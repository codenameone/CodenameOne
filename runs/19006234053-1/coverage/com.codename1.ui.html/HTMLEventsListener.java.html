<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HTMLEventsListener.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">codenameone-core-unittests</a> &gt; <a href="index.source.html" class="el_package">com.codename1.ui.html</a> &gt; <span class="el_source">HTMLEventsListener.java</span></div><h1>HTMLEventsListener.java</h1><pre class="source lang-java linenums">package com.codename1.ui.html;

import com.codename1.ui.Button;
import com.codename1.ui.CheckBox;
import com.codename1.ui.Component;
import com.codename1.ui.List;
import com.codename1.ui.RadioButton;
import com.codename1.ui.TextArea;
import com.codename1.ui.TextField;
import com.codename1.ui.events.ActionEvent;
import com.codename1.ui.events.ActionListener;
import com.codename1.ui.events.DataChangedListener;
import com.codename1.ui.events.FocusListener;
import com.codename1.ui.events.SelectionListener;

import java.util.Enumeration;
import java.util.Hashtable;
import java.util.Vector;

/**
 * This class serves as a aggregator of all the event listeners for all the active components within the HTML page.
 * It is in itself an ActionListener and a FocusListener, and it creates SelectionListeners and DataChangedListeners if needed.
 * Upon events it both updates the DOM if needed, and dispatches event methods on HTMLCallback
 *
 * @author Ofir Leitner
 */
class HTMLEventsListener implements ActionListener, FocusListener {

<span class="nc" id="L29">    Hashtable comps = new Hashtable();</span>
<span class="nc" id="L30">    Hashtable listeners = new Hashtable();</span>
    HTMLComponent htmlC;

<span class="nc" id="L33">    public HTMLEventsListener(HTMLComponent htmlC) {</span>
<span class="nc" id="L34">        this.htmlC = htmlC;</span>
<span class="nc" id="L35">    }</span>

    /**
     * Registeres the specified component/element duo to listen to all available events
     *
     * @param cmp     The actual component
     * @param element The element representing the component
     */
    void registerComponent(final Component cmp, final HTMLElement element) {
<span class="nc" id="L44">        comps.put(cmp, element);</span>
<span class="nc" id="L45">        cmp.addFocusListener(this);</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">        if (cmp instanceof Button) { // catches Button, CheckBox, RadioButton</span>
<span class="nc" id="L47">            ((Button) cmp).addActionListener(this);</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">        } else if (cmp instanceof List) { // catches ComboBox</span>
<span class="nc" id="L49">            final List list = (List) cmp;</span>
<span class="nc" id="L50">            list.addActionListener(this);</span>
<span class="nc" id="L51">            SelectionListener sl = new SelectionListener() { // We create a listener and not listen ourself since the listener's method does not pass the event origin, so we need to make one listener per component</span>
                public void selectionChanged(int oldSelected, int newSelected) {
<span class="nc bnc" id="L53" title="All 2 branches missed.">                    if (htmlC.getHTMLCallback() != null) {</span>
<span class="nc" id="L54">                        htmlC.getHTMLCallback().selectionChanged(oldSelected, newSelected, htmlC, list, element);</span>
                    }
<span class="nc" id="L56">                }</span>
            };
<span class="nc" id="L58">            list.addSelectionListener(sl);</span>
<span class="nc" id="L59">            listeners.put(cmp, sl);</span>

<span class="nc bnc" id="L61" title="All 2 branches missed.">        } else if (cmp instanceof TextArea) {</span>
<span class="nc" id="L62">            ((TextArea) cmp).addActionListener(this);</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">            if (cmp instanceof TextField) {</span>
<span class="nc" id="L64">                final TextField tf = (TextField) cmp;</span>
<span class="nc" id="L65">                DataChangedListener dcl = new DataChangedListener() { // We create a listener and not listen ourself since the listener's method does not pass the event origin, so we need to make one listener per component</span>
                    public void dataChanged(int type, int index) {
<span class="nc" id="L67">                        element.setAttributeById(HTMLElement.ATTR_VALUE, tf.getText());</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">                        if (htmlC.getHTMLCallback() != null) {</span>
<span class="nc" id="L69">                            htmlC.getHTMLCallback().dataChanged(type, index, htmlC, tf, element);</span>
                        }
<span class="nc" id="L71">                    }</span>
                };
<span class="nc" id="L73">                tf.addDataChangedListener(dcl);</span>
<span class="nc" id="L74">                listeners.put(cmp, dcl);</span>
            }
        }
<span class="nc" id="L77">    }</span>

    /**
     * Deregisters all the listeners, happens before a new page is loaded
     */
    void deregisterAll() {
<span class="nc bnc" id="L83" title="All 2 branches missed.">        for (Enumeration e = comps.keys(); e.hasMoreElements(); ) {</span>
<span class="nc" id="L84">            Component cmp = (Component) e.nextElement();</span>
<span class="nc" id="L85">            cmp.removeFocusListener(this);</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">            if (cmp instanceof Button) { // catches Button, CheckBox, RadioButton</span>
<span class="nc" id="L87">                ((Button) cmp).removeActionListener(this);</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">            } else if (cmp instanceof List) { // catches ComboBox</span>
<span class="nc" id="L89">                ((List) cmp).removeSelectionListener((SelectionListener) listeners.get(cmp));</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">            } else if (cmp instanceof TextArea) {</span>
<span class="nc" id="L91">                ((TextArea) cmp).removeActionListener(this);</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">                if (cmp instanceof TextField) {</span>
<span class="nc" id="L93">                    ((TextField) cmp).removeDataChangeListener((DataChangedListener) listeners.get(cmp));</span>
                }
            }
<span class="nc" id="L96">        }</span>
<span class="nc" id="L97">        comps = new Hashtable();</span>
<span class="nc" id="L98">        listeners = new Hashtable();</span>
<span class="nc" id="L99">    }</span>

    private void toggleChecked(HTMLElement element, boolean checkedX) {
<span class="nc bnc" id="L102" title="All 2 branches missed.">        if (checkedX) {</span>
<span class="nc" id="L103">            element.setAttributeById(HTMLElement.ATTR_CHECKED, &quot;checked&quot;);</span>
        } else {
<span class="nc" id="L105">            element.removeAttributeById(HTMLElement.ATTR_CHECKED);</span>
        }

<span class="nc" id="L108">    }</span>

    /**
     * {{@inheritDoc}}
     */
    public void actionPerformed(ActionEvent evt) {
<span class="nc" id="L114">        Object src = evt.getSource();</span>
<span class="nc" id="L115">        HTMLElement element = (HTMLElement) comps.get(evt.getSource());</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">        if (src instanceof CheckBox) {</span>
<span class="nc" id="L117">            toggleChecked(element, ((CheckBox) src).isSelected());</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">        } else if (src instanceof RadioButton) {</span>
<span class="nc" id="L119">            String curDomState = element.getAttributeById(HTMLElement.ATTR_CHECKED);</span>
<span class="nc bnc" id="L120" title="All 4 branches missed.">            if ((curDomState == null) || (!curDomState.equals(&quot;checked&quot;))) {</span>
<span class="nc" id="L121">                String name = element.getAttributeById(HTMLElement.ATTR_NAME);</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">                if (name != null) { // If this is named radiobutton, we need to set the status of the others accordingly</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">                    for (Enumeration e = comps.keys(); e.hasMoreElements(); ) {</span>
<span class="nc" id="L124">                        Component cmp = (Component) e.nextElement();</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">                        if (cmp instanceof RadioButton) {</span>
<span class="nc" id="L126">                            HTMLElement rbElem = (HTMLElement) comps.get(cmp);</span>
<span class="nc" id="L127">                            String rbName = rbElem.getAttributeById(HTMLElement.ATTR_NAME);</span>
<span class="nc bnc" id="L128" title="All 4 branches missed.">                            if ((rbName != null) &amp;&amp; (rbName.equals(name))) {</span>
<span class="nc" id="L129">                                rbElem.removeAttributeById(HTMLElement.ATTR_CHECKED);</span>
                            }
                        }
<span class="nc" id="L132">                    }</span>
                }
            }
<span class="nc" id="L135">            toggleChecked(element, ((RadioButton) src).isSelected());</span>
            //element.setAttributeById(HTMLElement.ATTR_CHECKED, ((RadioButton)src).isSelected()?&quot;checked&quot;:null);
<span class="nc bnc" id="L137" title="All 2 branches missed.">        } else if (src instanceof TextArea) {</span>
<span class="nc" id="L138">            String text = ((TextArea) src).getText();</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">            if (element.getNumChildren() == 0) {</span>
<span class="nc" id="L140">                HTMLElement textElem = new HTMLElement(text, true);</span>
<span class="nc" id="L141">                element.addChild(textElem);</span>
<span class="nc" id="L142">            } else {</span>
<span class="nc" id="L143">                HTMLElement textElem = (HTMLElement) element.getChildAt(0);</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">                if (textElem.isTextElement()) { // If the HTML is malformed we may have a different element - and we ignore</span>
<span class="nc" id="L145">                    textElem.setText(text);</span>
                } else {
<span class="nc" id="L147">                    System.out.println(&quot;Malformed HTML - Found a non-text element under TEXTAREA tag - ignoring&quot;);</span>
                }
            }
<span class="nc bnc" id="L150" title="All 2 branches missed.">        } else if (src instanceof List) { //combobox</span>
<span class="nc" id="L151">            String item = ((List) src).getSelectedItem().toString();</span>
<span class="nc" id="L152">            Vector v = element.getDescendantsByTagId(HTMLElement.TAG_OPTION); // This is activated on the SELECT tag - we take descendants and not only children due to OPTGROUP</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">            for (Enumeration e = v.elements(); e.hasMoreElements(); ) {</span>
<span class="nc" id="L154">                HTMLElement option = (HTMLElement) e.nextElement();</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">                if (option.getNumChildren() == 1) { //we expect only a text element, if not the HTML is malformed and we ignore</span>
<span class="nc" id="L156">                    HTMLElement textElem = (HTMLElement) option.getChildAt(0);</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">                    if (textElem.isTextElement()) { // If the HTML is malformed we may have a different element - and we ignore</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">                        if (textElem.getText().equalsIgnoreCase(item)) {</span>
<span class="nc" id="L159">                            option.setAttributeById(HTMLElement.ATTR_SELECTED, &quot;selected&quot;);</span>
                        } else {
<span class="nc" id="L161">                            option.removeAttributeById(HTMLElement.ATTR_SELECTED);</span>
                        }
                    } else {
<span class="nc" id="L164">                        System.out.println(&quot;Malformed HTML - Found a non-text element under OPTION tag - ignoring&quot;);</span>
                    }
<span class="nc" id="L166">                } else {</span>
<span class="nc" id="L167">                    System.out.println(&quot;Malformed HTML - Found illegal tags as children of the OPTION tag - ignoring&quot;);</span>
                }
<span class="nc" id="L169">            }</span>
        }
<span class="nc bnc" id="L171" title="All 2 branches missed.">        if (htmlC.getHTMLCallback() != null) {</span>
<span class="nc" id="L172">            htmlC.getHTMLCallback().actionPerformed(evt, htmlC, element);</span>
        }
<span class="nc" id="L174">    }</span>

    /**
     * {{@inheritDoc}}
     */
    public void focusGained(Component cmp) {
<span class="nc bnc" id="L180" title="All 2 branches missed.">        if (htmlC.getHTMLCallback() != null) {</span>
<span class="nc" id="L181">            htmlC.getHTMLCallback().focusGained(cmp, htmlC, (HTMLElement) comps.get(cmp));</span>
        }
<span class="nc" id="L183">    }</span>

    /**
     * {{@inheritDoc}}
     */
    public void focusLost(Component cmp) {
<span class="nc bnc" id="L189" title="All 2 branches missed.">        if (htmlC.getHTMLCallback() != null) {</span>
<span class="nc" id="L190">            htmlC.getHTMLCallback().focusLost(cmp, htmlC, (HTMLElement) comps.get(cmp));</span>
        }
<span class="nc" id="L192">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>