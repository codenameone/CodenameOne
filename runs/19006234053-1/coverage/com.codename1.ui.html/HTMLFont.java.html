<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HTMLFont.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">codenameone-core-unittests</a> &gt; <a href="index.source.html" class="el_package">com.codename1.ui.html</a> &gt; <span class="el_source">HTMLFont.java</span></div><h1>HTMLFont.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2008, 2010, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores
 * CA 94065 USA or visit www.oracle.com if you need additional information or
 * have any questions.
 */
package com.codename1.ui.html;

import com.codename1.ui.Font;

import java.util.Vector;

/**
 * This class is a wrapper class for a Codename One font object, that keeps additional info on the font as required for HTML rendering by HTMLComponent.&lt;br&gt;
 * The info kept on the font is its family, size and style. These attributes are available in Codename One only for system fonts,
 * but here they are made available for bitmap fonts using a key to describe the font (See HTMLComponent.addFont)&lt;br&gt;
 * &lt;br&gt;
 * In addition this class keeps track of &quot;counterpart&quot; fonts for this font in a space of 4 attributes: BOLD, ITALIC, BIG and SMALL.&lt;br&gt;
 * For example a bold font is the BOLD counterpart of a plain one. A font with size 16 is the BIG counterpart of a font the size of 12 - provided that all other attributes are the same (i.e. an arial.16 font is not the BIG counterpart of a courier.12 etc.)&lt;br&gt;
 *
 * @author Ofir Leitner
 */
class HTMLFont {

    static final int BOLD = 0;
    static final int ITALIC = 1;
    static final int BIG = 2;
    static final int SMALL = 3;
    private static final char TOKEN = '.';
<span class="nc" id="L47">    static Vector SPECIAL_FONT_TAGS = new Vector();</span>
    /**
     * The following tags are tags that mainly define the style of their content, and one of the things they can change is the font
     */
<span class="nc" id="L51">    static private final int[] SPECIAL_FONT_TAGS_ID = {</span>
            HTMLElement.TAG_EM, HTMLElement.TAG_STRONG,
            HTMLElement.TAG_DFN, HTMLElement.TAG_CODE,
            HTMLElement.TAG_SAMP, HTMLElement.TAG_KBD,
            HTMLElement.TAG_VAR, HTMLElement.TAG_CITE,
            HTMLElement.TAG_H1, HTMLElement.TAG_H2,
            HTMLElement.TAG_H3, HTMLElement.TAG_H4,
            HTMLElement.TAG_H5, HTMLElement.TAG_H6,
            HTMLElement.TAG_TT
    };

    /**
     * The static segment sets up the SPECIAL_FONT_TAGS vector with values from the SPECIAL_FONT_TAGS_ID array.
     * This vector is used for lookup later on.
     */
    static {
<span class="nc bnc" id="L67" title="All 2 branches missed.">        for (int i = 0; i &lt; SPECIAL_FONT_TAGS_ID.length; i++) {</span>
<span class="nc" id="L68">            SPECIAL_FONT_TAGS.addElement(HTMLElement.TAG_NAMES[SPECIAL_FONT_TAGS_ID[i]]);</span>
        }
<span class="nc" id="L70">    }</span>

    boolean systemFont;
    Font font;
    String family;
    int size;
    int style;
    boolean bold;
    boolean italic;
    String tagFont;
<span class="nc" id="L80">    private final HTMLFont[] counterpartFonts = new HTMLFont[4];</span>

    /**
     * Constructs the HTMLFont
     *
     * @param fontKey The key for this font (See class definition)
     * @param font    The actual Codename One font object (Can be either system or bitmap font)
     */
<span class="nc" id="L88">    HTMLFont(String fontKey, Font font) {</span>
<span class="nc" id="L89">        this.font = font;</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">        systemFont = (font.getCharset() == null); // A systemfont has no &quot;supported&quot; charset</span>

<span class="nc bnc" id="L92" title="All 2 branches missed.">        if (isSystemFont()) {</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">            bold = ((font.getStyle() &amp; Font.STYLE_BOLD) != 0);</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">            italic = ((font.getStyle() &amp; Font.STYLE_ITALIC) != 0);</span>
<span class="nc" id="L95">            size = font.getSize();</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">            if (font.getFace() == Font.FACE_SYSTEM) {</span>
<span class="nc" id="L97">                family = &quot;system&quot;;</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">            } else if (font.getFace() == Font.FACE_MONOSPACE) {</span>
<span class="nc" id="L99">                family = &quot;monospace&quot;;</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">            } else if (font.getFace() == Font.FACE_PROPORTIONAL) {</span>
<span class="nc" id="L101">                family = &quot;proportional&quot;;</span>
            }
        } else { //bitmap font
<span class="nc bnc" id="L104" title="All 2 branches missed.">            if (fontKey != null) { //fontKey can be null in the case this is a default font (Though even then it is recommended to provide a font key so the engine can use this font in other cases)</span>
<span class="nc" id="L105">                boolean sufficientInfo = false;</span>
<span class="nc" id="L106">                int lastIndex = 0;</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">                if (!fontKey.endsWith(&quot;.&quot;)) {</span>
<span class="nc" id="L108">                    fontKey += '.';</span>
                }
<span class="nc" id="L110">                int index = fontKey.indexOf(TOKEN);</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">                while (index != -1) {</span>
<span class="nc" id="L112">                    String str = fontKey.substring(lastIndex, index);</span>
                    try {
<span class="nc" id="L114">                        int num = Integer.parseInt(str);</span>
<span class="nc" id="L115">                        size = num;</span>
<span class="nc" id="L116">                    } catch (NumberFormatException nfe) {</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">                        if (str.equalsIgnoreCase(&quot;bold&quot;)) {</span>
<span class="nc" id="L118">                            bold = true;</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">                        } else if (str.equalsIgnoreCase(&quot;italic&quot;)) {</span>
<span class="nc" id="L120">                            italic = true;</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">                        } else if (str.equalsIgnoreCase(&quot;plain&quot;)) {</span>
                            // do nothing, but don't save as a family
<span class="nc bnc" id="L123" title="All 2 branches missed.">                        } else if (SPECIAL_FONT_TAGS.contains(str)) {</span>
<span class="nc" id="L124">                            HTMLComponent.fonts.put(str, this);</span>
<span class="nc" id="L125">                            sufficientInfo = true;</span>
                        } else {
<span class="nc" id="L127">                            family = str.toLowerCase();</span>
<span class="nc" id="L128">                            sufficientInfo = true;</span>
                        }

<span class="nc" id="L131">                    }</span>
<span class="nc" id="L132">                    lastIndex = index + 1;</span>
<span class="nc" id="L133">                    index = fontKey.indexOf(TOKEN, lastIndex);</span>
<span class="nc" id="L134">                }</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">                if (!sufficientInfo) {</span>
<span class="nc" id="L136">                    System.out.println(&quot;WARNING: Font was added with key '&quot; + fontKey + &quot;' which doesn't contain info on the font's family or attributes it to a special tag. The font will probably be unusable by the font engine.&quot;);</span>
                }
            }
        }

<span class="nc bnc" id="L141" title="All 2 branches missed.">        if (bold) {</span>
<span class="nc" id="L142">            style += Font.STYLE_BOLD;</span>
<span class="nc" id="L143">            counterpartFonts[BOLD] = this;</span>
        }
<span class="nc bnc" id="L145" title="All 2 branches missed.">        if (italic) {</span>
<span class="nc" id="L146">            style += Font.STYLE_ITALIC;</span>
<span class="nc" id="L147">            counterpartFonts[ITALIC] = this;</span>
        }

<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (isSystemFont()) {</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">            if (size == Font.SIZE_LARGE) {</span>
<span class="nc" id="L152">                counterpartFonts[BIG] = this;</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">            } else if (size == Font.SIZE_SMALL) {</span>
<span class="nc" id="L154">                counterpartFonts[SMALL] = this;</span>
            }
        }

<span class="nc" id="L158">    }</span>

    /**
     * Checks if this is a system font
     *
     * @return true if the font is a system font, false otherwise
     */
    boolean isSystemFont() {
<span class="nc" id="L166">        return systemFont;</span>
    }

    /**
     * Checks if this is a bold font
     *
     * @return true if the font is bold, false otherwise
     */
    boolean isBold() {
<span class="nc" id="L175">        return bold;</span>
    }

    /**
     * Checks if this is an Italic font
     *
     * @return true if the font is italic, false otherwise
     */
    boolean isItalic() {
<span class="nc" id="L184">        return italic;</span>
    }

    /**
     * Checks if the given font is the counterpart of the current form in the sense of the given attribute
     *
     * @param attribute The attribute, can be one of BOLD, ITALIC, BIG or SMALL
     * @param font      The font to check
     * @return true if the font is a counterpart, false otherwise
     */
    boolean isCounterpart(int attribute, HTMLFont font) {
<span class="nc bnc" id="L195" title="All 5 branches missed.">        switch (attribute) {</span>
            case BOLD:
<span class="nc" id="L197">                return isBoldCounterpart(font);</span>
            case ITALIC:
<span class="nc" id="L199">                return isItalicCounterpart(font);</span>
            case BIG:
<span class="nc" id="L201">                return isBigCounterpart(font);</span>
            case SMALL:
<span class="nc" id="L203">                return isSmallCounterpart(font);</span>
            default:
<span class="nc" id="L205">                return false;</span>
        }
    }

    /**
     * Utility method that first checks that neither font family is null and then compares them
     *
     * @param font The other font to check
     * @return true if the family of the compared font and this font are identical (and both are not null), false otherwise
     */
    boolean isSameFamily(HTMLFont font) {
<span class="nc bnc" id="L216" title="All 6 branches missed.">        return ((family != null) &amp;&amp; (font.getFamily() != null) &amp;&amp; (family.equals(font.getFamily())));</span>
    }


    /**
     * Checks if the specified font is a big counterpart of this font.
     *
     * @param font The font to check
     * @return true if this is a big couterpart, false otherwise
     */
    private boolean isBigCounterpart(HTMLFont font) {
<span class="nc bnc" id="L227" title="All 2 branches missed.">        if (size &lt;= font.getSize()) {</span>
<span class="nc" id="L228">            return false;</span>
        }
<span class="nc bnc" id="L230" title="All 4 branches missed.">        return (isSameFamily(font) &amp;&amp; (style == font.getStyle()));</span>
    }

    /**
     * Checks if the specified font is a small counterpart of this font.
     *
     * @param font The font to check
     * @return true if this is a small couterpart, false otherwise
     */
    private boolean isSmallCounterpart(HTMLFont font) {
<span class="nc bnc" id="L240" title="All 2 branches missed.">        if (size &gt;= font.getSize()) {</span>
<span class="nc" id="L241">            return false;</span>
        }
<span class="nc bnc" id="L243" title="All 4 branches missed.">        return (isSameFamily(font) &amp;&amp; (style == font.getStyle()));</span>
    }

    /**
     * Checks if the specified font is a bold counterpart of this font.
     *
     * @param font The font to check
     * @return true if this is a bold couterpart, false otherwise
     */

    private boolean isBoldCounterpart(HTMLFont font) {
<span class="nc bnc" id="L254" title="All 2 branches missed.">        if (!bold) {</span>
<span class="nc" id="L255">            return false;</span>
        }
<span class="nc bnc" id="L257" title="All 6 branches missed.">        return ((size == font.getSize()) &amp;&amp; (isSameFamily(font)) &amp;&amp; (italic == font.isItalic()));</span>
    }

    /**
     * Checks if the specified font is an italic counterpart of this font.
     *
     * @param font The font to check
     * @return true if this is an italic couterpart, false otherwise
     */
    private boolean isItalicCounterpart(HTMLFont font) {
<span class="nc bnc" id="L267" title="All 2 branches missed.">        if (!italic) {</span>
<span class="nc" id="L268">            return false;</span>
        }
<span class="nc bnc" id="L270" title="All 6 branches missed.">        return ((size == font.getSize()) &amp;&amp; (isSameFamily(font)) &amp;&amp; (bold == font.isBold()));</span>
    }


    /**
     * Returns the font family (i.e. Arial, Times New Roman)
     *
     * @return the string describing this font family
     */
    String getFamily() {
<span class="nc" id="L280">        return family;</span>
    }

    /**
     * Returns the Codename One font wrapped in this HTMLFont
     *
     * @return the Codename One font wrapped in this HTMLFont
     */
    Font getFont() {
<span class="nc" id="L289">        return font;</span>
    }

    /**
     * Returns the counterpart font for this font in the given attribute.
     * This method either creates it or fetches it if it was already set. It handles both system and bitmap fonts.
     * Note that a counterpart font can be the font itself if no other suitable font was found.
     *
     * @param attribute The requested counterpart attribute
     * @return the counterpart font for this font in the given attribute
     */
    HTMLFont getCounterpartFont(int attribute) {
<span class="nc bnc" id="L301" title="All 4 branches missed.">        if ((systemFont) &amp;&amp; (counterpartFonts[attribute] == null)) { //Note that bold counterpart for a bold font is already set as the font itself in the constructor and so on for all attributes</span>
<span class="nc bnc" id="L302" title="All 5 branches missed.">            switch (attribute) {</span>
                case BOLD:
<span class="nc" id="L304">                    counterpartFonts[attribute] = new HTMLFont(null, Font.createSystemFont(font.getFace(), style + Font.STYLE_BOLD, size));</span>
<span class="nc" id="L305">                    break;</span>
                case ITALIC:
<span class="nc" id="L307">                    counterpartFonts[attribute] = new HTMLFont(null, Font.createSystemFont(font.getFace(), style + Font.STYLE_ITALIC, size));</span>
<span class="nc" id="L308">                    break;</span>
                case BIG:
                    //If current form's size is medium then the big counterpart is large, if it's small then medium
<span class="nc bnc" id="L311" title="All 2 branches missed.">                    int counterpartSize = (size == Font.SIZE_SMALL) ? Font.SIZE_MEDIUM : Font.SIZE_LARGE;</span>
<span class="nc" id="L312">                    counterpartFonts[attribute] = new HTMLFont(null, Font.createSystemFont(font.getFace(), style, counterpartSize));</span>
<span class="nc" id="L313">                    break;</span>
                case SMALL:
                    //If current form's size is medium then the small counterpart is small, if it's large then medium
<span class="nc bnc" id="L316" title="All 2 branches missed.">                    counterpartSize = (size == Font.SIZE_LARGE) ? Font.SIZE_MEDIUM : Font.SIZE_SMALL;</span>
<span class="nc" id="L317">                    counterpartFonts[attribute] = new HTMLFont(null, Font.createSystemFont(font.getFace(), style, counterpartSize));</span>
                    break;
            }
        }
<span class="nc" id="L321">        return counterpartFonts[attribute];</span>
    }

    /**
     * Sets the specified font as the counterpart of this font in the given attribute
     *
     * @param attribute       The attribute in which the specified font is the counterpart of this font.
     * @param counterpartFont The counter part font
     */
    void setCounterpartFont(int attribute, HTMLFont counterpartFont) {
<span class="nc" id="L331">        counterpartFonts[attribute] = counterpartFont;</span>
<span class="nc" id="L332">    }</span>


    // font &quot;interface&quot; methods

    /**
     * Return the total height of the font
     *
     * @return the total height of the font
     */
    int getHeight() {
<span class="nc" id="L343">        return font.getHeight();</span>
    }

    /**
     * Return the width of the given string in this font instance
     *
     * @param str the given string     *
     * @return the width of the given string in this font instance
     */
    int stringWidth(String str) {
<span class="nc" id="L353">        return font.stringWidth(str);</span>
    }

    /**
     * Return Optional operation returning the font face for system fonts
     *
     * @return Optional operation returning the font face for system fonts
     */
    int getFace() {
<span class="nc" id="L362">        return font.getFace();</span>
    }

    /**
     * Returns the style of the font
     *
     * @return STYLE_PLAIN, STYLE_BOLD or STYLE_ITALIC or STYLE_BOLD | STYLE_ITALIC
     */
    int getStyle() {
<span class="nc" id="L371">        return style;</span>
    }

    /**
     * Returns the font size. For system fonts this would be either SIZE_SMALL, SIZE_MEDIUM or SIZE_LARGE.
     * For bitmap font this would be the exact size as defined in the font key.
     *
     * @return the font size
     */
    int getSize() {
<span class="nc" id="L381">        return size;</span>
    }

    /**
     * Returns the font size in pixels. For system fonts an estimation is made.
     *
     * @return the font size in pixels
     */
    int getSizeInPixels() {
<span class="nc bnc" id="L390" title="All 2 branches missed.">        if (systemFont) {</span>
<span class="nc" id="L391">            return font.getHeight() - 2; //estimation - usually a font's hright is bigger in a few pixels than the size</span>
        } else {
<span class="nc" id="L393">            return size;</span>
        }
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>