<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HTMLComponent.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">codenameone-core-unittests</a> &gt; <a href="index.source.html" class="el_package">com.codename1.ui.html</a> &gt; <span class="el_source">HTMLComponent.java</span></div><h1>HTMLComponent.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2008, 2010, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores
 * CA 94065 USA or visit www.oracle.com if you need additional information or
 * have any questions.
 */
package com.codename1.ui.html;

import com.codename1.ui.Button;
import com.codename1.ui.CheckBox;
import com.codename1.ui.ComboBox;
import com.codename1.ui.Command;
import com.codename1.ui.Component;
import com.codename1.ui.Container;
import com.codename1.ui.Display;
import com.codename1.ui.Font;
import com.codename1.ui.Form;
import com.codename1.ui.Graphics;
import com.codename1.ui.Label;
import com.codename1.ui.List;
import com.codename1.ui.RadioButton;
import com.codename1.ui.TextArea;
import com.codename1.ui.TextField;
import com.codename1.ui.animations.Motion;
import com.codename1.ui.events.ActionEvent;
import com.codename1.ui.events.ActionListener;
import com.codename1.ui.geom.Dimension;
import com.codename1.ui.geom.Rectangle;
import com.codename1.ui.layouts.BorderLayout;
import com.codename1.ui.layouts.BoxLayout;
import com.codename1.ui.layouts.FlowLayout;
import com.codename1.ui.plaf.Border;
import com.codename1.ui.plaf.Style;
import com.codename1.ui.table.Table;

import java.io.ByteArrayInputStream;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.UnsupportedEncodingException;
import java.util.Enumeration;
import java.util.Hashtable;
import java.util.Vector;

/**
 * HTMLComponent is a Codename One Component that renders HTML documents that conform to the XHTML Mobile Profile 1.0
 *
 * @author Ofir Leitner
 * @deprecated this component includes some customizability advantages but its probably better for 99% of the use
 * cases to use the WebBrowser Component from the Components package. That component works with the native
 * browser when applicable which is a far superior approach.
 */
public class HTMLComponent extends Container implements ActionListener, IOCallback {
    /**
     * If true a full screen width will be assumed, this helps to make less internal components as text is aggregated to long labels
     * If false, then the width is flexible, but every word will be rendered as a separate label.
     * Note that if false, RTL texts will display in
     */
    static final boolean FIXED_WIDTH = false;
//    long startTime;
//    String msg=&quot;&quot;;
//    long textTime;

    // Internal &quot;tweakable&quot; constants
    /**
     * A constant that can be used to obfuscate out HTMLInputFormat if unnecessary
     */
    static final boolean SUPPORT_INPUT_FORMAT = true;
    /**
     * A constant that can be used to obfuscate out all CSS related code if unnecessary
     */
    static final boolean SUPPORT_CSS = true;
    /**
     * A constant denoting whether to process only XHTML-MP1 (and WCSS), or some other tags/properties from HTML4/CSS2
     */
    static final boolean PROCESS_HTML_MP1_ONLY = false;
    /**
     * Indicates a Justify alignment. Text justification is enabled only in FIXED_WIDTH mode
     */
    static final int JUSTIFY = 5;
    static final String CLIENT_PROPERTY_QUOTE = &quot;quote&quot;; // Client property added to quote elements to enable changing them later on with CSS
    static final String CLIENT_PROPERTY_IMG_BORDER = &quot;imgBorder&quot;;
    /**
     * The default background color of an HTML document, can be changed with the BGCOLOR attribute in the BODY tag or via CSS
     */
    static final int DEFAULT_BGCOLOR = 0xffffff;
    /**
     * The default color of text in HTML documents, can be changed with the TEXT attribute in the BODY tag or via CSS
     */
    static final int DEFAULT_TEXT_COLOR = 0;
    /**
     * Static variables for HTMLListIndex
     */

<span class="nc" id="L111">    static final String[] CSS_OL_TYPES = {&quot;decimal&quot;, &quot;upper-alpha&quot;, &quot;lower-alpha&quot;, &quot;upper-roman&quot;, &quot;lower-roman&quot;, &quot;none&quot;};</span>
    /**
     * Static variables and methods for HTMLBullet
     */

<span class="nc" id="L116">    static final String[] CSS_UL_TYPES = {&quot;none&quot;, &quot;disc&quot;, &quot;circle&quot;, &quot;square&quot;};</span>
    /**
     * If true, when a page is requested, the previous page is immediately removed, thus helping conserve memory (Since only 1 page is held in memory simultanously)
     * In next releases a better and external control over this will be provided.
     */
    private static final boolean CLEAN_ON_PAGE_REQUEST = true; //false;
    /**
     * If true, checks will be made on each character in the text to see if it is CJK (Chinese, Japanese, Korean)
     * If so each character will be considered as an entire word (for line wrapping puposes) as required in CJK.
     * Since the tests require multiple unicode ranges check, this can be set to false avoiding these tests if the app doesn't use CJK
     */
    private static final boolean CJK_SUPPORT = true;
    /**
     * If true, then table cells will be preset with a size according to their preferred size, before the table begins calculating needed sizes
     * This also requires loading all images in table cells prior to page display (Unlike the normal way in which they can be completed afterwards)
     * This is needed due to some complexity when calculating sizes of tables with complex containers as cells, and especially with nested tables
     */
    //static final boolean TABLES_LOCK_SIZE = true; // The issue that required this patch was solved in the table package

    // Indentation for various tags
    private static final int INDENT_BLOCKQUOTE = 20;
    private static final int INDENT_DD = 20;
    // The minimum number of visible items of a multiple combobox (Unless it has less)
    private static final int MIN_MULTI_COMBOBOX_ITEMS = 4;
    private static final int MAX_MULTI_COMBOBOX_ITEMS = 6;
    /**
     * The default size (in characters) of an input textfield
     */
    private static final int DEFAULT_TEXTFIELD_SIZE = 12;
    /**
     * The default oolumns (in characters) of a textarea
     */
    private static final int DEFAULT_TEXTAREA_COLS = 20;
    /**
     * The default rows (in characters) of a textarea
     */
    private static final int DEFAULT_TEXTAREA_ROWS = 2;
    /**
     * The thickness of a line drawn by the HR tag
     */
    private static final int HR_THICKNESS = 3;
    /**
     * The time it takes a marquee to move across the screen (See -wap-marquee in CSS)
     */
    private static final int MARQUEE_DELAY = 6000;
    /**
     * When this is set to true, only exact fonts will be matched, i.e. if the font matching algorithm needs an arial.12.bold.italic - it will not &quot;settle&quot; for just bold or italic or a different size
     * Default is false
     */
    private static final boolean MATCH_EXACT_FONTS_ONLY = false;
    /**
     * When this is set to true only bitmap fonts will be used for matching (and not system fonts)
     * Default is true, and false has not been tested thoroughly
     */
    private static final boolean MATCH_BITMAP_FONTS_ONLY = true;
    /**
     * When this is set to true, only fonts of the same family will be matched. i.e. if we're looking for a bigger font than arial.10, and we have timesnewroman.12 it will not be taken as a matching font
     * Default is true
     */
    private static final boolean MATCH_SAME_FONT_FAMILY_ONLY = true;
    /**
     * The color given to visited links
     */
    private static final int COLOR_VISITED_LINKS = 0x990099;
    // Constants for the various possible input types (i.e. allowed values of the INPUT tag)
    private static final int INPUT_CHECKBOX = 0;
    private static final int INPUT_HIDDEN = 1;
    private static final int INPUT_PASSWORD = 2;
    private static final int INPUT_RADIO = 3;
    private static final int INPUT_RESET = 4;
    private static final int INPUT_SUBMIT = 5;
    private static final int INPUT_TEXT = 6;
    private static final int INPUT_IMAGE = 7; // image is not officially supported in XHTML-MP 1.0 but we support it
    private static final int INPUT_BUTTON = 8; //button is not supported in XHTML-MP 1.0
    //private static final int INPUT_FILE = 9; //file upload is not supported in XHTML-MP 1.0
    private static final int INPUT_EMAIL = 9;
    /**
     * Ordered list type legal identifiers as can be defined in the ATTR_TYPE of the OL_TAG
     */
<span class="nc" id="L195">    private static final char[] ORDERED_LIST_TYPE_IDENTIFIERS = {'1', 'A', 'a', 'I', 'i'};</span>
    /**
     * The default color of links in HTML documents, can be changed with the LINK attribute in the BODY tag or via CSS
     */
    static private final int DEFAULT_LINK_COLOR = 0x0000ff;
    /**
     * Strings representing roman numerals 0-9
     */
<span class="nc" id="L203">    private static final String[] ROMAN_NUMERALS_ONES = {&quot;&quot;, &quot;I&quot;, &quot;II&quot;, &quot;III&quot;, &quot;IV&quot;, &quot;V&quot;, &quot;VI&quot;, &quot;VII&quot;, &quot;VIII&quot;, &quot;IX&quot;};</span>

    // Ordered list types
    /**
     * Strings representing roman numeral tens (10,20,30 etc.)
     */
<span class="nc" id="L209">    private static final String[] ROMAN_NUMERALS_TENS = {&quot;&quot;, &quot;X&quot;, &quot;XX&quot;, &quot;XXX&quot;, &quot;XL&quot;, &quot;L&quot;, &quot;LX&quot;, &quot;LXX&quot;, &quot;LXXX&quot;, &quot;XC&quot;};</span>
    /**
     * A hashtable containing all defined HTMLFont objects
     */
<span class="nc" id="L213">    static Hashtable fonts = new Hashtable();</span>
<span class="nc" id="L214">    private static int INDENT_OL = -1;//Font.getDefaultFont().stringWidth(&quot;8888. &quot;); //Ordered list</span>
<span class="nc" id="L215">    private static int INDENT_UL = -1;//Font.getDefaultFont().charWidth('W'); //Unordered list</span>
    /**
     * The default font to use
     */
<span class="nc" id="L219">    private static HTMLFont DEFAULT_FONT = null;//new HTMLFont(null,Font.createSystemFont(Font.FACE_SYSTEM, Font.STYLE_PLAIN, Font.SIZE_MEDIUM));</span>
    /**
     * Defines the possible values for the type attribute in the input tag, ordered according to the INPUT_* constants
     */
<span class="nc" id="L223">    private static final String[] INPUT_TYPE_STRINGS = {</span>
            &quot;checkbox&quot;, &quot;hidden&quot;, &quot;password&quot;, &quot;radio&quot;, &quot;reset&quot;,
            &quot;submit&quot;, &quot;text&quot;, &quot;image&quot;, &quot;button&quot;, &quot;email&quot;
    };
    /**
     * Vector holding the possible input type strings.
     */
<span class="nc" id="L230">    private static final Vector INPUT_TYPES = new Vector();</span>

    /**
     * This static segment sets up the INPUT_TYPES vector with values from INPUT_TYPE_STRINGS.
     * This is used later on for lookup.
     */
    static {
<span class="nc bnc" id="L237" title="All 2 branches missed.">        for (int i = 0; i &lt; INPUT_TYPE_STRINGS.length; i++) {</span>
<span class="nc" id="L238">            INPUT_TYPES.addElement(INPUT_TYPE_STRINGS[i]);</span>
        }
<span class="nc" id="L240">    }</span>

    /**
     * Inidcates whether this component should load CSS files and consider STYLE tag and attributes when available..
     * Note that CSS requires to create significantlly more containers, as almost every tag needs to be in its own container
     * in order to manipulate style attributes like bgcolor, border etc. This is why the developer can disable CSS.
     * Currently this is a private variable, once CSS is actually available this will be exposed via public getter/setter.
     * Also there's no point setting this to true in this release as it will not lead to actual CSS, but just prepare containers for it.
     */
<span class="nc" id="L249">    boolean loadCSS = SUPPORT_CSS;</span>
    /**
     * If true than all active controls will be added event listeners and dispatch them via HTMLCallback
     * Default is false in order not to add overhead when this feature is not needed
     */
<span class="nc" id="L254">    boolean eventsEnabled = false;</span>
    HTMLParser parser;
<span class="nc" id="L256">    int contCount = 0; // debug for CSS</span>
<span class="nc" id="L257">    boolean showImages = true; //true to download image, false otherwise</span>
    Component firstFocusable; // The first focusable link on the page
    //Font
<span class="nc" id="L260">    HTMLFont defaultFont = DEFAULT_FONT; // The default font for all pages</span>
    HTMLTableModel curTable; // The model of the currently collected table
    Hashtable counters; // CSS content counters
    //private Vector elementsWithStyleAttr=new Vector();
<span class="nc" id="L264">    Vector marqueeComponents = new Vector();</span>
    private boolean supressExceptions;
    /**
     * Style sheets embedded directly into the style tag (not the style attribute)
     */
    private Vector embeddedCSS;
    /**
     * External style sheets referenced from LINK tags
     */
    private Vector externalCSS;
    // Document colors
<span class="nc" id="L275">    private int bgColor = DEFAULT_BGCOLOR;</span>
<span class="nc" id="L276">    private int textColor = DEFAULT_TEXT_COLOR;</span>
<span class="nc" id="L277">    private int linkColor = DEFAULT_LINK_COLOR;</span>
    // Refrences to helper classes and delegates
    private DocumentRequestHandler handler; // The HTMLComponent's request handler
    private RedirectThread redirectThread; // A refrence to a redirection thread if exists
    private final ResourceThreadQueue threadQueue; // A reference to the ResourceThreadQueue that handles asynchronous image download
    private HTMLCallback htmlCallback;
    private HTMLEventsListener eventsListener;
    // Page info and status
    private DocumentInfo docInfo; // The DocumentInfo object associated with this document
    private HTMLElement document; // The page DOM representation
    private String pageURL; // The current page's URL
<span class="nc" id="L288">    private int pageStatus = HTMLCallback.STATUS_NONE; // The page's status (See HTMLCallback)</span>
    private boolean pageError; // true if there was an error during the page building process
    private String title; // The page's title (as obtained from the TITLE tag in the HEAD tag)
    private int displayWidth; // Used to store the display width to detect width changes later on.


    // The following variables are used when building the component from the document.
    // After the component construction they are not used (Basically they can all be considered as &quot;temporary&quot; variables,
    // but due to the recursive nature of the document building operation, they are defined as members)

    //Containers
    private boolean cancelled; // true if the page was cancelled (Signals all processing to stop)
    private boolean cancelledCaught; //true if the cancel signal was already caught (Used to avoid multiple cancel handling)
    private Style pageStyle; // The page's user defined style
    private String pageUIID; // The page's user defined UIID
    // Links related
<span class="nc" id="L304">    private Hashtable accessKeys = new Hashtable();// A hastable containing all the access keys in this document and their respective links</span>
    private Hashtable anchors;// A hashtable containing all the anchors of this document
    private Hashtable inputFields; // A hashtable containing all the input fields in the page. Used for FOR labels
    // this variable is only useful with the properties mostly for the purpose of the resource editor GUI builder
    private String htmlBody;
    /**
     * The main container is the top-level container to which other containers are added when building the page.
     * After the page was built the main container is added to the HTMLComponent.
     * We do not build directly on the HTMLComponent to allow the building process to be performed not in the EDT thread.
     */
    private Container mainContainer;
    /**
     * curContianer is the current container we are adding components to. AT the start it is the main container.
     * Later on it can be a certain table cell or a fieldset.
     */
    private Container curContainer;
<span class="nc" id="L320">    private boolean autoFocus = true; // Determines whether to auto-focus on the first link after page load</span>
    /**
     * curLine is the basic container to which components are added in the building process.
     * Components are added to it horizontally and when there no more space left (or a newline is needed) - it is added to the curContainer
     */
    private Container curLine;
    // Layouting - NOTE: In FIXED_WIDTH mode this component assumes the full width of the screen and performs text wrapping due to a bug in the combination of FlowLayout inside BoxLayout. In non fixed width mode the variables x &amp; width are not used.
    private int x; // Holds the horizontal position in the curLine container
    private int width; // Holds the width available to each line
    private int leftIndent; // Holds the current left margin (can be changed by tags)
    private boolean lastWasEmpty; // true if the last line was empty, used to prevent unneeded multiple row spacing
    // Font
    private HTMLFont font; // Holds the current used font (starts with defaultFont and changes according to various tags and attributes)
    // Links
    private String link; // The current link address (so when a text is processed, we know to attribute it to this link)
    private HTMLLink mainLink; // The &quot;main&quot; link. If a link spans over 2 or more lines, the first segment is considered the &quot;main&quot; link and is responsible for highlighting all segments when focused.
<span class="nc" id="L336">    private char accesskey = '\0'; // The current accesskey for a link</span>
    private String anchor; // The current page anchor
    private boolean linkVisited; // True if the current link address was visited
    // Forms
    private HTMLForm curForm; // The current HTMLForm to which input fields should be added
    private TextArea curTextArea; // The current TextArea
    private List curComboBox; // The current ComboBox
    private boolean optionTag; // true if an option tag is open
    private boolean optionSelected; //true if the current option is marked as selected (i.e. the default selection)
    private String optionValue; // The current option value
    private Hashtable textfieldsToForms; // A hashtable that maps all input fields to their corresponding forms
    // Lists
    private int ulLevel; //Unordered list level (Used to display the right bullet)
    private int olIndex; //Index of the current item in the list
    private Vector olUpperLevelIndex;// = new Vector(); //Used to save the index when nesting
    private int listType; // The type of the current list
    private int listIndent; // Holds the current list margin
    // Tables
    private Vector tables;// A vector used for nesting, when a table contains a table ,the current one is &quot;pushed&quot; into the vector, to be &quot;popped&quot; later when the nested table processing ends.
    private Vector tableCells;// A vector used for nesting of table cells
    // Misc. tags
    private Vector fieldsets; // A vector used to support FIELDSET tag nesting
<span class="nc" id="L358">    private int preTagCount = 0; // A counter used to support PRE tag nesting</span>
<span class="nc" id="L359">    private int quoteTagCount = 0; // A counter used to support QUOTE tag nesting</span>
    private String labelForID; // Collects &lt;label for=&quot;id&quot;&gt;
    //HTML 4
    private int underlineCount;
    private int strikethruCount;
    private int textDecoration;
    private Hashtable imageMapComponents;
    private Hashtable imageMapData;
    private ImageMapData curImageMap;
    private int superscript; // keeps track of current superscript level (negative means subscript)
    private int maxSuperscript; // keeps track of teh maximal superscript value of the current line
<span class="nc" id="L370">    private Vector containers = new Vector();</span>
    private Motion marqueeMotion;

    /**
     * Constructs HTMLComponent
     */
    public HTMLComponent() {
<span class="nc" id="L377">        this(new DefaultDocumentRequestHandler());</span>
<span class="nc" id="L378">    }</span>

    /**
     * Constructs HTMLComponent
     *
     * @param handler The HttpRequestHandler to which all requests for links will be sent
     */
<span class="nc" id="L385">    public HTMLComponent(DocumentRequestHandler handler) {</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">        if (INDENT_OL &lt; 0) {</span>
<span class="nc" id="L387">            INDENT_OL = Font.getDefaultFont().stringWidth(&quot;8888. &quot;); //Ordered list</span>
        }
<span class="nc bnc" id="L389" title="All 2 branches missed.">        if (INDENT_UL &lt; 0) {</span>
<span class="nc" id="L390">            INDENT_UL = Font.getDefaultFont().charWidth('W'); //Unordered list</span>
        }
<span class="nc bnc" id="L392" title="All 2 branches missed.">        if (DEFAULT_FONT == null) {</span>
<span class="nc" id="L393">            DEFAULT_FONT = new HTMLFont(null, Font.createSystemFont(Font.FACE_SYSTEM, Font.STYLE_PLAIN, Font.SIZE_MEDIUM));</span>
        }

<span class="nc" id="L396">        setLayout(new BoxLayout(BoxLayout.Y_AXIS));</span>
<span class="nc" id="L397">        this.handler = handler;</span>
<span class="nc" id="L398">        threadQueue = new ResourceThreadQueue(this);</span>
<span class="nc" id="L399">        setHandlesInput(true);</span>
<span class="nc" id="L400">        setScrollableY(true);</span>
<span class="nc" id="L401">        setScrollableX(false);</span>
<span class="nc" id="L402">        setSmoothScrolling(true);</span>

        //Create some default fonts
<span class="nc" id="L405">        HTMLFont italic = new HTMLFont(null, Font.createSystemFont(Font.FACE_SYSTEM, Font.STYLE_ITALIC, Font.SIZE_MEDIUM));</span>
<span class="nc" id="L406">        HTMLFont monospace = new HTMLFont(null, Font.createSystemFont(Font.FACE_MONOSPACE, Font.STYLE_PLAIN, Font.SIZE_MEDIUM));</span>

        //Assign default fonts to some tags
<span class="nc" id="L409">        fonts.put(HTMLElement.TAG_NAMES[HTMLElement.TAG_EM], italic);</span>
<span class="nc" id="L410">        fonts.put(HTMLElement.TAG_NAMES[HTMLElement.TAG_STRONG], new HTMLFont(null, Font.createSystemFont(Font.FACE_SYSTEM, Font.STYLE_BOLD, Font.SIZE_MEDIUM)));</span>
<span class="nc" id="L411">        fonts.put(HTMLElement.TAG_NAMES[HTMLElement.TAG_DFN], italic);</span>
<span class="nc" id="L412">        fonts.put(HTMLElement.TAG_NAMES[HTMLElement.TAG_CODE], monospace);</span>
<span class="nc" id="L413">        fonts.put(HTMLElement.TAG_NAMES[HTMLElement.TAG_SAMP], monospace);</span>
<span class="nc" id="L414">        fonts.put(HTMLElement.TAG_NAMES[HTMLElement.TAG_KBD], monospace);</span>
<span class="nc" id="L415">        fonts.put(HTMLElement.TAG_NAMES[HTMLElement.TAG_VAR], italic);</span>
<span class="nc" id="L416">        fonts.put(HTMLElement.TAG_NAMES[HTMLElement.TAG_CITE], italic);</span>
<span class="nc" id="L417">        fonts.put(HTMLElement.TAG_NAMES[HTMLElement.TAG_PRE], monospace);</span>
<span class="nc" id="L418">        fonts.put(HTMLElement.TAG_NAMES[HTMLElement.TAG_H1], new HTMLFont(null, Font.createSystemFont(Font.FACE_SYSTEM, Font.STYLE_BOLD, Font.SIZE_LARGE)));</span>
<span class="nc" id="L419">        fonts.put(HTMLElement.TAG_NAMES[HTMLElement.TAG_H2], new HTMLFont(null, Font.createSystemFont(Font.FACE_SYSTEM, Font.STYLE_ITALIC, Font.SIZE_LARGE)));</span>
<span class="nc" id="L420">        fonts.put(HTMLElement.TAG_NAMES[HTMLElement.TAG_H3], new HTMLFont(null, Font.createSystemFont(Font.FACE_SYSTEM, Font.STYLE_BOLD, Font.SIZE_MEDIUM)));</span>

        // The TT (Teletype) tag is not part of XHTML-MP 1.0 but is supported anyway
<span class="nc" id="L423">        fonts.put(HTMLElement.TAG_NAMES[HTMLElement.TAG_TT], monospace);</span>


<span class="nc" id="L426">        parser = new HTMLParser(); //HTMLParser.getHTMLParserInstance();</span>
<span class="nc" id="L427">        parser.setHTMLComponent(this);</span>

<span class="nc" id="L429">    }</span>

    /**
     * Sets the given Codename One font for use with HTMLComponents.
     * &lt;p&gt;
     * The font key can contain information about the following attributes:
     * &lt;p&gt;
     * * The font family - i.e. Arial, Times New Roman etc.
     * * The font size - in pixels (i.e. 12, 14 etc.)
     * * The font style - bold, italic or both (no need to specify plain)
     * * The font tag assignments - if this font should be used for any HTML specific tags they should be specified - i.e. h1, kbd etc.
     * &lt;p&gt;
     * The key is just a concatenation of all attributes seperated with a dot.
     * Examples for valid keys:
     * arial.12 - Describes a plain font from the arial family in size 12
     * arial.16.bold - A bold arial font in size 16
     * courier.italic.bold.20 - A bold and italic courier font in size 20
     * arial.20.h1 - A plain arial font, size 20, that should be used for contents of the H1 tag
     * code.kbd.samp - A font that should be used for the CODE, KBD and SAMP tags
     * &lt;p&gt;
     * Note that the order of the attributes is not important and also that the case is ignored.
     * This means that arial.12.bold.italic.h3 is equivalent to itALIc.H3.arial.BOLD.12
     * &lt;p&gt;
     * Also note that while you do not have to provide all the info for the font, but the info helps the rendering engine to reuse fonts when suitable.
     * For example, if you have a 16px arial bold font which you want to use for H2, you can simply add it as &quot;h2&quot;, but if you add it as &quot;arial.16.bold.h2&quot;
     * then if the current font is arial.16 and the renderer encounters a B tag, it will know it can use the font you added as the bold counterpart of the current font.
     * &lt;p&gt;
     * When adding system fonts there is no need to describe the font, the usage of setFont with system fonts is usually just to assign them for tags.
     * The rendering engine knows to derive bold/italic/bigger/smaller fonts from other system fonts (default or tag fonts) even if not added.
     *
     * @param fontKey The font key in the format described above
     * @param font    The actual Codename One font object
     */
    public static void addFont(String fontKey, Font font) {
<span class="nc bnc" id="L463" title="All 2 branches missed.">        if (fontKey != null) {</span>
<span class="nc" id="L464">            fontKey = fontKey.toLowerCase();</span>
        } else {
<span class="nc bnc" id="L466" title="All 2 branches missed.">            if (font.getCharset() != null) {</span>
<span class="nc" id="L467">                throw new IllegalArgumentException(&quot;Font key must be non-null for bitmap fonts&quot;);</span>
            }
        }
<span class="nc" id="L470">        fonts.put(fontKey, new HTMLFont(fontKey, font));</span>
<span class="nc" id="L471">    }</span>

    /**
     * Adds support for a special key to be used as an accesskey.
     * The CSS property -wap-accesskey supports special keys, for example &quot;phone-send&quot; that may have different key codes per device.
     * This method allows pairing between such keys to their respective key codes.
     * Note that these keys are valid only for -wap-aceesskey in CSS files, and not for the XHTML accesskey attribute.
     *
     * @param specialKeyName The name of the special key as denoted in CSS files
     * @param specialKeyCode The special key code
     */
    public static void addSpecialKey(String specialKeyName, int specialKeyCode) {
        if (SUPPORT_CSS) {
<span class="nc" id="L484">            CSSEngine.addSpecialKey(specialKeyName, specialKeyCode);</span>
        } else {
            System.out.println(&quot;HTMLComponent.addSpecialKey: Codename One was compiled with HTMLComponent.SUPPORT_CSS false, this method has no effect&quot;);
        }
<span class="nc" id="L488">    }</span>

    /**
     * Sets the maximum number of threads to use for image download
     *
     * @param threadsNum the maximum number of threads to use for image download
     */
    public static void setMaxThreads(int threadsNum) {
<span class="nc" id="L496">        ResourceThreadQueue.setMaxThreads(threadsNum);</span>
<span class="nc" id="L497">    }</span>

    /**
     * Sets the supported CSS media types to the given strings.
     * Usually the default media types (&quot;all&quot;,&quot;handheld&quot;) should be suitable, but in case this runs on a device that matches another profile, the developer can specify it here.
     *
     * @param supportedMediaTypes A string array containing the media types that should be supported
     */
    public static void setCSSSupportedMediaTypes(String[] supportedMediaTypes) {
        if (SUPPORT_CSS) {
<span class="nc" id="L507">            CSSParser.setCSSSupportedMediaTypes(supportedMediaTypes);</span>
        } else {
            System.out.println(&quot;HTMLComponent.setCSSSupportedMediaTypes: Codename One was compiled with HTMLComponent.SUPPORT_CSS false, this method has no effect&quot;);
        }
<span class="nc" id="L511">    }</span>

    /**
     * A convenience method to convert a string to an int.
     * This is mainly intended to save the try-catch for NumericFormatExceptions
     *
     * @param intStr       The string describing the integer
     * @param defaultValue The value to return if the string is not numeric
     * @return the integer value of the string, or defaultValue if the string is not numeric
     */
    static int getInt(String intStr, int defaultValue) {
        try {
<span class="nc" id="L523">            int num = Integer.parseInt(intStr);</span>
<span class="nc" id="L524">            return num;</span>
<span class="nc" id="L525">        } catch (NumberFormatException nfe) {</span>
<span class="nc" id="L526">            return defaultValue;</span>
        }
    }

    /**
     * A convenience method to convert a string to an int.
     * This is mainly intended to save the try-catch for NumericFormatExceptions
     *
     * @param intStr The string describing the integer
     * @return the integer value of the string, or 0 if the string is not numeric
     */
    static int getInt(String intStr) {
<span class="nc" id="L538">        return getInt(intStr, 0);</span>
    }

    /**
     * Calculates width or height of an element according to its original size, requested size and default size
     *
     * @param origDim      The original width/height
     * @param requestedDim The string describing the requested width/height either in pixels or in percentage
     * @param defaultDim   The default width/height to return in case the calculation fails
     * @return The new width/height according to the parameters
     */
    static int calcSize(int origDim, String requestedDim, int defaultDim, boolean negativeAllowed) {
<span class="nc bnc" id="L550" title="All 2 branches missed.">        if (requestedDim == null) {</span>
<span class="nc" id="L551">            return defaultDim;</span>
        }
<span class="nc" id="L553">        boolean percent = false;</span>

<span class="nc bnc" id="L555" title="All 2 branches missed.">        if (requestedDim.endsWith(&quot;%&quot;)) {</span>
<span class="nc" id="L556">            percent = true;</span>
<span class="nc" id="L557">            requestedDim = requestedDim.substring(0, requestedDim.length() - 1);</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">        } else if (requestedDim.endsWith(&quot;px&quot;)) { // Pixels can be described either simply as '20' or as '20px'</span>
<span class="nc" id="L559">            requestedDim = requestedDim.substring(0, requestedDim.length() - 2);</span>
        }

<span class="nc" id="L562">        int dim = 0;</span>
        try {
<span class="nc" id="L564">            dim = Integer.parseInt(requestedDim);</span>
<span class="nc" id="L565">        } catch (Exception e) {</span>
            //dim=-1;
<span class="nc" id="L567">            return origDim;</span>
<span class="nc" id="L568">        }</span>

<span class="nc bnc" id="L570" title="All 4 branches missed.">        if ((dim &lt; 0) &amp;&amp; (!negativeAllowed)) { //Dimension was negative</span>
<span class="nc" id="L571">            return origDim;</span>
        }

<span class="nc bnc" id="L574" title="All 2 branches missed.">        if (percent) {</span>
<span class="nc" id="L575">            return origDim * dim / 100;</span>
        } else {
<span class="nc" id="L577">            return dim;</span>
        }
    }

    static int convertULString(String listTypeStr) {
<span class="nc bnc" id="L582" title="All 2 branches missed.">        if (listTypeStr == null) {</span>
<span class="nc" id="L583">            return -1;</span>
        }

<span class="nc bnc" id="L586" title="All 2 branches missed.">        for (int j = 0; j &lt; CSS_UL_TYPES.length; j++) {</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">            if (listTypeStr.equalsIgnoreCase(CSS_UL_TYPES[j])) {</span>
<span class="nc" id="L588">                return j;</span>
            }
        }

<span class="nc" id="L592">        return -1;</span>
    }

    /**
     * Sets a custom HTMLParser for this HTMLComponent
     * By default, a new HTMLParser instance is created for each HTMLComponent, use this method if you have a custom parser.
     *
     * @param parser The HTMLParser to use
     */
    public void setParser(HTMLParser parser) {
<span class="nc" id="L602">        this.parser.setParserCallback(null); //remove the callback</span>
<span class="nc" id="L603">        this.parser.setHTMLComponent(null); // remove the HTMLComponent</span>
<span class="nc" id="L604">        this.parser = parser;</span>
<span class="nc" id="L605">        parser.setHTMLComponent(this);</span>
<span class="nc" id="L606">        parser.setParserCallback(htmlCallback);</span>
<span class="nc" id="L607">    }</span>

    /**
     * Adds the given symbol and code to the user defined char entities table.
     * Symbols do not need to include leading &amp;amp; and trailing ; - these will be trimmed if given as the symbol
     *
     * @param symbol The symbol to add
     * @param code   The symbol's code
     */
    public void addCharEntity(String symbol, int code) {
<span class="nc" id="L617">        parser.addCharEntity(symbol, code);</span>
<span class="nc" id="L618">    }</span>

    /**
     * Adds the given symbols array  to the user defined char entities table with the startcode provided as the code of the first string, startcode+1 for the second etc.
     * Some strings in the symbols array may be null thus skipping code numbers.
     *
     * @param symbols   The symbols to add
     * @param startcode The symbol's code
     */
    public void addCharEntitiesRange(String[] symbols, int startcode) {
<span class="nc" id="L628">        parser.addCharEntitiesRange(symbols, startcode);</span>
<span class="nc" id="L629">    }</span>

    /**
     * Returns the document request handler
     *
     * @return the document request handler
     */
    public DocumentRequestHandler getRequestHandler() {
<span class="nc" id="L637">        return handler;</span>
    }

    /**
     * Changes the document request handler
     *
     * @param handler the new document request handler
     */
    public void setRequestHandler(DocumentRequestHandler handler) {
<span class="nc" id="L646">        this.handler = handler;</span>
<span class="nc" id="L647">    }</span>

    /**
     * Returns the DocumentInfo that currently represents the document loaded/shown
     *
     * @return the DocumentInfo that currently represents the document loaded/shown
     */
    public DocumentInfo getDocumentInfo() {
<span class="nc" id="L655">        return docInfo;</span>
    }

    /**
     * Returns the HTMLCallback that is set on this HTMLComponent
     *
     * @return the HTMLCallback that is set on this HTMLComponent or null if none
     */
    public HTMLCallback getHTMLCallback() {
<span class="nc" id="L664">        return htmlCallback;</span>
    }

    /**
     * Sets an HTMLCallback to listen to this HTMLCOmponent
     *
     * @param callback The HTMLCallback that will receive events
     */
    public void setHTMLCallback(HTMLCallback callback) {
<span class="nc" id="L673">        htmlCallback = callback;</span>
<span class="nc" id="L674">        parser.setParserCallback(htmlCallback);</span>
        if (SUPPORT_CSS) {
<span class="nc" id="L676">            CSSParser.getInstance().setCSSParserCallback(htmlCallback);</span>
        }
<span class="nc" id="L678">    }</span>

    /**
     * Sets the default font for this HTMLComponent
     *
     * @param fontKey The font key in the format described in setFont (Can be null for default font, but it is recommended to add a descriptive key if this is a bitmap font to enable the font engine to use it in other cases as well)
     * @param font    The actual Codename One font object
     */
    public void setDefaultFont(String fontKey, Font font) {
<span class="nc bnc" id="L687" title="All 2 branches missed.">        if (fontKey != null) {</span>
<span class="nc" id="L688">            fontKey = fontKey.toLowerCase();</span>
        }
<span class="nc" id="L690">        defaultFont = new HTMLFont(fontKey, font);</span>
<span class="nc bnc" id="L691" title="All 2 branches missed.">        if (fontKey != null) {</span>
<span class="nc" id="L692">            fonts.put(fontKey, defaultFont);</span>
        }
<span class="nc" id="L694">    }</span>

    /**
     * Sets whether this HTMLComponent will download and show linked images or not
     *
     * @param show true to show images, false otherwise
     */
    public void setShowImages(boolean show) {
<span class="nc" id="L702">        showImages = show;</span>
<span class="nc" id="L703">    }</span>

    /**
     * Sets whether this HTMLComponent will ignore all CSS.directives.
     * This includes external CSS files (which won't be downloaded), embedded CSS segmentsand style tags and attributes.
     * By default this is false.
     *
     * @param ignore true to ignore CSS directives, false otherwise
     */
    public void setIgnoreCSS(boolean ignore) {
        if (SUPPORT_CSS) { // If not supporting CSS, the loadCSS flag is locked on false
<span class="nc bnc" id="L714" title="All 2 branches missed.">            loadCSS = !ignore;</span>
        }
<span class="nc" id="L716">    }</span>

    /**
     * Scrolls the HTMLComponent several pixels forward/backward.
     *
     * @param pixels  The number of pixels to scroll (positive for forward and negative for backward)
     * @param animate true to animate the scrolling, false otherwise
     */
    public void scrollPixels(int pixels, boolean animate) {
<span class="nc" id="L725">        int scrollToY = getScrollY() + pixels;</span>
<span class="nc" id="L726">        scrollTo(scrollToY, animate);</span>
<span class="nc" id="L727">    }</span>

    /**
     * Scrolls the HTMLComponent several pages forward/backward.
     * TO scroll to the start or end of the document, one can provide a very big number.
     *
     * @param pages   The number of pages to scroll (positive for forward and negative for backward)
     * @param animate true to animate the scrolling, false otherwise
     */
    public void scrollPages(int pages, boolean animate) {
<span class="nc" id="L737">        int scrollToY = getScrollY() + getHeight() * pages;</span>
<span class="nc" id="L738">        scrollTo(scrollToY, animate);</span>

<span class="nc" id="L740">    }</span>

    /**
     * Scrolls the HTMLComponent to the specified element
     *
     * @param element The element to scroll to (must be contained in the document)
     * @param animate true to animate the scrolling, false otherwise
     * @throws IllegalArgumentException if the element is not contained in the current document.
     */
    public void scrollToElement(HTMLElement element, boolean animate) {
<span class="nc bnc" id="L750" title="All 2 branches missed.">        if (!pageLoading()) {</span>
<span class="nc bnc" id="L751" title="All 2 branches missed.">            if (!document.contains(element)) {</span>
<span class="nc" id="L752">                throw new IllegalArgumentException(&quot;The specified element is not contained in the current document.&quot;);</span>
            }
<span class="nc" id="L754">            Vector v = element.getUi();</span>
<span class="nc bnc" id="L755" title="All 4 branches missed.">            if ((v != null) &amp;&amp; (v.size() &gt; 0)) {</span>
<span class="nc" id="L756">                Component cmp = ((Component) v.firstElement());</span>
<span class="nc bnc" id="L757" title="All 2 branches missed.">                if (cmp != null) {</span>
<span class="nc" id="L758">                    Container parent = cmp.getParent();</span>
<span class="nc" id="L759">                    int y = cmp.getY();</span>
<span class="nc bnc" id="L760" title="All 4 branches missed.">                    while ((parent != null) &amp;&amp; (parent != this)) {</span>
<span class="nc" id="L761">                        y += parent.getY();</span>
<span class="nc" id="L762">                        parent = parent.getParent();</span>
                    }
<span class="nc" id="L764">                    scrollTo(y, animate);</span>
                }
            }
<span class="nc" id="L767">        } else {</span>
<span class="nc" id="L768">            throw new IllegalStateException(&quot;Page is still loading&quot;);</span>
        }
<span class="nc" id="L770">    }</span>

    /**
     * Scrolls the HTMLComponent to the denoted Y position
     *
     * @param y       The Y-coordinate to scroll to
     * @param animate true to animate the scrolling, false otherwise
     */
    private void scrollTo(int y, boolean animate) {
<span class="nc bnc" id="L779" title="All 2 branches missed.">        if (y &lt; 0) {</span>
<span class="nc" id="L780">            y = 0;</span>
<span class="nc bnc" id="L781" title="All 2 branches missed.">        } else if (y &gt; getPreferredH() - getHeight()) {</span>
<span class="nc" id="L782">            y = getPreferredH() - getHeight();</span>
        }
<span class="nc bnc" id="L784" title="All 2 branches missed.">        if (animate) {</span>
<span class="nc" id="L785">            scrollRectToVisible(getX(), y, getWidth(), getHeight(), this);</span>
        } else {
<span class="nc" id="L787">            setScrollY(y);</span>
        }
<span class="nc" id="L789">    }</span>

    /**
     * Sets the given string containing HTML code as this HTMLComponent's body
     *
     * @param htmlText The HTML body to set
     */
    public void setBodyText(String htmlText) {
<span class="nc" id="L797">        setBodyText(htmlText, null);</span>
<span class="nc" id="L798">    }</span>

    /**
     * Sets the given string containing HTML code as this HTMLComponent's body.
     * The string is read using the specified encoding. If the encoding is not supported it will be read without encoding
     *
     * @param htmlText The HTML body to set
     * @param encoding The encoding to use when reading the HTML i.e. UTF8, ISO-8859-1 etc.
     * @return true if the encoding succeeded, false otherwise
     */
    public boolean setBodyText(String htmlText, String encoding) {
<span class="nc" id="L809">        return setHTML(htmlText, encoding, null, false);</span>
    }

    /**
     * Sets the given string containing HTML code either as this HTMLComponent's body or as the full HTML.
     * The string is read using the specified encoding. If the encoding is not supported it will be read without encoding
     *
     * @param htmlText   The HTML to set
     * @param encoding   The encoding to use when reading the HTML i.e. UTF8, ISO-8859-1 etc.
     * @param title      The HTML title, or null if none (Used only when isFullHTML is false)
     * @param isFullHTML true if this is a full HTML document (with html/body tags), false if this HTML should be used as the HTMLComponent's body
     * @return true if the encoding succeeded, false otherwise
     */
    public boolean setHTML(String htmlText, String encoding, String title, boolean isFullHTML) {
<span class="nc" id="L823">        boolean success = true;</span>
<span class="nc" id="L824">        InputStreamReader isr = getStream(htmlText, encoding, title, isFullHTML);</span>

<span class="nc bnc" id="L826" title="All 2 branches missed.">        if (isr == null) {</span>
<span class="nc" id="L827">            isr = getStream(&quot;Encoding error loading string&quot;, null, title, isFullHTML); //TODO - dynamic error messages</span>
<span class="nc" id="L828">            success = false;</span>
        }
<span class="nc" id="L830">        final InputStreamReader isReader = isr;</span>

<span class="nc" id="L832">        Display.getInstance().startThread(new Runnable() {</span>
            public void run() {
<span class="nc" id="L834">                HTMLElement doc = parser.parseHTML(isReader);</span>
<span class="nc" id="L835">                documentReady(null, doc);</span>
<span class="nc" id="L836">            }</span>
<span class="nc" id="L837">        }, &quot;setHTML&quot;).start();</span>

<span class="nc" id="L839">        return success;</span>
    }

    /**
     * Convenience method that calls getStream(String,String,String,boolean)
     *
     * @param htmlText The HTML to set
     * @param encoding The encoding to use when reading the HTML i.e. UTF8, ISO-8859-1 etc.
     * @return A stream representing the HTML
     */
    private InputStreamReader getStream(String htmlText, String encoding) {
<span class="nc" id="L850">        return getStream(htmlText, encoding, null, false);</span>
    }

    /**
     * Obtains a stream of the given HTML with the given encoding
     *
     * @param htmlText   The HTML to set
     * @param encoding   The encoding to use when reading the HTML i.e. UTF8, ISO-8859-1 etc.
     * @param title      The HTML title, or null if none
     * @param isFullHTML true if this is a full HTML document (with html/body tags), false otherwise
     * @return A stream representing the HTML
     */
    private InputStreamReader getStream(String htmlText, String encoding, String title, boolean isFullHTML) {
<span class="nc bnc" id="L863" title="All 2 branches missed.">        if (!isFullHTML) {</span>
<span class="nc" id="L864">            String titleStr = &quot;&quot;;</span>
<span class="nc bnc" id="L865" title="All 2 branches missed.">            if (title != null) {</span>
<span class="nc" id="L866">                titleStr = &quot;&lt;head&gt;&lt;title&gt;&quot; + title + &quot;&lt;/title&gt;&lt;/head&gt;&quot;;</span>
            }
<span class="nc" id="L868">            htmlText = &quot;&lt;html&gt;&quot; + titleStr + &quot;&lt;body&gt;&quot; + htmlText + &quot;&lt;/body&gt;&lt;/html&gt;&quot;;</span>
        }

<span class="nc" id="L871">        ByteArrayInputStream bais = null;</span>
<span class="nc bnc" id="L872" title="All 2 branches missed.">        if (encoding != null) {</span>
            try {
<span class="nc" id="L874">                bais = new ByteArrayInputStream(htmlText.getBytes(encoding));</span>
<span class="nc" id="L875">            } catch (UnsupportedEncodingException ex) {</span>
<span class="nc" id="L876">                ex.printStackTrace();</span>
<span class="nc" id="L877">            }</span>
        }
<span class="nc bnc" id="L879" title="All 2 branches missed.">        if (bais == null) { //encoding wasn't specified or failed</span>
<span class="nc" id="L880">            bais = new ByteArrayInputStream(htmlText.getBytes());</span>
        }

<span class="nc" id="L883">        InputStreamReader isr = null;</span>
<span class="nc bnc" id="L884" title="All 2 branches missed.">        if (encoding != null) {</span>
            try {
<span class="nc" id="L886">                isr = new InputStreamReader(bais, encoding);</span>
<span class="nc" id="L887">            } catch (UnsupportedEncodingException uee) {</span>
<span class="nc" id="L888">                uee.printStackTrace();</span>
<span class="nc" id="L889">            }</span>
        }
<span class="nc bnc" id="L891" title="All 2 branches missed.">        if (isr == null) { //encoding wasn't specified or failed</span>
<span class="nc" id="L892">            isr = new InputStreamReader(bais);</span>
        }
<span class="nc" id="L894">        return isr;</span>
    }

    // debug method for performance measurement
    /*void clickTimer(String str) {
        if (str==null) {
            startTime=System.currentTimeMillis();
            textTime=0;
            msg=&quot;&quot;;
        } else {
            msg+=str+&quot;:&quot;+(System.currentTimeMillis()-startTime)+&quot;\n&quot;;
        }
    }*/

    /**
     * Cancels the loading of the current page
     */
    public void cancel() {
<span class="nc" id="L912">        cancelled = true;</span>
<span class="nc" id="L913">        setPageStatus(HTMLCallback.STATUS_CANCELLED);</span>
<span class="nc" id="L914">        cancelRedirectsAndImages();</span>
<span class="nc" id="L915">    }</span>

    /**
     * Adds the specified cssElement which represents an external CSS file to the external CSS vector
     *
     * @param cssElement The element to add
     */
    void addToExternalCSS(CSSElement cssElement) {
<span class="nc bnc" id="L923" title="All 2 branches missed.">        if (externalCSS == null) {</span>
<span class="nc" id="L924">            externalCSS = new Vector();</span>
        }
<span class="nc" id="L926">        externalCSS.addElement(cssElement);</span>
<span class="nc" id="L927">    }</span>

    /**
     * Adds the specified cssElement which represents an embedded CSS segment to the embedded CSS vector
     *
     * @param cssElement The element to add
     */
    void addToEmebeddedCSS(CSSElement cssElement) {
<span class="nc bnc" id="L935" title="All 2 branches missed.">        if (embeddedCSS == null) {</span>
<span class="nc" id="L936">            embeddedCSS = new Vector();</span>
        }
<span class="nc" id="L938">        embeddedCSS.addElement(cssElement);</span>
<span class="nc" id="L939">    }</span>

    /**
     * Sets this HTMLComponent to render the document in the specified URL
     *
     * @param pageURL The URL containing the HTML document
     */
    public void setPage(final String pageURL) {
<span class="nc" id="L947">        setPage(new DocumentInfo(pageURL));</span>
<span class="nc" id="L948">    }</span>

    /**
     * Sets the style of the page, allowing for example to set transparency to the main page.
     * This applies not only to the current page, but rather to all pages created with this HTMLComponent instance.
     * If both a UIID and a pageStyle were set, the style overrides the UIID.
     *
     * @param pageStyle The style to set to the page
     */
    public void setPageStyle(Style pageStyle) {
<span class="nc" id="L958">        this.pageStyle = pageStyle;</span>
<span class="nc bnc" id="L959" title="All 4 branches missed.">        if ((mainContainer != null) &amp;&amp; (pageStyle != null)) {</span>
<span class="nc" id="L960">            applyPageStyle();</span>
        }
<span class="nc" id="L962">    }</span>

    /**
     * Sets the UIID of the page (the internal container)
     * This applies not only to the current page, but rather to all pages created with this HTMLComponent instance.
     * If both a UIID and a pageStyle were set, the style overrides the UIID.
     *
     * @param pageUIID The UIID that should be applied to the page
     */
    public void setPageUIID(String pageUIID) {
<span class="nc" id="L972">        this.pageUIID = pageUIID;</span>
<span class="nc bnc" id="L973" title="All 4 branches missed.">        if ((mainContainer != null) &amp;&amp; (pageUIID != null)) {</span>
<span class="nc" id="L974">            mainContainer.setUIID(pageUIID);</span>
        }
<span class="nc" id="L976">    }</span>

    /**
     * Applies the user defined page style to the main container. This clones the page style and sets the clone to the page, as various CSS directives may change the style of the main container.
     */
    private void applyPageStyle() {
<span class="nc" id="L982">        Style pageStyleCopy = new Style(pageStyle);</span>
<span class="nc" id="L983">        mainContainer.setUnselectedStyle(pageStyleCopy);</span>
<span class="nc" id="L984">        mainContainer.setSelectedStyle(pageStyleCopy);</span>
<span class="nc" id="L985">    }</span>

    private void cancelCurrent() {
<span class="nc" id="L988">        cancelRedirectsAndImages();</span>
<span class="nc bnc" id="L989" title="All 6 branches missed.">        if ((pageStatus == HTMLCallback.STATUS_REQUESTED) ||</span>
                (pageStatus == HTMLCallback.STATUS_CONNECTED) ||
                (pageStatus == HTMLCallback.STATUS_PARSED)) {  //previous page still loading
<span class="nc" id="L992">            cancel();</span>

            // TODO - This mechanism is far from ideal - handle better page life cycle
<span class="nc" id="L995">            int waitTime = 0;</span>
<span class="nc bnc" id="L996" title="All 4 branches missed.">            while ((pageStatus != HTMLCallback.STATUS_CANCELLED) &amp;&amp; (waitTime &lt; 2500)) {</span>
<span class="nc" id="L997">                System.out.println(&quot;Waiting for previous page to cancel &quot; + System.currentTimeMillis());</span>
                try {
<span class="nc" id="L999">                    Thread.sleep(50);</span>
<span class="nc" id="L1000">                } catch (InterruptedException e) {</span>
<span class="nc" id="L1001">                    Thread.currentThread().interrupt();</span>
<span class="nc" id="L1002">                    break;</span>
<span class="nc" id="L1003">                }</span>
<span class="nc" id="L1004">                waitTime += 50;</span>

            }
        }
<span class="nc" id="L1008">        cancelled = false;</span>
<span class="nc" id="L1009">        cancelledCaught = false;</span>

        if (CLEAN_ON_PAGE_REQUEST) {
<span class="nc" id="L1012">            cleanup();</span>
<span class="nc" id="L1013">            removeAll();</span>
<span class="nc" id="L1014">            revalidate();</span>
        }

<span class="nc" id="L1017">    }</span>

    /**
     * Sets this HTMLComponent to render the document specified in the DocumentInfo object
     *
     * @param docInfo Containing info about the document (url, encoding etc)
     */
    void setPage(final DocumentInfo docInfo) {
<span class="nc" id="L1025">        cancelCurrent();</span>
        //clickTimer(null);
<span class="nc" id="L1027">        this.docInfo = docInfo; // Moved here since when getting CSS imports in embedded style segments, we need to know the relative URL</span>

<span class="nc" id="L1029">        this.pageURL = docInfo.getFullUrl();</span>
<span class="nc bnc" id="L1030" title="All 2 branches missed.">        if (handler instanceof AsyncDocumentRequestHandler) {</span>
<span class="nc" id="L1031">            setPageStatus(HTMLCallback.STATUS_REQUESTED);</span>
<span class="nc" id="L1032">            ((AsyncDocumentRequestHandler) handler).resourceRequestedAsync(docInfo, HTMLComponent.this);</span>
        } else {
<span class="nc" id="L1034">            Display.getInstance().startThread(new Runnable() {</span>

                public void run() {
<span class="nc" id="L1037">                    setPageStatus(HTMLCallback.STATUS_REQUESTED);</span>
<span class="nc" id="L1038">                    InputStream is = handler.resourceRequested(docInfo);</span>
<span class="nc" id="L1039">                    streamReady(is, docInfo);</span>
<span class="nc" id="L1040">                }</span>
<span class="nc" id="L1041">            }, &quot;setPage&quot;).start();</span>
        }
<span class="nc" id="L1043">    }</span>

    /**
     * This method should be called only by AsyncDocumentRequestHandler implementations after an async fetch of a document
     *
     * @param is      The InputStream of the document
     * @param docInfo The document info
     */
    public void streamReady(InputStream is, DocumentInfo docInfo) {
<span class="nc" id="L1052">        InputStreamReader isr = null;</span>
        try {
<span class="nc bnc" id="L1054" title="All 2 branches missed.">            if (is != null) {</span>
<span class="nc" id="L1055">                isr = new InputStreamReader(is, docInfo.getEncoding());</span>
            }
<span class="nc" id="L1057">        } catch (Exception uee) {</span>
<span class="nc" id="L1058">            boolean cont = true;</span>
<span class="nc bnc" id="L1059" title="All 2 branches missed.">            if (htmlCallback != null) {</span>
<span class="nc" id="L1060">                cont = htmlCallback.parsingError(HTMLCallback.ERROR_ENCODING, null, null, null, &quot;Page encoding &quot; + docInfo.getEncoding() + &quot; failed: &quot; + uee.getMessage());</span>
            }
<span class="nc bnc" id="L1062" title="All 2 branches missed.">            if (cont) { //retry without the encoding</span>
                try {
<span class="nc" id="L1064">                    isr = new InputStreamReader(is);</span>
<span class="nc" id="L1065">                } catch (Exception e) {</span>
<span class="nc" id="L1066">                    htmlCallback.parsingError(HTMLCallback.ERROR_ENCODING, null, null, null, &quot;Page loading failed, probably due to wrong encoding. &quot; + e.getMessage());</span>
<span class="nc" id="L1067">                    isr = getStream(&quot;Page loading failed, probably due to encoding mismatch.&quot;, null);</span>
<span class="nc" id="L1068">                    setPageStatus(HTMLCallback.STATUS_ERROR);</span>
<span class="nc" id="L1069">                }</span>
            } else {
<span class="nc" id="L1071">                isr = getStream(&quot;Page encoding not supported&quot;, null);</span>
<span class="nc" id="L1072">                setPageStatus(HTMLCallback.STATUS_ERROR);</span>
            }
<span class="nc" id="L1074">        }</span>

<span class="nc bnc" id="L1076" title="All 2 branches missed.">        if (cancelled) {</span>
<span class="nc" id="L1077">            isr = getStream(&quot;Page loading cancelled by user&quot;, null);</span>
        }

<span class="nc bnc" id="L1080" title="All 2 branches missed.">        if (isr == null) {</span>
<span class="nc bnc" id="L1081" title="All 2 branches missed.">            if (htmlCallback != null) {</span>
<span class="nc" id="L1082">                htmlCallback.parsingError(HTMLCallback.ERROR_CONNECTING, null, null, null, &quot;Error connecting to stream&quot;);</span>
            }
<span class="nc" id="L1084">            setPageStatus(HTMLCallback.STATUS_ERROR);</span>
<span class="nc" id="L1085">            isr = getStream(&quot;Error connecting to stream&quot;, null); //TODO - dynamic error messages</span>
        } else {
<span class="nc" id="L1087">            setPageStatus(HTMLCallback.STATUS_CONNECTED);</span>
        }

<span class="nc" id="L1090">        HTMLElement newDoc = null;</span>

        try {
<span class="nc" id="L1093">            newDoc = parser.parseHTML(isr);</span>
<span class="nc" id="L1094">        } catch (IllegalArgumentException iae) {</span>
<span class="nc" id="L1095">            iae.printStackTrace();</span>
<span class="nc" id="L1096">            setPageStatus(HTMLCallback.STATUS_ERROR);</span>
<span class="nc" id="L1097">            isr = getStream(&quot;Parsing error &quot; + iae.getMessage(), null);</span>
<span class="nc" id="L1098">            newDoc = parser.parseHTML(isr);</span>
<span class="nc" id="L1099">        }</span>

<span class="nc bnc" id="L1101" title="All 2 branches missed.">        if (cancelled) {</span>
<span class="nc" id="L1102">            isr = getStream(&quot;Page loading cancelled by user&quot;, null);</span>
<span class="nc" id="L1103">            newDoc = parser.parseHTML(isr);</span>
        }


<span class="nc" id="L1107">        setPageStatus(HTMLCallback.STATUS_PARSED);</span>
<span class="nc" id="L1108">        documentReady(docInfo, newDoc);</span>

<span class="nc" id="L1110">    }</span>

    /**
     * Sets this HTMLComponent to render the document in the specified DOM
     *
     * @param dom     An HTMLElement representing the root of the HTML document
     * @param baseURL The base URL for this DOM (Necessary if document references relative links)
     * @throws IllegalArgumentException if the HTMLElement supplied is not an 'html' tag
     */
    public void setDOM(HTMLElement dom, String baseURL) {
<span class="nc bnc" id="L1120" title="All 2 branches missed.">        if (dom.getTagId() != HTMLElement.TAG_HTML) {</span>
<span class="nc" id="L1121">            throw new IllegalArgumentException(&quot;HTML root element must be 'html'&quot;);</span>
        }
<span class="nc" id="L1123">        cancelCurrent();</span>
<span class="nc bnc" id="L1124" title="All 2 branches missed.">        if (baseURL != null) {</span>
<span class="nc" id="L1125">            docInfo = new DocumentInfo(baseURL);</span>
        } else {
<span class="nc" id="L1127">            docInfo = null;</span>
        }
<span class="nc" id="L1129">        documentReady(docInfo, dom);</span>
<span class="nc" id="L1130">    }</span>

    private boolean pageLoading() {
<span class="nc bnc" id="L1133" title="All 6 branches missed.">        return ((pageStatus == HTMLCallback.STATUS_REQUESTED) ||</span>
                (pageStatus == HTMLCallback.STATUS_CONNECTED) ||
                (pageStatus == HTMLCallback.STATUS_PARSED));

    }

    /**
     * Returns the DOM representing this document
     *
     * @return An HTMLElement representing the entire current HTML document
     * @throws IllegalStateException if the page is still loading
     */
    public HTMLElement getDOM() {
<span class="nc bnc" id="L1146" title="All 2 branches missed.">        if (pageLoading()) {</span>
<span class="nc" id="L1147">            throw new IllegalStateException(&quot;Page is still loading&quot;);</span>
        }
<span class="nc" id="L1149">        return document;</span>
    }

    /**
     * Sets this HTMLComponent to render the document in the specified DOM.
     * Note that relative links if any will be disabled. To allow relative links with DOM use setDOM(HTMLElement dom,String baseURL)
     *
     * @param dom An HTMLElement representing the root of the HTML document
     * @throws IllegalArgumentException if the HTMLElement supplied is not an 'html' tag
     */
    public void setDOM(HTMLElement dom) {
<span class="nc" id="L1160">        setDOM(dom, null);</span>
<span class="nc" id="L1161">    }</span>

    /**
     * Refreshes the current DOM so it any changes done after loading will be rendered.
     */
    public void refreshDOM() {
<span class="nc" id="L1167">        documentReady(docInfo, document);</span>
<span class="nc" id="L1168">    }</span>

    /**
     * Called internally after both reading and parsing of the HTML document has completed
     *
     * @param pageURL     The URL of the page
     * @param newDocument An element which is the root of the document
     */
    void documentReady(DocumentInfo docInfo, HTMLElement newDocument) {
        //clickTimer(&quot;docReady&quot;);
<span class="nc" id="L1178">        this.pageURL = null;</span>
<span class="nc bnc" id="L1179" title="All 2 branches missed.">        if (docInfo != null) {</span>
<span class="nc" id="L1180">            this.pageURL = docInfo.getUrl();</span>
        }
<span class="nc" id="L1182">        cleanup();</span>
<span class="nc" id="L1183">        document = newDocument;</span>
<span class="nc bnc" id="L1184" title="All 2 branches missed.">        if (supressExceptions) {</span>
            // can happen because page is rebuilt on a separate thread!
            try {
<span class="nc" id="L1187">                rebuildPage();</span>
<span class="nc" id="L1188">            } catch (Throwable t) {</span>
<span class="nc" id="L1189">                t.printStackTrace();</span>
<span class="nc" id="L1190">                return;</span>
<span class="nc" id="L1191">            }</span>
        } else {
<span class="nc" id="L1193">            rebuildPage();</span>
        }
        //clickTimer(&quot;rebuilt&quot;);

<span class="nc bnc" id="L1197" title="All 4 branches missed.">        if ((!cancelled) || (cancelledCaught)) {</span>
<span class="nc" id="L1198">            Display.getInstance().callSerially(new Runnable() {</span>

                public void run() {

<span class="nc bnc" id="L1202" title="All 2 branches missed.">                    if (threadQueue.getCSSCount() == -1) {</span>
<span class="nc" id="L1203">                        displayPage();</span>
                    }
                    //if ( ((!showImages) || (threadQueue.getQueueSize()==0)) {
<span class="nc bnc" id="L1206" title="All 2 branches missed.">                    if (threadQueue.getQueueSize() == 0) {</span>
<span class="nc" id="L1207">                        setPageStatus(HTMLCallback.STATUS_COMPLETED);</span>
                    } else {
<span class="nc" id="L1209">                        threadQueue.startRunning();</span>
                    }

<span class="nc bnc" id="L1212" title="All 2 branches missed.">                    if (pageURL != null) { // pageURL can be null if the page was set using setBodyText and not setPage</span>
<span class="nc" id="L1213">                        int hash = pageURL.indexOf('#');</span>

<span class="nc bnc" id="L1215" title="All 4 branches missed.">                        if ((hash != -1) &amp;&amp; (pageURL.length() &gt; hash + 1)) { // URL contains an anchor</span>
<span class="nc" id="L1216">                            String anchorName = pageURL.substring(hash + 1);</span>
<span class="nc" id="L1217">                            goToAnchor(anchorName);</span>
                        }
                    }


<span class="nc" id="L1222">                }</span>
            });
        } else { // Page was cancelled
<span class="nc" id="L1225">            cancelled = false;</span>
<span class="nc" id="L1226">            InputStreamReader isr = getStream(&quot;Page loading cancelled by user&quot;, null);</span>
<span class="nc" id="L1227">            HTMLElement newDoc = parser.parseHTML(isr);</span>
<span class="nc" id="L1228">            documentReady(docInfo, newDoc);</span>
        }

<span class="nc" id="L1231">    }</span>

    void cssCompleted() {
<span class="nc" id="L1234">        Display.getInstance().callSerially(new Runnable() {</span>

            public void run() {
<span class="nc" id="L1237">                displayPage();</span>
<span class="nc" id="L1238">            }</span>
        });
<span class="nc" id="L1240">    }</span>

    /**
     * Returns the current status of the events enabled flag
     *
     * @return true if events are enabled, false if not
     */
    public boolean isEventsEnabled() {
<span class="nc" id="L1248">        return eventsEnabled;</span>
    }

    /**
     * Sets whether the active controls in the HTML will trigger events, and whether the DOM will change dynamically due to user input.
     * If so the events are dispatched via HTMLCallback methods actionPerformed, focusGained/Lost, selectionChanged and dataChanged
     * The default is false in order not to add more overhead if these are not needed.
     *
     * @param enabled true to enable event dispatching, false otherwise
     */
    public void setEventsEnabled(boolean enabled) {
<span class="nc bnc" id="L1259" title="All 2 branches missed.">        if (eventsEnabled != enabled) {</span>
<span class="nc" id="L1260">            eventsEnabled = enabled;</span>
<span class="nc bnc" id="L1261" title="All 2 branches missed.">            if (!enabled) {</span>
<span class="nc" id="L1262">                eventsListener.deregisterAll();</span>
<span class="nc" id="L1263">                eventsListener = null;</span>
            } else {
<span class="nc" id="L1265">                eventsListener = new HTMLEventsListener(this);</span>
            }
        }
<span class="nc" id="L1268">    }</span>

    /**
     * Determines whether to auto-focus on the first link after page load
     * Note that focusing will happen only if the link is within a visible range (no scrolling is performed since this is rarely a wanted behaviour in this case)
     *
     * @param autoFocus true to auto-focus, false otherwise
     */
    public void setAutoFocusOnFirstLink(boolean autoFocus) {
<span class="nc" id="L1277">        this.autoFocus = autoFocus;</span>
<span class="nc" id="L1278">    }</span>

    /**
     * Actually displays the HTML page - this should be run on EDT
     */
    void displayPage() {
<span class="nc" id="L1284">        removeAll();</span>
<span class="nc" id="L1285">        addComponent(mainContainer);</span>
<span class="nc" id="L1286">        setScrollY(0);</span>

<span class="nc" id="L1288">        revalidate();</span>
<span class="nc" id="L1289">        repaint();</span>

        //Places the focus on the first link in the page, as long as it is within the visible area of the first page
<span class="nc bnc" id="L1292" title="All 2 branches missed.">        if (getComponentForm() != null) {</span>
<span class="nc" id="L1293">            getComponentForm().revalidate(); // a revalidate on the component itself does not always result in correct size calculation, thus leaving unreachable elements in the HTML (Note that the first revalidate on the component is also necessary)</span>
<span class="nc bnc" id="L1294" title="All 2 branches missed.">            if (firstFocusable != null) {</span>
<span class="nc bnc" id="L1295" title="All 2 branches missed.">                if (autoFocus) {</span>
<span class="nc bnc" id="L1296" title="All 2 branches missed.">                    if (firstFocusable.getY() &lt; getHeight()) {</span>
<span class="nc" id="L1297">                        getComponentForm().setFocused(firstFocusable);</span>
                    } else {
<span class="nc" id="L1299">                        getComponentForm().setFocused(mainContainer);</span>
                    }
                }
            } else {
<span class="nc" id="L1303">                mainContainer.setFocusable(true); // If there are no focused components, the main container will become focusable, thus enabling it to be pixel-scrolled</span>
<span class="nc" id="L1304">                getComponentForm().setFocused(mainContainer);</span>
            }

<span class="nc bnc" id="L1307" title="All 2 branches missed.">            if (marqueeComponents.size() &gt; 0) {</span>
<span class="nc" id="L1308">                getComponentForm().registerAnimated(HTMLComponent.this);</span>
<span class="nc bnc" id="L1309" title="All 2 branches missed.">                int dir = getUIManager().getLookAndFeel().isRTL() ? 1 : -1;</span>
<span class="nc" id="L1310">                marqueeMotion = Motion.createLinearMotion(0, dir * HTMLComponent.this.getWidth(), MARQUEE_DELAY / 2);</span>
<span class="nc" id="L1311">                marqueeMotion.start();</span>
            }


        }

<span class="nc" id="L1317">        setPageStatus(HTMLCallback.STATUS_DISPLAYED);</span>
<span class="nc bnc" id="L1318" title="All 2 branches missed.">        if (getComponentForm() != null) {</span>
<span class="nc" id="L1319">            getComponentForm().revalidate();</span>
        }
<span class="nc" id="L1321">    }</span>

    public boolean animate() {
<span class="nc" id="L1324">        boolean result = super.animate();</span>
<span class="nc bnc" id="L1325" title="All 2 branches missed.">        if (marqueeMotion == null) {</span>
<span class="nc" id="L1326">            return result;</span>
        }
<span class="nc bnc" id="L1328" title="All 2 branches missed.">        for (Enumeration e = marqueeComponents.elements(); e.hasMoreElements(); ) {</span>
<span class="nc" id="L1329">            Component cmp = (Component) e.nextElement();</span>
<span class="nc" id="L1330">            cmp.setX(marqueeMotion.getValue());</span>
<span class="nc" id="L1331">        }</span>
<span class="nc bnc" id="L1332" title="All 2 branches missed.">        if (marqueeMotion.isFinished()) {</span>
<span class="nc bnc" id="L1333" title="All 2 branches missed.">            int dir = getUIManager().getLookAndFeel().isRTL() ? 1 : -1;</span>
<span class="nc" id="L1334">            marqueeMotion = Motion.createLinearMotion(dir * -HTMLComponent.this.getWidth(), dir * HTMLComponent.this.getWidth(), MARQUEE_DELAY);</span>
<span class="nc" id="L1335">            marqueeMotion.start();</span>
        }

<span class="nc" id="L1338">        return true;</span>
    }

    /**
     * Returns the HTML page's title as described in its TITLE tag
     *
     * @return the HTML page's title as described in its TITLE tag
     */
    public String getTitle() {
<span class="nc" id="L1347">        return title;</span>
    }

    /**
     * Returns the page's URL
     *
     * @return the current page's URL
     */
    public String getPageURL() {
<span class="nc" id="L1356">        return pageURL;</span>
    }

    /**
     * Returns the page status
     *
     * @return the page status (One of the STATUS_* constants in HTMLCallback)
     */
    public int getPageStatus() {
<span class="nc" id="L1365">        return pageStatus;</span>
    }

    /**
     * Sets the page status to the given one
     *
     * @param status The new page status
     */
    void setPageStatus(final int status) {
<span class="nc bnc" id="L1374" title="All 4 branches missed.">        if ((!pageError) || (status == HTMLCallback.STATUS_REQUESTED)) { //Once the page error flag has been raised the page status doesn't change until a new page is requested</span>
<span class="nc" id="L1375">            pageStatus = status;</span>
<span class="nc bnc" id="L1376" title="All 2 branches missed.">            if (htmlCallback != null) {</span>
<span class="nc bnc" id="L1377" title="All 2 branches missed.">                if (Display.getInstance().isEdt()) {</span>
<span class="nc" id="L1378">                    htmlCallback.pageStatusChanged(this, status, pageURL);</span>
                } else {
<span class="nc" id="L1380">                    Display.getInstance().callSerially(new Runnable() {</span>
                        public void run() {
<span class="nc" id="L1382">                            htmlCallback.pageStatusChanged(HTMLComponent.this, status, pageURL);</span>
<span class="nc" id="L1383">                        }</span>
                    });
                }
            }
<span class="nc bnc" id="L1387" title="All 4 branches missed.">            pageError = ((status == HTMLCallback.STATUS_ERROR) || (status == HTMLCallback.STATUS_CANCELLED));</span>
<span class="nc bnc" id="L1388" title="All 2 branches missed.">            cancelledCaught = (status == HTMLCallback.STATUS_CANCELLED);</span>
        }
<span class="nc" id="L1390">    }</span>

    /**
     * Returns the closest font by the given parameters
     *
     * @param family The font family
     * @param size   The font size
     * @param style  The font style (Font.STYLE_PLAIN or Font.STYLE_ITALIC)
     * @param weight The font weight (Font.STYLE_PLAIN or Font.STYLE_BOLD)
     * @return the closest font the HTMLComponent could find or null if none found.
     */
    HTMLFont getClosestHTMLFont(String family, int size, int style, int weight) {
<span class="nc" id="L1402">        final int FACTOR_FONT_FAMILY = 30;</span>
<span class="nc" id="L1403">        final int FACTOR_FONT_SIZE = 5;</span>
<span class="nc" id="L1404">        final int FACTOR_FONT_STYLE = 10;</span>
<span class="nc" id="L1405">        HTMLFont bestFit = null;</span>
<span class="nc" id="L1406">        int bestFitDistance = 10000;</span>
<span class="nc" id="L1407">        Enumeration e = fonts.elements();</span>
<span class="nc bnc" id="L1408" title="All 2 branches missed.">        while (e.hasMoreElements()) {</span>
<span class="nc" id="L1409">            int curFontDistance = 0;</span>
<span class="nc" id="L1410">            HTMLFont hFont = (HTMLFont) e.nextElement();</span>
<span class="nc bnc" id="L1411" title="All 2 branches missed.">            if ((MATCH_BITMAP_FONTS_ONLY) &amp;&amp; (hFont.isSystemFont())) {</span>
<span class="nc" id="L1412">                continue;</span>
            }
<span class="nc bnc" id="L1414" title="All 2 branches missed.">            if (family != null) {</span>
<span class="nc bnc" id="L1415" title="All 4 branches missed.">                if ((hFont.getFamily() == null) || (!hFont.getFamily().equalsIgnoreCase(family))) {</span>
                    if (MATCH_SAME_FONT_FAMILY_ONLY) {
<span class="nc" id="L1417">                        continue;</span>
                    }
                    curFontDistance += FACTOR_FONT_FAMILY;
                }
            }
<span class="nc bnc" id="L1422" title="All 2 branches missed.">            if (size &gt; 0) {</span>
<span class="nc" id="L1423">                curFontDistance += Math.abs(size - hFont.getSizeInPixels()) * FACTOR_FONT_SIZE;</span>
            }

<span class="nc bnc" id="L1426" title="All 2 branches missed.">            if (weight &gt;= 0) {</span>
<span class="nc bnc" id="L1427" title="All 2 branches missed.">                if ((weight &amp; Font.STYLE_BOLD) != (hFont.getStyle() &amp; Font.STYLE_BOLD)) {</span>
<span class="nc" id="L1428">                    curFontDistance += FACTOR_FONT_STYLE;</span>
                }
            }
<span class="nc bnc" id="L1431" title="All 2 branches missed.">            if (style &gt;= 0) {</span>
<span class="nc bnc" id="L1432" title="All 2 branches missed.">                if ((style &amp; Font.STYLE_ITALIC) != (hFont.getStyle() &amp; Font.STYLE_ITALIC)) {</span>
<span class="nc" id="L1433">                    curFontDistance += FACTOR_FONT_STYLE;</span>
                }
            }
<span class="nc bnc" id="L1436" title="All 2 branches missed.">            if (curFontDistance &lt; bestFitDistance) {</span>
<span class="nc" id="L1437">                bestFitDistance = curFontDistance;</span>
<span class="nc" id="L1438">                bestFit = hFont;</span>

<span class="nc bnc" id="L1440" title="All 2 branches missed.">                if (curFontDistance == 0) { //exact match</span>
<span class="nc" id="L1441">                    break;</span>
                }

            }

<span class="nc" id="L1446">        }</span>
<span class="nc bnc" id="L1447" title="All 2 branches missed.">        if ((bestFit == null) || ((MATCH_EXACT_FONTS_ONLY) &amp;&amp; (bestFitDistance != 0))) {</span>
<span class="nc" id="L1448">            return null;</span>
        } else {
<span class="nc" id="L1450">            return bestFit;</span>
        }
    }

    Font getClosestFont(String family, int size, int style, int weight) {
<span class="nc" id="L1455">        HTMLFont f = getClosestHTMLFont(family, size, style, weight);</span>
<span class="nc bnc" id="L1456" title="All 2 branches missed.">        if (f != null) {</span>
<span class="nc" id="L1457">            return f.getFont();</span>
        }
<span class="nc" id="L1459">        return null;</span>
    }

    /**
     * Returns the HTMLFont that holds the given font.
     * This is in fact a &quot;reverse lookup&quot; for HTMLFonts
     *
     * @param font The font to search
     * @return the HTMLFont that holds the given font.
     */
    HTMLFont getHTMLFont(Font font) {
<span class="nc bnc" id="L1470" title="All 2 branches missed.">        for (Enumeration e = fonts.elements(); e.hasMoreElements(); ) {</span>
<span class="nc" id="L1471">            HTMLFont hFont = (HTMLFont) e.nextElement();</span>
<span class="nc bnc" id="L1472" title="All 2 branches missed.">            if (hFont.getFont() == font) {</span>
<span class="nc" id="L1473">                return hFont;</span>
            }
<span class="nc" id="L1475">        }</span>
<span class="nc" id="L1476">        return null;</span>
    }

    /**
     * Returns true if there's at least one smallcaps font in the fonts repository, or false otherwise
     *
     * @return true if there's at least one smallcaps font in the fonts repository, or false otherwise
     */
    boolean isSmallCapsFontAvailable() {
<span class="nc bnc" id="L1485" title="All 2 branches missed.">        for (Enumeration e = fonts.elements(); e.hasMoreElements(); ) {</span>
<span class="nc" id="L1486">            HTMLFont hFont = (HTMLFont) e.nextElement();</span>
<span class="nc bnc" id="L1487" title="All 4 branches missed.">            if ((hFont.getFamily() != null) &amp;&amp; (hFont.getFamily().equals(CSSElement.SMALL_CAPS_STRING))) {</span>
<span class="nc" id="L1488">                return true;</span>
            }
<span class="nc" id="L1490">        }</span>
<span class="nc" id="L1491">        return false;</span>
    }

    /**
     * A utility method to convert between Element TAG_* constants and HTMLFont font attribute constants.
     *
     * @param tag  The tag that describes the font attribute
     * @param font The font for which we want a counterpart font
     * @return the counterpart font for the given font in the specified tag sense.
     */
    private HTMLFont getCounterpartFont(int tag, HTMLFont font) {
<span class="nc" id="L1502">        int attribute = -1;</span>
<span class="nc bnc" id="L1503" title="All 5 branches missed.">        switch (tag) {</span>
            case HTMLElement.TAG_B:
<span class="nc" id="L1505">                attribute = HTMLFont.BOLD;</span>
<span class="nc" id="L1506">                break;</span>
            case HTMLElement.TAG_I:
<span class="nc" id="L1508">                attribute = HTMLFont.ITALIC;</span>
<span class="nc" id="L1509">                break;</span>
            case HTMLElement.TAG_BIG:
<span class="nc" id="L1511">                attribute = HTMLFont.BIG;</span>
<span class="nc" id="L1512">                break;</span>
            case HTMLElement.TAG_SMALL:
<span class="nc" id="L1514">                attribute = HTMLFont.SMALL;</span>
                break;
        }
<span class="nc bnc" id="L1517" title="All 2 branches missed.">        if (attribute == -1) {</span>
<span class="nc" id="L1518">            return font;</span>
        }
<span class="nc" id="L1520">        return getCounterpartFontByAttribute(attribute, font);</span>
    }

    /**
     * Returns the counterpart font according to the given attribute and font
     *
     * @param attribute The requested attribute, one of HTMLFont.BOLD/ITALIC/BIG/SMALL
     * @param font      The source font
     * @return the counterpart font according to the given attribute and font
     */
    HTMLFont getCounterpartFontByAttribute(int attribute, HTMLFont font) {
<span class="nc" id="L1531">        HTMLFont cFont = font.getCounterpartFont(attribute);</span>
<span class="nc bnc" id="L1532" title="All 2 branches missed.">        if (cFont != null) {</span>
<span class="nc" id="L1533">            return cFont;</span>
        }

<span class="nc" id="L1536">        HTMLFont bestFit = null;</span>
<span class="nc" id="L1537">        Enumeration e = fonts.elements();</span>
<span class="nc bnc" id="L1538" title="All 2 branches missed.">        while (e.hasMoreElements()) {</span>
<span class="nc" id="L1539">            HTMLFont hFont = (HTMLFont) e.nextElement();</span>
<span class="nc bnc" id="L1540" title="All 2 branches missed.">            if (hFont.isCounterpart(attribute, font)) {</span>
<span class="nc bnc" id="L1541" title="All 2 branches missed.">                if (attribute == HTMLFont.BIG) { //takes the closests font (i.e. big but not biggest)</span>
<span class="nc bnc" id="L1542" title="All 4 branches missed.">                    if ((bestFit == null) || (bestFit.getSize() &gt; hFont.getSize())) {</span>
<span class="nc" id="L1543">                        bestFit = hFont;</span>
                    }
<span class="nc bnc" id="L1545" title="All 2 branches missed.">                } else if (attribute == HTMLFont.SMALL) {</span>
<span class="nc bnc" id="L1546" title="All 4 branches missed.">                    if ((bestFit == null) || (bestFit.getSize() &lt; hFont.getSize())) {</span>
<span class="nc" id="L1547">                        bestFit = hFont;</span>
                    }
                } else { // BOLD, ITALIC
<span class="nc" id="L1550">                    font.setCounterpartFont(attribute, hFont);</span>
<span class="nc" id="L1551">                    return hFont;</span>
                }
            }
<span class="nc" id="L1554">        }</span>

<span class="nc bnc" id="L1556" title="All 2 branches missed.">        if (bestFit == null) {</span>
<span class="nc" id="L1557">            bestFit = font;</span>
        }
<span class="nc" id="L1559">        font.setCounterpartFont(attribute, bestFit);</span>
<span class="nc" id="L1560">        return bestFit;</span>
    }

    /**
     * Cleans this element and its children of any associated UI components
     *
     * @param element The element to clean
     */
    private void cleanElementUI(HTMLElement element) {
<span class="nc" id="L1569">        element.clearAssociatedComponents();</span>
<span class="nc" id="L1570">        int children = element.getNumChildren();</span>
<span class="nc bnc" id="L1571" title="All 2 branches missed.">        for (int i = 0; i &lt; children; i++) {</span>
<span class="nc" id="L1572">            HTMLElement child = (HTMLElement) element.getChildAt(i);</span>
<span class="nc" id="L1573">            cleanElementUI(child);</span>
        }
<span class="nc" id="L1575">    }</span>

    /**
     * Rebuilds the HTMLComponent, this is called usually after a new page was loaded.
     */
    private void cleanup() {
<span class="nc bnc" id="L1581" title="All 2 branches missed.">        if (document != null) {</span>
<span class="nc" id="L1582">            cleanElementUI(document);</span>
        }
<span class="nc bnc" id="L1584" title="All 2 branches missed.">        if (eventsListener != null) {</span>
<span class="nc" id="L1585">            eventsListener.deregisterAll();</span>
        }

<span class="nc" id="L1588">        displayWidth = Display.getInstance().getDisplayWidth();</span>

        //reset all building process values

<span class="nc" id="L1592">        leftIndent = 0;</span>
<span class="nc" id="L1593">        x = 0;</span>

<span class="nc" id="L1595">        containers = new Vector();</span>
        //embeddedCSS=null; // Shouldn't nullify as embedded style tag is collected in the head phase which is before..
<span class="nc" id="L1597">        marqueeComponents = new Vector();</span>
<span class="nc" id="L1598">        marqueeMotion = null;</span>
<span class="nc" id="L1599">        anchors = new Hashtable();</span>
<span class="nc" id="L1600">        anchor = null;</span>

<span class="nc" id="L1602">        accesskey = '\0';</span>
<span class="nc bnc" id="L1603" title="All 2 branches missed.">        for (Enumeration e = accessKeys.keys(); e.hasMoreElements(); ) {</span>
<span class="nc" id="L1604">            int keyCode = ((Integer) e.nextElement()).intValue();</span>
<span class="nc" id="L1605">            getComponentForm().removeKeyListener(keyCode, this);</span>
<span class="nc" id="L1606">        }</span>
<span class="nc" id="L1607">        accessKeys.clear(); //=new Hashtable();</span>

<span class="nc" id="L1609">        fieldsets = new Vector();</span>

<span class="nc" id="L1611">        curTable = null;</span>
<span class="nc" id="L1612">        tables = new Vector();</span>
<span class="nc" id="L1613">        tableCells = new Vector();</span>

<span class="nc" id="L1615">        ulLevel = 0;</span>
<span class="nc" id="L1616">        olIndex = Integer.MIN_VALUE;</span>
<span class="nc" id="L1617">        olUpperLevelIndex = new Vector();</span>
<span class="nc" id="L1618">        listType = HTMLListIndex.LIST_NUMERIC;</span>

<span class="nc" id="L1620">        underlineCount = 0;</span>
<span class="nc" id="L1621">        strikethruCount = 0;</span>
<span class="nc" id="L1622">        textDecoration = 0;</span>
<span class="nc" id="L1623">        imageMapComponents = null;</span>
<span class="nc" id="L1624">        imageMapData = null;</span>
<span class="nc" id="L1625">        curImageMap = null;</span>
<span class="nc" id="L1626">        superscript = 0;</span>
<span class="nc" id="L1627">        maxSuperscript = 0;</span>
<span class="nc" id="L1628">        counters = null;</span>

<span class="nc" id="L1630">        font = defaultFont;</span>

<span class="nc" id="L1632">        labelForID = null;</span>
<span class="nc" id="L1633">        inputFields = new Hashtable();</span>

<span class="nc" id="L1635">        link = null;</span>
<span class="nc" id="L1636">        linkVisited = false;</span>
<span class="nc" id="L1637">        mainLink = null;</span>
<span class="nc" id="L1638">        firstFocusable = null;</span>

<span class="nc" id="L1640">        curForm = null;</span>
<span class="nc" id="L1641">        curTextArea = null;</span>
<span class="nc" id="L1642">        curComboBox = null;</span>
<span class="nc" id="L1643">        textfieldsToForms = new Hashtable();</span>

<span class="nc" id="L1645">        optionTag = false;</span>
<span class="nc" id="L1646">        optionSelected = false;</span>

<span class="nc" id="L1648">        preTagCount = 0;</span>
<span class="nc" id="L1649">        quoteTagCount = 0;</span>

<span class="nc" id="L1651">        mainContainer = new Container();</span>
<span class="nc bnc" id="L1652" title="All 2 branches missed.">        if (pageUIID != null) {</span>
<span class="nc" id="L1653">            mainContainer.setUIID(pageUIID);</span>
        }

<span class="nc bnc" id="L1656" title="All 2 branches missed.">        if (pageStyle != null) {</span>
<span class="nc" id="L1657">            applyPageStyle();</span>
        }

<span class="nc" id="L1660">        mainContainer.setScrollableX(false);</span>
<span class="nc" id="L1661">        mainContainer.setLayout(new BoxLayout(BoxLayout.Y_AXIS));</span>

<span class="nc" id="L1663">        curContainer = mainContainer;</span>
<span class="nc" id="L1664">        curLine = new Container();</span>
<span class="nc" id="L1665">        lastWasEmpty = false;</span>

<span class="nc" id="L1667">        width = Display.getInstance().getDisplayWidth() - getStyle().getMargin(Component.LEFT) - getStyle().getPadding(Component.LEFT) -</span>
<span class="nc" id="L1668">                getStyle().getMargin(Component.RIGHT) - getStyle().getPadding(Component.RIGHT) - 10; // The -10 is arbitrary to avoid edge cases</span>

<span class="nc" id="L1670">        textColor = DEFAULT_TEXT_COLOR;</span>
<span class="nc" id="L1671">    }</span>

    /**
     * Handles a LINK tag and extracts any linked CSS file
     *
     * @param linkTag AN element containing the LINK tag
     */
    private void handleLinkTag(HTMLElement linkTag) {
<span class="nc" id="L1679">        String linkType = linkTag.getAttributeById(HTMLElement.ATTR_TYPE);</span>
<span class="nc" id="L1680">        String media = linkTag.getAttributeById(HTMLElement.ATTR_MEDIA);</span>
<span class="nc" id="L1681">        String href = linkTag.getAttributeById(HTMLElement.ATTR_HREF);</span>
<span class="nc" id="L1682">        String charset = linkTag.getAttributeById(HTMLElement.ATTR_CHARSET);</span>
<span class="nc bnc" id="L1683" title="All 8 branches missed.">        if ((linkType != null) &amp;&amp; (linkType.equalsIgnoreCase(&quot;text/css&quot;)) &amp;&amp; (href != null) &amp;&amp; (CSSParser.getInstance().mediaTypeMatches(media))) {</span>
<span class="nc bnc" id="L1684" title="All 2 branches missed.">            if (docInfo != null) {</span>
<span class="nc" id="L1685">                threadQueue.addCSS(docInfo.convertURL(href), charset);</span>
            } else {
<span class="nc bnc" id="L1687" title="All 2 branches missed.">                if (DocumentInfo.isAbsoluteURL(href)) {</span>
<span class="nc" id="L1688">                    threadQueue.addCSS(href, charset);</span>
                } else {
<span class="nc bnc" id="L1690" title="All 2 branches missed.">                    if (htmlCallback != null) {</span>
<span class="nc" id="L1691">                        htmlCallback.parsingError(HTMLCallback.ERROR_NO_BASE_URL, linkTag.getTagName(), linkTag.getAttributeName(Integer.valueOf(HTMLElement.ATTR_HREF)), href, &quot;Ignoring CSS file referred in a LINK tag (&quot; + href + &quot;), since page was set by setBody/setHTML/setDOM so there's no way to access relative URLs&quot;);</span>
                    }

                }
            }
        }
<span class="nc" id="L1697">    }</span>

    private void rebuildPage() {

        // Scan for LINK tags directly under the ROOT element, these are in fact converted &lt;?xml-stylesheet ... ?&gt; processing instructions
        // NOTE: Since only single root XML are supported, no converted tags can exist before the HTML tag
        /*if ((SUPPORT_CSS) &amp;&amp; (loadCSS)) {
            for(int i=0;i&lt;document.getNumChildren();i++) {
                HTMLElement child=(HTMLElement)document.getChildAt(i);
                if (child.getId()==HTMLElement.TAG_LINK) {
                    handleLinkTag(child);
                }
            }
        }*/

        // Get the HTML root tag and extract the HEAD and BODY (Note that the document tag is ROOT which contains HTML and so on.
        //HTMLElement html=document.getChildById(HTMLElement.TAG_HTML);
<span class="nc" id="L1714">        HTMLElement html = null;</span>
<span class="nc bnc" id="L1715" title="All 2 branches missed.">        if (document.getTagId() == HTMLElement.TAG_HTML) {</span>
<span class="nc" id="L1716">            html = document;</span>
        }
<span class="nc" id="L1718">        HTMLElement body = null;</span>
<span class="nc" id="L1719">        HTMLElement head = null;</span>
<span class="nc" id="L1720">        String dir = null;</span>
<span class="nc bnc" id="L1721" title="All 2 branches missed.">        if (html != null) {</span>
<span class="nc" id="L1722">            dir = html.getAttributeById(HTMLElement.ATTR_DIR);</span>
<span class="nc" id="L1723">            body = html.getFirstChildByTagId(HTMLElement.TAG_BODY);</span>
<span class="nc bnc" id="L1724" title="All 2 branches missed.">            if ((!PROCESS_HTML_MP1_ONLY) &amp;&amp; (body == null)) { // frames html does not contain body - but may contain a 'noframes' tag to display</span>
<span class="nc" id="L1725">                Vector noFrames = html.getDescendantsByTagId(HTMLElement.TAG_NOFRAMES);</span>
<span class="nc bnc" id="L1726" title="All 4 branches missed.">                if ((noFrames != null) &amp;&amp; (noFrames.size() &gt; 0)) {</span>
<span class="nc" id="L1727">                    body = (HTMLElement) noFrames.elementAt(0);</span>
                }
            }
<span class="nc" id="L1730">            head = html.getFirstChildByTagId(HTMLElement.TAG_HEAD);</span>
        }

        // Fetch the document's title
<span class="nc" id="L1734">        title = null;</span>
<span class="nc bnc" id="L1735" title="All 2 branches missed.">        if (head != null) {</span>
<span class="nc" id="L1736">            HTMLElement baseTag = head.getFirstChildByTagId(HTMLElement.TAG_BASE);</span>
<span class="nc bnc" id="L1737" title="All 2 branches missed.">            if (baseTag != null) {</span>
<span class="nc" id="L1738">                String baseURL = baseTag.getAttributeById(HTMLElement.ATTR_HREF);</span>
<span class="nc bnc" id="L1739" title="All 4 branches missed.">                if ((baseURL != null) &amp;&amp; (docInfo != null)) {</span>
<span class="nc" id="L1740">                    docInfo.setBaseURL(baseURL);</span>
                }
            }
<span class="nc" id="L1743">            HTMLElement titleTag = head.getFirstChildByTagId(HTMLElement.TAG_TITLE);</span>
<span class="nc bnc" id="L1744" title="All 4 branches missed.">            if ((titleTag != null) &amp;&amp; (titleTag.getNumChildren() &gt; 0)) {</span>
<span class="nc" id="L1745">                HTMLElement titleText = (HTMLElement) titleTag.getChildAt(0);</span>
<span class="nc bnc" id="L1746" title="All 2 branches missed.">                if (titleText != null) {</span>
<span class="nc" id="L1747">                    title = titleText.getText();</span>
                }
            }

<span class="nc" id="L1751">            HTMLElement basefontTag = head.getFirstChildByTagId(HTMLElement.TAG_BASEFONT);</span>
<span class="nc bnc" id="L1752" title="All 2 branches missed.">            if (basefontTag != null) {</span>
<span class="nc" id="L1753">                textColor = HTMLElement.getColor(basefontTag.getAttributeById(HTMLElement.ATTR_COLOR), textColor);</span>

<span class="nc" id="L1755">                String family = basefontTag.getAttributeById(HTMLElement.ATTR_FACE);</span>
<span class="nc" id="L1756">                int size = getInt(basefontTag.getAttributeById(HTMLElement.ATTR_SIZE));</span>
<span class="nc bnc" id="L1757" title="All 4 branches missed.">                if ((family != null) || (size != 0)) {</span>
<span class="nc" id="L1758">                    HTMLFont f = getClosestHTMLFont(family, size, 0, 0);</span>
<span class="nc bnc" id="L1759" title="All 2 branches missed.">                    if (f != null) {</span>
<span class="nc" id="L1760">                        font = f;</span>
                    }
                }
            }

<span class="nc bnc" id="L1765" title="All 2 branches missed.">            if ((SUPPORT_CSS) &amp;&amp; (loadCSS)) { // Scan for LINK tags under the HEAD tag</span>
<span class="nc bnc" id="L1766" title="All 2 branches missed.">                for (int i = 0; i &lt; head.getNumChildren(); i++) {</span>
<span class="nc" id="L1767">                    HTMLElement child = (HTMLElement) head.getChildAt(i);</span>
<span class="nc bnc" id="L1768" title="All 2 branches missed.">                    if (child.getTagId() == HTMLElement.TAG_LINK) {</span>
<span class="nc" id="L1769">                        handleLinkTag(child);</span>
                    }
                }
            }

        }

<span class="nc bnc" id="L1776" title="All 2 branches missed.">        if (htmlCallback != null) {</span>
<span class="nc" id="L1777">            Display.getInstance().callSerially(new Runnable() {</span>
                public void run() {
<span class="nc" id="L1779">                    htmlCallback.titleUpdated(HTMLComponent.this, title);</span>
<span class="nc" id="L1780">                }</span>
            });
        }

<span class="nc bnc" id="L1784" title="All 2 branches missed.">        if (body != null) {</span>
<span class="nc" id="L1785">            bgColor = HTMLElement.getColor(body.getAttributeById(HTMLElement.ATTR_BGCOLOR), -1);</span>
<span class="nc" id="L1786">            textColor = HTMLElement.getColor(body.getAttributeById(HTMLElement.ATTR_TEXT), textColor);</span>
<span class="nc" id="L1787">            linkColor = HTMLElement.getColor(body.getAttributeById(HTMLElement.ATTR_LINK), DEFAULT_LINK_COLOR);</span>
<span class="nc bnc" id="L1788" title="All 2 branches missed.">            if (bgColor != -1) {</span>
<span class="nc" id="L1789">                mainContainer.getUnselectedStyle().setBgColor(bgColor);</span>
<span class="nc" id="L1790">                mainContainer.getUnselectedStyle().setBgTransparency(255);</span>
<span class="nc" id="L1791">                mainContainer.getSelectedStyle().setBgColor(bgColor);</span>
<span class="nc" id="L1792">                mainContainer.getSelectedStyle().setBgTransparency(255);</span>
<span class="nc bnc" id="L1793" title="All 4 branches missed.">            } else if ((pageStyle == null) &amp;&amp; (pageUIID == null)) {</span>
<span class="nc" id="L1794">                mainContainer.getUnselectedStyle().setBgColor(DEFAULT_BGCOLOR);</span>
<span class="nc" id="L1795">                mainContainer.getUnselectedStyle().setBgTransparency(255);</span>
<span class="nc" id="L1796">                mainContainer.getSelectedStyle().setBgColor(DEFAULT_BGCOLOR);</span>
<span class="nc" id="L1797">                mainContainer.getSelectedStyle().setBgTransparency(255);</span>
            }
<span class="nc" id="L1799">            processTag(body, Component.LEFT);</span>
<span class="nc" id="L1800">            newLineIfNotEmpty(Component.LEFT);</span>
            //newLine(Component.LEFT); //flush buffer
<span class="nc bnc" id="L1802" title="All 4 branches missed.">            mainContainer.applyRTL((dir != null) &amp;&amp; (dir.equalsIgnoreCase(&quot;rtl&quot;)));</span>

<span class="nc bnc" id="L1804" title="All 2 branches missed.">            if ((SUPPORT_CSS) &amp;&amp; (loadCSS)) {</span>
<span class="nc" id="L1805">                body.setAssociatedComponents(mainContainer);</span>
<span class="nc bnc" id="L1806" title="All 2 branches missed.">                if (threadQueue.getCSSCount() == -1) { // If there are no pending external CSS, we can already process the CSS</span>
<span class="nc" id="L1807">                    applyAllCSS(); // Note that this doesn't have to be on EDT as the main container is still not displayed</span>
                }
            }

        } else {
<span class="nc" id="L1812">            System.out.println(&quot;no BODY tag was found in page.&quot;);</span>
        }

<span class="nc bnc" id="L1815" title="All 2 branches missed.">        if (!cancelled) {</span>
<span class="nc" id="L1816">            checkRedirect(head);</span>
        }
<span class="nc" id="L1818">    }</span>

    /**
     * Applies the CSS according to the following order (As the spec determines):
     * - External CSS (CSS files linked with the LINK tag)
     * - Embedded CSS (STYLE tag)
     * - Inline CSS (STYLE attribute)
     */
    void applyAllCSS() {
<span class="nc" id="L1827">        HTMLElement html = null;</span>
<span class="nc bnc" id="L1828" title="All 2 branches missed.">        if (document.getTagId() == HTMLElement.TAG_HTML) {</span>
<span class="nc" id="L1829">            html = document;</span>
        }
<span class="nc" id="L1831">        HTMLElement body = null;</span>
<span class="nc bnc" id="L1832" title="All 2 branches missed.">        if (html != null) {</span>
<span class="nc" id="L1833">            body = html.getFirstChildByTagId(HTMLElement.TAG_BODY);</span>
        }
        //clickTimer(&quot;B4CSS&quot;);
<span class="nc bnc" id="L1836" title="All 2 branches missed.">        if (body != null) {</span>
<span class="nc" id="L1837">            CSSEngine.getInstance().applyCSS(body, this, externalCSS, embeddedCSS);</span>
        }
<span class="nc" id="L1839">    }</span>

    /**
     * Checks if there's a refresh or redirect directive in the META tag and if so executes accordfingly.
     *
     * @param head The HEAD element of the document
     */
    private void checkRedirect(HTMLElement head) {
<span class="nc bnc" id="L1847" title="All 2 branches missed.">        if (head != null) {</span>
<span class="nc" id="L1848">            HTMLElement meta = head.getFirstChildByTagId(HTMLElement.TAG_META);</span>
<span class="nc bnc" id="L1849" title="All 2 branches missed.">            if (meta != null) {</span>
<span class="nc" id="L1850">                String httpequiv = meta.getAttributeById(HTMLElement.ATTR_HTTPEQUIV);</span>
<span class="nc bnc" id="L1851" title="All 4 branches missed.">                if ((httpequiv != null) &amp;&amp; (httpequiv.equalsIgnoreCase(&quot;refresh&quot;))) {</span>
<span class="nc" id="L1852">                    String content = meta.getAttributeById(HTMLElement.ATTR_CONTENT);</span>
<span class="nc bnc" id="L1853" title="All 2 branches missed.">                    if (content != null) {</span>
<span class="nc" id="L1854">                        int seperator = content.indexOf(';');</span>
<span class="nc" id="L1855">                        String redirectURL = null;</span>
<span class="nc bnc" id="L1856" title="All 2 branches missed.">                        if (seperator != -1) {</span>
<span class="nc" id="L1857">                            String tempUrl = content.substring(seperator + 1);</span>

<span class="nc" id="L1859">                            redirectURL = &quot;&quot;;</span>
<span class="nc bnc" id="L1860" title="All 2 branches missed.">                            for (int i = 0; i &lt; tempUrl.length(); i++) {</span>
<span class="nc" id="L1861">                                char ch = tempUrl.charAt(i);</span>
<span class="nc bnc" id="L1862" title="All 2 branches missed.">                                if (!CSSParser.isWhiteSpace(ch)) {</span>
<span class="nc" id="L1863">                                    redirectURL += ch;</span>
                                }
                            }

<span class="nc bnc" id="L1867" title="All 2 branches missed.">                            if (redirectURL.startsWith(&quot;url=&quot;)) { // i.e. 10;url=http://....</span>
<span class="nc" id="L1868">                                redirectURL = redirectURL.substring(4);</span>
                            }

<span class="nc" id="L1871">                            content = content.substring(0, seperator);</span>
                        }
<span class="nc" id="L1873">                        int redirectTime = -1;</span>
                        try {
<span class="nc" id="L1875">                            redirectTime = Integer.parseInt(content);</span>
<span class="nc" id="L1876">                            redirectThread = new RedirectThread(this, redirectTime, redirectURL);</span>
<span class="nc" id="L1877">                            Display.getInstance().startThread(redirectThread, &quot;HTML checkRedirect&quot;).start();</span>
<span class="nc" id="L1878">                        } catch (NumberFormatException nfe) {</span>
                            //Wasn't a number - ignore tag
<span class="nc" id="L1880">                        }</span>

                    }
                }
            }
        }

<span class="nc" id="L1887">    }</span>

    /**
     * Cancels redirects if exists. This is useful when the page has a meta tag with redirection/refresh in X seconds, and in that time the user clicked a link
     */
    void cancelRedirectsAndImages() {
<span class="nc bnc" id="L1893" title="All 2 branches missed.">        if (redirectThread != null) {</span>
<span class="nc" id="L1894">            redirectThread.cancel();</span>
<span class="nc" id="L1895">            redirectThread = null;</span>
        }
<span class="nc" id="L1897">        threadQueue.discardQueue();</span>
<span class="nc" id="L1898">        embeddedCSS = null;</span>
<span class="nc" id="L1899">        externalCSS = null;</span>
<span class="nc bnc" id="L1900" title="All 2 branches missed.">        if (getComponentForm() != null) {</span>
<span class="nc" id="L1901">            marqueeMotion = null;</span>
<span class="nc" id="L1902">            getComponentForm().deregisterAnimated(this);</span>
        }

<span class="nc" id="L1905">    }</span>

    /**
     * Adds the container representing the current line to the current container and creates a new one
     */
    private void newLine(int align) {
<span class="nc bnc" id="L1911" title="All 2 branches missed.">        if (curLine.getComponentCount() == 0) { // If no components are present, create a vertical spacing in the size of the font height</span>
<span class="nc" id="L1912">            curLine.setPreferredH(font.getHeight());</span>
<span class="nc bnc" id="L1913" title="All 2 branches missed.">        } else if (maxSuperscript != 0) {</span>
            // The following handles superscript. Bottom margin is added in addString to superscript-ed texts
            // but it doesn't create the effect of superscript, still the components are still drawn at the top.
            // Here we basically transfer the padding to the top, so that superscripted text will have less
            // top margin than non-superscripted text, which will render it as it should.
            // NOTE: handling this is the line level is not an ideal implementation, but other approaches will make it too complicated
<span class="nc bnc" id="L1919" title="All 2 branches missed.">            for (int i = 0; i &lt; curLine.getComponentCount(); i++) {</span>
<span class="nc" id="L1920">                Component cmp = curLine.getComponentAt(i);</span>
<span class="nc" id="L1921">                Style style = cmp.getStyle();</span>
<span class="nc" id="L1922">                style.setMargin(Component.TOP, style.getMargin(Component.TOP) + maxSuperscript - style.getMargin(Component.BOTTOM));</span>
<span class="nc" id="L1923">                style.setMargin(Component.BOTTOM, 0);</span>
<span class="nc bnc" id="L1924" title="All 2 branches missed.">                if (cmp instanceof HTMLLink) {</span>
<span class="nc" id="L1925">                    style = cmp.getSelectedStyle();</span>
<span class="nc" id="L1926">                    style.setMargin(Component.TOP, style.getMargin(Component.TOP) + maxSuperscript - style.getMargin(Component.BOTTOM));</span>
<span class="nc" id="L1927">                    style.setMargin(Component.BOTTOM, 0);</span>
<span class="nc" id="L1928">                    style = cmp.getPressedStyle();</span>
<span class="nc" id="L1929">                    style.setMargin(Component.TOP, style.getMargin(Component.TOP) + maxSuperscript - style.getMargin(Component.BOTTOM));</span>
<span class="nc" id="L1930">                    style.setMargin(Component.BOTTOM, 0);</span>
                }
            }
<span class="nc" id="L1933">            maxSuperscript = 0;</span>
        }

<span class="nc bnc" id="L1936" title="All 2 branches missed.">        lastWasEmpty = (curLine.getComponentCount() == 0);</span>

<span class="nc" id="L1938">        curContainer.addComponent(curLine);</span>
<span class="nc" id="L1939">        curLine = new Container();</span>
<span class="nc" id="L1940">        curLine.getStyle().setBgTransparency(0);</span>
        if (!FIXED_WIDTH) {
<span class="nc" id="L1942">            FlowLayout fl = new FlowLayout(align);</span>
<span class="nc" id="L1943">            fl.setValign(Component.BOTTOM);</span>
<span class="nc" id="L1944">            fl.setValignByRow(true);</span>
<span class="nc" id="L1945">            curLine.setLayout(fl);</span>
        } else {
            FlowLayout fl = (FlowLayout) curLine.getLayout();
            fl.setValign(Component.BOTTOM);
        }
<span class="nc" id="L1950">        curLine.setScrollableX(false);</span>

<span class="nc" id="L1952">        curLine.getStyle().setMargin(Component.LEFT, leftIndent);</span>
<span class="nc" id="L1953">        x = leftIndent;</span>

<span class="nc" id="L1955">    }</span>

    /**
     * Same as newLine, but only if the current line container is not empty
     */
    private void newLineIfNotEmpty(int align) {
<span class="nc bnc" id="L1961" title="All 2 branches missed.">        if (curLine.getComponentCount() &gt; 0) {</span>
<span class="nc" id="L1962">            newLine(align);</span>
        }
<span class="nc" id="L1964">    }</span>

    /**
     * Same as newLine, but only if the last line container was not empty
     */
    private void newLineIfLastWasNotEmpty(int align) {
<span class="nc bnc" id="L1970" title="All 2 branches missed.">        if (!lastWasEmpty) {</span>
<span class="nc" id="L1971">            newLine(align);</span>
        }
<span class="nc" id="L1973">    }</span>

    /**
     * Shows a text that has been marked with the html PRE tag which means the text will be displayed as is
     * without truncation of white spaces and new lines when reaching the end of the screen.
     *
     * @param text  The text to display
     * @param align The current horizontal alignment
     * @return a vector containing components each representing a sentence fragment
     */
    Vector showPreTagText(String text, int align) {
<span class="nc" id="L1984">        Vector comps = new Vector();</span>
<span class="nc bnc" id="L1985" title="All 4 branches missed.">        if ((text == null) || (text.equals(&quot;&quot;))) {</span>
<span class="nc" id="L1986">            return comps; //no text to show</span>
        }

<span class="nc" id="L1989">        String line = &quot;&quot;;</span>
<span class="nc bnc" id="L1990" title="All 2 branches missed.">        for (int c = 0; c &lt; text.length(); c++) {</span>
<span class="nc" id="L1991">            char ch = text.charAt(c);</span>
<span class="nc bnc" id="L1992" title="All 4 branches missed.">            if ((ch == 10) || (ch == 13)) {</span>
<span class="nc bnc" id="L1993" title="All 2 branches missed.">                if (!line.equals(&quot;&quot;)) {</span>
<span class="nc" id="L1994">                    comps.addElement(addString(line, align));</span>
<span class="nc" id="L1995">                    newLine(align);</span>
<span class="nc" id="L1996">                    line = &quot;&quot;;</span>
                }
            } else {
<span class="nc" id="L1999">                line += ch;</span>
            }

        }
<span class="nc bnc" id="L2003" title="All 2 branches missed.">        if (!line.equals(&quot;&quot;)) {</span>
<span class="nc" id="L2004">            comps.addElement(addString(line, align));</span>
<span class="nc" id="L2005">            newLine(align);</span>
        }
<span class="nc" id="L2007">        return comps;</span>
    }

    Vector getWords(String text, int align, boolean returnComps) {
<span class="nc" id="L2011">        Vector words = new Vector();</span>
<span class="nc" id="L2012">        String word = &quot;&quot;;</span>
<span class="nc" id="L2013">        String leadSpace = &quot;&quot;;</span>
<span class="nc bnc" id="L2014" title="All 2 branches missed.">        for (int c = 0; c &lt; text.length(); c++) {</span>
<span class="nc" id="L2015">            char ch = text.charAt(c);</span>
<span class="nc bnc" id="L2016" title="All 8 branches missed.">            if ((CJK_SUPPORT) &amp;&amp;</span>
                    (((ch &gt;= 0x3400) &amp;&amp; (ch &lt;= 0x9fff)) || //4E00-9FFF: CJK Unified Ideographs (Common), 3400-4DFF: CJK Unified Ideographs Extension A (Rare)
                            ((ch &gt;= 0xf900) &amp;&amp; (ch &lt;= 0xfaff)) //|| //CJK Compatibility Ideographs (Duplicates, unifiable variants, corporate characters)
                            // Since char can get a max value of 0xffff, the following are not applicable
                            //((ch&gt;=0x20000) &amp;&amp; (ch&lt;=0x2a6df)) || //CJK Unified Ideographs Extension B (Rare, historic)
                            //((ch&gt;=0x2f800) &amp;&amp; (ch&lt;=0x2fa1f)) //CJK Compatibility Ideographs Supplement (Unifiable variants)
                    )) { // CJK (Chinese, Japanese, Korean)
<span class="nc" id="L2023">                word += ch;</span>
<span class="nc bnc" id="L2024" title="All 2 branches missed.">                if (returnComps) {</span>
<span class="nc" id="L2025">                    words.addElement(addString(word, align));</span>
                } else {
<span class="nc" id="L2027">                    words.addElement(word);</span>
                }
<span class="nc" id="L2029">                word = &quot;&quot;;</span>
            } else {
<span class="nc bnc" id="L2031" title="All 10 branches missed.">                if ((ch == ' ') || (ch == 10) || (ch == 13) || (ch == '\t') || (ch == '\n')) {</span>
<span class="nc bnc" id="L2032" title="All 2 branches missed.">                    if (word.length() != 0) {</span>
<span class="nc bnc" id="L2033" title="All 2 branches missed.">                        if (returnComps) {</span>
<span class="nc" id="L2034">                            words.addElement(addString(leadSpace + word + ' ', align));</span>
<span class="nc" id="L2035">                            leadSpace = &quot;&quot;;</span>
                        } else {
<span class="nc" id="L2037">                            words.addElement(word);</span>
                        }
<span class="nc" id="L2039">                        word = &quot;&quot;;</span>
<span class="nc bnc" id="L2040" title="All 4 branches missed.">                    } else if ((words.isEmpty()) &amp;&amp; (text.length() &gt; 1)) { // The first word can have a leading space (only one, all whitespaces are aggregated to one space) - Unless this is just a space with no text</span>
<span class="nc" id="L2041">                        leadSpace = &quot; &quot;;</span>
                    }
<span class="nc bnc" id="L2043" title="All 4 branches missed.">                } else if ((!returnComps) &amp;&amp; (font.stringWidth(word + ch) &gt; width - leftIndent)) { //break words that are longer than the component's width</span>
<span class="nc" id="L2044">                    words.addElement(word);</span>
<span class="nc" id="L2045">                    word = &quot;&quot; + ch;</span>
                } else {
<span class="nc" id="L2047">                    word += ch;</span>
                }
            }
        }
<span class="nc bnc" id="L2051" title="All 4 branches missed.">        if ((word.length() != 0) || (leadSpace.length() != 0)) {</span>
<span class="nc bnc" id="L2052" title="All 2 branches missed.">            if (returnComps) {</span>
<span class="nc" id="L2053">                words.addElement(addString(leadSpace + word, align));</span>
            } else {
<span class="nc bnc" id="L2055" title="All 2 branches missed.">                if (word.length() != 0) {</span>
<span class="nc" id="L2056">                    words.addElement(word);</span>
                }
            }
        }
<span class="nc" id="L2060">        return words;</span>
    }

    /*
     * This method is used in non FIXED_WIDTH mode
     */
    private Vector showText(String text, int align) {
<span class="nc" id="L2067">        return getWords(text, align, true);</span>
    }

    /**
     * Shows the given text. This method breaks lines as necessary and adds the text either as regular labels or links.
     *
     * @param text  The text to display
     * @param align The current horizontal alignment
     */
    private Vector showTextFixedWidth(String text, int align) {
<span class="nc" id="L2077">        Vector comps = new Vector();</span>
<span class="nc bnc" id="L2078" title="All 4 branches missed.">        if ((text == null) || (text.equals(&quot;&quot;))) {</span>
<span class="nc" id="L2079">            return comps; //no text to show</span>
        }
<span class="nc" id="L2081">        int spaceW = width - x;</span>

<span class="nc" id="L2083">        Vector words = getWords(text, align, false);</span>

<span class="nc bnc" id="L2085" title="All 2 branches missed.">        if (words.size() &gt; 0) {</span>
<span class="nc" id="L2086">            int w = 0;</span>
<span class="nc" id="L2087">            String wordStr = &quot;&quot;;</span>
<span class="nc bnc" id="L2088" title="All 4 branches missed.">            if ((CSSParser.isWhiteSpace(text.charAt(0))) &amp;&amp; (curLine.getComponentCount() != 0)) { //leading space is trimmed if it is in the first component of the line</span>
<span class="nc" id="L2089">                wordStr = &quot; &quot;; //leading space</span>
            }

<span class="nc bnc" id="L2092" title="All 2 branches missed.">            while (w &lt; words.size()) {</span>
<span class="nc" id="L2093">                String nextWord = (String) words.elementAt(w);</span>
<span class="nc" id="L2094">                String space = &quot;&quot;;</span>
<span class="nc bnc" id="L2095" title="All 4 branches missed.">                if ((!wordStr.equals(&quot;&quot;)) &amp;&amp; (!wordStr.equals(&quot; &quot;))) {</span>
<span class="nc" id="L2096">                    space = &quot; &quot;;</span>
                }
<span class="nc bnc" id="L2098" title="All 2 branches missed.">                if (font.stringWidth(wordStr + space + nextWord) &gt; spaceW - 2) {</span>
<span class="nc" id="L2099">                    comps.addElement(addString(wordStr, align));</span>
<span class="nc" id="L2100">                    newLineIfNotEmpty(align);</span>
<span class="nc" id="L2101">                    spaceW = width - x;</span>
<span class="nc" id="L2102">                    wordStr = nextWord;</span>
                } else {
<span class="nc" id="L2104">                    wordStr += space + nextWord;</span>
                }
<span class="nc" id="L2106">                w++;</span>
<span class="nc" id="L2107">            }</span>
<span class="nc bnc" id="L2108" title="All 2 branches missed.">            if (CSSParser.isWhiteSpace(text.charAt(text.length() - 1))) {</span>
<span class="nc" id="L2109">                wordStr += &quot; &quot;; //trailing space</span>
            }

<span class="nc" id="L2112">            comps.addElement(addString(wordStr, align));</span>
        }

<span class="nc" id="L2115">        return comps;</span>
    }

    /**
     * Adds the given text to the container as a label or a link.
     * The string given here does not need line breaking as this was calculated before in the calling method.
     *
     * @param str   The text to display
     * @param align The current horizontal alignment
     */
    private Label addString(String str, int align) {
<span class="nc" id="L2126">        Label lbl = null;</span>
<span class="nc" id="L2127">        int color = textColor;</span>
<span class="nc bnc" id="L2128" title="All 4 branches missed.">        if ((curLine.getComponentCount() == 0) &amp;&amp; (str.startsWith(&quot; &quot;))) { // First word in paragraph ignores all spaces</span>
<span class="nc" id="L2129">            str = str.substring(1);</span>
<span class="nc bnc" id="L2130" title="All 2 branches missed.">            if (str.length() == 0) {</span>
<span class="nc" id="L2131">                return null;</span>
            }
        }

<span class="nc bnc" id="L2135" title="All 2 branches missed.">        if (link != null) {</span>
<span class="nc" id="L2136">            lbl = new HTMLLink(str, link, this, mainLink, linkVisited);</span>
<span class="nc" id="L2137">            color = linkColor;</span>
<span class="nc bnc" id="L2138" title="All 2 branches missed.">            if (linkVisited) {</span>
<span class="nc" id="L2139">                color = COLOR_VISITED_LINKS;</span>
            }

<span class="nc" id="L2142">            lbl.getSelectedStyle().setFont(font.getFont());</span>
<span class="nc" id="L2143">            lbl.getPressedStyle().setFont(font.getFont());</span>
<span class="nc bnc" id="L2144" title="All 2 branches missed.">            if (mainLink == null) {</span>
<span class="nc" id="L2145">                mainLink = (HTMLLink) lbl;</span>
            }
<span class="nc bnc" id="L2147" title="All 2 branches missed.">            if (accesskey != '\0') {</span>
<span class="nc" id="L2148">                addAccessKey(accesskey, lbl, false);//accessKeys.put(new Integer(accesskey), lbl);</span>
<span class="nc" id="L2149">                accesskey = '\0'; // To prevent the access key from adding again to all words of the link</span>
            }
<span class="nc" id="L2151">            lbl.getSelectedStyle().setMargin(0, 0, 0, 0);</span>
<span class="nc" id="L2152">            lbl.getSelectedStyle().setPadding(0, 0, 0, 0);</span>
<span class="nc" id="L2153">            lbl.getPressedStyle().setMargin(0, 0, 0, 0);</span>
<span class="nc" id="L2154">            lbl.getPressedStyle().setPadding(0, 0, 0, 0);</span>
<span class="nc" id="L2155">            lbl.getSelectedStyle().setTextDecoration(textDecoration);</span>
<span class="nc" id="L2156">            lbl.getPressedStyle().setTextDecoration(textDecoration);</span>
        } else {
<span class="nc bnc" id="L2158" title="All 2 branches missed.">            if (labelForID != null) {</span>
<span class="nc" id="L2159">                lbl = new ForLabel(str, this, labelForID);</span>
<span class="nc bnc" id="L2160" title="All 2 branches missed.">                if (accesskey != '\0') {</span>
<span class="nc" id="L2161">                    addAccessKey(accesskey, lbl, false);//accessKeys.put(new Integer(accesskey), lbl);</span>
<span class="nc" id="L2162">                    accesskey = '\0'; // To prevent the access key from adding again to all words of the link</span>
                }
<span class="nc" id="L2164">                labelForID = null;</span>
            } else {
<span class="nc" id="L2166">                lbl = new Label(str);</span>
            }

        }
<span class="nc" id="L2170">        lbl.getStyle().setMargin(0, 0, 0, 0);</span>
<span class="nc" id="L2171">        lbl.getStyle().setPadding(0, 0, 0, 0);</span>
<span class="nc bnc" id="L2172" title="All 2 branches missed.">        if (superscript &gt; 0) {</span>
<span class="nc" id="L2173">            int margin = font.getHeight() * superscript / 2;</span>
<span class="nc" id="L2174">            lbl.getStyle().setMargin(Component.BOTTOM, margin);</span>
<span class="nc bnc" id="L2175" title="All 2 branches missed.">            if (link != null) {</span>
<span class="nc" id="L2176">                lbl.getSelectedStyle().setMargin(Component.BOTTOM, margin);</span>
<span class="nc" id="L2177">                lbl.getPressedStyle().setMargin(Component.BOTTOM, margin);</span>
            }
<span class="nc bnc" id="L2179" title="All 2 branches missed.">            if (margin &gt; maxSuperscript) {</span>
<span class="nc" id="L2180">                maxSuperscript = margin; // The height superscript margin is saved for a later adjustment at newLine</span>
            }
<span class="nc bnc" id="L2182" title="All 2 branches missed.">        } else if (superscript &lt; 0) {</span>
<span class="nc" id="L2183">            int margin = -font.getHeight() * superscript / 2;</span>
<span class="nc" id="L2184">            lbl.getStyle().setMargin(Component.TOP, margin);</span>
<span class="nc bnc" id="L2185" title="All 2 branches missed.">            if (link != null) {</span>
<span class="nc" id="L2186">                lbl.getSelectedStyle().setMargin(Component.TOP, margin);</span>
<span class="nc" id="L2187">                lbl.getPressedStyle().setMargin(Component.TOP, margin);</span>
            }
        }

<span class="nc" id="L2191">        lbl.getUnselectedStyle().setFgColor(color);</span>
<span class="nc" id="L2192">        lbl.getSelectedStyle().setFgColor(color);</span>

        //lbl.setVerticalAlignment(Component.BOTTOM); //TODO - This still doesn't align as label alignment in Codename One refers to the text alignment in relation to its icon (if exists)
<span class="nc" id="L2195">        lbl.getUnselectedStyle().setFont(font.getFont());</span>
<span class="nc" id="L2196">        lbl.getUnselectedStyle().setBgTransparency(0);</span>
<span class="nc" id="L2197">        lbl.setGap(0);</span>
<span class="nc" id="L2198">        lbl.setTickerEnabled(false);</span>
<span class="nc" id="L2199">        lbl.setEndsWith3Points(false);</span>
<span class="nc" id="L2200">        lbl.getUnselectedStyle().setTextDecoration(textDecoration);</span>

<span class="nc bnc" id="L2202" title="All 2 branches missed.">        if (align != JUSTIFY) { // Regular Codename One labels do not support justify. We acheive justification in fixed width mode below</span>
<span class="nc" id="L2203">            lbl.setAlignment(align);</span>
        }


<span class="nc" id="L2207">        curLine.addComponent(lbl);</span>

<span class="nc bnc" id="L2209" title="All 2 branches missed.">        if (anchor != null) {</span>
<span class="nc" id="L2210">            anchors.put(anchor, lbl);</span>

        }

        if (FIXED_WIDTH) {
            if (align != Component.LEFT) {
                if (align == JUSTIFY) {  // Text justification algorithm
                    Vector words = getWords(str, align, false);
                    if (words.size() &gt; 1) {
                        int spaceW = font.getFont().stringWidth(&quot; &quot;);
                        int spacesToAdd = (width - lbl.getPreferredW()) / spaceW;
                        int spacesPerWord = spacesToAdd / (words.size() - 1);
                        int addtlSpaces = spacesToAdd % (words.size() - 1);
                        String newStr = (String) words.elementAt(0);
                        for (int i = 1; i &lt; words.size(); i++) {
                            for (int j = 0; j &lt; spacesPerWord; j++) {
                                newStr += ' ';
                            }
                            if (i &lt;= addtlSpaces) {
                                newStr += ' ';
                            }
                            newStr += ' ' + (String) words.elementAt(i);
                        }
                        lbl.setText(newStr);
                    }
                } else {
                    lbl.setPreferredW(width);
                }
                x = width;
                newLine(align);
            } else {
                x += lbl.getPreferredW();
            }
        }

<span class="nc" id="L2245">        return lbl;</span>

    }

    /**
     * Adds the given access key to make it focus on the given component
     *
     * @param accessKey The accesskey key code
     * @param cmp       The component that should be focused when the access key is pressed
     * @param override  If true, cancel any previous accesskey associated with this component (Relevant for CSS -wap-accesskey)
     */
    void addAccessKey(int accessKey, Component cmp, boolean override) {
<span class="nc bnc" id="L2257" title="All 4 branches missed.">        if ((override) &amp;&amp; (accessKeys.contains(cmp))) {</span>
<span class="nc" id="L2258">            Hashtable newAccessKeys = new Hashtable();</span>
<span class="nc bnc" id="L2259" title="All 2 branches missed.">            for (Enumeration e = accessKeys.keys(); e.hasMoreElements(); ) {</span>
<span class="nc" id="L2260">                Object key = e.nextElement();</span>
<span class="nc" id="L2261">                Component c = (Component) accessKeys.get(key);</span>
<span class="nc bnc" id="L2262" title="All 2 branches missed.">                if (c != cmp) {</span>
<span class="nc" id="L2263">                    newAccessKeys.put(key, c);</span>
                }
<span class="nc" id="L2265">            }</span>
<span class="nc" id="L2266">            accessKeys = newAccessKeys;</span>
        }

<span class="nc" id="L2269">        accessKeys.put(Integer.valueOf(accessKey), cmp);</span>
<span class="nc" id="L2270">        Form form = getComponentForm();</span>
<span class="nc bnc" id="L2271" title="All 2 branches missed.">        if (form != null) {</span>
<span class="nc" id="L2272">            form.addKeyListener(accessKey, this);</span>
        }
<span class="nc" id="L2274">    }</span>

    /**
     * Overrides initComponent to add the key listeners to the access keys when the component is first added to the form/displayed
     * This is useful when the component is added only after the page was read
     */
    protected void initComponent() {
<span class="nc" id="L2281">        super.initComponent();</span>
<span class="nc bnc" id="L2282" title="All 2 branches missed.">        for (Enumeration e = accessKeys.keys(); e.hasMoreElements(); ) {</span>
<span class="nc" id="L2283">            int keyCode = ((Integer) e.nextElement()).intValue();</span>
<span class="nc" id="L2284">            getComponentForm().addKeyListener(keyCode, this);</span>
<span class="nc" id="L2285">        }</span>
<span class="nc" id="L2286">    }</span>

    /**
     * If the component is taken off for any reason, makes sure access keys are not active
     */
    protected void deinitialize() {
<span class="nc" id="L2292">        super.deinitialize();</span>
<span class="nc bnc" id="L2293" title="All 2 branches missed.">        for (Enumeration e = accessKeys.keys(); e.hasMoreElements(); ) {</span>
<span class="nc" id="L2294">            int keyCode = ((Integer) e.nextElement()).intValue();</span>
<span class="nc" id="L2295">            getComponentForm().removeKeyListener(keyCode, this);</span>
<span class="nc" id="L2296">        }</span>
        // TODO - clean DOM's UI references on deinit? Then what happens on init???
<span class="nc" id="L2298">    }</span>

    /**
     * Handles the IMG tag. This includes calculating its size (if available), applying any links/accesskeys and adding it to the download queue
     *
     * @param imgElement the IMG element
     * @param align      th current alignment
     * @param cmd        The submit command of a form, used only for INPUT type=&quot;image&quot;
     */
    private void handleImage(HTMLElement imgElement, int align, Command cmd) {

<span class="nc" id="L2309">        String imageUrl = imgElement.getAttributeById(HTMLElement.ATTR_SRC);</span>
<span class="nc" id="L2310">        Label imgLabel = null;</span>
<span class="nc bnc" id="L2311" title="All 2 branches missed.">        if (imageUrl != null) {</span>

<span class="nc" id="L2313">            String alignStr = imgElement.getAttributeById(HTMLElement.ATTR_ALIGN);</span>

            // Image width and height
<span class="nc" id="L2316">            int iWidth = calcSize(getWidth(), imgElement.getAttributeById(HTMLElement.ATTR_WIDTH), 0, false);</span>
<span class="nc" id="L2317">            int iHeight = calcSize(getHeight(), imgElement.getAttributeById(HTMLElement.ATTR_HEIGHT), 0, false);</span>

            // Whitespace on the image sides (i.e. Margins)
<span class="nc" id="L2320">            int hspace = getInt(imgElement.getAttributeById(HTMLElement.ATTR_HSPACE));</span>
<span class="nc" id="L2321">            int vspace = getInt(imgElement.getAttributeById(HTMLElement.ATTR_VSPACE));</span>

<span class="nc" id="L2323">            int totalWidth = iWidth + hspace * 2;</span>

            if ((FIXED_WIDTH) &amp;&amp; (x + totalWidth &gt;= width)) {
                newLine(align);
            }

            // Alternative image text, shown until image is loaded.
<span class="nc" id="L2330">            String altText = imgElement.getAttributeById(HTMLElement.ATTR_ALT);</span>

<span class="nc" id="L2332">            String imageMap = imgElement.getAttributeById(HTMLElement.ATTR_USEMAP);</span>

<span class="nc bnc" id="L2334" title="All 2 branches missed.">            if (link != null) { // This image is inside an A tag with HREF attribute</span>
<span class="nc" id="L2335">                imgLabel = new HTMLLink(altText, link, this, mainLink, false);</span>
<span class="nc bnc" id="L2336" title="All 2 branches missed.">                if (mainLink == null) {</span>
<span class="nc" id="L2337">                    mainLink = (HTMLLink) imgLabel;</span>
                }
<span class="nc bnc" id="L2339" title="All 2 branches missed.">                if (accesskey != '\0') {</span>
<span class="nc" id="L2340">                    addAccessKey(accesskey, imgLabel, false);//accessKeys.put(new Integer(accesskey), imgLabel);</span>
                }
                if (!PROCESS_HTML_MP1_ONLY) {
<span class="nc bnc" id="L2343" title="All 2 branches missed.">                    ((HTMLLink) imgLabel).isMap = (imgElement.getAttributeById(HTMLElement.ATTR_ISMAP) != null);</span>
                }

<span class="nc bnc" id="L2346" title="All 2 branches missed.">            } else if (cmd != null) { //Special case of an image submit button</span>
<span class="nc" id="L2347">                imgLabel = new Button(cmd);</span>
<span class="nc bnc" id="L2348" title="All 4 branches missed.">                if ((altText != null) &amp;&amp; (!altText.equals(&quot;&quot;))) {</span>
<span class="nc" id="L2349">                    imgLabel.setText(altText);</span>
                }
<span class="nc bnc" id="L2351" title="All 2 branches missed.">                if (firstFocusable == null) {</span>
<span class="nc" id="L2352">                    firstFocusable = imgLabel;</span>
                }

<span class="nc bnc" id="L2355" title="All 2 branches missed.">            } else if (imageMap != null) { // Image Map</span>
<span class="nc" id="L2356">                imgLabel = new HTMLImageMap(this);</span>
<span class="nc bnc" id="L2357" title="All 2 branches missed.">                if (imageMapComponents == null) {</span>
<span class="nc" id="L2358">                    imageMapComponents = new Hashtable();</span>
                }
<span class="nc bnc" id="L2360" title="All 2 branches missed.">                if (imageMap.startsWith(&quot;#&quot;)) { // Image map are denoted by # and then the map name (But we also tolerate if map is specified without #)</span>
<span class="nc" id="L2361">                    imageMap = imageMap.substring(1);</span>
                }
<span class="nc" id="L2363">                imageMapComponents.put(imageMap, imgLabel);</span>
<span class="nc bnc" id="L2364" title="All 4 branches missed.">                if ((imageMapData != null) &amp;&amp; (imageMapData.containsKey(imageMap))) {</span>
<span class="nc" id="L2365">                    ImageMapData data = (ImageMapData) imageMapData.get(imageMap);</span>
<span class="nc" id="L2366">                    ((HTMLImageMap) imgLabel).mapData = data;</span>
<span class="nc" id="L2367">                }</span>


            } else {
<span class="nc" id="L2371">                imgLabel = new Label(altText);</span>
            }


<span class="nc bnc" id="L2375" title="All 4 branches missed.">            if ((iWidth != 0) || (iHeight != 0)) { // reserve space while loading image if either width or height are specified, otherwise we don't know how much to reserve</span>
<span class="nc" id="L2376">                iWidth += imgLabel.getStyle().getPadding(Component.LEFT) + imgLabel.getStyle().getPadding(Component.RIGHT);</span>
<span class="nc" id="L2377">                iHeight += imgLabel.getStyle().getPadding(Component.TOP) + imgLabel.getStyle().getPadding(Component.BOTTOM);</span>
<span class="nc" id="L2378">                imgLabel.setPreferredSize(new Dimension(iWidth, iHeight));</span>
            } else { // If no space is reserved, make a minimal text, otherwise Codename One won't calculate the size right after the image loads
<span class="nc bnc" id="L2380" title="All 4 branches missed.">                if ((imgLabel.getText() == null) || (imgLabel.getText().equals(&quot;&quot;))) {</span>
<span class="nc" id="L2381">                    imgLabel.setText(&quot; &quot;);</span>
                }
            }

            // It is important that the padding of the image component itself will be all 0
            // This is because when the image is loaded, its preferred size is checked to see if its width/height were preset by the width/height attribute
<span class="nc" id="L2387">            imgLabel.getSelectedStyle().setPadding(0, 0, 0, 0);</span>
<span class="nc" id="L2388">            imgLabel.getUnselectedStyle().setPadding(0, 0, 0, 0);</span>

<span class="nc" id="L2390">            imgLabel.getSelectedStyle().setFont(font.getFont());</span>
<span class="nc" id="L2391">            imgLabel.getUnselectedStyle().setFont(font.getFont());</span>

<span class="nc" id="L2393">            int borderSize = getInt(imgElement.getAttributeById(HTMLElement.ATTR_BORDER));</span>
<span class="nc bnc" id="L2394" title="All 2 branches missed.">            if (borderSize != 0) {</span>
<span class="nc" id="L2395">                imgLabel.putClientProperty(CLIENT_PROPERTY_IMG_BORDER, Integer.valueOf(borderSize));</span>
            } else {
<span class="nc" id="L2397">                borderSize = 1;</span>
            }

<span class="nc" id="L2400">            imgLabel.getUnselectedStyle().setBorder(Border.createLineBorder(borderSize));</span>
<span class="nc" id="L2401">            imgLabel.getSelectedStyle().setBorder(Border.createLineBorder(borderSize));</span>
<span class="nc" id="L2402">            imgLabel.getUnselectedStyle().setBgTransparency(0);</span>
<span class="nc" id="L2403">            imgLabel.getSelectedStyle().setBgTransparency(0);</span>

<span class="nc" id="L2405">            Container imgCont = new Container(new BorderLayout());</span>
<span class="nc" id="L2406">            imgCont.addComponent(BorderLayout.CENTER, imgLabel);</span>
<span class="nc" id="L2407">            imgCont.getSelectedStyle().setMargin(vspace, vspace, hspace, hspace);</span>
<span class="nc" id="L2408">            imgCont.getUnselectedStyle().setMargin(vspace, vspace, hspace, hspace);</span>


<span class="nc" id="L2411">            curLine.addComponent(imgCont);</span>
<span class="nc" id="L2412">            x += totalWidth;</span>

            //Alignment
<span class="nc" id="L2415">            imgLabel.setAlignment(getHorizAlign(alignStr, align, false));</span>
<span class="nc" id="L2416">            imgLabel.setVerticalAlignment(getVertAlign(alignStr, Component.CENTER));</span>

<span class="nc bnc" id="L2418" title="All 2 branches missed.">            if (showImages) {</span>
<span class="nc bnc" id="L2419" title="All 2 branches missed.">                if (docInfo != null) {</span>
<span class="nc" id="L2420">                    imageUrl = docInfo.convertURL(imageUrl);</span>
<span class="nc" id="L2421">                    threadQueue.add(imgLabel, imageUrl);</span>
                } else {
<span class="nc bnc" id="L2423" title="All 2 branches missed.">                    if (DocumentInfo.isAbsoluteURL(imageUrl)) {</span>
<span class="nc" id="L2424">                        threadQueue.add(imgLabel, imageUrl);</span>
                    } else {
<span class="nc bnc" id="L2426" title="All 2 branches missed.">                        if (htmlCallback != null) {</span>
<span class="nc" id="L2427">                            htmlCallback.parsingError(HTMLCallback.ERROR_NO_BASE_URL, imgElement.getTagName(), imgElement.getAttributeName(Integer.valueOf(HTMLElement.ATTR_SRC)), imageUrl, &quot;Ignoring Image file referred in an IMG tag (&quot; + imageUrl + &quot;), since page was set by setBody/setHTML/setDOM so there's no way to access relative URLs&quot;);</span>
                        }
                    }
                }

            }

<span class="nc bnc" id="L2434" title="All 2 branches missed.">            if (loadCSS) {</span>
<span class="nc" id="L2435">                imgElement.setAssociatedComponents(imgCont);</span>
            }

        }
<span class="nc" id="L2439">    }</span>

    /**
     * Handles an area definition for an image map
     *
     * @param areaTag The AREA tag
     */
    private void handleImageMapArea(HTMLElement areaTag) {
<span class="nc bnc" id="L2447" title="All 2 branches missed.">        if (curImageMap != null) {</span>
<span class="nc" id="L2448">            String shape = areaTag.getAttributeById(HTMLElement.ATTR_SHAPE);</span>
<span class="nc" id="L2449">            boolean supportedShape = false;</span>
<span class="nc bnc" id="L2450" title="All 2 branches missed.">            if (shape != null) {</span>
<span class="nc" id="L2451">                String hrefStr = areaTag.getAttributeById(HTMLElement.ATTR_HREF);</span>
<span class="nc bnc" id="L2452" title="All 2 branches missed.">                if (shape.equalsIgnoreCase(&quot;default&quot;)) {</span>
<span class="nc" id="L2453">                    supportedShape = true;</span>
<span class="nc" id="L2454">                    curImageMap.setDefaultLink(hrefStr);</span>
<span class="nc bnc" id="L2455" title="All 4 branches missed.">                } else if ((shape.equalsIgnoreCase(&quot;rect&quot;)) || (shape.equalsIgnoreCase(&quot;circle&quot;))) {</span>
<span class="nc" id="L2456">                    supportedShape = true;</span>
<span class="nc" id="L2457">                    String coordsStr = areaTag.getAttributeById(HTMLElement.ATTR_COORDS);</span>
<span class="nc bnc" id="L2458" title="All 4 branches missed.">                    if ((coordsStr != null) &amp;&amp; (hrefStr != null)) {</span>
<span class="nc" id="L2459">                        String curValStr = &quot;&quot;;</span>
<span class="nc" id="L2460">                        int[] coords = new int[4];</span>
<span class="nc" id="L2461">                        int curCoord = 0;</span>
<span class="nc" id="L2462">                        boolean error = true;</span>
                        try {
<span class="nc bnc" id="L2464" title="All 2 branches missed.">                            for (int c = 0; c &lt; coordsStr.length(); c++) {</span>
<span class="nc" id="L2465">                                char ch = coordsStr.charAt(c);</span>
<span class="nc bnc" id="L2466" title="All 2 branches missed.">                                if (ch != ',') {</span>
<span class="nc" id="L2467">                                    curValStr += ch;</span>
                                } else {
<span class="nc" id="L2469">                                    coords[curCoord] = Integer.parseInt(curValStr);</span>
<span class="nc" id="L2470">                                    curCoord++;</span>
<span class="nc" id="L2471">                                    curValStr = &quot;&quot;;</span>
                                }
                            }
<span class="nc bnc" id="L2474" title="All 2 branches missed.">                            if (curValStr.length() &gt; 0) {</span>
<span class="nc" id="L2475">                                coords[curCoord] = Integer.parseInt(curValStr);</span>
<span class="nc" id="L2476">                                curCoord++;</span>
                            }
<span class="nc bnc" id="L2478" title="All 2 branches missed.">                            if (shape.equalsIgnoreCase(&quot;rect&quot;)) {</span>
<span class="nc bnc" id="L2479" title="All 2 branches missed.">                                if (curCoord == 4) {</span>
<span class="nc" id="L2480">                                    curImageMap.addRectArea(new Rectangle(coords[0], coords[1], coords[2] - coords[0], coords[3] - coords[1]), hrefStr);</span>
<span class="nc" id="L2481">                                    error = false;</span>
                                }
<span class="nc bnc" id="L2483" title="All 2 branches missed.">                            } else if (curCoord == 3) { //circle</span>
                                // coords[2] is the radius, and 0,1 are the center x,y
<span class="nc" id="L2485">                                curImageMap.addRectArea(new Rectangle(coords[0] - coords[2], coords[1] - coords[2], coords[2] * 2 + 1, coords[2] * 2 + 1), hrefStr);</span>
                                // Note: The 'circle' SHAPE in AREA tag is implemented as a rectangle to avoid complication of circle pixel collision
<span class="nc" id="L2487">                                error = false;</span>
                            }
<span class="nc" id="L2489">                        } catch (Exception e) { // Can be number format exception or index out of bounds</span>
                            // do nothing - error will stay true
<span class="nc" id="L2491">                        }</span>
<span class="nc bnc" id="L2492" title="All 2 branches missed.">                        if (error) {</span>
<span class="nc" id="L2493">                            notifyImageMapError(&quot;AREA tag 'coords' property value is invalid (should be exactly 3 comma seperated numbers for circle, 4 for rectangle): &quot; + coordsStr, HTMLCallback.ERROR_ATTIBUTE_VALUE_INVALID, HTMLElement.ATTR_COORDS, coordsStr);</span>
                        }

                    }
                }
            }
<span class="nc bnc" id="L2499" title="All 2 branches missed.">            if (!supportedShape) {</span>
<span class="nc" id="L2500">                notifyImageMapError(&quot;Unsupported or missing AREA tag 'shape' property: &quot; + shape, HTMLCallback.ERROR_ATTIBUTE_VALUE_INVALID, HTMLElement.ATTR_SHAPE, shape);</span>
            }
<span class="nc" id="L2502">        } else {</span>
<span class="nc" id="L2503">            notifyImageMapError(&quot;AREA tag is defined without a parent MAP tag - ignoring&quot;, HTMLCallback.ERROR_INVALID_TAG_HIERARCHY, -1, null);</span>
        }

<span class="nc" id="L2506">    }</span>

    private void notifyImageMapError(String msg, int errorCode, int attrId, String value) {
<span class="nc bnc" id="L2509" title="All 2 branches missed.">        if (htmlCallback != null) {</span>
<span class="nc" id="L2510">            String attr = null;</span>
<span class="nc bnc" id="L2511" title="All 2 branches missed.">            if (attrId != -1) {</span>
<span class="nc" id="L2512">                attr = HTMLElement.ATTRIBUTE_NAMES[attrId];</span>
            }
<span class="nc" id="L2514">            htmlCallback.parsingError(errorCode, HTMLElement.TAG_NAMES[HTMLElement.TAG_AREA], attr, value, msg);</span>
        }
<span class="nc" id="L2516">    }</span>

    /**
     * Handles the INPUT tag
     *
     * @param element The input element
     * @param align   The current aligment
     */
    private void handleInput(HTMLElement element, int align) {
<span class="nc" id="L2525">        String type = element.getAttributeById(HTMLElement.ATTR_TYPE);</span>
<span class="nc bnc" id="L2526" title="All 2 branches missed.">        if (type == null) {</span>
<span class="nc" id="L2527">            return;</span>
        }
<span class="nc" id="L2529">        int typeID = INPUT_TYPES.indexOf(type.toLowerCase());</span>
<span class="nc bnc" id="L2530" title="All 2 branches missed.">        if (typeID == -1) {</span>
<span class="nc bnc" id="L2531" title="All 2 branches missed.">            if (htmlCallback != null) {</span>
<span class="nc bnc" id="L2532" title="All 2 branches missed.">                if (!htmlCallback.parsingError(HTMLCallback.ERROR_ATTIBUTE_VALUE_INVALID, element.getTagName(), element.getAttributeName(Integer.valueOf(HTMLElement.ATTR_TYPE)), type, &quot;Unsupported input type '&quot; + type + &quot;'. Supported types: text, password, checkbox, radio, submit, reset, hidden, image&quot;)) {</span>
<span class="nc" id="L2533">                    cancel();</span>
                }
            }
<span class="nc" id="L2536">            return;</span>
        }

<span class="nc" id="L2539">        String name = element.getAttributeById(HTMLElement.ATTR_NAME);</span>
<span class="nc" id="L2540">        String id = element.getAttributeById(HTMLElement.ATTR_ID);</span>
<span class="nc" id="L2541">        String value = element.getAttributeById(HTMLElement.ATTR_VALUE);</span>
<span class="nc bnc" id="L2542" title="All 2 branches missed.">        if (value == null) {</span>
<span class="nc" id="L2543">            value = &quot;&quot;;</span>
        }

<span class="nc" id="L2546">        Component cmp = null;</span>
<span class="nc bnc" id="L2547" title="All 8 branches missed.">        switch (typeID) {</span>
            case INPUT_CHECKBOX:
<span class="nc" id="L2549">                CheckBox cb = new CheckBox();</span>
<span class="nc bnc" id="L2550" title="All 2 branches missed.">                if (element.getAttributeById(HTMLElement.ATTR_CHECKED) != null) {</span>
<span class="nc" id="L2551">                    cb.setSelected(true);</span>
                }
<span class="nc" id="L2553">                cmp = cb;</span>
<span class="nc bnc" id="L2554" title="All 2 branches missed.">                if (curForm != null) {</span>
<span class="nc" id="L2555">                    curForm.addCheckBox(name, cb, value);</span>
                }
                break;
            case INPUT_HIDDEN:
<span class="nc bnc" id="L2559" title="All 2 branches missed.">                if (curForm != null) {</span>
<span class="nc" id="L2560">                    curForm.addInput(name, value, null);</span>
                }
                break;
            case INPUT_EMAIL:
            case INPUT_TEXT:
            case INPUT_PASSWORD:
<span class="nc" id="L2566">                TextField tf = new TextField(value);</span>
<span class="nc" id="L2567">                tf.setLeftAndRightEditingTrigger(false);</span>
<span class="nc bnc" id="L2568" title="All 2 branches missed.">                if (typeID == INPUT_PASSWORD) {</span>
<span class="nc" id="L2569">                    tf.setConstraint(TextField.PASSWORD);</span>
                }

<span class="nc bnc" id="L2572" title="All 2 branches missed.">                if (typeID == INPUT_EMAIL) {</span>
<span class="nc" id="L2573">                    tf.setConstraint(TextField.EMAILADDR);</span>
                }

                if (SUPPORT_INPUT_FORMAT) {
<span class="nc" id="L2577">                    HTMLInputFormat inputFormat = HTMLInputFormat.getInputFormat(element.getAttributeById(HTMLElement.ATTR_FORMAT));</span>
<span class="nc bnc" id="L2578" title="All 2 branches missed.">                    if (inputFormat != null) {</span>
<span class="nc" id="L2579">                        tf = (TextField) inputFormat.applyConstraints(tf);</span>
<span class="nc bnc" id="L2580" title="All 2 branches missed.">                        if (curForm != null) {</span>
<span class="nc" id="L2581">                            curForm.setInputFormat(tf, inputFormat);</span>
                        }
                    }
<span class="nc" id="L2584">                    String emptyOk = element.getAttributeById(HTMLElement.ATTR_EMPTYOK);</span>
<span class="nc bnc" id="L2585" title="All 4 branches missed.">                    if ((emptyOk != null) &amp;&amp; (curForm != null)) {</span>
<span class="nc bnc" id="L2586" title="All 2 branches missed.">                        if (emptyOk.equalsIgnoreCase(&quot;true&quot;)) {</span>
<span class="nc" id="L2587">                            curForm.setEmptyOK(tf, true);</span>
<span class="nc bnc" id="L2588" title="All 2 branches missed.">                        } else if (emptyOk.equalsIgnoreCase(&quot;false&quot;)) {</span>
<span class="nc" id="L2589">                            curForm.setEmptyOK(tf, false);</span>
                        }
                    }
                }

<span class="nc" id="L2594">                int size = getInt(element.getAttributeById(HTMLElement.ATTR_SIZE));</span>
<span class="nc" id="L2595">                int maxlen = getInt(element.getAttributeById(HTMLElement.ATTR_MAXLENGTH));</span>

<span class="nc bnc" id="L2597" title="All 2 branches missed.">                if (size == 0) {</span>
<span class="nc" id="L2598">                    size = DEFAULT_TEXTFIELD_SIZE;</span>
                }

<span class="nc bnc" id="L2601" title="All 2 branches missed.">                if (maxlen != 0) {</span>
<span class="nc" id="L2602">                    tf.setMaxSize(maxlen);</span>
<span class="nc bnc" id="L2603" title="All 2 branches missed.">                    if (size &gt; maxlen) {</span>
<span class="nc" id="L2604">                        size = maxlen;</span>
                    }
                }

<span class="nc" id="L2608">                tf.setPreferredW(tf.getStyle().getFont().stringWidth(&quot;W&quot;) * size);</span>
<span class="nc" id="L2609">                tf.getSelectedStyle().setFont(font.getFont());</span>
<span class="nc" id="L2610">                tf.getUnselectedStyle().setFont(font.getFont());</span>

<span class="nc bnc" id="L2612" title="All 2 branches missed.">                if ((!PROCESS_HTML_MP1_ONLY) &amp;&amp; (element.getAttributeById(HTMLElement.ATTR_READONLY) != null)) {</span>
<span class="nc" id="L2613">                    tf.setEditable(false);</span>
                }
<span class="nc" id="L2615">                cmp = tf;</span>
<span class="nc bnc" id="L2616" title="All 2 branches missed.">                if (curForm != null) {</span>
<span class="nc" id="L2617">                    curForm.addInput(name, cmp, value);</span>
<span class="nc" id="L2618">                    textfieldsToForms.put(tf, curForm);</span>
                }
                break;
            case INPUT_RADIO:
<span class="nc" id="L2622">                RadioButton rb = new RadioButton(&quot; &quot;);</span>
<span class="nc bnc" id="L2623" title="All 2 branches missed.">                if (element.getAttributeById(HTMLElement.ATTR_CHECKED) != null) {</span>
<span class="nc" id="L2624">                    rb.setSelected(true);</span>
                }

<span class="nc" id="L2627">                cmp = rb;</span>
<span class="nc bnc" id="L2628" title="All 2 branches missed.">                if (curForm != null) {</span>
<span class="nc" id="L2629">                    curForm.addRadioButton(name, rb, value);</span>
                }
                break;
            case INPUT_RESET:
<span class="nc" id="L2633">                Command resetCmd = null;</span>
<span class="nc bnc" id="L2634" title="All 2 branches missed.">                if (curForm != null) {</span>
<span class="nc" id="L2635">                    resetCmd = curForm.createResetCommand(value);</span>
                }
<span class="nc bnc" id="L2637" title="All 2 branches missed.">                if (resetCmd == null) {</span>
<span class="nc" id="L2638">                    resetCmd = new Command(getUIManager().localize(&quot;html.reset&quot;, HTMLForm.DEFAULT_RESET_TEXT)); //dummy command - no form so it won't do anything</span>
                }
<span class="nc" id="L2640">                Button resetButton = new Button(resetCmd);</span>
<span class="nc" id="L2641">                cmp = resetButton;</span>

<span class="nc" id="L2643">                break;</span>
            case INPUT_BUTTON:
            case INPUT_SUBMIT:
<span class="nc" id="L2646">                Command submitCmd = null;</span>
<span class="nc bnc" id="L2647" title="All 2 branches missed.">                if (curForm != null) {</span>
<span class="nc" id="L2648">                    submitCmd = curForm.createSubmitCommand(name, value);</span>
                }
<span class="nc bnc" id="L2650" title="All 2 branches missed.">                if (submitCmd == null) {</span>
<span class="nc bnc" id="L2651" title="All 2 branches missed.">                    submitCmd = new Command(value.equals(&quot;&quot;) ? value = getUIManager().localize(&quot;html.submit&quot;, HTMLForm.DEFAULT_SUBMIT_TEXT) : value); //dummy command - no form so it won't do anything</span>
                }
<span class="nc" id="L2653">                Button submitButton = new Button(submitCmd);</span>
<span class="nc" id="L2654">                cmp = submitButton;</span>
<span class="nc" id="L2655">                break;</span>
            case INPUT_IMAGE: // Image submit is not officially supported in XHTML-MP 1.0 but was added anyway, but pixel data submission is not supported (i.e. name.x=xx&amp;name.y=yy)
<span class="nc" id="L2657">                submitCmd = null;</span>
<span class="nc bnc" id="L2658" title="All 2 branches missed.">                if (curForm != null) {</span>
<span class="nc" id="L2659">                    submitCmd = curForm.createSubmitCommand(name, value);</span>
                }
<span class="nc" id="L2661">                handleImage(element, align, submitCmd);</span>
                break;
        }

<span class="nc bnc" id="L2665" title="All 2 branches missed.">        if (cmp != null) {</span>
<span class="nc bnc" id="L2666" title="All 2 branches missed.">            if ((!PROCESS_HTML_MP1_ONLY) &amp;&amp; (element.getAttributeById(HTMLElement.ATTR_DISABLED) != null)) {</span>
<span class="nc" id="L2667">                cmp.setEnabled(false);</span>
            }
<span class="nc" id="L2669">            String aKey = element.getAttributeById(HTMLElement.ATTR_ACCESSKEY);</span>
<span class="nc bnc" id="L2670" title="All 4 branches missed.">            if ((aKey != null) &amp;&amp; (aKey.length() == 1)) {</span>
<span class="nc" id="L2671">                addAccessKey(aKey.charAt(0), cmp, false);//accessKeys.put(new Integer(aKey.charAt(0)), cmp);</span>
            }
<span class="nc bnc" id="L2673" title="All 2 branches missed.">            if (eventsListener != null) {</span>
<span class="nc" id="L2674">                eventsListener.registerComponent(cmp, element);</span>
            }
<span class="nc" id="L2676">            element.setAssociatedComponents(cmp); //Even if CSS is off, we need to associate it for HTMLElement.getCurentValue</span>
<span class="nc bnc" id="L2677" title="All 4 branches missed.">            if ((curForm != null) &amp;&amp; (curForm.action == null)) { //Form that submits to a forbidden link</span>
<span class="nc" id="L2678">                cmp.setEnabled(false);</span>
<span class="nc bnc" id="L2679" title="All 2 branches missed.">            } else if (firstFocusable == null) {</span>
<span class="nc" id="L2680">                firstFocusable = cmp;</span>
            }

<span class="nc bnc" id="L2683" title="All 2 branches missed.">            if (id != null) {</span>
<span class="nc" id="L2684">                inputFields.put(id, cmp);</span>
            }
        }

<span class="nc" id="L2688">        addCmp(cmp, align);</span>

<span class="nc" id="L2690">    }</span>

    /**
     * Sets input format validation for a TextArea or TextField
     * This is called from the CSSEngine, and since it is done after the TextArea has been added it is a bit more complicated
     *
     * @param inputField  The TextArea to place the input format validation on
     * @param inputFormat The string representing the input format
     * @return The same TextArea or a new instance representing the element
     */
    TextArea setInputFormat(final TextArea inputField, String inputFormat) {
<span class="nc" id="L2701">        TextArea returnInputField = inputField;</span>
        if (SUPPORT_INPUT_FORMAT) {
<span class="nc" id="L2703">            HTMLForm form = (HTMLForm) textfieldsToForms.get(inputField);</span>
<span class="nc bnc" id="L2704" title="All 2 branches missed.">            if (form != null) {</span>
<span class="nc" id="L2705">                HTMLInputFormat format = HTMLInputFormat.getInputFormat(inputFormat);</span>
<span class="nc bnc" id="L2706" title="All 2 branches missed.">                if (format != null) {</span>
<span class="nc" id="L2707">                    form.setInputFormat(inputField, format);</span>
<span class="nc" id="L2708">                    final TextArea newInputField = format.applyConstraints(inputField);</span>
<span class="nc" id="L2709">                    returnInputField = newInputField;</span>

                    // Replace operation must be done on the EDT if the form is visible
<span class="nc bnc" id="L2712" title="All 2 branches missed.">                    if (Display.getInstance().getCurrent() != inputField.getComponentForm()) { // ((inputField.getComponentForm()==null) ||</span>
<span class="nc" id="L2713">                        inputField.getParent().replace(inputField, newInputField, null); // Applying the constraints may return a new instance that has to be replaced in the form</span>
                    } else {
<span class="nc" id="L2715">                        Display.getInstance().callSerially(new Runnable() {</span>
                            public void run() {
<span class="nc" id="L2717">                                inputField.getParent().replace(inputField, newInputField, null); // Applying the constraints may return a new instance that has to be replaced in the form</span>
<span class="nc" id="L2718">                            }</span>
                        });
                    }
<span class="nc bnc" id="L2721" title="All 2 branches missed.">                    if (firstFocusable == inputField) {</span>
<span class="nc" id="L2722">                        firstFocusable = newInputField;</span>
                    }
                }
            }
        }
<span class="nc" id="L2727">        return returnInputField;</span>
    }

    /**
     * Sets an input-required restriction on the given input field
     *
     * @param inputField    The TextArea to place the input required restriction on
     * @param inputRequired true if input is required (i.e. emptyok=false), false if input is not required (i.e. emptyok=true)
     */
    void setInputRequired(TextArea inputField, boolean inputRequired) {
        if (SUPPORT_INPUT_FORMAT) {
<span class="nc" id="L2738">            HTMLForm form = (HTMLForm) textfieldsToForms.get(inputField);</span>
<span class="nc bnc" id="L2739" title="All 2 branches missed.">            if (form != null) {</span>
                // Note that input-required is the reverse from emptyok...
<span class="nc bnc" id="L2741" title="All 2 branches missed.">                form.setEmptyOK(inputField, !inputRequired);</span>
            }
        }
<span class="nc" id="L2744">    }</span>

    /**
     * Adds the given component to the curLine container after performing size checks
     *
     * @param cmp The component to add
     */
    private void addCmp(Component cmp, int align) {
<span class="nc bnc" id="L2752" title="All 2 branches missed.">        if (cmp != null) {</span>
            if ((FIXED_WIDTH) &amp;&amp; (x + cmp.getPreferredW() &gt; width)) {
                newLine(align);
            }
<span class="nc" id="L2756">            curLine.addComponent(cmp);</span>
<span class="nc" id="L2757">            x += cmp.getPreferredW();</span>
        }
<span class="nc" id="L2759">    }</span>

    /**
     * Updates the current margin with the given delta
     *
     * @param delta The pixels to increment (positive value) or decrement (negative value) from the current margin
     */
    private void updateMargin(int delta) {
<span class="nc" id="L2767">        leftIndent += delta;</span>
<span class="nc" id="L2768">        x += delta;</span>
<span class="nc" id="L2769">        curLine.getStyle().setMargin(Component.LEFT, leftIndent);</span>
<span class="nc" id="L2770">    }</span>

    /**
     * Handles a single table cell (a TD tag)
     *
     * @param tdTag The TD tag element
     * @param align The current alignment
     */
    private void handleTableCell(HTMLElement tdTag, int align) {
<span class="nc" id="L2779">        newLineIfNotEmpty(align);</span>
<span class="nc" id="L2780">        tableCells.addElement(curContainer);</span>
<span class="nc" id="L2781">        Container cell = new Container();</span>
<span class="nc" id="L2782">        cell.getStyle().setBgTransparency(0);</span>
<span class="nc" id="L2783">        cell.setLayout(new BoxLayout(BoxLayout.Y_AXIS));</span>

        //int border=0;
<span class="nc" id="L2786">        HTMLElement trTag = (HTMLElement) tdTag.getParent();</span>
<span class="nc bnc" id="L2787" title="All 4 branches missed.">        while ((trTag != null) &amp;&amp; (trTag.getTagId() != HTMLElement.TAG_TR)) { // Though in strict XHTML TR can only contain TD/TH - in some HTMLs TR doesn't have to be the direct parent of the tdTag, i.e.: &lt;tr&gt;&lt;b&gt;&lt;td&gt;...&lt;/td&gt;... &lt;/b&gt;&lt;/tr&gt;</span>
<span class="nc" id="L2788">            trTag = (HTMLElement) trTag.getParent();</span>
        }

        // Commented since the table border should not affect cell border
            /*if (trTag!=null) { // Null checks to prevent exceptions for a TD tag without table etc.
                HTMLElement tableTag=(HTMLElement)trTag.getParent();
                while ((tableTag!=null) &amp;&amp; (tableTag.getTagId()!=HTMLElement.TAG_TABLE)) { // Though in strict XHTML TABLE can only contain TR - in some HTMLs it might be different
                    tableTag=(HTMLElement)tableTag.getParent();
                }

                if (tableTag!=null) {
                    border=getInt(tableTag.getAttributeById(HTMLElement.ATTR_BORDER));
                }
            }
            cell.getUnselectedStyle().setPadding(border, border, border, border);
            cell.getSelectedStyle().setPadding(border, border, border, border);*/

        //Constraint constraint = new Constraint();
<span class="nc" id="L2806">        CellConstraint constraint = new CellConstraint();</span>

<span class="nc" id="L2808">        int halign = align;</span>
<span class="nc" id="L2809">        int valign = Component.CENTER;</span>
<span class="nc bnc" id="L2810" title="All 2 branches missed.">        if (trTag != null) {</span>
<span class="nc" id="L2811">            HTMLElement tGroupTag = (HTMLElement) trTag.getParent();</span>
<span class="nc" id="L2812">            int tagId = tGroupTag.getTagId();</span>
<span class="nc bnc" id="L2813" title="All 6 branches missed.">            if ((tagId == HTMLElement.TAG_TBODY) || (tagId == HTMLElement.TAG_THEAD) || (tagId == HTMLElement.TAG_TFOOT)) {</span>
<span class="nc" id="L2814">                halign = getHorizAlign(tGroupTag.getAttributeById(HTMLElement.ATTR_ALIGN), halign, false); // Get the default TR alignment</span>
<span class="nc" id="L2815">                valign = getVertAlign(tGroupTag.getAttributeById(HTMLElement.ATTR_VALIGN), valign); // Get the default TR valignment</span>
            }
<span class="nc" id="L2817">            halign = getHorizAlign(trTag.getAttributeById(HTMLElement.ATTR_ALIGN), halign, false); // Get the default TR alignment</span>
<span class="nc" id="L2818">            valign = getVertAlign(trTag.getAttributeById(HTMLElement.ATTR_VALIGN), valign); // Get the default TR valignment</span>
        }

<span class="nc" id="L2821">        halign = getHorizAlign(tdTag.getAttributeById(HTMLElement.ATTR_ALIGN), halign, false);</span>
<span class="nc" id="L2822">        valign = getVertAlign(tdTag.getAttributeById(HTMLElement.ATTR_VALIGN), valign);</span>
<span class="nc" id="L2823">        int colspan = getInt(tdTag.getAttributeById(HTMLElement.ATTR_COLSPAN));</span>
<span class="nc" id="L2824">        int rowspan = getInt(tdTag.getAttributeById(HTMLElement.ATTR_ROWSPAN));</span>
<span class="nc" id="L2825">        String cWidth = tdTag.getAttributeById(HTMLElement.ATTR_WIDTH);</span>
<span class="nc" id="L2826">        int pW = getPercentage(cWidth);</span>
<span class="nc bnc" id="L2827" title="All 4 branches missed.">        if ((pW &gt; 0) &amp;&amp; (pW &lt; 100)) {</span>
            //constraint.setWidthPercentage(pW); //TODO - Setting a width constraint currently makes the field width 0 - needs to be fixed in TableLayout
        } else {
<span class="nc" id="L2830">            pW = getInt(cWidth);</span>
<span class="nc bnc" id="L2831" title="All 2 branches missed.">            if (pW != 0) {</span>
<span class="nc" id="L2832">                cell.setPreferredW(pW);</span>
            }
        }
<span class="nc" id="L2835">        String cHeight = tdTag.getAttributeById(HTMLElement.ATTR_HEIGHT);</span>
<span class="nc" id="L2836">        int pH = getPercentage(cHeight);</span>
<span class="nc bnc" id="L2837" title="All 4 branches missed.">        if ((pH &gt; 0) &amp;&amp; (pH &lt; 100)) {</span>
            //constraint.setHeightPercentage(pH); //TODO - Setting a height constraint currently makes the field height 0 - needs to be fixed in TableLayout
        } else {
<span class="nc" id="L2840">            pH = getInt(cHeight);</span>
<span class="nc bnc" id="L2841" title="All 2 branches missed.">            if (pH != 0) {</span>
<span class="nc" id="L2842">                cell.setPreferredH(pH);</span>
            }
        }

<span class="nc" id="L2846">        constraint.setHorizontalAlign(halign);</span>
<span class="nc" id="L2847">        constraint.setVerticalAlign(valign);</span>

<span class="nc bnc" id="L2849" title="All 2 branches missed.">        if (colspan &gt; 1) {</span>
<span class="nc" id="L2850">            constraint.setHorizontalSpan(colspan);</span>
        }
<span class="nc bnc" id="L2852" title="All 2 branches missed.">        if (rowspan &gt; 1) {</span>
<span class="nc" id="L2853">            constraint.setVerticalSpan(rowspan);</span>
        }

<span class="nc" id="L2856">        curContainer = cell;</span>
<span class="nc bnc" id="L2857" title="All 2 branches missed.">        if (curTable != null) {</span>
<span class="nc bnc" id="L2858" title="All 2 branches missed.">            curTable.addCell(cell, (tdTag.getTagId() == HTMLElement.TAG_TH), constraint);</span>
        }

<span class="nc bnc" id="L2861" title="All 2 branches missed.">        if (loadCSS) {</span>
<span class="nc" id="L2862">            tdTag.setAssociatedComponents(cell);</span>
<span class="nc bnc" id="L2863" title="All 2 branches missed.">            if (trTag != null) {</span>
<span class="nc" id="L2864">                trTag.addAssociatedComponent(cell);</span>
            }
        }

<span class="nc" id="L2868">    }</span>

    /**
     * Processes the given tag. This is the main processing method that calls all others and uses itself in a recursive manner.
     *
     * @param element The element to process
     * @param align   The current alignment
     */
    private void processTag(HTMLElement element, int align) {
<span class="nc bnc" id="L2877" title="All 4 branches missed.">        if ((cancelled) &amp;&amp; (!cancelledCaught)) {</span>
<span class="nc" id="L2878">            return;</span>
        }
<span class="nc" id="L2880">        int curAlign = align;</span>

<span class="nc" id="L2882">        HTMLFont oldFont = font;</span>
<span class="nc" id="L2883">        int oldFontColor = textColor;</span>
<span class="nc bnc" id="L2884" title="All 2 branches missed.">        for (int i = 0; i &lt; element.getNumChildren(); i++) {</span>
<span class="nc bnc" id="L2885" title="All 4 branches missed.">            if ((cancelled) &amp;&amp; (!cancelledCaught)) {</span>
<span class="nc" id="L2886">                break;</span>
            }
<span class="nc" id="L2888">            HTMLElement child = (HTMLElement) element.getChildAt(i);</span>

            // Process Tag Open
<span class="nc bnc" id="L2891" title="All 42 branches missed.">            switch (child.getTagId()) {</span>
                case HTMLElement.TAG_TEXT:
                    //String text=child.getAttributeById(HTMLElement.ATTR_TITLE);
<span class="nc" id="L2894">                    String text = child.getText();</span>
<span class="nc bnc" id="L2895" title="All 4 branches missed.">                    if ((curComboBox != null) &amp;&amp; (optionTag)) { // Text is inside an OPTION tag, i.e. belongs to a ComboBox</span>
<span class="nc" id="L2896">                        OptionItem oi = new OptionItem(text, optionValue);</span>
<span class="nc" id="L2897">                        curComboBox.addItem(oi);</span>
<span class="nc bnc" id="L2898" title="All 2 branches missed.">                        if (optionSelected) {</span>
<span class="nc" id="L2899">                            curComboBox.setSelectedItem(oi);</span>
<span class="nc bnc" id="L2900" title="All 2 branches missed.">                            if (curForm != null) {</span>
<span class="nc" id="L2901">                                curForm.setDefaultValue(curComboBox, oi);</span>
                            }
                        }
<span class="nc bnc" id="L2904" title="All 2 branches missed.">                    } else if (curTextArea != null) { // Text is inside of a TEXTAREA tag</span>
<span class="nc" id="L2905">                        curTextArea.setText(text);</span>
<span class="nc bnc" id="L2906" title="All 2 branches missed.">                        if (curForm != null) {</span>
<span class="nc" id="L2907">                            curForm.setDefaultValue(curTextArea, text);</span>
                        }
<span class="nc bnc" id="L2909" title="All 2 branches missed.">                    } else if (element.getTagId() == HTMLElement.TAG_LEGEND) { // Note: this is element, i.e. the child's parent (child is TAG_TEXT, and if parent is TAG_LEGEND then we process this block)</span>
<span class="nc bnc" id="L2910" title="All 2 branches missed.">                        if (fieldsets.size() &gt; 0) {</span>
<span class="nc" id="L2911">                            Container fset = (Container) fieldsets.lastElement();</span>
<span class="nc" id="L2912">                            fset.getStyle().setBorder(Border.createLineBorder(1, text));</span>
<span class="nc" id="L2913">                            fset.getStyle().setPadding(Component.TOP, fset.getStyle().getFont().getHeight() + 1);</span>
<span class="nc" id="L2914">                        }</span>
<span class="nc bnc" id="L2915" title="All 4 branches missed.">                    } else if ((curTable != null) &amp;&amp; (element.getTagId() == HTMLElement.TAG_CAPTION)) { // Note: this is element, i.e. the child's parent (child is TAG_TEXT, and if parent is TAG_LEGEND then we process this block)</span>
<span class="nc" id="L2916">                        curTable.captionTextTag = child;</span>
                    } else {
                        //long startTextTime=System.currentTimeMillis();  //debug code for performance measurement
<span class="nc" id="L2919">                        Vector comps = null;</span>
<span class="nc bnc" id="L2920" title="All 2 branches missed.">                        if (preTagCount != 0) {</span>
<span class="nc" id="L2921">                            comps = showPreTagText(text, curAlign);</span>
                        } else {

                            if (FIXED_WIDTH) {
                                comps = showTextFixedWidth(text, curAlign);
                            } else {
<span class="nc" id="L2927">                                comps = showText(text, curAlign);</span>
                            }
                        }
<span class="nc bnc" id="L2930" title="All 2 branches missed.">                        if (loadCSS) {</span>
<span class="nc" id="L2931">                            child.setAssociatedComponents(comps);</span>
                        }
                        //textTime+=(System.currentTimeMillis()-startTextTime); //debug code for performance measurement
                    }
<span class="nc" id="L2935">                    break;</span>
                case HTMLElement.TAG_A:
<span class="nc" id="L2937">                    link = child.getAttributeById(HTMLElement.ATTR_HREF);</span>
<span class="nc bnc" id="L2938" title="All 6 branches missed.">                    if ((link != null) &amp;&amp; (docInfo == null) &amp;&amp; (!DocumentInfo.isAbsoluteURL(link))) {</span>
<span class="nc bnc" id="L2939" title="All 2 branches missed.">                        if (htmlCallback != null) {</span>
<span class="nc" id="L2940">                            htmlCallback.parsingError(HTMLCallback.ERROR_NO_BASE_URL, child.getTagName(), child.getAttributeName(Integer.valueOf(HTMLElement.ATTR_HREF)), link, &quot;Disabling relative link (&quot; + link + &quot;), since page was set by setBody/setHTML/setDOM so there's no way to access relative URLs&quot;);</span>
                        }
<span class="nc" id="L2942">                        link = null;</span>
                    }
<span class="nc bnc" id="L2944" title="All 4 branches missed.">                    if ((link != null) &amp;&amp; (htmlCallback != null)) {</span>
<span class="nc" id="L2945">                        int linkProps = htmlCallback.getLinkProperties(this, convertURL(link));</span>
<span class="nc bnc" id="L2946" title="All 2 branches missed.">                        if ((linkProps &amp; HTMLCallback.LINK_FORBIDDEN) != 0) {</span>
<span class="nc" id="L2947">                            link = null;</span>
<span class="nc bnc" id="L2948" title="All 2 branches missed.">                        } else if ((linkProps &amp; HTMLCallback.LINK_VISTED) != 0) {</span>
<span class="nc" id="L2949">                            linkVisited = true;</span>
                        }
                    }

<span class="nc" id="L2953">                    anchor = child.getAttributeById(HTMLElement.ATTR_NAME);</span>

<span class="nc bnc" id="L2955" title="All 2 branches missed.">                    if (link != null) {</span>
<span class="nc" id="L2956">                        String aKey = child.getAttributeById(HTMLElement.ATTR_ACCESSKEY);</span>
<span class="nc bnc" id="L2957" title="All 4 branches missed.">                        if ((aKey != null) &amp;&amp; (aKey.length() == 1)) {</span>
<span class="nc" id="L2958">                            accesskey = aKey.charAt(0);</span>
                        }
<span class="nc" id="L2960">                    }</span>
                    break;
                case HTMLElement.TAG_H1:
                case HTMLElement.TAG_H2:
                case HTMLElement.TAG_H3:
                case HTMLElement.TAG_H4:
                case HTMLElement.TAG_H5:
                case HTMLElement.TAG_H6:
<span class="nc" id="L2968">                    font = (HTMLFont) fonts.get(child.getTagName());</span>
<span class="nc bnc" id="L2969" title="All 2 branches missed.">                    if (font == null) {</span>
<span class="nc" id="L2970">                        font = oldFont;</span>
                    }
                    // No break here intentionally
                case HTMLElement.TAG_P:
<span class="nc" id="L2974">                    curAlign = getHorizAlign(child.getAttributeById(HTMLElement.ATTR_ALIGN), align, true);</span>
<span class="nc" id="L2975">                    adjustAlignment(align, curAlign);</span>
<span class="nc" id="L2976">                    newLineIfNotEmpty(curAlign);</span>
<span class="nc" id="L2977">                    newLineIfLastWasNotEmpty(curAlign);</span>
<span class="nc" id="L2978">                    pushContainer(child);</span>
<span class="nc" id="L2979">                    break;</span>
                case HTMLElement.TAG_DIV:
                case HTMLElement.TAG_CENTER: // CENTER is practically DIV align=CENTER
<span class="nc bnc" id="L2982" title="All 2 branches missed.">                    curAlign = child.getTagId() == HTMLElement.TAG_DIV ? getHorizAlign(child.getAttributeById(HTMLElement.ATTR_ALIGN), align, true) : Component.CENTER;</span>
<span class="nc" id="L2983">                    adjustAlignment(align, curAlign);</span>
<span class="nc" id="L2984">                    newLineIfNotEmpty(curAlign);</span>
<span class="nc" id="L2985">                    pushContainer(child);</span>
<span class="nc" id="L2986">                    break;</span>
                case HTMLElement.TAG_FIELDSET:
<span class="nc" id="L2988">                    newLineIfNotEmpty(curAlign);</span>
<span class="nc" id="L2989">                    Container newCont = new Container();</span>
<span class="nc" id="L2990">                    newCont.setUIID(&quot;HTMLFieldset&quot;);</span>
<span class="nc bnc" id="L2991" title="All 2 branches missed.">                    if (fieldsets.size() == 0) { // First fieldset shouldn't have margin</span>
<span class="nc" id="L2992">                        newCont.getStyle().setMargin(Component.LEFT, 0);</span>
                    }
<span class="nc" id="L2994">                    newCont.setLayout(new BoxLayout(BoxLayout.Y_AXIS));</span>
<span class="nc" id="L2995">                    curContainer.addComponent(newCont);</span>
<span class="nc" id="L2996">                    fieldsets.addElement(newCont);</span>
<span class="nc" id="L2997">                    curContainer = newCont;</span>
<span class="nc bnc" id="L2998" title="All 2 branches missed.">                    if (loadCSS) {</span>
<span class="nc" id="L2999">                        child.setAssociatedComponents(newCont);</span>
                    }

                    break;
                case HTMLElement.TAG_BR:
<span class="nc bnc" id="L3004" title="All 2 branches missed.">                    if (loadCSS) {</span>
<span class="nc" id="L3005">                        child.setAssociatedComponents(curLine);</span>
                    }
<span class="nc" id="L3007">                    newLine(curAlign);</span>
<span class="nc" id="L3008">                    break;</span>
                case HTMLElement.TAG_DL:
<span class="nc" id="L3010">                    newLineIfNotEmpty(curAlign);</span>
<span class="nc" id="L3011">                    newLine(curAlign);</span>
<span class="nc" id="L3012">                    pushContainer(child);</span>
<span class="nc" id="L3013">                    break;</span>
                case HTMLElement.TAG_DT:
<span class="nc" id="L3015">                    newLineIfNotEmpty(curAlign);</span>
<span class="nc" id="L3016">                    pushContainer(child);</span>
<span class="nc" id="L3017">                    break;</span>
                case HTMLElement.TAG_UL:
                case HTMLElement.TAG_DIR:
                case HTMLElement.TAG_MENU:
<span class="nc" id="L3021">                    newLineIfNotEmpty(curAlign);</span>
<span class="nc" id="L3022">                    ulLevel++;</span>
<span class="nc" id="L3023">                    listIndent += INDENT_UL;</span>
<span class="nc bnc" id="L3024" title="All 4 branches missed.">                    if ((ulLevel == 1) &amp;&amp; (olIndex == Integer.MIN_VALUE)) { //newline only if it's the first list</span>
<span class="nc" id="L3025">                        newLine(curAlign);</span>
                    } else {
<span class="nc" id="L3027">                        listIndent += INDENT_UL; //extra indentation for level 2 and beyond</span>
                    }
<span class="nc" id="L3029">                    pushContainer(child);</span>
<span class="nc" id="L3030">                    break;</span>
                case HTMLElement.TAG_OL:
<span class="nc" id="L3032">                    newLineIfNotEmpty(curAlign);</span>
<span class="nc bnc" id="L3033" title="All 2 branches missed.">                    if (olIndex != Integer.MIN_VALUE) {</span>
<span class="nc" id="L3034">                        String indexStr = ORDERED_LIST_TYPE_IDENTIFIERS[listType] + &quot;&quot; + olIndex;</span>
<span class="nc" id="L3035">                        olUpperLevelIndex.addElement(indexStr); //new Integer(olIndex));</span>
                    }
<span class="nc" id="L3037">                    olIndex = getInt(child.getAttributeById(HTMLElement.ATTR_START), 1); //olIndex=1;</span>
<span class="nc" id="L3038">                    listType = getOrderedListType(child);</span>

<span class="nc bnc" id="L3040" title="All 4 branches missed.">                    if ((olUpperLevelIndex.size() == 0) &amp;&amp; (ulLevel == 0)) { //newline only if it's the first list</span>
<span class="nc" id="L3041">                        newLine(curAlign);</span>
                    } else {
<span class="nc" id="L3043">                        listIndent += INDENT_OL; // add indent only for second level - first one already gets it from the numbers alignment to a 4-digit number</span>
                    }
<span class="nc" id="L3045">                    pushContainer(child);</span>
<span class="nc" id="L3046">                    break;</span>
                case HTMLElement.TAG_LI:
<span class="nc" id="L3048">                    Container listItemCont = new Container(new BorderLayout());</span>
<span class="nc" id="L3049">                    listItemCont.getStyle().setMargin(Component.LEFT, leftIndent + listIndent);</span>
<span class="nc" id="L3050">                    curContainer.addComponent(listItemCont);</span>
<span class="nc" id="L3051">                    containers.addElement(curContainer);</span>

<span class="nc" id="L3053">                    HTMLListItem bullet = null;</span>
<span class="nc bnc" id="L3054" title="All 2 branches missed.">                    if (((HTMLElement) child.getParent()).getTagId() == HTMLElement.TAG_OL) {</span>
<span class="nc" id="L3055">                        olIndex = getInt(child.getAttributeById(HTMLElement.ATTR_VALUE), olIndex);</span>
<span class="nc" id="L3056">                        int itemListType = getOrderedListType(child, listType);</span>
<span class="nc" id="L3057">                        HTMLListIndex listIndex = new HTMLListIndex(olIndex, itemListType);</span>
<span class="nc" id="L3058">                        listIndex.getUnselectedStyle().setFgColor(textColor);</span>
<span class="nc" id="L3059">                        listIndex.getSelectedStyle().setFgColor(textColor);</span>
<span class="nc" id="L3060">                        listIndex.getUnselectedStyle().setFont(font.getFont());</span>
<span class="nc" id="L3061">                        bullet = listIndex;</span>

                        // following aligns short and long numbers (assuming a 4-digit number as the maximum, as other browsers do)
<span class="nc" id="L3064">                        bullet.getUnselectedStyle().setAlignment(Component.RIGHT);</span>
<span class="nc" id="L3065">                        bullet.setPreferredW(font.getFont().stringWidth(&quot;8888. &quot;));</span>
<span class="nc" id="L3066">                    } else {</span>
<span class="nc" id="L3067">                        bullet = new HTMLBullet(getUnorderedListType(child, ulLevel), font.getFont().getHeight(), textColor, this);</span>
                    }
<span class="nc" id="L3069">                    Container bulletCont = new Container(new BorderLayout());</span>
<span class="nc" id="L3070">                    bulletCont.addComponent(BorderLayout.NORTH, bullet);</span>
<span class="nc" id="L3071">                    listItemCont.addComponent(BorderLayout.WEST, bulletCont);</span>

<span class="nc" id="L3073">                    Container listItemText = new Container(new BoxLayout(BoxLayout.Y_AXIS));</span>
<span class="nc" id="L3074">                    listItemCont.addComponent(BorderLayout.CENTER, listItemText);</span>
<span class="nc" id="L3075">                    curContainer = listItemText;</span>
<span class="nc bnc" id="L3076" title="All 2 branches missed.">                    if (loadCSS) {</span>
<span class="nc" id="L3077">                        child.setAssociatedComponents(listItemText);</span>
                    }
                    break;

                case HTMLElement.TAG_BLOCKQUOTE:
<span class="nc" id="L3082">                    newLineIfNotEmpty(curAlign);</span>
<span class="nc" id="L3083">                    updateMargin(INDENT_BLOCKQUOTE);</span>
<span class="nc" id="L3084">                    newLine(curAlign);</span>
<span class="nc" id="L3085">                    pushContainer(child);</span>
<span class="nc" id="L3086">                    break;</span>
                case HTMLElement.TAG_DD:
<span class="nc" id="L3088">                    newLineIfNotEmpty(curAlign);</span>
<span class="nc" id="L3089">                    updateMargin(INDENT_DD);</span>
<span class="nc" id="L3090">                    pushContainer(child);</span>
<span class="nc" id="L3091">                    break;</span>
                case HTMLElement.TAG_HR:
<span class="nc" id="L3093">                    newLineIfNotEmpty(curAlign);</span>
<span class="nc" id="L3094">                    Label hr = new Label();</span>
<span class="nc" id="L3095">                    hr.setUIID(&quot;HTMLHR&quot;);</span>
                    //hr.getStyle().setBorder(Border.createBevelRaised());
<span class="nc" id="L3097">                    int hrWidth = calcSize(width, child.getAttributeById(HTMLElement.ATTR_WIDTH), width, false);</span>
<span class="nc" id="L3098">                    int hrHeight = getInt(child.getAttributeById(HTMLElement.ATTR_SIZE), HR_THICKNESS);</span>
<span class="nc" id="L3099">                    hr.setPreferredW(hrWidth);</span>
<span class="nc" id="L3100">                    hr.setPreferredH(hrHeight);</span>
<span class="nc" id="L3101">                    curLine.addComponent(hr);</span>
<span class="nc" id="L3102">                    newLine(curAlign);</span>
<span class="nc bnc" id="L3103" title="All 2 branches missed.">                    if (loadCSS) {</span>
<span class="nc" id="L3104">                        child.setAssociatedComponents(hr);</span>
                    }
                    break;
                case HTMLElement.TAG_STYLE:
<span class="nc" id="L3108">                    break;</span>
                case HTMLElement.TAG_IMG:
<span class="nc" id="L3110">                    handleImage(child, curAlign, null);</span>
<span class="nc" id="L3111">                    break;</span>

                case HTMLElement.TAG_PRE:
<span class="nc" id="L3114">                    preTagCount++;</span>
<span class="nc" id="L3115">                    pushContainer(child);</span>
                case HTMLElement.TAG_EM:
                case HTMLElement.TAG_STRONG:
                case HTMLElement.TAG_DFN:
                case HTMLElement.TAG_CODE:
                case HTMLElement.TAG_SAMP:
                case HTMLElement.TAG_KBD:
                case HTMLElement.TAG_VAR:
                case HTMLElement.TAG_CITE:
                case HTMLElement.TAG_TT:
<span class="nc" id="L3125">                    font = (HTMLFont) fonts.get(child.getTagName());</span>
<span class="nc bnc" id="L3126" title="All 2 branches missed.">                    if (font == null) {</span>
<span class="nc" id="L3127">                        font = oldFont;</span>
                    }
                    break;

                case HTMLElement.TAG_B:
                case HTMLElement.TAG_I:
                case HTMLElement.TAG_BIG:
                case HTMLElement.TAG_SMALL:
<span class="nc" id="L3135">                    font = getCounterpartFont(child.getTagId(), font);</span>
<span class="nc" id="L3136">                    break;</span>
                case HTMLElement.TAG_FORM:
<span class="nc" id="L3138">                    curForm = new HTMLForm(this, child.getAttributeById(HTMLElement.ATTR_ACTION), child.getAttributeById(HTMLElement.ATTR_METHOD), child.getAttributeById(HTMLElement.ATTR_ENCTYPE));</span>
<span class="nc" id="L3139">                    pushContainer(child);</span>
<span class="nc" id="L3140">                    break;</span>
                case HTMLElement.TAG_BUTTON:
                case HTMLElement.TAG_INPUT:
<span class="nc" id="L3143">                    handleInput(child, curAlign);</span>
<span class="nc" id="L3144">                    break;</span>
                case HTMLElement.TAG_SELECT:
<span class="nc" id="L3146">                    String multi = child.getAttributeById(HTMLElement.ATTR_MULTIPLE);</span>

                    // If a select tag has size specified, it will be shown as an open list, and not as Codename One combo, even if there's no multiple seection allowed
<span class="nc bnc" id="L3149" title="All 4 branches missed.">                    if ((multi != null) || (child.getAttributeById(HTMLElement.ATTR_SIZE) != null)) {</span>
<span class="nc bnc" id="L3150" title="All 2 branches missed.">                        curComboBox = new MultiComboBox(multi != null);</span>
<span class="nc" id="L3151">                        Container comboCont = new Container(new BorderLayout());</span>
<span class="nc" id="L3152">                        curComboBox.setItemGap(0);</span>
<span class="nc" id="L3153">                        comboCont.setUIID(&quot;ComboBox&quot;);</span>
<span class="nc" id="L3154">                        curComboBox.setUIID(&quot;List&quot;);</span>
<span class="nc" id="L3155">                        comboCont.addComponent(BorderLayout.CENTER, curComboBox);</span>
<span class="nc" id="L3156">                    } else {</span>
<span class="nc" id="L3157">                        curComboBox = new HTMLComboBox();</span>
                    }
<span class="nc" id="L3159">                    String name = child.getAttributeById(HTMLElement.ATTR_NAME);</span>

<span class="nc bnc" id="L3161" title="All 2 branches missed.">                    if (curForm != null) {</span>
<span class="nc" id="L3162">                        curForm.addInput(name, curComboBox, null);</span>
                    }

<span class="nc" id="L3165">                    child.setAssociatedComponents(curComboBox);  //Even if CSS is off, we need to associate it for HTMLElement.getCurentValue</span>
<span class="nc bnc" id="L3166" title="All 2 branches missed.">                    if (eventsListener != null) {</span>
<span class="nc" id="L3167">                        eventsListener.registerComponent(curComboBox, child);</span>
                    }

<span class="nc bnc" id="L3170" title="All 2 branches missed.">                    if ((!PROCESS_HTML_MP1_ONLY) &amp;&amp; (child.getAttributeById(HTMLElement.ATTR_DISABLED) != null)) {</span>
<span class="nc" id="L3171">                        curComboBox.setEnabled(false);</span>
                    }
                    break;
                case HTMLElement.TAG_OPTGROUP:
<span class="nc bnc" id="L3175" title="All 2 branches missed.">                    if (curComboBox != null) {</span>
<span class="nc" id="L3176">                        String label = child.getAttributeById(HTMLElement.ATTR_LABEL);</span>
<span class="nc bnc" id="L3177" title="All 2 branches missed.">                        if (label != null) {</span>
<span class="nc" id="L3178">                            curComboBox.addItem(label);</span>
                        }
<span class="nc" id="L3180">                    }</span>
                    break;
                case HTMLElement.TAG_OPTION:
<span class="nc" id="L3183">                    optionTag = true;</span>
<span class="nc" id="L3184">                    optionValue = child.getAttributeById(HTMLElement.ATTR_VALUE);</span>
<span class="nc bnc" id="L3185" title="All 4 branches missed.">                    if ((curComboBox != null) &amp;&amp; (child.getAttributeById(HTMLElement.ATTR_SELECTED) != null)) {</span>
<span class="nc" id="L3186">                        optionSelected = true;</span>
                    }
                    break;
                case HTMLElement.TAG_TEXTAREA:
<span class="nc" id="L3190">                    curTextArea = new TextArea(getInt(child.getAttributeById(HTMLElement.ATTR_ROWS), DEFAULT_TEXTAREA_ROWS),</span>
<span class="nc" id="L3191">                            getInt(child.getAttributeById(HTMLElement.ATTR_COLS), DEFAULT_TEXTAREA_COLS));</span>
                    if (!PROCESS_HTML_MP1_ONLY) {
<span class="nc bnc" id="L3193" title="All 2 branches missed.">                        if (child.getAttributeById(HTMLElement.ATTR_DISABLED) != null) {</span>
<span class="nc" id="L3194">                            curTextArea.setEnabled(false);</span>
                        }
<span class="nc bnc" id="L3196" title="All 2 branches missed.">                        if (child.getAttributeById(HTMLElement.ATTR_READONLY) != null) {</span>
<span class="nc" id="L3197">                            curTextArea.setEditable(false);</span>
                        }
                    }

<span class="nc" id="L3201">                    addCmp(curTextArea, curAlign);</span>
<span class="nc bnc" id="L3202" title="All 2 branches missed.">                    if (eventsListener != null) {</span>
<span class="nc" id="L3203">                        eventsListener.registerComponent(curTextArea, child);</span>
                    }
<span class="nc" id="L3205">                    child.setAssociatedComponents(curTextArea); //Even if CSS is off, we need to associate it for HTMLElement.getCurentValue</span>
<span class="nc" id="L3206">                    String aKey = element.getAttributeById(HTMLElement.ATTR_ACCESSKEY);</span>
<span class="nc bnc" id="L3207" title="All 4 branches missed.">                    if ((aKey != null) &amp;&amp; (aKey.length() == 1)) {</span>
<span class="nc" id="L3208">                        addAccessKey(aKey.charAt(0), curTextArea, false);//accessKeys.put(new Integer(aKey.charAt(0)), curTextArea);</span>
                    }

                    break;
                case HTMLElement.TAG_Q:
<span class="nc" id="L3213">                    addQuote(child, curAlign, true);</span>
<span class="nc" id="L3214">                    quoteTagCount++;</span>
<span class="nc" id="L3215">                    break;</span>
                case HTMLElement.TAG_TABLE:
<span class="nc" id="L3217">                    newLineIfNotEmpty(curAlign);</span>
<span class="nc bnc" id="L3218" title="All 2 branches missed.">                    if (curTable != null) {</span>
<span class="nc" id="L3219">                        tables.addElement(curTable);</span>
<span class="nc" id="L3220">                        HTMLTableModel newTable = new HTMLTableModel();</span>
<span class="nc" id="L3221">                        curTable = newTable;</span>
<span class="nc" id="L3222">                    } else {</span>
<span class="nc" id="L3223">                        curTable = new HTMLTableModel();</span>
                    }
<span class="nc" id="L3225">                    width = width / 2; // In fixed width mode we arbitrarily divide the size by a factor knowing that probably there are several cells (If we don't do it, labels inside the cell will be built up to the full width size, leaving no space for others)</span>

<span class="nc" id="L3227">                    break;</span>
                case HTMLElement.TAG_TR:
<span class="nc" id="L3229">                    break;</span>
                case HTMLElement.TAG_TH:
                case HTMLElement.TAG_TD:
<span class="nc bnc" id="L3232" title="All 2 branches missed.">                    if (curTable != null) {</span>
<span class="nc" id="L3233">                        handleTableCell(child, curAlign);</span>
                    }
                    break;
                case HTMLElement.TAG_LABEL:
<span class="nc" id="L3237">                    labelForID = child.getAttributeById(HTMLElement.ATTR_FOR);</span>
<span class="nc" id="L3238">                    aKey = child.getAttributeById(HTMLElement.ATTR_ACCESSKEY);</span>
<span class="nc bnc" id="L3239" title="All 4 branches missed.">                    if ((aKey != null) &amp;&amp; (aKey.length() == 1)) {</span>
<span class="nc" id="L3240">                        accesskey = aKey.charAt(0);</span>
                    }
                    break;

                // HTML 4 tags
                case HTMLElement.TAG_FONT:
<span class="nc" id="L3246">                    textColor = HTMLElement.getColor(child.getAttributeById(HTMLElement.ATTR_COLOR), textColor); // TODO - This will not work for nested font tags, need to either define color as a local parameter or create a vector stack</span>
<span class="nc" id="L3247">                    String family = child.getAttributeById(HTMLElement.ATTR_FACE);</span>
<span class="nc" id="L3248">                    int size = getInt(child.getAttributeById(HTMLElement.ATTR_SIZE));</span>
<span class="nc bnc" id="L3249" title="All 4 branches missed.">                    if ((family != null) || (size != 0)) {</span>
<span class="nc" id="L3250">                        HTMLFont f = getClosestHTMLFont(family, size, 0, 0);</span>
<span class="nc bnc" id="L3251" title="All 2 branches missed.">                        if (f != null) {</span>
<span class="nc" id="L3252">                            font = f;</span>
                        }
<span class="nc" id="L3254">                    }</span>
                    break;

                case HTMLElement.TAG_U:
                case HTMLElement.TAG_INS: // INS (Inserted text) is rendered exactly like U (underline) in most browsers
<span class="nc bnc" id="L3259" title="All 2 branches missed.">                    if (underlineCount == 0) {</span>
<span class="nc" id="L3260">                        textDecoration |= Style.TEXT_DECORATION_UNDERLINE;</span>
                    }
<span class="nc" id="L3262">                    underlineCount++;</span>
<span class="nc" id="L3263">                    break;</span>
                case HTMLElement.TAG_S:
                case HTMLElement.TAG_STRIKE:
                case HTMLElement.TAG_DEL:// DEL (Deleted text) is rendered exactly like S (strikethru) in most browsers
<span class="nc bnc" id="L3267" title="All 2 branches missed.">                    if (strikethruCount == 0) {</span>
<span class="nc" id="L3268">                        textDecoration |= Style.TEXT_DECORATION_STRIKETHRU;</span>
                    }
<span class="nc" id="L3270">                    strikethruCount++;</span>
<span class="nc" id="L3271">                    break;</span>
                case HTMLElement.TAG_MAP:
<span class="nc" id="L3273">                    String mapName = child.getAttributeById(HTMLElement.ATTR_NAME);</span>
<span class="nc" id="L3274">                    curImageMap = new ImageMapData(mapName);</span>
<span class="nc" id="L3275">                    break;</span>
                case HTMLElement.TAG_AREA:
<span class="nc" id="L3277">                    handleImageMapArea(child);</span>
<span class="nc" id="L3278">                    break;</span>
                case HTMLElement.TAG_SUP:
<span class="nc" id="L3280">                    superscript++;</span>
<span class="nc" id="L3281">                    break;</span>
                case HTMLElement.TAG_SUB:
<span class="nc" id="L3283">                    superscript--;</span>
<span class="nc" id="L3284">                    break;</span>
                case HTMLElement.TAG_TBODY:
<span class="nc bnc" id="L3286" title="All 2 branches missed.">                    if (curTable != null) {</span>
<span class="nc" id="L3287">                        curTable.startSegment(HTMLTableModel.SEGMENT_TBODY);</span>
                    }
                    break;
                case HTMLElement.TAG_THEAD:
<span class="nc bnc" id="L3291" title="All 2 branches missed.">                    if (curTable != null) {</span>
<span class="nc" id="L3292">                        curTable.startSegment(HTMLTableModel.SEGMENT_THEAD);</span>
                    }
                    break;
                case HTMLElement.TAG_TFOOT:
<span class="nc bnc" id="L3296" title="All 2 branches missed.">                    if (curTable != null) {</span>
<span class="nc" id="L3297">                        curTable.startSegment(HTMLTableModel.SEGMENT_TFOOT);</span>
                    }
                    break;

            }

<span class="nc bnc" id="L3303" title="All 2 branches missed.">            if (child.getNumChildren() &gt; 0) {</span>
<span class="nc" id="L3304">                processTag(child, curAlign);</span>
            }

            // Process close tag
<span class="nc bnc" id="L3308" title="All 31 branches missed.">            switch (child.getTagId()) {</span>
                case HTMLElement.TAG_H1:
                case HTMLElement.TAG_H2:
                case HTMLElement.TAG_H3:
                case HTMLElement.TAG_H4:
                case HTMLElement.TAG_H5:
                case HTMLElement.TAG_H6:
<span class="nc" id="L3315">                    font = oldFont;</span>
                case HTMLElement.TAG_P:
<span class="nc" id="L3317">                    curAlign = align; //Restore previous alignment</span>
<span class="nc" id="L3318">                    newLineIfNotEmpty(curAlign);</span>
<span class="nc" id="L3319">                    popContainer();</span>
<span class="nc" id="L3320">                    newLine(curAlign);</span>
<span class="nc" id="L3321">                    break;</span>
                case HTMLElement.TAG_DIV:
                case HTMLElement.TAG_CENTER:
<span class="nc" id="L3324">                    curAlign = align; //Restore previous alignment</span>
<span class="nc" id="L3325">                    newLineIfNotEmpty(curAlign);</span>
<span class="nc" id="L3326">                    popContainer();</span>
<span class="nc" id="L3327">                    break;</span>
                case HTMLElement.TAG_FIELDSET:
<span class="nc" id="L3329">                    newLineIfNotEmpty(curAlign);</span>
<span class="nc" id="L3330">                    Container fieldsetContainer = (Container) fieldsets.lastElement();</span>
<span class="nc" id="L3331">                    curContainer = fieldsetContainer.getParent();</span>
<span class="nc" id="L3332">                    fieldsets.removeElement(fieldsetContainer);</span>
<span class="nc" id="L3333">                    break;</span>
                case HTMLElement.TAG_BLOCKQUOTE:
<span class="nc" id="L3335">                    newLineIfNotEmpty(curAlign);</span>
<span class="nc" id="L3336">                    newLine(curAlign);</span>
<span class="nc" id="L3337">                    updateMargin(-INDENT_BLOCKQUOTE);</span>
<span class="nc" id="L3338">                    popContainer();</span>
<span class="nc" id="L3339">                    break;</span>
                case HTMLElement.TAG_DT:
<span class="nc" id="L3341">                    popContainer();</span>
<span class="nc" id="L3342">                    break;</span>
                case HTMLElement.TAG_DD:
<span class="nc" id="L3344">                    newLineIfNotEmpty(curAlign);</span>
<span class="nc" id="L3345">                    updateMargin(-INDENT_DD);</span>
<span class="nc" id="L3346">                    popContainer();</span>
<span class="nc" id="L3347">                    break;</span>
                case HTMLElement.TAG_DL:
<span class="nc" id="L3349">                    newLine(curAlign);</span>
<span class="nc" id="L3350">                    popContainer();</span>
<span class="nc" id="L3351">                    break;</span>
                case HTMLElement.TAG_A:
<span class="nc" id="L3353">                    link = null;</span>
<span class="nc" id="L3354">                    linkVisited = false;</span>
<span class="nc" id="L3355">                    mainLink = null;</span>
<span class="nc" id="L3356">                    anchor = null;</span>
<span class="nc" id="L3357">                    accesskey = '\0';</span>
<span class="nc" id="L3358">                    break;</span>
                case HTMLElement.TAG_UL:
                case HTMLElement.TAG_DIR:
                case HTMLElement.TAG_MENU:
<span class="nc" id="L3362">                    ulLevel--;</span>
<span class="nc bnc" id="L3363" title="All 4 branches missed.">                    if ((ulLevel == 0) &amp;&amp; (olIndex == Integer.MIN_VALUE)) {</span>
<span class="nc" id="L3364">                        newLine(curAlign);</span>
                    } else {
<span class="nc" id="L3366">                        listIndent -= INDENT_UL; // level 2 and beyond got extra indentation, so we remove it here</span>
                    }
<span class="nc" id="L3368">                    listIndent -= INDENT_UL;</span>
<span class="nc" id="L3369">                    popContainer();</span>
<span class="nc" id="L3370">                    break;</span>
                case HTMLElement.TAG_OL:
<span class="nc bnc" id="L3372" title="All 2 branches missed.">                    if (olUpperLevelIndex.size() != 0) {</span>
<span class="nc" id="L3373">                        String indexStr = (String) olUpperLevelIndex.lastElement();</span>
<span class="nc" id="L3374">                        olUpperLevelIndex.removeElementAt(olUpperLevelIndex.size() - 1);</span>
<span class="nc" id="L3375">                        listType = getOrderedListType(indexStr.charAt(0), HTMLListIndex.LIST_NUMERIC);</span>
<span class="nc" id="L3376">                        olIndex = getInt(indexStr.substring(1));</span>
<span class="nc" id="L3377">                        listIndent -= INDENT_OL; // First level of ordered list doesn't get indentation, so we substract only if it's nested</span>
<span class="nc" id="L3378">                    } else {</span>
<span class="nc" id="L3379">                        olIndex = Integer.MIN_VALUE;</span>
                    }
<span class="nc bnc" id="L3381" title="All 4 branches missed.">                    if ((olIndex == Integer.MIN_VALUE) &amp;&amp; (ulLevel == 0)) {</span>
<span class="nc" id="L3382">                        newLine(curAlign); //new line only if it is the last nested list</span>
                    }

<span class="nc" id="L3385">                    popContainer();</span>

<span class="nc" id="L3387">                    break;</span>
                case HTMLElement.TAG_LI:
<span class="nc bnc" id="L3389" title="All 2 branches missed.">                    if (olIndex != Integer.MIN_VALUE) {</span>
<span class="nc" id="L3390">                        olIndex++;</span>
                    }
<span class="nc" id="L3392">                    newLineIfNotEmpty(curAlign);</span>
                    // We can't use popContainer, since with LI the container is pushed even when CSS is ignored, to provide the spacing between the list item bullet/number and the text (in a nested way if needed)
<span class="nc" id="L3394">                    Container prevContainer = (Container) containers.lastElement();</span>
<span class="nc" id="L3395">                    curContainer = prevContainer;</span>
<span class="nc" id="L3396">                    containers.removeElement(curContainer);</span>

                    //popContainer();
                    //curContainer=listItemParentContainer;
<span class="nc" id="L3400">                    break;</span>


                case HTMLElement.TAG_PRE:
<span class="nc" id="L3404">                    preTagCount--;</span>
<span class="nc" id="L3405">                    popContainer();</span>
                case HTMLElement.TAG_FONT:
<span class="nc" id="L3407">                    textColor = oldFontColor;</span>
                case HTMLElement.TAG_EM:
                case HTMLElement.TAG_STRONG:
                case HTMLElement.TAG_DFN:
                case HTMLElement.TAG_CODE:
                case HTMLElement.TAG_SAMP:
                case HTMLElement.TAG_KBD:
                case HTMLElement.TAG_VAR:
                case HTMLElement.TAG_CITE:
                case HTMLElement.TAG_B:
                case HTMLElement.TAG_I:
                case HTMLElement.TAG_BIG:
                case HTMLElement.TAG_SMALL:
                case HTMLElement.TAG_TT:
<span class="nc" id="L3421">                    font = oldFont;</span>
<span class="nc" id="L3422">                    break;</span>
                case HTMLElement.TAG_FORM:
<span class="nc bnc" id="L3424" title="All 6 branches missed.">                    if ((curForm != null) &amp;&amp; (!curForm.hasSubmitButton) &amp;&amp; (curForm.getNumFields() &gt; 0)) { // This is a fix for forms with no submit buttons which can be resulted due to the fact XHTML-MP doesn't support the BUTTON tag and also input type button with javascript</span>
<span class="nc" id="L3425">                        Button submitButton = new Button(curForm.createSubmitCommand(null, null));</span>
<span class="nc" id="L3426">                        addCmp(submitButton, curAlign);</span>
                    }
<span class="nc" id="L3428">                    curForm = null;</span>
<span class="nc" id="L3429">                    popContainer();</span>
<span class="nc" id="L3430">                    break;</span>
                case HTMLElement.TAG_TEXTAREA:
<span class="nc" id="L3432">                    String name = child.getAttributeById(HTMLElement.ATTR_NAME);</span>

<span class="nc bnc" id="L3434" title="All 2 branches missed.">                    if (curForm != null) { // This was moved to the end tag to enable auto complete support (i.e. if there's an autocomplete it overrides the default value)</span>
<span class="nc" id="L3435">                        curForm.addInput(name, curTextArea, null);</span>
                    }

<span class="nc" id="L3438">                    curTextArea = null;</span>
<span class="nc" id="L3439">                    break;</span>
                case HTMLElement.TAG_SELECT:
<span class="nc bnc" id="L3441" title="All 2 branches missed.">                    if (curComboBox instanceof MultiComboBox) {</span>
<span class="nc" id="L3442">                        Container comboCont = curComboBox.getParent();</span>
<span class="nc" id="L3443">                        int minSize = Math.min(MIN_MULTI_COMBOBOX_ITEMS, curComboBox.size());</span>
<span class="nc" id="L3444">                        int maxSize = Math.min(curComboBox.size(), MAX_MULTI_COMBOBOX_ITEMS);</span>
<span class="nc" id="L3445">                        int size = Math.min(maxSize, Math.max(getInt(child.getAttributeById(HTMLElement.ATTR_SIZE)), minSize));</span>

<span class="nc" id="L3447">                        Component renderCmp = curComboBox.getRenderer().getListCellRendererComponent(curComboBox, &quot;X&quot;, 0, false);</span>
<span class="nc" id="L3448">                        comboCont.setPreferredH((renderCmp.getPreferredH() + renderCmp.getStyle().getMargin(Component.TOP) + renderCmp.getStyle().getMargin(Component.BOTTOM) + curComboBox.getItemGap()) * size</span>
<span class="nc" id="L3449">                                + curComboBox.getStyle().getPadding(Component.TOP) + curComboBox.getStyle().getPadding(Component.BOTTOM));</span>

<span class="nc" id="L3451">                        addCmp(comboCont, curAlign);</span>
<span class="nc" id="L3452">                    } else {</span>
<span class="nc" id="L3453">                        addCmp(curComboBox, curAlign);</span>
                    }

<span class="nc" id="L3456">                    curComboBox = null;</span>
<span class="nc" id="L3457">                    break;</span>
                case HTMLElement.TAG_OPTION:
<span class="nc" id="L3459">                    optionTag = false;</span>
<span class="nc" id="L3460">                    optionSelected = false;</span>
<span class="nc" id="L3461">                    optionValue = null;</span>
<span class="nc" id="L3462">                    break;</span>
                case HTMLElement.TAG_Q:
<span class="nc" id="L3464">                    quoteTagCount--;</span>
<span class="nc" id="L3465">                    addQuote(child, curAlign, false);</span>
<span class="nc" id="L3466">                    break;</span>
                case HTMLElement.TAG_TABLE:
<span class="nc" id="L3468">                    newLineIfNotEmpty(curAlign);</span>
<span class="nc" id="L3469">                    curTable.commitRowIfNotEmpty(); // For a case that TR was not closed properly</span>
<span class="nc bnc" id="L3470" title="All 2 branches missed.">                    if (curTable.getRowCount() != 0) { //Don't add an empty table (Creates an exception in TableLayout and useless)</span>
                        /*if (TABLES_LOCK_SIZE) {
                            for(int r=0;r&lt;curTable.getRowCount();r++) {
                                for(int c=0;c&lt;curTable.getColumnCount();c++) {
                                    Component cmp=(Component)curTable.getValueAt(r, c);
                                    if (cmp!=null) { // Can be null for cells that are &quot;spanned over&quot;
                                        cmp.setPreferredSize(cmp.getPreferredSize());
                                    }
                                }
                            }
                        }*/
<span class="nc" id="L3481">                        HTMLTable table = new HTMLTable(curTable);</span>
<span class="nc" id="L3482">                        table.getStyle().setBgTransparency(0);</span>
<span class="nc bnc" id="L3483" title="All 2 branches missed.">                        if (loadCSS) {</span>
<span class="nc" id="L3484">                            child.setAssociatedComponents(table);</span>
                        }

<span class="nc" id="L3487">                        int borderSize = getInt(child.getAttributeById(HTMLElement.ATTR_BORDER));</span>
<span class="nc" id="L3488">                        int[] borderPad = new int[4];</span>
<span class="nc bnc" id="L3489" title="All 2 branches missed.">                        if (borderSize &gt; 0) {</span>
<span class="nc" id="L3490">                            int frame = PROCESS_HTML_MP1_ONLY ? -1 : HTMLUtils.getStringVal(child.getAttributeById(HTMLElement.ATTR_FRAME), HTMLElement.ALLOWED_TABLE_FRAME_STRINGS);</span>
<span class="nc" id="L3491">                            Border border = Border.createLineBorder(borderSize);</span>

<span class="nc bnc" id="L3493" title="All 2 branches missed.">                            if (frame == -1) {</span>
<span class="nc bnc" id="L3494" title="All 2 branches missed.">                                for (int s = 0; s &lt; borderPad.length; s++) {</span>
<span class="nc" id="L3495">                                    borderPad[s] = borderSize;</span>
                                }
                            } else {
<span class="nc" id="L3498">                                Border[] borders = new Border[4];</span>
<span class="nc bnc" id="L3499" title="All 2 branches missed.">                                for (int j = 0; j &lt; HTMLElement.ALLOWED_TABLE_FRAME_VALS[frame].length; j++) {</span>
<span class="nc" id="L3500">                                    int side = HTMLElement.ALLOWED_TABLE_FRAME_VALS[frame][j];</span>
<span class="nc" id="L3501">                                    borders[side] = border;</span>
<span class="nc" id="L3502">                                    borderPad[side] = borderSize;</span>
                                }
<span class="nc" id="L3504">                                border = Border.createCompoundBorder(borders[Component.TOP], borders[Component.BOTTOM], borders[Component.LEFT], borders[Component.RIGHT]);</span>
                            }

<span class="nc" id="L3507">                            table.getUnselectedStyle().setBorder(border);</span>
<span class="nc" id="L3508">                            table.getSelectedStyle().setBorder(border);</span>
<span class="nc" id="L3509">                            table.getUnselectedStyle().setPadding(borderPad[Component.TOP], borderPad[Component.BOTTOM], borderPad[Component.LEFT], borderPad[Component.RIGHT]);</span>
<span class="nc" id="L3510">                            table.getSelectedStyle().setPadding(borderPad[Component.TOP], borderPad[Component.BOTTOM], borderPad[Component.LEFT], borderPad[Component.RIGHT]);</span>
<span class="nc" id="L3511">                        } else {</span>
<span class="nc" id="L3512">                            table.getUnselectedStyle().setBorder(null);</span>
<span class="nc" id="L3513">                            table.getSelectedStyle().setBorder(null);</span>
<span class="nc" id="L3514">                            table.setDrawBorder(false);</span>
                        }

                        if (!PROCESS_HTML_MP1_ONLY) {
<span class="nc" id="L3518">                            int rules = HTMLUtils.getStringVal(child.getAttributeById(HTMLElement.ATTR_RULES), HTMLElement.ALLOWED_TABLE_RULES_STRINGS, Table.INNER_BORDERS_ALL);</span>
<span class="nc" id="L3519">                            table.setInnerBorderMode(rules);</span>
<span class="nc" id="L3520">                            int spacing = getInt(child.getAttributeById(HTMLElement.ATTR_CELLSPACING), -1);</span>
<span class="nc bnc" id="L3521" title="All 2 branches missed.">                            if (spacing != -1) {</span>
<span class="nc" id="L3522">                                table.setBorderSpacing(spacing, spacing);</span>
                            }
<span class="nc" id="L3524">                            int padding = getInt(child.getAttributeById(HTMLElement.ATTR_CELLPADDING), -1);</span>
<span class="nc bnc" id="L3525" title="All 2 branches missed.">                            if (padding != -1) {</span>
<span class="nc bnc" id="L3526" title="All 2 branches missed.">                                for (int r = 0; r &lt; curTable.getRowCount(); r++) {</span>
<span class="nc bnc" id="L3527" title="All 2 branches missed.">                                    for (int c = 0; c &lt; curTable.getColumnCount(); c++) {</span>
<span class="nc" id="L3528">                                        Component cmp = (Component) curTable.getValueAt(r, c);</span>
<span class="nc bnc" id="L3529" title="All 2 branches missed.">                                        if (cmp != null) { // Can be null for cells that are &quot;spanned over&quot;</span>
<span class="nc" id="L3530">                                            cmp.getUnselectedStyle().setPadding(padding, padding, padding, padding);</span>
<span class="nc" id="L3531">                                            cmp.getSelectedStyle().setPadding(padding, padding, padding, padding);</span>
                                        }
                                    }
                                }
                            }
                        }

<span class="nc bnc" id="L3538" title="All 2 branches missed.">                        if (curTable.captionTextTag != null) {</span>
<span class="nc" id="L3539">                            Container captionedTable = new Container(new BoxLayout(BoxLayout.Y_AXIS));</span>
<span class="nc" id="L3540">                            TextArea caption = new TextArea(curTable.captionTextTag.getText());</span>
<span class="nc" id="L3541">                            curTable.captionTextTag.setAssociatedComponents(caption);</span>
<span class="nc" id="L3542">                            caption.setUIID(&quot;HTMLTableCaption&quot;);</span>
<span class="nc" id="L3543">                            caption.setEditable(false);</span>
<span class="nc" id="L3544">                            caption.setFocusable(false);</span>
<span class="nc" id="L3545">                            caption.getStyle().setBorder(null);</span>
<span class="nc" id="L3546">                            caption.getStyle().setAlignment(Component.CENTER);</span>
<span class="nc" id="L3547">                            captionedTable.addComponent(caption);</span>
<span class="nc" id="L3548">                            captionedTable.addComponent(table);</span>
<span class="nc" id="L3549">                            addCmp(captionedTable, curAlign);</span>
<span class="nc" id="L3550">                        } else {</span>
<span class="nc" id="L3551">                            addCmp(table, curAlign);</span>
                        }
<span class="nc" id="L3553">                        newLineIfNotEmpty(curAlign);</span>
                    }

<span class="nc bnc" id="L3556" title="All 2 branches missed.">                    if (tables.size() == 0) {</span>
<span class="nc" id="L3557">                        curTable = null;</span>
                    } else {
<span class="nc" id="L3559">                        curTable = (HTMLTableModel) tables.lastElement();</span>
<span class="nc" id="L3560">                        tables.removeElement(curTable);</span>
                    }
<span class="nc" id="L3562">                    width = width * 2; // In fixed width mode we arbitrarily divide the size by a factor knowing that probably there are several cells - here we restore the size back</span>
<span class="nc bnc" id="L3563" title="All 2 branches missed.">                    if (width &gt; displayWidth) {</span>
<span class="nc" id="L3564">                        width = displayWidth;</span>
                    }
                    break;
                case HTMLElement.TAG_TR:
<span class="nc bnc" id="L3568" title="All 2 branches missed.">                    if (curTable != null) {</span>
<span class="nc" id="L3569">                        curTable.commitRow();</span>
                    }
                    break;
                case HTMLElement.TAG_TH:
                case HTMLElement.TAG_TD:
<span class="nc bnc" id="L3574" title="All 2 branches missed.">                    if (curTable != null) {</span>
<span class="nc" id="L3575">                        newLineIfNotEmpty(curAlign);</span>
<span class="nc" id="L3576">                        curContainer = (Container) tableCells.lastElement();</span>
<span class="nc" id="L3577">                        tableCells.removeElement(curContainer);</span>
                    }
                    break;
                case HTMLElement.TAG_LABEL:
<span class="nc" id="L3581">                    labelForID = null;</span>
<span class="nc" id="L3582">                    accesskey = '\0';</span>
<span class="nc" id="L3583">                    break;</span>

                // HTML 4 tags
                case HTMLElement.TAG_U:
                case HTMLElement.TAG_INS:
<span class="nc" id="L3588">                    underlineCount--;</span>
<span class="nc bnc" id="L3589" title="All 2 branches missed.">                    if (underlineCount == 0) {</span>
<span class="nc" id="L3590">                        textDecoration -= Style.TEXT_DECORATION_UNDERLINE;</span>
                    }
                    break;
                case HTMLElement.TAG_S:
                case HTMLElement.TAG_STRIKE:
                case HTMLElement.TAG_DEL:
<span class="nc" id="L3596">                    strikethruCount--;</span>
<span class="nc bnc" id="L3597" title="All 2 branches missed.">                    if (strikethruCount == 0) {</span>
<span class="nc" id="L3598">                        textDecoration -= Style.TEXT_DECORATION_STRIKETHRU;</span>
                    }

                    break;
                case HTMLElement.TAG_MAP:
<span class="nc bnc" id="L3603" title="All 2 branches missed.">                    if (curImageMap != null) {</span>
<span class="nc bnc" id="L3604" title="All 2 branches missed.">                        if (imageMapData == null) {</span>
<span class="nc" id="L3605">                            imageMapData = new Hashtable();</span>
                        }
<span class="nc" id="L3607">                        imageMapData.put(curImageMap.name, curImageMap);</span>
<span class="nc bnc" id="L3608" title="All 4 branches missed.">                        if ((imageMapComponents != null) &amp;&amp; (imageMapComponents.containsKey(curImageMap.name))) {</span>
<span class="nc" id="L3609">                            HTMLImageMap imageMap = (HTMLImageMap) imageMapComponents.get(curImageMap.name);</span>
<span class="nc" id="L3610">                            imageMap.mapData = curImageMap;</span>
                        }

<span class="nc" id="L3613">                        curImageMap = null;</span>
                    }

                    break;
                case HTMLElement.TAG_SUP:
<span class="nc" id="L3618">                    superscript--;</span>
<span class="nc" id="L3619">                    break;</span>
                case HTMLElement.TAG_SUB:
<span class="nc" id="L3621">                    superscript++;</span>
<span class="nc" id="L3622">                    break;</span>
                case HTMLElement.TAG_TBODY:
                case HTMLElement.TAG_THEAD:
                case HTMLElement.TAG_TFOOT:
<span class="nc bnc" id="L3626" title="All 2 branches missed.">                    if (curTable != null) {</span>
<span class="nc" id="L3627">                        curTable.endSegment();</span>
                    }
                    break;

            }

        }
<span class="nc" id="L3634">    }</span>

    /**
     * The following replaces the layout of the curLine container with the correct alignment, in non fixed width alignment is done by flowlayout's orientation.
     * In case the line is not empty, a new line will be opened by newLineIfNotEmpty below
     *
     * @param align    The general alignment of the element
     * @param curAlign The alignment of the specific component we want to
     */
    private void adjustAlignment(int align, int curAlign) {
<span class="nc bnc" id="L3644" title="All 2 branches missed.">        if ((!FIXED_WIDTH) &amp;&amp; (align != curAlign)) {</span>
<span class="nc bnc" id="L3645" title="All 2 branches missed.">            if (curLine.getComponentCount() == 0) {</span>
<span class="nc" id="L3646">                curLine.setLayout(new FlowLayout(curAlign));</span>
            }
        }
<span class="nc" id="L3649">    }</span>

    /**
     * Figures out what is the appropriate list type (i.e. which bullet types) for the unordered list in question
     *
     * @param element     The element containing the UL tag
     * @param defaultType The default list type
     * @return The UL list type
     */
    private int getUnorderedListType(HTMLElement element, int defaultType) {
<span class="nc" id="L3659">        String listTypeStr = element.getAttributeById(HTMLElement.ATTR_TYPE);</span>
<span class="nc" id="L3660">        int type = convertULString(listTypeStr);</span>
<span class="nc bnc" id="L3661" title="All 2 branches missed.">        if (type == -1) {</span>
<span class="nc" id="L3662">            type = defaultType;</span>
        }
<span class="nc" id="L3664">        return type;</span>
    }

    /**
     * Figures out the appropriate list type for the given Ordered List element according to its attributes
     * This calls the getOrderedListType(Element,int) with LIST_NUMERIC as the default type
     *
     * @param element The OL element
     * @return The OL list type
     */
    private int getOrderedListType(HTMLElement element) {
<span class="nc" id="L3675">        return getOrderedListType(element, HTMLListIndex.LIST_NUMERIC);</span>
    }

    /**
     * Figures out the appropriate list type for the given Ordered List element according to its attributes
     *
     * @param element         The OL element
     * @param defaultListType The default list type
     * @return The OL list type
     */
    private int getOrderedListType(HTMLElement element, int defaultListType) {
<span class="nc" id="L3686">        String listTypeStr = element.getAttributeById(HTMLElement.ATTR_TYPE);</span>
<span class="nc bnc" id="L3687" title="All 4 branches missed.">        if ((listTypeStr != null) &amp;&amp; (listTypeStr.length() &gt; 0)) {</span>
<span class="nc" id="L3688">            char c = listTypeStr.charAt(0);</span>
<span class="nc" id="L3689">            return getOrderedListType(c, defaultListType);</span>
        }
<span class="nc" id="L3691">        return defaultListType;</span>
    }

    /**
     * Figures out the appropriate list type for the given list type identifier
     *
     * @param c               The list identifier (one of ORDERED_LIST_TYPE_IDENTIFIERS)
     * @param defaultListType The default list type
     * @return The OL list type
     */
    private int getOrderedListType(char c, int defaultListType) {
<span class="nc bnc" id="L3702" title="All 2 branches missed.">        for (int j = 0; j &lt; ORDERED_LIST_TYPE_IDENTIFIERS.length; j++) {</span>
<span class="nc bnc" id="L3703" title="All 2 branches missed.">            if (c == ORDERED_LIST_TYPE_IDENTIFIERS[j]) {</span>
<span class="nc" id="L3704">                return j;</span>
            }
        }
<span class="nc" id="L3707">        return defaultListType;</span>
    }

    private void pushContainer(HTMLElement element) {
<span class="nc bnc" id="L3711" title="All 2 branches missed.">        if (loadCSS) {</span>
<span class="nc" id="L3712">            Container cont = new Container(new BoxLayout(BoxLayout.Y_AXIS));</span>
<span class="nc" id="L3713">            cont.setScrollableX(false);</span>
            //cont.getStyle().setBgColor(Element.COLOR_VALS[contCount]);
            //contCount=(contCount+1)%Element.COLOR_VALS.length; // debug for CSS
            //cont.getStyle().setBgTransparency(128);
<span class="nc" id="L3717">            cont.getStyle().setBgTransparency(0);</span>
<span class="nc" id="L3718">            element.setAssociatedComponents(cont);</span>
<span class="nc" id="L3719">            curContainer.addComponent(cont);</span>
<span class="nc" id="L3720">            containers.addElement(curContainer);</span>
<span class="nc" id="L3721">            curContainer = cont;</span>
        }
<span class="nc" id="L3723">    }</span>

    private void popContainer() {
<span class="nc bnc" id="L3726" title="All 2 branches missed.">        if (loadCSS) {</span>
<span class="nc" id="L3727">            Container prevContainer = (Container) containers.lastElement();</span>
<span class="nc" id="L3728">            curContainer = prevContainer;</span>
<span class="nc" id="L3729">            containers.removeElement(curContainer);</span>
        }
<span class="nc" id="L3731">    }</span>

    /**
     * Adds a quote according to the current quote count
     *
     * @param quoteElement The quote element (TAG_Q)
     * @param curAlign     The current horizontal alignment
     */
    private void addQuote(HTMLElement quoteElement, int curAlign, boolean isStartTag) {
<span class="nc" id="L3740">        String quote = null;</span>
<span class="nc bnc" id="L3741" title="All 2 branches missed.">        int quoteNum = isStartTag ? 0 : 1; // 0 is the start tag of primary tag and 1 its closing tag. 2 is the start of secondary tag and 3 the closing tag (Used for CSS_QUOTES)</span>
<span class="nc bnc" id="L3742" title="All 2 branches missed.">        if (quoteTagCount == 0) {</span>
<span class="nc" id="L3743">            quote = &quot;\&quot;&quot;;</span>
        } else {
<span class="nc" id="L3745">            quote = &quot;'&quot;;</span>
<span class="nc" id="L3746">            quoteNum += 2;</span>
        }
        if ((FIXED_WIDTH) &amp;&amp; (width - x &lt; font.stringWidth(quote))) {
            newLine(curAlign);
        }
<span class="nc" id="L3751">        Label quoteLabel = addString(quote, curAlign);</span>

<span class="nc" id="L3753">        quoteLabel.putClientProperty(CLIENT_PROPERTY_QUOTE, Integer.valueOf(quoteNum));</span>
<span class="nc bnc" id="L3754" title="All 2 branches missed.">        if (loadCSS) {</span>
<span class="nc" id="L3755">            quoteElement.addAssociatedComponent(quoteLabel);</span>
        }
<span class="nc" id="L3757">    }</span>

    /**
     * Converts a textual horizontal alignment description to a Codename One alignment constant
     *
     * @param alignment    The string describing the alignment
     * @param defaultAlign The default alignment if the string cannot be converted
     * @param allowJustify true to allow justify alignment, false to return center if justify is mentioned
     * @return Component.LEFT, RIGHT or CENTER or the defaultAlign in case no match was found.
     */
    private int getHorizAlign(String alignment, int defaultAlign, boolean allowJustify) {
<span class="nc bnc" id="L3768" title="All 2 branches missed.">        if (alignment != null) {</span>
<span class="nc bnc" id="L3769" title="All 2 branches missed.">            if (alignment.equals(&quot;left&quot;)) {</span>
<span class="nc" id="L3770">                return Component.LEFT;</span>
<span class="nc bnc" id="L3771" title="All 2 branches missed.">            } else if (alignment.equals(&quot;right&quot;)) {</span>
<span class="nc" id="L3772">                return Component.RIGHT;</span>
<span class="nc bnc" id="L3773" title="All 4 branches missed.">            } else if ((alignment.equals(&quot;center&quot;)) || (alignment.equals(&quot;middle&quot;))) {</span>
<span class="nc" id="L3774">                return Component.CENTER;</span>
<span class="nc bnc" id="L3775" title="All 2 branches missed.">            } else if (alignment.equals(&quot;justify&quot;)) {</span>
<span class="nc bnc" id="L3776" title="All 2 branches missed.">                return ((allowJustify) &amp;&amp; (FIXED_WIDTH)) ? JUSTIFY : Component.CENTER;</span>
            }
        }

<span class="nc" id="L3780">        return defaultAlign; //unknown alignment</span>

    }

    /**
     * Converts a textual vertical alignment description to a Codename One alignment constant
     *
     * @param alignment    The string describing the alignment
     * @param defaultAlign The default alignment if the string cannot be converted
     * @return Component.TOP, BOTTOM or CENTER or the defaultAlign in case no match was found.
     */
    private int getVertAlign(String alignment, int defaultAlign) {
<span class="nc bnc" id="L3792" title="All 2 branches missed.">        if (alignment != null) {</span>
<span class="nc bnc" id="L3793" title="All 2 branches missed.">            if (alignment.equals(&quot;top&quot;)) {</span>
<span class="nc" id="L3794">                return Component.TOP;</span>
<span class="nc bnc" id="L3795" title="All 2 branches missed.">            } else if (alignment.equals(&quot;bottom&quot;)) {</span>
<span class="nc" id="L3796">                return Component.BOTTOM;</span>
<span class="nc bnc" id="L3797" title="All 4 branches missed.">            } else if ((alignment.equals(&quot;center&quot;)) || (alignment.equals(&quot;middle&quot;))) {</span>
<span class="nc" id="L3798">                return Component.CENTER;</span>
            }
        }
<span class="nc" id="L3801">        return defaultAlign;</span>

    }

    /**
     * A convenience method to convert a string describing a percentage to an int.
     *
     * @param percent The string representing the percentage
     * @return The percentage integer value (i.e. 80% will return 80) or 0 if the string is not a percentage
     */
    private int getPercentage(String percent) {
<span class="nc bnc" id="L3812" title="All 4 branches missed.">        if ((percent == null) || (!percent.endsWith(&quot;%&quot;))) {</span>
<span class="nc" id="L3813">            return 0;</span>
        }
<span class="nc" id="L3815">        return getInt(percent.substring(0, percent.length() - 1));</span>

    }

    /**
     * Returns the input fields of this HTMLComponent, used by the FOR label mecahnism.
     *
     * @return the input fields of this HTMLComponent
     */
    Hashtable getInputFields() {
<span class="nc" id="L3825">        return inputFields;</span>
    }

    /**
     * Focuses on the given component and if it's a checkbox/radiobutton selects it
     * This is used both for ForLabels and for access keys
     *
     * @param cmp The component to focus and select
     */
    void selectComponent(Component cmp) {
<span class="nc" id="L3835">        getComponentForm().setFocused(cmp);</span>
<span class="nc" id="L3836">        getComponentForm().scrollComponentToVisible(cmp);</span>
<span class="nc bnc" id="L3837" title="All 2 branches missed.">        if (cmp instanceof RadioButton) {</span>
<span class="nc" id="L3838">            ((RadioButton) cmp).setSelected(true);</span>
<span class="nc bnc" id="L3839" title="All 2 branches missed.">        } else if (cmp instanceof CheckBox) {</span>
<span class="nc" id="L3840">            CheckBox cb = ((CheckBox) cmp);</span>
<span class="nc bnc" id="L3841" title="All 2 branches missed.">            cb.setSelected(!cb.isSelected());</span>
        }
<span class="nc" id="L3843">    }</span>

    /**
     * Converts the given URL to an absolute URL based on the current page's URL
     *
     * @param url The url to convert (Can be relative)
     * @return The absolute URL representing the given URL in relation to the current one.
     */
    String convertURL(String url) {
<span class="nc bnc" id="L3852" title="All 2 branches missed.">        if (docInfo != null) {</span>
<span class="nc" id="L3853">            return docInfo.convertURL(url);</span>
        } else {
<span class="nc" id="L3855">            return url; // No conversion is possible if we don't have a DocumentInfo object (in cases of setBody from a string and not from a document address), absolute URLs should have no problem, and as for relative the RequestHandler will have to handle these cases</span>
        }
    }

    /**
     * Jumps to the given anchor
     *
     * @param anchorName The anchor to jump to
     */
    void goToAnchor(String anchorName) {
<span class="nc" id="L3865">        Label anchorCmp = (Label) anchors.get(anchorName);</span>
<span class="nc bnc" id="L3866" title="All 2 branches missed.">        if (anchorCmp != null) {</span>
<span class="nc" id="L3867">            int cx = anchorCmp.getX();</span>
<span class="nc" id="L3868">            int cy = anchorCmp.getY();</span>
<span class="nc" id="L3869">            int h = getHeight();</span>
<span class="nc bnc" id="L3870" title="All 2 branches missed.">            if (anchorCmp.getAbsoluteY() - getY() + h &gt; getPreferredH()) {</span>
<span class="nc" id="L3871">                h = getPreferredH() - (anchorCmp.getAbsoluteY() - getY());</span>
            }
<span class="nc" id="L3873">            scrollRectToVisible(cx, cy, getWidth(), h, anchorCmp);</span>
        }
<span class="nc" id="L3875">    }</span>

    /**
     * {{@inheritDoc}}
     */
    public void layoutContainer() {
        if ((FIXED_WIDTH) &amp;&amp; (displayWidth != 0) &amp;&amp; (Display.getInstance().getDisplayWidth() != displayWidth)) {
            Display.getInstance().startThread(new Runnable() {
                public void run() {
                    cleanup();
                    rebuildPage(); //screen form factor changed - landscape/portrait
                }
            }, &quot;HTML layout&quot;).start();
        }
<span class="nc" id="L3889">        super.layoutContainer();</span>
<span class="nc" id="L3890">    }</span>

    /**
     * {{@inheritDoc}}
     */
    public void actionPerformed(ActionEvent evt) {
<span class="nc bnc" id="L3896" title="All 2 branches missed.">        if (getComponentForm().getFocused() instanceof TextField) {</span>
<span class="nc" id="L3897">            return;</span>
        }
<span class="nc" id="L3899">        int keyCode = evt.getKeyEvent();</span>
<span class="nc" id="L3900">        Object obj = accessKeys.get(Integer.valueOf(keyCode));</span>
<span class="nc bnc" id="L3901" title="All 2 branches missed.">        if (obj != null) {</span>
<span class="nc bnc" id="L3902" title="All 2 branches missed.">            if (obj instanceof HTMLLink) {</span>
<span class="nc" id="L3903">                HTMLLink htmlLink = (HTMLLink) obj;</span>
<span class="nc" id="L3904">                htmlLink.actionPerformed(null);</span>
<span class="nc bnc" id="L3905" title="All 2 branches missed.">            } else if (obj instanceof ForLabel) {</span>
<span class="nc" id="L3906">                ((ForLabel) obj).triggerAction();</span>
<span class="nc bnc" id="L3907" title="All 2 branches missed.">            } else if (obj instanceof Component) {</span>
<span class="nc" id="L3908">                selectComponent((Component) obj);</span>
            }
        }
<span class="nc" id="L3911">    }</span>


    ///////////////////
    // Methods relevant to CSS2 only (not WCSS)
    ///////////////////

    ResourceThreadQueue getThreadQueue() {
<span class="nc" id="L3919">        return threadQueue;</span>
    }

    /**
     * {@inheritDoc}
     */
    public String[] getPropertyNames() {
<span class="nc" id="L3926">        return new String[]{&quot;url&quot;, &quot;body&quot;, &quot;pageUIID&quot;};</span>
    }

    /**
     * {@inheritDoc}
     */
    public Class[] getPropertyTypes() {
<span class="nc" id="L3933">        return new Class[]{String.class, String.class, String.class};</span>
    }

    /**
     * {@inheritDoc}
     */
    public Object getPropertyValue(String name) {
<span class="nc bnc" id="L3940" title="All 2 branches missed.">        if (name.equals(&quot;url&quot;)) {</span>
<span class="nc" id="L3941">            return pageURL;</span>
        }
<span class="nc bnc" id="L3943" title="All 2 branches missed.">        if (name.equals(&quot;body&quot;)) {</span>
<span class="nc" id="L3944">            return htmlBody;</span>
        }
<span class="nc bnc" id="L3946" title="All 2 branches missed.">        if (name.equals(&quot;pageUIID&quot;)) {</span>
<span class="nc" id="L3947">            return pageUIID;</span>
        }
<span class="nc" id="L3949">        return null;</span>
    }

    /*********
     * HTMLComponent inner classes
     *********/

    /**
     * {@inheritDoc}
     */
    public String setPropertyValue(String name, Object value) {
<span class="nc bnc" id="L3960" title="All 2 branches missed.">        if (name.equals(&quot;url&quot;)) {</span>
<span class="nc" id="L3961">            setPage((String) value);</span>
<span class="nc" id="L3962">            return null;</span>
        }
<span class="nc bnc" id="L3964" title="All 2 branches missed.">        if (name.equals(&quot;body&quot;)) {</span>
<span class="nc" id="L3965">            htmlBody = (String) value;</span>
<span class="nc bnc" id="L3966" title="All 4 branches missed.">            if (htmlBody != null &amp;&amp; htmlBody.length() &gt; 0) {</span>
<span class="nc" id="L3967">                setHTML(htmlBody, &quot;UTF-8&quot;, null, true);</span>
            }
<span class="nc" id="L3969">            return null;</span>
        }
<span class="nc bnc" id="L3971" title="All 2 branches missed.">        if (name.equals(&quot;pageUIID&quot;)) {</span>
<span class="nc" id="L3972">            pageUIID = (String) value;</span>
<span class="nc bnc" id="L3973" title="All 4 branches missed.">            if ((mainContainer != null) &amp;&amp; (pageUIID != null)) {</span>
<span class="nc" id="L3974">                mainContainer.setUIID(pageUIID);</span>
            }
<span class="nc" id="L3976">            return null;</span>
        }

<span class="nc" id="L3979">        return super.setPropertyValue(name, value);</span>
    }

    /**
     * Increments or resets the specified counter (This is CSS related, but since CSSEngine has no class members for storage, we keep control of it here)
     *
     * @param counterStr The counter-increment/reset property value which is the string counter name followed optionally by the factor by which to increment or the value to reset to
     * @param reset      true to reset, false to increment
     */
    void incCounter(String counterStr, boolean reset) {
<span class="nc" id="L3989">        counterStr = counterStr.trim();</span>
<span class="nc bnc" id="L3990" title="All 2 branches missed.">        int value = reset ? 0 : 1; // 0 is the default value to reset to, while 1 is the default increment step</span>
<span class="nc" id="L3991">        Vector v = getWords(counterStr, Component.LEFT, false); // align is LEFT but just as a place holder, it doesn't really have any effect</span>
<span class="nc bnc" id="L3992" title="All 2 branches missed.">        if (v.size() == 0) {</span>
<span class="nc" id="L3993">            return;</span>
        }
<span class="nc" id="L3995">        counterStr = (String) v.elementAt(0);</span>
<span class="nc bnc" id="L3996" title="All 2 branches missed.">        if (v.size() &gt; 1) {</span>
            try {
<span class="nc" id="L3998">                value = Integer.parseInt((String) v.elementAt(1));</span>
<span class="nc" id="L3999">            } catch (NumberFormatException nfe) {</span>
                // ignore - use default values
<span class="nc" id="L4001">            }</span>
        }

<span class="nc bnc" id="L4004" title="All 2 branches missed.">        if (counters == null) {</span>
<span class="nc" id="L4005">            counters = new Hashtable();</span>
        }
<span class="nc bnc" id="L4007" title="All 2 branches missed.">        if (reset) {</span>
<span class="nc" id="L4008">            counters.put(counterStr, Integer.valueOf(value));</span>
        } else {
<span class="nc" id="L4010">            int curValue = 0;</span>
<span class="nc" id="L4011">            Object obj = counters.get(counterStr);</span>
<span class="nc bnc" id="L4012" title="All 2 branches missed.">            if (obj != null) {</span>
<span class="nc" id="L4013">                curValue = ((Integer) obj).intValue();</span>
            }
<span class="nc" id="L4015">            counters.put(counterStr, Integer.valueOf(value + curValue));</span>
        }
<span class="nc" id="L4017">    }</span>

    /**
     * Return the value of the sperecified counter
     *
     * @param counterName The counter name
     * @return the value of this counter (or 0 if it does not exist)
     */
    int getCounterValue(String counterName) {
<span class="nc bnc" id="L4026" title="All 2 branches missed.">        if (counters == null) {</span>
<span class="nc" id="L4027">            return 0;</span>
        }
<span class="nc" id="L4029">        Object obj = counters.get(counterName);</span>
<span class="nc bnc" id="L4030" title="All 2 branches missed.">        return obj == null ? 0 : ((Integer) obj).intValue();</span>
    }

    /**
     * @return the supressExceptions
     */
    public boolean isSupressExceptions() {
<span class="nc" id="L4037">        return supressExceptions;</span>
    }

    /**
     * @param supressExceptions the supressExceptions to set
     */
    public void setSupressExceptions(boolean supressExceptions) {
<span class="nc" id="L4044">        this.supressExceptions = supressExceptions;</span>
<span class="nc" id="L4045">    }</span>

    /**
     * A thread used to refresh or redirect to another page in X seconds
     *
     * @author Ofir Leitner
     */
    class RedirectThread implements Runnable {

        int seconds;
        String url;
        HTMLComponent htmlC;
        boolean cancelled;

<span class="nc" id="L4059">        public RedirectThread(HTMLComponent htmlC, int seconds, String url) {</span>
<span class="nc" id="L4060">            this.seconds = seconds;</span>
<span class="nc" id="L4061">            this.url = url;</span>
<span class="nc" id="L4062">            this.htmlC = htmlC;</span>
<span class="nc" id="L4063">        }</span>

        public void run() {
            try {
<span class="nc" id="L4067">                Thread.sleep(seconds * 1000L);</span>
<span class="nc" id="L4068">            } catch (InterruptedException ie) {</span>
<span class="nc" id="L4069">                System.out.println(&quot;Warning: Redirect/Refresh thread sleep interrupted, page may refresh sooner than expected.&quot;);</span>
<span class="nc" id="L4070">            }</span>
<span class="nc bnc" id="L4071" title="All 2 branches missed.">            if (!cancelled) {</span>
<span class="nc bnc" id="L4072" title="All 2 branches missed.">                boolean redirect = (url != null);</span>
<span class="nc" id="L4073">                url = htmlC.convertURL(url);</span>
<span class="nc bnc" id="L4074" title="All 2 branches missed.">                if (redirect) {</span>
<span class="nc" id="L4075">                    htmlC.setPageStatus(HTMLCallback.STATUS_REDIRECTED);</span>
                }

<span class="nc" id="L4078">                htmlC.setPage(url);</span>
            }
<span class="nc" id="L4080">        }</span>

        public void cancel() {
<span class="nc" id="L4083">            cancelled = true;</span>
<span class="nc" id="L4084">        }</span>

    }

    /**
     * A label that when clicked focuses (and toggels when applicable) a certain input field.
     * This implements the LABEL html tag
     *
     * @author Ofir Leitner
     */
    class ForLabel extends Label {

        String id;
        HTMLComponent htmlC;

<span class="nc" id="L4099">        ForLabel(String labelText, HTMLComponent htmlC, String id) {</span>
<span class="nc" id="L4100">            super(labelText);</span>
<span class="nc" id="L4101">            this.id = id;</span>
<span class="nc" id="L4102">            this.htmlC = htmlC;</span>
<span class="nc" id="L4103">        }</span>

        /**
         * {{@inheritDoc}}
         */
        public void pointerReleased(int x, int y) {
<span class="nc" id="L4109">            triggerAction();</span>
<span class="nc" id="L4110">            super.pointerReleased(x, y);</span>
<span class="nc" id="L4111">        }</span>

        /**
         * Triggers the needed action for this ForLabel
         */
        void triggerAction() {
<span class="nc" id="L4117">            Component cmp = (Component) htmlC.getInputFields().get(id);</span>
<span class="nc bnc" id="L4118" title="All 2 branches missed.">            if (cmp != null) {</span>
<span class="nc" id="L4119">                htmlC.selectComponent(cmp);</span>
            }
<span class="nc" id="L4121">        }</span>
    }

    class HTMLListIndex extends HTMLListItem {

        /**
         * Numeric ordered list type (1 ,2, 3)
         */
        static final int LIST_NUMERIC = 0;
        /**
         * Uppercase ordered list type (A, B, C)
         */
        private static final int LIST_UPPERCASE = 1;
        /**
         * Lowercase ordered list type (a, b, c)
         */
        private static final int LIST_LOWERCASE = 2;
        /**
         * Roman numerals uppercase ordered list type (I,II,III,IV,V ......)
         */
        private static final int LIST_ROMAN_UPPER = 3;
        /**
         * Roman numerals lowercase ordered list type (i, ii, iii, iv, v ...)
         */
        private static final int LIST_ROMAN_LOWER = 4;
        /**
         * A list with no numbers at all - can be triggered with CSS
         */
        private static final int LIST_NONE = 5;
        int index;
        int listType;

<span class="nc" id="L4153">        public HTMLListIndex(int index, int listType) {</span>
<span class="nc" id="L4154">            this.index = index;</span>
<span class="nc" id="L4155">            this.listType = listType;</span>
<span class="nc" id="L4156">            setText(getListIndexString(index, listType));</span>
<span class="nc" id="L4157">            getStyle().setMargin(0, 0, 0, 0);</span>
<span class="nc" id="L4158">            getStyle().setPadding(0, 0, 0, 0);</span>
<span class="nc" id="L4159">            getUnselectedStyle().setBgTransparency(0);</span>

<span class="nc" id="L4161">        }</span>

        /**
         * Returns a list index text according to the list type
         *
         * @param index The list index
         * @param type  The list type
         * @return The index converted according to the list style
         */
        private String getListIndexString(int index, int type) {
<span class="nc bnc" id="L4171" title="All 2 branches missed.">            if (index &lt;= 0) {</span>
<span class="nc" id="L4172">                return index + &quot;. &quot;;</span>
            }
<span class="nc bnc" id="L4174" title="All 6 branches missed.">            switch (type) {</span>
                case LIST_NUMERIC:
<span class="nc" id="L4176">                    return index + &quot;. &quot;;</span>
                case LIST_UPPERCASE:
<span class="nc" id="L4178">                    return getLiteral(index, 'A');</span>
                case LIST_LOWERCASE:
<span class="nc" id="L4180">                    return getLiteral(index, 'a');</span>
                case LIST_ROMAN_UPPER:
<span class="nc" id="L4182">                    return getRomanIndexString(index);</span>
                case LIST_ROMAN_LOWER:
<span class="nc" id="L4184">                    return getRomanIndexString(index).toLowerCase();</span>
            }
<span class="nc" id="L4186">            return &quot;    &quot;; //In case of &quot;none&quot; - To keep indentation</span>
        }

        String getLiteral(int index, char baseChar) {
<span class="nc" id="L4190">            String literal = &quot;&quot;;</span>
<span class="nc bnc" id="L4191" title="All 2 branches missed.">            while (index &gt; 0) {</span>
<span class="nc" id="L4192">                literal = (char) ((index % 26) + baseChar - 1) + literal;</span>
<span class="nc" id="L4193">                index = index / 26;</span>
            }

<span class="nc" id="L4196">            return literal + &quot;. &quot;;</span>
        }

        /**
         * Converts a number to a roman numeral (Up to 99, should suffice for HTML lists...)
         *
         * @param index The list index to convert
         * @return A roman numeral representing the given index
         */
        private String getRomanIndexString(int index) {
<span class="nc" id="L4206">            index = index % 100;</span>
<span class="nc" id="L4207">            return ROMAN_NUMERALS_TENS[index / 10] + ROMAN_NUMERALS_ONES[index % 10] + &quot;. &quot;;</span>
        }

        public void setStyleType(int type) {
<span class="nc bnc" id="L4211" title="All 2 branches missed.">            if (type != -1) {</span>
<span class="nc" id="L4212">                listType = type - 4;</span>
<span class="nc bnc" id="L4213" title="All 2 branches missed.">                if (listType &lt; 0) {</span>
<span class="nc" id="L4214">                    listType = 5; //LIST_NONE</span>
                }
<span class="nc" id="L4216">                setText(getListIndexString(index, listType));</span>
<span class="nc" id="L4217">                repaint();</span>
            }
<span class="nc" id="L4219">        }</span>

        public void setImage(String imageUrl) {
            // do nothing, has no meaning for ordered lists
<span class="nc" id="L4223">        }</span>

    }

    /**
     * A simple class drawing a bullet in various styles
     *
     * @author Ofir Leitner
     */
    class HTMLBullet extends HTMLListItem {


        // Unordered list types

        /**
         * Indicates no bullet should be displayed
         */
        private static final int BULLET_NONE = 0;

        /**
         * Indicates the disc style (full circle) for an unordered list
         */
        private static final int BULLET_DISC = 1;

        /**
         * Indicates the circle (empty circle) style for an unordered list
         */
        private static final int BULLET_CIRCLE = 2;

        /**
         * Indicates the square (full square) style for an unordered list
         */
        private static final int BULLET_SQUARE = 3;

        int level;
        int fontHeight;
        int color;
        HTMLComponent htmlC;

<span class="nc" id="L4262">        public HTMLBullet(int level, int fontHeight, int color, HTMLComponent htmlC) {</span>
<span class="nc" id="L4263">            this.level = level;</span>
<span class="nc" id="L4264">            this.fontHeight = fontHeight;</span>
<span class="nc" id="L4265">            this.color = color;</span>
<span class="nc" id="L4266">            this.htmlC = htmlC;</span>
<span class="nc" id="L4267">            getStyle().setBgTransparency(0);</span>
<span class="nc" id="L4268">            setFocusable(false);</span>
<span class="nc" id="L4269">        }</span>

        public void setStyleType(int type) {
<span class="nc bnc" id="L4272" title="All 2 branches missed.">            if (type != -1) {</span>
<span class="nc" id="L4273">                level = type;</span>
<span class="nc" id="L4274">                setShouldCalcPreferredSize(true);</span>
<span class="nc" id="L4275">                repaint();</span>
            }
<span class="nc" id="L4277">        }</span>

        public void setImage(String imageUrl) {
<span class="nc bnc" id="L4280" title="All 2 branches missed.">            if (imageUrl != null) {</span>
                //setText(&quot; &quot;); // Due to a Codename One bug Labels with an icon only and no text can be cut
<span class="nc" id="L4282">                htmlC.getThreadQueue().add(this, htmlC.convertURL(imageUrl));</span>
            }
<span class="nc" id="L4284">        }</span>

        /**
         * {{@inheritDoc}}
         */
        public void paint(Graphics g) {
<span class="nc bnc" id="L4290" title="All 2 branches missed.">            if (getIcon() != null) {</span>
<span class="nc" id="L4291">                super.paint(g);</span>
<span class="nc" id="L4292">                return;</span>
            }
<span class="nc" id="L4294">            int size = fontHeight / 3;</span>
<span class="nc" id="L4295">            g.setColor(color);</span>
<span class="nc bnc" id="L4296" title="All 2 branches missed.">            if (level == BULLET_DISC) { // Filled circle</span>
<span class="nc" id="L4297">                size += 2;</span>
<span class="nc" id="L4298">                g.fillArc(getX() + (getWidth() - size) / 2, getY() + (getHeight() - size) / 2, size, size, 0, 360);</span>
<span class="nc bnc" id="L4299" title="All 2 branches missed.">            } else if (level == BULLET_CIRCLE) { // Empty circle</span>
<span class="nc" id="L4300">                g.drawArc(getX() + (getWidth() - size) / 2, getY() + (getHeight() - size) / 2, size, size, 0, 360);</span>
<span class="nc bnc" id="L4301" title="All 2 branches missed.">            } else if (level == BULLET_SQUARE) { // Filled square</span>
<span class="nc" id="L4302">                g.fillRect(getX() + (getWidth() - size) / 2, getY() + (getHeight() - size) / 2, size, size);</span>
            }
<span class="nc" id="L4304">        }</span>

        /**
         * {{@inheritDoc}}
         */
        protected Dimension calcPreferredSize() {
<span class="nc bnc" id="L4310" title="All 2 branches missed.">            if (getIcon() != null) {</span>
<span class="nc" id="L4311">                return super.calcPreferredSize();</span>
            }
<span class="nc bnc" id="L4313" title="All 2 branches missed.">            if (level == BULLET_NONE) {</span>
<span class="nc" id="L4314">                return new Dimension(0, fontHeight);</span>
            } else {
<span class="nc" id="L4316">                return new Dimension(fontHeight, fontHeight);</span>
            }
        }

    }

    /**
     * HTMLComboBox overrides ComboBox to allow usage of MultiComboBox as its list.
     * This is done for OPTGROUP labels support (Note that multiple features of MultiComboBox will be switched off)
     *
     * @author Ofir Leitner
     */
<span class="nc" id="L4328">    class HTMLComboBox extends ComboBox {</span>

        /**
         * {{@inheritDoc}}
         */
        protected List createPopupList() {
<span class="nc" id="L4334">            List l = new MultiComboBox(getModel(), false);</span>
<span class="nc" id="L4335">            l.setSmoothScrolling(isSmoothScrolling());</span>
<span class="nc" id="L4336">            l.setFixedSelection(getFixedSelection());</span>
<span class="nc" id="L4337">            l.setItemGap(getItemGap());</span>
<span class="nc" id="L4338">            l.setUIID(&quot;ComboBoxList&quot;);</span>
<span class="nc" id="L4339">            return l;</span>
        }

    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>