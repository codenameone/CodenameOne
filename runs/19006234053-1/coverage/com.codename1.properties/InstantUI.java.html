<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InstantUI.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">codenameone-core-unittests</a> &gt; <a href="index.source.html" class="el_package">com.codename1.properties</a> &gt; <span class="el_source">InstantUI.java</span></div><h1>InstantUI.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2012, Codename One and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Codename One designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Codename One through http://www.codenameone.com/ if you
 * need additional information or have any questions.
 */

package com.codename1.properties;

import com.codename1.io.Log;
import com.codename1.ui.ButtonGroup;
import com.codename1.ui.CheckBox;
import com.codename1.ui.Component;
import com.codename1.ui.Container;
import com.codename1.ui.Display;
import com.codename1.ui.RadioButton;
import com.codename1.ui.TextArea;
import com.codename1.ui.TextField;
import com.codename1.ui.layouts.BoxLayout;
import com.codename1.ui.layouts.GridLayout;
import com.codename1.ui.spinner.Picker;
import com.codename1.ui.table.TableLayout;

import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;

/**
 * Instant UI generates a user interface for editing a property business object based on common
 * conventions and settings within the properties. UI's are automatically bound and work seamlessly.
 * &lt;strong&gt;Important&lt;/strong&gt;: These UI's are subject to change, e.g. a generated UI might not have
 * validation for a specific property in one build and might introduce it in an update. We try to generate
 * great UI's seamlessly and some improvements might break functionality.
 *
 * @author Shai Almog
 */
<span class="nc" id="L54">public class InstantUI {</span>
    private PropertyBase[] order;

    /**
     * Excludes the property from the generated UI
     *
     * @param exclude the property to exclude
     */
    public void excludeProperty(PropertyBase exclude) {
<span class="nc" id="L63">        exclude.putClientProperty(&quot;cn1$excludeFromUI&quot;, Boolean.TRUE);</span>
<span class="nc" id="L64">    }</span>

    /**
     * Excludes the properties from the generated UI
     *
     * @param exclude the properties to exclude
     */
    public void excludeProperties(PropertyBase... exclude) {
<span class="nc bnc" id="L72" title="All 2 branches missed.">        for (PropertyBase p : exclude) {</span>
<span class="nc" id="L73">            p.putClientProperty(&quot;cn1$excludeFromUI&quot;, Boolean.TRUE);</span>
        }
<span class="nc" id="L75">    }</span>

    /**
     * Returns true if the property was excluded from the GUI
     *
     * @param exclude the property
     * @return true if the property was excluded from the GUI
     */
    public boolean isExcludedProperty(PropertyBase exclude) {
<span class="nc bnc" id="L84" title="All 2 branches missed.">        return exclude.getClientProperty(&quot;cn1$excludeFromUI&quot;) == Boolean.TRUE;</span>
    }

    /**
     * A property that's a multi-choice can use this API to define the options used e.g.:
     * {@code
     * iui.setMultiChoiceLabels(c.gender, &quot;Male&quot;, &quot;Female&quot;, &quot;Undefined&quot;);
     * iui.setMultiChoiceValues(c.gender, &quot;M&quot;, &quot;F&quot;, &quot;U&quot;);
     * }
     *
     * @param p      the property
     * @param labels label for each option
     */
    public void setMultiChoiceLabels(PropertyBase p, String... labels) {
<span class="nc" id="L98">        p.putClientProperty(&quot;cn1$multiChceLbl&quot;, labels);</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">        if (p.getClientProperty(&quot;cn1$multiChceVal&quot;) == null) {</span>
<span class="nc" id="L100">            p.putClientProperty(&quot;cn1$multiChceVal&quot;, labels);</span>
        }
<span class="nc" id="L102">    }</span>

    /**
     * A property that's a multi-choice can use this API to define the options used, notice that
     * this API won't work correctly without {@link #setMultiChoiceLabels(com.codename1.properties.PropertyBase, java.lang.String...)}
     *
     * @param p      the property
     * @param values actual values used for each label
     */
    public void setMultiChoiceValues(PropertyBase p, Object... values) {
<span class="nc" id="L112">        p.putClientProperty(&quot;cn1$multiChceVal&quot;, values);</span>
<span class="nc" id="L113">    }</span>

    /**
     * The component class used to map this property
     *
     * @param p      the property
     * @param cmpCls class of the component e.g. {@code Button.class}
     */
    public void setComponentClass(PropertyBase p, Class cmpCls) {
<span class="nc" id="L122">        p.putClientProperty(&quot;cn1$cmpCls&quot;, cmpCls);</span>
<span class="nc" id="L123">    }</span>

    /**
     * Sets the text field constraint for the property explicitly, notice that some constraints
     * are implicit unless set manually e.g. numeric for numbers or password for fields with password
     * in the name
     *
     * @param p    the property
     * @param cons the text field constraint
     */
    public void setTextFieldConstraint(PropertyBase p, int cons) {
<span class="nc" id="L134">        p.putClientProperty(&quot;cn1$tconstraint&quot;, cons);</span>
<span class="nc" id="L135">    }</span>

    /**
     * The text field constraint for the property. notice that some constraints
     * are implicit unless set manually e.g. numeric for numbers or password for fields with password
     * in the name
     *
     * @param p the property
     * @return the constraint matching this property
     */
    public int getTextFieldConstraint(PropertyBase p) {
<span class="nc" id="L146">        Integer v = (Integer) p.getClientProperty(&quot;cn1$tconstraint&quot;);</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (v != null) {</span>
<span class="nc" id="L148">            return v;</span>
        }

<span class="nc" id="L151">        Class t = p.getGenericType();</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">        if (t != null) {</span>
<span class="nc bnc" id="L153" title="All 8 branches missed.">            if (t == Integer.class || t == Long.class || t == Short.class || t == Byte.class) {</span>
<span class="nc" id="L154">                return TextArea.NUMERIC;</span>
            }
<span class="nc bnc" id="L156" title="All 4 branches missed.">            if (t == Double.class || t == Float.class) {</span>
<span class="nc" id="L157">                return TextArea.DECIMAL;</span>
            }
        }
<span class="nc" id="L160">        String n = p.getName().toLowerCase();</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (n.indexOf(&quot;password&quot;) &gt; -1) {</span>
<span class="nc" id="L162">            return TextArea.PASSWORD;</span>
        }
<span class="nc bnc" id="L164" title="All 6 branches missed.">        if (n.indexOf(&quot;url&quot;) &gt; -1 || n.indexOf(&quot;website&quot;) &gt; -1 || n.indexOf(&quot;blog&quot;) &gt; -1) {</span>
<span class="nc" id="L165">            return TextArea.URL;</span>
        }
<span class="nc bnc" id="L167" title="All 2 branches missed.">        if (n.indexOf(&quot;email&quot;) &gt; -1) {</span>
<span class="nc" id="L168">            return TextArea.EMAILADDR;</span>
        }
<span class="nc bnc" id="L170" title="All 4 branches missed.">        if (n.indexOf(&quot;phone&quot;) &gt; -1 || n.indexOf(&quot;mobile&quot;) &gt; -1) {</span>
<span class="nc" id="L171">            return TextArea.PHONENUMBER;</span>
        }
<span class="nc" id="L173">        return TextArea.ANY;</span>
    }

    /**
     * Returns the order of the properties or null if they should use their
     * natural order as they were submitted to the index object
     *
     * @return the property order
     */
    public PropertyBase[] getOrder() {
<span class="nc" id="L183">        return order;</span>
    }

    /**
     * Sets the order of the properties, notice that this can also replace exclude
     *
     * @param order the order of the properties
     */
    public void setOrder(PropertyBase... order) {
<span class="nc" id="L192">        this.order = order;</span>
<span class="nc" id="L193">    }</span>

    /**
     * Creates editing UI for the given business object
     *
     * @param bo         the business object
     * @param autoCommit true if the bindings used should be auto-committed
     * @return a UI container that can be used to edit the business object
     */
    public Container createEditUI(PropertyBusinessObject bo, boolean autoCommit) {
        Container cnt;
<span class="nc bnc" id="L204" title="All 2 branches missed.">        if (Display.getInstance().isTablet()) {</span>
<span class="nc" id="L205">            TableLayout tl = new TableLayout(1, 2);</span>
<span class="nc" id="L206">            tl.setGrowHorizontally(true);</span>
<span class="nc" id="L207">            cnt = new Container(tl);</span>
<span class="nc" id="L208">        } else {</span>
<span class="nc" id="L209">            cnt = new Container(BoxLayout.y());</span>
        }
<span class="nc" id="L211">        UiBinding uib = new UiBinding();</span>
<span class="nc" id="L212">        ArrayList&lt;UiBinding.Binding&gt; allBindings = new ArrayList&lt;UiBinding.Binding&gt;();</span>
<span class="nc bnc" id="L213" title="All 4 branches missed.">        if (order != null &amp;&amp; order.length &gt; 0) {</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">            for (PropertyBase b : order) {</span>
<span class="nc" id="L215">                createEntryForProperty(b, cnt, allBindings, uib);</span>
            }
        } else {
<span class="nc bnc" id="L218" title="All 2 branches missed.">            for (PropertyBase b : bo.getPropertyIndex()) {</span>
<span class="nc" id="L219">                createEntryForProperty(b, cnt, allBindings, uib);</span>
<span class="nc" id="L220">            }</span>
        }

<span class="nc" id="L223">        cnt.putClientProperty(&quot;cn1$iui-binding&quot;, uib.createGroupBinding(allBindings));</span>
<span class="nc" id="L224">        return cnt;</span>
    }

    private void createEntryForProperty(PropertyBase b, Container cnt,
                                        ArrayList&lt;UiBinding.Binding&gt; allBindings, UiBinding uib) throws
            RuntimeException {
<span class="nc bnc" id="L230" title="All 2 branches missed.">        if (isExcludedProperty(b)) {</span>
<span class="nc" id="L231">            return;</span>
        }
<span class="nc" id="L233">        Class cls = (Class) b.getClientProperty(&quot;cn1$cmpCls&quot;);</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">        if (cls != null) {</span>
            try {
<span class="nc" id="L236">                Component cmp = (Component) cls.newInstance();</span>
<span class="nc" id="L237">                cmp.setName(b.getName());</span>
<span class="nc" id="L238">                cnt.add(b.getLabel()).</span>
<span class="nc" id="L239">                        add(cmp);</span>
<span class="nc" id="L240">                allBindings.add(uib.bind(b, cmp));</span>
<span class="nc" id="L241">            } catch (Exception err) {</span>
<span class="nc" id="L242">                Log.e(err);</span>
<span class="nc" id="L243">                throw new RuntimeException(&quot;Custom property instant UI failed for &quot; + b.getName() + &quot; &quot; + err);</span>
<span class="nc" id="L244">            }</span>
<span class="nc" id="L245">            return;</span>
        }
<span class="nc" id="L247">        String[] multiLabels = (String[]) b.getClientProperty(&quot;cn1$multiChceLbl&quot;);</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">        if (multiLabels != null) {</span>
            // multi choice component
<span class="nc" id="L250">            final Object[] multiValues = (Object[]) b.getClientProperty(&quot;cn1$multiChceVal&quot;);</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">            if (multiLabels.length &lt; 5) {</span>
                // toggle buttons
<span class="nc" id="L253">                ButtonGroup bg = new ButtonGroup();</span>
<span class="nc" id="L254">                RadioButton[] rbs = new RadioButton[multiLabels.length];</span>
<span class="nc" id="L255">                cnt.add(b.getLabel());</span>
<span class="nc" id="L256">                Container radioBox = new Container(new GridLayout(multiLabels.length));</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">                for (int iter = 0; iter &lt; multiLabels.length; iter++) {</span>
<span class="nc" id="L258">                    rbs[iter] = RadioButton.createToggle(multiLabels[iter], bg);</span>
<span class="nc" id="L259">                    radioBox.add(rbs[iter]);</span>
                }
<span class="nc" id="L261">                cnt.add(radioBox);</span>
<span class="nc" id="L262">                allBindings.add(uib.bindGroup(b, multiValues, rbs));</span>
<span class="nc" id="L263">            } else {</span>
<span class="nc" id="L264">                Picker stringPicker = new Picker();</span>
<span class="nc" id="L265">                stringPicker.setStrings(multiLabels);</span>
<span class="nc" id="L266">                Map&lt;Object, Object&gt; m1 = new HashMap&lt;Object, Object&gt;();</span>
<span class="nc" id="L267">                Map&lt;Object, Object&gt; m2 = new HashMap&lt;Object, Object&gt;();</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">                for (int iter = 0; iter &lt; multiLabels.length; iter++) {</span>
<span class="nc" id="L269">                    m1.put(multiLabels[iter], multiValues[iter]);</span>
<span class="nc" id="L270">                    m2.put(multiValues[iter], multiLabels[iter]);</span>
                }
<span class="nc" id="L272">                cnt.add(b.getLabel()).</span>
<span class="nc" id="L273">                        add(stringPicker);</span>
<span class="nc" id="L274">                allBindings.add(uib.bind(b, stringPicker,</span>
                        new UiBinding.PickerAdapter&lt;Object&gt;(
                                new UiBinding.MappingConverter(m1), new UiBinding.MappingConverter(m2))));
            }
<span class="nc" id="L278">            return;</span>
        }
<span class="nc" id="L280">        Class t = b.getGenericType();</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">        if (t != null) {</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">            if (t == Boolean.class) {</span>
<span class="nc" id="L283">                CheckBox cb = new CheckBox();</span>
<span class="nc" id="L284">                uib.bind(b, cb);</span>
<span class="nc" id="L285">                cnt.add(b.getLabel()).</span>
<span class="nc" id="L286">                        add(cb);</span>
<span class="nc" id="L287">                return;</span>
            }
<span class="nc bnc" id="L289" title="All 2 branches missed.">            if (t == Date.class) {</span>
<span class="nc" id="L290">                Picker dp = new Picker();</span>
<span class="nc" id="L291">                dp.setType(Display.PICKER_TYPE_DATE);</span>
<span class="nc" id="L292">                uib.bind(b, dp);</span>
<span class="nc" id="L293">                cnt.add(b.getLabel()).</span>
<span class="nc" id="L294">                        add(dp);</span>
<span class="nc" id="L295">                return;</span>
            }
        }
<span class="nc" id="L298">        TextField tf = new TextField();</span>
<span class="nc" id="L299">        tf.setConstraint(getTextFieldConstraint(b));</span>
<span class="nc" id="L300">        uib.bind(b, tf);</span>
<span class="nc" id="L301">        cnt.add(b.getLabel()).</span>
<span class="nc" id="L302">                add(tf);</span>
<span class="nc" id="L303">    }</span>

    /**
     * Returns the Binding object for the given container which allows us control over the widgets
     * and their commit status
     *
     * @param cnt the container returned by the {@link #createUI(boolean)} method
     * @return a binding object
     */
    public UiBinding.Binding getBindings(Container cnt) {
<span class="nc" id="L313">        return (UiBinding.Binding) cnt.getClientProperty(&quot;cn1$iui-binding&quot;);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>