<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Validator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">codenameone-core-unittests</a> &gt; <a href="index.source.html" class="el_package">com.codename1.ui.validation</a> &gt; <span class="el_source">Validator.java</span></div><h1>Validator.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2012, Codename One and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Codename One designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Codename One through http://www.codenameone.com/ if you
 * need additional information or have any questions.
 */
package com.codename1.ui.validation;

import com.codename1.components.InteractionDialog;
import com.codename1.ui.Button;
import com.codename1.ui.CheckBox;
import com.codename1.ui.Component;
import com.codename1.ui.Container;
import com.codename1.ui.Display;
import com.codename1.ui.FontImage;
import com.codename1.ui.Form;
import com.codename1.ui.Graphics;
import com.codename1.ui.Image;
import com.codename1.ui.InputComponent;
import com.codename1.ui.Label;
import com.codename1.ui.List;
import com.codename1.ui.Painter;
import com.codename1.ui.PickerComponent;
import com.codename1.ui.RadioButton;
import com.codename1.ui.TextArea;
import com.codename1.ui.TextComponent;
import com.codename1.ui.TextField;
import com.codename1.ui.events.ActionEvent;
import com.codename1.ui.events.ActionListener;
import com.codename1.ui.events.DataChangedListener;
import com.codename1.ui.events.FocusListener;
import com.codename1.ui.events.ScrollListener;
import com.codename1.ui.geom.Rectangle;
import com.codename1.ui.plaf.UIManager;
import com.codename1.ui.spinner.Picker;
import com.codename1.ui.util.UITimer;

import java.util.ArrayList;
import java.util.HashMap;

/**
 * &lt;p&gt;Binds validation constraints to form elements, when validation fails it can be highlighted directly on
 * the component via an emblem or change of the UIID (to original UIID name + &quot;Invalid&quot; e.g. &quot;TextFieldInvalid&quot;).
 * Validators just run thru a set of Constraint objects to decide if validation succeeded or failed.&lt;/p&gt;
 *
 * &lt;p&gt;It's possible to create any custom logic of validation. Example (see
 * &lt;a href=&quot;https://stackoverflow.com/questions/48481888/codename-one-regexconstraint-to-check-a-valid-phone-number/48483465#48483465&quot;&gt;this
 * discussion&lt;/a&gt; on StackOverflow): &lt;/p&gt;
 *
 * &lt;script src=&quot;https://gist.github.com/codenameone/6a67dd4d151bedf1bc3db6abb7b945ee.js&quot;&gt;&lt;/script&gt;
 *
 * @author Shai Almog
 */
public class Validator {
    private static final String VALID_MARKER = &quot;cn1$$VALID_MARKER&quot;;
    /**
     * Indicates the default mode in which validation failures are expressed
     */
<span class="nc" id="L75">    private static HighlightMode defaultValidationFailureHighlightMode = HighlightMode.EMBLEM;</span>
    /**
     * The emblem that will be drawn on top of the component to indicate the validation failure
     */
<span class="nc" id="L79">    private static Image defaultValidationFailedEmblem = null;</span>
    /**
     * The position of the validation emblem on the component as X/Y values between 0 and 1 where
     * 0 indicates the start of the component and 1 indicates its end on the given axis.
     */
<span class="nc" id="L84">    private static float defaultValidationEmblemPositionX = 1;</span>
    /**
     * The position of the validation emblem on the component as X/Y values between 0 and 1 where
     * 0 indicates the start of the component and 1 indicates its end on the given axis.
     */
<span class="nc" id="L89">    private static float defaultValidationEmblemPositionY = 0.5f;</span>
    /**
     * Indicates whether validation should occur on every key press (data change listener) or
     * action performed (editing completion)
     */
<span class="nc" id="L94">    private static boolean validateOnEveryKey = false;</span>
<span class="nc" id="L95">    private InteractionDialog message = new InteractionDialog();</span>
    /**
     * Error message UIID defaults to DialogBody. Allows customizing the look of the message
     */
<span class="nc" id="L99">    private String errorMessageUIID = &quot;DialogBody&quot;;</span>
    /**
     * Indicates the mode in which validation failures are expressed
     */
<span class="nc" id="L103">    private HighlightMode validationFailureHighlightMode = defaultValidationFailureHighlightMode;</span>
    /**
     * The emblem that will be drawn on top of the component to indicate the validation failure
     */
<span class="nc" id="L107">    private Image validationFailedEmblem = defaultValidationFailedEmblem;</span>
    /**
     * The position of the validation emblem on the component as X/Y values between 0 and 1 where
     * 0 indicates the start of the component and 1 indicates its end on the given axis.
     */
<span class="nc" id="L112">    private float validationEmblemPositionX = defaultValidationEmblemPositionX;</span>
    /**
     * The position of the validation emblem on the component as X/Y values between 0 and 1 where
     * 0 indicates the start of the component and 1 indicates its end on the given axis.
     */
<span class="nc" id="L117">    private float validationEmblemPositionY = defaultValidationEmblemPositionY;</span>
<span class="nc" id="L118">    private final HashMap&lt;Component, Constraint&gt; constraintList = new HashMap&lt;Component, Constraint&gt;();</span>
<span class="nc" id="L119">    private final ArrayList&lt;Component&gt; submitButtons = new ArrayList&lt;Component&gt;();</span>
    /**
     * Indicates whether an error message should be shown for the focused component
     */
    private boolean showErrorMessageForFocusedComponent;

    /**
     * Default constructor
     */
<span class="nc" id="L128">    public Validator() {</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">        if (defaultValidationFailedEmblem == null) {</span>
            // initialize the default emblem
<span class="nc" id="L131">            defaultValidationFailedEmblem = FontImage.createMaterial(FontImage.MATERIAL_CANCEL, &quot;InvalidEmblem&quot;, 3);</span>
<span class="nc" id="L132">            validationFailedEmblem = defaultValidationFailedEmblem;</span>
        }
<span class="nc" id="L134">    }</span>

    /**
     * Indicates the default mode in which validation failures are expressed
     *
     * @return the defaultValidationFailureHighlightMode
     */
    public static HighlightMode getDefaultValidationFailureHighlightMode() {
<span class="nc" id="L142">        return defaultValidationFailureHighlightMode;</span>
    }

    /**
     * Indicates the default mode in which validation failures are expressed
     *
     * @param aDefaultValidationFailureHighlightMode the defaultValidationFailureHighlightMode to set
     */
    public static void setDefaultValidationFailureHighlightMode(HighlightMode aDefaultValidationFailureHighlightMode) {
<span class="nc" id="L151">        defaultValidationFailureHighlightMode = aDefaultValidationFailureHighlightMode;</span>
<span class="nc" id="L152">    }</span>

    /**
     * The emblem that will be drawn on top of the component to indicate the validation failure
     *
     * @return the defaultValidationFailedEmblem
     */
    public static Image getDefaultValidationFailedEmblem() {
<span class="nc" id="L160">        return defaultValidationFailedEmblem;</span>
    }

    /**
     * The emblem that will be drawn on top of the component to indicate the validation failure
     *
     * @param aDefaultValidationFailedEmblem the defaultValidationFailedEmblem to set
     */
    public static void setDefaultValidationFailedEmblem(Image aDefaultValidationFailedEmblem) {
<span class="nc" id="L169">        defaultValidationFailedEmblem = aDefaultValidationFailedEmblem;</span>
<span class="nc" id="L170">    }</span>

    /**
     * The position of the validation emblem on the component as X/Y values between 0 and 1 where
     * 0 indicates the start of the component and 1 indicates its end on the given axis.
     *
     * @return the defaultValidationEmblemPositionX
     */
    public static float getDefaultValidationEmblemPositionX() {
<span class="nc" id="L179">        return defaultValidationEmblemPositionX;</span>
    }

    /**
     * The position of the validation emblem on the component as X/Y values between 0 and 1 where
     * 0 indicates the start of the component and 1 indicates its end on the given axis.
     *
     * @param aDefaultValidationEmblemPositionX the defaultValidationEmblemPositionX to set
     */
    public static void setDefaultValidationEmblemPositionX(float aDefaultValidationEmblemPositionX) {
<span class="nc" id="L189">        defaultValidationEmblemPositionX = aDefaultValidationEmblemPositionX;</span>
<span class="nc" id="L190">    }</span>

    /**
     * The position of the validation emblem on the component as X/Y values between 0 and 1 where
     * 0 indicates the start of the component and 1 indicates its end on the given axis.
     *
     * @return the defaultValidationEmblemPositionY
     */
    public static float getDefaultValidationEmblemPositionY() {
<span class="nc" id="L199">        return defaultValidationEmblemPositionY;</span>
    }

    /**
     * The position of the validation emblem on the component as X/Y values between 0 and 1 where
     * 0 indicates the start of the component and 1 indicates its end on the given axis.
     *
     * @param aDefaultValidationEmblemPositionY the defaultValidationEmblemPositionY to set
     */
    public static void setDefaultValidationEmblemPositionY(float aDefaultValidationEmblemPositionY) {
<span class="nc" id="L209">        defaultValidationEmblemPositionY = aDefaultValidationEmblemPositionY;</span>
<span class="nc" id="L210">    }</span>

    /**
     * Indicates whether validation should occur on every key press (data change listener) or
     * action performed (editing completion)
     *
     * @return the validateOnEveryKey
     */
    public static boolean isValidateOnEveryKey() {
<span class="nc" id="L219">        return validateOnEveryKey;</span>
    }

    /**
     * Indicates whether validation should occur on every key press (data change listener) or
     * action performed (editing completion)
     *
     * @param aValidateOnEveryKey the validateOnEveryKey to set
     */
    public static void setValidateOnEveryKey(boolean aValidateOnEveryKey) {
<span class="nc" id="L229">        validateOnEveryKey = aValidateOnEveryKey;</span>
<span class="nc" id="L230">    }</span>

    /**
     * Indicates the default mode in which validation failures are expressed
     *
     * @return the validationFailureHighlightMode
     */
    public HighlightMode getValidationFailureHighlightMode() {
<span class="nc" id="L238">        return validationFailureHighlightMode;</span>
    }

    /**
     * Indicates the default mode in which validation failures are expressed
     *
     * @param validationFailureHighlightMode the validationFailureHighlightMode to set
     */
    public void setValidationFailureHighlightMode(HighlightMode validationFailureHighlightMode) {
<span class="nc" id="L247">        this.validationFailureHighlightMode = validationFailureHighlightMode;</span>
<span class="nc" id="L248">    }</span>

    /**
     * The emblem that will be drawn on top of the component to indicate the validation failure
     *
     * @return the validationFailedEmblem
     */
    public Image getValidationFailedEmblem() {
<span class="nc" id="L256">        return validationFailedEmblem;</span>
    }

    /**
     * The emblem that will be drawn on top of the component to indicate the validation failure
     *
     * @param validationFailedEmblem the validationFailedEmblem to set
     */
    public void setValidationFailedEmblem(Image validationFailedEmblem) {
<span class="nc" id="L265">        this.validationFailedEmblem = validationFailedEmblem;</span>
<span class="nc" id="L266">    }</span>

    /**
     * The position of the validation emblem on the component as X/Y values between 0 and 1 where
     * 0 indicates the start of the component and 1 indicates its end on the given axis.
     *
     * @return the validationEmblemPositionX
     */
    public float getValidationEmblemPositionX() {
<span class="nc" id="L275">        return validationEmblemPositionX;</span>
    }

    /**
     * The position of the validation emblem on the component as X/Y values between 0 and 1 where
     * 0 indicates the start of the component and 1 indicates its end on the given axis.
     *
     * @param validationEmblemPositionX the validationEmblemPositionX to set
     */
    public void setValidationEmblemPositionX(float validationEmblemPositionX) {
<span class="nc" id="L285">        this.validationEmblemPositionX = validationEmblemPositionX;</span>
<span class="nc" id="L286">    }</span>

    /**
     * The position of the validation emblem on the component as X/Y values between 0 and 1 where
     * 0 indicates the start of the component and 1 indicates its end on the given axis.
     *
     * @return the validationEmblemPositionY
     */
    public float getValidationEmblemPositionY() {
<span class="nc" id="L295">        return validationEmblemPositionY;</span>
    }

    /**
     * The position of the validation emblem on the component as X/Y values between 0 and 1 where
     * 0 indicates the start of the component and 1 indicates its end on the given axis.
     *
     * @param validationEmblemPositionY the validationEmblemPositionY to set
     */
    public void setValidationEmblemPositionY(float validationEmblemPositionY) {
<span class="nc" id="L305">        this.validationEmblemPositionY = validationEmblemPositionY;</span>
<span class="nc" id="L306">    }</span>

    /**
     * Indicates whether an error message should be shown for the focused component
     *
     * @return true if the error message should be displayed
     */
    public boolean isShowErrorMessageForFocusedComponent() {
<span class="nc" id="L314">        return showErrorMessageForFocusedComponent;</span>
    }

    /**
     * Indicates whether an error message should be shown for the focused component
     *
     * @param showErrorMessageForFocusedComponent true to show the error message
     */
    public void setShowErrorMessageForFocusedComponent(boolean showErrorMessageForFocusedComponent) {
<span class="nc" id="L323">        this.showErrorMessageForFocusedComponent = showErrorMessageForFocusedComponent;</span>
<span class="nc" id="L324">    }</span>

    /**
     * Error message UIID defaults to DialogBody. Allows customizing the look of the message
     *
     * @return the errorMessageUIID
     */
    public String getErrorMessageUIID() {
<span class="nc" id="L332">        return errorMessageUIID;</span>
    }

    /**
     * Error message UIID defaults to DialogBody. Allows customizing the look of the message
     *
     * @param errorMessageUIID the errorMessageUIID to set
     */
    public void setErrorMessageUIID(String errorMessageUIID) {
<span class="nc" id="L341">        this.errorMessageUIID = errorMessageUIID;</span>
<span class="nc" id="L342">    }</span>

    /**
     * Places a constraint on the validator, returns this object so constraint
     * additions can be chained. Shows validation errors messages even when the
     * TextModeLayout is not {@code onTopMode} (it's possible to disable this
     * functionality setting to false the theme constant
     * {@code showValidationErrorsIfNotOnTopMode}: basically, the error
     * message is shown for two second in place of the label on the left of the
     * InputComponent (or on right of the InputComponent for RTL languages);
     * this solution never breaks the layout, because the error message is
     * trimmed to fit the available space. The error message UIID is
     * &quot;ErrorLabel&quot; when it's not onTopMode.
     *
     * @param cmp the component to validate
     * @param c   the constraint or constraints
     * @return this object so we can write code like v.addConstraint(cmp1,
     * cons).addConstraint(cmp2, otherConstraint);
     */
    public Validator addConstraint(Component cmp, Constraint... c) {
<span class="nc" id="L362">        Constraint constraint = null;</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">        if (c.length == 1) {</span>
<span class="nc" id="L364">            constraint = c[0];</span>
<span class="nc" id="L365">            constraintList.put(cmp, constraint);</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">        } else if (c.length &gt; 1) {</span>
<span class="nc" id="L367">            constraint = new GroupConstraint(c);</span>
<span class="nc" id="L368">            constraintList.put(cmp, constraint);</span>
        }
<span class="nc bnc" id="L370" title="All 2 branches missed.">        if (constraint == null) {</span>
<span class="nc" id="L371">            throw new IllegalArgumentException(&quot;addConstraint needs at least a Constraint, but the Constraint array in empty&quot;);</span>
        }
<span class="nc" id="L373">        bindDataListener(cmp);</span>
<span class="nc" id="L374">        boolean isV = isValid();</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">        for (Component btn : submitButtons) {</span>
<span class="nc" id="L376">            btn.setEnabled(isV);</span>
<span class="nc" id="L377">        }</span>

        // Show validation error on iPhone
<span class="nc bnc" id="L380" title="All 4 branches missed.">        if (UIManager.getInstance().isThemeConstant(&quot;showValidationErrorsIfNotOnTopMode&quot;, true) &amp;&amp; cmp instanceof InputComponent) {</span>
<span class="nc" id="L381">            final InputComponent inputComponent = (InputComponent) cmp;</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">            if (!inputComponent.isOnTopMode()) {</span>
<span class="nc" id="L383">                Label labelForComponent = null;</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">                if (inputComponent instanceof TextComponent) {</span>
<span class="nc" id="L385">                    labelForComponent = ((TextComponent) inputComponent).getField().getLabelForComponent();</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">                } else if (inputComponent instanceof PickerComponent) {</span>
<span class="nc" id="L387">                    labelForComponent = ((PickerComponent) inputComponent).getPicker().getLabelForComponent();</span>
                }

<span class="nc bnc" id="L390" title="All 2 branches missed.">                if (labelForComponent != null) {</span>
<span class="nc" id="L391">                    final Label myLabel = labelForComponent;</span>
<span class="nc" id="L392">                    final String originalText = myLabel.getText();</span>
<span class="nc" id="L393">                    final String originalUIID = myLabel.getUIID();</span>
<span class="nc" id="L394">                    final Constraint myConstraint = constraint;</span>

<span class="nc" id="L396">                    final Runnable showError = new Runnable() {</span>
                        @Override
                        public void run() {
<span class="nc" id="L399">                            boolean isValid = false;</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">                            if (inputComponent instanceof TextComponent) {</span>
<span class="nc" id="L401">                                isValid = myConstraint.isValid(((TextComponent) inputComponent).getField().getText());</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">                            } else if (inputComponent instanceof PickerComponent) {</span>
<span class="nc" id="L403">                                isValid = myConstraint.isValid(((PickerComponent) inputComponent).getPicker().getValue());</span>
                            }

<span class="nc" id="L406">                            String errorMessage = trimLongString(UIManager.getInstance().localize(myConstraint.getDefaultFailMessage(), myConstraint.getDefaultFailMessage()), &quot;ErrorLabel&quot;, myLabel.getWidth());</span>

<span class="nc bnc" id="L408" title="All 6 branches missed.">                            if (errorMessage != null &amp;&amp; errorMessage.length() &gt; 0 &amp;&amp; !isValid) {</span>
                                // show the error in place of the label for component
<span class="nc" id="L410">                                myLabel.setUIID(&quot;ErrorLabel&quot;);</span>
<span class="nc" id="L411">                                myLabel.setText(errorMessage);</span>
<span class="nc" id="L412">                                UITimer.timer(2000, false, Display.getInstance().getCurrent(), new Runnable() {</span>
                                    @Override
                                    public void run() {
<span class="nc" id="L415">                                        myLabel.setUIID(originalUIID);</span>
<span class="nc" id="L416">                                        myLabel.setText(originalText);</span>
<span class="nc" id="L417">                                    }</span>
                                });
                            } else {
                                // show the label for component without the error
<span class="nc" id="L421">                                myLabel.setUIID(originalUIID);</span>
<span class="nc" id="L422">                                myLabel.setText(originalText);</span>
                            }
<span class="nc" id="L424">                        }</span>
                    };

<span class="nc" id="L427">                    FocusListener myFocusListener = new FocusListener() {</span>

                        @Override
                        public void focusLost(Component cmp) {
<span class="nc" id="L431">                            showError.run();</span>
<span class="nc" id="L432">                        }</span>

                        @Override
                        public void focusGained(Component cmp) {
                            // no code here
<span class="nc" id="L437">                        }</span>
                    };

<span class="nc bnc" id="L440" title="All 2 branches missed.">                    if (inputComponent instanceof TextComponent) {</span>
<span class="nc" id="L441">                        ((TextComponent) inputComponent).getField().addFocusListener(myFocusListener);</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">                    } else if (inputComponent instanceof PickerComponent) {</span>
<span class="nc" id="L443">                        ((PickerComponent) inputComponent).getPicker().addFocusListener(myFocusListener);</span>
                    }

                }
            }
        }
<span class="nc" id="L449">        return this;</span>
    }

    /**
     * Long error messages are trimmed to fit the available space in the layout
     *
     * @param errorMessage the string to be trimmed
     * @param uiid         the uiid of the errorMessage
     * @param width        the maximum width
     * @return the new String trimmed to fit the available width
     */
    private String trimLongString(String errorMessage, String uiid, int width) {
<span class="nc" id="L461">        Label errorLabel = new Label(errorMessage, uiid);</span>
<span class="nc bnc" id="L462" title="All 4 branches missed.">        while (errorLabel.getPreferredW() &gt; width &amp;&amp; errorMessage.length() &gt; 1) {</span>
<span class="nc" id="L463">            errorMessage = errorMessage.substring(0, errorMessage.length() - 1);</span>
<span class="nc" id="L464">            errorLabel.setText(errorMessage);</span>
        }
<span class="nc" id="L466">        return errorMessage;</span>
    }

    /**
     * Submit buttons (or any other component type) can be disabled until all components contain a valid value.
     * Notice that this method should be invoked after all the constraints are added so the initial state of the buttons
     * will be correct.
     *
     * @param cmp set of buttons or components to disable until everything is valid
     * @return the validator instance so this method can be chained
     */
    public Validator addSubmitButtons(Component... cmp) {
<span class="nc" id="L478">        boolean isV = isValid();</span>
<span class="nc bnc" id="L479" title="All 2 branches missed.">        for (Component c : cmp) {</span>
<span class="nc" id="L480">            submitButtons.add(c);</span>
<span class="nc" id="L481">            c.setEnabled(isV);</span>
        }
<span class="nc" id="L483">        return this;</span>
    }

    /**
     * Returns the value of the given component, this can be overriden to add support for custom built components
     *
     * @param cmp the component
     * @return the object value
     */
    protected Object getComponentValue(Component cmp) {
<span class="nc bnc" id="L493" title="All 2 branches missed.">        if (cmp instanceof InputComponent) {</span>
<span class="nc" id="L494">            cmp = ((InputComponent) cmp).getEditor();</span>
        }
<span class="nc bnc" id="L496" title="All 2 branches missed.">        if (cmp instanceof TextArea) {</span>
<span class="nc" id="L497">            return ((TextArea) cmp).getText();</span>
        }
<span class="nc bnc" id="L499" title="All 2 branches missed.">        if (cmp instanceof Picker) {</span>
<span class="nc" id="L500">            return ((Picker) cmp).getValue();</span>
        }
<span class="nc bnc" id="L502" title="All 4 branches missed.">        if (cmp instanceof RadioButton || cmp instanceof CheckBox) {</span>
<span class="nc bnc" id="L503" title="All 2 branches missed.">            if (((Button) cmp).isSelected()) {</span>
<span class="nc" id="L504">                return Boolean.TRUE;</span>
            }
<span class="nc" id="L506">            return Boolean.FALSE;</span>
        }
<span class="nc bnc" id="L508" title="All 2 branches missed.">        if (cmp instanceof Label) {</span>
<span class="nc" id="L509">            return ((Label) cmp).getText();</span>
        }
<span class="nc bnc" id="L511" title="All 2 branches missed.">        if (cmp instanceof List) {</span>
<span class="nc" id="L512">            return ((List) cmp).getSelectedItem();</span>
        }
<span class="nc" id="L514">        return null;</span>
    }

    /**
     * Binds an event listener to the given component
     *
     * @param cmp the component to bind the data listener to
     * @deprecated this method was exposed by accident, constraint implicitly calls it and you don't need to
     * call it directly. It will be made protected in a future update to Codename One!
     */
    public void bindDataListener(Component cmp) {
<span class="nc bnc" id="L525" title="All 2 branches missed.">        if (showErrorMessageForFocusedComponent) {</span>
<span class="nc bnc" id="L526" title="All 4 branches missed.">            if (!(cmp instanceof InputComponent &amp;&amp; ((InputComponent) cmp).isOnTopMode())) {</span>
<span class="nc" id="L527">                cmp.addFocusListener(new FocusListener() {</span>
                    public void focusGained(Component cmp) {
                        // special case. Before the form is showing don't show error dialogs
<span class="nc" id="L530">                        Form p = cmp.getComponentForm();</span>
<span class="nc bnc" id="L531" title="All 2 branches missed.">                        if (p != Display.getInstance().getCurrent()) {</span>
<span class="nc" id="L532">                            return;</span>
                        }
<span class="nc bnc" id="L534" title="All 2 branches missed.">                        if (message != null) {</span>
<span class="nc" id="L535">                            message.dispose();</span>
                        }
<span class="nc bnc" id="L537" title="All 2 branches missed.">                        if (!isValid(cmp)) {</span>
<span class="nc" id="L538">                            String err = getErrorMessage(cmp);</span>
<span class="nc bnc" id="L539" title="All 4 branches missed.">                            if (err != null &amp;&amp; err.length() &gt; 0) {</span>
<span class="nc" id="L540">                                message = new InteractionDialog(err);</span>
<span class="nc" id="L541">                                message.getTitleComponent().setUIID(errorMessageUIID);</span>
<span class="nc" id="L542">                                message.setAnimateShow(false);</span>
<span class="nc bnc" id="L543" title="All 4 branches missed.">                                if (validationFailureHighlightMode == HighlightMode.EMBLEM || validationFailureHighlightMode == HighlightMode.UIID_AND_EMBLEM) {</span>
<span class="nc" id="L544">                                    int xpos = cmp.getAbsoluteX();</span>
<span class="nc" id="L545">                                    int ypos = cmp.getAbsoluteY();</span>
<span class="nc" id="L546">                                    Component scr = cmp.getScrollable();</span>
<span class="nc bnc" id="L547" title="All 2 branches missed.">                                    if (scr != null) {</span>
<span class="nc" id="L548">                                        xpos -= scr.getScrollX();</span>
<span class="nc" id="L549">                                        ypos -= scr.getScrollY();</span>
<span class="nc" id="L550">                                        scr.addScrollListener(new ScrollListener() {</span>
                                            public void scrollChanged(int scrollX, int scrollY, int oldscrollX, int oldscrollY) {
<span class="nc bnc" id="L552" title="All 2 branches missed.">                                                if (message != null) {</span>
<span class="nc" id="L553">                                                    message.dispose();</span>
                                                }
<span class="nc" id="L555">                                                message = null;</span>
<span class="nc" id="L556">                                            }</span>
                                        });
                                    }
<span class="nc" id="L559">                                    float width = cmp.getWidth();</span>
<span class="nc" id="L560">                                    float height = cmp.getHeight();</span>
<span class="nc" id="L561">                                    xpos += Math.round(width * validationEmblemPositionX);</span>
<span class="nc" id="L562">                                    ypos += Math.round(height * validationEmblemPositionY);</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">                                    if (message != null) {</span>
<span class="nc" id="L564">                                        message.showPopupDialog(new Rectangle(xpos, ypos, validationFailedEmblem.getWidth(),</span>
<span class="nc" id="L565">                                                validationFailedEmblem.getHeight()));</span>
                                    }
<span class="nc" id="L567">                                } else {</span>
<span class="nc" id="L568">                                    message.showPopupDialog(cmp);</span>
                                }
                            }
                        }
<span class="nc" id="L572">                    }</span>

                    public void focusLost(Component cmp) {
<span class="nc" id="L575">                    }</span>
                });
            }
        }
<span class="nc bnc" id="L579" title="All 2 branches missed.">        if (validateOnEveryKey) {</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">            if (cmp instanceof TextComponent) {</span>
<span class="nc" id="L581">                ((TextComponent) cmp).getField().addDataChangedListener(new ComponentListener(cmp));</span>
<span class="nc" id="L582">                return;</span>
            }
<span class="nc bnc" id="L584" title="All 2 branches missed.">            if (cmp instanceof TextField) {</span>
<span class="nc" id="L585">                ((TextField) cmp).addDataChangedListener(new ComponentListener(cmp));</span>
<span class="nc" id="L586">                return;</span>
            }
        }
<span class="nc bnc" id="L589" title="All 2 branches missed.">        if (cmp instanceof TextComponent) {</span>
<span class="nc" id="L590">            ((TextComponent) cmp).getField().addActionListener(new ComponentListener(cmp));</span>
<span class="nc" id="L591">            return;</span>
        }
<span class="nc bnc" id="L593" title="All 2 branches missed.">        if (cmp instanceof TextArea) {</span>
<span class="nc" id="L594">            ((TextArea) cmp).addActionListener(new ComponentListener(cmp));</span>
<span class="nc" id="L595">            return;</span>
        }
<span class="nc bnc" id="L597" title="All 2 branches missed.">        if (cmp instanceof List) {</span>
<span class="nc" id="L598">            ((List) cmp).addActionListener(new ComponentListener(cmp));</span>
<span class="nc" id="L599">            return;</span>
        }
<span class="nc bnc" id="L601" title="All 4 branches missed.">        if (cmp instanceof CheckBox || cmp instanceof RadioButton) {</span>
<span class="nc" id="L602">            ((Button) cmp).addActionListener(new ComponentListener(cmp));</span>
<span class="nc" id="L603">            return;</span>
        }
<span class="nc bnc" id="L605" title="All 2 branches missed.">        if (cmp instanceof Picker) {</span>
<span class="nc" id="L606">            ((Picker) cmp).addActionListener(new ComponentListener(cmp));</span>
<span class="nc" id="L607">            return;</span>
        }
<span class="nc bnc" id="L609" title="All 2 branches missed.">        if (cmp instanceof PickerComponent) {</span>
<span class="nc" id="L610">            ((PickerComponent) cmp).getPicker().addActionListener(new ComponentListener(cmp));</span>
        }
<span class="nc" id="L612">    }</span>

    /**
     * Returns true if all the constraints are currently valid
     *
     * @return true if the entire validator is valid
     */
    public boolean isValid() {
<span class="nc bnc" id="L620" title="All 2 branches missed.">        for (Component c : constraintList.keySet()) {</span>
<span class="nc bnc" id="L621" title="All 2 branches missed.">            if (!isValid(c)) {</span>
<span class="nc" id="L622">                return false;</span>
            }
<span class="nc" id="L624">        }</span>
<span class="nc" id="L625">        return true;</span>
    }

    /**
     * Validates and highlights an individual component
     *
     * @param cmp the component to validate
     */
    protected void validate(Component cmp) {
<span class="nc" id="L634">        Object val = getComponentValue(cmp);</span>
<span class="nc" id="L635">        Constraint c = constraintList.get(cmp);</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">        if (c != null) {</span>
<span class="nc" id="L637">            setValid(cmp, c.isValid(val));</span>
        }
<span class="nc" id="L639">    }</span>

    boolean isValid(Component cmp) {
<span class="nc" id="L642">        Boolean b = (Boolean) cmp.getClientProperty(VALID_MARKER);</span>
<span class="nc bnc" id="L643" title="All 2 branches missed.">        if (b != null) {</span>
<span class="nc" id="L644">            return b.booleanValue();</span>
        }
<span class="nc" id="L646">        Object val = getComponentValue(cmp);</span>
<span class="nc" id="L647">        Constraint c = constraintList.get(cmp);</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">        if (c != null) {</span>
<span class="nc" id="L649">            return c.isValid(val);</span>
        }
<span class="nc" id="L651">        return true;</span>
    }

    /**
     * Returns the validation error message for the given component or null if no such message exists
     *
     * @param cmp the invalid component
     * @return a string representing the error message
     */
    public String getErrorMessage(Component cmp) {
<span class="nc" id="L661">        return constraintList.get(cmp).getDefaultFailMessage();</span>
    }

    void setValid(Component cmp, boolean v) {
<span class="nc" id="L665">        Boolean b = (Boolean) cmp.getClientProperty(VALID_MARKER);</span>
<span class="nc bnc" id="L666" title="All 4 branches missed.">        if (b != null &amp;&amp; b.booleanValue() == v) {</span>
<span class="nc" id="L667">            return;</span>
        }
<span class="nc" id="L669">        cmp.putClientProperty(VALID_MARKER, v);</span>
<span class="nc bnc" id="L670" title="All 2 branches missed.">        if (!v) {</span>
            // if one component is invalid... just disable the submit buttons
<span class="nc bnc" id="L672" title="All 2 branches missed.">            for (Component c : submitButtons) {</span>
<span class="nc" id="L673">                c.setEnabled(false);</span>
<span class="nc" id="L674">            }</span>
        } else {
<span class="nc" id="L676">            boolean isV = isValid();</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">            for (Component c : submitButtons) {</span>
<span class="nc" id="L678">                c.setEnabled(isV);</span>
<span class="nc" id="L679">            }</span>
<span class="nc bnc" id="L680" title="All 4 branches missed.">            if (message != null &amp;&amp; cmp.hasFocus()) {</span>
<span class="nc" id="L681">                message.dispose();</span>
            }
        }

<span class="nc bnc" id="L685" title="All 4 branches missed.">        if (cmp instanceof InputComponent &amp;&amp; ((InputComponent) cmp).isOnTopMode()) {</span>
<span class="nc" id="L686">            InputComponent tc = (InputComponent) cmp;</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">            if (v) {</span>
<span class="nc" id="L688">                tc.errorMessage(null);</span>
            } else {
<span class="nc" id="L690">                tc.errorMessage(getErrorMessage(cmp));</span>
            }
        }

<span class="nc bnc" id="L694" title="All 2 branches missed.">        if (cmp.getComponentForm() != null) {</span>
<span class="nc bnc" id="L695" title="All 4 branches missed.">            if (validationFailureHighlightMode == HighlightMode.EMBLEM || validationFailureHighlightMode == HighlightMode.UIID_AND_EMBLEM) {</span>
<span class="nc bnc" id="L696" title="All 2 branches missed.">                if (!(cmp.getComponentForm().getGlassPane() instanceof ComponentListener)) {</span>
<span class="nc" id="L697">                    cmp.getComponentForm().setGlassPane(new ComponentListener(null));</span>
                }
            }
        }
<span class="nc bnc" id="L701" title="All 2 branches missed.">        if (v) {</span>
<span class="nc bnc" id="L702" title="All 4 branches missed.">            if (validationFailureHighlightMode == HighlightMode.UIID || validationFailureHighlightMode == HighlightMode.UIID_AND_EMBLEM) {</span>
<span class="nc" id="L703">                String uiid = cmp.getUIID();</span>
<span class="nc bnc" id="L704" title="All 2 branches missed.">                if (uiid.endsWith(&quot;Invalid&quot;)) {</span>
<span class="nc" id="L705">                    uiid = uiid.substring(0, uiid.length() - 7);</span>
<span class="nc" id="L706">                    cmp.setUIID(uiid);</span>
                }
<span class="nc" id="L708">                return;</span>
            }
<span class="nc bnc" id="L710" title="All 4 branches missed.">            if (validationFailureHighlightMode == HighlightMode.EMBLEM &amp;&amp; validationFailedEmblem != null) {</span>

            }
        } else {
<span class="nc bnc" id="L714" title="All 4 branches missed.">            if (validationFailureHighlightMode == HighlightMode.UIID || validationFailureHighlightMode == HighlightMode.UIID_AND_EMBLEM) {</span>
<span class="nc" id="L715">                String uiid = cmp.getUIID();</span>
<span class="nc bnc" id="L716" title="All 2 branches missed.">                if (!uiid.endsWith(&quot;Invalid&quot;)) {</span>
<span class="nc" id="L717">                    cmp.setUIID(uiid + &quot;Invalid&quot;);</span>
                }
            }
        }
<span class="nc" id="L721">    }</span>

    /**
     * Indicates the validation failure modes
     */
<span class="nc" id="L726">    public enum HighlightMode {</span>
<span class="nc" id="L727">        UIID,</span>
<span class="nc" id="L728">        EMBLEM,</span>
<span class="nc" id="L729">        UIID_AND_EMBLEM,</span>
<span class="nc" id="L730">        NONE</span>
    }

    class ComponentListener implements ActionListener, DataChangedListener, Painter {
        private final Component cmp;
<span class="nc" id="L735">        private Rectangle visibleRect = new Rectangle();</span>

<span class="nc" id="L737">        public ComponentListener(Component cmp) {</span>
<span class="nc" id="L738">            this.cmp = cmp;</span>
<span class="nc" id="L739">        }</span>

        public void actionPerformed(ActionEvent evt) {
<span class="nc" id="L742">            validate(cmp);</span>
<span class="nc" id="L743">        }</span>

        public void dataChanged(int type, int index) {
<span class="nc" id="L746">            validate(cmp);</span>
<span class="nc" id="L747">        }</span>

        /**
         * Handles the glasspane work just to save a new class object (smaller code)
         */
        @Override
        public void paint(Graphics g, Rectangle rect) {
<span class="nc bnc" id="L754" title="All 2 branches missed.">            for (Component c : constraintList.keySet()) {</span>
<span class="nc bnc" id="L755" title="All 2 branches missed.">                if (!isValid(c)) {</span>
<span class="nc bnc" id="L756" title="All 4 branches missed.">                    if (c instanceof InputComponent &amp;&amp; ((InputComponent) c).isOnTopMode()) {</span>
<span class="nc" id="L757">                        continue;</span>
                    }
<span class="nc" id="L759">                    int xpos = c.getAbsoluteX();</span>
<span class="nc" id="L760">                    int ypos = c.getAbsoluteY();</span>
<span class="nc" id="L761">                    float width = c.getWidth();</span>
<span class="nc" id="L762">                    float height = c.getHeight();</span>
<span class="nc" id="L763">                    xpos += Math.round(width * validationEmblemPositionX);</span>
<span class="nc" id="L764">                    ypos += Math.round(height * validationEmblemPositionY);</span>

<span class="nc" id="L766">                    Container parent = c.getParent();</span>
<span class="nc" id="L767">                    visibleRect = parent.getVisibleBounds(visibleRect);</span>
<span class="nc" id="L768">                    Container grandParent = parent.getParent();</span>
<span class="nc bnc" id="L769" title="All 2 branches missed.">                    if (grandParent != null) {</span>
<span class="nc" id="L770">                        visibleRect.setX(visibleRect.getX() + grandParent.getAbsoluteX());</span>
<span class="nc" id="L771">                        visibleRect.setY(visibleRect.getY() + grandParent.getAbsoluteY());</span>
                    }

<span class="nc" id="L774">                    int[] originalClip = g.getClip();</span>
<span class="nc" id="L775">                    g.setClip(visibleRect);</span>
<span class="nc bnc" id="L776" title="All 2 branches missed.">                    if (xpos + validationFailedEmblem.getWidth() &gt; Display.getInstance().getDisplayWidth()) {</span>
<span class="nc" id="L777">                        g.drawImage(validationFailedEmblem, xpos - validationFailedEmblem.getWidth(), ypos - validationFailedEmblem.getHeight() / 2);</span>
                    } else {
<span class="nc" id="L779">                        g.drawImage(validationFailedEmblem, xpos - validationFailedEmblem.getWidth() / 2, ypos - validationFailedEmblem.getHeight() / 2);</span>
                    }
<span class="nc" id="L781">                    g.setClip(originalClip);</span>
                }
<span class="nc" id="L783">            }</span>
<span class="nc" id="L784">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>