<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ZoozPurchase.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.codename1.impl.android</a> &gt; <span class="el_source">ZoozPurchase.java</span></div><h1>ZoozPurchase.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2012, Codename One and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Codename One designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *  
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 * 
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 * 
 * Please contact Codename One through http://www.codenameone.com/ if you 
 * need additional information or have any questions.
 */
package com.codename1.impl.android;

import android.app.Activity;
import android.content.Intent;
import android.util.Log;
import com.codename1.payment.Product;
import com.codename1.payment.Purchase;
import com.codename1.payment.PurchaseCallback;
import com.codename1.payment.Receipt;
import com.codename1.ui.CN;
import com.codename1.ui.Display;
/* ZOOZMARKER_START 
import com.zooz.android.lib.CheckoutActivity;
 ZOOZMARKER_END */

/**
 *
 * @author Chen
 */
public class ZoozPurchase extends Purchase implements IntentResultListener, Runnable {

    private Activity activity;
    
<span class="nc" id="L46">    private String purchaseId = null;</span>
    
<span class="nc" id="L48">    private boolean completed = false;</span>
    private boolean hasMarket;
    private String currency;
    private double amount;
    private String failMessage;
    
<span class="nc" id="L54">    public ZoozPurchase() {</span>
<span class="nc" id="L55">        activity = AndroidImplementation.getActivity();</span>
<span class="nc" id="L56">        hasMarket= AndroidImplementation.hasAndroidMarket(activity);</span>
<span class="nc" id="L57">    }</span>

    @Override
    public String getStoreCode() {
<span class="nc" id="L61">        return Receipt.STORE_CODE_PLAY;</span>
    }

    @Override
    public boolean isManagedPaymentSupported() {
<span class="nc" id="L66">        return hasMarket;</span>
    }

    @Override
    public boolean wasPurchased(String sku) {
<span class="nc" id="L71">        return ((CodenameOneActivity)activity).wasPurchased(sku);</span>
    }

    @Override
    public void purchase(String sku) {
<span class="nc" id="L76">        ((CodenameOneActivity)activity).purchase(sku);</span>
<span class="nc" id="L77">    }</span>

    @Override
    public void subscribe(String sku) {
        // Note that for Subscription products in Android, you can't just use
        // purchase(sku) like iOS does.  We need to run through the subscribe 
        // workflow.
<span class="nc" id="L84">        ((CodenameOneActivity)activity).subscribe(sku);</span>
<span class="nc" id="L85">    }</span>

    @Override
    public boolean isSubscriptionSupported() {
        //return ((CodenameOneActivity)activity).isSubscriptionSupported();
<span class="nc" id="L90">        return true;</span>
    }

    @Override
    public boolean isUnsubscribeSupported() {
<span class="nc" id="L95">        return false;</span>
    }
                
    @Override
    public boolean isManualPaymentSupported() {
<span class="nc" id="L100">        return true;</span>
    }
    
    public boolean isItemListingSupported() {
<span class="nc" id="L104">        return true;</span>
    }
    
    public Product[] getProducts(String[] skus) {
<span class="nc" id="L108">        return ((CodenameOneActivity)activity).getProducts(skus);</span>
    }
    
    
    /* ZOOZMARKER_START    
    @Override
    public String pay(double amount, String currency) {
        Intent intent = new Intent(activity, CheckoutActivity.class);

        String zoozAppKey = Display.getInstance().getProperty(&quot;ZoozAppKey&quot;, &quot;&quot;);
        boolean isSandBox = Display.getInstance().getProperty(&quot;ZoozSandBox&quot;, &quot;true&quot;).equals(&quot;true&quot;);
        // send merchant credential, app_key as given in the registration
        intent.putExtra(CheckoutActivity.ZOOZ_APP_KEY, zoozAppKey);
        intent.putExtra(CheckoutActivity.ZOOZ_AMOUNT, amount);
        intent.putExtra(CheckoutActivity.ZOOZ_CURRENCY_CODE, currency);
        intent.putExtra(CheckoutActivity.ZOOZ_IS_SANDBOX, isSandBox);
        String zoozInvoice = Display.getInstance().getProperty(&quot;ZoozInvoice&quot;, null);
        if(zoozInvoice != null) {
            intent.putExtra(CheckoutActivity.ZOOZ_INVOICE, zoozInvoice);
        }
        // start ZooZCheckoutActivity and wait to the activity result.
        activity.startActivityForResult(intent, ZOOZ_PAYMENT);
        
        Display.getInstance().invokeAndBlock(this);
        
        // use call serially so the purchase callback happens on the 
        // next EDT loop AFTER the value was returned 
        Display.getInstance().callSerially(new Runnable() {
            @Override
            public void run() {
                CodenameOneActivity cn = (CodenameOneActivity)activity;
                PurchaseCallback pc = cn.getPurchaseCallback();
                if(pc != null) {
                    if(failMessage != null) {
                        pc.paymentFailed(purchaseId, failMessage);
                    } else {
                        pc.paymentSucceeded(purchaseId, ZoozPurchase.this.amount, ZoozPurchase.this.currency);
                    }
                }
            }
        });
        return purchaseId;
    }
    ZOOZMARKER_END */

    @Override
    public void onActivityResult(int requestCode, int resultCode, Intent data) {
    /* ZOOZMARKER_START    
        if(resultCode == Activity.RESULT_OK){
            failMessage = null;
            purchaseId = data.getStringExtra(CheckoutActivity.ZOOZ_TRANSACTION_ID);
            amount = data.getDoubleExtra(CheckoutActivity.ZOOZ_AMOUNT, -1);
            currency = data.getStringExtra(CheckoutActivity.ZOOZ_CURRENCY_CODE);
        }else{
            failMessage = &quot;&quot;;
            if (data != null){
                //failed to purchase - the purchaseId will be null
                Log.d(&quot;Codename One&quot;, data.getStringExtra(CheckoutActivity.ZOOZ_ERROR_MSG));
                purchaseId = data.getStringExtra(CheckoutActivity.ZOOZ_TRANSACTION_ID);
                failMessage = data.getStringExtra(CheckoutActivity.ZOOZ_ERROR_MSG);
                if(failMessage == null) {
                    failMessage = &quot;&quot;;
                }
            }
        }
        completed = true;
        synchronized(this) {
            notify();
        }
    ZOOZMARKER_END */
<span class="nc" id="L178">    }</span>
    
    @Override
    public synchronized void run() {
<span class="nc bnc" id="L182" title="All 2 branches missed.">            while(!completed) {</span>
                try {
<span class="nc" id="L184">                    wait();</span>
<span class="nc" id="L185">                } catch (InterruptedException ex) {</span>
<span class="nc" id="L186">                }</span>
            }
<span class="nc" id="L188">    }</span>

    @Override
    public boolean isManageSubscriptionsSupported() {
<span class="nc" id="L192">        return true;</span>
    }

    @Override
    public void manageSubscriptions(String sku) {
<span class="nc bnc" id="L197" title="All 2 branches missed.">        if (sku == null) {</span>
<span class="nc" id="L198">            CN.execute(&quot;https://play.google.com/store/account/subscriptions&quot;);</span>
        } else {
<span class="nc" id="L200">            String packageName = activity.getApplicationContext().getPackageName();</span>
<span class="nc" id="L201">            CN.execute(&quot;https://play.google.com/store/account/subscriptions?sku=&quot;+sku+&quot;&amp;package=&quot;+packageName);</span>
        }
        
<span class="nc" id="L204">    }</span>
    
    
    
    
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>