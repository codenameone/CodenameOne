<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AndroidImplementation.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.codename1.impl.android</a> &gt; <span class="el_source">AndroidImplementation.java</span></div><h1>AndroidImplementation.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2012, Codename One and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Codename One designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *  
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 * 
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 * 
 * Please contact Codename One through http://www.codenameone.com/ if you 
 * need additional information or have any questions.
 */
package com.codename1.impl.android;

import android.Manifest;
import android.annotation.TargetApi;
import com.codename1.impl.android.permissions.DevicePermission;
import com.codename1.impl.android.permissions.PermissionsHelper;
import com.codename1.location.AndroidLocationManager;
import android.app.*;
import android.content.pm.PackageManager.NameNotFoundException;
import android.media.AudioTimestamp;
import androidx.core.content.ContextCompat;
import android.view.MotionEvent;
import com.codename1.codescan.ScanResult;
import com.codename1.media.Media;
import com.codename1.ui.geom.Dimension;


import android.webkit.CookieSyncManager;
import android.content.*;
import android.content.pm.*;
import android.content.res.AssetFileDescriptor;
import android.content.res.Configuration;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.graphics.Canvas;
import android.graphics.Paint;
import android.graphics.Rect;
import android.graphics.Typeface;
import android.graphics.Path;
import android.graphics.drawable.Drawable;
import android.media.AudioManager;
import android.net.Uri;
import android.os.Vibrator;
import android.os.PowerManager;
import android.telephony.TelephonyManager;
import android.util.DisplayMetrics;
import android.util.Log;
import android.util.TypedValue;
import android.view.KeyEvent;
import android.view.View;
import android.view.ViewGroup;
import android.view.Window;
import android.webkit.WebSettings;
import android.webkit.WebView;
import android.webkit.WebViewClient;
import android.widget.RelativeLayout;
import android.widget.TextView;
import com.codename1.ui.BrowserComponent;

import com.codename1.ui.Component;
import com.codename1.ui.Font;
import com.codename1.ui.Image;
import com.codename1.ui.PeerComponent;
import com.codename1.ui.events.ActionEvent;
import com.codename1.impl.CodenameOneImplementation;
import com.codename1.impl.VirtualKeyboardInterface;
import com.codename1.ui.plaf.UIManager;
import com.codename1.ui.util.Resources;
import java.lang.ref.SoftReference;
import java.lang.reflect.Method;
import java.net.URISyntaxException;
import java.nio.charset.StandardCharsets;
import java.util.Vector;
import android.database.Cursor;
import android.database.sqlite.SQLiteDatabase;
import android.graphics.Matrix;
import android.graphics.drawable.BitmapDrawable;
import android.hardware.Camera;
import android.media.AudioFormat;
import android.media.AudioRecord;
import android.media.ExifInterface;
import android.media.MediaPlayer;
import android.media.MediaRecorder;
import android.net.ConnectivityManager;
import android.net.NetworkInfo;
import android.os.Build;
import android.os.Bundle;
import android.os.Environment;
import android.os.Handler;
import android.os.IBinder;
import android.os.Looper;
import android.os.RemoteException;
import android.provider.MediaStore;
import android.provider.Settings;
import android.provider.Settings.Secure;
import android.renderscript.Allocation;
import android.renderscript.Element;
import android.renderscript.RenderScript;
import android.renderscript.ScriptIntrinsicBlur;
import androidx.core.app.NotificationCompat;
import androidx.core.content.FileProvider;
import android.support.v4.media.MediaBrowserCompat;
import android.support.v4.media.session.MediaControllerCompat;
import android.support.v4.media.session.PlaybackStateCompat;
import android.telephony.SmsManager;
import android.telephony.gsm.GsmCellLocation;
import android.text.Html;
import android.view.*;
import android.view.View.MeasureSpec;
import android.view.accessibility.AccessibilityEvent;
import android.view.accessibility.AccessibilityManager;
import android.webkit.*;
import android.widget.*;
import com.codename1.background.BackgroundFetch;
import com.codename1.capture.VideoCaptureConstraints;
import com.codename1.codescan.CodeScanner;
import com.codename1.contacts.Contact;
import com.codename1.db.Database;
import com.codename1.impl.android.compat.app.NotificationCompatWrapper;
import com.codename1.impl.android.compat.app.NotificationCompatWrapper.ActionWrapper;
import com.codename1.impl.android.compat.app.RemoteInputWrapper;
import com.codename1.io.BufferedInputStream;
import com.codename1.io.BufferedOutputStream;
import com.codename1.io.*;
import com.codename1.l10n.L10NManager;
import com.codename1.location.LocationManager;
import com.codename1.media.AbstractMedia;
import com.codename1.media.AsyncMedia;
import com.codename1.media.AsyncMedia.MediaErrorType;
import com.codename1.media.AsyncMedia.MediaException;
import com.codename1.media.Audio;
import com.codename1.media.AudioService;
import com.codename1.media.BackgroundAudioService;
import com.codename1.media.MediaProxy;
import com.codename1.media.MediaRecorderBuilder;
import com.codename1.messaging.Message;
import com.codename1.notifications.LocalNotification;
import com.codename1.payment.Purchase;
import com.codename1.push.PushAction;
import com.codename1.push.PushActionCategory;
import com.codename1.push.PushActionsProvider;
import com.codename1.push.PushCallback;
import com.codename1.push.PushContent;
import com.codename1.ui.*;
import com.codename1.ui.Dialog;
import com.codename1.ui.Display;
import com.codename1.ui.animations.Animation;
import com.codename1.ui.animations.CommonTransitions;
import com.codename1.ui.events.ActionListener;
import com.codename1.ui.geom.GeneralPath;
import com.codename1.ui.geom.Rectangle;
import com.codename1.ui.geom.Shape;
import com.codename1.ui.layouts.BorderLayout;
import com.codename1.ui.plaf.Style;
import com.codename1.ui.util.EventDispatcher;
import com.codename1.util.AsyncResource;
import com.codename1.util.Callback;
import java.io.File;
import java.io.FileDescriptor;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.PrintWriter;
import java.io.RandomAccessFile;
import java.io.Writer;
import java.lang.reflect.Constructor;
import java.net.HttpURLConnection;
import java.net.URI;
import java.net.URL;
import java.net.URLConnection;
import java.text.DateFormat;
import java.text.NumberFormat;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Date;
import java.util.Hashtable;
import java.util.List;
import java.util.Locale;
import java.util.Set;
import java.util.logging.Level;
import java.util.logging.Logger;
import com.codename1.util.StringUtil;
import com.codename1.util.SuccessCallback;
import java.io.*;
import java.lang.reflect.Field;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Modifier;
import java.net.CookieHandler;
import java.net.InetAddress;
import java.net.InetSocketAddress;
import java.net.NetworkInterface;
import java.net.ServerSocket;
import java.security.MessageDigest;
import java.text.ParseException;
import java.util.*;
import javax.net.ssl.HttpsURLConnection;
import javax.xml.parsers.ParserConfigurationException;

import org.json.JSONException;
import org.json.JSONObject;
import org.json.JSONStringer;
import org.xml.sax.SAXException;
//import android.webkit.JavascriptInterface;

<span class="fc" id="L220">public class AndroidImplementation extends CodenameOneImplementation implements IntentResultListener {</span>
<span class="fc" id="L221">    public static final Thread.UncaughtExceptionHandler exceptionHandler = new Thread.UncaughtExceptionHandler() {</span>
        @Override
        public void uncaughtException(Thread t, Throwable e) {
<span class="nc bnc" id="L224" title="All 2 branches missed.">            if(com.codename1.io.Log.isCrashBound()) {</span>
<span class="nc" id="L225">                com.codename1.io.Log.p(&quot;Uncaught exception in thread &quot; + t.getName());</span>
<span class="nc" id="L226">                com.codename1.io.Log.e(e);</span>
<span class="nc" id="L227">                com.codename1.io.Log.sendLog();</span>
            }
<span class="nc" id="L229">        }</span>
    };

    public static final int FLAG_ONE_SHOT = 0x40000000;
    public static final int FLAG_MUTABLE = 0x02000000;

    public static final int FLAG_IMMUTABLE = 0x04000000;

    /**
     * make sure these important keys have a negative value when passed to
     * Codename One or they might be interpreted as characters.
     */
    static final int DROID_IMPL_KEY_LEFT = -23446;
    static final int DROID_IMPL_KEY_RIGHT = -23447;
    static final int DROID_IMPL_KEY_UP = -23448;
    static final int DROID_IMPL_KEY_DOWN = -23449;
    static final int DROID_IMPL_KEY_FIRE = -23450;
    static final int DROID_IMPL_KEY_MENU = -23451;
    static final int DROID_IMPL_KEY_BACK = -23452;
    static final int DROID_IMPL_KEY_BACKSPACE = -23453;
    static final int DROID_IMPL_KEY_CLEAR = -23454;
    static final int DROID_IMPL_KEY_SEARCH = -23455;
    static final int DROID_IMPL_KEY_CALL = -23456;
    static final int DROID_IMPL_KEY_VOLUME_UP = -23457;
    static final int DROID_IMPL_KEY_VOLUME_DOWN = -23458;
    static final int DROID_IMPL_KEY_MUTE = -23459;
<span class="fc" id="L255">    static int[] leftSK = new int[]{DROID_IMPL_KEY_MENU};</span>

    /**
     * @return the activity
     */
    public static CodenameOneActivity getActivity() {
<span class="fc" id="L261">        return activity;</span>
    }

    /**
     * @param aActivity the activity to set
     */
    public static void setActivity(CodenameOneActivity aActivity) {
<span class="fc" id="L268">        activity = aActivity;</span>
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">        if (activity != null) {</span>
<span class="fc" id="L270">            activityComponentName = activity.getComponentName();</span>
        }
        
<span class="fc" id="L273">    }</span>
<span class="fc" id="L274">    CodenameOneSurface myView = null;</span>
    CodenameOneTextPaint defaultFont;
<span class="fc" id="L276">    private final char[] tmpchar = new char[1];</span>
<span class="fc" id="L277">    private final Rect tmprect = new Rect();</span>
    protected int defaultFontHeight;
<span class="fc" id="L279">    private Vibrator v = null;</span>
<span class="fc" id="L280">    private boolean vibrateInitialized = false;</span>
    private int displayWidth;
    private int displayHeight;
    static CodenameOneActivity activity;
    static ComponentName activityComponentName;
    private static PowerManager.WakeLock pushWakeLock;
    public static void acquirePushWakeLock(long timeout) {
<span class="nc bnc" id="L287" title="All 2 branches missed.">        if (getContext() == null) return;</span>
        try {
<span class="nc bnc" id="L289" title="All 2 branches missed.">            if (pushWakeLock == null) {</span>
<span class="nc" id="L290">                PowerManager pm = (PowerManager) getContext().getSystemService(Context.POWER_SERVICE);</span>
<span class="nc" id="L291">                pushWakeLock = pm.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK, &quot;CN1:PushWakeLock&quot;);</span>
            }
<span class="nc" id="L293">            pushWakeLock.acquire(timeout);</span>
<span class="nc" id="L294">        } catch (Exception ex) {</span>
<span class="nc" id="L295">            com.codename1.io.Log.e(ex);</span>
<span class="nc" id="L296">        }</span>
<span class="nc" id="L297">    }</span>
    
    private static Context context;
    private static PermissionPromptCallback permissionPromptCallback;
    RelativeLayout relativeLayout;
<span class="fc" id="L302">    final Vector nativePeers = new Vector();</span>
    int lastDirectionalKeyEventReceivedByWrapper;
    private EventDispatcher callback;
<span class="fc" id="L305">    private int timeout = -1;</span>
    private CodeScannerImpl scannerInstance;
    private HashMap apIds;
    private static View viewBelow;
    private static View viewAbove;
    private static int aboveSpacing;
    private static int belowSpacing;
<span class="fc" id="L312">    public static boolean asyncView = true;</span>
<span class="fc" id="L313">    public static boolean textureView = false;</span>
    private AudioService background;
<span class="fc" id="L315">    private boolean asyncEditMode = true;</span>
    private boolean compatPaintMode;
<span class="fc" id="L317">    private MediaRecorder recorder = null;</span>

    private boolean statusBarHidden;
<span class="fc" id="L320">    private boolean superPeerMode = true;</span>
    
    
    private ValueCallback&lt;Uri&gt; mUploadMessage;
    public ValueCallback&lt;Uri[]&gt; uploadMessage;

    /**
     * Keeps track of running contexts.
     * @see #startContext(Context)
     * @see #stopContext(Context)
     */
<span class="fc" id="L331">    private static HashSet&lt;Context&gt; activeContexts = new HashSet&lt;Context&gt;();</span>

    /**
     * A method to be called when a Context begins its execution.  This adds the
     * context to the context set.  When the contenxt's execution completes, it should
     * call {@link #stopContext} to clear up resources.
     * @param ctx The context that is starting.
     * @see #stopContext(Context)
     */
    public static void startContext(Context ctx) {

<span class="pc bpc" id="L342" title="1 of 2 branches missed.">        while (deinitializingEdt) {</span>
            // It is possible that deinitialize was called just before the
            // last context was destroyed so there is a pending deinitialize
            // working its way through the system.  Give it some time
            // before forcing the deinitialize
<span class="nc" id="L347">            System.out.println(&quot;Waiting for deinitializing to complete before starting a new initialization&quot;);</span>
<span class="nc" id="L348">            Util.sleep(30);</span>
        }
<span class="pc bpc" id="L350" title="3 of 4 branches missed.">        if (deinitializing &amp;&amp; instance != null) {</span>
<span class="nc" id="L351">            instance.deinitialize();</span>
        }
<span class="fc" id="L353">        synchronized(activeContexts) {</span>
<span class="fc" id="L354">            activeContexts.add(ctx);</span>
<span class="pc bpc" id="L355" title="1 of 2 branches missed.">            if (instance == null) {</span>
                // If this is our first rodeo, just call Display.init() as that should
                // be sufficient to set everything up.
<span class="fc" id="L358">                Display.init(ctx);</span>
            } else {
                // If we've initialized before, we should &quot;re-initialize&quot; the implementation
                // Reinitializing will force views to be created even if the EDT was already
                // running in background mode.
<span class="nc" id="L363">                reinit(ctx);</span>
            }
<span class="fc" id="L365">        }</span>
<span class="fc" id="L366">    }</span>

    /**
     * Cleans up resources in the given context.  This method should be called by
     * any Activity or Service that called startContext() when it started.
     * @param ctx The context to stop.
     *
     * @see #startContext(Context)
     */
    public static void stopContext(Context ctx) {
<span class="fc" id="L376">        synchronized(activeContexts) {</span>
<span class="fc" id="L377">            activeContexts.remove(ctx);</span>
<span class="pc bpc" id="L378" title="1 of 2 branches missed.">            if (activeContexts.isEmpty()) {</span>
                // If we are the last context, we should deinitialize
<span class="fc" id="L380">                syncDeinitialize();</span>
            } else {
<span class="nc bnc" id="L382" title="All 4 branches missed.">                if (instance != null &amp;&amp; getActivity() != null) {</span>
                    // if this is an activity, then we should clean up
                    // our UI resources anyways because the last context
                    // to be cleaned up might not have access to the UI thread.
<span class="nc" id="L386">                    instance.deinitialize();</span>
                }
            }
<span class="fc" id="L389">        }</span>
<span class="fc" id="L390">    }</span>

    @Override
    public void screenshot(SuccessCallback&lt;Image&gt; callback) {
<span class="fc" id="L394">        final Activity activity = (Activity) getContext();</span>
<span class="fc" id="L395">        final AndroidScreenshotTask task = new AndroidScreenshotTask(myView, activity, callback);</span>
<span class="fc" id="L396">        activity.runOnUiThread(task);</span>
<span class="fc" id="L397">    }</span>

    @Override
    public void setPlatformHint(String key, String value) {
<span class="nc bnc" id="L401" title="All 2 branches missed.">        if(key.equals(&quot;platformHint.compatPaintMode&quot;)) {</span>
<span class="nc" id="L402">            compatPaintMode = value.equalsIgnoreCase(&quot;true&quot;);</span>
<span class="nc" id="L403">            return;</span>
        }
<span class="nc bnc" id="L405" title="All 2 branches missed.">        if(key.equals(&quot;platformHint.legacyPaint&quot;)) {</span>
<span class="nc" id="L406">            AndroidAsyncView.legacyPaintLogic = value.equalsIgnoreCase(&quot;true&quot;);;</span>
        }
<span class="nc" id="L408">    }</span>


    /**
     * This method in used internally for ads
     * @param above shown above the view
     * @param below shown below the view
     */
    public static void setViewAboveBelow(View above, View below, int spacingAbove, int spacingBelow) {
<span class="nc" id="L417">        viewBelow = below;</span>
<span class="nc" id="L418">        viewAbove = above;</span>
<span class="nc" id="L419">        aboveSpacing = spacingAbove;</span>
<span class="nc" id="L420">        belowSpacing = spacingBelow;</span>
<span class="nc" id="L421">    }</span>

    static boolean hasViewAboveBelow(){
<span class="nc bnc" id="L424" title="All 4 branches missed.">        return viewBelow != null || viewAbove != null;</span>
    }

    /**
     * Copy the input stream into the output stream, closes both streams when finishing or in
     * a case of an exception
     *
     * @param i source
     * @param o destination
     */
    private static void copy(InputStream i, OutputStream o) throws IOException {
<span class="nc" id="L435">        copy(i, o, 8192);</span>
<span class="nc" id="L436">    }</span>

    /**
     * Copy the input stream into the output stream, closes both streams when finishing or in
     * a case of an exception
     *
     * @param i source
     * @param o destination
     * @param bufferSize the size of the buffer, which should be a power of 2 large enoguh
     */
    private static void copy(InputStream i, OutputStream o, int bufferSize) throws IOException {
        try {
<span class="nc" id="L448">            byte[] buffer = new byte[bufferSize];</span>
<span class="nc" id="L449">            int size = i.read(buffer);</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">            while(size &gt; -1) {</span>
<span class="nc" id="L451">                o.write(buffer, 0, size);</span>
<span class="nc" id="L452">                size = i.read(buffer);</span>
            }
        } finally {
<span class="nc" id="L455">            sCleanup(o);</span>
<span class="nc" id="L456">            sCleanup(i);</span>
        }
<span class="nc" id="L458">    }</span>

    private static void sCleanup(Object o) {
        try {
<span class="nc bnc" id="L462" title="All 2 branches missed.">            if(o != null) {</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">                if(o instanceof InputStream) {</span>
<span class="nc" id="L464">                    ((InputStream)o).close();</span>
<span class="nc" id="L465">                    return;</span>
                }
<span class="nc bnc" id="L467" title="All 2 branches missed.">                if(o instanceof OutputStream) {</span>
<span class="nc" id="L468">                    ((OutputStream)o).close();</span>
<span class="nc" id="L469">                    return;</span>
                }
            }
<span class="nc" id="L472">        } catch(Throwable t) {}</span>
<span class="nc" id="L473">    }</span>

    /**
     * Copied here since the cleanup method in util would crash append notification that runs when the app isn't in the foreground
     */
    private static byte[] readInputStream(InputStream i) throws IOException {
<span class="nc" id="L479">        ByteArrayOutputStream b = new ByteArrayOutputStream();</span>
<span class="nc" id="L480">        copy(i, b);</span>
<span class="nc" id="L481">        return b.toByteArray();</span>
    }


    public static void appendNotification(String type, String body, Context a) {
<span class="nc" id="L486">        appendNotification(type, body, null, null, a);</span>
<span class="nc" id="L487">    }</span>
    
    public static void appendNotification(String type, String body, String image, String category, Context a) {
        try {
<span class="nc" id="L491">            String[] fileList = a.fileList();</span>
<span class="nc" id="L492">            byte[] data = null;</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">            for (int iter = 0; iter &lt; fileList.length; iter++) {</span>
<span class="nc bnc" id="L494" title="All 2 branches missed.">                if (fileList[iter].equals(&quot;CN1$AndroidPendingNotifications&quot;)) {</span>
<span class="nc" id="L495">                    InputStream is = a.openFileInput(&quot;CN1$AndroidPendingNotifications&quot;);</span>
<span class="nc bnc" id="L496" title="All 2 branches missed.">                    if(is != null) {</span>
<span class="nc" id="L497">                        data = readInputStream(is);</span>
<span class="nc" id="L498">                        sCleanup(a);</span>
<span class="nc" id="L499">                        break;</span>
                    }
                }
            }
<span class="nc" id="L503">            DataOutputStream os = new DataOutputStream(a.openFileOutput(&quot;CN1$AndroidPendingNotifications&quot;, 0));</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">            if(data != null) {</span>
<span class="nc" id="L505">                data[0]++;</span>
<span class="nc" id="L506">                os.write(data);</span>
            } else {
<span class="nc" id="L508">                os.writeByte(1);</span>
            }
<span class="nc" id="L510">            String bodyType = type;</span>
<span class="nc bnc" id="L511" title="All 4 branches missed.">            if (image != null || category != null) {</span>
<span class="nc" id="L512">                type = &quot;99&quot;;</span>
            }
<span class="nc bnc" id="L514" title="All 2 branches missed.">            if(type != null) {</span>
<span class="nc" id="L515">                os.writeBoolean(true);</span>
<span class="nc" id="L516">                os.writeUTF(type);</span>
            } else {
<span class="nc" id="L518">                os.writeBoolean(false);</span>
            }
<span class="nc bnc" id="L520" title="All 2 branches missed.">            if (&quot;99&quot;.equals(type)) {</span>
<span class="nc" id="L521">                String msg = &quot;body=&quot;+java.net.URLEncoder.encode(body, &quot;UTF-8&quot;)</span>
<span class="nc" id="L522">                        +&quot;&amp;type=&quot;+java.net.URLEncoder.encode(bodyType, &quot;UTF-8&quot;);</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">                if (category != null) {</span>
<span class="nc" id="L524">                    msg += &quot;&amp;category=&quot;+java.net.URLEncoder.encode(category, &quot;UTF-8&quot;);</span>
                }
<span class="nc bnc" id="L526" title="All 2 branches missed.">                if (image != null) {</span>
<span class="nc" id="L527">                    msg += &quot;&amp;image=&quot;+java.net.URLEncoder.encode(image, &quot;UTF-8&quot;);</span>
                }
<span class="nc" id="L529">                os.writeUTF(msg);</span>
                        
<span class="nc" id="L531">            } else {</span>
<span class="nc" id="L532">                os.writeUTF(body);</span>
            }
<span class="nc" id="L534">            os.writeLong(System.currentTimeMillis());</span>
<span class="nc" id="L535">        } catch(IOException err) {</span>
<span class="nc" id="L536">            err.printStackTrace();</span>
<span class="nc" id="L537">        }</span>
<span class="nc" id="L538">    }</span>

    private static Map&lt;String,String&gt; splitQuery(String urlencodeQueryString) {
<span class="nc" id="L541">        String[] parts = urlencodeQueryString.split(&quot;&amp;&quot;);</span>
<span class="nc" id="L542">        Map&lt;String,String&gt; out = new HashMap&lt;String,String&gt;();</span>
<span class="nc bnc" id="L543" title="All 2 branches missed.">        for (String part : parts) {</span>
<span class="nc" id="L544">            int pos = part.indexOf(&quot;=&quot;);</span>
            String k,v;
<span class="nc bnc" id="L546" title="All 2 branches missed.">            if (pos &gt; 0) {</span>
<span class="nc" id="L547">                k = part.substring(0, pos);</span>
<span class="nc" id="L548">                v = part.substring(pos+1);</span>
            } else {
<span class="nc" id="L550">                k = part;</span>
<span class="nc" id="L551">                v = &quot;&quot;;</span>
            }
            try {
<span class="nc" id="L554">                k = java.net.URLDecoder.decode(k, &quot;UTF-8&quot;);</span>
<span class="nc" id="L555">                v = java.net.URLDecoder.decode(v, &quot;UTF-8&quot;);</span>
<span class="nc" id="L556">            } catch (UnsupportedEncodingException ex) {</span>
                // won't happen
<span class="nc" id="L558">                com.codename1.io.Log.e(ex);</span>
<span class="nc" id="L559">            }</span>
<span class="nc" id="L560">            out.put(k, v);</span>
        }
<span class="nc" id="L562">        return out;</span>
    }

    public String getStackTrace(Thread parentThread, Throwable t) {
<span class="nc" id="L566">        System.out.println(&quot;CN1SS:ERR:Invoking getStackTrace in AndroidImplementation&quot;);</span>
<span class="nc" id="L567">        ByteArrayOutputStream bos = new ByteArrayOutputStream();</span>
<span class="nc" id="L568">        PrintWriter w = new PrintWriter(new OutputStreamWriter(bos, StandardCharsets.UTF_8));</span>
<span class="nc" id="L569">        t.printStackTrace(w);</span>
<span class="nc" id="L570">        w.close();</span>
<span class="nc" id="L571">        System.out.println(&quot;CN1SS:ERR:AndroidImplementation getStackTrace completed&quot;);</span>
<span class="nc" id="L572">        return new String(bos.toByteArray(), StandardCharsets.UTF_8);</span>
    }

    public static void initPushContent(String message, String image, String messageType, String category, Context context) {
<span class="nc" id="L576">        com.codename1.push.PushContent.reset();</span>
        
<span class="nc" id="L578">        int iMessageType = 1;</span>
<span class="nc" id="L579">        try {iMessageType = Integer.parseInt(messageType);}catch(Throwable t){}</span>
        
<span class="nc" id="L581">        String actionId = null;</span>
<span class="nc" id="L582">        String reply = null;</span>
<span class="nc" id="L583">        boolean cancel = true;</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">        if (context instanceof Activity) {</span>
<span class="nc" id="L585">            Activity activity = (Activity)context;</span>
<span class="nc" id="L586">            Bundle extras = activity.getIntent().getExtras();</span>
<span class="nc bnc" id="L587" title="All 2 branches missed.">            if (extras != null) {</span>
<span class="nc" id="L588">                actionId = extras.getString(&quot;pushActionId&quot;);</span>
<span class="nc" id="L589">                extras.remove(&quot;pushActionId&quot;);</span>

<span class="nc bnc" id="L591" title="All 4 branches missed.">                if (actionId != null &amp;&amp; RemoteInputWrapper.isSupported()) {</span>
<span class="nc" id="L592">                    Bundle textExtras = RemoteInputWrapper.getResultsFromIntent(activity.getIntent());</span>
<span class="nc bnc" id="L593" title="All 2 branches missed.">                    if (textExtras != null) {</span>
<span class="nc" id="L594">                        CharSequence cs  = textExtras.getCharSequence(actionId + &quot;$Result&quot;);</span>
<span class="nc bnc" id="L595" title="All 2 branches missed.">                        if (cs != null) {</span>
<span class="nc" id="L596">                            reply = cs.toString();</span>
                        }
                    }

                    
                }
            }
            
        }
<span class="nc bnc" id="L605" title="All 2 branches missed.">        if (cancel) {</span>
<span class="nc" id="L606">            PushNotificationService.cancelNotification(context);</span>
        }
<span class="nc" id="L608">        com.codename1.push.PushContent.setType(iMessageType);</span>
<span class="nc" id="L609">        com.codename1.push.PushContent.setCategory(category);</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">        if (actionId != null) {</span>
<span class="nc" id="L611">            com.codename1.push.PushContent.setActionId(actionId);</span>
        }
<span class="nc bnc" id="L613" title="All 2 branches missed.">        if (reply != null) {</span>
<span class="nc" id="L614">            com.codename1.push.PushContent.setTextResponse(reply);</span>
        }
<span class="nc bnc" id="L616" title="All 7 branches missed.">        switch (iMessageType) {</span>
            case 1:
            case 5:
<span class="nc" id="L619">                com.codename1.push.PushContent.setBody(message);break;</span>
<span class="nc" id="L620">            case 2: com.codename1.push.PushContent.setMetaData(message);break;</span>
            case 3: {
<span class="nc" id="L622">                String[] parts = message.split(&quot;;&quot;);</span>
<span class="nc" id="L623">                com.codename1.push.PushContent.setMetaData(parts[1]);</span>
<span class="nc" id="L624">                com.codename1.push.PushContent.setBody(parts[0]);</span>
<span class="nc" id="L625">                break;</span>
            }
            case 4: {
<span class="nc" id="L628">                String[] parts = message.split(&quot;;&quot;);</span>
<span class="nc" id="L629">                com.codename1.push.PushContent.setTitle(parts[0]);</span>
<span class="nc" id="L630">                com.codename1.push.PushContent.setBody(parts[1]);</span>
<span class="nc" id="L631">                break;</span>
            }
            case 101: {
<span class="nc" id="L634">                com.codename1.push.PushContent.setBody(message.substring(message.indexOf(&quot; &quot;) + 1));</span>
<span class="nc" id="L635">                com.codename1.push.PushContent.setType(1);</span>
<span class="nc" id="L636">                break;</span>
            }
            case 102: {
<span class="nc" id="L639">                String[] parts = message.split(&quot;;&quot;);</span>
<span class="nc" id="L640">                com.codename1.push.PushContent.setTitle(parts[1]);</span>
<span class="nc" id="L641">                com.codename1.push.PushContent.setBody(parts[2]);</span>
<span class="nc" id="L642">                com.codename1.push.PushContent.setType(2);</span>
<span class="nc" id="L643">                break;</span>
            }
        }
<span class="nc" id="L646">    }</span>
    
    // Name of file where we install the push notification categories as an XML file
    // if the main class implements PushActiosProvider
<span class="fc" id="L650">    private static String FILE_NAME_NOTIFICATION_CATEGORIES = &quot;CN1$AndroidNotificationCategories&quot;;</span>
    
    
    
    /**
     * Action categories are defined on the Main class by implementing the PushActionsProvider, however
     * the main class may not be available to the push receiver, so we need to save these categories
     * to the file system when the app is installed, then the push receiver can load these actions
     * when it sends a push while the app isn't running.
     * @param provider A reference to the App's main class 
     * @throws IOException 
     */
    public static void installNotificationActionCategories(PushActionsProvider provider) throws IOException {
        // Assume that CN1 is running... this will run when the app starts
        // up
<span class="nc" id="L665">        Context context = getContext();</span>
<span class="nc" id="L666">        boolean requiresUpdate = false;</span>
        
<span class="nc" id="L668">        File categoriesFile = new File(activity.getFilesDir().getAbsolutePath() + &quot;/&quot; + FILE_NAME_NOTIFICATION_CATEGORIES);</span>
<span class="nc bnc" id="L669" title="All 2 branches missed.">        if (!categoriesFile.exists()) {</span>
<span class="nc" id="L670">            requiresUpdate = true;</span>
        }
<span class="nc bnc" id="L672" title="All 2 branches missed.">        if (!requiresUpdate) {</span>
            try {
<span class="nc" id="L674">                PackageInfo packageInfo = context.getPackageManager().getPackageInfo(context.getApplicationContext().getPackageName(), PackageManager.GET_PERMISSIONS);</span>
<span class="nc bnc" id="L675" title="All 2 branches missed.">                if (packageInfo.lastUpdateTime &gt; categoriesFile.lastModified()) {</span>
<span class="nc" id="L676">                    requiresUpdate = true;</span>
                }
<span class="nc" id="L678">            } catch (Exception ex) {</span>
<span class="nc" id="L679">                ex.printStackTrace();</span>
<span class="nc" id="L680">            }</span>
        }
        
<span class="nc bnc" id="L683" title="All 2 branches missed.">        if (!requiresUpdate) {</span>
<span class="nc" id="L684">            return;</span>
        }
        
<span class="nc" id="L687">        OutputStream os = getContext().openFileOutput(FILE_NAME_NOTIFICATION_CATEGORIES, 0);</span>
<span class="nc" id="L688">        PushActionCategory[] categories = provider.getPushActionCategories();</span>
<span class="nc" id="L689">        javax.xml.parsers.DocumentBuilderFactory docFactory = javax.xml.parsers.DocumentBuilderFactory.newInstance();</span>
        javax.xml.parsers.DocumentBuilder docBuilder;
        try {
<span class="nc" id="L692">            docBuilder = docFactory.newDocumentBuilder();</span>
<span class="nc" id="L693">        } catch (ParserConfigurationException ex) {</span>
<span class="nc" id="L694">            Logger.getLogger(AndroidImplementation.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L695">            throw new IOException(&quot;Faield to create document builder for creating notification categories XML document&quot;, ex);</span>
<span class="nc" id="L696">        }</span>

        // root elements
<span class="nc" id="L699">        org.w3c.dom.Document doc = docBuilder.newDocument();</span>
<span class="nc" id="L700">        org.w3c.dom.Element root = (org.w3c.dom.Element)doc.createElement(&quot;categories&quot;);</span>
<span class="nc" id="L701">        doc.appendChild(root);</span>
<span class="nc bnc" id="L702" title="All 2 branches missed.">        for (PushActionCategory category : categories) {</span>
<span class="nc" id="L703">            org.w3c.dom.Element categoryEl = (org.w3c.dom.Element)doc.createElement(&quot;category&quot;);</span>
<span class="nc" id="L704">            org.w3c.dom.Attr idAttr = doc.createAttribute(&quot;id&quot;);</span>
<span class="nc" id="L705">            idAttr.setValue(category.getId());</span>
<span class="nc" id="L706">            categoryEl.setAttributeNode(idAttr);</span>
            
<span class="nc bnc" id="L708" title="All 2 branches missed.">            for (PushAction action : category.getActions()) {</span>
<span class="nc" id="L709">                org.w3c.dom.Element actionEl = (org.w3c.dom.Element)doc.createElement(&quot;action&quot;);</span>
<span class="nc" id="L710">                org.w3c.dom.Attr actionIdAttr = doc.createAttribute(&quot;id&quot;);</span>
<span class="nc" id="L711">                actionIdAttr.setValue(action.getId());</span>
<span class="nc" id="L712">                actionEl.setAttributeNode(actionIdAttr);</span>
                
                
<span class="nc" id="L715">                org.w3c.dom.Attr actionTitleAttr = doc.createAttribute(&quot;title&quot;);</span>
<span class="nc bnc" id="L716" title="All 2 branches missed.">                if (action.getTitle() != null) {</span>
<span class="nc" id="L717">                    actionTitleAttr.setValue(action.getTitle());</span>
                } else {
<span class="nc" id="L719">                    actionTitleAttr.setValue(action.getId());</span>
                }
<span class="nc" id="L721">                actionEl.setAttributeNode(actionTitleAttr);</span>
                
<span class="nc bnc" id="L723" title="All 2 branches missed.">                if (action.getIcon() != null) {</span>
<span class="nc" id="L724">                    org.w3c.dom.Attr actionIconAttr = doc.createAttribute(&quot;icon&quot;);</span>
<span class="nc" id="L725">                    String iconVal = action.getIcon();</span>
                    try {
                        // We'll store the resource IDs for the icon
                        // rather than the icon name because that is what
                        // the push notifications require.
<span class="nc" id="L730">                        iconVal = &quot;&quot;+context.getResources().getIdentifier(iconVal, &quot;drawable&quot;, context.getPackageName());</span>
<span class="nc" id="L731">                        actionIconAttr.setValue(iconVal);</span>
<span class="nc" id="L732">                        actionEl.setAttributeNode(actionIconAttr);</span>
<span class="nc" id="L733">                    } catch (Exception ex) {</span>
<span class="nc" id="L734">                        ex.printStackTrace();</span>
                        
<span class="nc" id="L736">                    }</span>
                    
                }
                
<span class="nc bnc" id="L740" title="All 2 branches missed.">                if (action.getTextInputPlaceholder() != null) {</span>
<span class="nc" id="L741">                    org.w3c.dom.Attr textInputPlaceholderAttr = doc.createAttribute(&quot;textInputPlaceholder&quot;);</span>
<span class="nc" id="L742">                    textInputPlaceholderAttr.setValue(action.getTextInputPlaceholder());</span>
<span class="nc" id="L743">                    actionEl.setAttributeNode(textInputPlaceholderAttr);</span>
                }
<span class="nc bnc" id="L745" title="All 2 branches missed.">                if (action.getTextInputButtonText() != null) {</span>
<span class="nc" id="L746">                    org.w3c.dom.Attr textInputButtonTextAttr = doc.createAttribute(&quot;textInputButtonText&quot;);</span>
<span class="nc" id="L747">                    textInputButtonTextAttr.setValue(action.getTextInputButtonText());</span>
<span class="nc" id="L748">                    actionEl.setAttributeNode(textInputButtonTextAttr);</span>
                }
<span class="nc" id="L750">                categoryEl.appendChild(actionEl);</span>
            }
<span class="nc" id="L752">            root.appendChild(categoryEl);</span>
            
        }
        try {
<span class="nc" id="L756">            javax.xml.transform.TransformerFactory transformerFactory = javax.xml.transform.TransformerFactory.newInstance();</span>
<span class="nc" id="L757">            javax.xml.transform.Transformer transformer = transformerFactory.newTransformer();</span>
<span class="nc" id="L758">            javax.xml.transform.dom.DOMSource source = new javax.xml.transform.dom.DOMSource(doc);</span>
<span class="nc" id="L759">            javax.xml.transform.stream.StreamResult result = new javax.xml.transform.stream.StreamResult(os);</span>
<span class="nc" id="L760">            transformer.transform(source, result);</span>
            
<span class="nc" id="L762">        } catch (Exception ex) {</span>
<span class="nc" id="L763">            throw new IOException(&quot;Failed to save notification categories as XML.&quot;, ex);</span>
<span class="nc" id="L764">        }</span>
        
<span class="nc" id="L766">    }</span>
    
    /**
     * Retrieves the app's available push action categories from the XML file in which they
     * should have been installed on the first load.
     * @param context
     * @return
     * @throws IOException 
     */
    private static PushActionCategory[] getInstalledPushActionCategories(Context context) throws IOException {
        // NOTE:  This method may be called from the PushReceiver when the app isn't running so we can't access
        // the main activity context, display properties, or any CN1 stuff.  Just native android
        
<span class="nc" id="L779">        File categoriesFile = new File(context.getFilesDir().getAbsolutePath() + &quot;/&quot; + FILE_NAME_NOTIFICATION_CATEGORIES);</span>
<span class="nc bnc" id="L780" title="All 2 branches missed.">        if (!categoriesFile.exists()) {</span>
<span class="nc" id="L781">            return new PushActionCategory[0];</span>
        }
<span class="nc" id="L783">        javax.xml.parsers.DocumentBuilderFactory docFactory = javax.xml.parsers.DocumentBuilderFactory.newInstance();</span>
        javax.xml.parsers.DocumentBuilder docBuilder;
        try {
<span class="nc" id="L786">            docBuilder = docFactory.newDocumentBuilder();</span>
<span class="nc" id="L787">        } catch (ParserConfigurationException ex) {</span>
<span class="nc" id="L788">            Logger.getLogger(AndroidImplementation.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L789">            throw new IOException(&quot;Faield to create document builder for creating notification categories XML document&quot;, ex);</span>
<span class="nc" id="L790">        }</span>
        org.w3c.dom.Document doc;
        try {
<span class="nc" id="L793">            doc = docBuilder.parse(context.openFileInput(FILE_NAME_NOTIFICATION_CATEGORIES));</span>
<span class="nc" id="L794">        } catch (SAXException ex) {</span>
<span class="nc" id="L795">            Logger.getLogger(AndroidImplementation.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L796">            throw new IOException(&quot;Failed to parse instaled push action categories&quot;, ex);</span>
<span class="nc" id="L797">        }</span>
<span class="nc" id="L798">        org.w3c.dom.Element root = doc.getDocumentElement();</span>
<span class="nc" id="L799">        java.util.List&lt;PushActionCategory&gt; out = new ArrayList&lt;PushActionCategory&gt;();</span>
<span class="nc" id="L800">        org.w3c.dom.NodeList l = root.getElementsByTagName(&quot;category&quot;);</span>
<span class="nc" id="L801">        int len = l.getLength();</span>
<span class="nc bnc" id="L802" title="All 2 branches missed.">        for (int i=0; i&lt;len; i++) {</span>
<span class="nc" id="L803">            org.w3c.dom.Element el = (org.w3c.dom.Element)l.item(i);</span>
<span class="nc" id="L804">            java.util.List&lt;PushAction&gt; actions = new ArrayList&lt;PushAction&gt;();</span>
<span class="nc" id="L805">            org.w3c.dom.NodeList al = el.getElementsByTagName(&quot;action&quot;);</span>
<span class="nc" id="L806">            int alen = al.getLength();</span>
<span class="nc bnc" id="L807" title="All 2 branches missed.">            for (int j=0; j&lt;alen; j++) {</span>
<span class="nc" id="L808">                org.w3c.dom.Element actionEl = (org.w3c.dom.Element)al.item(j);</span>
<span class="nc bnc" id="L809" title="All 2 branches missed.">                String textInputPlaceholder = actionEl.hasAttribute(&quot;textInputPlaceholder&quot;) ? actionEl.getAttribute(&quot;textInputPlaceholder&quot;) : null;</span>
<span class="nc bnc" id="L810" title="All 2 branches missed.">                String textInputButtonText = actionEl.hasAttribute(&quot;textInputButtonText&quot;) ? actionEl.getAttribute(&quot;textInputButtonText&quot;) : null;</span>
<span class="nc" id="L811">                PushAction action = new PushAction(actionEl.getAttribute(&quot;id&quot;), actionEl.getAttribute(&quot;title&quot;), actionEl.getAttribute(&quot;icon&quot;), textInputPlaceholder, textInputButtonText);</span>
<span class="nc" id="L812">                actions.add(action);</span>
            }
            
<span class="nc" id="L815">            PushActionCategory cat = new PushActionCategory((String)el.getAttribute(&quot;id&quot;), actions.toArray(new PushAction[actions.size()]));</span>
<span class="nc" id="L816">            out.add(cat);</span>
            
        }
<span class="nc" id="L819">        return out.toArray(new PushActionCategory[out.size()]);</span>
    }

    public static PendingIntent createPendingIntent(Context ctx, int value, Intent intent) {
<span class="nc bnc" id="L823" title="All 2 branches missed.">        if (android.os.Build.VERSION.SDK_INT &gt;= 23) {</span>
<span class="nc" id="L824">            return PendingIntent.getActivity(ctx, value, intent, FLAG_IMMUTABLE);</span>
        } else {
<span class="nc" id="L826">            return PendingIntent.getActivity(ctx, value, intent, PendingIntent.FLAG_CANCEL_CURRENT);</span>
        }
    }

    public static PendingIntent createMutablePendingIntent(Context ctx, int value, Intent intent) {
<span class="nc bnc" id="L831" title="All 2 branches missed.">        if (android.os.Build.VERSION.SDK_INT &gt;= 23) {</span>
<span class="nc" id="L832">            return PendingIntent.getActivity(ctx, value, intent, FLAG_MUTABLE);</span>
        } else {
<span class="nc" id="L834">            return PendingIntent.getActivity(ctx, value, intent, PendingIntent.FLAG_CANCEL_CURRENT);</span>
        }
    }

    public static PendingIntent getPendingIntent(Context ctx, int value, Intent intent) {
<span class="nc bnc" id="L839" title="All 2 branches missed.">        if (android.os.Build.VERSION.SDK_INT &gt;= 23) {</span>
<span class="nc" id="L840">            return PendingIntent.getService(ctx, value, intent, FLAG_IMMUTABLE);</span>
        } else {
<span class="nc" id="L842">            return PendingIntent.getService(ctx, value, intent, PendingIntent.FLAG_CANCEL_CURRENT);</span>
        }
    }

    public static PendingIntent getBroadcastPendingIntent(Context ctx, int value, Intent intent) {
<span class="nc bnc" id="L847" title="All 2 branches missed.">        if (android.os.Build.VERSION.SDK_INT &gt;= 23) {</span>
            // PendingIntent.FLAG_IMMUTABLE
<span class="nc" id="L849">            return PendingIntent.getBroadcast(ctx, value, intent, 67108864);</span>
        } else {
<span class="nc" id="L851">            return PendingIntent.getBroadcast(ctx, value, intent, PendingIntent.FLAG_CANCEL_CURRENT);</span>
        }
    }

    /**
     * Adds actions to a push notification.  This is called by the Push broadcast receiver probably before 
     * Codename One is initialized
     * @param provider Reference to the app's main class which implements PushActionsProvider
     * @param categoryId The category ID of the push notification.
     * @param builder The builder for the push notification.
     * @param targetIntent The target intent... this should go to the app's main Activity.
     * @param context The current context (inside the Broadcast receiver).
     * @throws IOException 
     */
    public static void addActionsToNotification(PushActionsProvider provider, String categoryId, NotificationCompat.Builder builder, Intent targetIntent, Context context) throws IOException {
        // NOTE:  THis will likely run when the main activity isn't running so we won't have
        // access to any display properties... just native Android APIs will be accessible.
        
<span class="nc" id="L869">        PushActionCategory category = null;</span>
        PushActionCategory[] categories;
<span class="nc bnc" id="L871" title="All 2 branches missed.">        if (provider != null) {</span>
<span class="nc" id="L872">            categories = provider.getPushActionCategories();</span>
        } else {
<span class="nc" id="L874">            categories = getInstalledPushActionCategories(context);</span>
        }
<span class="nc bnc" id="L876" title="All 2 branches missed.">        for (PushActionCategory candidateCategory : categories) {</span>
<span class="nc bnc" id="L877" title="All 2 branches missed.">            if (categoryId.equals(candidateCategory.getId())) {</span>
<span class="nc" id="L878">                category = candidateCategory;</span>
<span class="nc" id="L879">                break;</span>
            }
        }
<span class="nc bnc" id="L882" title="All 2 branches missed.">        if (category == null) {</span>
<span class="nc" id="L883">            return;</span>
        }
        
<span class="nc" id="L886">        int requestCode = 1;</span>
<span class="nc bnc" id="L887" title="All 2 branches missed.">        for (PushAction action : category.getActions()) {</span>
<span class="nc" id="L888">            Intent newIntent = (Intent)targetIntent.clone();</span>
<span class="nc" id="L889">            newIntent.putExtra(&quot;pushActionId&quot;, action.getId());</span>
<span class="nc" id="L890">            PendingIntent contentIntent = createMutablePendingIntent(context, requestCode++, newIntent);</span>
            try {
                int iconId;
                try {
<span class="nc" id="L894">                    iconId = Integer.parseInt(action.getIcon());</span>
<span class="nc" id="L895">                } catch (NumberFormatException ex) {</span>
<span class="nc" id="L896">                    iconId = 0;</span>
<span class="nc" id="L897">                }</span>
<span class="nc bnc" id="L898" title="All 2 branches missed.">                if (ActionWrapper.BuilderWrapper.isSupported()) {</span>
                    // We need to take this abstracted &quot;wrapper&quot; approach because the Action.Builder class, and RemoteInput class
                    // aren't available until API 22.
                    // These classes use reflection to provide support for these classes safely.
<span class="nc" id="L902">                    ActionWrapper.BuilderWrapper actionBuilder = new ActionWrapper.BuilderWrapper(iconId, action.getTitle(), contentIntent);</span>
<span class="nc bnc" id="L903" title="All 4 branches missed.">                    if (action.getTextInputPlaceholder() != null &amp;&amp; RemoteInputWrapper.isSupported()) {</span>
<span class="nc" id="L904">                        RemoteInputWrapper.BuilderWrapper remoteInputBuilder = new RemoteInputWrapper.BuilderWrapper(action.getId()+&quot;$Result&quot;);</span>
<span class="nc" id="L905">                        remoteInputBuilder.setLabel(action.getTextInputPlaceholder());</span>

<span class="nc" id="L907">                        RemoteInputWrapper remoteInput = remoteInputBuilder.build();</span>
<span class="nc" id="L908">                        actionBuilder.addRemoteInput(remoteInput);</span>
                    }
<span class="nc" id="L910">                    ActionWrapper actionWrapper = actionBuilder.build();</span>
<span class="nc" id="L911">                    new NotificationCompatWrapper.BuilderWrapper(builder).addAction(actionWrapper);</span>
<span class="nc" id="L912">                } else {</span>
<span class="nc" id="L913">                    builder.addAction(iconId, action.getTitle(), contentIntent);</span>
                }
<span class="nc" id="L915">            } catch (Exception ex) {</span>
<span class="nc" id="L916">                ex.printStackTrace();</span>
<span class="nc" id="L917">            }</span>
        }
        
<span class="nc" id="L920">    }</span>
    
    public static void firePendingPushes(final PushCallback c, final Context a) {
        try {
<span class="nc bnc" id="L924" title="All 2 branches missed.">            if(c != null) {</span>
<span class="nc" id="L925">                InputStream i = a.openFileInput(&quot;CN1$AndroidPendingNotifications&quot;);</span>
<span class="nc bnc" id="L926" title="All 2 branches missed.">                if(i == null) {</span>
<span class="nc" id="L927">                    return;</span>
                }
<span class="nc" id="L929">                DataInputStream is = new DataInputStream(i);</span>
<span class="nc" id="L930">                int count = is.readByte();</span>
<span class="nc bnc" id="L931" title="All 2 branches missed.">                for(int iter = 0 ; iter &lt; count ; iter++) {</span>
<span class="nc" id="L932">                    boolean hasType = is.readBoolean();</span>
<span class="nc" id="L933">                    String actualType = null;</span>
<span class="nc bnc" id="L934" title="All 2 branches missed.">                    if(hasType) {</span>
<span class="nc" id="L935">                        actualType = is.readUTF();</span>
                    }
                    final String t;
                    final String b;
                    final String category;
                    final String image;
<span class="nc bnc" id="L941" title="All 2 branches missed.">                    if (&quot;99&quot;.equals(actualType)) {</span>
                        // This was a rich push
<span class="nc" id="L943">                        Map&lt;String,String&gt; vals = splitQuery(is.readUTF());</span>
<span class="nc" id="L944">                        t = vals.get(&quot;type&quot;);</span>
<span class="nc" id="L945">                        b = vals.get(&quot;body&quot;);</span>
<span class="nc" id="L946">                        category = vals.get(&quot;category&quot;);</span>
<span class="nc" id="L947">                        image = vals.get(&quot;image&quot;);</span>
<span class="nc" id="L948">                    } else {</span>
<span class="nc" id="L949">                        t = actualType;</span>
<span class="nc" id="L950">                        b = is.readUTF();</span>
<span class="nc" id="L951">                        category = null;</span>
<span class="nc" id="L952">                        image = null;</span>
                    }
<span class="nc" id="L954">                    long s = is.readLong();</span>
<span class="nc" id="L955">                    Display.getInstance().callSerially(new Runnable() {</span>
                        @Override
                        public void run() {
<span class="nc" id="L958">                            Display.getInstance().setProperty(&quot;pendingPush&quot;, &quot;true&quot;);</span>
<span class="nc" id="L959">                            Display.getInstance().setProperty(&quot;pushType&quot;, t);</span>
<span class="nc" id="L960">                            initPushContent(b, image, t, category, a);</span>
<span class="nc bnc" id="L961" title="All 6 branches missed.">                            if(t != null &amp;&amp; (&quot;3&quot;.equals(t) || &quot;6&quot;.equals(t))) {</span>
<span class="nc" id="L962">                                String[] a = b.split(&quot;;&quot;);</span>
<span class="nc" id="L963">                                c.push(a[0]);</span>
<span class="nc" id="L964">                                c.push(a[1]);</span>
<span class="nc bnc" id="L965" title="All 4 branches missed.">                            } else if (t != null &amp;&amp; (&quot;101&quot;.equals(t))) {</span>
<span class="nc" id="L966">                                c.push(b.substring(b.indexOf(&quot; &quot;)+1));</span>
                            } else {
<span class="nc" id="L968">                                c.push(b);</span>
                            }
<span class="nc" id="L970">                            Display.getInstance().setProperty(&quot;pendingPush&quot;, null);</span>
<span class="nc" id="L971">                        }</span>
                    });
                }
<span class="nc" id="L974">                a.deleteFile(&quot;CN1$AndroidPendingNotifications&quot;);</span>
            }
<span class="nc" id="L976">        } catch(IOException err) {</span>
<span class="nc" id="L977">        }</span>
<span class="nc" id="L978">    }</span>

    public static String[] getPendingPush(String type, Context a) {
<span class="nc" id="L981">        InputStream i = null;</span>
        try {
<span class="nc" id="L983">            i = a.openFileInput(&quot;CN1$AndroidPendingNotifications&quot;);</span>
<span class="nc bnc" id="L984" title="All 2 branches missed.">            if (i == null) {</span>
<span class="nc" id="L985">                return null;</span>
            }
<span class="nc" id="L987">            DataInputStream is = new DataInputStream(i);</span>
<span class="nc" id="L988">            int count = is.readByte();</span>
<span class="nc" id="L989">            Vector v = new Vector&lt;String&gt;();</span>
<span class="nc bnc" id="L990" title="All 2 branches missed.">            for (int iter = 0; iter &lt; count; iter++) {</span>
<span class="nc" id="L991">                boolean hasType = is.readBoolean();</span>
<span class="nc" id="L992">                String actualType = null;</span>
<span class="nc bnc" id="L993" title="All 2 branches missed.">                if (hasType) {</span>
<span class="nc" id="L994">                    actualType = is.readUTF();</span>
                }
                
                final String t;
                final String b;
<span class="nc bnc" id="L999" title="All 2 branches missed.">                if (&quot;99&quot;.equals(actualType)) {</span>
                    // This was a rich push
<span class="nc" id="L1001">                    Map&lt;String,String&gt; vals = splitQuery(is.readUTF());</span>
<span class="nc" id="L1002">                    t = vals.get(&quot;type&quot;);</span>
<span class="nc" id="L1003">                    b = vals.get(&quot;body&quot;);</span>
                    //category = vals.get(&quot;category&quot;);
                    //image = vals.get(&quot;image&quot;);
<span class="nc" id="L1006">                } else {</span>
<span class="nc" id="L1007">                    t = actualType;</span>
<span class="nc" id="L1008">                    b = is.readUTF();</span>
                    //category = null;
                    //image = null;
                }
<span class="nc" id="L1012">                long s = is.readLong();</span>
<span class="nc bnc" id="L1013" title="All 6 branches missed.">                if(t != null &amp;&amp; (&quot;3&quot;.equals(t) || &quot;6&quot;.equals(t))) {</span>
<span class="nc" id="L1014">                    String[] m = b.split(&quot;;&quot;);</span>
<span class="nc" id="L1015">                    v.add(m[0]);</span>
<span class="nc bnc" id="L1016" title="All 4 branches missed.">                } else if(t != null &amp;&amp; &quot;4&quot;.equals(t)){</span>
<span class="nc" id="L1017">                    String[] m = b.split(&quot;;&quot;);</span>
<span class="nc" id="L1018">                    v.add(m[1]);</span>
<span class="nc bnc" id="L1019" title="All 4 branches missed.">                } else if(t != null &amp;&amp; &quot;2&quot;.equals(t)){</span>
<span class="nc" id="L1020">                    continue;</span>
<span class="nc bnc" id="L1021" title="All 4 branches missed.">                }else if (t != null &amp;&amp; &quot;101&quot;.equals(t)) {</span>
<span class="nc" id="L1022">                    v.add(b.substring(b.indexOf(&quot; &quot;)+1));</span>
                }else{
<span class="nc" id="L1024">                    v.add(b);</span>
                }
            }
<span class="nc" id="L1027">            String [] retVal = new String[v.size()];</span>
<span class="nc bnc" id="L1028" title="All 2 branches missed.">            for (int j = 0; j &lt; retVal.length; j++) {</span>
<span class="nc" id="L1029">                retVal[j] = (String)v.get(j);</span>
            }
<span class="nc" id="L1031">            return retVal;</span>

<span class="nc" id="L1033">        } catch (Exception ex) {</span>
<span class="nc" id="L1034">            ex.printStackTrace();</span>
        } finally {
            try {
<span class="nc bnc" id="L1037" title="All 2 branches missed.">                if(i != null){</span>
<span class="nc" id="L1038">                    i.close();</span>
                }
<span class="nc" id="L1040">            } catch (IOException ex) {</span>
<span class="nc" id="L1041">            }</span>
        }
<span class="nc" id="L1043">        return null;</span>
    }

    private static AndroidImplementation instance;

    public static AndroidImplementation getInstance() {
<span class="fc" id="L1049">        return instance;</span>
    }

    public static void clearAppArg() {
<span class="pc bpc" id="L1053" title="1 of 2 branches missed.">        if (instance != null) {</span>
<span class="fc" id="L1054">            instance.setAppArg(null);</span>
        }
<span class="fc" id="L1056">    }</span>

    public static Context getContext() {
<span class="fc" id="L1059">        Context out = getActivity();</span>
<span class="pc bpc" id="L1060" title="1 of 2 branches missed.">        if (out != null) {</span>
<span class="fc" id="L1061">            return out;</span>
        }
<span class="nc" id="L1063">        return context;</span>
    }

    public void setContext(Context c) {
<span class="fc" id="L1067">        context = c;</span>
<span class="fc" id="L1068">    }</span>

    @Override
    public void init(Object m) {
        // NOTE:  Do not explicitly set the PlayServices instance to anything other than
        // an instance of the base PlayServices class.  The Build Server will automatically
        // swap this for the appropriate subclass depending on the playServicesVersion of 
        // the build.
        //PlayServices.setInstance(new PlayServices()); // &lt;---- DO NOT CHANGE - Build server will replace with appropriate subclass instance
<span class="pc bpc" id="L1077" title="1 of 2 branches missed.">        if (m instanceof CodenameOneActivity) {</span>
<span class="fc" id="L1078">            setContext(null);</span>
<span class="fc" id="L1079">            setActivity((CodenameOneActivity) m);</span>
        } else {
<span class="nc" id="L1081">            setActivity(null);</span>
<span class="nc" id="L1082">            setContext((Context)m);</span>
        }

<span class="fc" id="L1085">        instance = this;</span>
<span class="pc bpc" id="L1086" title="2 of 4 branches missed.">        if(getActivity() != null &amp;&amp; getActivity().hasUI()){</span>
<span class="pc bpc" id="L1087" title="1 of 2 branches missed.">            if (!hasActionBar()) {</span>
                try {
<span class="nc" id="L1089">                    getActivity().requestWindowFeature(Window.FEATURE_NO_TITLE);</span>
<span class="nc" id="L1090">                } catch (Exception e) {</span>
<span class="nc" id="L1091">                    com.codename1.io.Log.p(&quot;requestWindowFeature FEATURE_NO_TITLE threw exception: &quot; + e.toString());</span>
<span class="nc" id="L1092">                }</span>
            } else {
<span class="fc" id="L1094">                getActivity().invalidateOptionsMenu();</span>
                try {
<span class="fc" id="L1096">                    getActivity().requestWindowFeature(Window.FEATURE_ACTION_BAR);</span>
<span class="fc" id="L1097">                    getActivity().requestWindowFeature(Window.FEATURE_PROGRESS);</span>

<span class="pc bpc" id="L1099" title="1 of 2 branches missed.">                    if(android.os.Build.VERSION.SDK_INT &gt;= 21){</span>
                        //WindowManager.LayoutParams.FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS
<span class="fc" id="L1101">                        getActivity().getWindow().addFlags(-2147483648);</span>
                    }
<span class="nc" id="L1103">                } catch (Exception e) {</span>
                    //Log.d(&quot;Codename One&quot;, &quot;No idea why this throws a Runtime Error&quot;, e);
<span class="fc" id="L1105">                }</span>
<span class="fc" id="L1106">                NotifyActionBar notify = new NotifyActionBar(getActivity(), false);</span>
<span class="fc" id="L1107">                notify.run();</span>
            }

<span class="pc bpc" id="L1110" title="1 of 2 branches missed.">            if(statusBarHidden) {</span>
<span class="nc" id="L1111">                getActivity().getWindow().getDecorView().setSystemUiVisibility(View.SYSTEM_UI_FLAG_LAYOUT_STABLE</span>
                        | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN);
<span class="nc" id="L1113">                getActivity().getWindow().setStatusBarColor(android.graphics.Color.TRANSPARENT);</span>
            }

<span class="pc bpc" id="L1116" title="1 of 2 branches missed.">            if(Display.getInstance().getProperty(&quot;StatusbarHidden&quot;, &quot;&quot;).equals(&quot;true&quot;)){</span>
<span class="nc" id="L1117">                getActivity().getWindow().setFlags(WindowManager.LayoutParams.FLAG_FULLSCREEN, WindowManager.LayoutParams.FLAG_FULLSCREEN);</span>
            }

<span class="pc bpc" id="L1120" title="1 of 2 branches missed.">            if(Display.getInstance().getProperty(&quot;KeepScreenOn&quot;, &quot;&quot;).equals(&quot;true&quot;)){</span>
<span class="nc" id="L1121">                getActivity().getWindow().addFlags(WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON);</span>
            }

<span class="pc bpc" id="L1124" title="1 of 2 branches missed.">            if(Display.getInstance().getProperty(&quot;DisableScreenshots&quot;, &quot;&quot;).equals(&quot;true&quot;)){</span>
<span class="nc" id="L1125">                getActivity().getWindow().addFlags(WindowManager.LayoutParams.FLAG_SECURE);</span>
            }

<span class="pc bpc" id="L1128" title="1 of 2 branches missed.">            if (m instanceof CodenameOneActivity) {</span>
<span class="fc" id="L1129">                ((CodenameOneActivity) m).setDefaultIntentResultListener(this);</span>
<span class="fc" id="L1130">                ((CodenameOneActivity) m).setIntentResultListener(this);</span>
            }

            /**
             * translate our default font height depending on the screen density.
             * this is required for new high resolution devices. otherwise
             * everything looks awfully small.
             *
             * we use our default font height value of 16 and go from there. i
             * thought about using new Paint().getTextSize() for this value but if
             * some new version of android suddenly returns values already tranlated
             * to the screen then we might end up with too large fonts. the
             * documentation is not very precise on that.
             */
<span class="fc" id="L1144">            final int defaultFontPixelHeight = 16;</span>
<span class="fc" id="L1145">            this.defaultFontHeight = this.translatePixelForDPI(defaultFontPixelHeight);</span>


<span class="fc" id="L1148">            this.defaultFont = (CodenameOneTextPaint) ((NativeFont) this.createFont(Font.FACE_SYSTEM, Font.STYLE_PLAIN, Font.SIZE_MEDIUM)).font;</span>
<span class="fc" id="L1149">            Display.getInstance().setTransitionYield(-1);</span>

<span class="fc" id="L1151">            initSurface();</span>
            /**
             * devices are extremely sensitive so dragging should start a little
             * later than suggested by default implementation.
             */
<span class="fc" id="L1156">            this.setDragStartPercentage(1);</span>
<span class="fc" id="L1157">            VirtualKeyboardInterface vkb = new AndroidKeyboard(this);</span>
<span class="fc" id="L1158">            Display.getInstance().registerVirtualKeyboard(vkb);</span>
<span class="fc" id="L1159">            Display.getInstance().setDefaultVirtualKeyboard(vkb);</span>

<span class="fc" id="L1161">            InPlaceEditView.endEdit();</span>

<span class="fc" id="L1163">            getActivity().getWindow().setSoftInputMode(WindowManager.LayoutParams.SOFT_INPUT_STATE_ALWAYS_HIDDEN);</span>

<span class="pc bpc" id="L1165" title="1 of 2 branches missed.">            if (nativePeers.size() &gt; 0) {</span>
<span class="nc bnc" id="L1166" title="All 2 branches missed.">                for (int i = 0; i &lt; nativePeers.size(); i++) {</span>
<span class="nc" id="L1167">                    ((AndroidImplementation.AndroidPeer) nativePeers.elementAt(i)).init();</span>
                }
            }
<span class="fc" id="L1170">        } else {</span>
            /**
             * translate our default font height depending on the screen density.
             * this is required for new high resolution devices. otherwise
             * everything looks awfully small.
             *
             * we use our default font height value of 16 and go from there. i
             * thought about using new Paint().getTextSize() for this value but if
             * some new version of android suddenly returns values already tranlated
             * to the screen then we might end up with too large fonts. the
             * documentation is not very precise on that.
             */
<span class="nc" id="L1182">            final int defaultFontPixelHeight = 16;</span>
<span class="nc" id="L1183">            this.defaultFontHeight = this.translatePixelForDPI(defaultFontPixelHeight);</span>


<span class="nc" id="L1186">            this.defaultFont = (CodenameOneTextPaint) ((NativeFont) this.createFont(Font.FACE_SYSTEM, Font.STYLE_PLAIN, Font.SIZE_MEDIUM)).font;</span>
        }
<span class="fc" id="L1188">        HttpURLConnection.setFollowRedirects(false);</span>
<span class="fc" id="L1189">        CookieHandler.setDefault(null);</span>
<span class="fc" id="L1190">        VideoCaptureConstraints.init(new AndroidVideoCaptureConstraintsCompiler());</span>
<span class="fc" id="L1191">    }</span>



    @Override
    public boolean isInitialized(){
// Removing the check for null view to prevent strange things from happening when
// calling from a Service context.
//        if(getActivity() != null &amp;&amp; myView == null){
//            //if the view is null deinitialize the Display
//            if(super.isInitialized()){
//                syncDeinitialize();
//            }
//            return false;
//        }
<span class="fc" id="L1206">        return super.isInitialized();</span>
    }

    /**
     * Reinitializes CN1.
     * @param i Context to initialize it with.
     *
     * @see #startContext(Context)
     */
    private static void reinit(Object i) {
<span class="nc bnc" id="L1216" title="All 6 branches missed.">        if (instance != null &amp;&amp; ((i instanceof CodenameOneActivity) || instance.myView == null)) {</span>
<span class="nc" id="L1217">            instance.init(i);</span>
        }
<span class="nc" id="L1219">        Display.init(i);</span>

        // This is a hack to fix an issue that caused the screen to appear blank when
        // the app is loaded from memory after being unloaded.

        // This issue only seems to occur when the Activity had been unloaded
        // so to test this you'll need to check the &quot;Don't keep activities&quot; checkbox under/
        // Developer options.
        // Developer options.
<span class="nc" id="L1228">        Display.getInstance().callSerially(new Runnable() {</span>
            public void run() {
<span class="nc" id="L1230">                Display.getInstance().invokeAndBlock(new Runnable(){ public void run(){</span>
<span class="nc" id="L1231">                    Util.sleep(50);</span>
<span class="nc" id="L1232">                }});</span>
<span class="nc bnc" id="L1233" title="All 4 branches missed.">                if (!Display.isInitialized() || Display.getInstance().isMinimized()) {</span>
<span class="nc" id="L1234">                    return;</span>
                }
<span class="nc" id="L1236">                Form cur = Display.getInstance().getCurrent();</span>
<span class="nc bnc" id="L1237" title="All 2 branches missed.">                if (cur != null) {</span>
<span class="nc" id="L1238">                    cur.forceRevalidate();</span>
                }
<span class="nc" id="L1240">            }</span>

        });
<span class="nc" id="L1243">    }</span>

    private static class InvalidateOptionsMenuImpl implements Runnable {
        private Activity activity;

<span class="nc" id="L1248">        public InvalidateOptionsMenuImpl(Activity activity) {</span>
<span class="nc" id="L1249">            this.activity = activity;</span>
<span class="nc" id="L1250">        }</span>

        @Override
        public void run() {
<span class="nc" id="L1254">            activity.invalidateOptionsMenu();</span>
<span class="nc" id="L1255">        }</span>
    }

    @Override
    public Boolean isDarkMode() {
        try {
<span class="nc" id="L1261">            int nightModeFlags = getActivity().getResources().getConfiguration().uiMode &amp; Configuration.UI_MODE_NIGHT_MASK; </span>
<span class="nc bnc" id="L1262" title="All 3 branches missed.">            switch (nightModeFlags) { </span>
                case Configuration.UI_MODE_NIGHT_YES: 
<span class="nc" id="L1264">                    return true;</span>
                case Configuration.UI_MODE_NIGHT_NO: 
<span class="nc" id="L1266">                    return false;</span>
                default: 
<span class="nc" id="L1268">                    return null;</span>
            } 
<span class="nc" id="L1270">        } catch(Throwable t) {</span>
<span class="nc" id="L1271">            return null;</span>
        }
    }

    @Override
    public boolean isLargerTextEnabled() {
<span class="nc bnc" id="L1277" title="All 2 branches missed.">        return getLargerTextScale() &gt; 1.0f;</span>
    }

    @Override
    public float getLargerTextScale() {
        try {
            Configuration configuration;
<span class="nc bnc" id="L1284" title="All 2 branches missed.">            if (getActivity() != null) {</span>
<span class="nc" id="L1285">                configuration = getActivity().getResources().getConfiguration();</span>
            } else {
<span class="nc" id="L1287">                configuration = getContext().getResources().getConfiguration();</span>
            }
<span class="nc" id="L1289">            return configuration.fontScale;</span>
<span class="nc" id="L1290">        } catch (Throwable t) {</span>
<span class="nc" id="L1291">            return 1.0f;</span>
        }
    }

    
    private boolean hasActionBar() {
<span class="pc bpc" id="L1297" title="1 of 2 branches missed.">        return android.os.Build.VERSION.SDK_INT &gt;= 11;</span>
    }

    public int translatePixelForDPI(int pixel) {
<span class="fc" id="L1301">        return (int) TypedValue.applyDimension(TypedValue.COMPLEX_UNIT_SP, pixel,</span>
<span class="fc" id="L1302">                getContext().getResources().getDisplayMetrics());</span>
    }

    /**
     * Returns the platform EDT thread priority
     */
    public int getEDTThreadPriority(){
<span class="fc" id="L1309">        return Thread.NORM_PRIORITY;</span>
    }

    @Override
    public int getDeviceDensity() {
<span class="fc" id="L1314">        DisplayMetrics metrics = new DisplayMetrics();</span>
<span class="pc bpc" id="L1315" title="1 of 2 branches missed.">        if (getActivity() != null) {</span>
<span class="fc" id="L1316">            getActivity().getWindowManager().getDefaultDisplay().getMetrics(metrics);</span>
        } else {
<span class="nc" id="L1318">            metrics = getContext().getResources().getDisplayMetrics();</span>
        }

<span class="pc bpc" id="L1321" title="1 of 2 branches missed.">        if(metrics.densityDpi &lt; DisplayMetrics.DENSITY_MEDIUM) {</span>
<span class="nc" id="L1322">            return Display.DENSITY_LOW;</span>
        }

<span class="pc bpc" id="L1325" title="1 of 2 branches missed.">        if(metrics.densityDpi &lt; 213) {</span>
<span class="fc" id="L1326">            return Display.DENSITY_MEDIUM;</span>
        }

        // 213 == TV
<span class="nc bnc" id="L1330" title="All 4 branches missed.">        if(metrics.densityDpi &gt;= 213 &amp;&amp;  metrics.densityDpi &lt;= DisplayMetrics.DENSITY_HIGH) {</span>
<span class="nc" id="L1331">            return Display.DENSITY_HIGH;</span>
        }

<span class="nc bnc" id="L1334" title="All 4 branches missed.">        if(metrics.densityDpi &gt; DisplayMetrics.DENSITY_HIGH &amp;&amp; metrics.densityDpi &lt; 400) {</span>
<span class="nc" id="L1335">            return Display.DENSITY_VERY_HIGH;</span>
        }

<span class="nc bnc" id="L1338" title="All 4 branches missed.">        if(metrics.densityDpi &gt;= 400 &amp;&amp; metrics.densityDpi &lt; 560) {</span>
<span class="nc" id="L1339">            return Display.DENSITY_HD;</span>
        }

<span class="nc bnc" id="L1342" title="All 4 branches missed.">        if(metrics.densityDpi &gt;= 560 &amp;&amp; metrics.densityDpi &lt;= 640) {</span>
<span class="nc" id="L1343">            return Display.DENSITY_2HD;</span>
        }
<span class="nc bnc" id="L1345" title="All 2 branches missed.">        if(metrics.densityDpi &gt; 640) {</span>
<span class="nc" id="L1346">            return Display.DENSITY_4K;</span>
        }

<span class="nc" id="L1349">        return Display.DENSITY_MEDIUM;</span>
    }

    public static boolean isImmersive() {
<span class="pc bpc" id="L1353" title="1 of 2 branches missed.">        if (getActivity() == null) {</span>
<span class="nc" id="L1354">            return false;</span>
        }
<span class="fc" id="L1356">        return isImmersive(getActivity().getWindow());</span>
    }
    public static boolean isImmersive(Window window) {
<span class="pc bpc" id="L1359" title="1 of 2 branches missed.">        if (Build.VERSION.SDK_INT &gt;= 35) {</span>
            // Android 15+ is always immersive (overlay mode by default)
<span class="fc" id="L1361">            return true;</span>
        }
        // On Android 34 and below, we can't detect decorFitsSystemWindows
        // reliably at runtime. So the app must make the decision explicitly.
<span class="nc" id="L1365">        return false;</span>
    }
    public static Rect getSystemBarInsets(final View rootView) {
<span class="fc" id="L1368">        final Rect result = new Rect(0, 0, 0, 0);</span>
        try {
<span class="fc" id="L1370">            Object insets = View.class</span>
<span class="fc" id="L1371">                    .getMethod(&quot;getRootWindowInsets&quot;)</span>
<span class="fc" id="L1372">                    .invoke(rootView);</span>
<span class="pc bpc" id="L1373" title="1 of 2 branches missed.">            if (insets == null) return result;</span>
            // Get android.view.WindowInsets$Type.systemBars()
<span class="fc" id="L1375">            Class typeClass = Class.forName(&quot;android.view.WindowInsets$Type&quot;);</span>
<span class="fc" id="L1376">            int systemBarsMask = ((Integer) typeClass</span>
<span class="fc" id="L1377">                    .getMethod(&quot;systemBars&quot;)</span>
<span class="fc" id="L1378">                    .invoke(null)).intValue();</span>
            // Call insets.getInsets(int)
<span class="fc" id="L1380">            Object insetsObject = insets.getClass()</span>
<span class="fc" id="L1381">                    .getMethod(&quot;getInsets&quot;, new Class[]{int.class})</span>
<span class="fc" id="L1382">                    .invoke(insets, new Object[]{systemBarsMask});</span>
<span class="pc bpc" id="L1383" title="1 of 2 branches missed.">            if (insetsObject == null) return result;</span>
<span class="fc" id="L1384">            Class insetsClass = insetsObject.getClass();</span>
<span class="fc" id="L1385">            int left = ((Integer) insetsClass.getField(&quot;left&quot;).get(insetsObject)).intValue();</span>
<span class="fc" id="L1386">            int top = ((Integer) insetsClass.getField(&quot;top&quot;).get(insetsObject)).intValue();</span>
<span class="fc" id="L1387">            int right = ((Integer) insetsClass.getField(&quot;right&quot;).get(insetsObject)).intValue();</span>
<span class="fc" id="L1388">            int bottom = ((Integer) insetsClass.getField(&quot;bottom&quot;).get(insetsObject)).intValue();</span>
<span class="fc" id="L1389">            result.set(left, top, right, bottom);</span>
<span class="nc" id="L1390">        } catch (Throwable t) {</span>
<span class="nc" id="L1391">            t.printStackTrace();  // Optional: log this or suppress if expected</span>
<span class="fc" id="L1392">        }</span>
<span class="fc" id="L1393">        return result;</span>
    }


    public Rectangle getDisplaySafeArea(Rectangle rect) {
<span class="pc bpc" id="L1398" title="1 of 2 branches missed.">        if (rect == null) {</span>
<span class="nc" id="L1399">            rect = new Rectangle();</span>
        }
<span class="pc bpc" id="L1401" title="1 of 2 branches missed.">        if (getProperty(&quot;android.useSafeAreaInsets&quot;, &quot;true&quot;).equals(&quot;false&quot;)) {</span>
<span class="nc" id="L1402">            return super.getDisplaySafeArea(rect);</span>
        }
<span class="pc bpc" id="L1404" title="1 of 2 branches missed.">        if (this.myView != null) {</span>
<span class="fc" id="L1405">            rect.setBounds(</span>
<span class="fc" id="L1406">                    this.myView.getSafeAreaInsets().left,</span>
<span class="fc" id="L1407">                    this.myView.getSafeAreaInsets().top,</span>
<span class="fc" id="L1408">                    getDisplayWidth() - this.myView.getSafeAreaInsets().right - this.myView.getSafeAreaInsets().left,</span>
<span class="fc" id="L1409">                    getDisplayHeight() - this.myView.getSafeAreaInsets().top - this.myView.getSafeAreaInsets().bottom</span>
            );
<span class="fc" id="L1411">            return rect;</span>
        }

<span class="nc" id="L1414">        return super.getDisplaySafeArea(rect);</span>
    }

    /**
     * A status flag to indicate that CN1 is in the process of deinitializing.
     */
    private static boolean deinitializing;
    private static boolean deinitializingEdt;

    public static void syncDeinitialize() {
<span class="pc bpc" id="L1424" title="1 of 2 branches missed.">        if (deinitializingEdt){</span>
<span class="nc" id="L1425">            return;</span>
        }
<span class="fc" id="L1427">        deinitializingEdt = true; // This will get unset in {@link #deinitialize()}</span>
<span class="fc" id="L1428">        deinitializing = true;</span>
<span class="fc" id="L1429">        Display.getInstance().callSerially(new Runnable() {</span>
            @Override
            public void run() {
<span class="nc" id="L1432">                Display.deinitialize();</span>
<span class="nc" id="L1433">                deinitializingEdt = false;</span>
<span class="nc" id="L1434">            }</span>
        });
<span class="fc" id="L1436">    }</span>

    public void deinitialize() {
        //activity.getWindowManager().removeView(relativeLayout);
<span class="nc" id="L1440">        super.deinitialize();</span>
<span class="nc bnc" id="L1441" title="All 2 branches missed.">        if (getActivity() != null) {</span>

<span class="nc" id="L1443">            Runnable r = new Runnable() {</span>
                public void run() {
<span class="nc" id="L1445">                    synchronized (AndroidImplementation.this) {</span>
<span class="nc bnc" id="L1446" title="All 2 branches missed.">                        if (!deinitializing) {</span>
<span class="nc" id="L1447">                            return;</span>
                        }
<span class="nc" id="L1449">                        deinitializing = false;</span>
<span class="nc" id="L1450">                    }</span>
<span class="nc bnc" id="L1451" title="All 2 branches missed.">                    if (nativePeers.size() &gt; 0) {</span>
<span class="nc bnc" id="L1452" title="All 2 branches missed.">                        for (int i = 0; i &lt; nativePeers.size(); i++) {</span>
<span class="nc" id="L1453">                            ((AndroidImplementation.AndroidPeer) nativePeers.elementAt(i)).deinit();</span>
                        }
                    }
<span class="nc bnc" id="L1456" title="All 2 branches missed.">                    if (relativeLayout != null) {</span>
<span class="nc" id="L1457">                        relativeLayout.removeAllViews();</span>
                    }
<span class="nc" id="L1459">                    relativeLayout = null;</span>
<span class="nc" id="L1460">                    myView = null;</span>
<span class="nc" id="L1461">                }</span>
            };

<span class="nc bnc" id="L1464" title="All 2 branches missed.">            if (Looper.getMainLooper().getThread() == Thread.currentThread()) {</span>
<span class="nc" id="L1465">                deinitializing = true;</span>
<span class="nc" id="L1466">                r.run();</span>
            } else {
<span class="nc" id="L1468">                deinitializing = true;</span>
<span class="nc" id="L1469">                getActivity().runOnUiThread(r);</span>
            }
<span class="nc" id="L1471">        } else {</span>
<span class="nc" id="L1472">            deinitializing = false;</span>
        }
<span class="nc" id="L1474">    }</span>

    /**
     * init view. a lot of back and forth between this thread and the UI thread.
     */
    private void initSurface() {
<span class="pc bpc" id="L1480" title="2 of 4 branches missed.">        if (getActivity() != null &amp;&amp; myView == null) {</span>
<span class="fc" id="L1481">            relativeLayout=  new RelativeLayout(getActivity());</span>
<span class="fc" id="L1482">            relativeLayout.setLayoutParams(new RelativeLayout.LayoutParams(</span>
                    RelativeLayout.LayoutParams.FILL_PARENT,
                    RelativeLayout.LayoutParams.FILL_PARENT));
<span class="fc" id="L1485">            relativeLayout.setFocusable(false);</span>

<span class="fc" id="L1487">            getActivity().getWindow().setBackgroundDrawable(null);</span>
<span class="pc bpc" id="L1488" title="1 of 2 branches missed.">            if(asyncView) {</span>
<span class="pc bpc" id="L1489" title="1 of 2 branches missed.">                if(android.os.Build.VERSION.SDK_INT &lt; 14){</span>
<span class="nc" id="L1490">                    myView = new AndroidSurfaceView(getActivity(), AndroidImplementation.this);</span>
                } else {
<span class="fc" id="L1492">                    int hardwareAcceleration = 16777216;</span>
<span class="fc" id="L1493">                    getActivity().getWindow().setFlags(hardwareAcceleration, hardwareAcceleration);</span>
<span class="fc" id="L1494">                    myView = new AndroidAsyncView(getActivity(), AndroidImplementation.this);</span>
<span class="fc" id="L1495">                }</span>
            } else {
<span class="nc" id="L1497">                int hardwareAcceleration = 16777216;</span>
<span class="nc" id="L1498">                getActivity().getWindow().setFlags(hardwareAcceleration, hardwareAcceleration);</span>
<span class="nc" id="L1499">                superPeerMode = true;</span>
<span class="nc" id="L1500">                myView = new AndroidAsyncView(getActivity(), AndroidImplementation.this);</span>
            }
<span class="fc" id="L1502">            myView.getAndroidView().setVisibility(View.VISIBLE);</span>

<span class="fc" id="L1504">            relativeLayout.addView(myView.getAndroidView());</span>
<span class="fc" id="L1505">            myView.getAndroidView().setVisibility(View.VISIBLE);</span>

<span class="fc" id="L1507">            int id = getActivity().getResources().getIdentifier(&quot;main&quot;, &quot;layout&quot;, getActivity().getApplicationInfo().packageName);</span>
<span class="fc" id="L1508">            RelativeLayout root = (RelativeLayout) LayoutInflater.from(getActivity()).inflate(id, null);</span>
<span class="pc bpc" id="L1509" title="1 of 2 branches missed.">            if(viewAbove != null) {</span>
<span class="nc" id="L1510">                RelativeLayout.LayoutParams lp = new RelativeLayout.LayoutParams(RelativeLayout.LayoutParams.WRAP_CONTENT, RelativeLayout.LayoutParams.WRAP_CONTENT);</span>
<span class="nc" id="L1511">                lp.addRule(RelativeLayout.ALIGN_PARENT_TOP);</span>
<span class="nc" id="L1512">                lp.addRule(RelativeLayout.CENTER_HORIZONTAL);</span>

<span class="nc" id="L1514">                RelativeLayout.LayoutParams lp2 = new RelativeLayout.LayoutParams(RelativeLayout.LayoutParams.MATCH_PARENT, RelativeLayout.LayoutParams.MATCH_PARENT);</span>
<span class="nc" id="L1515">                lp2.setMargins(0, 0, aboveSpacing, 0);</span>
<span class="nc" id="L1516">                relativeLayout.setLayoutParams(lp2);</span>
<span class="nc" id="L1517">                root.addView(viewAbove, lp);</span>
            }
<span class="fc" id="L1519">            root.addView(relativeLayout);</span>
<span class="pc bpc" id="L1520" title="1 of 2 branches missed.">            if(viewBelow != null) {</span>
<span class="nc" id="L1521">                RelativeLayout.LayoutParams lp = new RelativeLayout.LayoutParams(RelativeLayout.LayoutParams.WRAP_CONTENT, RelativeLayout.LayoutParams.WRAP_CONTENT);</span>
<span class="nc" id="L1522">                lp.addRule(RelativeLayout.ALIGN_PARENT_BOTTOM);</span>
<span class="nc" id="L1523">                lp.addRule(RelativeLayout.CENTER_HORIZONTAL);</span>

<span class="nc" id="L1525">                RelativeLayout.LayoutParams lp2 = new RelativeLayout.LayoutParams(RelativeLayout.LayoutParams.MATCH_PARENT, RelativeLayout.LayoutParams.MATCH_PARENT);</span>
<span class="nc" id="L1526">                lp2.setMargins(0, 0, 0, belowSpacing);</span>
<span class="nc" id="L1527">                relativeLayout.setLayoutParams(lp2);</span>
<span class="nc" id="L1528">                root.addView(viewBelow, lp);</span>
            }
<span class="fc" id="L1530">            getActivity().setContentView(root);</span>
<span class="pc bpc" id="L1531" title="1 of 2 branches missed.">            if (!myView.getAndroidView().hasFocus()) {</span>
<span class="fc" id="L1532">                myView.getAndroidView().requestFocus();</span>
            }
        }
<span class="fc" id="L1535">    }</span>

    @Override
    public void confirmControlView() {
<span class="pc bpc" id="L1539" title="1 of 2 branches missed.">        if(myView == null){</span>
<span class="nc" id="L1540">            return;</span>
        }
<span class="fc" id="L1542">        myView.getAndroidView().setVisibility(View.VISIBLE);</span>
        //ugly workaround for a bug where on some android versions the async view
        //came back black from the background.
<span class="pc bpc" id="L1545" title="1 of 2 branches missed.">        if(myView instanceof AndroidAsyncView){</span>
<span class="fc" id="L1546">            new Thread(new Runnable() {</span>
                @Override
                public void run() {
<span class="fc" id="L1549">                    Util.sleep(1000);</span>
<span class="fc" id="L1550">                    ((AndroidAsyncView)myView).setPaintViewOnBuffer(false);</span>
<span class="fc" id="L1551">                }</span>
<span class="fc" id="L1552">            }).start();</span>
        }
<span class="fc" id="L1554">    }</span>

    public void hideNotifyPublic() {
<span class="nc" id="L1557">        super.hideNotify();</span>
<span class="nc" id="L1558">        saveTextEditingState();</span>
<span class="nc" id="L1559">    }</span>

    public void showNotifyPublic() {
<span class="nc" id="L1562">        super.showNotify();</span>
<span class="nc" id="L1563">    }</span>

    @Override
    public boolean isMinimized() {
<span class="pc bpc" id="L1567" title="1 of 4 branches missed.">        return getActivity() == null || ((CodenameOneActivity)getActivity()).isBackground();</span>
    }

    @Override
    public boolean minimizeApplication() {
<span class="nc" id="L1572">        Intent startMain = new Intent(Intent.ACTION_MAIN);</span>
<span class="nc" id="L1573">        startMain.addCategory(Intent.CATEGORY_HOME);</span>
<span class="nc" id="L1574">        startMain.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span>
<span class="nc" id="L1575">        startMain.putExtra(&quot;WaitForResult&quot;, Boolean.FALSE);</span>
<span class="nc" id="L1576">        getContext().startActivity(startMain);</span>
<span class="nc" id="L1577">        return true;</span>
    }

    @Override
    public void restoreMinimizedApplication() {
<span class="nc bnc" id="L1582" title="All 2 branches missed.">        if (getActivity() != null) {</span>
<span class="nc" id="L1583">            Intent i = new Intent(getActivity(), getActivity().getClass());</span>
<span class="nc" id="L1584">            i.setAction(Intent.ACTION_MAIN);</span>
<span class="nc" id="L1585">            i.addCategory(Intent.CATEGORY_LAUNCHER);</span>
<span class="nc" id="L1586">            getContext().startActivity(i);</span>
        }
<span class="nc" id="L1588">    }</span>

    @Override
    public boolean isNativeInputImmediate() {
<span class="nc" id="L1592">        return true;</span>
    }

    public void editString(final Component cmp, int maxSize, final int constraint, String text, int keyCode) {
<span class="nc" id="L1596">        InPlaceEditView.edit(this, cmp, constraint);</span>
<span class="nc" id="L1597">    }</span>

    protected boolean editInProgress() {
<span class="fc" id="L1600">        return InPlaceEditView.isEditing();</span>
    }

    @Override
    public boolean isAsyncEditMode() {
<span class="fc" id="L1605">        return asyncEditMode;</span>
    }

    void setAsyncEditMode(boolean async) {
<span class="fc" id="L1609">        asyncEditMode = async;</span>
<span class="fc" id="L1610">    }</span>

    void callHideTextEditor() {
<span class="fc" id="L1613">        super.hideTextEditor();</span>
<span class="fc" id="L1614">    }</span>

    @Override
    public void hideTextEditor() {
<span class="nc" id="L1618">        InPlaceEditView.hideActiveTextEditor();</span>
<span class="nc" id="L1619">    }</span>

    @Override
    public boolean isNativeEditorVisible(Component c) {
<span class="pc bpc" id="L1623" title="1 of 4 branches missed.">        return super.isNativeEditorVisible(c) &amp;&amp; !InPlaceEditView.isActiveTextEditorHidden();</span>
    }

    public static void stopEditing() {
<span class="nc" id="L1627">        stopEditing(false);</span>
<span class="nc" id="L1628">    }</span>

    public static void stopEditing(final boolean forceVKBClose){
<span class="pc bpc" id="L1631" title="1 of 2 branches missed.">        if (getActivity() == null) {</span>
<span class="nc" id="L1632">            return;</span>
        }
<span class="fc" id="L1634">        final boolean[] flag = new boolean[]{false};</span>

        // InPlaceEditView.endEdit must be called from the UI thread.
        // We must wait for this call to be over, otherwise Codename One's painting
        // of the next form will be garbled.
<span class="fc" id="L1639">        getActivity().runOnUiThread(new Runnable() {</span>
            @Override
            public void run() {
                // Must be called from the UI thread
<span class="fc" id="L1643">                InPlaceEditView.stopEdit(forceVKBClose);</span>

<span class="fc" id="L1645">                synchronized (flag) {</span>
<span class="fc" id="L1646">                    flag[0] = true;</span>
<span class="fc" id="L1647">                    flag.notify();</span>
<span class="fc" id="L1648">                }</span>
<span class="fc" id="L1649">            }</span>
        });

<span class="pc bpc" id="L1652" title="1 of 2 branches missed.">        if (!flag[0]) {</span>
            // Wait (if necessary) for the asynchronous runOnUiThread to do its work
<span class="nc" id="L1654">            synchronized (flag) {</span>

                try {
<span class="nc" id="L1657">                    flag.wait();</span>
<span class="nc" id="L1658">                } catch (InterruptedException e) {</span>
<span class="nc" id="L1659">                }</span>
<span class="nc" id="L1660">            }</span>
        }
<span class="fc" id="L1662">    }</span>

    @Override
    public void saveTextEditingState() {
<span class="nc" id="L1666">        stopEditing(true);</span>
<span class="nc" id="L1667">    }</span>

    @Override
    public void stopTextEditing() {
<span class="nc" id="L1671">        saveTextEditingState();</span>
<span class="nc" id="L1672">    }</span>

    @Override
    public void stopTextEditing(final Runnable onFinish) {
<span class="nc" id="L1676">        final Form f = Display.getInstance().getCurrent();</span>
<span class="nc" id="L1677">        f.addSizeChangedListener(new ActionListener() {</span>
            @Override
            public void actionPerformed(ActionEvent evt) {
<span class="nc" id="L1680">                f.removeSizeChangedListener(this);</span>
<span class="nc" id="L1681">                Display.getInstance().callSerially(new Runnable() {</span>
                    @Override
                    public void run() {
<span class="nc" id="L1684">                        onFinish.run();</span>
<span class="nc" id="L1685">                    }</span>
                });
<span class="nc" id="L1687">            }</span>
        });
<span class="nc" id="L1689">        stopEditing(true);</span>
<span class="nc" id="L1690">    }</span>


    protected void setLastSizeChangedWH(int w, int h) {
        // not used?
        //this.lastSizeChangeW = w;
        //this.lastSizeChangeH = h;
<span class="nc" id="L1697">    }</span>

    /*@Override
    public boolean handleEDTException(final Throwable err) {

        final boolean[] messageComplete = new boolean[]{false};

        Log.e(&quot;Codename One&quot;, &quot;Err on EDT&quot;, err);

        activity.runOnUiThread(new Runnable() {
            @Override
            public void run() {
                UIManager m = UIManager.getInstance();
                final FrameLayout frameLayout = new FrameLayout(
                        activity);
                final TextView textView = new TextView(
                        activity);
                textView.setGravity(Gravity.CENTER);
                frameLayout.addView(textView, new FrameLayout.LayoutParams(
                        FrameLayout.LayoutParams.FILL_PARENT,
                        FrameLayout.LayoutParams.WRAP_CONTENT));
                textView.setText(&quot;An internal application error occurred: &quot; + err.toString());
                AlertDialog.Builder bob = new AlertDialog.Builder(
                        activity);
                bob.setView(frameLayout);
                bob.setTitle(&quot;&quot;);
                bob.setPositiveButton(m.localize(&quot;ok&quot;, &quot;OK&quot;),
                        new DialogInterface.OnClickListener() {
                            @Override
                            public void onClick(DialogInterface d, int which) {
                                d.dismiss();
                                synchronized (messageComplete) {
                                    messageComplete[0] = true;
                                    messageComplete.notify();
                                }
                            }
                        });
                AlertDialog editDialog = bob.create();
                editDialog.show();
            }
        });

        synchronized (messageComplete) {
            if (messageComplete[0]) {
                return true;
            }
            try {
                messageComplete.wait();
            } catch (Exception ignored) {
                ;
            }
        }
        return true;
    }*/

    @Override
    public InputStream getResourceAsStream(Class cls, String resource) {
        try {
<span class="pc bpc" id="L1755" title="1 of 2 branches missed.">            if (resource.startsWith(&quot;/&quot;)) {</span>
<span class="fc" id="L1756">                resource = resource.substring(1);</span>
            }
<span class="fc" id="L1758">            return getContext().getAssets().open(resource);</span>
<span class="fc" id="L1759">        } catch (IOException ex) {</span>
<span class="fc" id="L1760">            Log.i(&quot;Codename One&quot;, &quot;Resource not found: &quot; + resource);</span>
<span class="fc" id="L1761">            return null;</span>
        }
    }

    @Override
    protected void pointerPressed(final int x, final int y) {
<span class="nc" id="L1767">        super.pointerPressed(x, y);</span>
<span class="nc" id="L1768">    }</span>

    @Override
    protected void pointerPressed(final int[] x, final int[] y) {
<span class="nc" id="L1772">        super.pointerPressed(x, y);</span>
<span class="nc" id="L1773">    }</span>

    @Override
    protected void pointerReleased(final int x, final int y) {
<span class="nc" id="L1777">        super.pointerReleased(x, y);</span>
<span class="nc" id="L1778">    }</span>

    @Override
    protected void pointerReleased(final int[] x, final int[] y) {
<span class="nc" id="L1782">        super.pointerReleased(x, y);</span>
<span class="nc" id="L1783">    }</span>

    @Override
    protected void pointerDragged(int x, int y) {
<span class="nc" id="L1787">        super.pointerDragged(x, y);</span>
<span class="nc" id="L1788">    }</span>

    @Override
    protected void pointerDragged(int[] x, int[] y) {
<span class="nc" id="L1792">        super.pointerDragged(x, y);</span>
<span class="nc" id="L1793">    }</span>

    @Override
    protected int getDragAutoActivationThreshold() {
<span class="nc" id="L1797">        return 1000000;</span>
    }

    @Override
    public void flushGraphics() {
<span class="pc bpc" id="L1802" title="1 of 2 branches missed.">        if (myView != null) {</span>
<span class="fc" id="L1803">            myView.flushGraphics();</span>
        }

<span class="fc" id="L1806">    }</span>

    @Override
    public void flushGraphics(int x, int y, int width, int height) {
<span class="fc" id="L1810">        this.tmprect.set(x, y, x + width, y + height);</span>
<span class="pc bpc" id="L1811" title="1 of 2 branches missed.">        if (myView != null) {</span>
<span class="fc" id="L1812">            myView.flushGraphics(this.tmprect);</span>
        }
<span class="fc" id="L1814">    }</span>

    @Override
    public int charWidth(Object nativeFont, char ch) {
<span class="fc" id="L1818">        this.tmpchar[0] = ch;</span>
<span class="pc bpc" id="L1819" title="1 of 2 branches missed.">        float w = (nativeFont == null ? this.defaultFont</span>
<span class="fc" id="L1820">                : (Paint) ((NativeFont) nativeFont).font).measureText(this.tmpchar, 0, 1);</span>
<span class="pc bpc" id="L1821" title="1 of 2 branches missed.">        if (w - (int) w &gt; 0) {</span>
<span class="nc" id="L1822">            return (int) (w + 1);</span>
        }
<span class="fc" id="L1824">        return (int) w;</span>
    }

    @Override
    public int charsWidth(Object nativeFont, char[] ch, int offset, int length) {
<span class="nc bnc" id="L1829" title="All 2 branches missed.">        float w = (nativeFont == null ? this.defaultFont</span>
<span class="nc" id="L1830">                : (Paint) ((NativeFont) nativeFont).font).measureText(ch, offset, length);</span>
<span class="nc bnc" id="L1831" title="All 2 branches missed.">        if (w - (int) w &gt; 0) {</span>
<span class="nc" id="L1832">            return (int) (w + 1);</span>
        }
<span class="nc" id="L1834">        return (int) w;</span>
    }

    @Override
    public int stringWidth(Object nativeFont, String str) {
<span class="fc bfc" id="L1839" title="All 2 branches covered.">        float w = (nativeFont == null ? this.defaultFont</span>
<span class="fc" id="L1840">                : (Paint) ((NativeFont) nativeFont).font).measureText(str);</span>
<span class="pc bpc" id="L1841" title="1 of 2 branches missed.">        if (w - (int) w &gt; 0) {</span>
<span class="nc" id="L1842">            return (int) (w + 1);</span>
        }
<span class="fc" id="L1844">        return (int) w;</span>
    }

    @Override
    public void setNativeFont(Object graphics, Object font) {
<span class="fc bfc" id="L1849" title="All 2 branches covered.">        if (font == null) {</span>
<span class="fc" id="L1850">            font = this.defaultFont;</span>
        }
<span class="fc bfc" id="L1852" title="All 2 branches covered.">        if (font instanceof NativeFont) {</span>
<span class="fc" id="L1853">            ((AndroidGraphics) graphics).setFont((CodenameOneTextPaint) ((NativeFont) font).font);</span>
        } else {
<span class="fc" id="L1855">            ((AndroidGraphics) graphics).setFont((CodenameOneTextPaint) font);</span>
        }
<span class="fc" id="L1857">    }</span>

    @Override
    public int getHeight(Object nativeFont) {
<span class="fc bfc" id="L1861" title="All 2 branches covered.">        CodenameOneTextPaint font = (nativeFont == null ? this.defaultFont</span>
<span class="fc" id="L1862">                : (CodenameOneTextPaint) ((NativeFont) nativeFont).font);</span>
<span class="fc bfc" id="L1863" title="All 2 branches covered.">        if(font.fontHeight &lt; 0) {</span>
<span class="fc" id="L1864">            Paint.FontMetrics fm = font.getFontMetrics();</span>
<span class="fc" id="L1865">            font.fontHeight = (int)Math.ceil(fm.bottom - fm.top);</span>
        }
<span class="fc" id="L1867">        return font.fontHeight;</span>
    }

    @Override
    public int getFontAscent(Object nativeFont) {
<span class="pc bpc" id="L1872" title="1 of 2 branches missed.">        Paint font = (nativeFont == null ? this.defaultFont</span>
<span class="fc" id="L1873">                : (Paint) ((NativeFont) nativeFont).font);</span>
<span class="fc" id="L1874">        return -Math.round(font.getFontMetrics().ascent);</span>
    }

    @Override
    public int getFontDescent(Object nativeFont) {
<span class="nc bnc" id="L1879" title="All 2 branches missed.">        Paint font = (nativeFont == null ? this.defaultFont</span>
<span class="nc" id="L1880">                : (Paint) ((NativeFont) nativeFont).font);</span>
<span class="nc" id="L1881">        return Math.abs(Math.round(font.getFontMetrics().descent));</span>
    }

    @Override
    public boolean isBaselineTextSupported() {
<span class="nc" id="L1886">        return true;</span>
    }






    public int getFace(Object nativeFont) {
<span class="nc bnc" id="L1895" title="All 2 branches missed.">        if (nativeFont == null) {</span>
<span class="nc" id="L1896">            return Font.FACE_SYSTEM;</span>
        }
<span class="nc" id="L1898">        return ((NativeFont) nativeFont).face;</span>
    }

    public int getStyle(Object nativeFont) {
<span class="pc bpc" id="L1902" title="1 of 2 branches missed.">        if (nativeFont == null) {</span>
<span class="nc" id="L1903">            return Font.STYLE_PLAIN;</span>
        }
<span class="fc" id="L1905">        return ((NativeFont) nativeFont).style;</span>
    }

    @Override
    public int getSize(Object nativeFont) {
<span class="nc bnc" id="L1910" title="All 2 branches missed.">        if (nativeFont == null) {</span>
<span class="nc" id="L1911">            return Font.SIZE_MEDIUM;</span>
        }
<span class="nc" id="L1913">        return ((NativeFont) nativeFont).size;</span>
    }

    @Override
    public boolean isTrueTypeSupported() {
<span class="fc" id="L1918">        return true;</span>
    }

    @Override
    public boolean isNativeFontSchemeSupported() {
<span class="fc" id="L1923">        return true;</span>
    }

    private Typeface fontToRoboto(String fontName) {
<span class="fc bfc" id="L1927" title="All 2 branches covered.">        if(&quot;native:MainThin&quot;.equals(fontName)) {</span>
<span class="fc" id="L1928">            return Typeface.create(&quot;sans-serif-thin&quot;, Typeface.NORMAL);</span>
        }
<span class="fc bfc" id="L1930" title="All 2 branches covered.">        if(&quot;native:MainLight&quot;.equals(fontName)) {</span>
<span class="fc" id="L1931">            return Typeface.create(&quot;sans-serif-light&quot;, Typeface.NORMAL);</span>
        }
<span class="fc bfc" id="L1933" title="All 2 branches covered.">        if(&quot;native:MainRegular&quot;.equals(fontName)) {</span>
<span class="fc" id="L1934">            return Typeface.create(&quot;sans-serif&quot;, Typeface.NORMAL);</span>
        }

<span class="fc bfc" id="L1937" title="All 2 branches covered.">        if(&quot;native:MainBold&quot;.equals(fontName)) {</span>
<span class="fc" id="L1938">            return Typeface.create(&quot;sans-serif-condensed&quot;, Typeface.BOLD);</span>
        }

<span class="fc bfc" id="L1941" title="All 2 branches covered.">        if(&quot;native:MainBlack&quot;.equals(fontName)) {</span>
<span class="fc" id="L1942">            return Typeface.create(&quot;sans-serif-black&quot;, Typeface.BOLD);</span>
        }

<span class="fc bfc" id="L1945" title="All 2 branches covered.">        if(&quot;native:ItalicThin&quot;.equals(fontName)) {</span>
<span class="fc" id="L1946">            return Typeface.create(&quot;sans-serif-thin&quot;, Typeface.ITALIC);</span>
        }

<span class="fc bfc" id="L1949" title="All 2 branches covered.">        if(&quot;native:ItalicLight&quot;.equals(fontName)) {</span>
<span class="fc" id="L1950">            return Typeface.create(&quot;sans-serif-thin&quot;, Typeface.ITALIC);</span>
        }

<span class="fc bfc" id="L1953" title="All 2 branches covered.">        if(&quot;native:ItalicRegular&quot;.equals(fontName)) {</span>
<span class="fc" id="L1954">            return Typeface.create(&quot;sans-serif&quot;, Typeface.ITALIC);</span>
        }

<span class="fc bfc" id="L1957" title="All 2 branches covered.">        if(&quot;native:ItalicBold&quot;.equals(fontName)) {</span>
<span class="fc" id="L1958">            return Typeface.create(&quot;sans-serif-condensed&quot;, Typeface.BOLD_ITALIC);</span>
        }

<span class="pc bpc" id="L1961" title="1 of 2 branches missed.">        if(&quot;native:ItalicBlack&quot;.equals(fontName)) {</span>
<span class="fc" id="L1962">            return Typeface.create(&quot;sans-serif-black&quot;, Typeface.BOLD_ITALIC);</span>
        }

<span class="nc" id="L1965">        throw new IllegalArgumentException(&quot;Unsupported native font type: &quot; + fontName);</span>
    }

    @Override
    public Object loadTrueTypeFont(String fontName, String fileName) {
<span class="fc bfc" id="L1970" title="All 2 branches covered.">        if(fontName.startsWith(&quot;native:&quot;)) {</span>
<span class="fc" id="L1971">            Typeface t = fontToRoboto(fontName);</span>
<span class="fc" id="L1972">            int fontStyle = com.codename1.ui.Font.STYLE_PLAIN;</span>
<span class="fc bfc" id="L1973" title="All 2 branches covered.">            if(t.isBold()) {</span>
<span class="fc" id="L1974">                fontStyle |= com.codename1.ui.Font.STYLE_BOLD;</span>
            }
<span class="fc bfc" id="L1976" title="All 2 branches covered.">            if(t.isItalic()) {</span>
<span class="fc" id="L1977">                fontStyle |= com.codename1.ui.Font.STYLE_ITALIC;</span>
            }
<span class="fc" id="L1979">            CodenameOneTextPaint newPaint = new CodenameOneTextPaint(t);</span>
<span class="fc" id="L1980">            newPaint.setAntiAlias(true);</span>
<span class="fc" id="L1981">            newPaint.setSubpixelText(true);</span>
<span class="fc" id="L1982">            return new NativeFont(com.codename1.ui.Font.FACE_SYSTEM, fontStyle,</span>
                    com.codename1.ui.Font.SIZE_MEDIUM, newPaint, fileName, 0, 0);
        }
<span class="fc" id="L1985">        Typeface t = Typeface.createFromAsset(getContext().getAssets(), fileName);</span>
<span class="pc bpc" id="L1986" title="1 of 2 branches missed.">        if(t == null) {</span>
<span class="nc" id="L1987">            throw new RuntimeException(&quot;Font not found: &quot; + fileName);</span>
        }
<span class="fc" id="L1989">        CodenameOneTextPaint newPaint = new CodenameOneTextPaint(t);</span>
<span class="fc" id="L1990">        newPaint.setAntiAlias(true);</span>
<span class="fc" id="L1991">        newPaint.setSubpixelText(true);</span>
<span class="fc" id="L1992">        return new NativeFont(com.codename1.ui.Font.FACE_SYSTEM,</span>
                com.codename1.ui.Font.STYLE_PLAIN, com.codename1.ui.Font.SIZE_MEDIUM, newPaint, fileName, 0, 0);
    }

    public static class NativeFont {
        int face;
        int style;
        int size;
        public Object font;
        String fileName;
        float height;
        int weight;

        public NativeFont(int face, int style, int size, Object font, String fileName, float height, int weight) {
<span class="fc" id="L2006">            this(face, style, size, font);</span>
<span class="fc" id="L2007">            this.fileName = fileName;</span>
<span class="fc" id="L2008">            this.height = height;</span>
<span class="fc" id="L2009">            this.weight = weight;</span>
<span class="fc" id="L2010">        }</span>

<span class="fc" id="L2012">        public NativeFont(int face, int style, int size, Object font) {</span>
<span class="fc" id="L2013">            this.face = face;</span>
<span class="fc" id="L2014">            this.style = style;</span>
<span class="fc" id="L2015">            this.size = size;</span>
<span class="fc" id="L2016">            this.font = font;</span>
<span class="fc" id="L2017">        }</span>

        public boolean equals(Object o) {
<span class="pc bpc" id="L2020" title="1 of 2 branches missed.">            if(o == null) {</span>
<span class="nc" id="L2021">                return false;</span>
            }
<span class="fc" id="L2023">            NativeFont n = ((NativeFont)o);</span>
<span class="pc bpc" id="L2024" title="1 of 2 branches missed.">            if(fileName != null) {</span>
<span class="pc bpc" id="L2025" title="4 of 8 branches missed.">                return n.fileName != null &amp;&amp; fileName.equals(n.fileName) &amp;&amp; n.height == height &amp;&amp; n.weight == weight;</span>
            }
<span class="nc bnc" id="L2027" title="All 8 branches missed.">            return n.face == face &amp;&amp; n.style == style &amp;&amp; n.size == size &amp;&amp; font.equals(n.font);</span>
        }

        public int hashCode() {
<span class="fc" id="L2031">            return face | style | size;</span>
        }
    }

    @Override
    public Object deriveTrueTypeFont(Object font, float size, int weight) {
<span class="fc" id="L2037">        NativeFont fnt = (NativeFont)font;</span>
<span class="fc" id="L2038">        CodenameOneTextPaint paint = (CodenameOneTextPaint)fnt.font;</span>
<span class="fc" id="L2039">        paint.setAntiAlias(true);</span>
<span class="fc" id="L2040">        Typeface type = paint.getTypeface();</span>
<span class="fc" id="L2041">        int fontstyle = Typeface.NORMAL;</span>
<span class="fc bfc" id="L2042" title="All 4 branches covered.">        if ((weight &amp; Font.STYLE_BOLD) != 0 || type.isBold()) {</span>
<span class="fc" id="L2043">            fontstyle |= Typeface.BOLD;</span>
        }
<span class="fc bfc" id="L2045" title="All 4 branches covered.">        if ((weight &amp; Font.STYLE_ITALIC) != 0 || type.isItalic()) {</span>
<span class="fc" id="L2046">            fontstyle |= Typeface.ITALIC;</span>
        }
<span class="fc" id="L2048">        type = Typeface.create(type, fontstyle);</span>
<span class="fc" id="L2049">        CodenameOneTextPaint newPaint = new CodenameOneTextPaint(type);</span>
<span class="fc" id="L2050">        newPaint.setTextSize(size);</span>
<span class="fc" id="L2051">        newPaint.setAntiAlias(true);</span>
<span class="fc" id="L2052">        NativeFont n = new NativeFont(com.codename1.ui.Font.FACE_SYSTEM, weight, com.codename1.ui.Font.SIZE_MEDIUM, newPaint, fnt.fileName, size, weight);</span>
<span class="fc" id="L2053">        return n;</span>
    }

    @Override
    public Object createFont(int face, int style, int size) {
<span class="fc" id="L2058">        Typeface typeface = null;</span>
<span class="fc bfc" id="L2059" title="All 2 branches covered.">        switch (face) {</span>
            case Font.FACE_MONOSPACE:
<span class="fc" id="L2061">                typeface = Typeface.MONOSPACE;</span>
<span class="fc" id="L2062">                break;</span>
            default:
<span class="fc" id="L2064">                typeface = Typeface.DEFAULT;</span>
                break;
        }

<span class="fc" id="L2068">        int fontstyle = Typeface.NORMAL;</span>
<span class="fc bfc" id="L2069" title="All 2 branches covered.">        if ((style &amp; Font.STYLE_BOLD) != 0) {</span>
<span class="fc" id="L2070">            fontstyle |= Typeface.BOLD;</span>
        }
<span class="fc bfc" id="L2072" title="All 2 branches covered.">        if ((style &amp; Font.STYLE_ITALIC) != 0) {</span>
<span class="fc" id="L2073">            fontstyle |= Typeface.ITALIC;</span>
        }


<span class="fc" id="L2077">        int height = this.defaultFontHeight;</span>
<span class="fc" id="L2078">        int diff = height / 3;</span>

<span class="fc bfc" id="L2080" title="All 3 branches covered.">        switch (size) {</span>
            case Font.SIZE_SMALL:
<span class="fc" id="L2082">                height -= diff;</span>
<span class="fc" id="L2083">                break;</span>
            case Font.SIZE_LARGE:
<span class="fc" id="L2085">                height += diff;</span>
                break;
        }

<span class="fc" id="L2089">        Paint font = new CodenameOneTextPaint(Typeface.create(typeface, fontstyle));</span>
<span class="fc" id="L2090">        font.setAntiAlias(true);</span>
<span class="pc bpc" id="L2091" title="1 of 2 branches missed.">        font.setUnderlineText((style &amp; Font.STYLE_UNDERLINED) != 0);</span>
<span class="fc" id="L2092">        font.setTextSize(height);</span>
<span class="fc" id="L2093">        return new NativeFont(face, style, size, font);</span>

    }

    /**
     * Loads a native font based on a lookup for a font name and attributes.
     * Font lookup values can be separated by commas and thus allow fallback if
     * the primary font isn't supported by the platform.
     *
     * @param lookup string describing the font
     * @return the native font object
     */
    public Object loadNativeFont(String lookup) {
        try {
<span class="nc" id="L2107">            lookup = lookup.split(&quot;;&quot;)[0];</span>
<span class="nc" id="L2108">            int typeface = Typeface.NORMAL;</span>
<span class="nc" id="L2109">            String familyName = lookup.substring(0, lookup.indexOf(&quot;-&quot;));</span>
<span class="nc" id="L2110">            String style = lookup.substring(lookup.indexOf(&quot;-&quot;) + 1, lookup.lastIndexOf(&quot;-&quot;));</span>
<span class="nc" id="L2111">            String size = lookup.substring(lookup.lastIndexOf(&quot;-&quot;) + 1, lookup.length());</span>

<span class="nc bnc" id="L2113" title="All 2 branches missed.">            if (style.equals(&quot;bolditalic&quot;)) {</span>
<span class="nc" id="L2114">                typeface = Typeface.BOLD_ITALIC;</span>
<span class="nc bnc" id="L2115" title="All 2 branches missed.">            } else if (style.equals(&quot;italic&quot;)) {</span>
<span class="nc" id="L2116">                typeface = Typeface.ITALIC;</span>
<span class="nc bnc" id="L2117" title="All 2 branches missed.">            } else if (style.equals(&quot;bold&quot;)) {</span>
<span class="nc" id="L2118">                typeface = Typeface.BOLD;</span>
            }
<span class="nc" id="L2120">            Paint font = new CodenameOneTextPaint(Typeface.create(familyName, typeface));</span>
<span class="nc" id="L2121">            font.setAntiAlias(true);</span>
<span class="nc" id="L2122">            font.setTextSize(Integer.parseInt(size));</span>
<span class="nc" id="L2123">            return new NativeFont(0, 0, 0, font);</span>
<span class="nc" id="L2124">        } catch (Exception err) {</span>
<span class="nc" id="L2125">            return null;</span>
        }
    }

    /**
     * Indicates whether loading a font by a string is supported by the platform
     *
     * @return true if the platform supports font lookup
     */
    @Override
    public boolean isLookupFontSupported() {
<span class="nc" id="L2136">        return true;</span>
    }

    @Override
    public boolean isAntiAliasedTextSupported() {
<span class="nc" id="L2141">        return true;</span>
    }

    @Override
    public void setAntiAliasedText(Object graphics, boolean a) {
<span class="fc" id="L2146">        android.graphics.Paint p  = ((AndroidGraphics) graphics).getFont();</span>
<span class="pc bpc" id="L2147" title="1 of 2 branches missed.">        if(p != null) {</span>
<span class="fc" id="L2148">            p.setAntiAlias(a);</span>
        }
<span class="fc" id="L2150">    }</span>

    @Override
    public Object getDefaultFont() {
<span class="fc" id="L2154">        CodenameOneTextPaint paint = new CodenameOneTextPaint(this.defaultFont);</span>
<span class="fc" id="L2155">        return new NativeFont(Font.FACE_SYSTEM, Font.STYLE_PLAIN, Font.SIZE_MEDIUM, paint);</span>
    }


    private AndroidGraphics nullGraphics;

    private AndroidGraphics getNullGraphics() {
<span class="nc bnc" id="L2162" title="All 2 branches missed.">        if (nullGraphics == null) {</span>
<span class="nc bnc" id="L2163" title="All 4 branches missed.">            Bitmap bitmap = Bitmap.createBitmap(getDisplayWidth()==0?100:getDisplayWidth(), getDisplayHeight()==0?100:getDisplayHeight(),</span>
                    Bitmap.Config.ARGB_8888);
<span class="nc" id="L2165">            nullGraphics = (AndroidGraphics) this.getNativeGraphics(bitmap);</span>
        }
<span class="nc" id="L2167">        return nullGraphics;</span>
    }


    @Override
    public Object getNativeGraphics() {
<span class="pc bpc" id="L2173" title="1 of 2 branches missed.">        if(myView != null){</span>
<span class="fc" id="L2174">            nullGraphics = null;</span>
<span class="fc" id="L2175">            return myView.getGraphics();</span>
        }else{
<span class="nc" id="L2177">            return getNullGraphics();</span>
        }
    }

    @Override
    public Object getNativeGraphics(Object image) {
<span class="fc" id="L2183">        AndroidGraphics g =  new AndroidGraphics(this, new Canvas((Bitmap) image), true);</span>
<span class="fc" id="L2184">        g.setClip(0, 0, ((Bitmap)image).getWidth(), ((Bitmap)image).getHeight());</span>
<span class="fc" id="L2185">        return g;</span>
    }

    @Override
    public void getRGB(Object nativeImage, int[] arr, int offset, int x, int y,
                       int width, int height) {
<span class="fc" id="L2191">        ((Bitmap) nativeImage).getPixels(arr, offset, width, x, y, width,</span>
                height);
<span class="fc" id="L2193">    }</span>

<span class="fc" id="L2195">    private int sampleSizeOverride = -1;</span>

    @Override
    public Object createImage(String path) throws IOException {
<span class="nc" id="L2199">        int IMAGE_MAX_SIZE = getDisplayHeight();</span>
<span class="nc bnc" id="L2200" title="All 2 branches missed.">        if (exists(path)) {</span>
<span class="nc" id="L2201">            Bitmap b = null;</span>
            try {
                //Decode image size
<span class="nc" id="L2204">                BitmapFactory.Options o = new BitmapFactory.Options();</span>
<span class="nc" id="L2205">                o.inJustDecodeBounds = true;</span>
<span class="nc" id="L2206">                o.inPreferredConfig = Bitmap.Config.ARGB_8888;</span>

<span class="nc" id="L2208">                InputStream fis = createFileInputStream(path);</span>
<span class="nc" id="L2209">                BitmapFactory.decodeStream(fis, null, o);</span>
<span class="nc" id="L2210">                fis.close();</span>

<span class="nc" id="L2212">                int scale = 1;</span>
<span class="nc bnc" id="L2213" title="All 4 branches missed.">                if (o.outHeight &gt; IMAGE_MAX_SIZE || o.outWidth &gt; IMAGE_MAX_SIZE) {</span>
<span class="nc" id="L2214">                    scale = (int) Math.pow(2, (int) Math.round(Math.log(IMAGE_MAX_SIZE / (double) Math.max(o.outHeight, o.outWidth)) / Math.log(0.5)));</span>
                }

                //Decode with inSampleSize
<span class="nc" id="L2218">                BitmapFactory.Options o2 = new BitmapFactory.Options();</span>
<span class="nc" id="L2219">                o2.inPreferredConfig = Bitmap.Config.ARGB_8888;</span>

<span class="nc bnc" id="L2221" title="All 2 branches missed.">                if(sampleSizeOverride != -1) {</span>
<span class="nc" id="L2222">                    o2.inSampleSize = sampleSizeOverride;</span>
                } else {
<span class="nc" id="L2224">                    String sampleSize = Display.getInstance().getProperty(&quot;android.sampleSize&quot;, null);</span>
<span class="nc bnc" id="L2225" title="All 2 branches missed.">                    if(sampleSize != null) {</span>
<span class="nc" id="L2226">                        o2.inSampleSize = Integer.parseInt(sampleSize);</span>
                    } else {
<span class="nc" id="L2228">                        o2.inSampleSize = scale;</span>
                    }
                }
<span class="nc" id="L2231">                o2.inPurgeable = true;</span>
<span class="nc" id="L2232">                o2.inInputShareable = true;</span>
<span class="nc" id="L2233">                fis = createFileInputStream(path);</span>
<span class="nc" id="L2234">                b = BitmapFactory.decodeStream(fis, null, o2);</span>
<span class="nc" id="L2235">                fis.close();</span>

                //fix rotation
<span class="nc" id="L2238">                ExifInterface exif = new ExifInterface(removeFilePrefix(path));</span>
<span class="nc" id="L2239">                int orientation = exif.getAttributeInt(ExifInterface.TAG_ORIENTATION, ExifInterface.ORIENTATION_NORMAL);</span>

<span class="nc" id="L2241">                int angle = 0;</span>
<span class="nc bnc" id="L2242" title="All 4 branches missed.">                switch (orientation) {</span>
                    case ExifInterface.ORIENTATION_ROTATE_90:
<span class="nc" id="L2244">                        angle = 90;</span>
<span class="nc" id="L2245">                        break;</span>
                    case ExifInterface.ORIENTATION_ROTATE_180:
<span class="nc" id="L2247">                        angle = 180;</span>
<span class="nc" id="L2248">                        break;</span>
                    case ExifInterface.ORIENTATION_ROTATE_270:
<span class="nc" id="L2250">                        angle = 270;</span>
                        break;
                }

<span class="nc bnc" id="L2254" title="All 4 branches missed.">                if (sampleSizeOverride &lt; 0 &amp;&amp; angle != 0) {</span>
<span class="nc" id="L2255">                    Matrix mat = new Matrix();</span>
<span class="nc" id="L2256">                    mat.postRotate(angle);</span>
<span class="nc" id="L2257">                    Bitmap correctBmp = Bitmap.createBitmap(b, 0, 0, b.getWidth(), b.getHeight(), mat, true);</span>
<span class="nc" id="L2258">                    b.recycle();</span>
<span class="nc" id="L2259">                    b = correctBmp;</span>
                }
<span class="nc" id="L2261">            } catch (IOException e) {</span>
<span class="nc" id="L2262">            }</span>
<span class="nc" id="L2263">            return b;</span>
        } else {
<span class="nc" id="L2265">            InputStream in = this.getResourceAsStream(getClass(), path);</span>
<span class="nc bnc" id="L2266" title="All 2 branches missed.">            if (in == null) {</span>
<span class="nc" id="L2267">                throw new IOException(&quot;Resource not found. &quot; + path);</span>
            }
            try {
<span class="nc" id="L2270">                return this.createImage(in);</span>
            } finally {
<span class="nc bnc" id="L2272" title="All 2 branches missed.">                if (in != null) {</span>
                    try {
<span class="nc" id="L2274">                        in.close();</span>
<span class="nc" id="L2275">                    } catch (Exception ignored) {</span>
                        ;
<span class="nc" id="L2277">                    }</span>
                }
            }
        }
    }

    @Override
    public boolean areMutableImagesFast() {
<span class="pc bpc" id="L2285" title="1 of 2 branches missed.">        if (myView == null) return false;</span>
<span class="pc bpc" id="L2286" title="1 of 2 branches missed.">        return !myView.alwaysRepaintAll();</span>
    }

    @Override
    public void repaint(Animation cmp) {
<span class="pc bpc" id="L2291" title="2 of 4 branches missed.">        if(myView != null &amp;&amp; myView.alwaysRepaintAll()) {</span>
<span class="pc bpc" id="L2292" title="1 of 2 branches missed.">            if(cmp instanceof Component) {</span>
<span class="fc" id="L2293">                Component c = (Component)cmp;</span>
<span class="fc" id="L2294">                c.setDirtyRegion(null);</span>
<span class="fc bfc" id="L2295" title="All 2 branches covered.">                if(c.getParent() != null) {</span>
<span class="fc" id="L2296">                    cmp = c.getComponentForm();</span>
                } else {
<span class="fc" id="L2298">                    Form f = getCurrentForm();</span>
<span class="pc bpc" id="L2299" title="1 of 2 branches missed.">                    if(f != null) {</span>
<span class="fc" id="L2300">                        cmp = f;</span>
                    }
                }
<span class="fc" id="L2303">            } else {</span>
                // make sure the form is repainted for standalone anims e.g. in the case
                // of replace animation
<span class="nc" id="L2306">                Form f = getCurrentForm();</span>
<span class="nc bnc" id="L2307" title="All 2 branches missed.">                if(f != null) {</span>
<span class="nc" id="L2308">                    super.repaint(f);</span>
                }
            }
        }
<span class="fc" id="L2312">        super.repaint(cmp);</span>
<span class="fc" id="L2313">    }</span>

    @Override
    public Object createImage(InputStream i) throws IOException {
<span class="nc" id="L2317">        BitmapFactory.Options opts = new BitmapFactory.Options();</span>
<span class="nc" id="L2318">        opts.inPreferredConfig = Bitmap.Config.ARGB_8888;</span>
<span class="nc" id="L2319">        return BitmapFactory.decodeStream(i, null, opts);</span>
    }

    @Override
    public void releaseImage(Object image) {
<span class="fc" id="L2324">        Bitmap i = (Bitmap) image;</span>
<span class="fc" id="L2325">        i.recycle();</span>
<span class="fc" id="L2326">    }</span>

    @Override
    public Object createImage(byte[] bytes, int offset, int len) {
<span class="fc" id="L2330">        BitmapFactory.Options opts = new BitmapFactory.Options();</span>
<span class="fc" id="L2331">        opts.inPreferredConfig = Bitmap.Config.ARGB_8888;</span>
<span class="fc" id="L2332">        return BitmapFactory.decodeByteArray(bytes, offset, len, opts);</span>
    }

    @Override
    public Object createImage(int[] rgb, int width, int height) {
<span class="fc" id="L2337">        return Bitmap.createBitmap(rgb, width, height, Bitmap.Config.ARGB_8888);</span>
    }

    @Override
    public boolean isAlphaMutableImageSupported() {
<span class="nc" id="L2342">        return true;</span>
    }

    @Override
    public Object scale(Object nativeImage, int width, int height) {
<span class="fc" id="L2347">        return Bitmap.createScaledBitmap((Bitmap) nativeImage, width, height,</span>
                false);
    }

    //    @Override
//    public Object rotate(Object image, int degrees) {
//        Matrix matrix = new Matrix();
//        matrix.postRotate(degrees);
//        return Bitmap.createBitmap((Bitmap) image, 0, 0, ((Bitmap) image).getWidth(), ((Bitmap) image).getHeight(), matrix, true);
//    }
    @Override
    public boolean isRotationDrawingSupported() {
<span class="nc" id="L2359">        return false;</span>
    }

    @Override
    protected boolean cacheLinearGradients() {
<span class="nc" id="L2364">        return false;</span>
    }

    @Override
    public boolean isNativeInputSupported() {
<span class="fc" id="L2369">        return true;</span>
    }

    /**
     * Returns true if the underlying OS supports opening the native navigation
     * application
     * @return true if the underlying OS supports launch of native navigation app
     */
    public boolean isOpenNativeNavigationAppSupported(){
<span class="nc" id="L2378">        return true;</span>
    }

    /**
     * Opens the native navigation app in the given coordinate.
     * @param latitude
     * @param longitude
     */
    public void openNativeNavigationApp(double latitude, double longitude){
<span class="nc" id="L2387">        execute(&quot;google.navigation:ll=&quot; + latitude+ &quot;,&quot; + longitude);</span>
<span class="nc" id="L2388">    }</span>


    @Override
    public void openNativeNavigationApp(String location) {
<span class="nc" id="L2393">        execute(&quot;google.navigation:q=&quot; + Util.encodeUrl(location));</span>
<span class="nc" id="L2394">    }</span>

    @Override
    public Object createMutableImage(int width, int height, int fillColor) {
<span class="fc" id="L2398">        Bitmap bitmap = Bitmap.createBitmap(width, height,</span>
                Bitmap.Config.ARGB_8888);
<span class="fc" id="L2400">        AndroidGraphics graphics = (AndroidGraphics) this.getNativeGraphics(bitmap);</span>
<span class="fc" id="L2401">        graphics.fillBitmap(fillColor);</span>
<span class="fc" id="L2402">        return bitmap;</span>
    }

    @Override
    public int getImageHeight(Object i) {
<span class="fc" id="L2407">        return ((Bitmap) i).getHeight();</span>
    }

    @Override
    public int getImageWidth(Object i) {
<span class="fc" id="L2412">        return ((Bitmap) i).getWidth();</span>
    }

    @Override
    public void drawImage(Object graphics, Object img, int x, int y) {
<span class="fc" id="L2417">        ((AndroidGraphics) graphics).drawImage(img, x, y);</span>
<span class="fc" id="L2418">    }</span>

    @Override
    public void tileImage(Object graphics, Object img, int x, int y, int w, int h) {
<span class="fc" id="L2422">        ((AndroidGraphics) graphics).tileImage(img, x, y, w, h);</span>
<span class="fc" id="L2423">    }</span>

    public boolean isScaledImageDrawingSupported() {
<span class="fc" id="L2426">        return true;</span>
    }

    public void drawImage(Object graphics, Object img, int x, int y, int w, int h) {
<span class="fc" id="L2430">        ((AndroidGraphics) graphics).drawImage(img, x, y, w, h);</span>
<span class="fc" id="L2431">    }</span>

    @Override
    public void drawLine(Object graphics, int x1, int y1, int x2, int y2) {
<span class="fc" id="L2435">        ((AndroidGraphics) graphics).drawLine(x1, y1, x2, y2);</span>
<span class="fc" id="L2436">    }</span>

    @Override
    public boolean isAntiAliasingSupported() {
<span class="nc" id="L2440">        return true;</span>
    }

    @Override
    public void setAntiAliased(Object graphics, boolean a) {
<span class="fc" id="L2445">        ((AndroidGraphics) graphics).getPaint().setAntiAlias(a);</span>
<span class="fc" id="L2446">    }</span>

    @Override
    public void drawPolygon(Object graphics, int[] xPoints, int[] yPoints, int nPoints) {
<span class="fc" id="L2450">        ((AndroidGraphics) graphics).drawPolygon(xPoints, yPoints, nPoints);</span>
<span class="fc" id="L2451">    }</span>

    @Override
    public void fillPolygon(Object graphics, int[] xPoints, int[] yPoints, int nPoints) {
<span class="fc" id="L2455">        ((AndroidGraphics) graphics).fillPolygon(xPoints, yPoints, nPoints);</span>
<span class="fc" id="L2456">    }</span>

    @Override
    public void drawRGB(Object graphics, int[] rgbData, int offset, int x,
                        int y, int w, int h, boolean processAlpha) {
<span class="fc" id="L2461">        ((AndroidGraphics) graphics).drawRGB(rgbData, offset, x, y, w, h, processAlpha);</span>
<span class="fc" id="L2462">    }</span>

    @Override
    public void drawRect(Object graphics, int x, int y, int width, int height) {
<span class="fc" id="L2466">        ((AndroidGraphics) graphics).drawRect(x, y, width, height);</span>
<span class="fc" id="L2467">    }</span>

    @Override
    public void drawRoundRect(Object graphics, int x, int y, int width,
                              int height, int arcWidth, int arcHeight) {
<span class="fc" id="L2472">        ((AndroidGraphics) graphics).drawRoundRect(x, y, width, height, arcWidth, arcHeight);</span>
<span class="fc" id="L2473">    }</span>

    @Override
    public void drawString(Object graphics, String str, int x, int y) {
<span class="fc" id="L2477">        ((AndroidGraphics) graphics).drawString(str, x, y);</span>
<span class="fc" id="L2478">    }</span>

    @Override
    public void drawArc(Object graphics, int x, int y, int width, int height,
                        int startAngle, int arcAngle) {
<span class="fc" id="L2483">        ((AndroidGraphics) graphics).drawArc(x, y, width, height, startAngle, arcAngle);</span>
<span class="fc" id="L2484">    }</span>

    @Override
    public void fillArc(Object graphics, int x, int y, int width, int height,
                        int startAngle, int arcAngle) {
<span class="fc" id="L2489">        ((AndroidGraphics) graphics).fillArc(x, y, width, height, startAngle, arcAngle);</span>
<span class="fc" id="L2490">    }</span>

    @Override
    public void fillRect(Object graphics, int x, int y, int width, int height) {
<span class="fc" id="L2494">        ((AndroidGraphics) graphics).fillRect(x, y, width, height);</span>
<span class="fc" id="L2495">    }</span>

    @Override
    public void fillRect(Object graphics, int x, int y, int w, int h, byte alpha) {
<span class="nc" id="L2499">        ((AndroidGraphics) graphics).fillRect(x, y, w, h, alpha);</span>
<span class="nc" id="L2500">    }</span>

    @Override
    public void paintComponentBackground(Object graphics, int x, int y, int width, int height, Style s) {
<span class="pc bpc" id="L2504" title="2 of 4 branches missed.">        if((!asyncView) || compatPaintMode ) {</span>
<span class="nc" id="L2505">            super.paintComponentBackground(graphics, x, y, width, height, s);</span>
<span class="nc" id="L2506">            return;</span>
        }
<span class="fc" id="L2508">        ((AndroidGraphics) graphics).paintComponentBackground(x, y, width, height, s);</span>
<span class="fc" id="L2509">    }</span>

    @Override
    public void fillLinearGradient(Object graphics, int startColor, int endColor, int x, int y, int width, int height, boolean horizontal) {
<span class="pc bpc" id="L2513" title="1 of 2 branches missed.">        if(!asyncView) {</span>
<span class="nc" id="L2514">            super.fillLinearGradient(graphics, startColor, endColor, x, y, width, height, horizontal);</span>
<span class="nc" id="L2515">            return;</span>
        }
<span class="fc" id="L2517">        ((AndroidGraphics)graphics).fillLinearGradient(startColor, endColor, x, y, width, height, horizontal);</span>
<span class="fc" id="L2518">    }</span>

    @Override
    public void fillRectRadialGradient(Object graphics, int startColor, int endColor, int x, int y, int width, int height, float relativeX, float relativeY, float relativeSize) {
<span class="pc bpc" id="L2522" title="1 of 2 branches missed.">        if(!asyncView) {</span>
<span class="nc" id="L2523">            super.fillRectRadialGradient(graphics, startColor, endColor, x, y, width, height, relativeX, relativeY, relativeSize);</span>
<span class="nc" id="L2524">            return;</span>
        }
<span class="fc" id="L2526">        ((AndroidGraphics)graphics).fillRectRadialGradient(startColor, endColor, x, y, width, height, relativeX, relativeY, relativeSize);</span>
<span class="fc" id="L2527">    }</span>

    @Override
    public void fillRadialGradient(Object graphics, int startColor, int endColor, int x, int y, int width, int height) {
<span class="fc" id="L2531">        ((AndroidGraphics)graphics).fillRadialGradient(startColor, endColor, x, y, width, height);</span>
<span class="fc" id="L2532">    }</span>

    @Override
    public void fillRadialGradient(Object graphics, int startColor, int endColor, int x, int y, int width, int height, int startAngle, int arcAngle) {
<span class="fc" id="L2536">        ((AndroidGraphics)graphics).fillRadialGradient(startColor, endColor, x, y, width, height, startAngle, arcAngle);</span>
<span class="fc" id="L2537">    }</span>

    @Override
    public void drawLabelComponent(Object nativeGraphics, int cmpX, int cmpY, int cmpHeight, int cmpWidth, Style style, String text, Object icon, Object stateIcon, int preserveSpaceForState, int gap, boolean rtl, boolean isOppositeSide, int textPosition, int stringWidth, boolean isTickerRunning, int tickerShiftText, boolean endsWith3Points, int valign) {
<span class="pc bpc" id="L2541" title="1 of 2 branches missed.">        if(AndroidAsyncView.legacyPaintLogic) {</span>
<span class="fc" id="L2542">            super.drawLabelComponent(nativeGraphics, cmpX, cmpY, cmpHeight, cmpWidth, style, text, icon, stateIcon, preserveSpaceForState, gap, rtl, isOppositeSide, textPosition, stringWidth, isTickerRunning, tickerShiftText, endsWith3Points, valign);</span>
<span class="fc" id="L2543">            return;</span>
        }
<span class="nc" id="L2545">        ((AndroidGraphics)nativeGraphics).drawLabelComponent(cmpX, cmpY, cmpHeight, cmpWidth, style, text,</span>
                (Bitmap)icon, (Bitmap)stateIcon, preserveSpaceForState, gap, rtl, isOppositeSide, textPosition, stringWidth,
                isTickerRunning, tickerShiftText, endsWith3Points, valign);
<span class="nc" id="L2548">    }</span>


    @Override
    public void fillRoundRect(Object graphics, int x, int y, int width,
                              int height, int arcWidth, int arcHeight) {
<span class="fc" id="L2554">        ((AndroidGraphics) graphics).fillRoundRect(x, y, width, height, arcWidth, arcHeight);</span>
<span class="fc" id="L2555">    }</span>

    @Override
    public int getAlpha(Object graphics) {
<span class="fc" id="L2559">        return ((AndroidGraphics) graphics).getAlpha();</span>
    }

    @Override
    public void setAlpha(Object graphics, int alpha) {
<span class="fc" id="L2564">        ((AndroidGraphics) graphics).setAlpha(alpha);</span>
<span class="fc" id="L2565">    }</span>

    @Override
    public boolean isAlphaGlobal() {
<span class="nc" id="L2569">        return true;</span>
    }

    @Override
    public void setColor(Object graphics, int RGB) {
<span class="fc" id="L2574">        ((AndroidGraphics) graphics).setColor((getColor(graphics) &amp; 0xff000000) | RGB);</span>
<span class="fc" id="L2575">    }</span>

    @Override
    public int getBackKeyCode() {
<span class="fc" id="L2579">        return DROID_IMPL_KEY_BACK;</span>
    }

    @Override
    public int getBackspaceKeyCode() {
<span class="fc" id="L2584">        return DROID_IMPL_KEY_BACKSPACE;</span>
    }

    @Override
    public int getClearKeyCode() {
<span class="fc" id="L2589">        return DROID_IMPL_KEY_CLEAR;</span>
    }

    @Override
    public int getClipHeight(Object graphics) {
<span class="fc" id="L2594">        return ((AndroidGraphics) graphics).getClipHeight();</span>
    }

    @Override
    public int getClipWidth(Object graphics) {
<span class="fc" id="L2599">        return ((AndroidGraphics) graphics).getClipWidth();</span>
    }

    @Override
    public int getClipX(Object graphics) {
<span class="fc" id="L2604">        return ((AndroidGraphics) graphics).getClipX();</span>
    }

    @Override
    public int getClipY(Object graphics) {
<span class="fc" id="L2609">        return ((AndroidGraphics) graphics).getClipY();</span>
    }

    @Override
    public void setClip(Object graphics, int x, int y, int width, int height) {
<span class="fc" id="L2614">        ((AndroidGraphics) graphics).setClip(x, y, width, height);</span>
<span class="fc" id="L2615">    }</span>

    @Override
    public boolean isShapeClipSupported(Object graphics){
<span class="pc bpc" id="L2619" title="1 of 2 branches missed.">        return Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.HONEYCOMB;</span>
    }

    @Override
    public void setClip(Object graphics, Shape shape) {
        //Path p = cn1ShapeToAndroidPath(shape);
<span class="fc" id="L2625">        ((AndroidGraphics) graphics).setClip(shape);</span>
<span class="fc" id="L2626">    }</span>


    @Override
    public void clipRect(Object graphics, int x, int y, int width, int height) {
<span class="fc" id="L2631">        ((AndroidGraphics) graphics).clipRect(x, y, width, height);</span>
<span class="fc" id="L2632">    }</span>

    @Override
    public int getColor(Object graphics) {
<span class="fc" id="L2636">        return ((AndroidGraphics) graphics).getColor();</span>
    }

    @Override
    public int getDisplayHeight() {
<span class="pc bpc" id="L2641" title="1 of 2 branches missed.">        if (this.myView != null) {</span>
<span class="fc" id="L2642">            int h = this.myView.getViewHeight();</span>
<span class="fc" id="L2643">            displayHeight = h;</span>
<span class="fc" id="L2644">            return h;</span>
        }
<span class="nc" id="L2646">        return displayHeight;</span>
    }

    @Override
    public int getDisplayWidth() {
<span class="pc bpc" id="L2651" title="1 of 2 branches missed.">        if (this.myView != null) {</span>
<span class="fc" id="L2652">            int w = this.myView.getViewWidth();</span>
<span class="fc" id="L2653">            displayWidth = w;</span>
<span class="fc" id="L2654">            return w;</span>
        }
<span class="nc" id="L2656">        return displayWidth;</span>
    }

    @Override
    public int getActualDisplayHeight() {
<span class="nc" id="L2661">        DisplayMetrics dm = getContext().getResources().getDisplayMetrics();</span>
<span class="nc" id="L2662">        return dm.heightPixels;</span>
    }

    @Override
    public int getGameAction(int keyCode) {
<span class="nc bnc" id="L2667" title="All 6 branches missed.">        switch (keyCode) {</span>
            case DROID_IMPL_KEY_DOWN:
<span class="nc" id="L2669">                return Display.GAME_DOWN;</span>
            case DROID_IMPL_KEY_UP:
<span class="nc" id="L2671">                return Display.GAME_UP;</span>
            case DROID_IMPL_KEY_LEFT:
<span class="nc" id="L2673">                return Display.GAME_LEFT;</span>
            case DROID_IMPL_KEY_RIGHT:
<span class="nc" id="L2675">                return Display.GAME_RIGHT;</span>
            case DROID_IMPL_KEY_FIRE:
<span class="nc" id="L2677">                return Display.GAME_FIRE;</span>
            default:
<span class="nc" id="L2679">                return 0;</span>
        }
    }

    @Override
    public int getKeyCode(int gameAction) {
<span class="nc bnc" id="L2685" title="All 6 branches missed.">        switch (gameAction) {</span>
            case Display.GAME_DOWN:
<span class="nc" id="L2687">                return DROID_IMPL_KEY_DOWN;</span>
            case Display.GAME_UP:
<span class="nc" id="L2689">                return DROID_IMPL_KEY_UP;</span>
            case Display.GAME_LEFT:
<span class="nc" id="L2691">                return DROID_IMPL_KEY_LEFT;</span>
            case Display.GAME_RIGHT:
<span class="nc" id="L2693">                return DROID_IMPL_KEY_RIGHT;</span>
            case Display.GAME_FIRE:
<span class="nc" id="L2695">                return DROID_IMPL_KEY_FIRE;</span>
            default:
<span class="nc" id="L2697">                return 0;</span>
        }
    }

    @Override
    public int[] getSoftkeyCode(int index) {
<span class="pc bpc" id="L2703" title="1 of 2 branches missed.">        if (index == 0) {</span>
<span class="fc" id="L2704">            return leftSK;</span>
        }
<span class="nc" id="L2706">        return null;</span>
    }

    @Override
    public int getSoftkeyCount() {
        /**
         * one menu button only. we may have to stuff some code here as soon as
         * there are devices that no longer have only a single menu button.
         */
<span class="fc" id="L2715">        return 1;</span>
    }

    @Override
    public void vibrate(int duration) {
<span class="nc bnc" id="L2720" title="All 2 branches missed.">        if (!this.vibrateInitialized) {</span>
            try {
<span class="nc" id="L2722">                v = (Vibrator) getContext().getSystemService(Context.VIBRATOR_SERVICE);</span>
<span class="nc" id="L2723">            } catch (Throwable e) {</span>
<span class="nc" id="L2724">                Log.e(&quot;Codename One&quot;, &quot;problem with virbrator(0)&quot;, e);</span>
            } finally {
<span class="nc" id="L2726">                this.vibrateInitialized = true;</span>
            }
        }
<span class="nc bnc" id="L2729" title="All 2 branches missed.">        if (v != null) {</span>
            try {
<span class="nc" id="L2731">                v.vibrate(duration);</span>
<span class="nc" id="L2732">            } catch (Throwable e) {</span>
<span class="nc" id="L2733">                Log.e(&quot;Codename One&quot;, &quot;problem with virbrator(1)&quot;, e);</span>
<span class="nc" id="L2734">            }</span>
        }
<span class="nc" id="L2736">    }</span>

    @Override
    public boolean isTouchDevice() {
<span class="fc" id="L2740">        return getContext().getPackageManager().hasSystemFeature(PackageManager.FEATURE_TOUCHSCREEN);</span>
    }

    @Override
    public boolean hasPendingPaints() {
        //if the view is not visible make sure the edt won't wait.
<span class="pc bpc" id="L2746" title="2 of 4 branches missed.">        if (myView != null &amp;&amp; myView.getAndroidView().getVisibility() != View.VISIBLE) {</span>
<span class="nc" id="L2747">            return true;</span>
        } else {
<span class="fc" id="L2749">            return super.hasPendingPaints();</span>
        }
    }

    public void revalidate() {
<span class="pc bpc" id="L2754" title="1 of 2 branches missed.">        if (myView != null) {</span>
<span class="fc" id="L2755">            myView.getAndroidView().setVisibility(View.VISIBLE);</span>
<span class="fc" id="L2756">            Form form = getCurrentForm();</span>
<span class="pc bpc" id="L2757" title="1 of 2 branches missed.">            if (form != null) {</span>
<span class="nc" id="L2758">                form.revalidate();</span>
            }
<span class="fc" id="L2760">            flushGraphics();</span>
        }

<span class="fc" id="L2763">    }</span>

    @Override
    public int getKeyboardType() {
<span class="pc bpc" id="L2767" title="1 of 2 branches missed.">        if (Display.getInstance().getDefaultVirtualKeyboard().isVirtualKeyboardShowing()) {</span>
<span class="nc" id="L2768">            return Display.KEYBOARD_TYPE_VIRTUAL;</span>
        }
        /**
         * can we detect this? but even if we could i think it is best to have
         * this fixed to qwerty. we pass unicode values to Codename One in any
         * case. check AndroidView.onKeyUpDown() method. and read comment below.
         */
<span class="fc" id="L2775">        return Display.KEYBOARD_TYPE_QWERTY;</span>
        /**
         * some info from the MIDP docs about keycodes:
         *
         * &quot;Applications receive keystroke events in which the individual keys
         * are named within a space of key codes. Every key for which events are
         * reported to MIDP applications is assigned a key code. The key code
         * values are unique for each hardware key unless two keys are obvious
         * synonyms for each other. MIDP defines the following key codes:
         * KEY_NUM0, KEY_NUM1, KEY_NUM2, KEY_NUM3, KEY_NUM4, KEY_NUM5, KEY_NUM6,
         * KEY_NUM7, KEY_NUM8, KEY_NUM9, KEY_STAR, and KEY_POUND. (These key
         * codes correspond to keys on a ITU-T standard telephone keypad.) Other
         * keys may be present on the keyboard, and they will generally have key
         * codes distinct from those list above. In order to guarantee
         * portability, applications should use only the standard key codes.
         *
         * The standard key codes values are equal to the Unicode encoding for
         * the character that represents the key. If the device includes any
         * other keys that have an obvious correspondence to a Unicode
         * character, their key code values should equal the Unicode encoding
         * for that character. For keys that have no corresponding Unicode
         * character, the implementation must use negative values. Zero is
         * defined to be an invalid key code.&quot;
         *
         * Because the MIDP implementation is our reference and that
         * implementation does not interpret the given keycodes we behave alike
         * and pass on the unicode values.
         */
    }

    /**
     * Exits the application...
     */
    public void exitApplication() {
<span class="nc" id="L2809">        android.os.Process.killProcess(android.os.Process.myPid());</span>
<span class="nc" id="L2810">    }</span>

    @Override
    public void notifyPushCompletion() {
<span class="nc bnc" id="L2814" title="All 4 branches missed.">        if (pushWakeLock != null &amp;&amp; pushWakeLock.isHeld()) {</span>
            try {
<span class="nc" id="L2816">                pushWakeLock.release();</span>
<span class="nc" id="L2817">            } catch (Exception ex) {</span>
<span class="nc" id="L2818">                com.codename1.io.Log.e(ex);</span>
<span class="nc" id="L2819">            }</span>
        }
<span class="nc" id="L2821">    }</span>

    @Override
    public void notifyCommandBehavior(int commandBehavior) {
<span class="fc bfc" id="L2825" title="All 2 branches covered.">        if (commandBehavior == Display.COMMAND_BEHAVIOR_NATIVE) {</span>
<span class="pc bpc" id="L2826" title="1 of 2 branches missed.">            if (getActivity() instanceof CodenameOneActivity) {</span>
<span class="fc" id="L2827">                ((CodenameOneActivity) getActivity()).enableNativeMenu(true);</span>
            }
        }
<span class="fc" id="L2830">    }</span>

    private static class NotifyActionBar implements Runnable {
        private Activity activity;
        private boolean show;

<span class="nc" id="L2836">        public NotifyActionBar(Activity activity, int commandBehavior) {</span>
<span class="nc" id="L2837">            this.activity = activity;</span>
<span class="nc bnc" id="L2838" title="All 2 branches missed.">            show = commandBehavior == Display.COMMAND_BEHAVIOR_NATIVE;</span>
<span class="nc" id="L2839">        }</span>

<span class="fc" id="L2841">        public NotifyActionBar(Activity activity, boolean show) {</span>
<span class="fc" id="L2842">            this.activity = activity;</span>
<span class="fc" id="L2843">            this.show = show;</span>
<span class="fc" id="L2844">        }</span>

        @Override
        public void run() {
<span class="fc" id="L2848">            activity.invalidateOptionsMenu();</span>
<span class="pc bpc" id="L2849" title="1 of 2 branches missed.">            if (activity.getActionBar() == null) {</span>
<span class="nc" id="L2850">                return;</span>
            }
<span class="pc bpc" id="L2852" title="1 of 2 branches missed.">            if (show) {</span>
<span class="nc" id="L2853">                activity.getActionBar().show();</span>
            } else {
<span class="fc" id="L2855">                activity.getActionBar().hide();</span>
            }
<span class="fc" id="L2857">        }</span>
    }

    @Override
    public String getAppArg() {
<span class="nc bnc" id="L2862" title="All 2 branches missed.">        if (super.getAppArg() != null) {</span>
            // This just maintains backward compatibility in case people are manually
            // setting the AppArg in their properties.  It reproduces the general
            // behaviour the existed when AppArg was just another Display property.
<span class="nc" id="L2866">            return super.getAppArg();</span>
        }
<span class="nc bnc" id="L2868" title="All 2 branches missed.">        if (getActivity() == null) {</span>
<span class="nc" id="L2869">            return null;</span>
        }

<span class="nc" id="L2872">        android.content.Intent intent = getActivity().getIntent();</span>
<span class="nc bnc" id="L2873" title="All 2 branches missed.">        if (intent != null) {</span>
<span class="nc" id="L2874">            String sharedText = intent.getStringExtra(Intent.EXTRA_TEXT);</span>
<span class="nc" id="L2875">            intent.removeExtra(Intent.EXTRA_TEXT);</span>
<span class="nc" id="L2876">            Uri u = intent.getData();</span>
<span class="nc" id="L2877">            String scheme = intent.getScheme();</span>
<span class="nc bnc" id="L2878" title="All 4 branches missed.">            if (u == null &amp;&amp; intent.getExtras() != null) {</span>
<span class="nc bnc" id="L2879" title="All 2 branches missed.">                if (intent.getExtras().keySet().contains(&quot;android.intent.extra.STREAM&quot;)) {</span>
                    try {
<span class="nc" id="L2881">                        u = (Uri)intent.getParcelableExtra(&quot;android.intent.extra.STREAM&quot;);</span>
<span class="nc" id="L2882">                        scheme = u.getScheme();</span>
<span class="nc" id="L2883">                        System.out.println(&quot;u=&quot;+u);</span>
<span class="nc" id="L2884">                    } catch (Exception ex) {</span>
<span class="nc" id="L2885">                        Log.d(&quot;Codename One&quot;, &quot;Failed to load parcelable extra from intent: &quot;+ex.getMessage());</span>
<span class="nc" id="L2886">                    }</span>
                }

            }
<span class="nc bnc" id="L2890" title="All 2 branches missed.">            if (u != null) {</span>
                //String scheme = intent.getScheme();
<span class="nc" id="L2892">                intent.setData(null);</span>
<span class="nc bnc" id="L2893" title="All 2 branches missed.">                if (&quot;content&quot;.equals(scheme)) {</span>
                    try {
<span class="nc" id="L2895">                        InputStream attachment = getActivity().getContentResolver().openInputStream(u);</span>
<span class="nc bnc" id="L2896" title="All 2 branches missed.">                        if (attachment != null) {</span>
<span class="nc" id="L2897">                            String name = getContentName(getActivity().getContentResolver(), u);</span>
<span class="nc bnc" id="L2898" title="All 2 branches missed.">                            if (name != null) {</span>
<span class="nc" id="L2899">                                String filePath = getAppHomePath()</span>
<span class="nc" id="L2900">                                        + getFileSystemSeparator() + name;</span>
<span class="nc bnc" id="L2901" title="All 2 branches missed.">                                if(filePath.startsWith(&quot;file:&quot;)) {</span>
<span class="nc" id="L2902">                                    filePath = filePath.substring(5);</span>
                                }
<span class="nc" id="L2904">                                File f = new File(filePath);</span>
<span class="nc" id="L2905">                                OutputStream tmp = createFileOuputStream(f);</span>
<span class="nc" id="L2906">                                byte[] buffer = new byte[1024];</span>
<span class="nc" id="L2907">                                int read = -1;</span>
<span class="nc bnc" id="L2908" title="All 2 branches missed.">                                while ((read = attachment.read(buffer)) &gt; -1) {</span>
<span class="nc" id="L2909">                                    tmp.write(buffer, 0, read);</span>
                                }
<span class="nc" id="L2911">                                tmp.close();</span>
<span class="nc" id="L2912">                                attachment.close();</span>
<span class="nc" id="L2913">                                setAppArg(addFile(filePath));</span>
<span class="nc" id="L2914">                                return addFile(filePath);</span>
                            }
                        }
<span class="nc" id="L2917">                    } catch (FileNotFoundException e) {</span>
<span class="nc" id="L2918">                        e.printStackTrace();</span>
<span class="nc" id="L2919">                        return null;</span>
<span class="nc" id="L2920">                    } catch (IOException e) {</span>
<span class="nc" id="L2921">                        e.printStackTrace();</span>
<span class="nc" id="L2922">                        return null;</span>
<span class="nc" id="L2923">                    } catch (Exception e) {</span>
<span class="nc" id="L2924">                        e.printStackTrace();</span>
<span class="nc" id="L2925">                        return null;</span>
<span class="nc" id="L2926">                    }</span>
                } else {

                    /*
                    // Why do we need this special case?  u.toString()
                    // will include the full URL including query string.
                    // This special case causes urls like myscheme://part1/part2
                    // to only return &quot;/part2&quot; which is obviously problematic and
                    // is inconsistent with iOS.  Is this special case necessary
                    // in some versions of Android?
                    String encodedPath = u.getEncodedPath();
                    if (encodedPath != null &amp;&amp; encodedPath.length() &gt; 0) {
                        String query = u.getQuery();
                        if(query != null &amp;&amp; query.length() &gt; 0){
                            encodedPath += &quot;?&quot; + query;
                        }
                        setAppArg(encodedPath);
                        return encodedPath;
                    }
                    */
<span class="nc bnc" id="L2946" title="All 2 branches missed.">                    if (sharedText != null) {</span>
<span class="nc" id="L2947">                        setAppArg(sharedText);</span>
<span class="nc" id="L2948">                        return sharedText;</span>
                    } else {
<span class="nc" id="L2950">                        setAppArg(u.toString());</span>
<span class="nc" id="L2951">                        return u.toString();</span>
                    }

                }
<span class="nc bnc" id="L2955" title="All 2 branches missed.">            } else if (sharedText != null) {</span>
<span class="nc" id="L2956">                setAppArg(sharedText);</span>
<span class="nc" id="L2957">                return sharedText;</span>
            }
        }
<span class="nc" id="L2960">        return null;</span>
    }
    
    // taken from https://stackoverflow.com/a/70380413/756809
    private boolean isRunningOnAndroidStudioEmulator() {
<span class="nc bnc" id="L2965" title="All 2 branches missed.">        return Build.FINGERPRINT.startsWith(&quot;google/sdk_gphone&quot;)</span>
<span class="nc bnc" id="L2966" title="All 4 branches missed.">                &amp;&amp; Build.FINGERPRINT.endsWith(&quot;:user/release-keys&quot;)</span>
<span class="nc bnc" id="L2967" title="All 4 branches missed.">                &amp;&amp; Build.MANUFACTURER == &quot;Google&quot; &amp;&amp; Build.PRODUCT.startsWith(&quot;sdk_gphone&quot;) &amp;&amp; Build.BRAND == &quot;google&quot;</span>
<span class="nc bnc" id="L2968" title="All 2 branches missed.">                &amp;&amp; Build.MODEL.startsWith(&quot;sdk_gphone&quot;);</span>
    }

    // taken from https://stackoverflow.com/a/57960169/756809
    private boolean isEmulator() {
<span class="nc bnc" id="L2973" title="All 2 branches missed.">        return isRunningOnAndroidStudioEmulator() ||</span>
<span class="nc bnc" id="L2974" title="All 4 branches missed.">                ((Build.BRAND.startsWith(&quot;generic&quot;) &amp;&amp; Build.DEVICE.startsWith(&quot;generic&quot;))</span>
<span class="nc bnc" id="L2975" title="All 2 branches missed.">                || Build.FINGERPRINT.startsWith(&quot;generic&quot;)</span>
<span class="nc bnc" id="L2976" title="All 2 branches missed.">                || Build.FINGERPRINT.startsWith(&quot;unknown&quot;)</span>
<span class="nc bnc" id="L2977" title="All 2 branches missed.">                || Build.HARDWARE.contains(&quot;goldfish&quot;)</span>
<span class="nc bnc" id="L2978" title="All 2 branches missed.">                || Build.HARDWARE.contains(&quot;ranchu&quot;)</span>
<span class="nc bnc" id="L2979" title="All 2 branches missed.">                || Build.MODEL.contains(&quot;google_sdk&quot;)</span>
<span class="nc bnc" id="L2980" title="All 2 branches missed.">                || Build.MODEL.contains(&quot;Emulator&quot;)</span>
<span class="nc bnc" id="L2981" title="All 2 branches missed.">                || Build.MODEL.contains(&quot;Android SDK built for x86&quot;)</span>
<span class="nc bnc" id="L2982" title="All 2 branches missed.">                || Build.MODEL.contains(&quot;VirtualBox&quot;)</span>
<span class="nc bnc" id="L2983" title="All 2 branches missed.">                || Build.MANUFACTURER.contains(&quot;Genymotion&quot;)</span>
<span class="nc bnc" id="L2984" title="All 2 branches missed.">                || Build.PRODUCT.contains(&quot;sdk_google&quot;)</span>
<span class="nc bnc" id="L2985" title="All 2 branches missed.">                || Build.PRODUCT.contains(&quot;google_sdk&quot;)</span>
<span class="nc bnc" id="L2986" title="All 2 branches missed.">                || Build.PRODUCT.contains(&quot;sdk&quot;)</span>
<span class="nc bnc" id="L2987" title="All 2 branches missed.">                || Build.PRODUCT.contains(&quot;sdk_x86&quot;)</span>
<span class="nc bnc" id="L2988" title="All 2 branches missed.">                || Build.PRODUCT.contains(&quot;vbox86p&quot;)</span>
<span class="nc bnc" id="L2989" title="All 2 branches missed.">                || Build.PRODUCT.contains(&quot;emulator&quot;)</span>
<span class="nc bnc" id="L2990" title="All 2 branches missed.">                || Build.PRODUCT.contains(&quot;simulator&quot;));</span>
    }


    /**
     * @inheritDoc
     */
    @Override
    public boolean canDial() {
<span class="nc" id="L2999">        return getContext().getPackageManager().hasSystemFeature(PackageManager.FEATURE_TELEPHONY);</span>
    }

    /**
     * @inheritDoc
     */
    public String getProperty(String key, String defaultValue) {
<span class="pc bpc" id="L3006" title="1 of 2 branches missed.">        if(key.equalsIgnoreCase(&quot;cn1_push_prefix&quot;)) {</span>
            /*if(!checkForPermission(Manifest.permission.READ_PHONE_STATE, &quot;This is required to get notifications&quot;)){
                return &quot;&quot;;
            }*/
<span class="nc" id="L3010">            boolean has = hasAndroidMarket();</span>
<span class="nc bnc" id="L3011" title="All 2 branches missed.">            if(has) {</span>
<span class="nc" id="L3012">                return &quot;gcm&quot;;</span>
            }
<span class="nc" id="L3014">            return defaultValue;</span>
        }
<span class="pc bpc" id="L3016" title="1 of 2 branches missed.">        if (&quot;OS&quot;.equals(key)) {</span>
<span class="nc" id="L3017">            return &quot;Android&quot;;</span>
        }

        // It's possible that this is triggering a Google Play data collection verification error
        /*if (&quot;androidId&quot;.equals(key)) {
            return Settings.Secure.getString(getContext().getContentResolver(), Settings.Secure.ANDROID_ID);
        }*/

        /*if (&quot;cellId&quot;.equals(key)) {
            try {
                if(!checkForPermission(Manifest.permission.READ_PHONE_STATE, &quot;This is required to get the cellId&quot;)){
                    return defaultValue;
                }
                String serviceName = Context.TELEPHONY_SERVICE;
                TelephonyManager telephonyManager = (TelephonyManager) getContext().getSystemService(serviceName);
                int cellId = ((GsmCellLocation) telephonyManager.getCellLocation()).getCid();
                return &quot;&quot; + cellId;
            } catch (Throwable t) {
                return defaultValue;
            }
        }*/
<span class="fc bfc" id="L3038" title="All 2 branches covered.">        if (&quot;AppName&quot;.equals(key)) {</span>

<span class="fc" id="L3040">            final PackageManager pm = getContext().getPackageManager();</span>
            ApplicationInfo ai;
            try {
<span class="fc" id="L3043">                ai = pm.getApplicationInfo(getContext().getPackageName(), 0);</span>
<span class="nc" id="L3044">            } catch (NameNotFoundException e) {</span>
<span class="nc" id="L3045">                ai = null;</span>
<span class="fc" id="L3046">            }</span>
<span class="pc bpc" id="L3047" title="1 of 2 branches missed.">            String applicationName = (String) (ai != null ? pm.getApplicationLabel(ai) : null);</span>
<span class="pc bpc" id="L3048" title="1 of 2 branches missed.">            if(applicationName == null){</span>
<span class="nc" id="L3049">                return defaultValue;</span>
            }
<span class="fc" id="L3051">            return applicationName;</span>
        }
<span class="pc bpc" id="L3053" title="1 of 2 branches missed.">        if (&quot;AppVersion&quot;.equals(key)) {</span>
            try {
<span class="nc" id="L3055">                PackageInfo i = getContext().getPackageManager().getPackageInfo(getContext().getApplicationInfo().packageName, 0);</span>
<span class="nc" id="L3056">                return i.versionName;</span>
<span class="nc" id="L3057">            } catch (NameNotFoundException ex) {</span>
<span class="nc" id="L3058">                ex.printStackTrace();</span>
            }
<span class="nc" id="L3060">            return defaultValue;</span>
        }
<span class="pc bpc" id="L3062" title="1 of 2 branches missed.">        if (&quot;Platform&quot;.equals(key)) {</span>
<span class="nc" id="L3063">            String p = System.getProperty(&quot;platform&quot;);</span>
<span class="nc bnc" id="L3064" title="All 2 branches missed.">            if(p == null) {</span>
<span class="nc" id="L3065">                return defaultValue;</span>
            }
<span class="nc" id="L3067">            return p;</span>
        }
<span class="fc bfc" id="L3069" title="All 2 branches covered.">        if (&quot;User-Agent&quot;.equals(key)) {</span>
<span class="fc" id="L3070">            String ua = getUserAgent();</span>
<span class="pc bpc" id="L3071" title="1 of 2 branches missed.">            if(ua == null) {</span>
<span class="nc" id="L3072">                return defaultValue;</span>
            }
<span class="fc" id="L3074">            return ua;</span>
        }
<span class="pc bpc" id="L3076" title="1 of 2 branches missed.">        if(&quot;OSVer&quot;.equals(key)) {</span>
<span class="nc" id="L3077">            return &quot;&quot; + android.os.Build.VERSION.RELEASE;</span>
        }
<span class="pc bpc" id="L3079" title="1 of 2 branches missed.">        if(&quot;DeviceName&quot;.equals(key)) {</span>
<span class="nc" id="L3080">            return &quot;&quot; + android.os.Build.MODEL;</span>
        }
<span class="pc bpc" id="L3082" title="1 of 2 branches missed.">        if(&quot;Emulator&quot;.equals(key)) {</span>
<span class="nc" id="L3083">            return &quot;&quot; + isEmulator();</span>
        }
        /*try {
            if (&quot;IMEI&quot;.equals(key) || &quot;UDID&quot;.equals(key)) {
                if(!checkForPermission(Manifest.permission.READ_PHONE_STATE, &quot;This is required to get the device ID&quot;)){
                    return &quot;&quot;;
                }
                TelephonyManager tm = (TelephonyManager) getContext().getSystemService(Context.TELEPHONY_SERVICE);
                String imei = null;
                if (tm!=null &amp;&amp; tm.getDeviceId() != null) {
                    // for phones or 3g tablets
                    imei = tm.getDeviceId();
                } else {
                    try {
                        imei = Secure.getString(getContext().getContentResolver(), Secure.ANDROID_ID);
                    } catch(Throwable t) {
                        com.codename1.io.Log.e(t);
                    }
                }
                return imei;
            }
            if (&quot;MSISDN&quot;.equals(key)) {
                if(!checkForPermission(Manifest.permission.READ_PHONE_STATE, &quot;This is required to get the device ID&quot;)){
                    return &quot;&quot;;
                }
                TelephonyManager tm = (TelephonyManager) getContext().getSystemService(Context.TELEPHONY_SERVICE);
                return tm.getLine1Number();
            }
        } catch(Throwable t) {
            // will be caused by no permissions.
            return defaultValue;
        }*/

<span class="pc bpc" id="L3116" title="1 of 2 branches missed.">        if (getActivity() != null) {</span>
<span class="fc" id="L3117">            android.content.Intent intent = getActivity().getIntent();</span>
<span class="pc bpc" id="L3118" title="1 of 2 branches missed.">            if(intent != null){</span>
<span class="fc" id="L3119">                Bundle extras = intent.getExtras();</span>
<span class="pc bpc" id="L3120" title="1 of 2 branches missed.">                if (extras != null) {</span>
<span class="nc" id="L3121">                    String value = extras.getString(key);</span>
<span class="nc bnc" id="L3122" title="All 2 branches missed.">                    if(value != null) {</span>
<span class="nc" id="L3123">                        return value;</span>
                    }
                }
            }
        }

<span class="pc bpc" id="L3129" title="1 of 2 branches missed.">        if(!key.startsWith(&quot;android.permission&quot;)) {</span>
            //these keys/values are from the Application Resources (strings values)
            try {
<span class="fc" id="L3132">                int id = getContext().getResources().getIdentifier(key, &quot;string&quot;, getContext().getApplicationInfo().packageName);</span>
<span class="pc bpc" id="L3133" title="1 of 2 branches missed.">                if (id != 0) {</span>
<span class="nc" id="L3134">                    String val = getContext().getResources().getString(id);</span>
<span class="nc" id="L3135">                    return val;</span>
                }
<span class="nc" id="L3137">            } catch (Exception e) {</span>
<span class="fc" id="L3138">            }</span>
        }
<span class="fc" id="L3140">        return System.getProperty(key, super.getProperty(key, defaultValue));</span>
    }

    private String getContentName(ContentResolver resolver, Uri uri) {
<span class="nc" id="L3144">        Cursor cursor = resolver.query(uri, null, null, null, null);</span>
<span class="nc" id="L3145">        cursor.moveToFirst();</span>
<span class="nc" id="L3146">        int nameIndex = cursor.getColumnIndex(MediaStore.MediaColumns.DISPLAY_NAME);</span>
<span class="nc bnc" id="L3147" title="All 2 branches missed.">        if (nameIndex &gt;= 0) {</span>
<span class="nc" id="L3148">            String name = cursor.getString(nameIndex);</span>
<span class="nc" id="L3149">            cursor.close();</span>
<span class="nc" id="L3150">            return name;</span>
        }
<span class="nc" id="L3152">        return null;</span>
    }

    private String getUserAgent() {
        try {
<span class="fc" id="L3157">            String userAgent = System.getProperty(&quot;http.agent&quot;);</span>
<span class="pc bpc" id="L3158" title="1 of 2 branches missed.">            if(userAgent != null){</span>
<span class="fc" id="L3159">                return userAgent;</span>
            }
<span class="nc" id="L3161">        } catch (Exception e) {</span>
<span class="nc" id="L3162">        }</span>
<span class="nc bnc" id="L3163" title="All 2 branches missed.">        if (getActivity() == null) {</span>
<span class="nc" id="L3164">            return &quot;Android-CN1&quot;;</span>
        }
        try {
<span class="nc" id="L3167">            Constructor&lt;WebSettings&gt; constructor = WebSettings.class.getDeclaredConstructor(Context.class, WebView.class);</span>
<span class="nc" id="L3168">            constructor.setAccessible(true);</span>
            try {
<span class="nc" id="L3170">                WebSettings settings = constructor.newInstance(getActivity(), null);</span>
<span class="nc" id="L3171">                return settings.getUserAgentString();</span>
            } finally {
<span class="nc" id="L3173">                constructor.setAccessible(false);</span>
            }
<span class="nc" id="L3175">        } catch (Exception e) {</span>
<span class="nc" id="L3176">            final StringBuffer ua = new StringBuffer();</span>
<span class="nc bnc" id="L3177" title="All 2 branches missed.">            if (Thread.currentThread().getName().equalsIgnoreCase(&quot;main&quot;)) {</span>
<span class="nc" id="L3178">                WebView m_webview = new WebView(getActivity());</span>
<span class="nc" id="L3179">                ua.append(m_webview.getSettings().getUserAgentString());</span>
<span class="nc" id="L3180">                m_webview.destroy();</span>
<span class="nc" id="L3181">            } else {</span>
<span class="nc" id="L3182">                final boolean[] flag = new boolean[1];</span>
<span class="nc" id="L3183">                Thread thread = new Thread() {</span>
                    public void run() {
<span class="nc" id="L3185">                        Looper.prepare();</span>
<span class="nc" id="L3186">                        WebView m_webview = new WebView(getActivity());</span>
<span class="nc" id="L3187">                        ua.append(m_webview.getSettings().getUserAgentString());</span>
<span class="nc" id="L3188">                        m_webview.destroy();</span>
<span class="nc" id="L3189">                        Looper.loop();</span>
<span class="nc" id="L3190">                        flag[0] = true;</span>
<span class="nc" id="L3191">                        synchronized (flag) {</span>
<span class="nc" id="L3192">                            flag.notify();</span>
<span class="nc" id="L3193">                        }</span>
<span class="nc" id="L3194">                    }</span>
                };
<span class="nc" id="L3196">                thread.setUncaughtExceptionHandler(AndroidImplementation.exceptionHandler);</span>
<span class="nc" id="L3197">                thread.start();</span>
<span class="nc bnc" id="L3198" title="All 2 branches missed.">                while (!flag[0]) {</span>
<span class="nc" id="L3199">                    synchronized (flag) {</span>
                        try {
<span class="nc" id="L3201">                            flag.wait(100);</span>
<span class="nc" id="L3202">                        } catch (InterruptedException ex) {</span>
<span class="nc" id="L3203">                        }</span>
<span class="nc" id="L3204">                    }</span>
                }
            }
<span class="nc" id="L3207">            return ua.toString();</span>
        }
    }

    private String getMimeType(String url){
<span class="nc" id="L3212">        String type = null;</span>
<span class="nc" id="L3213">        String extension = MimeTypeMap.getFileExtensionFromUrl(url);</span>
<span class="nc bnc" id="L3214" title="All 2 branches missed.">        if (extension != null) {</span>
<span class="nc" id="L3215">            MimeTypeMap mime = MimeTypeMap.getSingleton();</span>

<span class="nc" id="L3217">            type = mime.getMimeTypeFromExtension(extension);</span>
        }
<span class="nc bnc" id="L3219" title="All 2 branches missed.">        if (type == null) {</span>
            try {
<span class="nc" id="L3221">                Uri uri = Uri.parse(url);</span>
<span class="nc" id="L3222">                ContentResolver cr = getContext().getContentResolver();</span>
<span class="nc" id="L3223">                type = cr.getType(uri);</span>
<span class="nc" id="L3224">            } catch (Throwable t) {</span>
<span class="nc" id="L3225">                t.printStackTrace();</span>
<span class="nc" id="L3226">            }</span>
        }
<span class="nc" id="L3228">        return type;</span>
    }

    public static void copy(File src, File dst) throws IOException {
<span class="nc" id="L3232">        InputStream in = new FileInputStream(src);</span>
        try {
<span class="nc" id="L3234">            OutputStream out = new FileOutputStream(dst);</span>
            try {
                // Transfer bytes from in to out
<span class="nc" id="L3237">                byte[] buf = new byte[8096];</span>
                int len;
<span class="nc bnc" id="L3239" title="All 2 branches missed.">                while ((len = in.read(buf)) &gt; 0) {</span>
<span class="nc" id="L3240">                    out.write(buf, 0, len);</span>
                }
            } finally {
<span class="nc" id="L3243">                out.close();</span>
            }
        } finally {
<span class="nc" id="L3246">            in.close();</span>
        }
<span class="nc" id="L3248">    }</span>

    private static File makeTempCacheCopy(File file) throws IOException {
<span class="nc" id="L3251">        File cacheDir = new File(getContext().getCacheDir(), &quot;intent_files&quot;);</span>

        // Create the storage directory if it does not exist
<span class="nc bnc" id="L3254" title="All 2 branches missed.">        if (!cacheDir.exists()) {</span>
<span class="nc bnc" id="L3255" title="All 2 branches missed.">            if (!cacheDir.mkdirs()) {</span>
<span class="nc" id="L3256">                Log.d(Display.getInstance().getProperty(&quot;AppName&quot;, &quot;CodenameOne&quot;), &quot;failed to create directory&quot;);</span>
<span class="nc" id="L3257">                return null;</span>
            }
        }

<span class="nc" id="L3261">        File copy = new File(cacheDir, &quot;tmp-&quot;+System.currentTimeMillis()+file.getName());</span>
<span class="nc" id="L3262">        copy(file, copy);</span>
<span class="nc" id="L3263">        return copy;</span>

    }



    private Intent createIntentForURL(String url) {
        Intent intent;
        Uri uri;
        try {
<span class="nc bnc" id="L3273" title="All 2 branches missed.">            if (url.startsWith(&quot;intent&quot;)) {</span>
<span class="nc" id="L3274">                intent = Intent.parseUri(url, Intent.URI_INTENT_SCHEME);</span>
            } else {
<span class="nc bnc" id="L3276" title="All 4 branches missed.">                if(url.startsWith(&quot;/&quot;) || url.startsWith(&quot;file:&quot;)) {</span>
<span class="nc bnc" id="L3277" title="All 2 branches missed.">                    if (PermissionsHelper.requiresExternalStoragePermissionForMediaAccess()) {</span>
<span class="nc bnc" id="L3278" title="All 2 branches missed.">                        if(!checkForPermission(Manifest.permission.WRITE_EXTERNAL_STORAGE, &quot;This is required to open the file&quot;)){</span>
<span class="nc" id="L3279">                            return null;</span>
                        }
                    }

                }
<span class="nc" id="L3284">                intent = new Intent();</span>
<span class="nc" id="L3285">                intent.setAction(Intent.ACTION_VIEW);</span>
<span class="nc bnc" id="L3286" title="All 2 branches missed.">                if (url.startsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L3287">                    File f = new File(url);</span>
<span class="nc" id="L3288">                    Uri furi = null;</span>
                    try {
<span class="nc" id="L3290">                        furi = FileProvider.getUriForFile(getContext(), getContext().getPackageName()+&quot;.provider&quot;, f);</span>
<span class="nc" id="L3291">                    } catch (Exception ex) {</span>
<span class="nc" id="L3292">                        f = makeTempCacheCopy(f);</span>
<span class="nc" id="L3293">                        furi = FileProvider.getUriForFile(getContext(), getContext().getPackageName()+&quot;.provider&quot;, f);</span>
<span class="nc" id="L3294">                    }</span>
        
        
<span class="nc bnc" id="L3297" title="All 2 branches missed.">                    if (Build.VERSION.SDK_INT &lt; 21) {</span>
<span class="nc" id="L3298">                        List&lt;ResolveInfo&gt; resInfoList = getContext().getPackageManager().queryIntentActivities(intent, PackageManager.MATCH_DEFAULT_ONLY);</span>
<span class="nc bnc" id="L3299" title="All 2 branches missed.">                        for (ResolveInfo resolveInfo : resInfoList) {</span>
<span class="nc" id="L3300">                            String packageName = resolveInfo.activityInfo.packageName;</span>
<span class="nc" id="L3301">                            getContext().grantUriPermission(packageName, furi, Intent.FLAG_GRANT_WRITE_URI_PERMISSION | Intent.FLAG_GRANT_READ_URI_PERMISSION);</span>
<span class="nc" id="L3302">                        }</span>
                    }
                    
<span class="nc" id="L3305">                    uri = furi;</span>
<span class="nc" id="L3306">                    intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK|Intent.FLAG_GRANT_READ_URI_PERMISSION);</span>
<span class="nc" id="L3307">                }else{</span>

<span class="nc bnc" id="L3309" title="All 2 branches missed.">                    if (url.startsWith(&quot;file:&quot;)) {</span>
<span class="nc" id="L3310">                        File f = new File(removeFilePrefix(url));</span>
<span class="nc" id="L3311">                        System.out.println(&quot;File size: &quot;+f.length());</span>

<span class="nc" id="L3313">                        Uri furi = null;</span>
                        try {
<span class="nc" id="L3315">                            furi = FileProvider.getUriForFile(getContext(), getContext().getPackageName()+&quot;.provider&quot;, f);</span>
<span class="nc" id="L3316">                        } catch (Exception ex) {</span>
<span class="nc" id="L3317">                            f = makeTempCacheCopy(f);</span>
<span class="nc" id="L3318">                            furi = FileProvider.getUriForFile(getContext(), getContext().getPackageName()+&quot;.provider&quot;, f);</span>
<span class="nc" id="L3319">                        }</span>


<span class="nc bnc" id="L3322" title="All 2 branches missed.">                        if (Build.VERSION.SDK_INT &lt; 21) {</span>
<span class="nc" id="L3323">                            List&lt;ResolveInfo&gt; resInfoList = getContext().getPackageManager().queryIntentActivities(intent, PackageManager.MATCH_DEFAULT_ONLY);</span>
<span class="nc bnc" id="L3324" title="All 2 branches missed.">                            for (ResolveInfo resolveInfo : resInfoList) {</span>
<span class="nc" id="L3325">                                String packageName = resolveInfo.activityInfo.packageName;</span>
<span class="nc" id="L3326">                                getContext().grantUriPermission(packageName, furi, Intent.FLAG_GRANT_WRITE_URI_PERMISSION | Intent.FLAG_GRANT_READ_URI_PERMISSION);</span>
<span class="nc" id="L3327">                            }</span>
                        }
<span class="nc" id="L3329">                        uri = furi;</span>
<span class="nc" id="L3330">                        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK|Intent.FLAG_GRANT_READ_URI_PERMISSION);</span>


<span class="nc" id="L3333">                    } else {</span>
<span class="nc" id="L3334">                        uri = Uri.parse(url);</span>
                    }
                }
<span class="nc" id="L3337">                String mimeType = getMimeType(url);</span>
<span class="nc bnc" id="L3338" title="All 2 branches missed.">                if(mimeType != null){</span>
<span class="nc" id="L3339">                    intent.setDataAndType(uri, mimeType);</span>
                }else{
<span class="nc" id="L3341">                    intent.setData(uri);</span>
                }
            }

<span class="nc" id="L3345">            return intent;</span>
<span class="nc" id="L3346">        } catch(Exception err) {</span>
<span class="nc" id="L3347">            com.codename1.io.Log.e(err);</span>
<span class="nc" id="L3348">            return null;</span>
        }
    }

    @Override
    public Boolean canExecute(String url) {
        try {
<span class="nc" id="L3355">            Intent it = createIntentForURL(url);</span>
<span class="nc bnc" id="L3356" title="All 2 branches missed.">            if(it == null) {</span>
<span class="nc" id="L3357">                return false;</span>
            }
<span class="nc" id="L3359">            final PackageManager mgr = getContext().getPackageManager();</span>
<span class="nc" id="L3360">            List&lt;ResolveInfo&gt; list = mgr.queryIntentActivities(it, PackageManager.MATCH_DEFAULT_ONLY);</span>
<span class="nc bnc" id="L3361" title="All 2 branches missed.">            return list.size() &gt; 0;</span>
<span class="nc" id="L3362">        } catch(Exception err) {</span>
<span class="nc" id="L3363">            com.codename1.io.Log.e(err);</span>
<span class="nc" id="L3364">            return false;</span>
        }
    }


    public void execute(String url, ActionListener response) {
<span class="nc bnc" id="L3370" title="All 2 branches missed.">        if (response != null) {</span>
<span class="nc" id="L3371">            callback = new EventDispatcher();</span>
<span class="nc" id="L3372">            callback.addListener(response);</span>
        }

        try {
<span class="nc" id="L3376">            Intent intent = createIntentForURL(url);</span>
<span class="nc bnc" id="L3377" title="All 2 branches missed.">            if(intent == null) {</span>
<span class="nc" id="L3378">                return;</span>
            }
<span class="nc bnc" id="L3380" title="All 4 branches missed.">            if(response != null &amp;&amp; getActivity() != null){</span>
<span class="nc" id="L3381">                getActivity().startActivityForResult(intent, IntentResultListener.URI_SCHEME);</span>
            }else {
<span class="nc" id="L3383">                getContext().startActivity(intent);</span>
            }
<span class="nc" id="L3385">            return;</span>
<span class="nc" id="L3386">        } catch (Exception ex) {</span>
<span class="nc" id="L3387">            com.codename1.io.Log.e(ex);</span>
        }

        try {
<span class="nc bnc" id="L3391" title="All 2 branches missed.">            if(editInProgress()) {</span>
<span class="nc" id="L3392">                stopEditing(true);</span>
            }
<span class="nc" id="L3394">            getContext().startActivity(new Intent(Intent.ACTION_VIEW, Uri.parse(url)));</span>
<span class="nc" id="L3395">        } catch (Exception e) {</span>
<span class="nc" id="L3396">            e.printStackTrace();</span>
<span class="nc" id="L3397">        }</span>
<span class="nc" id="L3398">    }</span>


    /**
     * @inheritDoc
     */
    @Override
    public void execute(String url) {
<span class="nc" id="L3406">        execute(url, null);</span>
<span class="nc" id="L3407">    }</span>

    /**
     * @inheritDoc
     */
    public void playBuiltinSound(String soundIdentifier) {
<span class="nc bnc" id="L3413" title="All 4 branches missed.">        if (getActivity() != null &amp;&amp; Display.SOUND_TYPE_BUTTON_PRESS == soundIdentifier) {</span>
<span class="nc" id="L3414">            getActivity().runOnUiThread(new Runnable() {</span>
                public void run() {
<span class="nc bnc" id="L3416" title="All 2 branches missed.">                    if (myView != null) {</span>
<span class="nc" id="L3417">                        myView.getAndroidView().playSoundEffect(AudioManager.FX_KEY_CLICK);</span>
                    }
<span class="nc" id="L3419">                }</span>
            });
        }
<span class="nc" id="L3422">    }</span>

    /**
     * @inheritDoc
     */
    protected void playNativeBuiltinSound(Object data) {
<span class="nc" id="L3428">    }</span>

    /**
     * @inheritDoc
     */
    public boolean isBuiltinSoundAvailable(String soundIdentifier) {
<span class="nc" id="L3434">        return false;</span>
    }

    /**
     * @inheritDoc
     */
    @Override
    public boolean isNativeVideoPlayerControlsIncluded() {
<span class="nc" id="L3442">        return true;</span>
    }
    
    private static final int STATE_PAUSED = 0;
    private static final int STATE_PLAYING = 1;

    private int mCurrentState;

    private MediaBrowserCompat mMediaBrowserCompat;
    private android.support.v4.media.session.MediaControllerCompat mMediaControllerCompat;
    
<span class="fc" id="L3453">    private android.support.v4.media.session.MediaControllerCompat.Callback mMediaControllerCompatCallback = new android.support.v4.media.session.MediaControllerCompat.Callback() {</span>

        @Override
        public void onPlaybackStateChanged(PlaybackStateCompat state) {
<span class="nc" id="L3457">            super.onPlaybackStateChanged(state);</span>
<span class="nc bnc" id="L3458" title="All 2 branches missed.">            if( state == null ) {</span>
<span class="nc" id="L3459">                return;</span>
            }

<span class="nc bnc" id="L3462" title="All 3 branches missed.">            switch( state.getState() ) {</span>
                case PlaybackStateCompat.STATE_PLAYING: {
<span class="nc" id="L3464">                    mCurrentState = STATE_PLAYING;</span>
<span class="nc" id="L3465">                    break;</span>
                }
                case PlaybackStateCompat.STATE_PAUSED: {
<span class="nc" id="L3468">                    mCurrentState = STATE_PAUSED;</span>
                    break;
                }
            }
<span class="nc" id="L3472">        }</span>
    };
    
<span class="fc" id="L3475">    private MediaBrowserCompat.ConnectionCallback mMediaBrowserCompatConnectionCallback = new MediaBrowserCompat.ConnectionCallback() {</span>

        @Override
        public void onConnected() {
<span class="nc" id="L3479">            super.onConnected();</span>
            try {
<span class="nc" id="L3481">                mMediaControllerCompat = new MediaControllerCompat(getActivity(), mMediaBrowserCompat.getSessionToken());</span>
<span class="nc" id="L3482">                mMediaControllerCompat.registerCallback(mMediaControllerCompatCallback);</span>
<span class="nc" id="L3483">                MediaControllerCompat.setMediaController(getActivity(), mMediaControllerCompat);</span>
<span class="nc" id="L3484">                MediaControllerCompat.getMediaController(getActivity()).getTransportControls().play();</span>

<span class="nc" id="L3486">            } catch( RemoteException e ) {</span>
<span class="nc" id="L3487">                e.printStackTrace();</span>
<span class="nc" id="L3488">            }</span>
<span class="nc" id="L3489">        }</span>
    };

    //BackgroundAudioService remoteControl;

    @Override
    public void startRemoteControl() {
<span class="nc" id="L3496">        super.startRemoteControl();</span>
<span class="nc" id="L3497">        getActivity().runOnUiThread(new Runnable() {</span>
            public void run() {
<span class="nc" id="L3499">                mMediaBrowserCompat = new MediaBrowserCompat(getActivity(), new ComponentName(getActivity(), BackgroundAudioService.class),</span>
<span class="nc" id="L3500">                mMediaBrowserCompatConnectionCallback, getActivity().getIntent().getExtras());</span>

<span class="nc" id="L3502">                mMediaBrowserCompat.connect();</span>
<span class="nc" id="L3503">                AndroidNativeUtil.addLifecycleListener(new LifecycleListener() {</span>
                    @Override
                    public void onCreate(Bundle savedInstanceState) {

<span class="nc" id="L3507">                    }</span>

                    @Override
                    public void onResume() {

<span class="nc" id="L3512">                    }</span>

                    @Override
                    public void onPause() {

<span class="nc" id="L3517">                    }</span>

                    @Override
                    public void onDestroy() {
<span class="nc bnc" id="L3521" title="All 2 branches missed.">                        if (mMediaBrowserCompat != null) {</span>
<span class="nc bnc" id="L3522" title="All 2 branches missed.">                            if( MediaControllerCompat.getMediaController(getActivity()).getPlaybackState().getState() == PlaybackStateCompat.STATE_PLAYING ) {</span>
<span class="nc" id="L3523">                                MediaControllerCompat.getMediaController(getActivity()).getTransportControls().pause();</span>
                            }

<span class="nc" id="L3526">                            mMediaBrowserCompat.disconnect();</span>
<span class="nc" id="L3527">                            mMediaBrowserCompat = null;</span>
                        }
<span class="nc" id="L3529">                    }</span>

                    @Override
                    public void onSaveInstanceState(Bundle b) {

<span class="nc" id="L3534">                    }</span>

                    @Override
                    public void onLowMemory() {

<span class="nc" id="L3539">                    }</span>
                });
<span class="nc" id="L3541">            }</span>
            
        });
        
<span class="nc" id="L3545">    }</span>

    @Override
    public void stopRemoteControl() {
<span class="nc" id="L3549">        super.stopRemoteControl(); </span>
<span class="nc bnc" id="L3550" title="All 2 branches missed.">        if (mMediaBrowserCompat != null) {</span>
<span class="nc bnc" id="L3551" title="All 2 branches missed.">            if( MediaControllerCompat.getMediaController(getActivity()).getPlaybackState().getState() == PlaybackStateCompat.STATE_PLAYING ) {</span>
<span class="nc" id="L3552">                MediaControllerCompat.getMediaController(getActivity()).getTransportControls().pause();</span>
            }

<span class="nc" id="L3555">            mMediaBrowserCompat.disconnect();</span>
<span class="nc" id="L3556">            mMediaBrowserCompat = null;</span>
        }
<span class="nc" id="L3558">    }</span>


    @Override
    public AsyncResource&lt;Media&gt; createBackgroundMediaAsync(final String uri) {
<span class="nc" id="L3563">        final AsyncResource&lt;Media&gt; out = new AsyncResource&lt;Media&gt;();</span>
<span class="nc" id="L3564">        new Thread(new Runnable() {</span>
            public void run() {
                try {
<span class="nc" id="L3567">                    out.complete(createBackgroundMedia(uri));</span>
<span class="nc" id="L3568">                } catch (IOException ex) {</span>
<span class="nc" id="L3569">                    out.error(ex);</span>
<span class="nc" id="L3570">                }</span>
<span class="nc" id="L3571">            }</span>
<span class="nc" id="L3572">        }).start();</span>

<span class="nc" id="L3574">        return out;</span>
    }

    private int nextMediaId;
    private int backgroundMediaCount;
    private ServiceConnection backgroundMediaServiceConnection;
    @Override
    public Media createBackgroundMedia(final String uri) throws IOException {
<span class="nc" id="L3582">        int mediaId = nextMediaId++;</span>
<span class="nc" id="L3583">        backgroundMediaCount++;</span>

<span class="nc" id="L3585">        Intent serviceIntent = new Intent(getContext(), AudioService.class);</span>
<span class="nc" id="L3586">        serviceIntent.putExtra(&quot;mediaLink&quot;, uri);</span>
<span class="nc" id="L3587">        serviceIntent.putExtra(&quot;mediaId&quot;, mediaId);</span>
<span class="nc bnc" id="L3588" title="All 2 branches missed.">        if (background == null) {</span>
<span class="nc" id="L3589">            ServiceConnection mConnection = new ServiceConnection() {</span>

                public void onServiceDisconnected(ComponentName name) {

<span class="nc" id="L3593">                    background = null;</span>
<span class="nc" id="L3594">                    backgroundMediaServiceConnection = null;</span>
<span class="nc" id="L3595">                }</span>

                public void onServiceConnected(ComponentName name, IBinder service) {
<span class="nc" id="L3598">                    AudioService.LocalBinder mLocalBinder = (AudioService.LocalBinder) service;</span>
<span class="nc" id="L3599">                    AudioService svc = (AudioService)mLocalBinder.getService();</span>
<span class="nc" id="L3600">                    background = svc;</span>
<span class="nc" id="L3601">                }</span>
            };
<span class="nc" id="L3603">            backgroundMediaServiceConnection = mConnection;</span>
<span class="nc" id="L3604">            boolean boundSuccess = getContext().bindService(serviceIntent, mConnection, getContext().BIND_AUTO_CREATE);</span>
<span class="nc bnc" id="L3605" title="All 2 branches missed.">            if (!boundSuccess) {</span>
<span class="nc" id="L3606">                throw new RuntimeException(&quot;Failed to bind background media service for uri &quot;+uri);</span>
            }
<span class="nc" id="L3608">            ContextCompat.startForegroundService(getContext(), serviceIntent);</span>
<span class="nc bnc" id="L3609" title="All 2 branches missed.">            while (background == null) {</span>
<span class="nc" id="L3610">                Display.getInstance().invokeAndBlock(new Runnable() {</span>
                    @Override
                    public void run() {
<span class="nc" id="L3613">                        Util.sleep(200);</span>
<span class="nc" id="L3614">                    }</span>
                });
            }
<span class="nc" id="L3617">        } else {</span>
<span class="nc" id="L3618">            ContextCompat.startForegroundService(getContext(), serviceIntent);</span>
        }

<span class="nc bnc" id="L3621" title="All 2 branches missed.">        while (background.getMedia(mediaId) == null) {</span>
<span class="nc" id="L3622">            Display.getInstance().invokeAndBlock(new Runnable() {</span>
                public void run() {
<span class="nc" id="L3624">                    Util.sleep(200);</span>
<span class="nc" id="L3625">                }</span>

            });
        }
<span class="nc" id="L3629">        Media ret = new MediaProxy(background.getMedia(mediaId)) {</span>

            
            @Override
            public void cleanup() {
<span class="nc" id="L3634">                super.cleanup();</span>
<span class="nc bnc" id="L3635" title="All 2 branches missed.">                if (--backgroundMediaCount &lt;= 0) {</span>
<span class="nc bnc" id="L3636" title="All 2 branches missed.">                    if (backgroundMediaServiceConnection != null) {</span>
                        try {
<span class="nc" id="L3638">                            getContext().unbindService(backgroundMediaServiceConnection);</span>
<span class="nc" id="L3639">                        } catch (IllegalArgumentException ex) {</span>
                            // This is thrown sometimes if the service has already been unbound
<span class="nc" id="L3641">                        }</span>
                    }
                }
<span class="nc" id="L3644">            }</span>
        };
        
<span class="nc" id="L3647">        return ret;</span>

    }


    /**
     * @inheritDoc
     */
    @Override
    public Media createMedia(final String uri, boolean isVideo, final Runnable onCompletion) throws IOException {
<span class="nc bnc" id="L3657" title="All 2 branches missed.">        if (getActivity() == null) {</span>
<span class="nc" id="L3658">            return null;</span>
        }
<span class="nc bnc" id="L3660" title="All 2 branches missed.">        if (uri.startsWith(&quot;file://&quot;)) {</span>
<span class="nc" id="L3661">            return createMedia(removeFilePrefix(uri), isVideo, onCompletion);</span>
        }
<span class="nc" id="L3663">        File file = null;</span>
<span class="nc bnc" id="L3664" title="All 2 branches missed.">        if (uri.indexOf(':') &lt; 0) {</span>
            // use a file object to play to try and workaround this issue:
            // http://code.google.com/p/android/issues/detail?id=4124
<span class="nc" id="L3667">            file = new File(uri);</span>
        }

<span class="nc" id="L3670">        Uri parsedUri = null;</span>
<span class="nc" id="L3671">        boolean isContentUri = false;</span>
<span class="nc bnc" id="L3672" title="All 2 branches missed.">        if (file == null) {</span>
<span class="nc" id="L3673">            parsedUri = Uri.parse(uri);</span>
<span class="nc bnc" id="L3674" title="All 4 branches missed.">            isContentUri = parsedUri != null &amp;&amp; &quot;content&quot;.equalsIgnoreCase(parsedUri.getScheme());</span>
        }

        // The document picker grants temporary permissions for content URIs. Requesting
        // READ_EXTERNAL_STORAGE again would surface a redundant prompt on Android 13+, so we only
        // ask for classic file paths that require the legacy permission. MediaStore URIs still
        // require an explicit permission grant, so they remain subject to the legacy check even
        // though they also use the content:// scheme.
<span class="nc bnc" id="L3682" title="All 2 branches missed.">        boolean requiresLegacyPermission = !uri.startsWith(FileSystemStorage.getInstance().getAppHomePath());</span>
<span class="nc bnc" id="L3683" title="All 4 branches missed.">        if (isContentUri &amp;&amp; parsedUri != null) {</span>
<span class="nc" id="L3684">            String authority = parsedUri.getAuthority();</span>
<span class="nc bnc" id="L3685" title="All 2 branches missed.">            if (authority != null) {</span>
<span class="nc" id="L3686">                authority = authority.toLowerCase();</span>
<span class="nc bnc" id="L3687" title="All 4 branches missed.">                if (!&quot;media&quot;.equals(authority) &amp;&amp; !authority.startsWith(&quot;media.&quot;)) {</span>
<span class="nc bnc" id="L3688" title="All 2 branches missed.">                    if (!&quot;com.android.providers.media.documents&quot;.equals(authority)) {</span>
<span class="nc" id="L3689">                        requiresLegacyPermission = false;</span>
                    }
                }
            } else {
<span class="nc" id="L3693">                requiresLegacyPermission = false;</span>
            }
        }

<span class="nc bnc" id="L3697" title="All 2 branches missed.">        if(requiresLegacyPermission) {</span>
<span class="nc bnc" id="L3698" title="All 4 branches missed.">            if(!PermissionsHelper.checkForPermission(isVideo ? DevicePermission.PERMISSION_READ_VIDEO : DevicePermission.PERMISSION_READ_AUDIO, &quot;This is required to play media&quot;)){</span>
<span class="nc" id="L3699">                return null;</span>
            }
        }

        Media retVal;

<span class="nc bnc" id="L3705" title="All 2 branches missed.">        if (isVideo) {</span>
<span class="nc" id="L3706">            final AndroidImplementation.Video[] video = new AndroidImplementation.Video[1];</span>
<span class="nc" id="L3707">            final boolean[] flag = new boolean[1];</span>
<span class="nc" id="L3708">            final File f = file;</span>
<span class="nc" id="L3709">            final Uri videoUri = parsedUri;</span>
<span class="nc" id="L3710">            getActivity().runOnUiThread(new Runnable() {</span>
                @Override
                public void run() {
<span class="nc" id="L3713">                    VideoView v = new VideoView(getActivity());</span>
<span class="nc" id="L3714">                    v.setZOrderMediaOverlay(true);</span>
<span class="nc bnc" id="L3715" title="All 2 branches missed.">                    if (f != null) {</span>
<span class="nc" id="L3716">                        v.setVideoURI(Uri.fromFile(f));</span>
                    } else {
<span class="nc bnc" id="L3718" title="All 2 branches missed.">                        v.setVideoURI(videoUri != null ? videoUri : Uri.parse(uri));</span>
                    }
<span class="nc" id="L3720">                    video[0] = new AndroidImplementation.Video(v, getActivity(), onCompletion);</span>
<span class="nc" id="L3721">                    flag[0] = true;</span>
<span class="nc" id="L3722">                    synchronized (flag) {</span>
<span class="nc" id="L3723">                        flag.notify();</span>
<span class="nc" id="L3724">                    }</span>
<span class="nc" id="L3725">                }</span>
            });
<span class="nc bnc" id="L3727" title="All 2 branches missed.">            while (!flag[0]) {</span>
<span class="nc" id="L3728">                synchronized (flag) {</span>
                    try {
<span class="nc" id="L3730">                        flag.wait(100);</span>
<span class="nc" id="L3731">                    } catch (InterruptedException ex) {</span>
<span class="nc" id="L3732">                    }</span>
<span class="nc" id="L3733">                }</span>
            }
<span class="nc" id="L3735">            return video[0];</span>
        } else {
            MediaPlayer player;
<span class="nc bnc" id="L3738" title="All 2 branches missed.">            if (file != null) {</span>
<span class="nc" id="L3739">                FileInputStream is = new FileInputStream(file);</span>
<span class="nc" id="L3740">                player = new MediaPlayer();</span>
<span class="nc" id="L3741">                player.setDataSource(is.getFD());</span>
<span class="nc" id="L3742">                player.prepare();</span>
<span class="nc" id="L3743">            } else {</span>
<span class="nc bnc" id="L3744" title="All 2 branches missed.">                player = MediaPlayer.create(getActivity(), parsedUri != null ? parsedUri : Uri.parse(uri));</span>
<span class="nc bnc" id="L3745" title="All 4 branches missed.">                if (player == null &amp;&amp; isContentUri) {</span>
                    // Android 13+ introduces stricter access rules for content:// URIs returned
                    // from the system document picker. The picker grants our activity a
                    // persistable read permission, but some OEM builds still reject the URI when it
                    // is passed directly to MediaPlayer. Opening the descriptor ourselves keeps the
                    // same permission grant while avoiding the OEM bug.
<span class="nc" id="L3751">                    ContentResolver resolver = getContext().getContentResolver();</span>
<span class="nc bnc" id="L3752" title="All 4 branches missed.">                    if (resolver != null &amp;&amp; parsedUri != null) {</span>
<span class="nc" id="L3753">                        AssetFileDescriptor afd = null;</span>
                        try {
<span class="nc" id="L3755">                            afd = resolver.openAssetFileDescriptor(parsedUri, &quot;r&quot;);</span>
<span class="nc bnc" id="L3756" title="All 2 branches missed.">                            if (afd != null) {</span>
<span class="nc" id="L3757">                                player = new MediaPlayer();</span>
<span class="nc" id="L3758">                                player.setDataSource(afd.getFileDescriptor(), afd.getStartOffset(), afd.getLength());</span>
<span class="nc" id="L3759">                                player.prepare();</span>
                            }
                        } finally {
<span class="nc bnc" id="L3762" title="All 2 branches missed.">                            if (afd != null) {</span>
                                try {
<span class="nc" id="L3764">                                    afd.close();</span>
<span class="nc" id="L3765">                                } catch (IOException ignore) {</span>
<span class="nc" id="L3766">                                }</span>
                            }
                        }
                    }
                }
            }
<span class="nc bnc" id="L3772" title="All 2 branches missed.">            if (player == null) {</span>
<span class="nc" id="L3773">                throw new IOException(&quot;Unable to create media player for uri &quot; + uri);</span>
            }
<span class="nc" id="L3775">            retVal = new Audio(getActivity(), player, null, onCompletion);</span>
        }
<span class="nc" id="L3777">        return retVal;</span>
    }

    @Override
    public void addCompletionHandler(Media media, Runnable onCompletion) {
<span class="nc" id="L3782">        super.addCompletionHandler(media, onCompletion);</span>
<span class="nc bnc" id="L3783" title="All 2 branches missed.">        if (media instanceof Video) {</span>
<span class="nc" id="L3784">            ((Video)media).addCompletionHandler(onCompletion);</span>
<span class="nc bnc" id="L3785" title="All 2 branches missed.">        } else if (media instanceof Audio) {</span>
<span class="nc" id="L3786">            ((Audio)media).addCompletionHandler(onCompletion);</span>
<span class="nc bnc" id="L3787" title="All 2 branches missed.">        } else if (media instanceof MediaProxy) {</span>
<span class="nc" id="L3788">            ((MediaProxy)media).addCompletionHandler(onCompletion);</span>
        }
<span class="nc" id="L3790">    }</span>

    @Override
    public void removeCompletionHandler(Media media, Runnable onCompletion) {
<span class="nc" id="L3794">        super.removeCompletionHandler(media, onCompletion);</span>
<span class="nc bnc" id="L3795" title="All 2 branches missed.">        if (media instanceof Video) {</span>
<span class="nc" id="L3796">            ((Video)media).removeCompletionHandler(onCompletion);</span>
<span class="nc bnc" id="L3797" title="All 2 branches missed.">        } else if (media instanceof Audio) {</span>
<span class="nc" id="L3798">            ((Audio)media).removeCompletionHandler(onCompletion);</span>
<span class="nc bnc" id="L3799" title="All 2 branches missed.">        } else if (media instanceof MediaProxy) {</span>
<span class="nc" id="L3800">            ((MediaProxy)media).removeCompletionHandler(onCompletion);</span>
        }
<span class="nc" id="L3802">    }</span>

    
    
    /**
     * @inheritDoc
     */
    @Override
    public Media createMedia(InputStream stream, String mimeType, final Runnable onCompletion) throws IOException {
<span class="pc bpc" id="L3811" title="1 of 2 branches missed.">        if (getActivity() == null) {</span>
<span class="nc" id="L3812">            return null;</span>
        }
        /*if(!checkForPermission(Manifest.permission.WRITE_EXTERNAL_STORAGE, &quot;This is required to play media&quot;)){
            return null;
        }*/
<span class="fc" id="L3817">        boolean isVideo = mimeType.contains(&quot;video&quot;);</span>

<span class="pc bpc" id="L3819" title="1 of 4 branches missed.">        if (!isVideo &amp;&amp; stream instanceof FileInputStream) {</span>
<span class="fc" id="L3820">            MediaPlayer player = new MediaPlayer();</span>
<span class="fc" id="L3821">            player.setDataSource(((FileInputStream) stream).getFD());</span>
<span class="fc" id="L3822">            player.prepare();</span>
<span class="fc" id="L3823">            return new Audio(getActivity(), player, stream, onCompletion);</span>
        }
<span class="fc" id="L3825">        String extension = MimeTypeMap.getFileExtensionFromUrl(mimeType);</span>
<span class="pc bpc" id="L3826" title="1 of 2 branches missed.">        final File temp = File.createTempFile(&quot;mtmp&quot;, extension == null ? &quot;dat&quot; : extension);</span>
<span class="fc" id="L3827">        temp.deleteOnExit();</span>
<span class="fc" id="L3828">        OutputStream out = createFileOuputStream(temp);</span>

<span class="fc" id="L3830">        byte buf[] = new byte[256];</span>
<span class="fc" id="L3831">        int len = 0;</span>
<span class="fc bfc" id="L3832" title="All 2 branches covered.">        while ((len = stream.read(buf, 0, buf.length)) &gt; -1) {</span>
<span class="fc" id="L3833">            out.write(buf, 0, len);</span>
        }
<span class="fc" id="L3835">        out.close();</span>
<span class="fc" id="L3836">        stream.close();</span>

<span class="fc" id="L3838">        final Runnable finish = new Runnable() {</span>

            @Override
            public void run() {
<span class="pc bpc" id="L3842" title="1 of 2 branches missed.">                if(onCompletion != null){</span>
<span class="nc" id="L3843">                    Display.getInstance().callSerially(onCompletion);</span>

                    // makes sure the file is only deleted after the onCompletion was invoked
<span class="nc" id="L3846">                    Display.getInstance().callSerially(new Runnable() {</span>
                        @Override
                        public void run() {
<span class="nc" id="L3849">                            temp.delete();</span>
<span class="nc" id="L3850">                        }</span>
                    });
<span class="nc" id="L3852">                    return;</span>
                }
<span class="fc" id="L3854">                temp.delete();</span>
<span class="fc" id="L3855">            }</span>
        };

<span class="pc bpc" id="L3858" title="1 of 2 branches missed.">        if (isVideo) {</span>
<span class="nc" id="L3859">            final AndroidImplementation.Video[] retVal = new AndroidImplementation.Video[1];</span>
<span class="nc" id="L3860">            final boolean[] flag = new boolean[1];</span>

<span class="nc" id="L3862">            getActivity().runOnUiThread(new Runnable() {</span>
                @Override
                public void run() {
<span class="nc" id="L3865">                    VideoView v = new VideoView(getActivity());</span>
<span class="nc" id="L3866">                    v.setZOrderMediaOverlay(true);</span>
<span class="nc" id="L3867">                    v.setVideoURI(Uri.fromFile(temp));</span>
<span class="nc" id="L3868">                    retVal[0] = new AndroidImplementation.Video(v, getActivity(), finish);</span>
<span class="nc" id="L3869">                    flag[0] = true;</span>
<span class="nc" id="L3870">                    synchronized (flag) {</span>
<span class="nc" id="L3871">                        flag.notify();</span>
<span class="nc" id="L3872">                    }</span>
<span class="nc" id="L3873">                }</span>
            });
<span class="nc bnc" id="L3875" title="All 2 branches missed.">            while (!flag[0]) {</span>
<span class="nc" id="L3876">                synchronized (flag) {</span>
                    try {
<span class="nc" id="L3878">                        flag.wait(100);</span>
<span class="nc" id="L3879">                    } catch (InterruptedException ex) {</span>
<span class="nc" id="L3880">                    }</span>
<span class="nc" id="L3881">                }</span>
            }

<span class="nc" id="L3884">            return retVal[0];</span>
        } else {
<span class="fc" id="L3886">            return createMedia(createFileInputStream(temp), mimeType, finish);</span>
        }

    }

    @Override
    public Media createMediaRecorder(MediaRecorderBuilder builder) throws IOException {
<span class="nc" id="L3893">        return createMediaRecorder(builder.getPath(), builder.getMimeType(), builder.getSamplingRate(), builder.getBitRate(), builder.getAudioChannels(), 0, builder.isRedirectToAudioBuffer());</span>
    }

    @Override
    public Media createMediaRecorder(final String path, final String mimeType) throws IOException {
<span class="nc" id="L3898">        MediaRecorderBuilder builder = new MediaRecorderBuilder()</span>
<span class="nc" id="L3899">                .path(path)</span>
<span class="nc" id="L3900">                .mimeType(mimeType);</span>
<span class="nc" id="L3901">        return createMediaRecorder(builder);</span>
    }
    
   
    
    private  Media createMediaRecorder(final String path, final String mimeType, final int sampleRate, final int bitRate, final int audioChannels, final int maxDuration, final boolean redirectToAudioBuffer) throws IOException {
<span class="nc bnc" id="L3907" title="All 2 branches missed.">        if (getActivity() == null) {</span>
<span class="nc" id="L3908">            return null;</span>
        }
<span class="nc bnc" id="L3910" title="All 2 branches missed.">        if(!checkForPermission(Manifest.permission.RECORD_AUDIO, &quot;This is required to record audio&quot;)){</span>
<span class="nc" id="L3911">            return null;</span>
        }
<span class="nc" id="L3913">        final Media[] record = new Media[1];</span>
<span class="nc" id="L3914">        final IOException[] error = new IOException[1];</span>

<span class="nc" id="L3916">        final Object lock = new Object();</span>
<span class="nc" id="L3917">        synchronized (lock) {</span>
<span class="nc" id="L3918">            getActivity().runOnUiThread(new Runnable() {</span>
                @Override
                public void run() {
<span class="nc" id="L3921">                    synchronized (lock) {</span>
<span class="nc bnc" id="L3922" title="All 2 branches missed.">                        if (redirectToAudioBuffer) {</span>
<span class="nc bnc" id="L3923" title="All 2 branches missed.">                            final int channelConfig =audioChannels == 1 ? android.media.AudioFormat.CHANNEL_IN_MONO</span>
<span class="nc bnc" id="L3924" title="All 2 branches missed.">                                            : audioChannels == 2 ? android.media.AudioFormat.CHANNEL_IN_STEREO</span>
<span class="nc" id="L3925">                                                    : android.media.AudioFormat.CHANNEL_IN_MONO;</span>
<span class="nc" id="L3926">                            final AudioRecord recorder = new AudioRecord(</span>
                                    MediaRecorder.AudioSource.MIC, 
                                    sampleRate, 
                                    channelConfig,
                                    AudioFormat.ENCODING_PCM_16BIT,
<span class="nc" id="L3931">                                    AudioRecord.getMinBufferSize(sampleRate, channelConfig, AudioFormat.ENCODING_PCM_16BIT)</span>
                            );
                            
<span class="nc" id="L3934">                            final com.codename1.media.AudioBuffer audioBuffer = com.codename1.media.MediaManager.getAudioBuffer(path, true, 64);</span>

<span class="nc" id="L3936">                            record[0] = new AbstractMedia() {</span>
                                private int lastTime;
                                private boolean isRecording;
                                @Override
                                protected void playImpl() {
<span class="nc bnc" id="L3941" title="All 2 branches missed.">                                    if (isRecording) {</span>
<span class="nc" id="L3942">                                        return;</span>
                                    }
<span class="nc" id="L3944">                                    isRecording = true;</span>
<span class="nc" id="L3945">                                    recorder.startRecording();</span>
<span class="nc" id="L3946">                                    fireMediaStateChange(State.Playing);</span>
<span class="nc" id="L3947">                                    new Thread(new Runnable() {</span>
                                        public void run() {
<span class="nc" id="L3949">                                            float[] audioData = new float[audioBuffer.getMaxSize()];</span>
<span class="nc" id="L3950">                                            short[] buffer = new short[AudioRecord.getMinBufferSize(recorder.getSampleRate(), recorder.getChannelCount(), AudioFormat.ENCODING_PCM_16BIT)];</span>
<span class="nc" id="L3951">                                            int read = -1;</span>
<span class="nc" id="L3952">                                            int index = 0;</span>
                                            
<span class="nc bnc" id="L3954" title="All 4 branches missed.">                                            while (isRecording &amp;&amp; (read = recorder.read(buffer, 0, buffer.length)) &gt;= 0) {</span>
<span class="nc bnc" id="L3955" title="All 2 branches missed.">                                                if (read &gt; 0) {</span>
<span class="nc bnc" id="L3956" title="All 2 branches missed.">                                                    for (int i=0; i&lt;read; i++) {</span>
<span class="nc" id="L3957">                                                        audioData[index] = ((float)buffer[i]) / 0x8000;</span>
<span class="nc" id="L3958">                                                        index++;</span>
<span class="nc bnc" id="L3959" title="All 2 branches missed.">                                                        if (index &gt;= audioData.length) {</span>
<span class="nc" id="L3960">                                                            audioBuffer.copyFrom(sampleRate, audioChannels, audioData, 0, index);</span>
<span class="nc" id="L3961">                                                            index = 0;</span>
                                                        }
                                                    }
<span class="nc bnc" id="L3964" title="All 2 branches missed.">                                                    if (index &gt; 0) {</span>
<span class="nc" id="L3965">                                                        audioBuffer.copyFrom(sampleRate, audioChannels, audioData, 0, index);</span>
<span class="nc" id="L3966">                                                        index = 0;</span>
                                                    }
                                                }
                                            }

<span class="nc" id="L3971">                                        }</span>

<span class="nc" id="L3973">                                    }).start();</span>
<span class="nc" id="L3974">                                }</span>

                                @Override
                                protected void pauseImpl() {
<span class="nc bnc" id="L3978" title="All 2 branches missed.">                                    if (!isRecording) {</span>
<span class="nc" id="L3979">                                        return;</span>
                                    }
<span class="nc" id="L3981">                                    isRecording = false;</span>
<span class="nc" id="L3982">                                    recorder.stop();</span>


<span class="nc" id="L3985">                                    fireMediaStateChange(State.Paused);</span>
<span class="nc" id="L3986">                                }</span>

                                @Override
                                public void prepare() {
                                    
<span class="nc" id="L3991">                                }</span>

                                @Override
                                public void cleanup() {
<span class="nc" id="L3995">                                    pauseImpl();</span>
<span class="nc" id="L3996">                                    recorder.release();</span>
<span class="nc" id="L3997">                                    com.codename1.media.MediaManager.releaseAudioBuffer(path);</span>
                                    
<span class="nc" id="L3999">                                }</span>

                                @Override
                                public int getTime() {
<span class="nc bnc" id="L4003" title="All 2 branches missed.">                                    if (isRecording) {</span>
<span class="nc bnc" id="L4004" title="All 2 branches missed.">                                        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) {</span>
<span class="nc" id="L4005">                                            AudioTimestamp ts = new AudioTimestamp();</span>
<span class="nc" id="L4006">                                            recorder.getTimestamp(ts, AudioTimestamp.TIMEBASE_MONOTONIC);</span>
<span class="nc" id="L4007">                                            lastTime = (int) (ts.framePosition / ((float) sampleRate / 1000f));</span>
                                        }
                                    }
<span class="nc" id="L4010">                                    return lastTime;</span>
                                }

                                @Override
                                public void setTime(int time) {
                                    
<span class="nc" id="L4016">                                }</span>

                                @Override
                                public int getDuration() {
<span class="nc" id="L4020">                                    return getTime();</span>
                                }

                                @Override
                                public void setVolume(int vol) {
                                    
<span class="nc" id="L4026">                                }</span>

                                @Override
                                public int getVolume() {
<span class="nc" id="L4030">                                    return 0;</span>
                                }

                                @Override
                                public boolean isPlaying() {
<span class="nc bnc" id="L4035" title="All 2 branches missed.">                                    return recorder.getRecordingState() == AudioRecord.RECORDSTATE_RECORDING;</span>
                                }

                                @Override
                                public Component getVideoComponent() {
<span class="nc" id="L4040">                                    return null;</span>
                                }

                                @Override
                                public boolean isVideo() {
<span class="nc" id="L4045">                                    return false;</span>
                                }

                                @Override
                                public boolean isFullScreen() {
<span class="nc" id="L4050">                                    return false;</span>
                                }

                                @Override
                                public void setFullScreen(boolean fullScreen) {
                                    
<span class="nc" id="L4056">                                }</span>

                                @Override
                                public void setNativePlayerMode(boolean nativePlayer) {
                                    
<span class="nc" id="L4061">                                }</span>

                                @Override
                                public boolean isNativePlayerMode() {
<span class="nc" id="L4065">                                    return false;</span>
                                }

                                @Override
                                public void setVariable(String key, Object value) {
                                    
<span class="nc" id="L4071">                                }</span>

                                @Override
                                public Object getVariable(String key) {
<span class="nc" id="L4075">                                    return null;</span>
                                }
                                
                            };
<span class="nc" id="L4079">                            lock.notify();</span>
<span class="nc" id="L4080">                        } else {</span>
<span class="nc" id="L4081">                            MediaRecorder recorder = new MediaRecorder();</span>
<span class="nc" id="L4082">                            recorder.setAudioSource(MediaRecorder.AudioSource.MIC);</span>
                        
<span class="nc bnc" id="L4084" title="All 2 branches missed.">                            if(mimeType.contains(&quot;amr&quot;)){</span>
<span class="nc" id="L4085">                            recorder.setOutputFormat(MediaRecorder.OutputFormat.AMR_NB);</span>
<span class="nc" id="L4086">                            recorder.setAudioEncoder(MediaRecorder.AudioEncoder.AMR_NB);</span>
                            }else{
<span class="nc" id="L4088">                                recorder.setOutputFormat(MediaRecorder.OutputFormat.MPEG_4);</span>
<span class="nc" id="L4089">                                recorder.setAudioEncoder(MediaRecorder.AudioEncoder.AAC);</span>
<span class="nc" id="L4090">                                recorder.setAudioSamplingRate(sampleRate);</span>
<span class="nc" id="L4091">                                recorder.setAudioEncodingBitRate(bitRate);</span>
                            }
<span class="nc bnc" id="L4093" title="All 2 branches missed.">                            if (audioChannels &gt; 0) {</span>
<span class="nc" id="L4094">                                recorder.setAudioChannels(audioChannels);</span>
                            }
<span class="nc bnc" id="L4096" title="All 2 branches missed.">                            if (maxDuration &gt; 0) {</span>
<span class="nc" id="L4097">                                recorder.setMaxDuration(maxDuration);</span>
                            }
<span class="nc" id="L4099">                            recorder.setOutputFile(removeFilePrefix(path));</span>
                            try {
<span class="nc" id="L4101">                                recorder.prepare();</span>
<span class="nc" id="L4102">                                record[0] = new AndroidRecorder(recorder);</span>
<span class="nc" id="L4103">                            } catch (IllegalStateException ex) {</span>
<span class="nc" id="L4104">                                Logger.getLogger(AndroidImplementation.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L4105">                            } catch (IOException ex) {</span>
<span class="nc" id="L4106">                                error[0] = ex;</span>
                            } finally {
<span class="nc" id="L4108">                                lock.notify();</span>
                            }
                        }
                        


<span class="nc" id="L4114">                    }</span>
<span class="nc" id="L4115">                }</span>
            });

            try {
<span class="nc" id="L4119">                lock.wait();</span>
<span class="nc" id="L4120">            } catch (InterruptedException ex) {</span>
<span class="nc" id="L4121">                ex.printStackTrace();</span>
<span class="nc" id="L4122">            }</span>

<span class="nc bnc" id="L4124" title="All 2 branches missed.">            if (error[0] != null) {</span>
<span class="nc" id="L4125">                throw error[0];</span>
            }

<span class="nc" id="L4128">            return record[0];</span>
        }
    }

    public String [] getAvailableRecordingMimeTypes(){
        // audio/aac and audio/mp4 result in the same thing
        // AAC are wrapped in an mp4 container.
<span class="nc" id="L4135">        return new String[]{&quot;audio/amr&quot;, &quot;audio/aac&quot;, &quot;audio/mp4&quot;};</span>
    }


    /**
     * @inheritDoc
     */
    public Object createSoftWeakRef(Object o) {
<span class="fc" id="L4143">        return new SoftReference(o);</span>
    }

    /**
     * @inheritDoc
     */
    public Object extractHardRef(Object o) {
<span class="fc" id="L4150">        SoftReference w = (SoftReference) o;</span>
<span class="fc bfc" id="L4151" title="All 2 branches covered.">        if (w != null) {</span>
<span class="fc" id="L4152">            return w.get();</span>
        }
<span class="fc" id="L4154">        return null;</span>
    }

    /**
     * @inheritDoc
     */
    public PeerComponent createNativePeer(Object nativeComponent) {
<span class="nc bnc" id="L4161" title="All 2 branches missed.">        if (!(nativeComponent instanceof View)) {</span>
<span class="nc" id="L4162">            throw new IllegalArgumentException(nativeComponent.getClass().getName());</span>
        }
<span class="nc" id="L4164">        return new AndroidImplementation.AndroidPeer((View) nativeComponent);</span>
    }

    private void blockNativeFocusAll(boolean block) {
<span class="nc" id="L4168">        synchronized (this.nativePeers) {</span>
<span class="nc" id="L4169">            final int size = this.nativePeers.size();</span>
<span class="nc bnc" id="L4170" title="All 2 branches missed.">            for (int i = 0; i &lt; size; i++) {</span>
<span class="nc" id="L4171">                AndroidImplementation.AndroidPeer next = (AndroidImplementation.AndroidPeer) this.nativePeers.get(i);</span>
<span class="nc" id="L4172">                next.blockNativeFocus(block);</span>
            }
<span class="nc" id="L4174">        }</span>
<span class="nc" id="L4175">    }</span>

    public void onFocusChange(View view, boolean bln) {

<span class="nc bnc" id="L4179" title="All 2 branches missed.">        if (bln) {</span>
            /**
             * whenever the base view receives focus we automatically block
             * possible native subviews from gaining focus.
             */
<span class="nc" id="L4184">            blockNativeFocusAll(true);</span>
<span class="nc bnc" id="L4185" title="All 2 branches missed.">            if (this.lastDirectionalKeyEventReceivedByWrapper != 0) {</span>
                /**
                 * because we also consume any key event in the OnKeyListener of
                 * the native wrappers, we have to simulate key events to make
                 * Codename One move the focus to the next component.
                 */
<span class="nc bnc" id="L4191" title="All 2 branches missed.">                if (myView == null) {</span>
<span class="nc" id="L4192">                    return;</span>
                }
<span class="nc bnc" id="L4194" title="All 2 branches missed.">                if (!myView.getAndroidView().isInTouchMode()) {</span>
<span class="nc bnc" id="L4195" title="All 2 branches missed.">                    switch (lastDirectionalKeyEventReceivedByWrapper) {</span>
                        case AndroidImplementation.DROID_IMPL_KEY_LEFT:
                        case AndroidImplementation.DROID_IMPL_KEY_RIGHT:
                        case AndroidImplementation.DROID_IMPL_KEY_UP:
                        case AndroidImplementation.DROID_IMPL_KEY_DOWN:
<span class="nc" id="L4200">                            Display.getInstance().keyPressed(lastDirectionalKeyEventReceivedByWrapper);</span>
<span class="nc" id="L4201">                            Display.getInstance().keyReleased(lastDirectionalKeyEventReceivedByWrapper);</span>
<span class="nc" id="L4202">                            break;</span>
                        default:
<span class="nc" id="L4204">                            Log.d(&quot;Codename One&quot;, &quot;unexpected keycode: &quot; + lastDirectionalKeyEventReceivedByWrapper);</span>
<span class="nc" id="L4205">                            break;</span>
                    }
                } else {
<span class="nc" id="L4208">                    Log.d(&quot;Codename One&quot;, &quot;base view gained focus but no key event to process.&quot;);</span>
                }
<span class="nc" id="L4210">                lastDirectionalKeyEventReceivedByWrapper = 0;</span>
            }
        }

<span class="nc" id="L4214">    }</span>

    @Override
    public void edtIdle(boolean enter) {
<span class="fc" id="L4218">        super.edtIdle(enter);</span>
<span class="fc bfc" id="L4219" title="All 2 branches covered.">        if(enter) {</span>
            // check if we have peers waiting for resize...
<span class="pc bpc" id="L4221" title="1 of 2 branches missed.">            if(myView instanceof AndroidAsyncView) {</span>
<span class="fc" id="L4222">                ((AndroidAsyncView)myView).resizeViews();</span>
            }
        }
<span class="fc" id="L4225">    }</span>

<span class="fc" id="L4227">    static final Map&lt;View,AndroidPeer&gt; activePeers = new HashMap&lt;View,AndroidPeer&gt;();</span>


    /**
     * wrapper component that capsules a native view object in a Codename One
     * component. this involves A LOT of back and forth between the Codename One
     * EDT and the Android UI thread.
     *
     *
     * To use it you would:
     *
     * 1) create your native Android view(s). Make sure to work on the Android
     * UI thread when constructing and modifying them. 2) create a Codename One
     * peer component by calling:
     *
     * com.codename1.ui.PeerComponent.create(myAndroidView);
     *
     * 3) currently the view's size is not automatically calculated from the
     * native view. so you should set the preferred size of the Codename One
     * component manually.
     *
     *
     */
    class AndroidPeer extends PeerComponent {

        private View v;
<span class="fc" id="L4253">        private AndroidImplementation.AndroidRelativeLayout layoutWrapper = null;</span>
<span class="fc" id="L4254">        private int currentVisible = View.INVISIBLE;</span>
        private boolean lightweightMode;

<span class="fc" id="L4257">        public AndroidPeer(View vv) {</span>
<span class="fc" id="L4258">            super(vv);</span>
<span class="fc" id="L4259">            this.v = vv;</span>
<span class="pc bpc" id="L4260" title="1 of 2 branches missed.">            if(!superPeerMode) {</span>
<span class="nc" id="L4261">                v.measure(MeasureSpec.makeMeasureSpec(0, MeasureSpec.UNSPECIFIED),</span>
<span class="nc" id="L4262">                        MeasureSpec.makeMeasureSpec(0, MeasureSpec.UNSPECIFIED));</span>
            }
<span class="fc" id="L4264">        }</span>

        @Override
        protected Image generatePeerImage() {
            try {
<span class="nc" id="L4269">                Bitmap bmp = AndroidNativeUtil.renderViewOnBitmap(v, getWidth(), getHeight());</span>
<span class="nc bnc" id="L4270" title="All 2 branches missed.">                if(bmp == null) {</span>
<span class="nc" id="L4271">                    return Image.createImage(5, 5);</span>
                }
<span class="nc" id="L4273">                Image image = new AndroidImplementation.NativeImage(bmp);</span>
<span class="nc" id="L4274">                return image;</span>
<span class="nc" id="L4275">            } catch(Throwable t) {</span>
<span class="nc" id="L4276">                t.printStackTrace();</span>
<span class="nc" id="L4277">                return Image.createImage(5, 5);</span>
            }
        }

        protected boolean shouldRenderPeerImage() {
<span class="nc bnc" id="L4282" title="All 6 branches missed.">            return !superPeerMode &amp;&amp; (lightweightMode || !isInitialized());</span>
        }

        protected void setLightweightMode(boolean l) {
<span class="nc bnc" id="L4286" title="All 2 branches missed.">            if(superPeerMode) {</span>
<span class="nc bnc" id="L4287" title="All 2 branches missed.">                if (l != lightweightMode) {</span>
<span class="nc" id="L4288">                    lightweightMode = l;</span>
<span class="nc bnc" id="L4289" title="All 2 branches missed.">                    if (lightweightMode) {</span>
<span class="nc" id="L4290">                        Image img = generatePeerImage();</span>
<span class="nc bnc" id="L4291" title="All 2 branches missed.">                        if (img != null) {</span>
<span class="nc" id="L4292">                            peerImage = img;</span>
                        }
                    }

                }
<span class="nc" id="L4297">                return;</span>
            }
<span class="nc bnc" id="L4299" title="All 2 branches missed.">            doSetVisibility(!l);</span>
<span class="nc bnc" id="L4300" title="All 2 branches missed.">            if (lightweightMode == l) {</span>
<span class="nc" id="L4301">                return;</span>
            }
<span class="nc" id="L4303">            lightweightMode = l;</span>
<span class="nc" id="L4304">        }</span>

        @Override
        public void setVisible(boolean visible) {
<span class="fc" id="L4308">            super.setVisible(visible);</span>
<span class="fc" id="L4309">            this.doSetVisibility(visible);</span>
<span class="fc" id="L4310">        }</span>

        void doSetVisibility(final boolean visible) {
<span class="pc bpc" id="L4313" title="1 of 2 branches missed.">            if (getActivity() == null) {</span>
<span class="nc" id="L4314">                return;</span>
            }
<span class="fc" id="L4316">            getActivity().runOnUiThread(new Runnable() {</span>
                public void run() {
<span class="fc bfc" id="L4318" title="All 2 branches covered.">                    currentVisible = visible ? View.VISIBLE : View.INVISIBLE;</span>
<span class="fc" id="L4319">                    v.setVisibility(currentVisible);</span>
<span class="fc bfc" id="L4320" title="All 2 branches covered.">                    if (visible) {</span>
<span class="fc" id="L4321">                        v.bringToFront();</span>
                    }
<span class="fc" id="L4323">                }</span>
            });
<span class="fc bfc" id="L4325" title="All 2 branches covered.">            if(visible){</span>
<span class="fc" id="L4326">                layoutPeer();</span>
            }
<span class="fc" id="L4328">        }</span>

        private void doSetVisibilityInternal(final boolean visible) {
<span class="nc bnc" id="L4331" title="All 2 branches missed.">            if (getActivity() == null) {</span>
<span class="nc" id="L4332">                return;</span>
            }
<span class="nc" id="L4334">            getActivity().runOnUiThread(new Runnable() {</span>
                public void run() {
<span class="nc bnc" id="L4336" title="All 2 branches missed.">                    currentVisible = visible ? View.VISIBLE : View.INVISIBLE;</span>
<span class="nc" id="L4337">                    v.setVisibility(currentVisible);</span>
<span class="nc bnc" id="L4338" title="All 2 branches missed.">                    if (visible) {</span>
<span class="nc" id="L4339">                        v.bringToFront();</span>
                    }
<span class="nc" id="L4341">                }</span>
            });
<span class="nc" id="L4343">        }</span>

        protected void deinitialize() {
<span class="pc bpc" id="L4346" title="1 of 2 branches missed.">            if(!superPeerMode) {</span>
<span class="nc" id="L4347">                Image i = generatePeerImage();</span>
<span class="nc" id="L4348">                setPeerImage(i);</span>
<span class="nc" id="L4349">                super.deinitialize();</span>
<span class="nc" id="L4350">                synchronized (nativePeers) {</span>
<span class="nc" id="L4351">                    nativePeers.remove(this);</span>
<span class="nc" id="L4352">                }</span>
<span class="nc" id="L4353">                deinit();</span>
<span class="nc" id="L4354">            }else{</span>
<span class="fc" id="L4355">                Image img = generatePeerImage();</span>
<span class="pc bpc" id="L4356" title="1 of 2 branches missed.">                if (img != null) {</span>
<span class="fc" id="L4357">                    peerImage = img;</span>
                }

<span class="pc bpc" id="L4360" title="1 of 2 branches missed.">                if(myView instanceof AndroidAsyncView){</span>
<span class="fc" id="L4361">                    ((AndroidAsyncView)myView).removePeerView(v);</span>
                }
<span class="fc" id="L4363">                super.deinitialize();</span>
            }
<span class="fc" id="L4365">        }</span>

        public void deinit(){
<span class="nc bnc" id="L4368" title="All 2 branches missed.">            if (getActivity() == null) {</span>
<span class="nc" id="L4369">                return;</span>
            }
<span class="nc bnc" id="L4371" title="All 2 branches missed.">            if (peerImage == null) {</span>
<span class="nc" id="L4372">                peerImage = generatePeerImage();</span>
            }
<span class="nc" id="L4374">            final boolean [] removed = new boolean[1];</span>
<span class="nc" id="L4375">            getActivity().runOnUiThread(new Runnable() {</span>
                public void run() {
                    try {
<span class="nc bnc" id="L4378" title="All 4 branches missed.">                        if (layoutWrapper != null &amp;&amp; AndroidImplementation.this.relativeLayout != null) {</span>
<span class="nc" id="L4379">                            AndroidImplementation.this.relativeLayout.removeView(layoutWrapper);</span>
<span class="nc" id="L4380">                            AndroidImplementation.this.relativeLayout.requestLayout();</span>
<span class="nc" id="L4381">                            layoutWrapper = null;</span>
                        }
                    } finally {
<span class="nc" id="L4384">                        removed[0] = true;</span>
                    }
<span class="nc" id="L4386">                }</span>
            });
<span class="nc bnc" id="L4388" title="All 2 branches missed.">            while (!removed[0]) {</span>
<span class="nc" id="L4389">                Display.getInstance().invokeAndBlock(new Runnable() {</span>
                    public void run() {
<span class="nc bnc" id="L4391" title="All 2 branches missed.">                        if (!removed[0]) {</span>
                            try {
<span class="nc" id="L4393">                                Thread.sleep(5);</span>
<span class="nc" id="L4394">                            } catch(InterruptedException er) {}</span>
                        }
<span class="nc" id="L4396">                    }</span>
                });
            }
<span class="nc" id="L4399">        }</span>

        protected void initComponent() {
<span class="fc" id="L4402">            super.initComponent();</span>
<span class="pc bpc" id="L4403" title="1 of 2 branches missed.">            if(!superPeerMode) {</span>
<span class="nc" id="L4404">                synchronized (nativePeers) {</span>
<span class="nc" id="L4405">                    nativePeers.add(this);</span>
<span class="nc" id="L4406">                }</span>
<span class="nc" id="L4407">                init();</span>
<span class="nc" id="L4408">                setPeerImage(null);</span>
            }
<span class="fc" id="L4410">        }</span>

        public void init(){
<span class="nc bnc" id="L4413" title="All 4 branches missed.">            if(superPeerMode || getActivity() == null) {</span>
<span class="nc" id="L4414">                return;</span>
            }
<span class="nc" id="L4416">            runOnUiThreadAndBlock(new Runnable() {</span>
                public void run() {
<span class="nc bnc" id="L4418" title="All 2 branches missed.">                    if (layoutWrapper == null) {</span>
                        /**
                         * wrap the native item in a layout that we can move
                         * around on the surface view as we like.
                         */
<span class="nc" id="L4423">                        layoutWrapper = new AndroidImplementation.AndroidRelativeLayout(activity, AndroidImplementation.AndroidPeer.this, v);</span>
<span class="nc" id="L4424">                        layoutWrapper.setBackgroundDrawable(null);</span>
<span class="nc" id="L4425">                        v.setVisibility(currentVisible);</span>
<span class="nc" id="L4426">                        v.setFocusable(AndroidImplementation.AndroidPeer.this.isFocusable());</span>
<span class="nc" id="L4427">                        v.setFocusableInTouchMode(true);</span>
<span class="nc" id="L4428">                        ArrayList&lt;View&gt; viewList = new ArrayList&lt;View&gt;();</span>
<span class="nc" id="L4429">                        viewList.add(layoutWrapper);</span>
<span class="nc" id="L4430">                        v.addFocusables(viewList, View.FOCUS_DOWN);</span>
<span class="nc" id="L4431">                        v.addFocusables(viewList, View.FOCUS_UP);</span>
<span class="nc" id="L4432">                        v.addFocusables(viewList, View.FOCUS_LEFT);</span>
<span class="nc" id="L4433">                        v.addFocusables(viewList, View.FOCUS_RIGHT);</span>
<span class="nc bnc" id="L4434" title="All 4 branches missed.">                        if (v.isFocusable() || v.isFocusableInTouchMode()) {</span>
<span class="nc bnc" id="L4435" title="All 2 branches missed.">                            if (AndroidImplementation.AndroidPeer.super.hasFocus()) {</span>
<span class="nc" id="L4436">                                AndroidImplementation.this.blockNativeFocusAll(true);</span>
<span class="nc" id="L4437">                                blockNativeFocus(false);</span>
<span class="nc bnc" id="L4438" title="All 2 branches missed.">                                if (!v.hasFocus()) {</span>
<span class="nc" id="L4439">                                    v.requestFocus();</span>
                                }

                            } else {
<span class="nc" id="L4443">                                blockNativeFocus(true);</span>
                            }
<span class="nc" id="L4445">                            layoutWrapper.setOnKeyListener(new View.OnKeyListener() {</span>
                                public boolean onKey(View view, int i, KeyEvent ke) {
<span class="nc" id="L4447">                                    lastDirectionalKeyEventReceivedByWrapper = CodenameOneView.internalKeyCodeTranslate(ke.getKeyCode());</span>

                                    // move focus back to base view.
<span class="nc bnc" id="L4450" title="All 2 branches missed.">                                    if (AndroidImplementation.this.myView == null) return false;</span>
<span class="nc" id="L4451">                                    AndroidImplementation.this.myView.getAndroidView().requestFocus();</span>

                                    /**
                                     * if the wrapper has focus, then only because
                                     * the wrapped native component just lost focus.
                                     * we consume whatever key events we receive,
                                     * just to make sure no half press/release
                                     * sequence reaches the base view (and therefore
                                     * Codename One).
                                     */
<span class="nc" id="L4461">                                    return true;</span>
                                }
                            });
<span class="nc" id="L4464">                            layoutWrapper.setOnFocusChangeListener(new View.OnFocusChangeListener() {</span>
                                public void onFocusChange(View view, boolean bln) {
<span class="nc" id="L4466">                                    Log.d(&quot;Codename One&quot;, &quot;on focus change. &quot; + view.toString() + &quot; focus:&quot; + bln + &quot; touchmode: &quot; + v.isInTouchMode());</span>
<span class="nc" id="L4467">                                }</span>
                            });
<span class="nc" id="L4469">                            layoutWrapper.setOnTouchListener(new View.OnTouchListener() {</span>
                                public boolean onTouch(View v, MotionEvent me) {
<span class="nc bnc" id="L4471" title="All 2 branches missed.">                                    if (myView == null) return false;</span>
<span class="nc" id="L4472">                                    return myView.getAndroidView().onTouchEvent(me);</span>
                                }
                            });
                        }
<span class="nc bnc" id="L4476" title="All 2 branches missed.">                        if(AndroidImplementation.this.relativeLayout != null){</span>
                            // not sure why this happens but we got an exception where add view was called with
                            // a layout that was already added...
<span class="nc bnc" id="L4479" title="All 2 branches missed.">                            if(layoutWrapper.getParent() != null) {</span>
<span class="nc" id="L4480">                                ((ViewGroup)layoutWrapper.getParent()).removeView(layoutWrapper);</span>
                            }
<span class="nc" id="L4482">                            AndroidImplementation.this.relativeLayout.addView(layoutWrapper);</span>
                        }
                    }
<span class="nc" id="L4485">                }</span>
            });
<span class="nc" id="L4487">        }</span>
        private Image peerImage;
        public void paint(final Graphics g) {
<span class="pc bpc" id="L4490" title="1 of 2 branches missed.">            if(superPeerMode) {</span>
<span class="fc" id="L4491">                Object nativeGraphics = com.codename1.ui.Accessor.getNativeGraphics(g);</span>

<span class="fc" id="L4493">                Object o = v.getLayoutParams();</span>
                AndroidAsyncView.LayoutParams lp;
<span class="fc bfc" id="L4495" title="All 2 branches covered.">                if(o instanceof AndroidAsyncView.LayoutParams) {</span>
<span class="fc" id="L4496">                    lp = (AndroidAsyncView.LayoutParams) o;</span>
<span class="pc bpc" id="L4497" title="1 of 2 branches missed.">                    if (lp == null) {</span>
<span class="nc" id="L4498">                        lp = new AndroidAsyncView.LayoutParams(</span>
<span class="nc" id="L4499">                                getX() + g.getTranslateX(),</span>
<span class="nc" id="L4500">                                getY() + g.getTranslateY(),</span>
<span class="nc" id="L4501">                                getWidth(),</span>
<span class="nc" id="L4502">                                getHeight(), AndroidPeer.this);</span>
<span class="nc" id="L4503">                        final AndroidAsyncView.LayoutParams finalLp = lp;</span>
<span class="nc" id="L4504">                        activity.runOnUiThread(new Runnable() {</span>
                            @Override
                            public void run() {
<span class="nc" id="L4507">                                v.setLayoutParams(finalLp);</span>
<span class="nc" id="L4508">                            }</span>
                        });
<span class="nc" id="L4510">                        lp.dirty = true;</span>
<span class="nc" id="L4511">                    } else {</span>
<span class="fc" id="L4512">                        int x = getX() + g.getTranslateX();</span>
<span class="fc" id="L4513">                        int y = getY() + g.getTranslateY();</span>
<span class="fc" id="L4514">                        int w = getWidth();</span>
<span class="fc" id="L4515">                        int h = getHeight();</span>
<span class="pc bpc" id="L4516" title="3 of 8 branches missed.">                        if (x != lp.x || y != lp.y || w != lp.w || h != lp.h) {</span>
<span class="fc" id="L4517">                            lp.dirty = true;</span>
<span class="fc" id="L4518">                            lp.x = x;</span>
<span class="fc" id="L4519">                            lp.y = y;</span>
<span class="fc" id="L4520">                            lp.w = w;</span>
<span class="fc" id="L4521">                            lp.h = h;</span>
                        }
<span class="fc" id="L4523">                    }</span>
                } else {
<span class="fc" id="L4525">                    final AndroidAsyncView.LayoutParams finalLp = new AndroidAsyncView.LayoutParams(</span>
<span class="fc" id="L4526">                            getX() + g.getTranslateX(),</span>
<span class="fc" id="L4527">                            getY() + g.getTranslateY(),</span>
<span class="fc" id="L4528">                            getWidth(),</span>
<span class="fc" id="L4529">                            getHeight(), AndroidPeer.this);</span>
<span class="fc" id="L4530">                    activity.runOnUiThread(new Runnable() {</span>
                        @Override
                        public void run() {
<span class="fc" id="L4533">                            v.setLayoutParams(finalLp);</span>
<span class="fc" id="L4534">                        }</span>
                    });
<span class="fc" id="L4536">                    finalLp.dirty = true;</span>
<span class="fc" id="L4537">                    lp = finalLp;</span>
                }

                // this is a mutable image or side menu etc. where the peer is drawn on a different form...
                // Special case...
<span class="pc bpc" id="L4542" title="1 of 2 branches missed.">                if(nativeGraphics.getClass() == AndroidGraphics.class) {</span>
<span class="nc bnc" id="L4543" title="All 2 branches missed.">                    if(peerImage == null) {</span>
<span class="nc" id="L4544">                        peerImage = generatePeerImage();</span>
                    }
                    //systemOut(&quot;Drawing native image&quot;);
<span class="nc" id="L4547">                    g.drawImage(peerImage, getX(), getY());</span>
<span class="nc" id="L4548">                    return;</span>
                }
<span class="fc" id="L4550">                synchronized(activePeers) {</span>
<span class="fc" id="L4551">                    activePeers.put(v, this);</span>
<span class="fc" id="L4552">                }</span>
<span class="fc" id="L4553">                ((AndroidGraphics) nativeGraphics).drawView(v, lp);</span>
<span class="pc bpc" id="L4554" title="3 of 4 branches missed.">                if (lightweightMode &amp;&amp; peerImage != null) {</span>
<span class="nc" id="L4555">                    g.drawImage(peerImage, getX(), getY(), getWidth(), getHeight());</span>
                }
<span class="fc" id="L4557">            } else {</span>
<span class="nc" id="L4558">                super.paint(g);</span>
            }
<span class="fc" id="L4560">        }</span>

        boolean _initialized() {
<span class="nc" id="L4563">            return isInitialized();</span>
        }

        @Override
        protected void onPositionSizeChange() {
<span class="pc bpc" id="L4568" title="1 of 2 branches missed.">            if(!superPeerMode) {</span>
<span class="nc" id="L4569">                Form f = getComponentForm();</span>
<span class="nc bnc" id="L4570" title="All 4 branches missed.">                if (v.getVisibility() == View.INVISIBLE</span>
                        &amp;&amp; f != null
<span class="nc bnc" id="L4572" title="All 2 branches missed.">                        &amp;&amp; Display.getInstance().getCurrent() == f) {</span>
<span class="nc" id="L4573">                    doSetVisibilityInternal(true);</span>
<span class="nc" id="L4574">                    return;</span>
                }
<span class="nc" id="L4576">                layoutPeer();</span>
            }
<span class="fc" id="L4578">        }</span>

        protected void layoutPeer(){
<span class="pc bpc" id="L4581" title="1 of 2 branches missed.">            if (getActivity() == null) {</span>
<span class="nc" id="L4582">                return;</span>
            }
<span class="pc bpc" id="L4584" title="1 of 2 branches missed.">            if(!superPeerMode) {</span>
                // called by Codename One EDT to position the native component.
<span class="nc" id="L4586">                activity.runOnUiThread(new Runnable() {</span>
                    public void run() {
<span class="nc bnc" id="L4588" title="All 2 branches missed.">                        if (layoutWrapper != null) {</span>
<span class="nc bnc" id="L4589" title="All 2 branches missed.">                            if (v.getVisibility() == View.VISIBLE) {</span>

<span class="nc" id="L4591">                                RelativeLayout.LayoutParams layoutParams = layoutWrapper.createMyLayoutParams(</span>
<span class="nc" id="L4592">                                        AndroidImplementation.AndroidPeer.this.getAbsoluteX(),</span>
<span class="nc" id="L4593">                                        AndroidImplementation.AndroidPeer.this.getAbsoluteY(),</span>
<span class="nc" id="L4594">                                        AndroidImplementation.AndroidPeer.this.getWidth(),</span>
<span class="nc" id="L4595">                                        AndroidImplementation.AndroidPeer.this.getHeight());</span>
<span class="nc" id="L4596">                                layoutWrapper.setLayoutParams(layoutParams);</span>
<span class="nc bnc" id="L4597" title="All 2 branches missed.">                                if (AndroidImplementation.this.relativeLayout != null) {</span>
<span class="nc" id="L4598">                                    AndroidImplementation.this.relativeLayout.requestLayout();</span>
                                }

                            }
                        }
<span class="nc" id="L4603">                    }</span>
                });
            }
<span class="fc" id="L4606">        }</span>

        void blockNativeFocus(boolean block) {
<span class="pc bpc" id="L4609" title="1 of 2 branches missed.">            if (layoutWrapper != null) {</span>
<span class="nc bnc" id="L4610" title="All 2 branches missed.">                layoutWrapper.setDescendantFocusability(block</span>
<span class="nc" id="L4611">                        ? ViewGroup.FOCUS_BLOCK_DESCENDANTS : ViewGroup.FOCUS_AFTER_DESCENDANTS);</span>
            }
<span class="fc" id="L4613">        }</span>

        @Override
        public boolean isFocusable() {
            // EDT
<span class="pc bpc" id="L4618" title="1 of 2 branches missed.">            if (v != null) {</span>
<span class="nc bnc" id="L4619" title="All 4 branches missed.">                return v.isFocusableInTouchMode() || v.isFocusable();</span>
            } else {
<span class="fc" id="L4621">                return super.isFocusable();</span>
            }
        }

        @Override
        public void onSetFocusable(final boolean focusable) {
            // EDT
<span class="nc bnc" id="L4628" title="All 2 branches missed.">            if (getActivity() == null) {</span>
<span class="nc" id="L4629">                return;</span>
            }
<span class="nc" id="L4631">            getActivity().runOnUiThread(new Runnable() {</span>
                public void run() {
<span class="nc" id="L4633">                    v.setFocusable(focusable);</span>
<span class="nc" id="L4634">                }</span>
            });
<span class="nc" id="L4636">        }</span>

        @Override
        protected void focusGained() {
<span class="nc" id="L4640">            Log.d(&quot;Codename One&quot;, &quot;native focus gain&quot;);</span>
            // EDT
<span class="nc" id="L4642">            super.focusGained();</span>
<span class="nc bnc" id="L4643" title="All 2 branches missed.">            if (getActivity() == null) {</span>
<span class="nc" id="L4644">                return;</span>
            }
<span class="nc" id="L4646">            getActivity().runOnUiThread(new Runnable() {</span>
                public void run() {
                    // allow this one to gain focus
<span class="nc" id="L4649">                    blockNativeFocus(false);</span>
<span class="nc bnc" id="L4650" title="All 2 branches missed.">                    if (!v.hasFocus()) {</span>
<span class="nc bnc" id="L4651" title="All 2 branches missed.">                        if (v.isInTouchMode()) {</span>
<span class="nc" id="L4652">                            v.requestFocusFromTouch();</span>
                        } else {
<span class="nc" id="L4654">                            v.requestFocus();</span>
                        }
                    }
<span class="nc" id="L4657">                }</span>
            });
<span class="nc" id="L4659">        }</span>

        @Override
        protected void focusLost() {
<span class="nc" id="L4663">            Log.d(&quot;Codename One&quot;, &quot;native focus loss&quot;);</span>
            // EDT
<span class="nc" id="L4665">            super.focusLost();</span>
<span class="nc bnc" id="L4666" title="All 4 branches missed.">            if (layoutWrapper != null &amp;&amp; getActivity() != null) {</span>
<span class="nc" id="L4667">                getActivity().runOnUiThread(new Runnable() {</span>
                    public void run() {
<span class="nc bnc" id="L4669" title="All 2 branches missed.">                        if(isInitialized()) {</span>
                            // request focus of the wrapper. that will trigger the
                            // android focus listener and move focus back to the
                            // base view.
<span class="nc" id="L4673">                            layoutWrapper.requestFocus();</span>
                        }
<span class="nc" id="L4675">                    }</span>
                });
            }
<span class="nc" id="L4678">        }</span>

        public void release() {
<span class="nc" id="L4681">            deinitialize();</span>
<span class="nc" id="L4682">        }</span>

        @Override
        protected Dimension calcPreferredSize() {
<span class="nc" id="L4686">            int w = 1;</span>
<span class="nc" id="L4687">            int h = 1;</span>
<span class="nc" id="L4688">            Drawable d = v.getBackground();</span>
<span class="nc bnc" id="L4689" title="All 2 branches missed.">            if (d != null) {</span>
<span class="nc" id="L4690">                w = d.getMinimumWidth();</span>
<span class="nc" id="L4691">                h = d.getMinimumHeight();</span>
            }
<span class="nc" id="L4693">            w = Math.max(v.getMeasuredWidth(), w);</span>
<span class="nc" id="L4694">            h = Math.max(v.getMeasuredHeight(), h);</span>
<span class="nc bnc" id="L4695" title="All 2 branches missed.">            if (v instanceof TextView) {</span>
<span class="nc" id="L4696">                TextView tv = (TextView)v;</span>
<span class="nc" id="L4697">                w = (int) android.text.Layout.getDesiredWidth(((TextView) v).getText(), ((TextView) v).getPaint());</span>
<span class="nc" id="L4698">                int heightMeasureSpec = View.MeasureSpec.makeMeasureSpec(0, View.MeasureSpec.UNSPECIFIED);</span>
<span class="nc" id="L4699">                tv.measure(w, heightMeasureSpec);</span>
<span class="nc" id="L4700">                h = (int)Math.max(h, tv.getMeasuredHeight());</span>


            }
<span class="nc" id="L4704">            return new Dimension(w, h);</span>
        }
    }

    /**
     * inner class that wraps the native components. this is a useful thingy to
     * handle focus stuff and buffering.
     */
    class AndroidRelativeLayout extends RelativeLayout {

        private AndroidImplementation.AndroidPeer peer;

<span class="nc" id="L4716">        public AndroidRelativeLayout(Context activity, AndroidImplementation.AndroidPeer peer, View v) {</span>
<span class="nc" id="L4717">            super(activity);</span>

<span class="nc" id="L4719">            this.peer = peer;</span>
<span class="nc" id="L4720">            this.setLayoutParams(createMyLayoutParams(peer.getAbsoluteX(), peer.getAbsoluteY(),</span>
<span class="nc" id="L4721">                    peer.getWidth(), peer.getHeight()));</span>
<span class="nc bnc" id="L4722" title="All 2 branches missed.">            if (v.getParent() != null) {</span>
<span class="nc" id="L4723">                ((ViewGroup)v.getParent()).removeView(v);</span>
            }
<span class="nc" id="L4725">            this.addView(v, new RelativeLayout.LayoutParams(</span>
                    RelativeLayout.LayoutParams.FILL_PARENT,
                    RelativeLayout.LayoutParams.FILL_PARENT));
<span class="nc" id="L4728">            this.setDrawingCacheEnabled(false);</span>
<span class="nc" id="L4729">            this.setAlwaysDrawnWithCacheEnabled(false);</span>
<span class="nc" id="L4730">            this.setFocusable(true);</span>
<span class="nc" id="L4731">            this.setFocusableInTouchMode(false);</span>
<span class="nc" id="L4732">            this.setDescendantFocusability(ViewGroup.FOCUS_AFTER_DESCENDANTS);</span>

<span class="nc" id="L4734">        }</span>

        /**
         * create a layout parameter object that holds the native component's
         * position.
         *
         * @return
         */
        private RelativeLayout.LayoutParams createMyLayoutParams(int x, int y, int width, int height) {
<span class="nc" id="L4743">            RelativeLayout.LayoutParams layoutParams = new RelativeLayout.LayoutParams(</span>
                    RelativeLayout.LayoutParams.WRAP_CONTENT,
                    RelativeLayout.LayoutParams.WRAP_CONTENT);
<span class="nc" id="L4746">            layoutParams.addRule(RelativeLayout.ALIGN_PARENT_LEFT);</span>
<span class="nc" id="L4747">            layoutParams.addRule(RelativeLayout.ALIGN_PARENT_TOP);</span>
<span class="nc" id="L4748">            layoutParams.width = width;</span>
<span class="nc" id="L4749">            layoutParams.height = height;</span>
<span class="nc" id="L4750">            layoutParams.leftMargin = x;</span>
<span class="nc" id="L4751">            layoutParams.topMargin = y;</span>
<span class="nc" id="L4752">            return layoutParams;</span>
        }

        @Override
        public boolean dispatchKeyEvent(KeyEvent event) {

<span class="nc" id="L4758">            int keycode = event.getKeyCode();</span>
<span class="nc" id="L4759">            keycode = CodenameOneView.internalKeyCodeTranslate(keycode);</span>
<span class="nc bnc" id="L4760" title="All 2 branches missed.">            if (keycode == AndroidImplementation.DROID_IMPL_KEY_BACK) {</span>
<span class="nc bnc" id="L4761" title="All 3 branches missed.">                switch (event.getAction()) {</span>
                    case KeyEvent.ACTION_DOWN:
<span class="nc" id="L4763">                        Display.getInstance().keyPressed(keycode);</span>
<span class="nc" id="L4764">                        break;</span>
                    case KeyEvent.ACTION_UP:
<span class="nc" id="L4766">                        Display.getInstance().keyReleased(keycode);</span>
                        break;
                }
<span class="nc" id="L4769">                return true;</span>
            } else {
<span class="nc" id="L4771">                return super.dispatchKeyEvent(event);</span>
            }
        }


    }

    private boolean testedNativeTheme;
    private boolean nativeThemeAvailable;

    public boolean hasNativeTheme() {
<span class="fc bfc" id="L4782" title="All 2 branches covered.">        if (!testedNativeTheme) {</span>
<span class="fc" id="L4783">            testedNativeTheme = true;</span>
            try {
                InputStream is;
<span class="pc bpc" id="L4786" title="3 of 4 branches missed.">                if (android.os.Build.VERSION.SDK_INT &lt; 14 &amp;&amp; !isTablet()) {</span>
<span class="nc" id="L4787">                    is = getResourceAsStream(getClass(), &quot;/androidTheme.res&quot;);</span>
                } else {
<span class="fc" id="L4789">                    is = getResourceAsStream(getClass(), &quot;/android_holo_light.res&quot;);</span>
                }
<span class="pc bpc" id="L4791" title="1 of 2 branches missed.">                nativeThemeAvailable = is != null;</span>
<span class="pc bpc" id="L4792" title="1 of 2 branches missed.">                if (is != null) {</span>
<span class="fc" id="L4793">                    is.close();</span>
                }
<span class="nc" id="L4795">            } catch (IOException ex) {</span>
<span class="nc" id="L4796">                ex.printStackTrace();</span>
<span class="fc" id="L4797">            }</span>
        }
<span class="fc" id="L4799">        return nativeThemeAvailable;</span>
    }

    /**
     * Installs the native theme, this is only applicable if hasNativeTheme()
     * returned true. Notice that this method might replace the
     * DefaultLookAndFeel instance and the default transitions.
     */
    public void installNativeTheme() {
<span class="fc" id="L4808">        hasNativeTheme();</span>
<span class="pc bpc" id="L4809" title="1 of 2 branches missed.">        if (nativeThemeAvailable) {</span>
            try {
                InputStream is;
<span class="pc bpc" id="L4812" title="4 of 6 branches missed.">                if (android.os.Build.VERSION.SDK_INT &lt; 14 &amp;&amp; !isTablet() || Display.getInstance().getProperty(&quot;and.hololight&quot;, &quot;false&quot;).equals(&quot;true&quot;)) {</span>
<span class="nc" id="L4813">                    is = getResourceAsStream(getClass(), &quot;/androidTheme.res&quot;);</span>
                } else {
<span class="fc" id="L4815">                    is = getResourceAsStream(getClass(), &quot;/android_holo_light.res&quot;);</span>
                }
<span class="fc" id="L4817">                Resources r = Resources.open(is);</span>
<span class="fc" id="L4818">                Hashtable h = r.getTheme(r.getThemeResourceNames()[0]);</span>
<span class="fc" id="L4819">                h.put(&quot;@commandBehavior&quot;, &quot;Native&quot;);</span>
<span class="fc" id="L4820">                UIManager.getInstance().setThemeProps(h);</span>
<span class="fc" id="L4821">                is.close();</span>
<span class="fc" id="L4822">                Display.getInstance().setCommandBehavior(Display.COMMAND_BEHAVIOR_NATIVE);</span>
<span class="nc" id="L4823">            } catch (IOException ex) {</span>
<span class="nc" id="L4824">                ex.printStackTrace();</span>
<span class="fc" id="L4825">            }</span>
        }
<span class="fc" id="L4827">    }</span>

    public boolean isNativeBrowserComponentSupported() {
<span class="fc" id="L4830">        return true;</span>
    }

    @Override
    public void setNativeBrowserScrollingEnabled(final PeerComponent browserPeer, final boolean e) {
<span class="nc" id="L4835">        super.setNativeBrowserScrollingEnabled(browserPeer, e);</span>
<span class="nc bnc" id="L4836" title="All 2 branches missed.">        if (getActivity() == null) {</span>
<span class="nc" id="L4837">            return;</span>
        }
<span class="nc" id="L4839">        getActivity().runOnUiThread(new Runnable() {</span>
            public void run() {
<span class="nc" id="L4841">                AndroidBrowserComponent bc = (AndroidBrowserComponent)browserPeer;</span>
<span class="nc" id="L4842">                bc.setScrollingEnabled(e);</span>
<span class="nc" id="L4843">            }</span>
        });
<span class="nc" id="L4845">    }</span>

    @Override
    public void setPinchToZoomEnabled(final PeerComponent browserPeer, final boolean e) {
<span class="nc" id="L4849">        super.setPinchToZoomEnabled(browserPeer, e);</span>
<span class="nc bnc" id="L4850" title="All 2 branches missed.">        if (getActivity() == null) {</span>
<span class="nc" id="L4851">            return;</span>
        }
<span class="nc" id="L4853">        getActivity().runOnUiThread(new Runnable() {</span>
            public void run() {
<span class="nc" id="L4855">                AndroidBrowserComponent bc = (AndroidBrowserComponent)browserPeer;</span>
<span class="nc" id="L4856">                bc.setPinchZoomEnabled(e);</span>
<span class="nc" id="L4857">            }</span>
        });
<span class="nc" id="L4859">    }</span>

    public PeerComponent createBrowserComponent(final Object parent) {
<span class="pc bpc" id="L4862" title="1 of 2 branches missed.">        if (getActivity() == null) {</span>
<span class="nc" id="L4863">            return null;</span>
        }
<span class="fc" id="L4865">        final AndroidImplementation.AndroidBrowserComponent[] bc = new AndroidImplementation.AndroidBrowserComponent[1];</span>
<span class="fc" id="L4866">        final Throwable[] error = new Throwable[1];</span>
<span class="fc" id="L4867">        final Object lock = new Object();</span>

<span class="fc" id="L4869">        getActivity().runOnUiThread(new Runnable() {</span>
            @Override
            public void run() {

<span class="fc" id="L4873">                synchronized (lock) {</span>
                    try {
<span class="fc" id="L4875">                        WebView wv = new WebView(getActivity()) {</span>

                            @Override
                            public boolean dispatchKeyEvent(KeyEvent event) {

<span class="nc" id="L4880">                                int keycode = event.getKeyCode();</span>
<span class="nc" id="L4881">                                keycode = CodenameOneView.internalKeyCodeTranslate(keycode);</span>
<span class="nc bnc" id="L4882" title="All 4 branches missed.">                                if (keycode == AndroidImplementation.DROID_IMPL_KEY_BACK || </span>
                                    (keycode == KeyEvent.KEYCODE_MENU &amp;&amp; 
<span class="nc bnc" id="L4884" title="All 2 branches missed.">                                        Display.getInstance().getCommandBehavior() != Display.COMMAND_BEHAVIOR_NATIVE)) {</span>
<span class="nc bnc" id="L4885" title="All 3 branches missed.">                                    switch (event.getAction()) {</span>
                                        case KeyEvent.ACTION_DOWN:
<span class="nc" id="L4887">                                            Display.getInstance().keyPressed(keycode);</span>
<span class="nc" id="L4888">                                            break;</span>
                                        case KeyEvent.ACTION_UP:
<span class="nc" id="L4890">                                            Display.getInstance().keyReleased(keycode);</span>
                                            break;
                                    }
<span class="nc" id="L4893">                                    return true;</span>
                                } else {
<span class="nc" id="L4895">                                    if(Display.getInstance().getProperty(</span>
                                        &quot;android.propogateKeyEvents&quot;, &quot;false&quot;).
<span class="nc bnc" id="L4897" title="All 4 branches missed.">                                            equalsIgnoreCase(&quot;true&quot;) &amp;&amp; </span>
                                        myView instanceof AndroidAsyncView) {
<span class="nc bnc" id="L4899" title="All 3 branches missed.">                                        switch (event.getAction()) {</span>
                                            case KeyEvent.ACTION_DOWN:
<span class="nc" id="L4901">                                                Display.getInstance().keyPressed(keycode);</span>
<span class="nc" id="L4902">                                                break;</span>
                                            case KeyEvent.ACTION_UP:
<span class="nc" id="L4904">                                                Display.getInstance().keyReleased(keycode);</span>
                                                break;
                                        }
<span class="nc" id="L4907">                                        return true;</span>
                                    }                                    
                                                                        
<span class="nc" id="L4910">                                    return super.dispatchKeyEvent(event);</span>
                                }
                            }
                        };
<span class="fc" id="L4914">                        wv.setOnTouchListener(new View.OnTouchListener() {</span>

                            @Override
                            public boolean onTouch(View v, MotionEvent event) {
<span class="nc bnc" id="L4918" title="All 2 branches missed.">                                switch (event.getAction()) {</span>
                                    case MotionEvent.ACTION_DOWN:
                                    case MotionEvent.ACTION_UP:
<span class="nc bnc" id="L4921" title="All 2 branches missed.">                                        if (!v.hasFocus()) {</span>
<span class="nc" id="L4922">                                            v.requestFocus();</span>
                                        }
                                        break;
                                }
<span class="nc" id="L4926">                                return false;</span>
                            }
                        });
                        
<span class="pc bpc" id="L4930" title="1 of 2 branches missed.">                        if (android.os.Build.VERSION.SDK_INT &gt;= 19) {</span>
<span class="pc bpc" id="L4931" title="1 of 2 branches missed.">                            if (&quot;true&quot;.equals(Display.getInstance().getProperty(&quot;android.webContentsDebuggingEnabled&quot;, &quot;false&quot;))) {</span>
<span class="nc" id="L4932">                                wv.setWebContentsDebuggingEnabled(true);</span>
                            }
                        }
<span class="fc" id="L4935">                        wv.getSettings().setDomStorageEnabled(true);</span>
<span class="fc" id="L4936">                        wv.getSettings().setAllowFileAccess(true);</span>
<span class="fc" id="L4937">                        wv.getSettings().setAllowContentAccess(true);</span>
<span class="fc" id="L4938">                        wv.requestFocus(View.FOCUS_DOWN);</span>
<span class="fc" id="L4939">                        wv.setFocusableInTouchMode(true);</span>
<span class="pc bpc" id="L4940" title="1 of 2 branches missed.">                        if (android.os.Build.VERSION.SDK_INT &gt;= 17) {</span>
<span class="fc" id="L4941">                            wv.getSettings().setMediaPlaybackRequiresUserGesture(false);</span>
                        }
<span class="fc" id="L4943">                        bc[0] = new AndroidImplementation.AndroidBrowserComponent(wv, getActivity(), parent);</span>
<span class="fc" id="L4944">                        lock.notify();</span>
<span class="nc" id="L4945">                    } catch (Throwable t) {</span>
<span class="nc" id="L4946">                        error[0] = t;</span>
<span class="nc" id="L4947">                        lock.notify();</span>
<span class="fc" id="L4948">                    }</span>
<span class="fc" id="L4949">                }</span>
<span class="fc" id="L4950">            }</span>
        });
<span class="pc bpc" id="L4952" title="1 of 4 branches missed.">        while (bc[0] == null &amp;&amp; error[0] == null) {</span>
<span class="fc" id="L4953">            Display.getInstance().invokeAndBlock(new Runnable() {</span>
                public void run() {
<span class="fc" id="L4955">                    synchronized (lock) {</span>
<span class="pc bpc" id="L4956" title="2 of 4 branches missed.">                        if (bc[0] == null &amp;&amp; error[0] == null) {</span>
                            try {
<span class="fc" id="L4958">                                lock.wait(20);</span>
<span class="nc" id="L4959">                            } catch (InterruptedException ex) {</span>
<span class="nc" id="L4960">                                ex.printStackTrace();</span>
<span class="fc" id="L4961">                            }</span>
                        }
<span class="fc" id="L4963">                    }</span>
<span class="fc" id="L4964">                }</span>

            });
        }
<span class="pc bpc" id="L4968" title="1 of 2 branches missed.">        if (error[0] != null) {</span>
<span class="nc" id="L4969">            throw new RuntimeException(error[0]);</span>
        }
<span class="fc" id="L4971">        return bc[0];</span>
    }

    public void setBrowserProperty(PeerComponent browserPeer, String key, Object value) {
<span class="nc" id="L4975">        ((AndroidImplementation.AndroidBrowserComponent) browserPeer).setProperty(key, value);</span>
<span class="nc" id="L4976">    }</span>

    public String getBrowserTitle(PeerComponent browserPeer) {
<span class="nc" id="L4979">        return ((AndroidImplementation.AndroidBrowserComponent) browserPeer).getTitle();</span>
    }

    public String getBrowserURL(PeerComponent browserPeer) {
<span class="nc" id="L4983">        return ((AndroidImplementation.AndroidBrowserComponent) browserPeer).getURL();</span>
    }

    @Override
    public void setBrowserURL(PeerComponent browserPeer, String url, Map&lt;String, String&gt; headers) {
<span class="nc bnc" id="L4988" title="All 2 branches missed.">        if (url.startsWith(&quot;jar:&quot;)) {</span>
<span class="nc" id="L4989">            url = url.substring(6);</span>
<span class="nc bnc" id="L4990" title="All 2 branches missed.">            if(url.indexOf(&quot;/&quot;) != 0) {</span>
<span class="nc" id="L4991">                url = &quot;/&quot;+url;</span>
            }

<span class="nc" id="L4994">            url = &quot;file:///android_asset&quot;+url;</span>
        }
<span class="nc" id="L4996">        AndroidImplementation.AndroidBrowserComponent bc = (AndroidImplementation.AndroidBrowserComponent) browserPeer;</span>
<span class="nc bnc" id="L4997" title="All 2 branches missed.">        if(bc.parent.fireBrowserNavigationCallbacks(url)) {</span>
<span class="nc" id="L4998">            bc.setURL(url, headers);</span>
        }
<span class="nc" id="L5000">    }</span>

    @Override
    public boolean isURLWithCustomHeadersSupported() {
<span class="nc" id="L5004">        return true;</span>
    }

    @Override
    public void setBrowserURL(PeerComponent browserPeer, String url) {
<span class="nc" id="L5009">        setBrowserURL(browserPeer, url, null);</span>
<span class="nc" id="L5010">    }</span>

    public void browserStop(PeerComponent browserPeer) {
<span class="nc" id="L5013">        ((AndroidImplementation.AndroidBrowserComponent) browserPeer).stop();</span>
<span class="nc" id="L5014">    }</span>

    public void browserDestroy(PeerComponent browserPeer) {
<span class="nc" id="L5017">        ((AndroidImplementation.AndroidBrowserComponent) browserPeer).destroy();</span>
<span class="nc" id="L5018">    }</span>

    /**
     * Reload the current page
     *
     * @param browserPeer browser instance
     */
    public void browserReload(PeerComponent browserPeer) {
<span class="nc" id="L5026">        ((AndroidImplementation.AndroidBrowserComponent) browserPeer).reload();</span>
<span class="nc" id="L5027">    }</span>

    /**
     * Indicates whether back is currently available
     *
     * @param browserPeer browser instance
     * @return true if back should work
     */
    public boolean browserHasBack(PeerComponent browserPeer) {
<span class="nc" id="L5036">        return ((AndroidImplementation.AndroidBrowserComponent) browserPeer).hasBack();</span>
    }

    public boolean browserHasForward(PeerComponent browserPeer) {
<span class="nc" id="L5040">        return ((AndroidImplementation.AndroidBrowserComponent) browserPeer).hasForward();</span>
    }

    public void browserBack(PeerComponent browserPeer) {
<span class="nc" id="L5044">        ((AndroidImplementation.AndroidBrowserComponent) browserPeer).back();</span>
<span class="nc" id="L5045">    }</span>

    public void browserForward(PeerComponent browserPeer) {
<span class="nc" id="L5048">        ((AndroidImplementation.AndroidBrowserComponent) browserPeer).forward();</span>
<span class="nc" id="L5049">    }</span>

    public void browserClearHistory(PeerComponent browserPeer) {
<span class="nc" id="L5052">        ((AndroidImplementation.AndroidBrowserComponent) browserPeer).clearHistory();</span>
<span class="nc" id="L5053">    }</span>

    public void setBrowserPage(PeerComponent browserPeer, String html, String baseUrl) {
<span class="fc" id="L5056">        ((AndroidImplementation.AndroidBrowserComponent) browserPeer).setPage(html, baseUrl);</span>
<span class="fc" id="L5057">    }</span>

    public void browserExposeInJavaScript(PeerComponent browserPeer, Object o, String name) {
<span class="nc" id="L5060">        ((AndroidImplementation.AndroidBrowserComponent) browserPeer).exposeInJavaScript(o, name);</span>
<span class="nc" id="L5061">    }</span>

    private boolean useEvaluateJavascript() {
<span class="pc bpc" id="L5064" title="1 of 2 branches missed.">        return android.os.Build.VERSION.SDK_INT &gt;= 19;</span>
    }
    

<span class="fc" id="L5068">    private int jsCallbackIndex=0;</span>

    private void execJSUnsafe(WebView web, String js) {
<span class="pc bpc" id="L5071" title="1 of 2 branches missed.">        if (useEvaluateJavascript()) {</span>
<span class="fc" id="L5072">            web.evaluateJavascript(js, null);</span>
        } else {
<span class="nc" id="L5074">            web.loadUrl(&quot;javascript:(function(){&quot;+js+&quot;})()&quot;);</span>
        }
<span class="fc" id="L5076">    }</span>

    private void execJSSafe(final WebView web, final String js) {
<span class="pc bpc" id="L5079" title="1 of 2 branches missed.">        if (useJSDispatchThread()) {</span>
<span class="fc" id="L5080">            runOnJSDispatchThread(new Runnable() {</span>
                public void run() {
<span class="fc" id="L5082">                    getActivity().runOnUiThread(new Runnable() {</span>
                        public void run() {
<span class="fc" id="L5084">                            execJSUnsafe(web, js);</span>
<span class="fc" id="L5085">                        }</span>
                    });
<span class="fc" id="L5087">                }</span>
            });
        } else {
<span class="nc" id="L5090">            getActivity().runOnUiThread(new Runnable() {</span>
                public void run() {
<span class="nc" id="L5092">                    execJSUnsafe(web, js);</span>
<span class="nc" id="L5093">                }</span>
            });
        }
<span class="fc" id="L5096">    }</span>

    private void execJSUnsafe(final AndroidBrowserComponent bc, final String javaScript, final ValueCallback&lt;String&gt; resultCallback) {
<span class="nc bnc" id="L5099" title="All 2 branches missed.">        if (useEvaluateJavascript()) {</span>
            try {
<span class="nc" id="L5101">                bc.web.evaluateJavascript(javaScript, resultCallback);</span>
<span class="nc" id="L5102">            } catch (Throwable t) {</span>
<span class="nc" id="L5103">                com.codename1.io.Log.e(t);</span>
<span class="nc" id="L5104">                resultCallback.onReceiveValue(null);</span>
<span class="nc" id="L5105">            }</span>
        } else {
<span class="nc" id="L5107">            jsCallbackIndex = (++jsCallbackIndex) % 1024;</span>
<span class="nc" id="L5108">            int index = jsCallbackIndex;</span>

            // The jsCallback is a special java object exposed to javascript that we use
            // to return values from javascript to java.
<span class="nc" id="L5112">            synchronized (bc.jsCallback){</span>
                // Initialize the return value to null
<span class="nc bnc" id="L5114" title="All 2 branches missed.">                while (!bc.jsCallback.isIndexAvailable(index)) {</span>
<span class="nc" id="L5115">                    index++;</span>
                }
<span class="nc" id="L5117">                jsCallbackIndex = index+1;</span>
<span class="nc" id="L5118">            }</span>
<span class="nc" id="L5119">            final int fIndex = index;</span>
            // We are placing the javascript inside eval() so we need to escape
            // the input.
<span class="nc" id="L5122">            String escaped = StringUtil.replaceAll(javaScript, &quot;\\&quot;, &quot;\\\\&quot;);</span>
<span class="nc" id="L5123">            escaped = StringUtil.replaceAll(escaped, &quot;'&quot;, &quot;\\'&quot;);</span>

<span class="nc" id="L5125">            final String js = &quot;javascript:(function(){&quot;</span>

                    + &quot;try{&quot;
<span class="nc" id="L5128">                    +bc.jsCallback.jsInit()</span>
<span class="nc" id="L5129">                    +bc.jsCallback.jsCleanup()</span>
                    + AndroidBrowserComponentCallback.JS_RETURNVAL_VARNAME+&quot;[&quot;+index+&quot;]&quot;
                    + &quot;=eval('&quot;+escaped +&quot;');} catch (e){console.log(e)};&quot;
                    + AndroidBrowserComponentCallback.JS_VAR_NAME+&quot;.addReturnValue(&quot; + index+&quot;, ''+&quot;

                    + AndroidBrowserComponentCallback.JS_RETURNVAL_VARNAME+&quot;[&quot;+index+&quot;]&quot;
                    + &quot;);})()&quot;;

            // Send the Javascript string via SetURL.
            // NOTE!! This is sent asynchronously so we will need to wait for
            // the result to come in.
<span class="nc" id="L5140">            bc.setURL(js, null);</span>
<span class="nc bnc" id="L5141" title="All 2 branches missed.">            if (resultCallback == null) {</span>
<span class="nc" id="L5142">                return;</span>
            }
<span class="nc" id="L5144">            Thread t = new Thread(new Runnable() {</span>
                public void run() {
<span class="nc" id="L5146">                    int maxTries = 500;</span>
<span class="nc" id="L5147">                    int tryCounter = 0;</span>

                    // If we are not on the EDT, then it is safe to just loop and wait.
<span class="nc bnc" id="L5150" title="All 4 branches missed.">                    while (!bc.jsCallback.isValueSet(fIndex) &amp;&amp; tryCounter++ &lt; maxTries) {</span>
<span class="nc" id="L5151">                        synchronized(bc.jsCallback){</span>
<span class="nc" id="L5152">                            Util.wait(bc.jsCallback, 20);</span>
<span class="nc" id="L5153">                        }</span>
                    }

<span class="nc bnc" id="L5156" title="All 2 branches missed.">                    if (bc.jsCallback.isValueSet(fIndex)) {</span>
<span class="nc" id="L5157">                        String retval = bc.jsCallback.getReturnValue(fIndex);</span>
<span class="nc" id="L5158">                        bc.jsCallback.remove(fIndex);</span>
<span class="nc bnc" id="L5159" title="All 2 branches missed.">                        resultCallback.onReceiveValue(retval != null ? JSONObject.quote(retval) : null);</span>

<span class="nc" id="L5161">                    } else {</span>
<span class="nc" id="L5162">                        com.codename1.io.Log.e(new RuntimeException(&quot;Failed to execute javascript &quot;+js+&quot; after maximum wait time.&quot;));</span>
<span class="nc" id="L5163">                        resultCallback.onReceiveValue(null);</span>
                    }
<span class="nc" id="L5165">                }</span>
            });
<span class="nc" id="L5167">            t.start();</span>

        }
<span class="nc" id="L5170">    }</span>

    private void execJSSafe(final AndroidBrowserComponent bc, final String javaScript, final ValueCallback&lt;String&gt; resultCallback) {
<span class="nc bnc" id="L5173" title="All 2 branches missed.">        if (useJSDispatchThread()) {</span>
<span class="nc" id="L5174">            runOnJSDispatchThread(new Runnable() {</span>
                public void run() {
<span class="nc" id="L5176">                    getActivity().runOnUiThread(new Runnable() {</span>
                        public void run() {
<span class="nc" id="L5178">                            execJSUnsafe(bc, javaScript, resultCallback);</span>
<span class="nc" id="L5179">                        }</span>
                    });
<span class="nc" id="L5181">                }</span>
            });
        } else {
<span class="nc" id="L5184">            getActivity().runOnUiThread(new Runnable() {</span>
                public void run() {
<span class="nc" id="L5186">                    execJSUnsafe(bc, javaScript, resultCallback);</span>
<span class="nc" id="L5187">                }</span>
            });
        }
<span class="nc" id="L5190">    }</span>



    @Override
    public void browserExecute(final PeerComponent browserPeer, final String javaScript) {
<span class="fc" id="L5196">        final AndroidImplementation.AndroidBrowserComponent bc = (AndroidImplementation.AndroidBrowserComponent) browserPeer;</span>
<span class="fc" id="L5197">        execJSSafe(bc.web, javaScript);</span>
<span class="fc" id="L5198">    }</span>

    private com.codename1.util.EasyThread jsDispatchThread;
    private com.codename1.util.EasyThread jsDispatchThread() {
<span class="fc bfc" id="L5202" title="All 2 branches covered.">        if (jsDispatchThread == null) {</span>
<span class="fc" id="L5203">            jsDispatchThread = com.codename1.util.EasyThread.start(&quot;JS Dispatch Thread&quot;);</span>
        }
<span class="fc" id="L5205">        return jsDispatchThread;</span>
    }

    private boolean useJSDispatchThread() {

        // Before version 24, we need a separate JS dispatch thread to prevent deadlocks
<span class="fc" id="L5211">        return true;//Build.VERSION.SDK_INT &lt; 24;</span>
    }

    public boolean isJSDispatchThread() {
<span class="pc bpc" id="L5215" title="1 of 2 branches missed.">        if (useJSDispatchThread()) {</span>
<span class="fc" id="L5216">            return jsDispatchThread().isThisIt();</span>
        } else {
<span class="nc bnc" id="L5218" title="All 2 branches missed.">            return (Looper.getMainLooper().getThread() == Thread.currentThread());</span>
        }
    }

    public boolean runOnJSDispatchThread(Runnable r) {
<span class="pc bpc" id="L5223" title="1 of 2 branches missed.">        if (isJSDispatchThread()) {</span>
<span class="nc" id="L5224">            r.run();</span>
<span class="nc" id="L5225">            return true;</span>
        }
<span class="pc bpc" id="L5227" title="1 of 2 branches missed.">        if (useJSDispatchThread()) {</span>
<span class="fc" id="L5228">            jsDispatchThread().run(r);</span>
        } else {
<span class="nc" id="L5230">            getActivity().runOnUiThread(r);</span>
        }
<span class="fc" id="L5232">        return false;</span>
    }
    
    /**
     * Executes javascript and returns a string result where appropriate.
     * @param browserPeer
     * @param javaScript
     * @return
     */
    @Override
    public String browserExecuteAndReturnString(final PeerComponent browserPeer, final String javaScript) {
<span class="nc" id="L5243">        final AndroidImplementation.AndroidBrowserComponent bc = (AndroidImplementation.AndroidBrowserComponent) browserPeer;</span>
<span class="nc" id="L5244">        final String[] result = new String[1];</span>
<span class="nc" id="L5245">        final boolean[] complete = new boolean[1];</span>

<span class="nc" id="L5247">        execJSSafe(bc, javaScript, new ValueCallback&lt;String&gt;() {</span>
            @Override
            public void onReceiveValue(String value) {
<span class="nc" id="L5250">                synchronized(result) {</span>
<span class="nc" id="L5251">                    complete[0] = true;</span>
<span class="nc" id="L5252">                    result[0] = value;</span>
<span class="nc" id="L5253">                    result.notify();</span>
<span class="nc" id="L5254">                }</span>
<span class="nc" id="L5255">            }</span>
        });
<span class="nc" id="L5257">        synchronized(result) {</span>
<span class="nc bnc" id="L5258" title="All 2 branches missed.">            if (!complete[0]) {</span>
<span class="nc" id="L5259">                Util.wait(result, 10000);</span>
            }
<span class="nc" id="L5261">        }</span>
<span class="nc bnc" id="L5262" title="All 2 branches missed.">        if (result[0] == null) {</span>
<span class="nc" id="L5263">            return null;</span>
        } else {
<span class="nc" id="L5265">            org.json.JSONTokener tok = new org.json.JSONTokener(&quot;{\&quot;result\&quot;:&quot;+result[0]+&quot;}&quot;);</span>
            try {
<span class="nc" id="L5267">                JSONObject jso = new JSONObject(tok);</span>
<span class="nc" id="L5268">                return jso.getString(&quot;result&quot;);</span>
<span class="nc" id="L5269">            } catch (Throwable ex) {</span>
<span class="nc" id="L5270">                com.codename1.io.Log.e(ex);</span>
<span class="nc" id="L5271">                return null;</span>
            }

        }


    }

    public boolean supportsBrowserExecuteAndReturnString(PeerComponent browserPeer) {
<span class="nc" id="L5280">        return true;</span>
    }

    public boolean canForceOrientation() {
<span class="nc" id="L5284">        return true;</span>
    }

    public void lockOrientation(boolean portrait) {
<span class="pc bpc" id="L5288" title="1 of 2 branches missed.">        if (getActivity() == null) {</span>
<span class="nc" id="L5289">            return;</span>
        }
<span class="pc bpc" id="L5291" title="1 of 2 branches missed.">        if(portrait){</span>
<span class="nc" id="L5292">            getActivity().setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_PORTRAIT);</span>
        }else{
<span class="fc" id="L5294">            getActivity().setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_LANDSCAPE);</span>
        }
<span class="fc" id="L5296">    }</span>

    public void unlockOrientation() {
<span class="nc bnc" id="L5299" title="All 2 branches missed.">        if (getActivity() == null) {</span>
<span class="nc" id="L5300">            return;</span>
        }
<span class="nc" id="L5302">        getActivity().setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_SENSOR);</span>
<span class="nc" id="L5303">    }</span>



    public boolean isAffineSupported() {
<span class="fc" id="L5308">        return true;</span>
    }

    public void resetAffine(Object nativeGraphics) {
<span class="fc" id="L5312">        ((AndroidGraphics) nativeGraphics).resetAffine();</span>
<span class="fc" id="L5313">    }</span>

    public void scale(Object nativeGraphics, float x, float y) {
<span class="fc" id="L5316">        ((AndroidGraphics) nativeGraphics).scale(x, y);</span>
<span class="fc" id="L5317">    }</span>

    public void rotate(Object nativeGraphics, float angle) {
<span class="nc" id="L5320">        ((AndroidGraphics) nativeGraphics).rotate(angle);</span>
<span class="nc" id="L5321">    }</span>

    public void rotate(Object nativeGraphics, float angle, int x, int y) {
<span class="fc" id="L5324">        ((AndroidGraphics) nativeGraphics).rotate(angle, x, y);</span>
<span class="fc" id="L5325">    }</span>

    public void shear(Object nativeGraphics, float x, float y) {
<span class="nc" id="L5328">    }</span>

    public boolean isTablet() {
<span class="pc bpc" id="L5331" title="1 of 2 branches missed.">        return (getContext().getResources().getConfiguration().screenLayout</span>
                &amp; Configuration.SCREENLAYOUT_SIZE_MASK)
                &gt;= Configuration.SCREENLAYOUT_SIZE_LARGE;
    }

    /**
     * Executes r on the UI thread and blocks the EDT to completion
     * @param r runnable to execute
     */
    public static void runOnUiThreadAndBlock(final Runnable r) {
<span class="nc bnc" id="L5341" title="All 2 branches missed.">        if (getActivity() == null) {</span>
<span class="nc" id="L5342">            throw new RuntimeException(&quot;Cannot run on UI thread because getActivity() is null.  This generally means we are running inside a service in the background so UI access is disabled.&quot;);</span>
        }

<span class="nc" id="L5345">        final boolean[] completed = new boolean[1];</span>
<span class="nc" id="L5346">        getActivity().runOnUiThread(new Runnable() {</span>
            @Override
            public void run() {
                try {
<span class="nc" id="L5350">                    r.run();</span>
<span class="nc" id="L5351">                } catch(Throwable t) {</span>
<span class="nc" id="L5352">                    com.codename1.io.Log.e(t);</span>
<span class="nc" id="L5353">                }</span>
<span class="nc" id="L5354">                synchronized(completed) {</span>
<span class="nc" id="L5355">                    completed[0] = true;</span>
<span class="nc" id="L5356">                    completed.notify();</span>
<span class="nc" id="L5357">                }</span>
<span class="nc" id="L5358">            }</span>
        });
<span class="nc" id="L5360">        Display.getInstance().invokeAndBlock(new Runnable() {</span>
            @Override
            public void run() {
<span class="nc" id="L5363">                synchronized(completed) {</span>
<span class="nc bnc" id="L5364" title="All 2 branches missed.">                    while(!completed[0]) {</span>
                        try {
<span class="nc" id="L5366">                            completed.wait();</span>
<span class="nc" id="L5367">                        } catch(InterruptedException err) {}</span>
                    }
<span class="nc" id="L5369">                }</span>
<span class="nc" id="L5370">            }</span>
        });
<span class="nc" id="L5372">    }</span>
    
    public static void runOnUiThreadSync(final Runnable r) {
<span class="nc bnc" id="L5375" title="All 2 branches missed.">        if (getActivity() == null) {</span>
<span class="nc" id="L5376">            throw new RuntimeException(&quot;Cannot run on UI thread because getActivity() is null.  This generally means we are running inside a service in the background so UI access is disabled.&quot;);</span>
        }

<span class="nc" id="L5379">        final boolean[] completed = new boolean[1];</span>
<span class="nc" id="L5380">        getActivity().runOnUiThread(new Runnable() {</span>
            @Override
            public void run() {
                try {
<span class="nc" id="L5384">                    r.run();</span>
<span class="nc" id="L5385">                } catch(Throwable t) {</span>
<span class="nc" id="L5386">                    com.codename1.io.Log.e(t);</span>
<span class="nc" id="L5387">                }</span>
<span class="nc" id="L5388">                synchronized(completed) {</span>
<span class="nc" id="L5389">                    completed[0] = true;</span>
<span class="nc" id="L5390">                    completed.notify();</span>
<span class="nc" id="L5391">                }</span>
<span class="nc" id="L5392">            }</span>
        });
<span class="nc" id="L5394">        synchronized(completed) {</span>
<span class="nc bnc" id="L5395" title="All 2 branches missed.">            while(!completed[0]) {</span>
                try {
<span class="nc" id="L5397">                    completed.wait();</span>
<span class="nc" id="L5398">                } catch(InterruptedException err) {}</span>
            }
<span class="nc" id="L5400">        }</span>
<span class="nc" id="L5401">    }</span>


    public int convertToPixels(int dipCount, boolean horizontal) {
<span class="fc" id="L5405">        DisplayMetrics dm = getContext().getResources().getDisplayMetrics();</span>
<span class="fc" id="L5406">        float ppi = dm.density * 160f;</span>
<span class="fc" id="L5407">        return (int) (((float) dipCount) / 25.4f * ppi);</span>
    }

    public boolean isPortrait() {
<span class="nc" id="L5411">        int orientation = getContext().getResources().getConfiguration().orientation;</span>
<span class="nc bnc" id="L5412" title="All 4 branches missed.">        if (orientation == Configuration.ORIENTATION_UNDEFINED</span>
                || orientation == Configuration.ORIENTATION_SQUARE) {
<span class="nc" id="L5414">            return super.isPortrait();</span>
        }
<span class="nc bnc" id="L5416" title="All 2 branches missed.">        return orientation == Configuration.ORIENTATION_PORTRAIT;</span>
    }

    /**
     * Checks if this platform supports sharing cookies between Native components (e.g. BrowserComponent)
     * and ConnectionRequests.  Currently only Android and iOS ports support this.
     * @return
     */
    @Override
    public boolean isNativeCookieSharingSupported() {
<span class="nc" id="L5426">        return true;</span>
    }

    @Override
    public void clearNativeCookies() {
<span class="nc" id="L5431">        CookieManager mgr = getCookieManager();</span>
<span class="nc" id="L5432">        mgr.removeAllCookie();</span>
<span class="nc" id="L5433">    }</span>
    private static CookieManager cookieManager;
    private static CookieManager getCookieManager() {
<span class="nc bnc" id="L5436" title="All 2 branches missed.">        if (android.os.Build.VERSION.SDK_INT &gt; 28) {</span>
<span class="nc" id="L5437">            return CookieManager.getInstance();</span>
        }
<span class="nc bnc" id="L5439" title="All 2 branches missed.">        if (cookieManager == null) {</span>
<span class="nc" id="L5440">            CookieSyncManager.createInstance(getContext()); // Fixes a crash on Android 4.3</span>
            // https://stackoverflow.com/a/20552998/2935174
<span class="nc" id="L5442">            cookieManager = CookieManager.getInstance();</span>
        }
<span class="nc" id="L5444">        return CookieManager.getInstance();</span>
    }

    @Override
    public Vector getCookiesForURL(String url) {
<span class="nc bnc" id="L5449" title="All 2 branches missed.">        if (isUseNativeCookieStore()) {</span>
            try {
<span class="nc" id="L5451">                URI uri = new URI(url);</span>


<span class="nc" id="L5454">                CookieManager mgr = getCookieManager();</span>
<span class="nc" id="L5455">                mgr.removeExpiredCookie();</span>
<span class="nc" id="L5456">                String domain = uri.getHost();</span>
<span class="nc" id="L5457">                String cookieStr = mgr.getCookie(url);</span>
<span class="nc bnc" id="L5458" title="All 2 branches missed.">                if (cookieStr != null) {</span>
<span class="nc" id="L5459">                    String[] cookies = cookieStr.split(&quot;;&quot;);</span>
<span class="nc" id="L5460">                    int len = cookies.length;</span>
<span class="nc" id="L5461">                    Vector out = new Vector();</span>
<span class="nc bnc" id="L5462" title="All 2 branches missed.">                    for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L5463">                        Cookie c = new Cookie();</span>
<span class="nc" id="L5464">                        String[] parts = cookies[i].split(&quot;=&quot;);</span>
<span class="nc" id="L5465">                        c.setName(parts[0].trim());</span>
<span class="nc bnc" id="L5466" title="All 2 branches missed.">                        if (parts.length &gt; 1) {</span>
<span class="nc" id="L5467">                            c.setValue(parts[1].trim());</span>
                        } else {
<span class="nc" id="L5469">                            c.setValue(&quot;&quot;);</span>
                        }
<span class="nc" id="L5471">                        c.setDomain(domain);</span>
<span class="nc" id="L5472">                        out.add(c);</span>
                    }
<span class="nc" id="L5474">                    return out;</span>
                }
<span class="nc" id="L5476">            } catch (Exception ex) {</span>
<span class="nc" id="L5477">                com.codename1.io.Log.e(ex);</span>
<span class="nc" id="L5478">            }</span>
<span class="nc" id="L5479">            return new Vector();</span>
        }
<span class="nc" id="L5481">        return super.getCookiesForURL(url);</span>
    }

    public class WebAppInterface {
        BrowserComponent bc;
        /** Instantiate the interface and set the context */
<span class="fc" id="L5487">        WebAppInterface(BrowserComponent bc) {</span>
<span class="fc" id="L5488">            this.bc = bc;</span>
<span class="fc" id="L5489">        }</span>

        @JavascriptInterface   // must be added for API 17 or higher
        public boolean shouldNavigate(String url) {
<span class="fc" id="L5493">            return bc.fireBrowserNavigationCallbacks(url);</span>
        }
    }
    
    class AndroidBrowserComponent extends AndroidImplementation.AndroidPeer {

        private Activity act;
        private WebView web;
        private BrowserComponent parent;
<span class="fc" id="L5502">        private boolean scrollingEnabled = true;</span>
        protected AndroidBrowserComponentCallback jsCallback;
<span class="fc" id="L5504">        private boolean lightweightMode = false;</span>
        private ProgressDialog progressBar;
        private boolean hideProgress;
        private int layerType;


<span class="fc" id="L5510">        public AndroidBrowserComponent(final WebView web, Activity act, Object p) {</span>
<span class="fc" id="L5511">            super(web);</span>
<span class="pc bpc" id="L5512" title="1 of 2 branches missed.">            if(!superPeerMode) {</span>
<span class="nc" id="L5513">                doSetVisibility(false);</span>
            }
<span class="fc" id="L5515">            parent = (BrowserComponent) p;</span>
<span class="fc" id="L5516">            this.web = web;</span>
<span class="fc" id="L5517">            layerType = web.getLayerType();</span>
<span class="fc" id="L5518">            web.getSettings().setJavaScriptEnabled(true);</span>
<span class="fc" id="L5519">            web.getSettings().setSupportZoom(parent.isPinchToZoomEnabled());</span>
<span class="fc" id="L5520">            this.act = act;</span>
<span class="fc" id="L5521">            jsCallback = new AndroidBrowserComponentCallback();</span>
<span class="fc" id="L5522">            hideProgress = Display.getInstance().getProperty(&quot;WebLoadingHidden&quot;, &quot;false&quot;).equals(&quot;true&quot;);</span>

<span class="fc" id="L5524">            web.addJavascriptInterface(jsCallback, AndroidBrowserComponentCallback.JS_VAR_NAME);</span>
<span class="fc" id="L5525">            web.addJavascriptInterface(new WebAppInterface(parent), &quot;cn1application&quot;);</span>
<span class="pc bpc" id="L5526" title="1 of 2 branches missed.">            if (android.os.Build.VERSION.SDK_INT &gt;= 21) {</span>
<span class="fc" id="L5527">                CookieManager.getInstance().setAcceptThirdPartyCookies(web, true);</span>
            }

<span class="fc" id="L5530">            web.setWebViewClient(new WebViewClient() {</span>
                
                
                
                public void onLoadResource(WebView view, String url) {
<span class="pc bpc" id="L5535" title="1 of 2 branches missed.">                    if (Display.getInstance().getProperty(&quot;syncNativeCookies&quot;, &quot;false&quot;).equals(&quot;true&quot;)) {</span>
                        try {
<span class="nc" id="L5537">                            URI uri = new URI(url);</span>
<span class="nc" id="L5538">                            CookieManager mgr = getCookieManager();</span>
<span class="nc" id="L5539">                            mgr.removeExpiredCookie();</span>
<span class="nc" id="L5540">                            String domain = uri.getHost();</span>
<span class="nc" id="L5541">                            removeCookiesForDomain(domain);</span>
<span class="nc" id="L5542">                            String cookieStr = mgr.getCookie(url);</span>
<span class="nc bnc" id="L5543" title="All 2 branches missed.">                            if (cookieStr != null) {</span>
<span class="nc" id="L5544">                                String[] cookies = cookieStr.split(&quot;;&quot;);</span>
<span class="nc" id="L5545">                                int len = cookies.length;</span>
<span class="nc" id="L5546">                                ArrayList out = new ArrayList();</span>
<span class="nc bnc" id="L5547" title="All 2 branches missed.">                                for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L5548">                                    Cookie c = new Cookie();</span>
<span class="nc" id="L5549">                                    String[] parts = cookies[i].split(&quot;=&quot;);</span>
<span class="nc" id="L5550">                                    c.setName(parts[0].trim());</span>
<span class="nc bnc" id="L5551" title="All 2 branches missed.">                                    if (parts.length &gt; 1) {</span>
<span class="nc" id="L5552">                                        c.setValue(parts[1].trim());</span>
                                    } else {
<span class="nc" id="L5554">                                        c.setValue(&quot;&quot;);</span>
                                    }
<span class="nc" id="L5556">                                    c.setDomain(domain);</span>
<span class="nc" id="L5557">                                    out.add(c);</span>
                                }
<span class="nc" id="L5559">                                Cookie[] cookiesArr = new Cookie[out.size()];</span>
<span class="nc" id="L5560">                                out.toArray(cookiesArr);</span>
<span class="nc" id="L5561">                                AndroidImplementation.this.addCookie(cookiesArr, false);</span>
                            }

<span class="nc" id="L5564">                        } catch (URISyntaxException ex) {</span>

<span class="nc" id="L5566">                        }</span>
                    }
<span class="fc" id="L5568">                    parent.fireWebEvent(&quot;onLoadResource&quot;, new ActionEvent(url));</span>
<span class="fc" id="L5569">                    super.onLoadResource(view, url);</span>
<span class="fc" id="L5570">                    setShouldCalcPreferredSize(true);</span>
<span class="fc" id="L5571">                }</span>

                @Override
                public void onPageStarted(WebView view, String url, Bitmap favicon) {
<span class="pc bpc" id="L5575" title="1 of 2 branches missed.">                    if (getActivity() == null) {</span>
<span class="nc" id="L5576">                        return;</span>
                    }

<span class="fc" id="L5579">                    parent.fireWebEvent(&quot;onStart&quot;, new ActionEvent(url));</span>
<span class="fc" id="L5580">                    super.onPageStarted(view, url, favicon);</span>
<span class="fc" id="L5581">                    dismissProgress();</span>
                    //show the progress only if there is no ActionBar
<span class="pc bpc" id="L5583" title="2 of 4 branches missed.">                    if(!hideProgress &amp;&amp; !isNativeTitle()){</span>
<span class="fc" id="L5584">                        progressBar = ProgressDialog.show(getActivity(), null, &quot;Loading...&quot;);</span>
                        //if the page hasn't finished for more the 10 sec, dismiss
                        //the dialog
<span class="fc" id="L5587">                        Timer t= new Timer();</span>
<span class="fc" id="L5588">                        t.schedule(new TimerTask() {</span>
                            @Override
                            public void run() {
<span class="fc" id="L5591">                                dismissProgress();</span>
<span class="fc" id="L5592">                            }</span>
                        }, 10000);
                    }
<span class="fc" id="L5595">                }</span>

                public void onPageFinished(WebView view, String url) {
<span class="fc" id="L5598">                    parent.fireWebEvent(&quot;onLoad&quot;, new ActionEvent(url));</span>
<span class="fc" id="L5599">                    super.onPageFinished(view, url);</span>
<span class="fc" id="L5600">                    setShouldCalcPreferredSize(true);</span>
<span class="fc" id="L5601">                    dismissProgress();</span>
<span class="fc" id="L5602">                }</span>

                private void dismissProgress() {
<span class="fc bfc" id="L5605" title="All 4 branches covered.">                    if (progressBar != null &amp;&amp; progressBar.isShowing()) {</span>
<span class="fc" id="L5606">                        progressBar.dismiss();</span>
<span class="fc" id="L5607">                        Display.getInstance().callSerially(new Runnable() {</span>

                            public void run() {
<span class="fc" id="L5610">                                setVisible(true);</span>
<span class="fc" id="L5611">                                repaint();</span>
<span class="fc" id="L5612">                            }</span>
                        });
                    }
<span class="fc" id="L5615">                }</span>

                public void onReceivedError(WebView view, int errorCode, String description, String failingUrl) {
<span class="nc" id="L5618">                    parent.fireWebEvent(&quot;onError&quot;, new ActionEvent(description, errorCode));</span>
<span class="nc" id="L5619">                    super.onReceivedError(view, errorCode, description, failingUrl);</span>
<span class="nc" id="L5620">                    super.shouldOverrideKeyEvent(view, null);</span>
<span class="nc" id="L5621">                    dismissProgress();</span>
<span class="nc" id="L5622">                }</span>

                public boolean shouldOverrideKeyEvent(WebView view, KeyEvent event) {
<span class="nc" id="L5625">                    int keyCode = event.getKeyCode();</span>
<span class="nc bnc" id="L5626" title="All 4 branches missed.">                    if (keyCode == KeyEvent.KEYCODE_BACK || keyCode == KeyEvent.KEYCODE_MENU) {</span>
<span class="nc" id="L5627">                        return true;</span>
                    }

<span class="nc" id="L5630">                    return super.shouldOverrideKeyEvent(view, event);</span>
                }

                public boolean shouldOverrideUrlLoading(WebView view, String url) {
<span class="nc bnc" id="L5634" title="All 2 branches missed.">                    if (url.startsWith(&quot;jar:&quot;)) {</span>
<span class="nc" id="L5635">                        setURL(url, null);</span>
<span class="nc" id="L5636">                        return true;</span>
                    }

                    // this will fail if dial permission isn't declared
<span class="nc bnc" id="L5640" title="All 2 branches missed.">                    if(url.startsWith(&quot;tel:&quot;)) {</span>
<span class="nc bnc" id="L5641" title="All 2 branches missed.">                        if(parent.fireBrowserNavigationCallbacks(url)) {</span>
                            try {
<span class="nc" id="L5643">                                Intent dialer = new Intent(android.content.Intent.ACTION_DIAL, Uri.parse(url));</span>
<span class="nc" id="L5644">                                getContext().startActivity(dialer);</span>
<span class="nc" id="L5645">                            } catch(Throwable t) {}</span>
                        }
<span class="nc" id="L5647">                        return true;</span>
                    }
                    // this will fail if dial permission isn't declared
<span class="nc bnc" id="L5650" title="All 2 branches missed.">                    if(url.startsWith(&quot;mailto:&quot;)) {</span>
<span class="nc bnc" id="L5651" title="All 2 branches missed.">                        if(parent.fireBrowserNavigationCallbacks(url)) {</span>
                            try {
<span class="nc" id="L5653">                                Intent emailIntent = new Intent(Intent.ACTION_SENDTO, Uri.parse(url));</span>
<span class="nc" id="L5654">                                getContext().startActivity(emailIntent);</span>
<span class="nc" id="L5655">                            } catch(Throwable t) {}</span>
                        }
<span class="nc" id="L5657">                        return true;</span>
                    }
<span class="nc bnc" id="L5659" title="All 2 branches missed.">                    return !parent.fireBrowserNavigationCallbacks(url);</span>
                }


            });

<span class="fc" id="L5665">            web.setWebChromeClient(new WebChromeClient(){</span>
                // For 3.0+ Devices (Start)
                // onActivityResult attached before constructor
                protected void openFileChooser(ValueCallback uploadMsg, String acceptType)
                {
<span class="nc" id="L5670">                    mUploadMessage = uploadMsg;</span>
<span class="nc" id="L5671">                    Intent i = new Intent(Intent.ACTION_GET_CONTENT);</span>
<span class="nc" id="L5672">                    i.addCategory(Intent.CATEGORY_OPENABLE);</span>
<span class="nc" id="L5673">                    i.setType(acceptType);</span>
<span class="nc" id="L5674">                    AndroidNativeUtil.getActivity().startActivityForResult(Intent.createChooser(i, &quot;File Browser&quot;), FILECHOOSER_RESULTCODE);</span>
<span class="nc" id="L5675">                }</span>


                // For Lollipop 5.0+ Devices
                public boolean onShowFileChooser(WebView mWebView, ValueCallback&lt;Uri[]&gt; filePathCallback, WebChromeClient.FileChooserParams fileChooserParams)
                {
<span class="nc bnc" id="L5681" title="All 2 branches missed.">                    if (uploadMessage != null) {</span>
<span class="nc" id="L5682">                        uploadMessage.onReceiveValue(null);</span>
<span class="nc" id="L5683">                        uploadMessage = null;</span>
                    }

<span class="nc" id="L5686">                    uploadMessage = filePathCallback;</span>

<span class="nc" id="L5688">                    Intent intent = fileChooserParams.createIntent();</span>
                    try
                    {
<span class="nc" id="L5691">                        AndroidNativeUtil.getActivity().startActivityForResult(intent, REQUEST_SELECT_FILE);</span>
<span class="nc" id="L5692">                    } catch (ActivityNotFoundException e)</span>
                    {
<span class="nc" id="L5694">                        uploadMessage = null;</span>
<span class="nc" id="L5695">                        Toast.makeText(getActivity().getApplicationContext(), &quot;Cannot Open File Chooser&quot;, Toast.LENGTH_LONG).show();</span>
<span class="nc" id="L5696">                        return false;</span>
<span class="nc" id="L5697">                    }</span>
<span class="nc" id="L5698">                    return true;</span>
                }

                //For Android 4.1 only
                protected void openFileChooser(ValueCallback&lt;Uri&gt; uploadMsg, String acceptType, String capture)
                {
<span class="nc" id="L5704">                    mUploadMessage = uploadMsg;</span>
<span class="nc" id="L5705">                    Intent intent = new Intent(Intent.ACTION_GET_CONTENT);</span>
<span class="nc" id="L5706">                    intent.addCategory(Intent.CATEGORY_OPENABLE);</span>
<span class="nc" id="L5707">                    intent.setType(acceptType);</span>
                    
<span class="nc" id="L5709">                    AndroidNativeUtil.getActivity().startActivityForResult(Intent.createChooser(intent, &quot;File Browser&quot;), FILECHOOSER_RESULTCODE);</span>
<span class="nc" id="L5710">                }</span>

                protected void openFileChooser(ValueCallback&lt;Uri&gt; uploadMsg)
                {
<span class="nc" id="L5714">                    mUploadMessage = uploadMsg;</span>
<span class="nc" id="L5715">                    Intent i = new Intent(Intent.ACTION_GET_CONTENT);</span>
<span class="nc" id="L5716">                    i.addCategory(Intent.CATEGORY_OPENABLE);</span>
<span class="nc" id="L5717">                    i.setType(&quot;image/*&quot;);</span>
<span class="nc" id="L5718">                    AndroidNativeUtil.getActivity().startActivityForResult(Intent.createChooser(i, &quot;File Chooser&quot;), FILECHOOSER_RESULTCODE);</span>
<span class="nc" id="L5719">                }</span>

                
                @Override
                public boolean onConsoleMessage(ConsoleMessage consoleMessage) {
<span class="nc" id="L5724">                    com.codename1.io.Log.p(&quot;[&quot;+consoleMessage.messageLevel()+&quot;] &quot;+consoleMessage.message()+&quot; On line &quot;+consoleMessage.lineNumber()+&quot; of &quot;+consoleMessage.sourceId());</span>
<span class="nc" id="L5725">                    return true;</span>
                }

                @Override
                public void onProgressChanged(WebView view, int newProgress) {
<span class="fc" id="L5730">                    parent.fireWebEvent(&quot;Progress&quot;, new ActionEvent(parent, ActionEvent.Type.Progress, newProgress));</span>
<span class="pc bpc" id="L5731" title="8 of 10 branches missed.">                    if(!hideProgress &amp;&amp; isNativeTitle() &amp;&amp; getCurrentForm() != null &amp;&amp; getCurrentForm().getTitle() != null &amp;&amp; getCurrentForm().getTitle().length() &gt; 0 ){</span>
<span class="nc bnc" id="L5732" title="All 2 branches missed.">                        if(getActivity() != null){</span>
                            try{
<span class="nc" id="L5734">                                getActivity().setProgressBarVisibility(true);</span>
<span class="nc" id="L5735">                                getActivity().setProgress(newProgress * 100);</span>
<span class="nc bnc" id="L5736" title="All 2 branches missed.">                                if(newProgress == 100){</span>
<span class="nc" id="L5737">                                    getActivity().setProgressBarVisibility(false);</span>
                                }
<span class="nc" id="L5739">                            }catch(Throwable t){</span>
<span class="nc" id="L5740">                            }</span>
                        }
                    }
<span class="fc" id="L5743">                }</span>

                @Override
                public void onGeolocationPermissionsShowPrompt(String origin,
                                                               GeolocationPermissions.Callback callback) {
                    // Always grant permission since the app itself requires location
                    // permission and the user has therefore already granted it
<span class="nc" id="L5750">                    callback.invoke(origin, true, false);</span>
<span class="nc" id="L5751">                }</span>

                @Override
                public void onPermissionRequest(final PermissionRequest request) {

<span class="nc" id="L5756">                    Log.d(&quot;Codename One&quot;, &quot;onPermissionRequest&quot;);</span>
<span class="nc" id="L5757">                    getActivity().runOnUiThread(new Runnable() {</span>
                        @TargetApi(Build.VERSION_CODES.LOLLIPOP)
                        @Override
                        public void run() {
<span class="nc" id="L5761">                            String allowedOrigins = Display.getInstance().getProperty(&quot;android.WebView.grantPermissionsFrom&quot;, null);</span>
<span class="nc bnc" id="L5762" title="All 2 branches missed.">                            if (allowedOrigins != null) {</span>
<span class="nc" id="L5763">                                String[] origins = Util.split(allowedOrigins, &quot; &quot;);</span>
<span class="nc" id="L5764">                                boolean allowed = false;</span>
<span class="nc bnc" id="L5765" title="All 2 branches missed.">                                for (String origin : origins) {</span>
<span class="nc bnc" id="L5766" title="All 2 branches missed.">                                    if (request.getOrigin().toString().equals(origin)) {</span>
<span class="nc" id="L5767">                                        allowed = true;</span>
<span class="nc" id="L5768">                                        break;</span>
                                    }
                                }
<span class="nc bnc" id="L5771" title="All 2 branches missed.">                                if (allowed) {</span>
<span class="nc" id="L5772">                                    Log.d(&quot;Codename One&quot;, &quot;Allowing permission for &quot;+Arrays.toString(request.getResources())+&quot; in web view for origin &quot;+request.getOrigin());</span>
<span class="nc" id="L5773">                                    request.grant(request.getResources());</span>
                                } else {
<span class="nc" id="L5775">                                    Log.d(&quot;Codename One&quot;, &quot;Denying permission for &quot;+Arrays.toString(request.getResources())+&quot; in web view for origin &quot;+request.getOrigin());</span>
<span class="nc" id="L5776">                                    request.deny();</span>
                                }
                            }

<span class="nc" id="L5780">                        }</span>
                    });
<span class="nc" id="L5782">                }</span>
            });
<span class="fc" id="L5784">        }</span>

        @Override
        protected void initComponent() {
<span class="pc bpc" id="L5788" title="3 of 4 branches missed.">            if(android.os.Build.VERSION.SDK_INT == 21 &amp;&amp; web.getLayerType() != layerType){</span>
<span class="nc" id="L5789">                act.runOnUiThread(new Runnable() {</span>
                    @Override
                    public void run() {
<span class="nc" id="L5792">                        web.setLayerType(layerType, null); //setting layer type to original state</span>
<span class="nc" id="L5793">                    }</span>
                });
            }
<span class="fc" id="L5796">            super.initComponent();</span>
<span class="fc" id="L5797">            blockNativeFocus(false);</span>
<span class="fc" id="L5798">            setPeerImage(null);</span>
<span class="fc" id="L5799">        }</span>


        @Override
        protected Image generatePeerImage() {
            try {
<span class="fc" id="L5805">                final Bitmap nativeBuffer = Bitmap.createBitmap(</span>
<span class="fc" id="L5806">                        getWidth(), getHeight(), Bitmap.Config.ARGB_8888);</span>
<span class="fc" id="L5807">                Image image = new AndroidImplementation.NativeImage(nativeBuffer);</span>
<span class="fc" id="L5808">                getActivity().runOnUiThread(new Runnable() {</span>
                    @Override
                    public void run() {
                        try {
<span class="fc" id="L5812">                            Canvas canvas = new Canvas(nativeBuffer);</span>
<span class="fc" id="L5813">                            web.draw(canvas);</span>
<span class="nc" id="L5814">                        } catch(Throwable t) {</span>
<span class="nc" id="L5815">                            t.printStackTrace();</span>
<span class="fc" id="L5816">                        }</span>
<span class="fc" id="L5817">                    }</span>
                });
<span class="fc" id="L5819">                return image;</span>
<span class="nc" id="L5820">            } catch(Throwable t) {</span>
<span class="nc" id="L5821">                t.printStackTrace();</span>
<span class="nc" id="L5822">                return Image.createImage(5, 5);</span>
            }
        }

        protected boolean shouldRenderPeerImage() {
<span class="nc bnc" id="L5827" title="All 4 branches missed.">            return lightweightMode || !isInitialized();</span>
        }

        protected void setLightweightMode(boolean l) {
<span class="pc bpc" id="L5831" title="1 of 2 branches missed.">            doSetVisibility(!l);</span>
<span class="pc bpc" id="L5832" title="1 of 2 branches missed.">            if (lightweightMode == l) {</span>
<span class="nc" id="L5833">                return;</span>
            }
<span class="fc" id="L5835">            lightweightMode = l;</span>
<span class="fc" id="L5836">        }</span>



        public void setScrollingEnabled(final boolean enabled){
<span class="nc" id="L5841">            this.scrollingEnabled = enabled;</span>
<span class="nc" id="L5842">            act.runOnUiThread(new Runnable() {</span>
                public void run() {
<span class="nc" id="L5844">                    web.setHorizontalScrollBarEnabled(enabled);</span>
<span class="nc" id="L5845">                    web.setVerticalScrollBarEnabled(enabled);</span>
<span class="nc bnc" id="L5846" title="All 2 branches missed.">                    if ( !enabled ){</span>
<span class="nc" id="L5847">                        web.setOnTouchListener(new View.OnTouchListener(){</span>

                            @Override
                            public boolean onTouch(View view, MotionEvent me) {
<span class="nc bnc" id="L5851" title="All 2 branches missed.">                                return (me.getAction() == MotionEvent.ACTION_MOVE);</span>
                            }

                        });
                    } else {
<span class="nc" id="L5856">                        web.setOnTouchListener(null);</span>
                    }
<span class="nc" id="L5858">                }</span>
            });

<span class="nc" id="L5861">        }</span>

        public boolean isScrollingEnabled(){
<span class="nc" id="L5864">            return scrollingEnabled;</span>
        }

        public void setProperty(final String key, final Object value) {
<span class="nc" id="L5868">            act.runOnUiThread(new Runnable() {</span>
                public void run() {
<span class="nc" id="L5870">                    WebSettings s = web.getSettings();</span>
<span class="nc bnc" id="L5871" title="All 2 branches missed.">                    if(key.equalsIgnoreCase(&quot;useragent&quot;)) {</span>
<span class="nc" id="L5872">                        s.setUserAgentString((String)value);</span>
<span class="nc" id="L5873">                        return;</span>
                    }
                    try {
<span class="nc" id="L5876">                        s.setMixedContentMode(WebSettings.MIXED_CONTENT_ALWAYS_ALLOW);</span>
<span class="nc" id="L5877">                    } catch(Throwable t) {</span>
                        // the method isn't available in Android 4.x
<span class="nc" id="L5879">                    }</span>
<span class="nc" id="L5880">                    String methodName = &quot;set&quot; + key;</span>
<span class="nc bnc" id="L5881" title="All 2 branches missed.">                    for (Method m : s.getClass().getMethods()) {</span>
<span class="nc bnc" id="L5882" title="All 4 branches missed.">                        if (m.getName().equalsIgnoreCase(methodName) &amp;&amp; m.getParameterTypes().length == 1) {</span>
                            try {
<span class="nc" id="L5884">                                m.invoke(s, value);</span>
<span class="nc" id="L5885">                            } catch (Exception ex) {</span>
<span class="nc" id="L5886">                                ex.printStackTrace();</span>
<span class="nc" id="L5887">                            }</span>
<span class="nc" id="L5888">                            return;</span>
                        }
                    }
<span class="nc" id="L5891">                }</span>
            });
<span class="nc" id="L5893">        }</span>

        public String getTitle() {
<span class="nc" id="L5896">            final String[] retVal = new String[1];</span>
<span class="nc" id="L5897">            final boolean[] complete = new boolean[1];</span>
<span class="nc" id="L5898">            act.runOnUiThread(new Runnable() {</span>
                public void run() {
                    try {

<span class="nc" id="L5902">                        retVal[0] = web.getTitle();</span>
                    } finally {
<span class="nc" id="L5904">                        complete[0] = true;</span>
                    }
<span class="nc" id="L5906">                }</span>
            });
<span class="nc bnc" id="L5908" title="All 2 branches missed.">            while (!complete[0]) {</span>
<span class="nc" id="L5909">                Display.getInstance().invokeAndBlock(new Runnable() {</span>
                    @Override
                    public void run() {
<span class="nc bnc" id="L5912" title="All 2 branches missed.">                        if (!complete[0]) {</span>
                            try {
<span class="nc" id="L5914">                                Thread.sleep(20);</span>
<span class="nc" id="L5915">                            } catch (InterruptedException ex) {</span>
<span class="nc" id="L5916">                            }</span>
                        }
<span class="nc" id="L5918">                    }</span>
                });
            }
<span class="nc" id="L5921">            return retVal[0];</span>
        }

        public String getURL() {
<span class="nc" id="L5925">            final String[] retVal = new String[1];</span>
<span class="nc" id="L5926">            final boolean[] complete = new boolean[1];</span>
<span class="nc" id="L5927">            act.runOnUiThread(new Runnable() {</span>
                public void run() {
                    try {
<span class="nc" id="L5930">                        retVal[0] = web.getUrl();</span>
                    } finally {
<span class="nc" id="L5932">                        complete[0] = true;</span>
                    }
<span class="nc" id="L5934">                }</span>
            });
<span class="nc bnc" id="L5936" title="All 2 branches missed.">            while (!complete[0]) {</span>
<span class="nc" id="L5937">                Display.getInstance().invokeAndBlock(new Runnable() {</span>
                    @Override
                    public void run() {
<span class="nc bnc" id="L5940" title="All 2 branches missed.">                        if (!complete[0]) {</span>
                            try {
<span class="nc" id="L5942">                                Thread.sleep(20);</span>
<span class="nc" id="L5943">                            } catch (InterruptedException ex) {</span>
<span class="nc" id="L5944">                            }</span>
                        }
<span class="nc" id="L5946">                    }</span>
                });
            }
<span class="nc" id="L5949">            return retVal[0];</span>
        }

        public void setURL(final String url, final Map&lt;String, String&gt; headers) {
<span class="nc" id="L5953">            act.runOnUiThread(new Runnable() {</span>
                public void run() {
<span class="nc bnc" id="L5955" title="All 2 branches missed.">                    if(headers != null) {</span>
<span class="nc" id="L5956">                        web.loadUrl(url, headers);</span>
                    } else {
<span class="nc" id="L5958">                        web.loadUrl(url);</span>
                    }
<span class="nc" id="L5960">                }</span>
            });
<span class="nc" id="L5962">        }</span>

        public void reload() {
<span class="nc" id="L5965">            act.runOnUiThread(new Runnable() {</span>
                public void run() {
<span class="nc" id="L5967">                    web.reload();</span>
<span class="nc" id="L5968">                }</span>
            });
<span class="nc" id="L5970">        }</span>

        public boolean hasBack() {
<span class="nc" id="L5973">            final Boolean [] retVal = new Boolean[1];</span>
<span class="nc" id="L5974">            final boolean[] complete = new boolean[1];</span>

<span class="nc" id="L5976">            act.runOnUiThread(new Runnable() {</span>
                public void run() {
                    try {
<span class="nc" id="L5979">                        retVal[0] = web.canGoBack();</span>
                    } finally {
<span class="nc" id="L5981">                        complete[0] = true;</span>
                    }
<span class="nc" id="L5983">                }</span>
            });
<span class="nc bnc" id="L5985" title="All 2 branches missed.">            while (!complete[0]) {</span>
<span class="nc" id="L5986">                Display.getInstance().invokeAndBlock(new Runnable() {</span>
                    @Override
                    public void run() {
<span class="nc bnc" id="L5989" title="All 2 branches missed.">                        if (!complete[0]) {</span>
                            try {
<span class="nc" id="L5991">                                Thread.sleep(20);</span>
<span class="nc" id="L5992">                            } catch (InterruptedException ex) {</span>
<span class="nc" id="L5993">                            }</span>
                        }
<span class="nc" id="L5995">                    }</span>
                });
            }
<span class="nc" id="L5998">            return retVal[0].booleanValue();</span>
        }

        public boolean hasForward() {
<span class="nc" id="L6002">            final Boolean [] retVal = new Boolean[1];</span>
<span class="nc" id="L6003">            final boolean[] complete = new boolean[1];</span>

<span class="nc" id="L6005">            act.runOnUiThread(new Runnable() {</span>
                public void run() {
                    try {
<span class="nc" id="L6008">                        retVal[0] = web.canGoForward();</span>
                    } finally {
<span class="nc" id="L6010">                        complete[0] = true;</span>
                    }
<span class="nc" id="L6012">                }</span>
            });

<span class="nc bnc" id="L6015" title="All 2 branches missed.">            while (!complete[0]) {</span>
<span class="nc" id="L6016">                Display.getInstance().invokeAndBlock(new Runnable() {</span>
                    @Override
                    public void run() {
<span class="nc bnc" id="L6019" title="All 2 branches missed.">                        if (!complete[0]) {</span>
                            try {
<span class="nc" id="L6021">                                Thread.sleep(20);</span>
<span class="nc" id="L6022">                            } catch (InterruptedException ex) {</span>
<span class="nc" id="L6023">                            }</span>
                        }
<span class="nc" id="L6025">                    }</span>
                });
            }
<span class="nc" id="L6028">            return retVal[0].booleanValue();</span>
        }

        public void back() {
<span class="nc" id="L6032">            act.runOnUiThread(new Runnable() {</span>
                public void run() {
<span class="nc" id="L6034">                    web.goBack();</span>
<span class="nc" id="L6035">                }</span>
            });
<span class="nc" id="L6037">        }</span>

        public void forward() {
<span class="nc" id="L6040">            act.runOnUiThread(new Runnable() {</span>
                public void run() {
<span class="nc" id="L6042">                    web.goForward();</span>
<span class="nc" id="L6043">                }</span>
            });
<span class="nc" id="L6045">        }</span>

        public void clearHistory() {
<span class="nc" id="L6048">            act.runOnUiThread(new Runnable() {</span>
                public void run() {
<span class="nc" id="L6050">                    web.clearHistory();</span>
<span class="nc" id="L6051">                }</span>
            });
<span class="nc" id="L6053">        }</span>

        public void stop() {
<span class="nc" id="L6056">            act.runOnUiThread(new Runnable() {</span>
                public void run() {
<span class="nc" id="L6058">                    web.stopLoading();</span>
<span class="nc" id="L6059">                }</span>
            });
<span class="nc" id="L6061">        }</span>

        public void destroy() {
<span class="nc" id="L6064">            act.runOnUiThread(new Runnable() {</span>
                public void run() {
<span class="nc" id="L6066">                    web.destroy();</span>
<span class="nc" id="L6067">                }</span>
            });
<span class="nc" id="L6069">        }</span>

        public void setPage(final String html, final String baseUrl) {
<span class="fc" id="L6072">            act.runOnUiThread(new Runnable() {</span>
                public void run() {
<span class="fc" id="L6074">                    web.loadDataWithBaseURL(baseUrl, html, &quot;text/html&quot;, &quot;UTF-8&quot;, null);</span>
<span class="fc" id="L6075">                }</span>
            });
<span class="fc" id="L6077">        }</span>

        public void exposeInJavaScript(final Object o, final String name) {
<span class="nc" id="L6080">            act.runOnUiThread(new Runnable() {</span>
                public void run() {
<span class="nc" id="L6082">                    web.addJavascriptInterface(o, name);</span>
<span class="nc" id="L6083">                }</span>
            });
<span class="nc" id="L6085">        }</span>

        public  void setPinchZoomEnabled(final boolean e) {
<span class="nc" id="L6088">            act.runOnUiThread(new Runnable() {</span>
                public void run() {
<span class="nc" id="L6090">                    web.getSettings().setSupportZoom(e);</span>
<span class="nc" id="L6091">                    web.getSettings().setBuiltInZoomControls(e);</span>
<span class="nc" id="L6092">                }</span>
            });
<span class="nc" id="L6094">        }</span>

        @Override
        protected void deinitialize() {
<span class="fc" id="L6098">            act.runOnUiThread(new Runnable() {</span>
                @Override
                public void run() {
<span class="pc bpc" id="L6101" title="1 of 2 branches missed.">                    if(android.os.Build.VERSION.SDK_INT == 21) { // bugfix for Android 5.0.x</span>
<span class="nc" id="L6102">                        web.setLayerType(View.LAYER_TYPE_SOFTWARE, null); //setting layer type to software to prevent the sigseg 11 crash</span>
                    }
<span class="fc" id="L6104">                }</span>
            });
<span class="fc" id="L6106">            super.deinitialize();</span>
<span class="fc" id="L6107">        }</span>
    }



    public Object connect(String url, boolean read, boolean write, int timeout) throws IOException {
<span class="nc" id="L6113">        URL u = new URL(url);</span>
<span class="nc" id="L6114">        CookieHandler.setDefault(null);</span>
<span class="nc" id="L6115">        URLConnection con = u.openConnection();</span>
<span class="nc bnc" id="L6116" title="All 2 branches missed.">        if (con instanceof HttpURLConnection) {</span>
<span class="nc" id="L6117">            HttpURLConnection c = (HttpURLConnection) con;</span>
<span class="nc" id="L6118">            c.setUseCaches(false);</span>
<span class="nc" id="L6119">            c.setDefaultUseCaches(false);</span>
<span class="nc" id="L6120">            c.setInstanceFollowRedirects(false);</span>
<span class="nc bnc" id="L6121" title="All 2 branches missed.">            if(timeout &gt; -1) {</span>
<span class="nc" id="L6122">                c.setConnectTimeout(timeout);</span>
            }

<span class="nc bnc" id="L6125" title="All 2 branches missed.">            if (android.os.Build.VERSION.SDK_INT &gt; 13) {</span>
<span class="nc" id="L6126">                c.setRequestProperty(&quot;Connection&quot;, &quot;close&quot;);</span>
            }
        }
<span class="nc" id="L6129">        con.setDoInput(read);</span>
<span class="nc" id="L6130">        con.setDoOutput(write);</span>
<span class="nc" id="L6131">        return con;</span>
    }
    
    @Override
    public void setReadTimeout(Object connection, int readTimeout) {
<span class="nc bnc" id="L6136" title="All 2 branches missed.">        if (connection instanceof URLConnection) {</span>
<span class="nc" id="L6137">            ((URLConnection)connection).setReadTimeout(readTimeout);</span>
        }
<span class="nc" id="L6139">    }</span>
    
    

    @Override
    public boolean isReadTimeoutSupported() {
<span class="nc" id="L6145">        return true;</span>
    }
    
    @Override
    public void setInsecure(Object connection, boolean insecure) {
<span class="nc bnc" id="L6150" title="All 2 branches missed.">        if (insecure) {</span>
<span class="nc bnc" id="L6151" title="All 2 branches missed.">            if (connection instanceof HttpsURLConnection) {</span>
<span class="nc" id="L6152">                HttpsURLConnection conn = (HttpsURLConnection)connection;</span>
                try {
<span class="nc" id="L6154">                    TrustModifier.relaxHostChecking(conn);</span>
<span class="nc" id="L6155">                } catch (Exception ex) {</span>
<span class="nc" id="L6156">                    com.codename1.io.Log.e(ex);</span>
<span class="nc" id="L6157">                }</span>
            }
        }
<span class="nc" id="L6160">    }</span>
    

    /**
     * @inheritDoc
     */
    public Object connect(String url, boolean read, boolean write) throws IOException {
<span class="nc" id="L6167">        return connect(url, read, write, timeout);</span>
    }


<span class="fc" id="L6171">    private static final char[] HEX_CHARS = {'0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E', 'F'};</span>

    private static String dumpHex(byte[] data) {
<span class="nc" id="L6174">        final int n = data.length;</span>
<span class="nc" id="L6175">        final StringBuilder sb = new StringBuilder(n * 3 - 1);</span>
<span class="nc bnc" id="L6176" title="All 2 branches missed.">        for (int i = 0; i &lt; n; i++) {</span>
<span class="nc bnc" id="L6177" title="All 2 branches missed.">            if (i &gt; 0) {</span>
<span class="nc" id="L6178">                sb.append(' ');</span>
            }
<span class="nc" id="L6180">            sb.append(HEX_CHARS[(data[i] &gt;&gt; 4) &amp; 0x0F]);</span>
<span class="nc" id="L6181">            sb.append(HEX_CHARS[data[i] &amp; 0x0F]);</span>
        }
<span class="nc" id="L6183">        return sb.toString();</span>
    }

    @Override
    public String[] getSSLCertificates(Object connection, String url) throws IOException {
<span class="nc bnc" id="L6188" title="All 2 branches missed.">        if (connection instanceof HttpsURLConnection) {</span>
<span class="nc" id="L6189">            HttpsURLConnection conn = (HttpsURLConnection)connection;</span>

            try {
<span class="nc" id="L6192">                conn.connect();</span>
<span class="nc" id="L6193">                java.security.cert.Certificate[] certs = conn.getServerCertificates();</span>
<span class="nc" id="L6194">                String[] out = new String[certs.length * 2];</span>
<span class="nc" id="L6195">                int i=0;</span>
<span class="nc bnc" id="L6196" title="All 2 branches missed.">                for (java.security.cert.Certificate cert : certs) {</span>
                    {
<span class="nc" id="L6198">                        MessageDigest md = MessageDigest.getInstance(&quot;SHA-256&quot;);</span>
<span class="nc" id="L6199">                        md.update(cert.getEncoded());</span>
<span class="nc" id="L6200">                        out[i++] = &quot;SHA-256:&quot; + dumpHex(md.digest());</span>
                    }
                    {
<span class="nc" id="L6203">                        MessageDigest md = MessageDigest.getInstance(&quot;SHA1&quot;);</span>
<span class="nc" id="L6204">                        md.update(cert.getEncoded());</span>
<span class="nc" id="L6205">                        out[i++] = &quot;SHA1:&quot; + dumpHex(md.digest());</span>
                    }

                }
<span class="nc" id="L6209">                return out;</span>
<span class="nc" id="L6210">            } catch (Exception ex) {</span>
<span class="nc" id="L6211">                ex.printStackTrace();</span>
            }
        }
<span class="nc" id="L6214">        return new String[0];</span>

    }

    @Override
    public boolean canGetSSLCertificates() {
<span class="nc" id="L6220">        return true;</span>
    }

    /**
     * @inheritDoc
     */
    public void setHeader(Object connection, String key, String val) {
<span class="nc" id="L6227">        ((URLConnection) connection).setRequestProperty(key, val);</span>
<span class="nc" id="L6228">    }</span>

    @Override
    public void setChunkedStreamingMode(Object connection, int bufferLen){
<span class="nc" id="L6232">        HttpURLConnection con = ((HttpURLConnection) connection);</span>
<span class="nc" id="L6233">        con.setChunkedStreamingMode(bufferLen);</span>
<span class="nc" id="L6234">    }</span>



    /**
     * @inheritDoc
     */
    public OutputStream openOutputStream(Object connection) throws IOException {
<span class="nc bnc" id="L6242" title="All 2 branches missed.">        if (connection instanceof String) {</span>
<span class="nc" id="L6243">            String con = (String)connection;</span>
<span class="nc bnc" id="L6244" title="All 2 branches missed.">            if (con.startsWith(&quot;file://&quot;)) {</span>
<span class="nc" id="L6245">                con = con.substring(7);</span>
            }

<span class="nc" id="L6248">            OutputStream fc = createFileOuputStream((String) con);</span>
<span class="nc" id="L6249">            BufferedOutputStream o = new BufferedOutputStream(fc, (String) con);</span>
<span class="nc" id="L6250">            return o;</span>
        }
<span class="nc" id="L6252">        return new BufferedOutputStream(((URLConnection) connection).getOutputStream(), connection.toString());</span>
    }

    /**
     * @inheritDoc
     */
    public OutputStream openOutputStream(Object connection, int offset) throws IOException {
<span class="nc" id="L6259">        String con = (String) connection;</span>
<span class="nc" id="L6260">        con = removeFilePrefix(con);</span>
<span class="nc" id="L6261">        RandomAccessFile rf = new RandomAccessFile(con, &quot;rw&quot;);</span>
<span class="nc" id="L6262">        rf.seek(offset);</span>
<span class="nc" id="L6263">        FileOutputStream fc = new FileOutputStream(rf.getFD());</span>
<span class="nc" id="L6264">        BufferedOutputStream o = new BufferedOutputStream(fc, con);</span>
<span class="nc" id="L6265">        o.setConnection(rf);</span>
<span class="nc" id="L6266">        return o;</span>
    }

    /**
     * @inheritDoc
     */
    public void cleanup(Object o) {
        try {
<span class="fc" id="L6274">            super.cleanup(o);</span>
<span class="pc bpc" id="L6275" title="1 of 2 branches missed.">            if (o != null) {</span>
<span class="pc bpc" id="L6276" title="1 of 2 branches missed.">                if (o instanceof RandomAccessFile) {</span>
<span class="nc" id="L6277">                    ((RandomAccessFile) o).close();</span>
                }
            }
<span class="nc" id="L6280">        } catch (Throwable ex) {</span>
<span class="nc" id="L6281">            ex.printStackTrace();</span>
<span class="fc" id="L6282">        }</span>
<span class="fc" id="L6283">    }</span>

    /**
     * @inheritDoc
     */
    public InputStream openInputStream(Object connection) throws IOException {
<span class="nc bnc" id="L6289" title="All 2 branches missed.">        if (connection instanceof String) {</span>
<span class="nc" id="L6290">            String con = (String) connection;</span>
<span class="nc bnc" id="L6291" title="All 2 branches missed.">            if (con.startsWith(&quot;file://&quot;)) {</span>
<span class="nc" id="L6292">                con = con.substring(7);</span>
            }
<span class="nc" id="L6294">            InputStream fc = createFileInputStream(con);</span>
<span class="nc" id="L6295">            BufferedInputStream o = new BufferedInputStream(fc, con);</span>
<span class="nc" id="L6296">            return o;</span>
        }
<span class="nc bnc" id="L6298" title="All 2 branches missed.">        if(connection instanceof HttpURLConnection) {</span>
<span class="nc" id="L6299">            HttpURLConnection ht = (HttpURLConnection)connection;</span>
<span class="nc bnc" id="L6300" title="All 2 branches missed.">            if(ht.getResponseCode() &lt; 400) {</span>
<span class="nc" id="L6301">                return new BufferedInputStream(ht.getInputStream());</span>
            }
<span class="nc" id="L6303">            return new BufferedInputStream(ht.getErrorStream());</span>
        } else {
<span class="nc" id="L6305">            return new BufferedInputStream(((URLConnection) connection).getInputStream());</span>
        }
    }

    /**
     * @inheritDoc
     */
    public void setHttpMethod(Object connection, String method) throws IOException {
<span class="nc bnc" id="L6313" title="All 2 branches missed.">        if(method.equalsIgnoreCase(&quot;patch&quot;)) {</span>
<span class="nc" id="L6314">            allowPatch((HttpURLConnection) connection);</span>
        }
<span class="nc" id="L6316">        ((HttpURLConnection) connection).setRequestMethod(method);</span>
<span class="nc" id="L6317">    }</span>

    // the following block is based on a few suggestions in this stack overflow 
    // answer https://stackoverflow.com/questions/25163131/httpurlconnection-invalid-http-method-patch
    private static boolean enabledPatch;
    private static boolean patchFailed;
    private static void allowPatch(HttpURLConnection connection) {
<span class="nc bnc" id="L6324" title="All 2 branches missed.">        if(enabledPatch) {</span>
<span class="nc" id="L6325">            return;</span>
        }
<span class="nc bnc" id="L6327" title="All 2 branches missed.">        if(patchFailed) {</span>
<span class="nc" id="L6328">            connection.setRequestProperty(&quot;X-HTTP-Method-Override&quot;, &quot;PATCH&quot;);</span>
<span class="nc" id="L6329">            return;</span>
        }
        try {
<span class="nc" id="L6332">            Field methodsField = HttpURLConnection.class.getDeclaredField(&quot;methods&quot;);</span>

<span class="nc" id="L6334">            Field modifiersField = Field.class.getDeclaredField(&quot;modifiers&quot;);</span>
<span class="nc" id="L6335">            modifiersField.setAccessible(true);</span>
<span class="nc" id="L6336">            modifiersField.setInt(methodsField, methodsField.getModifiers() &amp; ~Modifier.FINAL);</span>

<span class="nc" id="L6338">            methodsField.setAccessible(true);</span>

<span class="nc" id="L6340">            String[] oldMethods = (String[]) methodsField.get(null);</span>
<span class="nc" id="L6341">            Set&lt;String&gt; methodsSet = new LinkedHashSet&lt;String&gt;(Arrays.asList(oldMethods));</span>
<span class="nc" id="L6342">            methodsSet.addAll(Arrays.asList(&quot;PATCH&quot;));</span>
<span class="nc" id="L6343">            String[] newMethods = methodsSet.toArray(new String[0]);</span>

<span class="nc" id="L6345">            methodsField.set(null/*static field*/, newMethods);</span>
<span class="nc" id="L6346">            enabledPatch = true;</span>
<span class="nc" id="L6347">        } catch (NoSuchFieldException e) {</span>
<span class="nc" id="L6348">            patchFailed = true;</span>
<span class="nc" id="L6349">            connection.setRequestProperty(&quot;X-HTTP-Method-Override&quot;, &quot;PATCH&quot;);</span>
<span class="nc" id="L6350">        } catch(IllegalAccessException ee) {</span>
<span class="nc" id="L6351">            patchFailed = true;</span>
<span class="nc" id="L6352">            connection.setRequestProperty(&quot;X-HTTP-Method-Override&quot;, &quot;PATCH&quot;);</span>
<span class="nc" id="L6353">        }</span>
<span class="nc" id="L6354">    }    </span>
    
    /**
     * @inheritDoc
     */
    public void setPostRequest(Object connection, boolean p) {
        try {
<span class="nc bnc" id="L6361" title="All 2 branches missed.">            if (p) {</span>
<span class="nc" id="L6362">                ((HttpURLConnection) connection).setRequestMethod(&quot;POST&quot;);</span>
            } else {
<span class="nc" id="L6364">                ((HttpURLConnection) connection).setRequestMethod(&quot;GET&quot;);</span>
            }
<span class="nc" id="L6366">        } catch (IOException err) {</span>
            // an exception here doesn't make sense
<span class="nc" id="L6368">            err.printStackTrace();</span>
<span class="nc" id="L6369">        }</span>
<span class="nc" id="L6370">    }</span>

    /**
     * @inheritDoc
     */
    public int getResponseCode(Object connection) throws IOException {
        // workaround for Android bug discussed here: http://stackoverflow.com/questions/17638398/androids-httpurlconnection-throws-eofexception-on-head-requests
<span class="nc" id="L6377">        HttpURLConnection con = (HttpURLConnection) connection;</span>
<span class="nc bnc" id="L6378" title="All 2 branches missed.">        if(&quot;head&quot;.equalsIgnoreCase(con.getRequestMethod())) {</span>
<span class="nc" id="L6379">            con.setDoOutput(false);</span>
<span class="nc" id="L6380">            con.setRequestProperty( &quot;Accept-Encoding&quot;, &quot;&quot; );</span>
        }
<span class="nc" id="L6382">        return ((HttpURLConnection) connection).getResponseCode();</span>
    }

    /**
     * @inheritDoc
     */
    public String getResponseMessage(Object connection) throws IOException {
<span class="nc" id="L6389">        return ((HttpURLConnection) connection).getResponseMessage();</span>
    }

    /**
     * @inheritDoc
     */
    public int getContentLength(Object connection) {
<span class="nc" id="L6396">        return ((HttpURLConnection) connection).getContentLength();</span>
    }

    /**
     * @inheritDoc
     */
    public String getHeaderField(String name, Object connection) throws IOException {
<span class="nc" id="L6403">        return ((HttpURLConnection) connection).getHeaderField(name);</span>
    }

    /**
     * @inheritDoc
     */
    public String[] getHeaderFieldNames(Object connection) throws IOException {
<span class="nc" id="L6410">        Set&lt;String&gt; s = ((HttpURLConnection) connection).getHeaderFields().keySet();</span>
<span class="nc" id="L6411">        String[] resp = new String[s.size()];</span>
<span class="nc" id="L6412">        s.toArray(resp);</span>
<span class="nc" id="L6413">        return resp;</span>
    }

    /**
     * @inheritDoc
     */
    public String[] getHeaderFields(String name, Object connection) throws IOException {
<span class="nc" id="L6420">        HttpURLConnection c = (HttpURLConnection) connection;</span>
<span class="nc" id="L6421">        List&lt;String&gt; headers = new ArrayList&lt;String&gt;();</span>

        // we need to merge headers with differing case since this should be case insensitive
<span class="nc bnc" id="L6424" title="All 2 branches missed.">        for(String key : c.getHeaderFields().keySet()) {</span>
<span class="nc bnc" id="L6425" title="All 4 branches missed.">            if(key != null &amp;&amp; key.equalsIgnoreCase(name)) {</span>
<span class="nc" id="L6426">                headers.addAll(c.getHeaderFields().get(key));</span>
            }
<span class="nc" id="L6428">        }</span>
<span class="nc bnc" id="L6429" title="All 2 branches missed.">        if (headers.size() &gt; 0) {</span>
<span class="nc" id="L6430">            List&lt;String&gt; v = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L6431">            v.addAll(headers);</span>
<span class="nc" id="L6432">            Collections.reverse(v);</span>
<span class="nc" id="L6433">            String[] s = new String[v.size()];</span>
<span class="nc" id="L6434">            v.toArray(s);</span>
<span class="nc" id="L6435">            return s;</span>
        }
        // workaround for a bug in some android devices
<span class="nc" id="L6438">        String f = c.getHeaderField(name);</span>
<span class="nc bnc" id="L6439" title="All 4 branches missed.">        if(f != null &amp;&amp; f.length() &gt; 0) {</span>
<span class="nc" id="L6440">            return new String[] {f};</span>
        }
<span class="nc" id="L6442">        return null;</span>



    }

    /**
     * @inheritDoc
     */
    public void deleteStorageFile(String name) {
<span class="nc" id="L6452">        getContext().deleteFile(name);</span>
<span class="nc" id="L6453">    }</span>

    /**
     * @inheritDoc
     */
    public OutputStream createStorageOutputStream(String name) throws IOException {
<span class="fc" id="L6459">        return getContext().openFileOutput(name, 0);</span>
    }

    /**
     * @inheritDoc
     */
    public InputStream createStorageInputStream(String name) throws IOException {
<span class="nc" id="L6466">        return getContext().openFileInput(name);</span>
    }

    /**
     * @inheritDoc
     */
    public boolean storageFileExists(String name) {
<span class="nc" id="L6473">        String[] fileList = getContext().fileList();</span>
<span class="nc bnc" id="L6474" title="All 2 branches missed.">        for (int iter = 0; iter &lt; fileList.length; iter++) {</span>
<span class="nc bnc" id="L6475" title="All 2 branches missed.">            if (fileList[iter].equals(name)) {</span>
<span class="nc" id="L6476">                return true;</span>
            }
        }
<span class="nc" id="L6479">        return false;</span>
    }

    /**
     * @inheritDoc
     */
    public String[] listStorageEntries() {
<span class="nc" id="L6486">        return getContext().fileList();</span>
    }

    /**
     * @inheritDoc
     */
    public int getStorageEntrySize(String name) {
<span class="nc" id="L6493">        return (int)new File(getContext().getFilesDir(), name).length();</span>
    }

    private String addFile(String s) {
        // I explicitly don't create a &quot;proper URL&quot; since code might rely on the fact that the file isn't encoded
<span class="nc bnc" id="L6498" title="All 4 branches missed.">        if(s != null &amp;&amp; s.startsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L6499">            return &quot;file://&quot; + s;</span>
        }
<span class="nc" id="L6501">        return s;</span>
    }

    /**
     * @inheritDoc
     */
    public String[] listFilesystemRoots() {

<span class="nc bnc" id="L6509" title="All 2 branches missed.">        if(!checkForPermission(Manifest.permission.READ_EXTERNAL_STORAGE, &quot;This is required to browse the file system&quot;)){</span>
<span class="nc" id="L6510">            return new String[]{};</span>
        }

<span class="nc" id="L6513">        String [] storageDirs = getStorageDirectories();</span>
<span class="nc bnc" id="L6514" title="All 2 branches missed.">        if(storageDirs != null){</span>
<span class="nc" id="L6515">            String [] roots = new String[storageDirs.length + 1];</span>
<span class="nc" id="L6516">            System.arraycopy(storageDirs, 0, roots, 0, storageDirs.length);</span>
<span class="nc" id="L6517">            roots[roots.length - 1] = addFile(Environment.getRootDirectory().getAbsolutePath());</span>
<span class="nc" id="L6518">            return roots;</span>
        }
<span class="nc" id="L6520">        return new String[]{addFile(Environment.getRootDirectory().getAbsolutePath())};</span>
    }

    @Override
    public boolean hasCachesDir() {
<span class="nc" id="L6525">        return true;</span>
    }

    @Override
    public String getCachesDir() {
<span class="nc" id="L6530">        return getContext().getCacheDir().getAbsolutePath();</span>
    }



    private String[] getStorageDirectories() {
<span class="nc" id="L6536">        String [] storageDirs = null;</span>

<span class="nc" id="L6538">        String storageDev = Environment.getExternalStorageDirectory().getPath();</span>
<span class="nc" id="L6539">        String storageRoot = storageDev.substring(0, storageDev.length() - 1);</span>
<span class="nc" id="L6540">        BufferedReader bufReader = null;</span>

        try {
<span class="nc" id="L6543">            bufReader = new BufferedReader(new InputStreamReader(new FileInputStream(&quot;/proc/mounts&quot;), StandardCharsets.UTF_8));</span>
<span class="nc" id="L6544">            ArrayList&lt;String&gt; list = new ArrayList&lt;String&gt;();</span>
            String line;

<span class="nc bnc" id="L6547" title="All 2 branches missed.">            while ((line = bufReader.readLine()) != null) {</span>
<span class="nc bnc" id="L6548" title="All 6 branches missed.">                if (line.contains(&quot;vfat&quot;) || line.contains(&quot;/mnt&quot;) || line.contains(&quot;/storage&quot;)) {</span>
<span class="nc" id="L6549">                    StringTokenizer tokens = new StringTokenizer(line, &quot; &quot;);</span>
<span class="nc" id="L6550">                    String s = tokens.nextToken();</span>
<span class="nc" id="L6551">                    s = tokens.nextToken(); // Take the second token, i.e. mount point</span>

<span class="nc bnc" id="L6553" title="All 2 branches missed.">                    if (s.indexOf(&quot;secure&quot;) != -1) {</span>
<span class="nc" id="L6554">                        continue;</span>
                    }

<span class="nc bnc" id="L6557" title="All 2 branches missed.">                    if (s.startsWith(storageRoot) == true) {</span>
<span class="nc" id="L6558">                        list.add(s);</span>
<span class="nc" id="L6559">                        continue;</span>
                    }

<span class="nc bnc" id="L6562" title="All 4 branches missed.">                    if (line.contains(&quot;vfat&quot;) &amp;&amp; line.contains(&quot;/mnt&quot;)) {</span>
<span class="nc" id="L6563">                        list.add(s);</span>
<span class="nc" id="L6564">                        continue;</span>
                    }
<span class="nc" id="L6566">                }</span>
            }

<span class="nc" id="L6569">            int count = list.size();</span>

<span class="nc bnc" id="L6571" title="All 2 branches missed.">            if (count &lt; 2) {</span>
<span class="nc" id="L6572">                storageDirs = new String[] {</span>
                        storageDev
                };
            }
            else {
<span class="nc" id="L6577">                storageDirs = new String[count];</span>

<span class="nc bnc" id="L6579" title="All 2 branches missed.">                for (int i = 0; i &lt; count; i++) {</span>
<span class="nc" id="L6580">                    storageDirs[i] = (String) list.get(i);</span>
                }
            }
        }
<span class="nc" id="L6584">        catch (FileNotFoundException e) {}</span>
<span class="nc" id="L6585">        catch (IOException e) {}</span>
        finally {
<span class="nc bnc" id="L6587" title="All 8 branches missed.">            if (bufReader != null) {</span>
                try {
<span class="nc" id="L6589">                    bufReader.close();</span>
                }
<span class="nc" id="L6591">                catch (IOException e) {}</span>
            }

<span class="nc" id="L6594">            return storageDirs;</span>
        }
    }

    /**
     * @inheritDoc
     */
    public String getAppHomePath() {
<span class="nc" id="L6602">        return addFile(getContext().getFilesDir().getAbsolutePath() + &quot;/&quot;);</span>
    }

    @Override
    public String toNativePath(String path) {
<span class="nc" id="L6607">        return removeFilePrefix(path);</span>
    }
    
    

    /**
     * @inheritDoc
     */
    public String[] listFiles(String directory) throws IOException {
<span class="nc" id="L6616">        directory = removeFilePrefix(directory);</span>
<span class="nc" id="L6617">        return new File(directory).list();</span>
    }

    /**
     * @inheritDoc
     */
    public long getRootSizeBytes(String root) {
<span class="nc" id="L6624">        return -1;</span>
    }

    /**
     * @inheritDoc
     */
    public long getRootAvailableSpace(String root) {
<span class="nc" id="L6631">        return -1;</span>
    }

    /**
     * @inheritDoc
     */
    public void mkdir(String directory) {
<span class="nc" id="L6638">        directory = removeFilePrefix(directory);</span>
<span class="nc" id="L6639">        new File(directory).mkdir();</span>
<span class="nc" id="L6640">    }</span>

    /**
     * @inheritDoc
     */
    public void deleteFile(String file) {
<span class="nc" id="L6646">        file = removeFilePrefix(file);</span>
<span class="nc" id="L6647">        File f = new File(file);</span>
<span class="nc" id="L6648">        f.delete();</span>
<span class="nc" id="L6649">    }</span>

    /**
     * @inheritDoc
     */
    public boolean isHidden(String file) {
<span class="nc" id="L6655">        file = removeFilePrefix(file);</span>
<span class="nc" id="L6656">        return new File(file).isHidden();</span>
    }

    /**
     * @inheritDoc
     */
    public void setHidden(String file, boolean h) {
<span class="nc" id="L6663">    }</span>

    /**
     * @inheritDoc
     */
    public long getFileLength(String file) {
<span class="nc" id="L6669">        file = removeFilePrefix(file);</span>
<span class="nc" id="L6670">        return new File(file).length();</span>
    }

    /**
     * @inheritDoc
     */
    public long getFileLastModified(String file) {
<span class="nc" id="L6677">        file = removeFilePrefix(file);</span>
<span class="nc" id="L6678">        return new File(file).lastModified();</span>
    }

    /**
     * @inheritDoc
     */
    public boolean isDirectory(String file) {
<span class="nc" id="L6685">        file = removeFilePrefix(file);</span>
<span class="nc" id="L6686">        return new File(file).isDirectory();</span>
    }

    /**
     * @inheritDoc
     */
    public char getFileSystemSeparator() {
<span class="nc" id="L6693">        return File.separatorChar;</span>
    }

    /**
     * @inheritDoc
     */
    public OutputStream openFileOutputStream(String file) throws IOException {
<span class="nc" id="L6700">        file = removeFilePrefix(file);</span>
<span class="nc" id="L6701">        OutputStream os = null;</span>
        try{
<span class="nc" id="L6703">            os = createFileOuputStream(file);</span>
<span class="nc" id="L6704">        }catch(FileNotFoundException fne){</span>
            //It is impossible to know if a path is considered an external
            //storage on the various android's versions.
            //So we try to open the path and if failed due to permission we will
            //ask for the permission from the user
<span class="nc bnc" id="L6709" title="All 2 branches missed.">            if(fne.getMessage().contains(&quot;Permission denied&quot;)){</span>

<span class="nc bnc" id="L6711" title="All 2 branches missed.">                if(!checkForPermission(Manifest.permission.WRITE_EXTERNAL_STORAGE, &quot;This is required to access the file&quot;)){</span>
                    //The user refused to give access.
<span class="nc" id="L6713">                    return null;</span>
                }else{
                    //The user gave permission try again to access the path
<span class="nc" id="L6716">                    return createFileOuputStream(file);</span>
                }

            }else{
<span class="nc" id="L6720">                throw fne;</span>
            }
<span class="nc" id="L6722">        }</span>

<span class="nc" id="L6724">        return os;</span>
    }

    private String removeFilePrefix(String file) {
<span class="nc bnc" id="L6728" title="All 2 branches missed.">        if (file.startsWith(&quot;file://&quot;)) {</span>
<span class="nc" id="L6729">            return file.substring(7);</span>
        }
<span class="nc bnc" id="L6731" title="All 2 branches missed.">        if (file.startsWith(&quot;file:/&quot;)) {</span>
<span class="nc" id="L6732">            return file.substring(5);</span>
        }
<span class="nc" id="L6734">        return file;</span>
    }

    /**
     * @inheritDoc
     */
    public InputStream openFileInputStream(String file) throws IOException {
<span class="nc" id="L6741">        file = removeFilePrefix(file);</span>
<span class="nc" id="L6742">        InputStream is = null;</span>
        try{
<span class="nc" id="L6744">            is = createFileInputStream(file);</span>
<span class="nc" id="L6745">        }catch(FileNotFoundException fne){</span>
            //It is impossible to know if a path is considered an external
            //storage on the various android's versions.
            //So we try to open the path and if failed due to permission we will
            //ask for the permission from the user
<span class="nc bnc" id="L6750" title="All 2 branches missed.">            if(fne.getMessage().contains(&quot;Permission denied&quot;)){</span>

<span class="nc bnc" id="L6752" title="All 2 branches missed.">                if(!checkForPermission(Manifest.permission.WRITE_EXTERNAL_STORAGE, &quot;This is required to access the file&quot;)){</span>
                    //The user refused to give access.
<span class="nc" id="L6754">                    return null;</span>
                }else{
                    //The user gave permission try again to access the path
<span class="nc" id="L6757">                    return openFileInputStream(file);</span>
                }

            }else{
<span class="nc" id="L6761">                throw fne;</span>
            }
<span class="nc" id="L6763">        }</span>

<span class="nc" id="L6765">        return is;</span>
    }

    @Override
    public boolean isMultiTouch() {
<span class="nc" id="L6770">        return true;</span>
    }

    /**
     * @inheritDoc
     */
    public boolean exists(String file) {
<span class="nc" id="L6777">        file = removeFilePrefix(file);</span>
<span class="nc" id="L6778">        return new File(file).exists();</span>
    }

    /**
     * @inheritDoc
     */
    public void rename(String file, String newName) {
<span class="nc" id="L6785">        file = removeFilePrefix(file);</span>
<span class="nc" id="L6786">        new File(file).renameTo(new File(new File(file).getParentFile(), newName));</span>
<span class="nc" id="L6787">    }</span>

    protected File createFileObject(String fileName) {
<span class="nc" id="L6790">        return new File(fileName);</span>
    }

    protected InputStream createFileInputStream(String fileName) throws FileNotFoundException {
<span class="nc" id="L6794">        return new FileInputStream(removeFilePrefix(fileName));</span>
    }

    protected InputStream createFileInputStream(File f) throws FileNotFoundException {
<span class="fc" id="L6798">        return new FileInputStream(f);</span>
    }

    protected OutputStream createFileOuputStream(String fileName) throws FileNotFoundException {
<span class="nc" id="L6802">        return new FileOutputStream(removeFilePrefix(fileName));</span>
    }

    protected OutputStream createFileOuputStream(java.io.File f) throws FileNotFoundException {
<span class="fc" id="L6806">        return new FileOutputStream(f);</span>
    }

    /**
     * @inheritDoc
     */
    public boolean shouldWriteUTFAsGetBytes() {
<span class="nc" id="L6813">        return true;</span>
    }


    /**
     * @inheritDoc
     */
    public void closingOutput(OutputStream s) {
        // For some reasons the Android guys chose not doing this by default:
        // http://android-developers.blogspot.com/2010/12/saving-data-safely.html
        // this seems to be a mistake of sacrificing stability for minor performance
        // gains which will only be noticeable on a server.
<span class="nc bnc" id="L6825" title="All 2 branches missed.">        if (s != null) {</span>
<span class="nc bnc" id="L6826" title="All 2 branches missed.">            if (s instanceof FileOutputStream) {</span>
                try {
<span class="nc" id="L6828">                    FileDescriptor fd = ((FileOutputStream) s).getFD();</span>
<span class="nc bnc" id="L6829" title="All 2 branches missed.">                    if (fd != null) {</span>
<span class="nc" id="L6830">                        fd.sync();</span>
                    }
<span class="nc" id="L6832">                } catch (IOException ex) {</span>
                    // this exception doesn't help us
<span class="nc" id="L6834">                    ex.printStackTrace();</span>
<span class="nc" id="L6835">                }</span>
            }
        }
<span class="nc" id="L6838">    }</span>

    /**
     * @inheritDoc
     */
    public void printStackTraceToStream(Throwable t, Writer o) {
<span class="fc" id="L6844">        PrintWriter p = new PrintWriter(o);</span>
<span class="fc" id="L6845">        t.printStackTrace(p);</span>
<span class="fc" id="L6846">    }</span>

    /**
     * This method returns the platform Location Control
     *
     * @return LocationControl Object
     */
    public LocationManager getLocationManager() {
<span class="nc" id="L6854">        String permissionMessage = &quot;This is required to get the location&quot;;</span>
<span class="nc" id="L6855">        if (</span>
<span class="nc bnc" id="L6856" title="All 2 branches missed.">                !checkForPermission( Manifest.permission.ACCESS_FINE_LOCATION, permissionMessage)</span>
        ) {
<span class="nc" id="L6858">            return null;</span>
        }
<span class="nc bnc" id="L6860" title="All 2 branches missed.">        if (</span>
                Build.VERSION.SDK_INT &gt;= 29  
<span class="nc bnc" id="L6862" title="All 2 branches missed.">                &amp;&amp; &quot;true&quot;.equals(Display.getInstance().getProperty(&quot;android.requiresBackgroundLocationPermissionForAPI29&quot;, &quot;false&quot;))</span>
        ) {
<span class="nc" id="L6864">            if (</span>
<span class="nc bnc" id="L6865" title="All 2 branches missed.">                    !checkForPermission(</span>
                            &quot;android.permission.ACCESS_BACKGROUND_LOCATION&quot;, 
                            permissionMessage
                    )
            ) {
<span class="nc" id="L6870">                com.codename1.io.Log.e(new RuntimeException(&quot;Background location permission denied&quot;));</span>
            }
        }

<span class="nc" id="L6874">        boolean includesPlayServices = Display.getInstance().getProperty(&quot;IncludeGPlayServices&quot;, &quot;false&quot;).equals(&quot;true&quot;);</span>
<span class="nc bnc" id="L6875" title="All 4 branches missed.">        if (includesPlayServices &amp;&amp; hasAndroidMarket()) {</span>
            try {
<span class="nc" id="L6877">                Class clazz = Class.forName(&quot;com.codename1.location.AndroidLocationPlayServiceManager&quot;);</span>
<span class="nc" id="L6878">                return (com.codename1.location.LocationManager)clazz.getMethod(&quot;getInstance&quot;).invoke(null);</span>
<span class="nc" id="L6879">            } catch (Exception e) {</span>
<span class="nc" id="L6880">                return AndroidLocationManager.getInstance(getContext());</span>
            }
        } else {
<span class="nc" id="L6883">            return AndroidLocationManager.getInstance(getContext());</span>
        }
    }

    private String fixAttachmentPath(String attachment) {
<span class="nc" id="L6888">        com.codename1.io.File cn1File = new com.codename1.io.File(attachment);</span>
<span class="nc" id="L6889">        File mediaStorageDir = new File(new File(getContext().getCacheDir(), &quot;intent_files&quot;), &quot;Attachment&quot;);</span>

        // Create the storage directory if it does not exist
<span class="nc bnc" id="L6892" title="All 2 branches missed.">        if (!mediaStorageDir.exists()) {</span>
<span class="nc bnc" id="L6893" title="All 2 branches missed.">            if (!mediaStorageDir.mkdirs()) {</span>
<span class="nc" id="L6894">                Log.d(Display.getInstance().getProperty(&quot;AppName&quot;, &quot;CodenameOne&quot;), &quot;failed to create directory&quot;);</span>
<span class="nc" id="L6895">                return null;</span>
            }
        }

<span class="nc" id="L6899">        File newFile = new File(mediaStorageDir.getPath() + File.separator</span>
<span class="nc" id="L6900">                    + cn1File.getName());</span>
<span class="nc bnc" id="L6901" title="All 2 branches missed.">        if (newFile.exists()) {</span>
<span class="nc bnc" id="L6902" title="All 2 branches missed.">            if (Display.getInstance().getProperty(&quot;DeleteCachedFileAfterShare&quot;, &quot;false&quot;).equals(&quot;true&quot;)) {</span>
<span class="nc" id="L6903">                newFile.delete();</span>
            } else {
                // Create a media file name
<span class="nc" id="L6906">                String timeStamp = new SimpleDateFormat(&quot;yyyyMMdd_HHmmss&quot;).format(new Date());</span>
<span class="nc" id="L6907">                newFile = new File(mediaStorageDir.getPath() + File.separator</span>
<span class="nc" id="L6908">                        + &quot;IMG_&quot; + timeStamp + &quot;_&quot; + cn1File.getName());</span>
            }
        }


        //Uri fileUri = Uri.fromFile(newFile);
<span class="nc" id="L6914">        newFile.getParentFile().mkdirs();</span>
        //Uri imageUri = Uri.fromFile(newFile);
<span class="nc" id="L6916">        Uri fileUri = FileProvider.getUriForFile(getContext(), getContext().getPackageName()+&quot;.provider&quot;, newFile);</span>

        try {
<span class="nc" id="L6919">            InputStream is = FileSystemStorage.getInstance().openInputStream(attachment);</span>
<span class="nc" id="L6920">            OutputStream os = new FileOutputStream(newFile);</span>
<span class="nc" id="L6921">            byte [] buf = new byte[1024];</span>
            int len;
<span class="nc bnc" id="L6923" title="All 2 branches missed.">            while((len = is.read(buf)) &gt; -1){</span>
<span class="nc" id="L6924">                os.write(buf, 0, len);</span>
            }
<span class="nc" id="L6926">            is.close();</span>
<span class="nc" id="L6927">            os.close();</span>
<span class="nc" id="L6928">        } catch (IOException ex) {</span>
<span class="nc" id="L6929">            Logger.getLogger(AndroidImplementation.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L6930">        }</span>

<span class="nc" id="L6932">        return fileUri.toString();</span>
    }

    /**
     * @inheritDoc
     */
    public void sendMessage(String[] recipients, String subject, Message msg) {
<span class="nc bnc" id="L6939" title="All 2 branches missed.">        if(editInProgress()) {</span>
<span class="nc" id="L6940">            stopEditing(true);</span>
        }
        Intent emailIntent;
<span class="nc" id="L6943">        String attachment = msg.getAttachment();</span>
<span class="nc bnc" id="L6944" title="All 6 branches missed.">        boolean hasAttachment = (attachment != null &amp;&amp; attachment.length() &gt; 0) || msg.getAttachments().size() &gt; 0;</span>

<span class="nc bnc" id="L6946" title="All 4 branches missed.">        if(msg.getMimeType().equals(Message.MIME_TEXT) &amp;&amp; !hasAttachment){</span>
<span class="nc" id="L6947">            StringBuilder to = new StringBuilder();</span>
<span class="nc bnc" id="L6948" title="All 2 branches missed.">            for (int i = 0; i &lt; recipients.length; i++) {</span>
<span class="nc" id="L6949">                to.append(recipients[i]);</span>
<span class="nc" id="L6950">                to.append(&quot;;&quot;);</span>
            }
<span class="nc" id="L6952">            emailIntent = new Intent(Intent.ACTION_SENDTO,</span>
<span class="nc" id="L6953">                    Uri.parse(</span>
<span class="nc" id="L6954">                            &quot;mailto:&quot; + to.toString()</span>
<span class="nc" id="L6955">                                    + &quot;?subject=&quot; + Uri.encode(subject)</span>
<span class="nc" id="L6956">                                    + &quot;&amp;body=&quot; + Uri.encode(msg.getContent())));</span>
<span class="nc" id="L6957">        }else{</span>
<span class="nc bnc" id="L6958" title="All 2 branches missed.">            if (hasAttachment) {</span>
<span class="nc bnc" id="L6959" title="All 2 branches missed.">                if(msg.getAttachments().size() &gt; 1) {</span>
<span class="nc" id="L6960">                    emailIntent = new Intent(android.content.Intent.ACTION_SEND_MULTIPLE);</span>
<span class="nc" id="L6961">                    emailIntent.putExtra(android.content.Intent.EXTRA_EMAIL, recipients);</span>
<span class="nc" id="L6962">                    emailIntent.putExtra(android.content.Intent.EXTRA_SUBJECT, subject);</span>
<span class="nc" id="L6963">                    emailIntent.setType(msg.getMimeType());</span>
<span class="nc" id="L6964">                    ArrayList&lt;Uri&gt; uris = new ArrayList&lt;Uri&gt;();</span>

<span class="nc bnc" id="L6966" title="All 2 branches missed.">                    for(String path : msg.getAttachments().keySet()) {</span>
<span class="nc" id="L6967">                        uris.add(Uri.parse(fixAttachmentPath(path)));</span>
<span class="nc" id="L6968">                    }</span>

<span class="nc" id="L6970">                    emailIntent.putParcelableArrayListExtra(Intent.EXTRA_STREAM, uris);</span>
<span class="nc" id="L6971">                } else {</span>
<span class="nc" id="L6972">                    emailIntent = new Intent(android.content.Intent.ACTION_SEND);</span>
<span class="nc" id="L6973">                    emailIntent.putExtra(android.content.Intent.EXTRA_EMAIL, recipients);</span>
<span class="nc" id="L6974">                    emailIntent.putExtra(android.content.Intent.EXTRA_SUBJECT, subject);</span>
<span class="nc" id="L6975">                    emailIntent.setType(msg.getMimeType());</span>
<span class="nc" id="L6976">                    emailIntent.setType(msg.getAttachmentMimeType());</span>
                    //if the attachment is in the uder home dir we need to copy it
                    //to an accessible dir
<span class="nc" id="L6979">                    attachment = fixAttachmentPath(attachment);</span>
<span class="nc" id="L6980">                    emailIntent.putExtra(Intent.EXTRA_STREAM, Uri.parse(attachment));</span>
                }
            } else {
<span class="nc" id="L6983">                emailIntent = new Intent(android.content.Intent.ACTION_SEND);</span>
<span class="nc" id="L6984">                emailIntent.putExtra(android.content.Intent.EXTRA_EMAIL, recipients);</span>
<span class="nc" id="L6985">                emailIntent.putExtra(android.content.Intent.EXTRA_SUBJECT, subject);</span>
<span class="nc" id="L6986">                emailIntent.setType(msg.getMimeType());</span>
            }
<span class="nc bnc" id="L6988" title="All 2 branches missed.">            if (msg.getMimeType().equals(Message.MIME_HTML)) {</span>
<span class="nc" id="L6989">                emailIntent.putExtra(android.content.Intent.EXTRA_TEXT, Html.fromHtml(msg.getContent()));</span>
<span class="nc" id="L6990">                emailIntent.putExtra(&quot;android.intent.extra.HTML_TEXT&quot;, msg.getContent());</span>
            }else{
                /*
                // Attempted this workaround to fix the ClassCastException that occurs on android when
                // there are multiple attachments.  Unfortunately, this fixes the stack trace, but
                // has the unwanted side-effect of producing a blank message body.
                // Same workaround for HTML mimetype also fails the same way.
                // Conclusion, Just live with the stack trace.  It doesn't seem to affect the
                // execution of the program... treat it as a warning.
                // See https://github.com/codenameone/CodenameOne/issues/1782
                if (msg.getAttachments().size() &gt; 1) {
                    ArrayList&lt;String&gt; contentArr = new ArrayList&lt;String&gt;();
                    contentArr.add(msg.getContent());
                    emailIntent.putStringArrayListExtra(android.content.Intent.EXTRA_TEXT, contentArr);
                } else {
                    emailIntent.putExtra(android.content.Intent.EXTRA_TEXT, msg.getContent());

                }*/
<span class="nc" id="L7008">                emailIntent.putExtra(android.content.Intent.EXTRA_TEXT, msg.getContent());</span>
            }

        }
<span class="nc" id="L7012">        final String attach = attachment;</span>
<span class="nc" id="L7013">        AndroidNativeUtil.startActivityForResult(Intent.createChooser(emailIntent, &quot;Send mail...&quot;), new IntentResultListener() {</span>

            @Override
            public void onActivityResult(int requestCode, int resultCode, Intent data) {
<span class="nc bnc" id="L7017" title="All 6 branches missed.">                if(attach != null &amp;&amp; attach.length() &gt; 0 &amp;&amp; attach.contains(&quot;tmp&quot;)){</span>
<span class="nc" id="L7018">                    FileSystemStorage.getInstance().delete(attach);</span>
                }
<span class="nc" id="L7020">            }</span>
        });
<span class="nc" id="L7022">    }</span>

    /**
     * @inheritDoc
     */
    public void dial(String phoneNumber) {
<span class="nc" id="L7028">        Intent dialer = new Intent(android.content.Intent.ACTION_DIAL, Uri.parse(&quot;tel:&quot; + phoneNumber));</span>
<span class="nc" id="L7029">        getContext().startActivity(dialer);</span>
<span class="nc" id="L7030">    }</span>

    @Override
    public int getSMSSupport() {
<span class="nc bnc" id="L7034" title="All 2 branches missed.">        if(canDial()) {</span>
<span class="nc" id="L7035">            return Display.SMS_INTERACTIVE;</span>
        }
<span class="nc" id="L7037">        return Display.SMS_NOT_SUPPORTED;</span>
    }

    /**
     * @inheritDoc
     */
    public void sendSMS(final String phoneNumber, final String message, boolean i) throws IOException {
        /*if(!checkForPermission(Manifest.permission.SEND_SMS, &quot;This is required to send a SMS&quot;)){
            return;
        }*/
<span class="nc bnc" id="L7047" title="All 2 branches missed.">        if(!checkForPermission(Manifest.permission.READ_PHONE_STATE, &quot;This is required to send a SMS&quot;)){</span>
<span class="nc" id="L7048">            return;</span>
        }
<span class="nc bnc" id="L7050" title="All 2 branches missed.">        if(i) {</span>
<span class="nc" id="L7051">            Intent smsIntent = null;</span>
<span class="nc bnc" id="L7052" title="All 2 branches missed.">            if(android.os.Build.VERSION.SDK_INT &lt; 19){</span>
<span class="nc" id="L7053">                smsIntent = new Intent(Intent.ACTION_VIEW);</span>
<span class="nc" id="L7054">                smsIntent.setType(&quot;vnd.android-dir/mms-sms&quot;);</span>
<span class="nc" id="L7055">                smsIntent.putExtra(&quot;address&quot;, phoneNumber);</span>
<span class="nc" id="L7056">                smsIntent.putExtra(&quot;sms_body&quot;,message);</span>
            }else{
<span class="nc" id="L7058">                smsIntent = new Intent(Intent.ACTION_SENDTO);</span>
<span class="nc" id="L7059">                smsIntent.setData(Uri.parse(&quot;smsto:&quot; + Uri.encode(phoneNumber)));</span>
<span class="nc" id="L7060">                smsIntent.putExtra(&quot;sms_body&quot;, message);</span>
            }
<span class="nc" id="L7062">            getContext().startActivity(smsIntent);</span>

        } /*else {
            SmsManager sms = SmsManager.getDefault();
            ArrayList&lt;String&gt; parts = sms.divideMessage(message);
            sms.sendMultipartTextMessage(phoneNumber, null, parts, null, null);
        }*/
<span class="nc" id="L7069">    }</span>

    @Override
    public void dismissNotification(Object o) {
<span class="nc" id="L7073">        NotificationManager notificationManager = (NotificationManager) getContext().getSystemService(Activity.NOTIFICATION_SERVICE);</span>
<span class="nc bnc" id="L7074" title="All 2 branches missed.">        if(o != null){</span>
<span class="nc" id="L7075">            Integer n = (Integer)o;</span>
<span class="nc" id="L7076">            notificationManager.cancel(&quot;CN1&quot;, n.intValue());</span>
<span class="nc" id="L7077">        }else{</span>
<span class="nc" id="L7078">            notificationManager.cancelAll();</span>
        }
<span class="nc" id="L7080">    }</span>

    @Override
    public boolean isNotificationSupported() {
<span class="nc" id="L7084">        return true;</span>
    }

    /**
     * Keys of display properties that need to be made available to Services
     * i.e. must be accessible even if CN1 is not initialized.
     * 
     * This is accomplished by setting them inside init().  Then they
     * are written to file so that they can be accessed inside a service
     * like push notification service.
     */
<span class="fc" id="L7095">    private static final String[] servicePropertyKeys = new String[]{</span>
        &quot;android.NotificationChannel.id&quot;,
        &quot;android.NotificationChannel.name&quot;,
        &quot;android.NotificationChannel.description&quot;,
        &quot;android.NotificationChannel.importance&quot;,
        &quot;android.NotificationChannel.enableLights&quot;,
        &quot;android.NotificationChannel.lightColor&quot;,
        &quot;android.NotificationChannel.enableVibration&quot;,
        &quot;android.NotificationChannel.vibrationPattern&quot;,
        &quot;android.NotoficationChannel.soundUri&quot;
    };
    
    /**
     * Flag to indicate if any of the service properties have been changed.
     */
    private static boolean servicePropertiesDirty() {
<span class="pc bpc" id="L7111" title="1 of 2 branches missed.">        for (String key : servicePropertyKeys) {</span>
<span class="pc bpc" id="L7112" title="1 of 2 branches missed.">            if (Display.getInstance().getProperty(key, null) != null) {</span>
<span class="fc" id="L7113">                return true;</span>
            }
        }
<span class="nc" id="L7116">        return false;</span>
    }
    
    /**
     * Stores properties that need to be accessible to services.   
     * i.e. must be accessible even if CN1 is not initialized.
     * 
     * This is accomplished by setting them inside init().  Then they
     * are written to file so that they can be accessed inside a service
     * like push notification service.
     */
    private static Map&lt;String,String&gt; serviceProperties;
    
    /**
     * Gets the service properties.  Will read properties from file so that
     * they are available even if CN1 is not initialized.
     * @param a
     * @return 
     */
    public static Map&lt;String,String&gt; getServiceProperties(Context a) {
<span class="pc bpc" id="L7136" title="1 of 2 branches missed.">        if (serviceProperties == null) {</span>
<span class="fc" id="L7137">            InputStream i = null;</span>
            try {
<span class="fc" id="L7139">                serviceProperties = new HashMap&lt;String,String&gt;();</span>
                try {
<span class="nc" id="L7141">                    i = a.openFileInput(&quot;CN1$AndroidServiceProperties&quot;);</span>
<span class="nc bnc" id="L7142" title="All 2 branches missed.">                    if(i == null) {</span>
<span class="nc" id="L7143">                        return serviceProperties;</span>
                    }
<span class="fc" id="L7145">                } catch (FileNotFoundException notFoundEx){</span>
<span class="fc" id="L7146">                    return serviceProperties;</span>
<span class="nc" id="L7147">                }</span>
<span class="nc" id="L7148">                DataInputStream is = new DataInputStream(i);</span>
<span class="nc" id="L7149">                int count = is.readInt();</span>
<span class="nc bnc" id="L7150" title="All 2 branches missed.">                for (int idx=0; idx&lt;count; idx++) {</span>
<span class="nc" id="L7151">                    String key = is.readUTF();</span>
<span class="nc" id="L7152">                    String value = is.readUTF();</span>
<span class="nc" id="L7153">                    serviceProperties.put(key, value);</span>
                }
<span class="nc" id="L7155">            } catch (IOException ex) {</span>
<span class="nc" id="L7156">                Logger.getLogger(AndroidImplementation.class.getName()).log(Level.SEVERE, null, ex);</span>
            } finally {
                try {
<span class="pc bpc" id="L7159" title="1 of 2 branches missed.">                    if (i != null) i.close();</span>
<span class="nc" id="L7160">                } catch (Throwable ex) {</span>
<span class="nc" id="L7161">                    Logger.getLogger(AndroidImplementation.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="fc" id="L7162">                }</span>
            }
        }
<span class="nc" id="L7165">        return serviceProperties;</span>
    }
    
    public static void writeServiceProperties(Context a) {
<span class="pc bpc" id="L7169" title="1 of 2 branches missed.">        if (servicePropertiesDirty()) {</span>
<span class="fc" id="L7170">            Map&lt;String,String&gt; out = getServiceProperties(a);</span>
            
            
<span class="fc bfc" id="L7173" title="All 2 branches covered.">            for (String key : servicePropertyKeys) {</span>
                
<span class="fc" id="L7175">                String val = Display.getInstance().getProperty(key, null);</span>
<span class="fc bfc" id="L7176" title="All 2 branches covered.">                if (val != null) {</span>
<span class="fc" id="L7177">                    out.put(key, val);</span>
                }
<span class="pc bpc" id="L7179" title="1 of 2 branches missed.">                if (&quot;true&quot;.equals(Display.getInstance().getProperty(key+&quot;#delete&quot;, null))) {</span>
<span class="nc" id="L7180">                    out.remove(key);</span>
                    
                }
            }
            
<span class="fc" id="L7185">            OutputStream os = null;</span>
            try {
<span class="fc" id="L7187">                os = a.openFileOutput(&quot;CN1$AndroidServiceProperties&quot;, 0);</span>
<span class="pc bpc" id="L7188" title="1 of 2 branches missed.">                if (os == null) {</span>
<span class="nc" id="L7189">                    System.out.println(&quot;Failed to save service properties null output stream&quot;);</span>
<span class="nc" id="L7190">                    return;</span>
                }
<span class="fc" id="L7192">                DataOutputStream dos = new DataOutputStream(os);</span>
<span class="fc" id="L7193">                dos.writeInt(out.size());</span>
<span class="fc bfc" id="L7194" title="All 2 branches covered.">                for (String key : out.keySet()) {</span>
<span class="fc" id="L7195">                    dos.writeUTF(key);</span>
<span class="fc" id="L7196">                    dos.writeUTF((String)out.get(key));</span>
<span class="fc" id="L7197">                }</span>
<span class="fc" id="L7198">                serviceProperties = null;</span>
<span class="nc" id="L7199">            } catch (FileNotFoundException ex) {</span>
<span class="nc" id="L7200">                System.out.println(&quot;Service properties file not found.  This is normal for the first run.   On subsequent runs, the file should exist.&quot;);</span>
<span class="nc" id="L7201">            } catch (IOException ex) {</span>
                
<span class="nc" id="L7203">                Logger.getLogger(AndroidImplementation.class.getName()).log(Level.SEVERE, null, ex);</span>
            } finally {
                try {
<span class="pc bpc" id="L7206" title="1 of 2 branches missed.">                    if (os != null) os.close();</span>
<span class="nc" id="L7207">                } catch (Throwable ex) {</span>
<span class="nc" id="L7208">                    Logger.getLogger(AndroidImplementation.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="fc" id="L7209">                }</span>
            }
        }
<span class="fc" id="L7212">    }</span>
    
    /**
     * Gets a &quot;service&quot; display property.  This is a property that is available
     * even if CN1 is not initialized.  They are written to file after init() so that 
     * they are available thereafter to services like push notification services.
     * @param key THe key
     * @param defaultValue The default value
     * @param context Context
     * @return The value.
     */
    public static String getServiceProperty(String key, String defaultValue, Context context) {
<span class="nc bnc" id="L7224" title="All 2 branches missed.">        if (Display.isInitialized()) {</span>
<span class="nc" id="L7225">            return Display.getInstance().getProperty(key, defaultValue);</span>
        }
<span class="nc" id="L7227">        String val = getServiceProperties(context).get(key);</span>
<span class="nc bnc" id="L7228" title="All 2 branches missed.">        return val == null ? defaultValue : val;</span>
    }
    
    /**
     * Sets the notification channel on a notification builder.  Uses service properties to 
     * set properties of channel.
     * @param nm The notification manager.
     * @param mNotifyBuilder The notify builder
     * @param context The context
     * @since 7.0
     */
    public static void setNotificationChannel(NotificationManager nm, NotificationCompat.Builder mNotifyBuilder, Context context) {
<span class="nc" id="L7240">        setNotificationChannel(nm, mNotifyBuilder, context, (String)null);</span>
        
<span class="nc" id="L7242">    }</span>
    
    /**
     * Sets the notification channel on a notification builder.  Uses service properties to 
     * set properties of channel.
     * @param nm The notification manager.
     * @param mNotifyBuilder The notify builder
     * @param context The context
     * @param soundName The name of the sound to use for notifications on this channel.  E.g. mysound.mp3.  This feature is not yet implemented, but
     *  parameter is added now to scaffold compatibility with build daemon until implementation is complete.
     * @since 8.0
     */
    public static void setNotificationChannel(NotificationManager nm, NotificationCompat.Builder mNotifyBuilder, Context context, String soundName) {
<span class="nc bnc" id="L7255" title="All 2 branches missed.">        if (android.os.Build.VERSION.SDK_INT &gt;= 26) {</span>
            try {
<span class="nc" id="L7257">                NotificationManager mNotificationManager = nm;</span>
                              
<span class="nc" id="L7259">                String id = getServiceProperty(&quot;android.NotificationChannel.id&quot;, &quot;cn1-channel&quot;, context);</span>
                
<span class="nc" id="L7261">                CharSequence name = getServiceProperty(&quot;android.NotificationChannel.name&quot;, &quot;Notifications&quot;, context);</span>
                
<span class="nc" id="L7263">                String description = getServiceProperty(&quot;android.NotificationChannel.description&quot;, &quot;Remote notifications&quot;, context);</span>
                
                // NotificationManager.IMPORTANCE_LOW = 2
                // NotificationManager.IMPORTANCE_HIGH = 4  // &lt;-- Minimum level to produce sound.
<span class="nc" id="L7267">                int importance = Integer.parseInt(getServiceProperty(&quot;android.NotificationChannel.importance&quot;, &quot;4&quot;, context));</span>
                    // Note: Currently we use a single notification channel for the app, but if the app uses different kinds of 
                    // push notifications, then this may not be sufficient.   E.g. The app may send both silent push notifications
                    // and regular notifications - but their settings (e.g. sound) are all managed through one channel with
                    // same settings. 
                    // TODO Add support for multiple channels.
                    // See https://github.com/codenameone/CodenameOne/issues/2583
                
<span class="nc" id="L7275">                Class clsNotificationChannel = Class.forName(&quot;android.app.NotificationChannel&quot;);</span>
                //android.app.NotificationChannel mChannel = new android.app.NotificationChannel(id, name, importance);
<span class="nc" id="L7277">                Constructor constructor = clsNotificationChannel.getConstructor(java.lang.String.class, java.lang.CharSequence.class, int.class);</span>
<span class="nc" id="L7278">                Object mChannel = constructor.newInstance(new Object[]{id, name, importance});</span>
                
<span class="nc" id="L7280">                Method method = clsNotificationChannel.getMethod(&quot;setDescription&quot;, java.lang.String.class);</span>
<span class="nc" id="L7281">                method.invoke(mChannel, new Object[]{description});</span>
                //mChannel.setDescription(description);
                
<span class="nc" id="L7284">                method = clsNotificationChannel.getMethod(&quot;enableLights&quot;, boolean.class);</span>
<span class="nc" id="L7285">                method.invoke(mChannel, new Object[]{Boolean.parseBoolean(getServiceProperty(&quot;android.NotificationChannel.enableLights&quot;, &quot;true&quot;, context))});</span>
                //mChannel.enableLights(Boolean.parseBoolean(getServiceProperty(&quot;android.NotificationChannel.enableLights&quot;, &quot;true&quot;, context)));
                
<span class="nc" id="L7288">                method = clsNotificationChannel.getMethod(&quot;setLightColor&quot;, int.class);</span>
<span class="nc" id="L7289">                method.invoke(mChannel, new Object[]{Integer.parseInt(getServiceProperty(&quot;android.NotificationChannel.lightColor&quot;, &quot;&quot; + android.graphics.Color.RED, context))});</span>
                //mChannel.setLightColor(Integer.parseInt(getServiceProperty(&quot;android.NotificationChannel.lightColor&quot;, &quot;&quot; + android.graphics.Color.RED, context)));
                
<span class="nc" id="L7292">                method = clsNotificationChannel.getMethod(&quot;enableVibration&quot;, boolean.class);</span>
<span class="nc" id="L7293">                method.invoke(mChannel, new Object[]{Boolean.parseBoolean(getServiceProperty(&quot;android.NotificationChannel.enableVibration&quot;, &quot;false&quot;, context))});</span>
                //mChannel.enableVibration(Boolean.parseBoolean(getServiceProperty(&quot;android.NotificationChannel.enableVibration&quot;, &quot;false&quot;, context)));
<span class="nc" id="L7295">                String vibrationPatternStr = getServiceProperty(&quot;android.NotificationChannel.vibrationPattern&quot;, null, context);</span>
<span class="nc bnc" id="L7296" title="All 2 branches missed.">                if (vibrationPatternStr != null) {</span>
<span class="nc" id="L7297">                    String[] parts = vibrationPatternStr.split(&quot;,&quot;);</span>
<span class="nc" id="L7298">                    int len = parts.length;</span>
<span class="nc" id="L7299">                    long[] pattern = new long[len];</span>
<span class="nc bnc" id="L7300" title="All 2 branches missed.">                    for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L7301">                        pattern[i] = Long.parseLong(parts[i].trim());</span>
                    }
<span class="nc" id="L7303">                    method = clsNotificationChannel.getMethod(&quot;setVibrationPattern&quot;, long[].class);</span>
<span class="nc" id="L7304">                    method.invoke(mChannel, new Object[]{pattern});</span>
                    //mChannel.setVibrationPattern(pattern);
                }
                
<span class="nc" id="L7308">                String soundUri = getServiceProperty(&quot;android.NotificationChannel.soundUri&quot;, null, context);</span>
<span class="nc bnc" id="L7309" title="All 2 branches missed.">                if (soundUri != null) {</span>
<span class="nc" id="L7310">                    Uri uri= android.net.Uri.parse(soundUri);</span>
                    
<span class="nc" id="L7312">                    android.media.AudioAttributes audioAttributes = new android.media.AudioAttributes.Builder()</span>
<span class="nc" id="L7313">                            .setContentType(android.media.AudioAttributes.CONTENT_TYPE_SONIFICATION)</span>
<span class="nc" id="L7314">                            .setUsage(android.media.AudioAttributes.USAGE_NOTIFICATION)</span>
<span class="nc" id="L7315">                            .build();</span>
<span class="nc" id="L7316">                    method = clsNotificationChannel.getMethod(&quot;setSound&quot;, android.net.Uri.class, android.media.AudioAttributes.class);</span>
<span class="nc" id="L7317">                    method.invoke(mChannel, new Object[]{uri, audioAttributes});</span>
                }
                
<span class="nc" id="L7320">                method = NotificationManager.class.getMethod(&quot;createNotificationChannel&quot;, clsNotificationChannel);</span>
<span class="nc" id="L7321">                method.invoke(mNotificationManager, new Object[]{mChannel});</span>
                //mNotificationManager.createNotificationChannel(mChannel);
                try {
                    // For some reason I can't find the app-support-v4.jar for
                    // API 26 that includes this method so that I can compile in netbeans.
                    // So we use reflection...  If someone coming after can find a newer version
                    // that has setChannelId(), please rip out this ugly reflection hack and
                    // replace it with a proper call to mNotifyBuilder.setChannelId(id)
<span class="nc" id="L7329">                    mNotifyBuilder.getClass().getMethod(&quot;setChannelId&quot;, new Class[]{String.class}).invoke(mNotifyBuilder, new Object[]{id});</span>
<span class="nc" id="L7330">                } catch (Exception ex) {</span>
<span class="nc" id="L7331">                    Logger.getLogger(AndroidImplementation.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L7332">                }</span>
                //mNotifyBuilder.setChannelId(id);
<span class="nc" id="L7334">            } catch (ClassNotFoundException ex) {</span>
<span class="nc" id="L7335">                Logger.getLogger(AndroidImplementation.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L7336">            } catch (NoSuchMethodException ex) {</span>
<span class="nc" id="L7337">                Logger.getLogger(AndroidImplementation.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L7338">            } catch (SecurityException ex) {</span>
<span class="nc" id="L7339">                Logger.getLogger(AndroidImplementation.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L7340">            } catch (IllegalAccessException ex) {</span>
<span class="nc" id="L7341">                Logger.getLogger(AndroidImplementation.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L7342">            } catch (IllegalArgumentException ex) {</span>
<span class="nc" id="L7343">                Logger.getLogger(AndroidImplementation.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L7344">            } catch (InvocationTargetException ex) {</span>
<span class="nc" id="L7345">                Logger.getLogger(AndroidImplementation.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L7346">            } catch (InstantiationException ex) {</span>
<span class="nc" id="L7347">                Logger.getLogger(AndroidImplementation.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L7348">            }</span>
            //mNotifyBuilder.setChannelId(id);
        }

<span class="nc" id="L7352">    }</span>
    
    public Object notifyStatusBar(String tickerText, String contentTitle,
                                  String contentBody, boolean vibrate, boolean flashLights, Hashtable args) {
<span class="nc" id="L7356">        int id = getContext().getResources().getIdentifier(&quot;icon&quot;, &quot;drawable&quot;, getContext().getApplicationInfo().packageName);</span>

<span class="nc" id="L7358">        NotificationManager notificationManager = (NotificationManager) getContext().getSystemService(Activity.NOTIFICATION_SERVICE);</span>

<span class="nc" id="L7360">        Intent notificationIntent = new Intent();</span>
<span class="nc" id="L7361">        notificationIntent.setComponent(activityComponentName);</span>
<span class="nc" id="L7362">        PendingIntent contentIntent = createPendingIntent(getContext(), 0, notificationIntent);</span>


<span class="nc" id="L7365">        NotificationCompat.Builder builder = new NotificationCompat.Builder(getContext())</span>
<span class="nc" id="L7366">                .setContentIntent(contentIntent)</span>
<span class="nc" id="L7367">                .setSmallIcon(id)</span>
<span class="nc" id="L7368">                .setContentTitle(contentTitle)</span>
<span class="nc" id="L7369">                .setTicker(tickerText);</span>
<span class="nc bnc" id="L7370" title="All 2 branches missed.">        if(flashLights){</span>
<span class="nc" id="L7371">            builder.setLights(0, 1000, 1000);</span>
        }
<span class="nc bnc" id="L7373" title="All 2 branches missed.">        if(vibrate){</span>
<span class="nc" id="L7374">            builder.setVibrate(new long[]{0, 100, 1000});</span>
        }
<span class="nc bnc" id="L7376" title="All 2 branches missed.">        if(args != null) {</span>
<span class="nc" id="L7377">            Boolean b = (Boolean)args.get(&quot;persist&quot;);</span>
<span class="nc bnc" id="L7378" title="All 4 branches missed.">            if(b != null &amp;&amp; b.booleanValue()) {</span>
<span class="nc" id="L7379">                builder.setAutoCancel(false);</span>
<span class="nc" id="L7380">                builder.setOngoing(true);</span>
            } else {
<span class="nc" id="L7382">                builder.setAutoCancel(false);</span>
            }
<span class="nc" id="L7384">        } else {</span>
<span class="nc" id="L7385">            builder.setAutoCancel(true);</span>
        }
<span class="nc" id="L7387">        Notification notification = builder.build();</span>
<span class="nc" id="L7388">        int notifyId = 10001;</span>
<span class="nc" id="L7389">        notificationManager.notify(&quot;CN1&quot;, notifyId, notification);</span>
<span class="nc" id="L7390">        return new Integer(notifyId);</span>
    }

    public boolean isContactsPermissionGranted() {
<span class="nc bnc" id="L7394" title="All 2 branches missed.">        if (android.os.Build.VERSION.SDK_INT &lt; 23) {</span>
<span class="nc" id="L7395">            return true;</span>
        }

<span class="nc bnc" id="L7398" title="All 2 branches missed.">        if (androidx.core.content.ContextCompat.checkSelfPermission(getContext(),</span>
                Manifest.permission.READ_CONTACTS)
                != PackageManager.PERMISSION_GRANTED) {
<span class="nc" id="L7401">            return false;</span>
        }
<span class="nc" id="L7403">        return true;</span>
    }


    @Override
    public String[] getAllContacts(boolean withNumbers) {
<span class="nc bnc" id="L7409" title="All 2 branches missed.">        if(!checkForPermission(Manifest.permission.READ_CONTACTS, &quot;This is required to get the contacts&quot;)){</span>
<span class="nc" id="L7410">            return new String[]{};</span>
        }
<span class="nc" id="L7412">        return AndroidContactsManager.getInstance().getContacts(getContext(), withNumbers);</span>
    }

    @Override
    public Contact getContactById(String id) {
<span class="nc bnc" id="L7417" title="All 2 branches missed.">        if(!checkForPermission(Manifest.permission.READ_CONTACTS, &quot;This is required to get the contacts&quot;)){</span>
<span class="nc" id="L7418">            return null;</span>
        }
<span class="nc" id="L7420">        return AndroidContactsManager.getInstance().getContact(getContext(), id);</span>
    }

    @Override
    public Contact getContactById(String id, boolean includesFullName, boolean includesPicture,
                                  boolean includesNumbers, boolean includesEmail, boolean includeAddress){
<span class="nc bnc" id="L7426" title="All 2 branches missed.">        if(!checkForPermission(Manifest.permission.READ_CONTACTS, &quot;This is required to get the contacts&quot;)){</span>
<span class="nc" id="L7427">            return null;</span>
        }
<span class="nc" id="L7429">        return AndroidContactsManager.getInstance().getContact(getContext(), id, includesFullName, includesPicture,</span>
                includesNumbers, includesEmail, includeAddress);
    }

    @Override
    public Contact[] getAllContacts(boolean withNumbers, boolean includesFullName, boolean includesPicture, boolean includesNumbers, boolean includesEmail, boolean includeAddress) {
<span class="nc bnc" id="L7435" title="All 2 branches missed.">        if(!checkForPermission(Manifest.permission.READ_CONTACTS, &quot;This is required to get the contacts&quot;)){</span>
<span class="nc" id="L7436">            return new Contact[]{};</span>
        }
<span class="nc" id="L7438">        return AndroidContactsManager.getInstance().getAllContacts(getContext(), withNumbers, includesFullName, includesPicture, includesNumbers, includesEmail, includeAddress);</span>
    }

    @Override
    public boolean isGetAllContactsFast() {
<span class="nc" id="L7443">        return true;</span>
    }

    public String createContact(String firstName, String surname, String officePhone, String homePhone, String cellPhone, String email) {
<span class="nc bnc" id="L7447" title="All 2 branches missed.">        if(!checkForPermission(Manifest.permission.WRITE_CONTACTS, &quot;This is required to create a contact&quot;)){</span>
<span class="nc" id="L7448">            return null;</span>
        }
<span class="nc" id="L7450">        return AndroidContactsManager.getInstance().createContact(getContext(), firstName, surname, officePhone, homePhone, cellPhone, email);</span>
    }

    public boolean deleteContact(String id) {
<span class="nc bnc" id="L7454" title="All 2 branches missed.">        if(!checkForPermission(Manifest.permission.WRITE_CONTACTS, &quot;This is required to delete a contact&quot;)){</span>
<span class="nc" id="L7455">            return false;</span>
        }
<span class="nc" id="L7457">        return AndroidContactsManager.getInstance().deleteContact(getContext(), id);</span>
    }

    @Override
    public boolean isNativeShareSupported() {
<span class="nc" id="L7462">        return true;</span>
    }

    @Override
    public void share(String text, String image, String mimeType, Rectangle sourceRect){
        /*if(!checkForPermission(Manifest.permission.READ_PHONE_STATE, &quot;This is required to perform share&quot;)){
            return;
        }*/
<span class="nc" id="L7470">        Intent shareIntent = new Intent(android.content.Intent.ACTION_SEND);</span>
<span class="nc bnc" id="L7471" title="All 2 branches missed.">        if(image == null){</span>
<span class="nc bnc" id="L7472" title="All 6 branches missed.">            if (text.startsWith(&quot;file:&quot;) &amp;&amp; mimeType != null &amp;&amp; new com.codename1.io.File(text).exists()) {</span>
<span class="nc" id="L7473">                shareIntent.setType(mimeType);</span>
<span class="nc" id="L7474">                shareIntent.putExtra(Intent.EXTRA_STREAM, Uri.parse(fixAttachmentPath(text)));</span>
            } else {
<span class="nc" id="L7476">                shareIntent.setType(&quot;text/plain&quot;);</span>
<span class="nc" id="L7477">                shareIntent.putExtra(android.content.Intent.EXTRA_TEXT, text);</span>
            }
        }else{
<span class="nc" id="L7480">            shareIntent.setType(mimeType);</span>
<span class="nc" id="L7481">            shareIntent.putExtra(Intent.EXTRA_STREAM, Uri.parse(fixAttachmentPath(image)));</span>
<span class="nc" id="L7482">            shareIntent.putExtra(Intent.EXTRA_TEXT, text);</span>
        }
<span class="nc" id="L7484">        getContext().startActivity(Intent.createChooser(shareIntent, &quot;Share with...&quot;));</span>
<span class="nc" id="L7485">    }</span>

    /**
     * @inheritDoc
     */
    public String getPlatformName() {
<span class="fc" id="L7491">        return &quot;and&quot;;</span>
    }

    /**
     * @inheritDoc
     */
    public String[] getPlatformOverrides() {
<span class="pc bpc" id="L7498" title="1 of 2 branches missed.">        if (isTablet()) {</span>
<span class="nc" id="L7499">            return new String[]{&quot;tablet&quot;, &quot;android&quot;, &quot;android-tab&quot;};</span>
        } else {
<span class="fc" id="L7501">            return new String[]{&quot;phone&quot;, &quot;android&quot;, &quot;android-phone&quot;};</span>
        }
    }

    /**
     * @inheritDoc
     */
    public void copyToClipboard(final Object obj) {
<span class="nc bnc" id="L7509" title="All 2 branches missed.">        if (getActivity() == null) {</span>
<span class="nc" id="L7510">            return;</span>
        }
<span class="nc" id="L7512">        getActivity().runOnUiThread(new Runnable() {</span>
            @Override
            public void run() {
<span class="nc" id="L7515">                int sdk = android.os.Build.VERSION.SDK_INT;</span>
<span class="nc bnc" id="L7516" title="All 2 branches missed.">                if (sdk &lt; 11) {</span>
<span class="nc" id="L7517">                    android.text.ClipboardManager clipboard = (android.text.ClipboardManager) getActivity().getSystemService(Context.CLIPBOARD_SERVICE);</span>
<span class="nc" id="L7518">                    clipboard.setText(obj.toString());</span>
<span class="nc" id="L7519">                } else {</span>
<span class="nc" id="L7520">                    android.content.ClipboardManager clipboard = (android.content.ClipboardManager) getActivity().getSystemService(Context.CLIPBOARD_SERVICE);</span>
<span class="nc" id="L7521">                    android.content.ClipData clip = ClipData.newPlainText(&quot;Codename One&quot;, obj.toString());</span>
<span class="nc" id="L7522">                    clipboard.setPrimaryClip(clip);</span>
                }
<span class="nc" id="L7524">            }</span>
        });
<span class="nc" id="L7526">    }</span>

    /**
     * @inheritDoc
     */
    public Object getPasteDataFromClipboard() {
<span class="nc bnc" id="L7532" title="All 2 branches missed.">        if (getContext() == null) {</span>
<span class="nc" id="L7533">            return null;</span>
        }
<span class="nc" id="L7535">        final Object[] response = new Object[1];</span>
<span class="nc" id="L7536">        runOnUiThreadAndBlock(new Runnable() {</span>
            @Override
            public void run() {
<span class="nc" id="L7539">                int sdk = android.os.Build.VERSION.SDK_INT;</span>
<span class="nc bnc" id="L7540" title="All 2 branches missed.">                if (sdk &lt; 11) {</span>
<span class="nc" id="L7541">                    android.text.ClipboardManager clipboard = (android.text.ClipboardManager) getActivity().getSystemService(Context.CLIPBOARD_SERVICE);</span>
<span class="nc" id="L7542">                    response[0] = clipboard.getText().toString();</span>
<span class="nc" id="L7543">                } else {</span>
<span class="nc" id="L7544">                    android.content.ClipboardManager clipboard = (android.content.ClipboardManager) getActivity().getSystemService(Context.CLIPBOARD_SERVICE);</span>
<span class="nc" id="L7545">                    ClipData.Item item = clipboard.getPrimaryClip().getItemAt(0);</span>
<span class="nc" id="L7546">                    response[0] = item.getText();</span>
                }
<span class="nc" id="L7548">            }</span>
        });
<span class="nc" id="L7550">        return response[0];</span>
    }

    public static MediaException createMediaException(int extra) {
        MediaErrorType type;
        String message;
<span class="nc bnc" id="L7556" title="All 8 branches missed.">        switch (extra) {</span>

            case MediaPlayer.MEDIA_ERROR_IO:
<span class="nc" id="L7559">                type = MediaErrorType.Network;</span>
<span class="nc" id="L7560">                message = &quot;IO error&quot;;</span>
<span class="nc" id="L7561">                break;</span>
            case MediaPlayer.MEDIA_ERROR_MALFORMED:
<span class="nc" id="L7563">                type = MediaErrorType.Decode;</span>
<span class="nc" id="L7564">                message = &quot;Media was malformed&quot;;</span>
<span class="nc" id="L7565">                break;</span>
            case MediaPlayer.MEDIA_ERROR_NOT_VALID_FOR_PROGRESSIVE_PLAYBACK:
<span class="nc" id="L7567">                type = MediaErrorType.SrcNotSupported;</span>
<span class="nc" id="L7568">                message = &quot;Not valie for progressive playback&quot;;</span>
<span class="nc" id="L7569">                break;</span>
            case MediaPlayer.MEDIA_ERROR_SERVER_DIED:
<span class="nc" id="L7571">                type = MediaErrorType.Network;</span>
<span class="nc" id="L7572">                message = &quot;Server died&quot;;</span>
<span class="nc" id="L7573">                break;</span>
            case MediaPlayer.MEDIA_ERROR_TIMED_OUT:
<span class="nc" id="L7575">                type = MediaErrorType.Network;</span>
<span class="nc" id="L7576">                message = &quot;Timed out&quot;;</span>
<span class="nc" id="L7577">                break;</span>

            case MediaPlayer.MEDIA_ERROR_UNKNOWN:
<span class="nc" id="L7580">                type = MediaErrorType.Network;</span>
<span class="nc" id="L7581">                message = &quot;Unknown error&quot;;</span>
<span class="nc" id="L7582">                break;</span>
            case MediaPlayer.MEDIA_ERROR_UNSUPPORTED:
<span class="nc" id="L7584">                type = MediaErrorType.SrcNotSupported;</span>
<span class="nc" id="L7585">                message = &quot;Unsupported media&quot;;</span>
<span class="nc" id="L7586">                break;</span>
            default:
<span class="nc" id="L7588">                type = MediaErrorType.Network;</span>
<span class="nc" id="L7589">                message = &quot;Unknown error&quot;;</span>
        }
<span class="nc" id="L7591">        return new MediaException(type, message);</span>
    }


    public class Video extends AndroidImplementation.AndroidPeer implements AsyncMedia {
        
        private VideoView nativeVideo;
        private Activity activity;
<span class="nc" id="L7599">        private boolean fullScreen = false;</span>
        private Rectangle bounds;
<span class="nc" id="L7601">        private boolean nativeController = true;</span>
        private boolean nativePlayer;
        private Form curentForm;
        private List&lt;Runnable&gt; completionHandlers;
<span class="nc" id="L7605">        private final EventDispatcher errorListeners = new EventDispatcher();</span>
        
<span class="nc" id="L7607">        private final EventDispatcher stateChangeListeners = new EventDispatcher();</span>
        private PlayRequest pendingPlayRequest;
        private PauseRequest pendingPauseRequest;

        @Override
        public State getState() {
<span class="nc bnc" id="L7613" title="All 2 branches missed.">            if (isPlaying()) {</span>
<span class="nc" id="L7614">                return State.Playing;</span>
            } else {
<span class="nc" id="L7616">                return State.Paused;</span>
            }
        }
        
        protected void fireMediaStateChange(State newState) {
<span class="nc bnc" id="L7621" title="All 4 branches missed.">            if (stateChangeListeners.hasListeners() &amp;&amp; newState != getState()) {</span>
<span class="nc" id="L7622">                stateChangeListeners.fireActionEvent(new MediaStateChangeEvent(this, getState(), newState));</span>
            }
<span class="nc" id="L7624">        }</span>
        
        @Override
        public void addMediaStateChangeListener(ActionListener&lt;MediaStateChangeEvent&gt; l) {
            
<span class="nc" id="L7629">            stateChangeListeners.addListener(l);</span>
<span class="nc" id="L7630">        }</span>
        
        @Override
        public void removeMediaStateChangeListener(ActionListener&lt;MediaStateChangeEvent&gt; l) {
            
<span class="nc" id="L7635">            stateChangeListeners.removeListener(l);</span>
<span class="nc" id="L7636">        }</span>
        
        @Override
        public void addMediaErrorListener(ActionListener&lt;MediaErrorEvent&gt; l) {
<span class="nc" id="L7640">            errorListeners.addListener(l);</span>
<span class="nc" id="L7641">        }</span>
        
        @Override
        public void removeMediaErrorListener(ActionListener&lt;MediaErrorEvent&gt; l) {
<span class="nc" id="L7645">            errorListeners.removeListener(l);</span>
<span class="nc" id="L7646">        }</span>
        
        @Override
        public PlayRequest playAsync() {
<span class="nc" id="L7650">            final PlayRequest out = new PlayRequest();</span>
<span class="nc" id="L7651">            out.ready(new SuccessCallback&lt;AsyncMedia&gt;() {</span>
                @Override
                public void onSucess(AsyncMedia value) {
<span class="nc bnc" id="L7654" title="All 2 branches missed.">                    if (out == pendingPlayRequest) {</span>
<span class="nc" id="L7655">                        pendingPlayRequest = null;</span>
                    }
<span class="nc" id="L7657">                }</span>
<span class="nc" id="L7658">            }).except(new SuccessCallback&lt;Throwable&gt;() {</span>
                @Override
                public void onSucess(Throwable value) {
<span class="nc bnc" id="L7661" title="All 2 branches missed.">                    if (out == pendingPlayRequest) {</span>
<span class="nc" id="L7662">                        pendingPlayRequest = null;</span>
                    }
<span class="nc" id="L7664">                }</span>
            });
            ;
<span class="nc bnc" id="L7667" title="All 2 branches missed.">            if (pendingPlayRequest != null) {</span>
<span class="nc" id="L7668">                pendingPlayRequest.ready(new SuccessCallback&lt;AsyncMedia&gt;() {</span>
                    @Override
                    public void onSucess(AsyncMedia value) {
<span class="nc bnc" id="L7671" title="All 2 branches missed.">                        if (!out.isDone()) {</span>
<span class="nc" id="L7672">                            out.complete(value);</span>
                        }
<span class="nc" id="L7674">                    }</span>
<span class="nc" id="L7675">                }).except(new SuccessCallback&lt;Throwable&gt;() {</span>
                    @Override
                    public void onSucess(Throwable value) {
<span class="nc bnc" id="L7678" title="All 2 branches missed.">                        if (!out.isDone()) {</span>
<span class="nc" id="L7679">                            out.error(value);</span>
                        }
<span class="nc" id="L7681">                    }</span>
                });
<span class="nc" id="L7683">                return out;</span>
            } else {
<span class="nc" id="L7685">                pendingPlayRequest = out;</span>
            }
            
<span class="nc" id="L7688">            ActionListener&lt;MediaStateChangeEvent&gt; onStateChange = new ActionListener&lt;MediaStateChangeEvent&gt;() {</span>
                @Override
                public void actionPerformed(MediaStateChangeEvent evt) {
<span class="nc" id="L7691">                    stateChangeListeners.removeListener(this);</span>
<span class="nc bnc" id="L7692" title="All 2 branches missed.">                    if (!out.isDone()) {</span>
<span class="nc bnc" id="L7693" title="All 2 branches missed.">                        if (evt.getNewState() == State.Playing) {</span>
<span class="nc" id="L7694">                            out.complete(Video.this);</span>
                        }
                    }
                    
<span class="nc" id="L7698">                }</span>
                
            };
            
<span class="nc" id="L7702">            stateChangeListeners.addListener(onStateChange);</span>
<span class="nc" id="L7703">            play();</span>
            
<span class="nc" id="L7705">            return out;</span>
            
        }
        
        @Override
        public PauseRequest pauseAsync() {
<span class="nc" id="L7711">            final PauseRequest out = new PauseRequest();</span>
<span class="nc" id="L7712">            out.ready(new SuccessCallback&lt;AsyncMedia&gt;() {</span>
                @Override
                public void onSucess(AsyncMedia value) {
<span class="nc bnc" id="L7715" title="All 2 branches missed.">                    if (out == pendingPauseRequest) {</span>
<span class="nc" id="L7716">                        pendingPauseRequest = null;</span>
                    }
<span class="nc" id="L7718">                }</span>
<span class="nc" id="L7719">            }).except(new SuccessCallback&lt;Throwable&gt;() {</span>
                @Override
                public void onSucess(Throwable value) {
<span class="nc bnc" id="L7722" title="All 2 branches missed.">                    if (out == pendingPauseRequest) {</span>
<span class="nc" id="L7723">                        pendingPauseRequest = null;</span>
                    }
<span class="nc" id="L7725">                }</span>
            });
            ;
<span class="nc bnc" id="L7728" title="All 2 branches missed.">            if (pendingPauseRequest != null) {</span>
<span class="nc" id="L7729">                pendingPauseRequest.ready(new SuccessCallback&lt;AsyncMedia&gt;() {</span>
                    @Override
                    public void onSucess(AsyncMedia value) {
<span class="nc bnc" id="L7732" title="All 2 branches missed.">                        if (!out.isDone()) {</span>
<span class="nc" id="L7733">                            out.complete(value);</span>
                        }
<span class="nc" id="L7735">                    }</span>
<span class="nc" id="L7736">                }).except(new SuccessCallback&lt;Throwable&gt;() {</span>
                    @Override
                    public void onSucess(Throwable value) {
<span class="nc bnc" id="L7739" title="All 2 branches missed.">                        if (!out.isDone()) {</span>
<span class="nc" id="L7740">                            out.error(value);</span>
                        }
<span class="nc" id="L7742">                    }</span>
                });
<span class="nc" id="L7744">                return out;</span>
            } else {
<span class="nc" id="L7746">                pendingPauseRequest = out;</span>
            }
            
<span class="nc" id="L7749">            ActionListener&lt;MediaStateChangeEvent&gt; onStateChange = new ActionListener&lt;MediaStateChangeEvent&gt;() {</span>
                @Override
                public void actionPerformed(MediaStateChangeEvent evt) {
<span class="nc" id="L7752">                    stateChangeListeners.removeListener(this);</span>
<span class="nc bnc" id="L7753" title="All 2 branches missed.">                    if (!out.isDone()) {</span>
<span class="nc bnc" id="L7754" title="All 2 branches missed.">                        if (evt.getNewState() == State.Paused) {</span>
<span class="nc" id="L7755">                            out.complete(Video.this);</span>
                        }
                    }
                    
<span class="nc" id="L7759">                }</span>
                
            };
            
<span class="nc" id="L7763">            stateChangeListeners.addListener(onStateChange);</span>
<span class="nc" id="L7764">            play();</span>
            
<span class="nc" id="L7766">            return out;</span>
        }
        

<span class="nc" id="L7770">        public Video(final VideoView nativeVideo, final Activity activity, final Runnable onCompletion) {</span>
<span class="nc" id="L7771">            super(new RelativeLayout(activity));</span>
<span class="nc" id="L7772">            this.nativeVideo = nativeVideo;</span>
<span class="nc" id="L7773">            RelativeLayout rl = (RelativeLayout)getNativePeer();</span>

<span class="nc" id="L7775">            rl.addView(nativeVideo);</span>
<span class="nc" id="L7776">            RelativeLayout.LayoutParams layout = new RelativeLayout.LayoutParams(getWidth(), getHeight());</span>
<span class="nc" id="L7777">            layout.addRule(RelativeLayout.CENTER_HORIZONTAL);</span>
<span class="nc" id="L7778">            layout.addRule(RelativeLayout.CENTER_VERTICAL);</span>
<span class="nc" id="L7779">            rl.setLayoutParams(layout);</span>
<span class="nc" id="L7780">            rl.requestLayout();</span>

<span class="nc" id="L7782">            this.activity = activity;</span>
<span class="nc bnc" id="L7783" title="All 2 branches missed.">            if (nativeController) {</span>
<span class="nc" id="L7784">                MediaController mc = new AndroidImplementation.CN1MediaController();</span>
<span class="nc" id="L7785">                nativeVideo.setMediaController(mc);</span>
            }

<span class="nc" id="L7788">            nativeVideo.setOnCompletionListener(new MediaPlayer.OnCompletionListener() {</span>
                @Override
                public void onCompletion(MediaPlayer arg0) {
<span class="nc" id="L7791">                    fireMediaStateChange(State.Paused);</span>
                    
<span class="nc" id="L7793">                    fireCompletionHandlers();</span>
<span class="nc" id="L7794">                }</span>
            });
<span class="nc bnc" id="L7796" title="All 2 branches missed.">            if (onCompletion != null) {</span>
<span class="nc" id="L7797">                addCompletionHandler(onCompletion);</span>
            }

<span class="nc" id="L7800">            nativeVideo.setOnErrorListener(new MediaPlayer.OnErrorListener() {</span>
                @Override
                public boolean onError(MediaPlayer mp, int what, int extra) {
<span class="nc" id="L7803">                    com.codename1.io.Log.p(&quot;Media player error: &quot; + mp + &quot; what: &quot; + what + &quot; extra: &quot; + extra);</span>
<span class="nc" id="L7804">                    errorListeners.fireActionEvent(new MediaErrorEvent(Video.this, createMediaException(extra)));</span>
<span class="nc" id="L7805">                    fireMediaStateChange(State.Paused);</span>
<span class="nc" id="L7806">                    fireCompletionHandlers();</span>
<span class="nc" id="L7807">                    return true;</span>
                }
            });

<span class="nc" id="L7811">        }</span>
        
        
        
        private void fireCompletionHandlers() {
<span class="nc bnc" id="L7816" title="All 4 branches missed.">            if (completionHandlers != null &amp;&amp; !completionHandlers.isEmpty()) {</span>
<span class="nc" id="L7817">                Display.getInstance().callSerially(new Runnable() {</span>
                    public void run() {
<span class="nc bnc" id="L7819" title="All 4 branches missed.">                        if (completionHandlers != null &amp;&amp; !completionHandlers.isEmpty()) {</span>
                            ArrayList&lt;Runnable&gt; toRun;
<span class="nc" id="L7821">                            synchronized(Video.this) {</span>
<span class="nc" id="L7822">                                toRun = new ArrayList&lt;Runnable&gt;(completionHandlers);</span>
<span class="nc" id="L7823">                            }</span>
<span class="nc bnc" id="L7824" title="All 2 branches missed.">                            for (Runnable r : toRun) {</span>
<span class="nc" id="L7825">                                r.run();</span>
<span class="nc" id="L7826">                            }</span>
                        }
<span class="nc" id="L7828">                    }</span>
                });
            }
<span class="nc" id="L7831">        }</span>
        private void setNativeController(final boolean nativeController) {
<span class="nc bnc" id="L7833" title="All 2 branches missed.">            if (nativeController != this.nativeController) {</span>
<span class="nc" id="L7834">                this.nativeController = nativeController;</span>
<span class="nc bnc" id="L7835" title="All 2 branches missed.">                if (nativeVideo != null) {</span>
<span class="nc" id="L7836">                    Activity activity = getActivity();</span>
<span class="nc bnc" id="L7837" title="All 2 branches missed.">                    if (activity != null) {</span>
<span class="nc" id="L7838">                        activity.runOnUiThread(new Runnable() {</span>

                            @Override
                            public void run() {
<span class="nc bnc" id="L7842" title="All 2 branches missed.">                                if (nativeVideo != null) {</span>
<span class="nc" id="L7843">                                    MediaController mc = new AndroidImplementation.CN1MediaController();</span>
<span class="nc" id="L7844">                                    nativeVideo.setMediaController(mc);</span>
<span class="nc bnc" id="L7845" title="All 2 branches missed.">                                    if (!nativeController) mc.setVisibility(View.GONE);</span>
<span class="nc" id="L7846">                                    else mc.setVisibility(View.VISIBLE);</span>

                                }
<span class="nc" id="L7849">                            }</span>

                        });
                    }

                }
            }
<span class="nc" id="L7856">        }</span>

        @Override
        public void init() {
<span class="nc" id="L7860">            super.init();</span>
<span class="nc" id="L7861">            setVisible(true);</span>
<span class="nc" id="L7862">        }</span>

        public void prepare() {
<span class="nc" id="L7865">        }</span>

        @Override
        public void play() {
<span class="nc" id="L7869">            Component cmp = getVideoComponent();</span>
<span class="nc bnc" id="L7870" title="All 6 branches missed.">            if (cmp.getParent() == null &amp;&amp; nativePlayer &amp;&amp; curentForm == null) {</span>
<span class="nc" id="L7871">                curentForm = Display.getInstance().getCurrent();</span>
<span class="nc" id="L7872">                Form f = new Form();</span>
<span class="nc" id="L7873">                f.setBackCommand(new Command(&quot;&quot;) {</span>
                    @Override
                    public void actionPerformed(ActionEvent evt) {
<span class="nc" id="L7876">                        Component cmp = getVideoComponent();</span>
<span class="nc bnc" id="L7877" title="All 2 branches missed.">                        if(cmp != null) {</span>
<span class="nc" id="L7878">                            cmp.remove();</span>
<span class="nc" id="L7879">                            pause();</span>
                        }
<span class="nc" id="L7881">                        curentForm.showBack();</span>
<span class="nc" id="L7882">                        curentForm = null;</span>
<span class="nc" id="L7883">                    }</span>
                });
<span class="nc" id="L7885">                f.setLayout(new BorderLayout());</span>

<span class="nc bnc" id="L7887" title="All 2 branches missed.">                if(cmp.getParent() != null) {</span>
<span class="nc" id="L7888">                    cmp.getParent().removeComponent(cmp);</span>
                }
<span class="nc" id="L7890">                f.addComponent(BorderLayout.CENTER, cmp);</span>
<span class="nc" id="L7891">                f.show();</span>
            }
<span class="nc" id="L7893">            nativeVideo.start();</span>
<span class="nc" id="L7894">            fireMediaStateChange(State.Playing);</span>
<span class="nc" id="L7895">        }</span>

        @Override
        public void pause() {
<span class="nc bnc" id="L7899" title="All 4 branches missed.">            if(nativeVideo != null &amp;&amp; nativeVideo.canPause()){</span>
<span class="nc" id="L7900">                nativeVideo.pause();</span>
<span class="nc" id="L7901">                fireMediaStateChange(State.Paused);</span>
            }
<span class="nc" id="L7903">        }</span>

        @Override
        public void cleanup() {
<span class="nc bnc" id="L7907" title="All 2 branches missed.">            if(nativeVideo != null) {</span>
<span class="nc" id="L7908">                nativeVideo.stopPlayback();</span>
<span class="nc" id="L7909">                fireMediaStateChange(State.Paused);</span>
            }
<span class="nc" id="L7911">            nativeVideo = null;</span>
<span class="nc bnc" id="L7912" title="All 4 branches missed.">            if (nativePlayer &amp;&amp; curentForm != null) {</span>
<span class="nc" id="L7913">                curentForm.showBack();</span>
<span class="nc" id="L7914">                curentForm = null;</span>
            }
<span class="nc" id="L7916">        }</span>

        @Override
        public int getTime() {
<span class="nc bnc" id="L7920" title="All 2 branches missed.">            if(nativeVideo != null){</span>
<span class="nc" id="L7921">                return nativeVideo.getCurrentPosition();</span>
            }
<span class="nc" id="L7923">            return -1;</span>
        }

        @Override
        public void setTime(int time) {
<span class="nc bnc" id="L7928" title="All 2 branches missed.">            if(nativeVideo != null){</span>
<span class="nc" id="L7929">                nativeVideo.seekTo(time);</span>
            }
<span class="nc" id="L7931">        }</span>

        @Override
        public int getDuration() {
<span class="nc bnc" id="L7935" title="All 2 branches missed.">            if(nativeVideo != null){</span>
<span class="nc" id="L7936">                return nativeVideo.getDuration();</span>
            }
<span class="nc" id="L7938">            return -1;</span>
        }

        @Override
        public void setVolume(int vol) {
            // float v = ((float) vol) / 100.0F;
<span class="nc" id="L7944">            AudioManager am = (AudioManager) activity.getSystemService(Context.AUDIO_SERVICE);</span>
<span class="nc" id="L7945">            int max = am.getStreamMaxVolume(AudioManager.STREAM_MUSIC);</span>
<span class="nc" id="L7946">            am.setStreamVolume(AudioManager.STREAM_MUSIC, vol, 0);</span>
<span class="nc" id="L7947">        }</span>

        @Override
        public int getVolume() {
<span class="nc" id="L7951">            AudioManager am = (AudioManager) activity.getSystemService(Context.AUDIO_SERVICE);</span>
<span class="nc" id="L7952">            return am.getStreamVolume(AudioManager.STREAM_MUSIC);</span>
        }

        @Override
        public boolean isVideo() {
<span class="nc" id="L7957">            return true;</span>
        }

        @Override
        public boolean isFullScreen() {
<span class="nc bnc" id="L7962" title="All 4 branches missed.">            return fullScreen || nativePlayer;</span>
        }

        @Override
        public void setFullScreen(boolean fullScreen) {
<span class="nc" id="L7967">            this.fullScreen = fullScreen;</span>
<span class="nc bnc" id="L7968" title="All 2 branches missed.">            if (fullScreen) {</span>
<span class="nc" id="L7969">                bounds = new Rectangle(getBounds());</span>
<span class="nc" id="L7970">                setX(0);</span>
<span class="nc" id="L7971">                setY(0);</span>
<span class="nc" id="L7972">                setWidth(Display.getInstance().getDisplayWidth());</span>
<span class="nc" id="L7973">                setHeight(Display.getInstance().getDisplayHeight());</span>
            } else {
<span class="nc bnc" id="L7975" title="All 2 branches missed.">                if (bounds != null) {</span>
<span class="nc" id="L7976">                    setX(bounds.getX());</span>
<span class="nc" id="L7977">                    setY(bounds.getY());</span>
<span class="nc" id="L7978">                    setWidth(bounds.getSize().getWidth());</span>
<span class="nc" id="L7979">                    setHeight(bounds.getSize().getHeight());</span>
                }
            }
<span class="nc" id="L7982">            repaint();</span>
<span class="nc" id="L7983">        }</span>

        @Override
        public Component getVideoComponent() {
<span class="nc" id="L7987">            return this;</span>
        }

        @Override
        protected Dimension calcPreferredSize() {
<span class="nc bnc" id="L7992" title="All 2 branches missed.">            if(nativeVideo != null){</span>
<span class="nc" id="L7993">                return new Dimension(nativeVideo.getWidth(), nativeVideo.getHeight());</span>
            }
<span class="nc" id="L7995">            return new Dimension();</span>
        }

        @Override
        public void setWidth(final int width) {
<span class="nc" id="L8000">            super.setWidth(width);</span>
<span class="nc" id="L8001">            final int currH = getHeight();</span>
<span class="nc bnc" id="L8002" title="All 2 branches missed.">            if(nativeVideo != null){</span>
<span class="nc" id="L8003">                activity.runOnUiThread(new Runnable() {</span>

                    public void run() {
<span class="nc" id="L8006">                        float nh = nativeVideo.getHeight();</span>
<span class="nc" id="L8007">                        float nw = nativeVideo.getWidth();</span>
<span class="nc" id="L8008">                        float w = width;</span>
<span class="nc" id="L8009">                        float h = currH;</span>
<span class="nc bnc" id="L8010" title="All 4 branches missed.">                        if (nh != 0 &amp;&amp; nw != 0) {</span>
<span class="nc" id="L8011">                            h = width * nh / nw;</span>
<span class="nc bnc" id="L8012" title="All 2 branches missed.">                            if (h &gt; getHeight()) {</span>
<span class="nc" id="L8013">                                h = getHeight();</span>
<span class="nc" id="L8014">                                w = h * nw / nh;</span>
                            }
<span class="nc bnc" id="L8016" title="All 2 branches missed.">                            if (w &gt; getWidth()) {</span>
<span class="nc" id="L8017">                                w = getWidth();</span>
<span class="nc" id="L8018">                                h = w * nh / nw;</span>
                            }
                        }
<span class="nc" id="L8021">                        RelativeLayout.LayoutParams layout = new RelativeLayout.LayoutParams((int)w, (int)h);</span>
<span class="nc" id="L8022">                        layout.addRule(RelativeLayout.CENTER_HORIZONTAL);</span>
<span class="nc" id="L8023">                        layout.addRule(RelativeLayout.CENTER_VERTICAL);</span>
<span class="nc" id="L8024">                        nativeVideo.setLayoutParams(layout);</span>
<span class="nc" id="L8025">                        nativeVideo.requestLayout();</span>
<span class="nc" id="L8026">                        nativeVideo.getHolder().setSizeFromLayout();</span>
<span class="nc" id="L8027">                    }</span>
                });
            }
<span class="nc" id="L8030">        }</span>

        @Override
        public void setHeight(final int height) {
<span class="nc" id="L8034">            super.setHeight(height);</span>
<span class="nc" id="L8035">            final int currW = getWidth();</span>
<span class="nc bnc" id="L8036" title="All 2 branches missed.">            if(nativeVideo != null){</span>
<span class="nc" id="L8037">                activity.runOnUiThread(new Runnable() {</span>

                    public void run() {
<span class="nc" id="L8040">                        float nh = nativeVideo.getHeight();</span>
<span class="nc" id="L8041">                        float nw = nativeVideo.getWidth();</span>
<span class="nc" id="L8042">                        float h = height;</span>
<span class="nc" id="L8043">                        float w = currW;</span>
<span class="nc bnc" id="L8044" title="All 4 branches missed.">                        if (nh != 0 &amp;&amp; nw != 0) {</span>
<span class="nc" id="L8045">                            w = h * nw / nh;</span>
<span class="nc bnc" id="L8046" title="All 2 branches missed.">                            if (h &gt; getHeight()) {</span>
<span class="nc" id="L8047">                                h = getHeight();</span>
<span class="nc" id="L8048">                                w = h * nw / nh;</span>
                            }
<span class="nc bnc" id="L8050" title="All 2 branches missed.">                            if (w &gt; getWidth()) {</span>
<span class="nc" id="L8051">                                w = getWidth();</span>
<span class="nc" id="L8052">                                h = w * nh / nw;</span>
                            }
                        }
<span class="nc" id="L8055">                        RelativeLayout.LayoutParams layout = new RelativeLayout.LayoutParams((int)w, (int)h);</span>
<span class="nc" id="L8056">                        layout.addRule(RelativeLayout.CENTER_HORIZONTAL);</span>
<span class="nc" id="L8057">                        layout.addRule(RelativeLayout.CENTER_VERTICAL);</span>
<span class="nc" id="L8058">                        nativeVideo.setLayoutParams(layout);</span>
<span class="nc" id="L8059">                        nativeVideo.requestLayout();</span>
<span class="nc" id="L8060">                        nativeVideo.getHolder().setSizeFromLayout();</span>
<span class="nc" id="L8061">                    }</span>
                });
            }
<span class="nc" id="L8064">        }</span>

        @Override
        public void setNativePlayerMode(boolean nativePlayer) {
<span class="nc" id="L8068">            this.nativePlayer = nativePlayer;</span>
<span class="nc" id="L8069">        }</span>

        @Override
        public boolean isNativePlayerMode() {
<span class="nc" id="L8073">            return nativePlayer;</span>
        }

        @Override
        public boolean isPlaying() {
<span class="nc bnc" id="L8078" title="All 2 branches missed.">            if(nativeVideo != null){</span>
<span class="nc" id="L8079">                return nativeVideo.isPlaying();</span>
            }
<span class="nc" id="L8081">            return false;</span>
        }

        public void setVariable(String key, Object value) {
<span class="nc bnc" id="L8085" title="All 6 branches missed.">            if (nativeVideo != null &amp;&amp; Media.VARIABLE_NATIVE_CONTRLOLS_EMBEDDED.equals(key) &amp;&amp; value instanceof Boolean) {</span>
<span class="nc" id="L8086">                setNativeController((Boolean)value);</span>
            }
<span class="nc" id="L8088">        }</span>

        public Object getVariable(String key) {
<span class="nc" id="L8091">            return null;</span>
        }

        @Override
        public void addMediaCompletionHandler(Runnable onComplete) {
<span class="nc" id="L8096">            addCompletionHandler(onComplete);</span>
<span class="nc" id="L8097">        }</span>

        
        
        private void addCompletionHandler(Runnable onCompletion) {
<span class="nc" id="L8102">            synchronized(this) {</span>
<span class="nc bnc" id="L8103" title="All 2 branches missed.">                if (completionHandlers == null) {</span>
<span class="nc" id="L8104">                    completionHandlers = new ArrayList&lt;Runnable&gt;();</span>
                }
<span class="nc" id="L8106">                completionHandlers.add(onCompletion);</span>
<span class="nc" id="L8107">            }</span>
<span class="nc" id="L8108">        }</span>
        
        private void removeCompletionHandler(Runnable onCompletion) {
<span class="nc" id="L8111">            synchronized(this) {</span>
<span class="nc bnc" id="L8112" title="All 2 branches missed.">                if (completionHandlers != null) {</span>
<span class="nc" id="L8113">                    completionHandlers.remove(onCompletion);</span>
                }
<span class="nc" id="L8115">            }</span>
<span class="nc" id="L8116">        }</span>

      
    }


    private String getImageFilePath(Uri uri) {
<span class="nc" id="L8123">        String scheme = uri.getScheme();</span>
<span class="nc" id="L8124">        String[] filePathColumn = {MediaStore.Images.Media.DATA};</span>
<span class="nc" id="L8125">        Cursor cursor = getContext().getContentResolver().query(</span>
                android.provider.MediaStore.Images.Media.EXTERNAL_CONTENT_URI,
                new String[]{ MediaStore.Images.Media.DATA},
                null,
                null,
                null
        );
        // Some gallery providers may return an empty cursor on modern Android builds.
<span class="nc" id="L8133">        String filePath = null;</span>
<span class="nc bnc" id="L8134" title="All 2 branches missed.">        if (cursor != null) {</span>
            try {
<span class="nc" id="L8136">                int columnIndex = cursor.getColumnIndex(filePathColumn[0]);</span>
<span class="nc bnc" id="L8137" title="All 4 branches missed.">                if (columnIndex &gt;= 0 &amp;&amp; cursor.moveToFirst()) {</span>
<span class="nc" id="L8138">                    filePath = cursor.getString(columnIndex);</span>
                }
            } finally {
<span class="nc" id="L8141">                cursor.close();</span>
            }
        }

<span class="nc bnc" id="L8145" title="All 4 branches missed.">        if (filePath == null || &quot;content&quot;.equals(scheme)) {</span>
            //if the file is not on the filesystem download it and save it
            //locally
<span class="nc" id="L8148">            InputStream inputStream = null;</span>
<span class="nc" id="L8149">            OutputStream tmp = null;</span>
            try {
<span class="nc" id="L8151">                inputStream = getContext().getContentResolver().openInputStream(uri);</span>
<span class="nc bnc" id="L8152" title="All 2 branches missed.">                if (inputStream != null) {</span>
<span class="nc" id="L8153">                    String name = new File(uri.toString()).getName();//getContentName(getContext().getContentResolver(), uri);</span>
<span class="nc bnc" id="L8154" title="All 2 branches missed.">                    if (name != null) {</span>
<span class="nc" id="L8155">                        String homePath = getAppHomePath();</span>
<span class="nc bnc" id="L8156" title="All 2 branches missed.">                        if (homePath.endsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L8157">                            homePath = homePath.substring(0, homePath.length()-1);</span>
                        }
<span class="nc" id="L8159">                        filePath = homePath</span>
<span class="nc" id="L8160">                                + getFileSystemSeparator() + name;</span>
<span class="nc" id="L8161">                        File f = new File(removeFilePrefix(filePath));</span>
<span class="nc" id="L8162">                        tmp = createFileOuputStream(f);</span>
<span class="nc" id="L8163">                        Util.copy(inputStream, tmp);</span>
                    }
                }
<span class="nc" id="L8166">            } catch (Exception e) {</span>
<span class="nc" id="L8167">                com.codename1.io.Log.e(e);</span>
            } finally {
<span class="nc" id="L8169">                Util.cleanup(tmp);</span>
<span class="nc" id="L8170">                Util.cleanup(inputStream);</span>
            }
        }
<span class="nc" id="L8173">        return filePath;</span>
    }

    @Override
    public void onActivityResult(int requestCode, int resultCode, Intent intent) {

<span class="nc bnc" id="L8179" title="All 2 branches missed.">        if (requestCode == ZOOZ_PAYMENT) {</span>
<span class="nc" id="L8180">            ((IntentResultListener) pur).onActivityResult(requestCode, resultCode, intent);</span>
<span class="nc" id="L8181">            return;</span>
        }

<span class="nc" id="L8184">        takePersistablePermissionsFromIntent(intent);</span>

<span class="nc bnc" id="L8186" title="All 4 branches missed.">        if (requestCode == REQUEST_SELECT_FILE || requestCode == FILECHOOSER_RESULTCODE) {</span>
<span class="nc bnc" id="L8187" title="All 2 branches missed.">            if(Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {</span>
<span class="nc bnc" id="L8188" title="All 2 branches missed.">                if (requestCode == REQUEST_SELECT_FILE) {</span>
<span class="nc bnc" id="L8189" title="All 2 branches missed.">                    if (uploadMessage == null) return;</span>
<span class="nc" id="L8190">                    Uri[] results = null;</span>

                    // Check that the response is a good one
<span class="nc bnc" id="L8193" title="All 2 branches missed.">                    if (resultCode == Activity.RESULT_OK) {</span>
<span class="nc bnc" id="L8194" title="All 2 branches missed.">                        if (intent != null) {</span>
                            // If there is not data, then we may have taken a photo
<span class="nc" id="L8196">                            String dataString = intent.getDataString();</span>
<span class="nc" id="L8197">                            ClipData clipData = intent.getClipData();</span>

<span class="nc bnc" id="L8199" title="All 2 branches missed.">                            if (clipData != null) {</span>
<span class="nc" id="L8200">                                results = new Uri[clipData.getItemCount()];</span>
<span class="nc bnc" id="L8201" title="All 2 branches missed.">                                for (int i = 0; i &lt; clipData.getItemCount(); i++) {</span>
<span class="nc" id="L8202">                                    ClipData.Item item = clipData.getItemAt(i);</span>
<span class="nc" id="L8203">                                    results[i] = item.getUri();</span>
                                }
<span class="nc bnc" id="L8205" title="All 2 branches missed.">                            } else if (dataString != null) {</span>
<span class="nc" id="L8206">                                results = new Uri[]{Uri.parse(dataString)};</span>
                            }
                        }
                    }

<span class="nc" id="L8211">                    uploadMessage.onReceiveValue(results);</span>
<span class="nc" id="L8212">                    uploadMessage = null;</span>
<span class="nc" id="L8213">                }</span>
            }
<span class="nc bnc" id="L8215" title="All 2 branches missed.">            else if (requestCode == FILECHOOSER_RESULTCODE) {</span>
<span class="nc bnc" id="L8216" title="All 2 branches missed.">                if (null == mUploadMessage) {</span>
<span class="nc" id="L8217">                    return;</span>
                }
            // Use MainActivity.RESULT_OK if you're implementing WebView inside Fragment
            // Use RESULT_OK only if you're implementing WebView inside an Activity
<span class="nc bnc" id="L8221" title="All 4 branches missed.">                Uri result = intent == null || resultCode != Activity.RESULT_OK ? null : intent.getData();</span>
<span class="nc" id="L8222">                mUploadMessage.onReceiveValue(result);</span>
<span class="nc" id="L8223">                mUploadMessage = null;</span>
<span class="nc" id="L8224">            }</span>
            else {

<span class="nc" id="L8227">                Toast.makeText(getActivity().getApplicationContext(), &quot;Failed to Upload File&quot;, Toast.LENGTH_LONG).show();</span>
            }
<span class="nc" id="L8229">            return;</span>
        }

        
<span class="nc bnc" id="L8233" title="All 2 branches missed.">        if (resultCode == Activity.RESULT_OK) {</span>
<span class="nc bnc" id="L8234" title="All 2 branches missed.">            if (requestCode == CAPTURE_IMAGE) {</span>
                try {
<span class="nc" id="L8236">                    String imageUri = (String) Storage.getInstance().readObject(&quot;imageUri&quot;);</span>
<span class="nc" id="L8237">                    Vector pathandId = StringUtil.tokenizeString(imageUri, &quot;;&quot;);</span>
<span class="nc" id="L8238">                    String path = (String)pathandId.get(0);</span>
<span class="nc" id="L8239">                    String lastId = (String)pathandId.get(1);</span>
<span class="nc" id="L8240">                    Storage.getInstance().deleteStorageFile(&quot;imageUri&quot;);</span>
<span class="nc" id="L8241">                    clearMediaDB(lastId, path);</span>
<span class="nc" id="L8242">                    callback.fireActionEvent(new ActionEvent(addFile(path)));</span>
<span class="nc" id="L8243">                    return;</span>
<span class="nc" id="L8244">                } catch (Exception e) {</span>
<span class="nc" id="L8245">                    e.printStackTrace();</span>
<span class="nc" id="L8246">                }</span>
<span class="nc bnc" id="L8247" title="All 2 branches missed.">            } else if (requestCode == CAPTURE_VIDEO) {</span>
<span class="nc" id="L8248">                String path = (String) Storage.getInstance().readObject(&quot;videoUri&quot;);</span>
<span class="nc" id="L8249">                Storage.getInstance().deleteStorageFile(&quot;videoUri&quot;);</span>
<span class="nc" id="L8250">                callback.fireActionEvent(new ActionEvent(addFile(path)));</span>
<span class="nc" id="L8251">                return;</span>
<span class="nc bnc" id="L8252" title="All 2 branches missed.">            } else if (requestCode == CAPTURE_AUDIO) {</span>
<span class="nc" id="L8253">                Uri data = intent.getData();</span>
<span class="nc" id="L8254">                String path = convertImageUriToFilePath(data, getContext());</span>
<span class="nc" id="L8255">                callback.fireActionEvent(new ActionEvent(addFile(path)));</span>
<span class="nc" id="L8256">                return;</span>
                
<span class="nc bnc" id="L8258" title="All 2 branches missed.">            } else if (requestCode == OPEN_GALLERY_MULTI) {</span>
<span class="nc bnc" id="L8259" title="All 2 branches missed.">                if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN) {</span>
<span class="nc bnc" id="L8260" title="All 2 branches missed.">                    if(intent.getClipData() != null){</span>
                        // If it was a multi-request
<span class="nc" id="L8262">                        ArrayList&lt;String&gt; selectedPaths = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L8263">                        int count = intent.getClipData().getItemCount();</span>
<span class="nc bnc" id="L8264" title="All 2 branches missed.">                        for (int i=0; i&lt;count; i++){</span>

<span class="nc" id="L8266">                            Uri uri = intent.getClipData().getItemAt(i).getUri();</span>
<span class="nc" id="L8267">                            String p = getImageFilePath(uri);</span>
<span class="nc bnc" id="L8268" title="All 2 branches missed.">                            if (p != null) {</span>
<span class="nc" id="L8269">                                selectedPaths.add(p);</span>
                            }
                        }
<span class="nc" id="L8272">                        callback.fireActionEvent(new ActionEvent(selectedPaths.toArray(new String[selectedPaths.size()])));</span>
<span class="nc" id="L8273">                        return;</span>
                    }
                } else {
<span class="nc" id="L8276">                    com.codename1.io.Log.e(new RuntimeException(&quot;OPEN_GALLERY_MULTI requires android sdk 16 (jelly bean) or higher&quot;));</span>
<span class="nc" id="L8277">                    callback.fireActionEvent(null);</span>
                }

<span class="nc" id="L8280">                Uri selectedImage = intent.getData();</span>
<span class="nc" id="L8281">                String scheme = intent.getScheme();</span>

<span class="nc" id="L8283">                String[] filePathColumn = {MediaStore.Images.Media.DATA};</span>
<span class="nc" id="L8284">                Cursor cursor = getContext().getContentResolver().query(selectedImage, filePathColumn, null, null, null);</span>

                // Some gallery providers may return an empty cursor on modern Android builds.
<span class="nc" id="L8287">                String filePath = null;</span>
<span class="nc bnc" id="L8288" title="All 2 branches missed.">                if (cursor != null) {</span>
                    try {
<span class="nc" id="L8290">                        int columnIndex = cursor.getColumnIndex(filePathColumn[0]);</span>
<span class="nc bnc" id="L8291" title="All 4 branches missed.">                        if (columnIndex &gt;= 0 &amp;&amp; cursor.moveToFirst()) {</span>
<span class="nc" id="L8292">                            filePath = cursor.getString(columnIndex);</span>
                        }
                    } finally {
<span class="nc" id="L8295">                        cursor.close();</span>
                    }
                }
<span class="nc" id="L8298">                boolean fileExists = false;</span>
<span class="nc bnc" id="L8299" title="All 2 branches missed.">                if (filePath != null) {</span>
<span class="nc" id="L8300">                    File file = new File(filePath);</span>
<span class="nc bnc" id="L8301" title="All 4 branches missed.">                    fileExists = file.exists() &amp;&amp; file.canRead();</span>
                }

<span class="nc bnc" id="L8304" title="All 4 branches missed.">                if (!fileExists &amp;&amp; &quot;content&quot;.equals(scheme)) {</span>
                    //if the file is not on the filesystem download it and save it
                    //locally
                    try {
<span class="nc" id="L8308">                        InputStream inputStream = getContext().getContentResolver().openInputStream(selectedImage);</span>
<span class="nc bnc" id="L8309" title="All 2 branches missed.">                        if (inputStream != null) {</span>
<span class="nc" id="L8310">                            String name = getContentName(getContext().getContentResolver(), selectedImage);</span>
<span class="nc bnc" id="L8311" title="All 2 branches missed.">                            if (name != null) {</span>
<span class="nc" id="L8312">                                filePath = getAppHomePath()</span>
<span class="nc" id="L8313">                                        + getFileSystemSeparator() + name;</span>
<span class="nc" id="L8314">                                File f = new File(removeFilePrefix(filePath));</span>
<span class="nc" id="L8315">                                OutputStream tmp = createFileOuputStream(f);</span>
<span class="nc" id="L8316">                                byte[] buffer = new byte[1024];</span>
<span class="nc" id="L8317">                                int read = -1;</span>
<span class="nc bnc" id="L8318" title="All 2 branches missed.">                                while ((read = inputStream.read(buffer)) &gt; -1) {</span>
<span class="nc" id="L8319">                                    tmp.write(buffer, 0, read);</span>
                                }
<span class="nc" id="L8321">                                tmp.close();</span>
<span class="nc" id="L8322">                                inputStream.close();</span>
                            }
                        }
<span class="nc" id="L8325">                    } catch (Exception e) {</span>
<span class="nc" id="L8326">                        e.printStackTrace();</span>
<span class="nc" id="L8327">                    }</span>
                }

<span class="nc bnc" id="L8330" title="All 2 branches missed.">                if (filePath == null) {</span>
<span class="nc" id="L8331">                    callback.fireActionEvent(null);</span>
<span class="nc" id="L8332">                    return;</span>
                }

<span class="nc" id="L8335">                callback.fireActionEvent(new ActionEvent(new String[]{filePath}));</span>
<span class="nc" id="L8336">                return;</span>
<span class="nc bnc" id="L8337" title="All 2 branches missed.">            } else if (requestCode == OPEN_GALLERY) {</span>
                
<span class="nc" id="L8339">                Uri selectedImage = intent.getData();</span>
<span class="nc" id="L8340">                String scheme = intent.getScheme();</span>

<span class="nc" id="L8342">                String[] filePathColumn = {MediaStore.Images.Media.DATA};</span>
<span class="nc" id="L8343">                Cursor cursor = getContext().getContentResolver().query(selectedImage, filePathColumn, null, null, null);</span>

                // Some gallery providers may return an empty cursor on modern Android builds.
<span class="nc" id="L8346">                String filePath = null;</span>
<span class="nc bnc" id="L8347" title="All 2 branches missed.">                if (cursor != null) {</span>
                    try {
<span class="nc" id="L8349">                        int columnIndex = cursor.getColumnIndex(filePathColumn[0]);</span>
<span class="nc bnc" id="L8350" title="All 4 branches missed.">                        if (columnIndex &gt;= 0 &amp;&amp; cursor.moveToFirst()) {</span>
<span class="nc" id="L8351">                            filePath = cursor.getString(columnIndex);</span>
                        }
                    } finally {
<span class="nc" id="L8354">                        cursor.close();</span>
                    }
                }
<span class="nc" id="L8357">                boolean fileExists = false;</span>
<span class="nc bnc" id="L8358" title="All 2 branches missed.">                if (filePath != null) {</span>
<span class="nc" id="L8359">                    File file = new File(filePath);</span>
<span class="nc bnc" id="L8360" title="All 4 branches missed.">                    fileExists = file.exists() &amp;&amp; file.canRead();</span>
                }

<span class="nc bnc" id="L8363" title="All 4 branches missed.">                if (!fileExists &amp;&amp; &quot;content&quot;.equals(scheme)) {</span>
                    //if the file is not on the filesystem download it and save it
                    //locally
                    try {
<span class="nc" id="L8367">                        InputStream inputStream = getContext().getContentResolver().openInputStream(selectedImage);</span>
<span class="nc bnc" id="L8368" title="All 2 branches missed.">                        if (inputStream != null) {</span>
<span class="nc" id="L8369">                            String name = getContentName(getContext().getContentResolver(), selectedImage);</span>
<span class="nc bnc" id="L8370" title="All 2 branches missed.">                            if (name != null) {</span>
<span class="nc" id="L8371">                                filePath = getAppHomePath()</span>
<span class="nc" id="L8372">                                        + getFileSystemSeparator() + name;</span>
<span class="nc" id="L8373">                                File f = new File(removeFilePrefix(filePath));</span>
<span class="nc" id="L8374">                                OutputStream tmp = createFileOuputStream(f);</span>
<span class="nc" id="L8375">                                byte[] buffer = new byte[1024];</span>
<span class="nc" id="L8376">                                int read = -1;</span>
<span class="nc bnc" id="L8377" title="All 2 branches missed.">                                while ((read = inputStream.read(buffer)) &gt; -1) {</span>
<span class="nc" id="L8378">                                    tmp.write(buffer, 0, read);</span>
                                }
<span class="nc" id="L8380">                                tmp.close();</span>
<span class="nc" id="L8381">                                inputStream.close();</span>
                            }
                        }
<span class="nc" id="L8384">                    } catch (Exception e) {</span>
<span class="nc" id="L8385">                        e.printStackTrace();</span>
<span class="nc" id="L8386">                    }</span>
                }

<span class="nc bnc" id="L8389" title="All 2 branches missed.">                if (filePath == null) {</span>
<span class="nc" id="L8390">                    callback.fireActionEvent(null);</span>
<span class="nc" id="L8391">                    return;</span>
                }

<span class="nc" id="L8394">                callback.fireActionEvent(new ActionEvent(filePath));</span>
<span class="nc" id="L8395">                return;</span>
            } else {
<span class="nc bnc" id="L8397" title="All 2 branches missed.">                if(callback != null) {</span>
<span class="nc" id="L8398">                    callback.fireActionEvent(new ActionEvent(&quot;ok&quot;));</span>
                }
<span class="nc" id="L8400">                return;</span>
            }
        }
        //clean imageUri
<span class="nc" id="L8404">        String imageUri = (String) Storage.getInstance().readObject(&quot;imageUri&quot;);</span>
<span class="nc bnc" id="L8405" title="All 2 branches missed.">        if(imageUri != null){</span>
<span class="nc" id="L8406">            Storage.getInstance().deleteStorageFile(&quot;imageUri&quot;);</span>
        }

<span class="nc bnc" id="L8409" title="All 2 branches missed.">        if(callback != null) {</span>
<span class="nc" id="L8410">            callback.fireActionEvent(null);</span>
        }
<span class="nc" id="L8412">    }</span>



    @Override
    public void capturePhoto(ActionListener response) {
<span class="nc bnc" id="L8418" title="All 2 branches missed.">        if (getActivity() == null) {</span>
<span class="nc" id="L8419">            throw new RuntimeException(&quot;Cannot capture photo in background mode&quot;);</span>
        }
<span class="nc bnc" id="L8421" title="All 2 branches missed.">        if (PermissionsHelper.requiresExternalStoragePermissionForMediaAccess()) {</span>
<span class="nc bnc" id="L8422" title="All 2 branches missed.">            if(!checkForPermission(Manifest.permission.WRITE_EXTERNAL_STORAGE, &quot;This is required to take a picture&quot;)){</span>
<span class="nc" id="L8423">                return;</span>
            }
        }

<span class="nc bnc" id="L8427" title="All 2 branches missed.">        if (getRequestedPermissions().contains(Manifest.permission.CAMERA)) {</span>
            // Normally we don't need to request the CAMERA permission since we use
            // the ACTION_IMAGE_CAPTURE intent, which handles permissions itself.
            // BUT: If the camera permission is included in the Manifest file, the 
            // intent will defer to the app's permissions, and on Android 6, 
            // the permission is denied unless we do the runtime check for permission.
            // See https://github.com/codenameone/CodenameOne/issues/2409#issuecomment-391696058
<span class="nc bnc" id="L8434" title="All 2 branches missed.">            if(!checkForPermission(Manifest.permission.CAMERA, &quot;This is required to take a picture&quot;)){</span>
<span class="nc" id="L8435">                return;</span>
            }
        }
<span class="nc" id="L8438">        callback = new EventDispatcher();</span>
<span class="nc" id="L8439">        callback.addListener(response);</span>
<span class="nc" id="L8440">        Intent intent = new Intent(android.provider.MediaStore.ACTION_IMAGE_CAPTURE);</span>

<span class="nc" id="L8442">        File newFile = getOutputMediaFile(false);</span>
<span class="nc" id="L8443">        newFile.getParentFile().mkdirs();</span>
<span class="nc" id="L8444">        newFile.getParentFile().setWritable(true, false);</span>
        //Uri imageUri = Uri.fromFile(newFile);
<span class="nc" id="L8446">        Uri imageUri = FileProvider.getUriForFile(getContext(), getContext().getPackageName()+&quot;.provider&quot;, newFile);</span>
<span class="nc" id="L8447">        intent.putExtra(android.provider.MediaStore.EXTRA_OUTPUT, imageUri);</span>

<span class="nc" id="L8449">        String lastImageID = getLastImageId();</span>
<span class="nc" id="L8450">        Storage.getInstance().writeObject(&quot;imageUri&quot;, newFile.getAbsolutePath() + &quot;;&quot; + lastImageID);</span>

<span class="nc" id="L8452">        intent.putExtra(android.provider.MediaStore.EXTRA_OUTPUT, imageUri);</span>
<span class="nc" id="L8453">        intent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);</span>
        
<span class="nc bnc" id="L8455" title="All 2 branches missed.">        if (Build.VERSION.SDK_INT &lt; 21) {</span>
<span class="nc" id="L8456">            List&lt;ResolveInfo&gt; resInfoList = getContext().getPackageManager().queryIntentActivities(intent, PackageManager.MATCH_DEFAULT_ONLY);</span>
<span class="nc bnc" id="L8457" title="All 2 branches missed.">            for (ResolveInfo resolveInfo : resInfoList) {</span>
<span class="nc" id="L8458">                String packageName = resolveInfo.activityInfo.packageName;</span>
<span class="nc" id="L8459">                getContext().grantUriPermission(packageName, imageUri, Intent.FLAG_GRANT_WRITE_URI_PERMISSION | Intent.FLAG_GRANT_READ_URI_PERMISSION);</span>
<span class="nc" id="L8460">            }</span>
        }

<span class="nc" id="L8463">        getActivity().startActivityForResult(intent, CAPTURE_IMAGE);</span>
<span class="nc" id="L8464">    }</span>

    @Override
    public void captureVideo(ActionListener response) {
<span class="nc" id="L8468">        captureVideo(null, response);</span>
<span class="nc" id="L8469">    }</span>
    
    @Override
    public void captureVideo(VideoCaptureConstraints cnst, ActionListener response) {
<span class="nc bnc" id="L8473" title="All 2 branches missed.">        if (getActivity() == null) {</span>
<span class="nc" id="L8474">            throw new RuntimeException(&quot;Cannot capture video in background mode&quot;);</span>
        }
<span class="nc bnc" id="L8476" title="All 2 branches missed.">        if (PermissionsHelper.requiresExternalStoragePermissionForMediaAccess()) {</span>
<span class="nc bnc" id="L8477" title="All 2 branches missed.">            if(!checkForPermission(Manifest.permission.WRITE_EXTERNAL_STORAGE, &quot;This is required to take a video&quot;)){</span>
<span class="nc" id="L8478">                return;</span>
            }
        }

<span class="nc bnc" id="L8482" title="All 2 branches missed.">        if (getRequestedPermissions().contains(Manifest.permission.CAMERA)) {</span>
            // Normally we don't need to request the CAMERA permission since we use
            // the ACTION_VIDEO_CAPTURE intent, which handles permissions itself.
            // BUT: If the camera permission is included in the Manifest file, the 
            // intent will defer to the app's permissions, and on Android 6, 
            // the permission is denied unless we do the runtime check for permission.
            // See https://github.com/codenameone/CodenameOne/issues/2409#issuecomment-391696058
<span class="nc bnc" id="L8489" title="All 2 branches missed.">            if(!checkForPermission(Manifest.permission.CAMERA, &quot;This is required to take a video&quot;)){</span>
<span class="nc" id="L8490">                return;</span>
            }
        }
<span class="nc" id="L8493">        callback = new EventDispatcher();</span>
<span class="nc" id="L8494">        callback.addListener(response);</span>
<span class="nc" id="L8495">        Intent intent = new Intent(android.provider.MediaStore.ACTION_VIDEO_CAPTURE);</span>
<span class="nc bnc" id="L8496" title="All 2 branches missed.">        if (cnst != null) {</span>
<span class="nc bnc" id="L8497" title="All 3 branches missed.">            switch (cnst.getQuality()) {</span>
                case VideoCaptureConstraints.QUALITY_LOW:
<span class="nc" id="L8499">                    intent.putExtra(MediaStore.EXTRA_VIDEO_QUALITY, 0);</span>
<span class="nc" id="L8500">                    break;</span>
                case VideoCaptureConstraints.QUALITY_HIGH:
<span class="nc" id="L8502">                    intent.putExtra(MediaStore.EXTRA_VIDEO_QUALITY, 1);</span>
                    break;
            }
            
<span class="nc bnc" id="L8506" title="All 2 branches missed.">            if (cnst.getMaxFileSize() &gt; 0) {</span>
<span class="nc" id="L8507">                intent.putExtra(MediaStore.EXTRA_SIZE_LIMIT, cnst.getMaxFileSize());</span>
            }
<span class="nc bnc" id="L8509" title="All 2 branches missed.">            if (cnst.getMaxLength() &gt; 0) {</span>
<span class="nc" id="L8510">                intent.putExtra(MediaStore.EXTRA_DURATION_LIMIT, cnst.getMaxLength());</span>
            }
        }
        

<span class="nc" id="L8515">        File newFile = getOutputMediaFile(true);</span>
<span class="nc" id="L8516">        newFile.getParentFile().mkdirs();</span>
<span class="nc" id="L8517">        newFile.getParentFile().setWritable(true, false);</span>
<span class="nc" id="L8518">        Uri videoUri = FileProvider.getUriForFile(getContext(), getContext().getPackageName()+&quot;.provider&quot;, newFile);</span>

<span class="nc" id="L8520">        Storage.getInstance().writeObject(&quot;videoUri&quot;, newFile.getAbsolutePath());</span>

<span class="nc" id="L8522">        intent.putExtra(android.provider.MediaStore.EXTRA_OUTPUT, videoUri);</span>
<span class="nc" id="L8523">        intent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);</span>
<span class="nc bnc" id="L8524" title="All 2 branches missed.">        if (Build.VERSION.SDK_INT &lt; 21) {</span>
<span class="nc" id="L8525">            List&lt;ResolveInfo&gt; resInfoList = getContext().getPackageManager().queryIntentActivities(intent, PackageManager.MATCH_DEFAULT_ONLY);</span>
<span class="nc bnc" id="L8526" title="All 2 branches missed.">            for (ResolveInfo resolveInfo : resInfoList) {</span>
<span class="nc" id="L8527">                String packageName = resolveInfo.activityInfo.packageName;</span>
<span class="nc" id="L8528">                getContext().grantUriPermission(packageName, videoUri, Intent.FLAG_GRANT_WRITE_URI_PERMISSION | Intent.FLAG_GRANT_READ_URI_PERMISSION);</span>
<span class="nc" id="L8529">            }</span>
        }
        
<span class="nc" id="L8532">        this.getActivity().startActivityForResult(intent, CAPTURE_VIDEO);</span>
<span class="nc" id="L8533">    }</span>

    public void captureAudio(final ActionListener response) {

<span class="nc bnc" id="L8537" title="All 2 branches missed.">        if(!checkForPermission(Manifest.permission.RECORD_AUDIO, &quot;This is required to record the audio&quot;)){</span>
<span class="nc" id="L8538">            return;</span>
        }
        
        try {
<span class="nc" id="L8542">            final Form current = Display.getInstance().getCurrent();</span>

<span class="nc" id="L8544">            final File temp = File.createTempFile(&quot;mtmp&quot;, &quot;.3gpp&quot;);</span>
<span class="nc" id="L8545">            temp.deleteOnExit();</span>

<span class="nc bnc" id="L8547" title="All 2 branches missed.">            if (recorder != null) {</span>
<span class="nc" id="L8548">                recorder.release();</span>
            }
<span class="nc" id="L8550">            recorder = new MediaRecorder();</span>
<span class="nc" id="L8551">            recorder.setAudioSource(MediaRecorder.AudioSource.MIC);</span>
<span class="nc" id="L8552">            recorder.setOutputFormat(MediaRecorder.OutputFormat.THREE_GPP);</span>
<span class="nc" id="L8553">            recorder.setAudioEncoder(MediaRecorder.AudioEncoder.AMR_WB);</span>
<span class="nc" id="L8554">            recorder.setOutputFile(temp.getAbsolutePath());</span>

<span class="nc" id="L8556">            final Form recording = new Form(&quot;Recording&quot;);</span>
<span class="nc" id="L8557">            recording.setTransitionInAnimator(CommonTransitions.createEmpty());</span>
<span class="nc" id="L8558">            recording.setTransitionOutAnimator(CommonTransitions.createEmpty());</span>
<span class="nc" id="L8559">            recording.setLayout(new BorderLayout());</span>

<span class="nc" id="L8561">            recorder.prepare();</span>
<span class="nc" id="L8562">            recorder.start();</span>

<span class="nc" id="L8564">            final Label time = new Label(&quot;00:00&quot;);</span>
<span class="nc" id="L8565">            time.getAllStyles().setAlignment(Component.CENTER);</span>
<span class="nc" id="L8566">            Font f = Font.createSystemFont(Font.FACE_SYSTEM, Font.STYLE_PLAIN, Font.SIZE_LARGE);</span>
<span class="nc" id="L8567">            f = f.derive(getDisplayHeight() / 10, Font.STYLE_PLAIN);</span>
<span class="nc" id="L8568">            time.getAllStyles().setFont(f);</span>
<span class="nc" id="L8569">            recording.addComponent(BorderLayout.CENTER, time);</span>

<span class="nc" id="L8571">            recording.registerAnimated(new Animation() {</span>

<span class="nc" id="L8573">                long current = System.currentTimeMillis();</span>
<span class="nc" id="L8574">                long zero = current;</span>
<span class="nc" id="L8575">                int sec = 0;</span>

                public boolean animate() {
<span class="nc" id="L8578">                    long now = System.currentTimeMillis();</span>
<span class="nc bnc" id="L8579" title="All 2 branches missed.">                    if (now - current &gt; 1000) {</span>
<span class="nc" id="L8580">                        current = now;</span>
<span class="nc" id="L8581">                        sec++;</span>
<span class="nc" id="L8582">                        return true;</span>
                    }
<span class="nc" id="L8584">                    return false;</span>
                }

                public void paint(Graphics g) {
<span class="nc" id="L8588">                    int seconds = sec % 60;</span>
<span class="nc" id="L8589">                    int minutes = sec / 60;</span>

<span class="nc bnc" id="L8591" title="All 2 branches missed.">                    String secStr = seconds &lt; 10 ? &quot;0&quot; + seconds : &quot;&quot; + seconds;</span>
<span class="nc bnc" id="L8592" title="All 2 branches missed.">                    String minStr = minutes &lt; 10 ? &quot;0&quot; + minutes : &quot;&quot; + minutes;</span>

<span class="nc" id="L8594">                    String txt = minStr + &quot;:&quot; + secStr;</span>
<span class="nc" id="L8595">                    time.setText(txt);</span>
<span class="nc" id="L8596">                }</span>
            });

<span class="nc" id="L8599">            Container south = new Container(new com.codename1.ui.layouts.GridLayout(1, 2));</span>
<span class="nc" id="L8600">            Command cancel = new Command(&quot;Cancel&quot;) {</span>

                @Override
                public void actionPerformed(ActionEvent evt) {
<span class="nc bnc" id="L8604" title="All 2 branches missed.">                    if (recorder != null) {</span>
<span class="nc" id="L8605">                        recorder.stop();</span>
<span class="nc" id="L8606">                        recorder.release();</span>
<span class="nc" id="L8607">                        recorder = null;</span>
                    }
<span class="nc" id="L8609">                    current.showBack();</span>
<span class="nc" id="L8610">                    response.actionPerformed(null);</span>
<span class="nc" id="L8611">                }</span>

            };
<span class="nc" id="L8614">            recording.setBackCommand(cancel);</span>
<span class="nc" id="L8615">            south.add(new com.codename1.ui.Button(cancel));</span>
<span class="nc" id="L8616">            south.add(new com.codename1.ui.Button(new Command(&quot;Save&quot;) {</span>

                @Override
                public void actionPerformed(ActionEvent evt) {
<span class="nc bnc" id="L8620" title="All 2 branches missed.">                    if (recorder != null) {</span>
<span class="nc" id="L8621">                        recorder.stop();</span>
<span class="nc" id="L8622">                        recorder.release();</span>
<span class="nc" id="L8623">                        recorder = null;</span>
                    }
<span class="nc" id="L8625">                    current.showBack();</span>
<span class="nc" id="L8626">                    response.actionPerformed(new ActionEvent(temp.getAbsolutePath()));</span>
<span class="nc" id="L8627">                }</span>

            }));
<span class="nc" id="L8630">            recording.addComponent(BorderLayout.SOUTH, south);</span>
<span class="nc" id="L8631">            recording.show();</span>

<span class="nc" id="L8633">        } catch (IOException ex) {</span>
<span class="nc" id="L8634">            ex.printStackTrace();</span>
<span class="nc" id="L8635">            throw new RuntimeException(&quot;failed to start audio recording&quot;);</span>
<span class="nc" id="L8636">        }</span>

<span class="nc" id="L8638">    }</span>

    /**
     * Opens the device image gallery
     *
     * @param response callback for the resulting image
     *
     * 
     * DISABLING:  openGallery() should take care of this
    public void openImageGallery(ActionListener response) {
        if (getActivity() == null) {
            throw new RuntimeException(&quot;Cannot open image gallery in background mode&quot;);
        }
        if(!checkForPermission(Manifest.permission.WRITE_EXTERNAL_STORAGE, &quot;This is required to browse the photos&quot;)){
            return;
        }

        if(editInProgress()) {
            stopEditing(true);
        }

        callback = new EventDispatcher();
        callback.addListener(response);
        Intent galleryIntent = new Intent(Intent.ACTION_PICK, android.provider.MediaStore.Images.Media.INTERNAL_CONTENT_URI);
        this.getActivity().startActivityForResult(galleryIntent, OPEN_GALLERY);
    }
    * */

    @Override
    public boolean isGalleryTypeSupported(int type) {
<span class="nc bnc" id="L8668" title="All 2 branches missed.">        if (super.isGalleryTypeSupported(type)) {</span>
<span class="nc" id="L8669">            return true;</span>
        }
<span class="nc bnc" id="L8671" title="All 4 branches missed.">        if (type == -9999 || type == -9998) {</span>
<span class="nc" id="L8672">            return true;</span>
        }
<span class="nc bnc" id="L8674" title="All 2 branches missed.">        if (android.os.Build.VERSION.SDK_INT &gt;= 16) {</span>
<span class="nc bnc" id="L8675" title="All 2 branches missed.">            switch (type) {</span>

                case Display.GALLERY_ALL_MULTI:
                case Display.GALLERY_VIDEO_MULTI:
                case Display.GALLERY_IMAGE_MULTI:
<span class="nc" id="L8680">                    return true;</span>
            }
        }
<span class="nc" id="L8683">        return false;</span>
    }

    
    
    public void openGallery(final ActionListener response, int type){
<span class="nc bnc" id="L8689" title="All 2 branches missed.">        if (!isGalleryTypeSupported(type)) {</span>
<span class="nc" id="L8690">            throw new IllegalArgumentException(&quot;Gallery type &quot;+type+&quot; not supported on this platform.&quot;);</span>
        }
<span class="nc bnc" id="L8692" title="All 2 branches missed.">        if (getActivity() == null) {</span>
<span class="nc" id="L8693">            throw new RuntimeException(&quot;Cannot open galery in background mode&quot;);</span>
        }
<span class="nc bnc" id="L8695" title="All 2 branches missed.">        if (PermissionsHelper.requiresExternalStoragePermissionForMediaAccess()) {</span>
<span class="nc bnc" id="L8696" title="All 2 branches missed.">            if(!checkForPermission(Manifest.permission.WRITE_EXTERNAL_STORAGE, &quot;This is required to browse the photos&quot;)){</span>
<span class="nc" id="L8697">                return;</span>
            }
        }
<span class="nc bnc" id="L8700" title="All 2 branches missed.">        if(editInProgress()) {</span>
<span class="nc" id="L8701">            stopEditing(true);</span>
        }
        final boolean multi;
<span class="nc bnc" id="L8704" title="All 5 branches missed.">        switch (type) {</span>
            case Display.GALLERY_ALL_MULTI:
<span class="nc" id="L8706">                multi=true;</span>
<span class="nc" id="L8707">                type = Display.GALLERY_ALL;</span>
<span class="nc" id="L8708">                break;</span>
            case Display.GALLERY_VIDEO_MULTI:
<span class="nc" id="L8710">                multi=true;</span>
<span class="nc" id="L8711">                type = Display.GALLERY_VIDEO;</span>
<span class="nc" id="L8712">                break;</span>
            case Display.GALLERY_IMAGE_MULTI:
<span class="nc" id="L8714">                multi = true;</span>
<span class="nc" id="L8715">                type = Display.GALLERY_IMAGE;</span>
<span class="nc" id="L8716">                break;</span>
            case -9998:
<span class="nc" id="L8718">                multi = true;</span>
<span class="nc" id="L8719">                type = -9999;</span>
<span class="nc" id="L8720">                break;</span>
            default:
<span class="nc" id="L8722">                multi = false;</span>
        }
        
<span class="nc" id="L8725">        callback = new EventDispatcher();</span>
<span class="nc" id="L8726">        callback.addListener(response);</span>
<span class="nc" id="L8727">        Intent galleryIntent = new Intent(Intent.ACTION_PICK, android.provider.MediaStore.Images.Media.INTERNAL_CONTENT_URI);</span>
<span class="nc" id="L8728">        galleryIntent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);</span>
<span class="nc bnc" id="L8729" title="All 2 branches missed.">        if (multi) {</span>
<span class="nc" id="L8730">            galleryIntent.putExtra(Intent.EXTRA_ALLOW_MULTIPLE, true);</span>
        }
<span class="nc bnc" id="L8732" title="All 2 branches missed.">        if(type == Display.GALLERY_VIDEO){</span>
<span class="nc" id="L8733">            galleryIntent.setType(&quot;video/*&quot;);</span>
<span class="nc bnc" id="L8734" title="All 2 branches missed.">        }else if(type == Display.GALLERY_IMAGE){</span>
<span class="nc" id="L8735">            galleryIntent.setType(&quot;image/*&quot;);</span>
<span class="nc bnc" id="L8736" title="All 2 branches missed.">        }else if(type == Display.GALLERY_ALL){</span>
<span class="nc" id="L8737">            galleryIntent.setType(&quot;image/* video/*&quot;);</span>
<span class="nc bnc" id="L8738" title="All 2 branches missed.">        }else if (type == -9999) {</span>
<span class="nc" id="L8739">            galleryIntent = new Intent();</span>
<span class="nc bnc" id="L8740" title="All 2 branches missed.">            if (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.KITKAT) {</span>
<span class="nc" id="L8741">                galleryIntent.setAction(Intent.ACTION_OPEN_DOCUMENT);</span>
            } else {
<span class="nc" id="L8743">                galleryIntent.setAction(Intent.ACTION_GET_CONTENT);</span>
            }
<span class="nc" id="L8745">            galleryIntent.addCategory(Intent.CATEGORY_OPENABLE);</span>
<span class="nc" id="L8746">            galleryIntent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);</span>
<span class="nc bnc" id="L8747" title="All 2 branches missed.">            if (android.os.Build.VERSION.SDK_INT &gt;= android.os.Build.VERSION_CODES.KITKAT) {</span>
<span class="nc" id="L8748">                galleryIntent.addFlags(Intent.FLAG_GRANT_PERSISTABLE_URI_PERMISSION);</span>
            }

            // set MIME type for image
<span class="nc" id="L8752">            galleryIntent.setType(&quot;*/*&quot;);</span>
<span class="nc" id="L8753">            galleryIntent.putExtra(Intent.EXTRA_MIME_TYPES, Display.getInstance().getProperty(&quot;android.openGallery.accept&quot;, &quot;*/*&quot;).split(&quot;,&quot;));</span>
        }else{
<span class="nc" id="L8755">            galleryIntent.setType(&quot;*/*&quot;);</span>
        }
<span class="nc bnc" id="L8757" title="All 2 branches missed.">        this.getActivity().startActivityForResult(galleryIntent, multi ? OPEN_GALLERY_MULTI: OPEN_GALLERY);</span>
<span class="nc" id="L8758">    }</span>

    class NativeImage extends Image {

<span class="fc" id="L8762">        public NativeImage(Bitmap nativeImage) {</span>
<span class="fc" id="L8763">            super(nativeImage);</span>
<span class="fc" id="L8764">        }</span>
    }

    /**
     * Persist read permissions that were granted by an activity result so that media playback can
     * continue after {@link Activity#onActivityResult(int, int, Intent)} returns.
     *
     * &lt;p&gt;Android 13 and newer revoke temporary grants immediately after the callback unless the
     * app calls {@link ContentResolver#takePersistableUriPermission(Uri, int)}. Without this call
     * {@link #createMedia(String, boolean, Runnable)} loses access to the {@code content://} URI
     * provided by the system picker and playback fails on Android 15.&lt;/p&gt;
     */
    private void takePersistablePermissionsFromIntent(Intent intent) {
<span class="nc bnc" id="L8777" title="All 4 branches missed.">        if (intent == null || Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.KITKAT) {</span>
<span class="nc" id="L8778">            return;</span>
        }
<span class="nc" id="L8780">        int takeFlags = intent.getFlags() &amp; (Intent.FLAG_GRANT_READ_URI_PERMISSION | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</span>
<span class="nc bnc" id="L8781" title="All 2 branches missed.">        if (takeFlags == 0) {</span>
<span class="nc" id="L8782">            return;</span>
        }
<span class="nc" id="L8784">        ContentResolver resolver = getContext().getContentResolver();</span>
<span class="nc bnc" id="L8785" title="All 2 branches missed.">        if (resolver == null) {</span>
<span class="nc" id="L8786">            return;</span>
        }
<span class="nc" id="L8788">        ClipData clip = intent.getClipData();</span>
<span class="nc bnc" id="L8789" title="All 2 branches missed.">        if (clip != null) {</span>
<span class="nc bnc" id="L8790" title="All 2 branches missed.">            for (int i = 0; i &lt; clip.getItemCount(); i++) {</span>
<span class="nc" id="L8791">                Uri uri = clip.getItemAt(i).getUri();</span>
<span class="nc bnc" id="L8792" title="All 2 branches missed.">                if (uri != null) {</span>
                    try {
<span class="nc" id="L8794">                        resolver.takePersistableUriPermission(uri, takeFlags);</span>
<span class="nc" id="L8795">                    } catch (SecurityException ignored) {</span>
<span class="nc" id="L8796">                    }</span>
                }
            }
        }
<span class="nc" id="L8800">        Uri dataUri = intent.getData();</span>
<span class="nc bnc" id="L8801" title="All 2 branches missed.">        if (dataUri != null) {</span>
            try {
<span class="nc" id="L8803">                resolver.takePersistableUriPermission(dataUri, takeFlags);</span>
<span class="nc" id="L8804">            } catch (SecurityException ignored) {</span>
<span class="nc" id="L8805">            }</span>
        }
<span class="nc" id="L8807">    }</span>

    /**
     * Create a File for saving an image or video
     */
    private File getOutputMediaFile(boolean isVideo) {
        // To be safe, you should check that the SDCard is mounted
        // using Environment.getExternalStorageState() before doing this.
<span class="nc bnc" id="L8815" title="All 2 branches missed.">        if (getActivity() != null) {</span>
<span class="nc" id="L8816">            return GetOutputMediaFile.getOutputMediaFile(isVideo, getActivity());</span>
        } else {
<span class="nc" id="L8818">            return GetOutputMediaFile.getOutputMediaFile(isVideo, getContext(), &quot;Video&quot;);</span>
        }
    }

    private static class GetOutputMediaFile {

        public static File getOutputMediaFile(boolean isVideo,Activity activity) {
<span class="nc" id="L8825">            activity.getComponentName();</span>
<span class="nc" id="L8826">            return getOutputMediaFile(isVideo, activity, activity.getTitle());</span>
        }

        public static File getOutputMediaFile(boolean isVideo, Context activity, CharSequence title) {


<span class="nc" id="L8832">            File mediaStorageDir = new File(new File(getContext().getCacheDir(), &quot;intent_files&quot;), &quot;&quot;+title);</span>

            // Create the storage directory if it does not exist
<span class="nc bnc" id="L8835" title="All 2 branches missed.">            if (!mediaStorageDir.exists()) {</span>
<span class="nc bnc" id="L8836" title="All 2 branches missed.">                if (!mediaStorageDir.mkdirs()) {</span>
<span class="nc" id="L8837">                    Log.d(Display.getInstance().getProperty(&quot;AppName&quot;, &quot;CodenameOne&quot;), &quot;failed to create directory&quot;);</span>
<span class="nc" id="L8838">                    return null;</span>
                }
            }

            // Create a media file name
<span class="nc" id="L8843">            String timeStamp = new SimpleDateFormat(&quot;yyyyMMdd_HHmmss&quot;).format(new Date());</span>
<span class="nc" id="L8844">            File mediaFile = null;</span>
<span class="nc bnc" id="L8845" title="All 2 branches missed.">            if (!isVideo) {</span>
<span class="nc" id="L8846">                mediaFile = new File(mediaStorageDir.getPath() + File.separator</span>
                        + &quot;IMG_&quot; + timeStamp + &quot;.jpg&quot;);
            } else {
<span class="nc" id="L8849">                mediaFile = new File(mediaStorageDir.getPath() + File.separator</span>
                        + &quot;VID_&quot; + timeStamp + &quot;.mp4&quot;);
            }

<span class="nc" id="L8853">            return mediaFile;</span>
        }
    }

    @Override
    public void systemOut(String content){
<span class="fc" id="L8859">        Log.d(Display.getInstance().getProperty(&quot;AppName&quot;, &quot;CodenameOne&quot;), content);</span>
<span class="fc" id="L8860">    }</span>

    private boolean hasAndroidMarket() {
<span class="nc" id="L8863">        return hasAndroidMarket(getContext());</span>
    }

    private static final String GooglePlayStorePackageNameOld = &quot;com.google.market&quot;;
    private static final String GooglePlayStorePackageNameNew = &quot;com.android.vending&quot;;

    /**
     * Indicates whether this is a Google certified device which means that it
     * has Android market etc.
     */
    public static boolean hasAndroidMarket(Context activity) {
<span class="nc" id="L8874">        final PackageManager packageManager = activity.getPackageManager();</span>
<span class="nc" id="L8875">        List&lt;PackageInfo&gt; packages = packageManager.getInstalledPackages(PackageManager.GET_UNINSTALLED_PACKAGES);</span>
<span class="nc bnc" id="L8876" title="All 2 branches missed.">        for (PackageInfo packageInfo : packages) {</span>
<span class="nc bnc" id="L8877" title="All 2 branches missed.">            if (packageInfo.packageName.equals(GooglePlayStorePackageNameOld) ||</span>
<span class="nc bnc" id="L8878" title="All 2 branches missed.">                    packageInfo.packageName.equals(GooglePlayStorePackageNameNew)) {</span>
<span class="nc" id="L8879">                return true;</span>
            }
<span class="nc" id="L8881">        }</span>
<span class="nc" id="L8882">        return false;</span>
    }

    @Override
    public void registerPush(Hashtable metaData, boolean noFallback) {
<span class="nc bnc" id="L8887" title="All 2 branches missed.">        if (getActivity() == null) {</span>
<span class="nc" id="L8888">            return;</span>
        }

<span class="nc bnc" id="L8891" title="All 2 branches missed.">        if (android.os.Build.VERSION.SDK_INT &gt;= 33) {</span>
<span class="nc bnc" id="L8892" title="All 2 branches missed.">            if(!checkForPermission(&quot;android.permission.POST_NOTIFICATIONS&quot;, &quot;This is required to receive push notifications&quot;)){</span>
<span class="nc" id="L8893">                return;</span>
            }
        }

<span class="nc" id="L8897">        boolean has = hasAndroidMarket();</span>
<span class="nc bnc" id="L8898" title="All 2 branches missed.">        if (!has) {</span>
<span class="nc" id="L8899">            Log.d(&quot;Codename One&quot;, &quot;Device doesn't have Android market/google play can't register for push!&quot;);</span>
<span class="nc" id="L8900">            return;</span>
        }
<span class="nc" id="L8902">        String id = (String)metaData.get(com.codename1.push.Push.GOOGLE_PUSH_KEY);</span>
<span class="nc bnc" id="L8903" title="All 2 branches missed.">        if (id == null) {</span>
<span class="nc" id="L8904">            id = Display.getInstance().getProperty(&quot;gcm.sender_id&quot;, null);</span>
        }
<span class="nc bnc" id="L8906" title="All 2 branches missed.">        if(has) {</span>
<span class="nc" id="L8907">            Log.d(&quot;Codename One&quot;, &quot;Sending async push request for id: &quot; + id);</span>
<span class="nc" id="L8908">            ((CodenameOneActivity) getActivity()).registerForPush(id);</span>
        } else {
<span class="nc" id="L8910">            PushNotificationService.forceStartService(getActivity().getPackageName() + &quot;.PushNotificationService&quot;, getActivity());</span>
<span class="nc bnc" id="L8911" title="All 2 branches missed.">            if(!registerServerPush(id, getApplicationKey(), (byte)10, &quot;&quot;, getPackageName())) {</span>
<span class="nc" id="L8912">                sendPushRegistrationError(&quot;Server registration error&quot;, 1);</span>
            }
        }
<span class="nc" id="L8915">    }</span>

    public static void stopPollingLoop() {
<span class="nc" id="L8918">        stopPolling();</span>
<span class="nc" id="L8919">    }</span>

    public static void registerPolling() {
<span class="nc" id="L8922">        registerPollingFallback();</span>
<span class="nc" id="L8923">    }</span>

    @Override
    public void deregisterPush() {
<span class="nc" id="L8927">        boolean has = hasAndroidMarket();</span>
<span class="nc bnc" id="L8928" title="All 2 branches missed.">        if (has) {</span>
<span class="nc" id="L8929">            ((CodenameOneActivity) getActivity()).stopReceivingPush();</span>
<span class="nc" id="L8930">            deregisterPushFromServer();</span>
        } else {
<span class="nc" id="L8932">            super.deregisterPush();</span>
        }
<span class="nc" id="L8934">    }</span>

    private static String convertImageUriToFilePath(Uri imageUri, Context activity) {
<span class="nc" id="L8937">        Cursor cursor = null;</span>
<span class="nc" id="L8938">        String[] proj = {MediaStore.Images.Media.DATA};</span>
<span class="nc" id="L8939">        cursor = activity.getContentResolver().query(imageUri, proj, null, null, null);</span>
<span class="nc" id="L8940">        int column_index = cursor.getColumnIndexOrThrow(MediaStore.Images.Media.DATA);</span>
<span class="nc" id="L8941">        cursor.moveToFirst();</span>
<span class="nc" id="L8942">        String path = cursor.getString(column_index);</span>
<span class="nc" id="L8943">        cursor.close();</span>
<span class="nc" id="L8944">        return path;</span>
    }

    class CN1MediaController extends MediaController {

<span class="nc" id="L8949">        public CN1MediaController() {</span>
<span class="nc" id="L8950">            super(getActivity());</span>
<span class="nc" id="L8951">        }</span>

        @Override
        public boolean dispatchKeyEvent(KeyEvent event) {
<span class="nc" id="L8955">            int keycode = event.getKeyCode();</span>
<span class="nc" id="L8956">            keycode = CodenameOneView.internalKeyCodeTranslate(keycode);</span>
<span class="nc bnc" id="L8957" title="All 2 branches missed.">            if (keycode == AndroidImplementation.DROID_IMPL_KEY_BACK) {</span>
<span class="nc" id="L8958">                Display.getInstance().keyPressed(keycode);</span>
<span class="nc" id="L8959">                Display.getInstance().keyReleased(keycode);</span>
<span class="nc" id="L8960">                return true;</span>
            } else {
<span class="nc" id="L8962">                return super.dispatchKeyEvent(event);</span>
            }
        }
    }
    private L10NManager l10n;

    /**
     * @inheritDoc
     */
    public L10NManager getLocalizationManager() {
<span class="nc bnc" id="L8972" title="All 2 branches missed.">        if (l10n == null) {</span>
<span class="nc" id="L8973">            final Locale l = Locale.getDefault();</span>
<span class="nc" id="L8974">            l10n = new L10NManager(l.getLanguage(), l.getCountry()) {</span>
                public double parseDouble(String localeFormattedDecimal) {
                    try {
<span class="nc" id="L8977">                        return NumberFormat.getNumberInstance().parse(localeFormattedDecimal).doubleValue();</span>
<span class="nc" id="L8978">                    } catch (ParseException err) {</span>
<span class="nc" id="L8979">                        return Double.parseDouble(localeFormattedDecimal);</span>
                    }
                }

                @Override
                public String getLongMonthName(Date date) {
<span class="nc" id="L8985">                    java.text.SimpleDateFormat fmt = new java.text.SimpleDateFormat(&quot;MMMM&quot;, l);</span>
<span class="nc" id="L8986">                    return fmt.format(date);</span>
                }

                @Override
                public String getShortMonthName(Date date) {
<span class="nc" id="L8991">                    java.text.SimpleDateFormat fmt = new java.text.SimpleDateFormat(&quot;MMM&quot;, l);</span>
<span class="nc" id="L8992">                    return fmt.format(date);</span>
                }
                
                

                public String format(int number) {
<span class="nc" id="L8998">                    return NumberFormat.getNumberInstance().format(number);</span>
                }

                public String format(double number) {
<span class="nc" id="L9002">                    return NumberFormat.getNumberInstance().format(number);</span>
                }

                public String formatCurrency(double currency) {
<span class="nc" id="L9006">                    return NumberFormat.getCurrencyInstance().format(currency);</span>
                }

                public String formatDateLongStyle(Date d) {
<span class="nc" id="L9010">                    return DateFormat.getDateInstance(DateFormat.LONG).format(d);</span>
                }

                public String formatDateShortStyle(Date d) {
<span class="nc" id="L9014">                    return DateFormat.getDateInstance(DateFormat.SHORT).format(d);</span>
                }

                public String formatDateTime(Date d) {
<span class="nc" id="L9018">                    return DateFormat.getDateTimeInstance().format(d);</span>
                }

                public String formatDateTimeMedium(Date d) {
<span class="nc" id="L9022">                    DateFormat dd = DateFormat.getDateTimeInstance(DateFormat.MEDIUM, DateFormat.MEDIUM);</span>
<span class="nc" id="L9023">                    return dd.format(d);</span>
                }

                public String formatDateTimeShort(Date d) {
<span class="nc" id="L9027">                    DateFormat dd = DateFormat.getDateTimeInstance(DateFormat.SHORT, DateFormat.SHORT);</span>
<span class="nc" id="L9028">                    return dd.format(d);</span>
                }

                public String getCurrencySymbol() {
<span class="nc" id="L9032">                    return NumberFormat.getInstance().getCurrency().getSymbol();</span>
                }

                public void setLocale(String locale, String language) {
<span class="nc" id="L9036">                    super.setLocale(locale, language);</span>
<span class="nc" id="L9037">                    Locale l = new Locale(language, locale);</span>
<span class="nc" id="L9038">                    Locale.setDefault(l);</span>
<span class="nc" id="L9039">                }</span>
            };
        }
<span class="nc" id="L9042">        return l10n;</span>
    }
    private com.codename1.ui.util.ImageIO imIO;

    @Override
    public com.codename1.ui.util.ImageIO getImageIO() {
<span class="fc bfc" id="L9048" title="All 2 branches covered.">        if (imIO == null) {</span>
<span class="fc" id="L9049">            imIO = new com.codename1.ui.util.ImageIO() {</span>
                @Override
                public Dimension getImageSize(String imageFilePath) throws IOException {
<span class="nc" id="L9052">                    BitmapFactory.Options o = new BitmapFactory.Options();</span>
<span class="nc" id="L9053">                    o.inJustDecodeBounds = true;</span>
<span class="nc" id="L9054">                    o.inPreferredConfig = Bitmap.Config.ARGB_8888;</span>

<span class="nc" id="L9056">                    InputStream fis = createFileInputStream(imageFilePath);</span>
<span class="nc" id="L9057">                    BitmapFactory.decodeStream(fis, null, o);</span>
<span class="nc" id="L9058">                    fis.close();</span>

<span class="nc" id="L9060">                    ExifInterface exif = new ExifInterface(removeFilePrefix(imageFilePath));</span>

                    // if the image is in portrait mode
<span class="nc" id="L9063">                    int orientation = exif.getAttributeInt(ExifInterface.TAG_ORIENTATION, ExifInterface.ORIENTATION_NORMAL);</span>
<span class="nc bnc" id="L9064" title="All 4 branches missed.">                    if(orientation == ExifInterface.ORIENTATION_ROTATE_90 || orientation == ExifInterface.ORIENTATION_ROTATE_270) {</span>
<span class="nc" id="L9065">                        return new Dimension(o.outHeight, o.outWidth);</span>
                    }
<span class="nc" id="L9067">                    return new Dimension(o.outWidth, o.outHeight);</span>
                }

                private Dimension getImageSizeNoRotation(String imageFilePath) throws IOException {
<span class="nc" id="L9071">                    BitmapFactory.Options o = new BitmapFactory.Options();</span>
<span class="nc" id="L9072">                    o.inJustDecodeBounds = true;</span>
<span class="nc" id="L9073">                    o.inPreferredConfig = Bitmap.Config.ARGB_8888;</span>

<span class="nc" id="L9075">                    InputStream fis = createFileInputStream(imageFilePath);</span>
<span class="nc" id="L9076">                    BitmapFactory.decodeStream(fis, null, o);</span>
<span class="nc" id="L9077">                    fis.close();</span>

<span class="nc" id="L9079">                    return new Dimension(o.outWidth, o.outHeight);</span>
                }

                @Override
                public void save(InputStream image, OutputStream response, String format, int width, int height, float quality) throws IOException {
<span class="nc" id="L9084">                    Bitmap.CompressFormat f = Bitmap.CompressFormat.PNG;</span>
<span class="nc bnc" id="L9085" title="All 2 branches missed.">                    if (format == FORMAT_JPEG) {</span>
<span class="nc" id="L9086">                        f = Bitmap.CompressFormat.JPEG;</span>
                    }
<span class="nc" id="L9088">                    Image img = Image.createImage(image).scaled(width, height);</span>
<span class="nc" id="L9089">                    Bitmap b = (Bitmap) img.getImage();</span>
<span class="nc" id="L9090">                    b.compress(f, (int) (quality * 100), response);</span>
<span class="nc" id="L9091">                }</span>

                @Override
                public String saveAndKeepAspect(String imageFilePath, String preferredOutputPath, String format, int width, int height, float quality, boolean onlyDownscale, boolean scaleToFill) throws IOException{
<span class="nc" id="L9095">                    ExifInterface exif = new ExifInterface(removeFilePrefix(imageFilePath));</span>
<span class="nc" id="L9096">                    Dimension d = getImageSizeNoRotation(imageFilePath);</span>
<span class="nc bnc" id="L9097" title="All 2 branches missed.">                    if(onlyDownscale) {</span>
<span class="nc bnc" id="L9098" title="All 2 branches missed.">                        if(scaleToFill) {</span>
<span class="nc bnc" id="L9099" title="All 4 branches missed.">                            if(d.getHeight() &lt;= height || d.getWidth() &lt;= width) {</span>
<span class="nc" id="L9100">                                return imageFilePath;</span>
                            }
                        } else {
<span class="nc bnc" id="L9103" title="All 4 branches missed.">                            if(d.getHeight() &lt;= height &amp;&amp; d.getWidth() &lt;= width) {</span>
<span class="nc" id="L9104">                                return imageFilePath;</span>
                            }
                        }
                    }

<span class="nc" id="L9109">                    float ratio = ((float)d.getWidth()) / ((float)d.getHeight());</span>
<span class="nc" id="L9110">                    int heightBasedOnWidth = (int)(((float)width) / ratio);</span>
<span class="nc" id="L9111">                    int widthBasedOnHeight = (int)(((float)height) * ratio);</span>
<span class="nc bnc" id="L9112" title="All 2 branches missed.">                    if(scaleToFill) {</span>
<span class="nc bnc" id="L9113" title="All 2 branches missed.">                        if(heightBasedOnWidth &gt;= width) {</span>
<span class="nc" id="L9114">                            height = heightBasedOnWidth;</span>
                        } else {
<span class="nc" id="L9116">                            width = widthBasedOnHeight;</span>
                        }
                    } else {
<span class="nc bnc" id="L9119" title="All 2 branches missed.">                        if(heightBasedOnWidth &gt; width) {</span>
<span class="nc" id="L9120">                            width = widthBasedOnHeight;</span>
                        } else {
<span class="nc" id="L9122">                            height = heightBasedOnWidth;</span>
                        }
                    }
<span class="nc" id="L9125">                    sampleSizeOverride = Math.max(d.getWidth()/width, d.getHeight()/height);</span>
<span class="nc" id="L9126">                    OutputStream im = FileSystemStorage.getInstance().openOutputStream(preferredOutputPath);</span>
<span class="nc" id="L9127">                    Image i = Image.createImage(imageFilePath);</span>
<span class="nc" id="L9128">                    Image newImage = i.scaled(width, height);</span>
<span class="nc" id="L9129">                    int orientation = exif.getAttributeInt(ExifInterface.TAG_ORIENTATION, ExifInterface.ORIENTATION_NORMAL);</span>

<span class="nc" id="L9131">                    int angle = 0;</span>
<span class="nc bnc" id="L9132" title="All 4 branches missed.">                    switch (orientation) {</span>
                        case ExifInterface.ORIENTATION_ROTATE_90:
<span class="nc" id="L9134">                            angle = 90;</span>
<span class="nc" id="L9135">                            break;</span>
                        case ExifInterface.ORIENTATION_ROTATE_180:
<span class="nc" id="L9137">                            angle = 180;</span>
<span class="nc" id="L9138">                            break;</span>
                        case ExifInterface.ORIENTATION_ROTATE_270:
<span class="nc" id="L9140">                            angle = 270;</span>
                            break;
                    }
<span class="nc bnc" id="L9143" title="All 2 branches missed.">                    if (angle != 0) {</span>
<span class="nc" id="L9144">                        Matrix mat = new Matrix();</span>
<span class="nc" id="L9145">                        mat.postRotate(angle);</span>
<span class="nc" id="L9146">                        Bitmap b = (Bitmap)newImage.getImage();</span>
<span class="nc" id="L9147">                        Bitmap correctBmp = Bitmap.createBitmap(b, 0, 0, b.getWidth(), b.getHeight(), mat, true);</span>
<span class="nc" id="L9148">                        b.recycle();</span>
<span class="nc" id="L9149">                        newImage.dispose();</span>
<span class="nc" id="L9150">                        Image tmp = Image.createImage(correctBmp);</span>
<span class="nc" id="L9151">                        newImage = tmp;</span>
<span class="nc" id="L9152">                        save(tmp, im, format, quality);</span>
<span class="nc" id="L9153">                    } else {</span>
<span class="nc" id="L9154">                        save(imageFilePath, im, format, width, height, quality);</span>
                    }
<span class="nc" id="L9156">                    sampleSizeOverride =  -1;</span>
<span class="nc" id="L9157">                    return preferredOutputPath;</span>
                }

                @Override
                public void save(String imageFilePath, OutputStream response, String format, int width, int height, float quality) throws IOException {
<span class="nc" id="L9162">                    Image i = Image.createImage(imageFilePath);</span>
<span class="nc" id="L9163">                    Image newImage = i.scaled(width, height);</span>
<span class="nc" id="L9164">                    save(newImage, response, format, quality);</span>
<span class="nc" id="L9165">                    newImage.dispose();</span>
<span class="nc" id="L9166">                    i.dispose();</span>
<span class="nc" id="L9167">                }</span>

                @Override
                protected void saveImage(Image img, OutputStream response, String format, float quality) throws IOException {
<span class="fc" id="L9171">                    Bitmap.CompressFormat f = Bitmap.CompressFormat.PNG;</span>
<span class="fc bfc" id="L9172" title="All 2 branches covered.">                    if (format == FORMAT_JPEG) {</span>
<span class="fc" id="L9173">                        f = Bitmap.CompressFormat.JPEG;</span>
                    }
<span class="fc" id="L9175">                    Bitmap b = (Bitmap) img.getImage();</span>
<span class="fc" id="L9176">                    b.compress(f, (int) (quality * 100), response);</span>
<span class="fc" id="L9177">                }</span>

                @Override
                public boolean isFormatSupported(String format) {
<span class="pc bpc" id="L9181" title="2 of 4 branches missed.">                    return format == FORMAT_JPEG || format == FORMAT_PNG;</span>
                }
            };
        }
<span class="fc" id="L9185">        return imIO;</span>
    }

    @Override
    public Database openOrCreateDB(String databaseName) throws IOException {
        SQLiteDatabase db;
<span class="nc bnc" id="L9191" title="All 2 branches missed.">        if (databaseName.startsWith(&quot;file://&quot;)) {</span>
<span class="nc" id="L9192">            db = SQLiteDatabase.openOrCreateDatabase(FileSystemStorage.getInstance().toNativePath(databaseName), null);</span>
        } else {
<span class="nc" id="L9194">            db = getContext().openOrCreateDatabase(databaseName, getContext().MODE_PRIVATE, null);</span>
        }
<span class="nc" id="L9196">        return new AndroidDB(db);</span>
    }

    @Override
    public boolean isDatabaseCustomPathSupported() {
<span class="nc" id="L9201">        return true;</span>
    }
    
    

    @Override
    public void deleteDB(String databaseName) throws IOException {
<span class="nc bnc" id="L9208" title="All 2 branches missed.">        if (databaseName.startsWith(&quot;file://&quot;)) {</span>
<span class="nc" id="L9209">            deleteFile(databaseName);</span>
<span class="nc" id="L9210">            return;</span>
        }
<span class="nc" id="L9212">        getContext().deleteDatabase(databaseName);</span>
<span class="nc" id="L9213">    }</span>

    @Override
    public boolean existsDB(String databaseName) {
<span class="nc bnc" id="L9217" title="All 2 branches missed.">        if (databaseName.startsWith(&quot;file://&quot;)) {</span>
<span class="nc" id="L9218">            return exists(databaseName);</span>
        }
<span class="nc" id="L9220">        File db = new File(getContext().getApplicationInfo().dataDir + &quot;/databases/&quot; + databaseName);</span>
<span class="nc" id="L9221">        return db.exists();</span>
    }

    public String getDatabasePath(String databaseName) {
<span class="nc bnc" id="L9225" title="All 2 branches missed.">        if (databaseName.startsWith(&quot;file://&quot;)) {</span>
<span class="nc" id="L9226">            return databaseName;</span>
        }
<span class="nc" id="L9228">        File db = new File(getContext().getApplicationInfo().dataDir + &quot;/databases/&quot; + databaseName);</span>
<span class="nc" id="L9229">        return db.getAbsolutePath();</span>
    }

    public boolean isNativeTitle() {
<span class="pc bpc" id="L9233" title="1 of 2 branches missed.">        if(com.codename1.ui.Toolbar.isGlobalToolbar()) {</span>
<span class="fc" id="L9234">            return false;</span>
        }
<span class="nc" id="L9236">        Form f = getCurrentForm();</span>
        boolean nativeCommand;
<span class="nc bnc" id="L9238" title="All 2 branches missed.">        if(f != null){</span>
<span class="nc bnc" id="L9239" title="All 2 branches missed.">            nativeCommand = f.getMenuBar().getCommandBehavior() == Display.COMMAND_BEHAVIOR_NATIVE;</span>
        }else{
<span class="nc bnc" id="L9241" title="All 2 branches missed.">            nativeCommand = getCommandBehavior() == Display.COMMAND_BEHAVIOR_NATIVE;</span>
        }
<span class="nc bnc" id="L9243" title="All 4 branches missed.">        return hasActionBar() &amp;&amp; nativeCommand;</span>
    }

    public void refreshNativeTitle(){
<span class="pc bpc" id="L9247" title="2 of 4 branches missed.">        if (getActivity() == null || com.codename1.ui.Toolbar.isGlobalToolbar()) {</span>
<span class="fc" id="L9248">            return;</span>
        }
<span class="nc" id="L9250">        Form f = getCurrentForm();</span>
<span class="nc bnc" id="L9251" title="All 6 branches missed.">        if (f != null &amp;&amp; isNativeTitle() &amp;&amp;  !(f instanceof Dialog)) {</span>
<span class="nc" id="L9252">            getActivity().runOnUiThread(new SetCurrentFormImpl(getActivity(), f));</span>
        }
<span class="nc" id="L9254">    }</span>

    public void setCurrentForm(final Form f) {
<span class="pc bpc" id="L9257" title="1 of 2 branches missed.">        if (getActivity() == null) {</span>
<span class="nc" id="L9258">            return;</span>
        }
<span class="fc bfc" id="L9260" title="All 2 branches covered.">        if(getCurrentForm() == null){</span>
<span class="fc" id="L9261">            flushGraphics();</span>
        }
<span class="pc bpc" id="L9263" title="1 of 2 branches missed.">        if(editInProgress()) {</span>
<span class="nc" id="L9264">            stopEditing(true);</span>
        }
<span class="fc" id="L9266">        super.setCurrentForm(f);</span>
<span class="pc bpc" id="L9267" title="3 of 4 branches missed.">        if (isNativeTitle() &amp;&amp;  !(f instanceof Dialog)) {</span>
<span class="nc" id="L9268">            getActivity().runOnUiThread(new SetCurrentFormImpl(getActivity(), f));</span>
        }
<span class="fc" id="L9270">    }</span>

    @Override
    public void setNativeCommands(Vector commands) {
<span class="fc" id="L9274">        refreshNativeTitle();</span>
<span class="fc" id="L9275">    }</span>

    @Override
    public boolean isScreenLockSupported() {
<span class="nc" id="L9279">        return true;</span>
    }

    @Override
    public void lockScreen(){
<span class="nc" id="L9284">        ((CodenameOneActivity)getContext()).lockScreen();</span>
<span class="nc" id="L9285">    }</span>

    @Override
    public void unlockScreen(){
<span class="nc" id="L9289">        ((CodenameOneActivity)getContext()).unlockScreen();</span>
<span class="nc" id="L9290">    }</span>

    private static class SetCurrentFormImpl implements Runnable {
        private Activity activity;
        private Form f;

<span class="nc" id="L9296">        public SetCurrentFormImpl(Activity activity, Form f) {</span>
<span class="nc" id="L9297">            this.activity = activity;</span>
<span class="nc" id="L9298">            this.f = f;</span>
<span class="nc" id="L9299">        }</span>

        @Override
        public void run() {
<span class="nc bnc" id="L9303" title="All 2 branches missed.">            if(com.codename1.ui.Toolbar.isGlobalToolbar()) {</span>
<span class="nc" id="L9304">                return;</span>
            }
<span class="nc" id="L9306">            ActionBar ab = activity.getActionBar();</span>
<span class="nc" id="L9307">            String title = f.getTitle();</span>
<span class="nc" id="L9308">            boolean hasMenuBtn = false;</span>
<span class="nc bnc" id="L9309" title="All 2 branches missed.">            if(android.os.Build.VERSION.SDK_INT &gt;= 14){</span>
                try {
<span class="nc" id="L9311">                    ViewConfiguration vc = ViewConfiguration.get(activity);</span>
<span class="nc" id="L9312">                    Method m = vc.getClass().getMethod(&quot;hasPermanentMenuKey&quot;, (Class[])null);</span>
<span class="nc" id="L9313">                    hasMenuBtn = ((Boolean)m.invoke(vc, (Object[])null)).booleanValue();</span>
<span class="nc" id="L9314">                } catch(Throwable t) {</span>
<span class="nc" id="L9315">                    t.printStackTrace();</span>
<span class="nc" id="L9316">                }</span>
            }
<span class="nc bnc" id="L9318" title="All 8 branches missed.">            if((title != null &amp;&amp; title.length() &gt; 0) || (f.getCommandCount() &gt; 0 &amp;&amp; !hasMenuBtn)){</span>
<span class="nc" id="L9319">                activity.runOnUiThread(new NotifyActionBar(activity, true));</span>
            }else{
<span class="nc" id="L9321">                activity.runOnUiThread(new NotifyActionBar(activity, false));</span>
<span class="nc" id="L9322">                return;</span>
            }

<span class="nc" id="L9325">            ab.setTitle(title);</span>
<span class="nc bnc" id="L9326" title="All 2 branches missed.">            ab.setDisplayHomeAsUpEnabled(f.getBackCommand() != null);</span>
<span class="nc bnc" id="L9327" title="All 2 branches missed.">            if(android.os.Build.VERSION.SDK_INT &gt;= 14){</span>
<span class="nc" id="L9328">                Image icon = f.getTitleComponent().getIcon();</span>
                try {
<span class="nc bnc" id="L9330" title="All 2 branches missed.">                    if(icon != null){</span>
<span class="nc" id="L9331">                        ab.getClass().getMethod(&quot;setIcon&quot;, Drawable.class).invoke(ab, new BitmapDrawable(activity.getResources(), (Bitmap)icon.getImage()));</span>
                    }else{
<span class="nc bnc" id="L9333" title="All 2 branches missed.">                        if(activity.getApplicationInfo().icon != 0){</span>
<span class="nc" id="L9334">                            ab.getClass().getMethod(&quot;setIcon&quot;, Integer.TYPE).invoke(ab, activity.getApplicationInfo().icon);</span>
                        }
                    }
<span class="nc" id="L9337">                    activity.runOnUiThread(new InvalidateOptionsMenuImpl(activity));</span>
<span class="nc" id="L9338">                } catch(Throwable t) {</span>
<span class="nc" id="L9339">                    t.printStackTrace();</span>
<span class="nc" id="L9340">                }</span>
            }
<span class="nc" id="L9342">            return;</span>
        }

    }

    private Purchase pur;

    @Override
    public Purchase getInAppPurchase() {
        try {
<span class="nc" id="L9352">            pur = ZoozPurchase.class.newInstance();</span>
<span class="nc" id="L9353">            return pur;</span>
<span class="nc" id="L9354">        } catch(Throwable t) {</span>
<span class="nc" id="L9355">            return super.getInAppPurchase();</span>
        }
    }

    @Override
    public boolean isTimeoutSupported() {
<span class="fc" id="L9361">        return true;</span>
    }

    @Override
    public void setTimeout(int t) {
<span class="nc" id="L9366">        timeout = t;</span>
<span class="nc" id="L9367">    }</span>

    @Override
    public CodeScanner getCodeScanner() {
<span class="nc bnc" id="L9371" title="All 2 branches missed.">        if(scannerInstance == null) {</span>
<span class="nc" id="L9372">            scannerInstance = new CodeScannerImpl();</span>
        }
<span class="nc" id="L9374">        return scannerInstance;</span>
    }

    public void addCookie(Cookie c, boolean addToWebViewCookieManager, boolean sync) {
<span class="nc bnc" id="L9378" title="All 2 branches missed.">        if(addToWebViewCookieManager) {</span>
            CookieManager mgr;
            CookieSyncManager syncer;
            try {
<span class="nc" id="L9382">                syncer = CookieSyncManager.getInstance();</span>
<span class="nc" id="L9383">                mgr = getCookieManager();</span>
<span class="nc" id="L9384">            } catch(IllegalStateException ex) {</span>
<span class="nc" id="L9385">                syncer = CookieSyncManager.createInstance(this.getContext());</span>
<span class="nc" id="L9386">                mgr = getCookieManager();</span>
<span class="nc" id="L9387">            }</span>
<span class="nc" id="L9388">            java.text.SimpleDateFormat format = new java.text.SimpleDateFormat(&quot;EEE, dd-MMM-yyyy HH:mm:ss z&quot;);</span>
<span class="nc" id="L9389">            format.setTimeZone(TimeZone.getTimeZone(&quot;GMT&quot;));</span>
<span class="nc" id="L9390">            addCookie(c, mgr, format);</span>
<span class="nc bnc" id="L9391" title="All 2 branches missed.">            if(sync) {</span>
<span class="nc" id="L9392">                syncer.sync();</span>
            }
        }
<span class="nc" id="L9395">        super.addCookie(c);</span>



<span class="nc" id="L9399">    }</span>

    private void addCookie(Cookie c, CookieManager mgr, java.text.SimpleDateFormat format) {

<span class="nc" id="L9403">        String d = c.getDomain();</span>
<span class="nc" id="L9404">        String port = &quot;&quot;;</span>
<span class="nc bnc" id="L9405" title="All 2 branches missed.">        if (d.contains(&quot;:&quot;)) {</span>
            // For some reason, the port must be stripped and stored separately
            // or it won't retrieve it properly.
            // https://github.com/codenameone/CodenameOne/issues/2804
<span class="nc" id="L9409">            port = &quot;; Port=&quot; + d.substring(d.indexOf(&quot;:&quot;)+1);</span>
<span class="nc" id="L9410">            d = d.substring(0, d.indexOf(&quot;:&quot;));</span>
        }
<span class="nc" id="L9412">        String cookieString = c.getName() + &quot;=&quot; + c.getValue() +</span>
                &quot;; Domain=&quot; + d +
                port +
<span class="nc" id="L9415">                &quot;; Path=&quot; + c.getPath() +</span>
<span class="nc bnc" id="L9416" title="All 2 branches missed.">                &quot;; &quot; + (c.isSecure() ? &quot;Secure;&quot; : &quot;&quot;)</span>
<span class="nc bnc" id="L9417" title="All 2 branches missed.">                + (c.getExpires() != 0 ? (&quot; Expires=&quot;+format.format(new Date(c.getExpires()))+&quot;;&quot;) : &quot;&quot;)</span>
<span class="nc bnc" id="L9418" title="All 2 branches missed.">                + (c.isHttpOnly() ? &quot;httpOnly;&quot; : &quot;&quot;);</span>
<span class="nc" id="L9419">        String cookieUrl = &quot;http&quot; +</span>
<span class="nc bnc" id="L9420" title="All 2 branches missed.">                (c.isSecure() ? &quot;s&quot; : &quot;&quot;) + &quot;://&quot; +</span>
                d +
<span class="nc" id="L9422">                c.getPath();</span>
<span class="nc" id="L9423">        mgr.setCookie(cookieUrl, cookieString);</span>
<span class="nc" id="L9424">    }</span>

    public void addCookie(Cookie[] cs, boolean addToWebViewCookieManager, boolean sync) {
<span class="nc bnc" id="L9427" title="All 2 branches missed.">        if(addToWebViewCookieManager) {</span>
            CookieManager mgr;
            CookieSyncManager syncer;
            try {
<span class="nc" id="L9431">                syncer = CookieSyncManager.getInstance();</span>
<span class="nc" id="L9432">                mgr = getCookieManager();</span>
<span class="nc" id="L9433">            } catch(IllegalStateException ex) {</span>
<span class="nc" id="L9434">                syncer = CookieSyncManager.createInstance(this.getContext());</span>
<span class="nc" id="L9435">                mgr = getCookieManager();</span>
<span class="nc" id="L9436">            }</span>
<span class="nc" id="L9437">            java.text.SimpleDateFormat format = new java.text.SimpleDateFormat(&quot;EEE, dd-MMM-yyyy HH:mm:ss z&quot;);</span>
<span class="nc" id="L9438">            format.setTimeZone(TimeZone.getTimeZone(&quot;GMT&quot;));</span>

<span class="nc bnc" id="L9440" title="All 2 branches missed.">            for (Cookie c : cs) {</span>
<span class="nc" id="L9441">                addCookie(c, mgr, format);</span>

            }

<span class="nc bnc" id="L9445" title="All 2 branches missed.">            if(sync) {</span>
<span class="nc" id="L9446">                syncer.sync();</span>
            }
        }
<span class="nc" id="L9449">        super.addCookie(cs);</span>



<span class="nc" id="L9453">    }</span>

    @Override
    public void addCookie(Cookie c) {
<span class="nc bnc" id="L9457" title="All 2 branches missed.">        if(isUseNativeCookieStore()) {</span>
<span class="nc" id="L9458">            this.addCookie(c, true, true);</span>
        } else {
<span class="nc" id="L9460">            super.addCookie(c);</span>
        }
<span class="nc" id="L9462">    }</span>



    @Override
    public void addCookie(Cookie[] cookiesArray) {
<span class="nc bnc" id="L9468" title="All 2 branches missed.">        if(isUseNativeCookieStore()) {</span>
<span class="nc" id="L9469">            this.addCookie(cookiesArray, true);</span>
        } else {
<span class="nc" id="L9471">            super.addCookie(cookiesArray);</span>
        }
<span class="nc" id="L9473">    }</span>

    public void addCookie(Cookie[] cookiesArray, boolean addToWebViewCookieManager){
<span class="nc" id="L9476">        addCookie(cookiesArray, addToWebViewCookieManager, false);</span>

<span class="nc" id="L9478">    }</span>



<span class="nc" id="L9482">    class CodeScannerImpl extends CodeScanner implements IntentResultListener {</span>
        private ScanResult callback;

        @Override
        public void scanQRCode(ScanResult callback) {
<span class="nc bnc" id="L9487" title="All 2 branches missed.">            if (getActivity() == null) {</span>
<span class="nc" id="L9488">                return;</span>
            }
<span class="nc bnc" id="L9490" title="All 2 branches missed.">            if (getActivity() instanceof CodenameOneActivity) {</span>
<span class="nc" id="L9491">                ((CodenameOneActivity) getActivity()).setIntentResultListener(this);</span>
            }
<span class="nc" id="L9493">            this.callback = callback;</span>
<span class="nc" id="L9494">            IntentIntegrator in = new IntentIntegrator(getActivity());</span>
<span class="nc bnc" id="L9495" title="All 2 branches missed.">            if(!in.initiateScan(IntentIntegrator.QR_CODE_TYPES, &quot;QR_CODE_MODE&quot;)){</span>
                // restore old activity handling
<span class="nc" id="L9497">                Display.getInstance().callSerially(new Runnable() {</span>
                    @Override
                    public void run() {
<span class="nc bnc" id="L9500" title="All 4 branches missed.">                        if(CodeScannerImpl.this != null &amp;&amp; CodeScannerImpl.this.callback != null) {</span>
<span class="nc" id="L9501">                            CodeScannerImpl.this.callback.scanError(-1, &quot;no scan app&quot;);</span>
<span class="nc" id="L9502">                            CodeScannerImpl.this.callback = null;</span>
                        }
<span class="nc" id="L9504">                    }</span>
                });

<span class="nc bnc" id="L9507" title="All 2 branches missed.">                if (getActivity() instanceof CodenameOneActivity) {</span>
<span class="nc" id="L9508">                    ((CodenameOneActivity) getActivity()).restoreIntentResultListener();</span>
                }
            }
<span class="nc" id="L9511">        }</span>

        @Override
        public void scanBarCode(ScanResult callback) {
<span class="nc bnc" id="L9515" title="All 2 branches missed.">            if (getActivity() == null) {</span>
<span class="nc" id="L9516">                return;</span>
            }
<span class="nc bnc" id="L9518" title="All 2 branches missed.">            if (getActivity() instanceof CodenameOneActivity) {</span>
<span class="nc" id="L9519">                ((CodenameOneActivity) getActivity()).setIntentResultListener(this);</span>
            }
<span class="nc" id="L9521">            this.callback = callback;</span>
<span class="nc" id="L9522">            IntentIntegrator in = new IntentIntegrator(getActivity());</span>
<span class="nc" id="L9523">            Collection&lt;String&gt; types = IntentIntegrator.PRODUCT_CODE_TYPES;</span>
<span class="nc bnc" id="L9524" title="All 2 branches missed.">            if(Display.getInstance().getProperty(&quot;scanAllCodeTypes&quot;, &quot;false&quot;).equals(&quot;true&quot;)) {</span>
<span class="nc" id="L9525">                types = IntentIntegrator.ALL_CODE_TYPES;</span>
            }
<span class="nc bnc" id="L9527" title="All 2 branches missed.">            if(Display.getInstance().getProperty(&quot;android.scanTypes&quot;, null) != null) {</span>
<span class="nc" id="L9528">                String[] arr = Display.getInstance().getProperty(&quot;android.scanTypes&quot;, null).split(&quot;;&quot;);</span>
<span class="nc" id="L9529">                types = Arrays.asList(arr);</span>
            }

<span class="nc bnc" id="L9532" title="All 2 branches missed.">            if(!in.initiateScan(types, &quot;ONE_D_MODE&quot;)){</span>
                // restore old activity handling
<span class="nc" id="L9534">                Display.getInstance().callSerially(new Runnable() {</span>
                    @Override
                    public void run() {
<span class="nc" id="L9537">                        CodeScannerImpl.this.callback.scanError(-1, &quot;no scan app&quot;);</span>
<span class="nc" id="L9538">                        CodeScannerImpl.this.callback = null;</span>
<span class="nc" id="L9539">                    }</span>
                });

<span class="nc bnc" id="L9542" title="All 2 branches missed.">                if (getActivity() instanceof CodenameOneActivity) {</span>
<span class="nc" id="L9543">                    ((CodenameOneActivity) getActivity()).restoreIntentResultListener();</span>
                }
            }
<span class="nc" id="L9546">        }</span>

        public void onActivityResult(int requestCode, final int resultCode, Intent data) {
<span class="nc bnc" id="L9549" title="All 4 branches missed.">            if (requestCode == IntentIntegrator.REQUEST_CODE &amp;&amp; callback != null) {</span>
<span class="nc" id="L9550">                final ScanResult sr = callback;</span>
<span class="nc bnc" id="L9551" title="All 2 branches missed.">                if (resultCode == Activity.RESULT_OK) {</span>
<span class="nc" id="L9552">                    final String contents = data.getStringExtra(&quot;SCAN_RESULT&quot;);</span>
<span class="nc" id="L9553">                    final String formatName = data.getStringExtra(&quot;SCAN_RESULT_FORMAT&quot;);</span>
<span class="nc" id="L9554">                    final byte[] rawBytes = data.getByteArrayExtra(&quot;SCAN_RESULT_BYTES&quot;);</span>
<span class="nc" id="L9555">                    Display.getInstance().callSerially(new Runnable() {</span>
                        @Override
                        public void run() {
<span class="nc" id="L9558">                            sr.scanCompleted(contents, formatName, rawBytes);</span>
<span class="nc" id="L9559">                        }</span>
                    });
<span class="nc bnc" id="L9561" title="All 2 branches missed.">                } else if(resultCode == Activity.RESULT_CANCELED) {</span>
<span class="nc" id="L9562">                    Display.getInstance().callSerially(new Runnable() {</span>
                        @Override
                        public void run() {
<span class="nc" id="L9565">                            sr.scanCanceled();</span>
<span class="nc" id="L9566">                        }</span>
                    });

                } else {
<span class="nc" id="L9570">                    Display.getInstance().callSerially(new Runnable() {</span>
                        @Override
                        public void run() {
<span class="nc" id="L9573">                            sr.scanError(resultCode, null);</span>
<span class="nc" id="L9574">                        }</span>
                    });
                }
<span class="nc" id="L9577">                callback = null;</span>
            }

            // restore old activity handling
<span class="nc bnc" id="L9581" title="All 2 branches missed.">            if (getActivity() instanceof CodenameOneActivity) {</span>
<span class="nc" id="L9582">                ((CodenameOneActivity) getActivity()).restoreIntentResultListener();</span>
            }
<span class="nc" id="L9584">        }</span>
    }

    public boolean hasCamera() {
        try {
<span class="nc" id="L9589">            int numCameras = Camera.getNumberOfCameras();</span>
<span class="nc bnc" id="L9590" title="All 2 branches missed.">            return numCameras &gt; 0;</span>
<span class="nc" id="L9591">        } catch(Throwable t) {</span>
<span class="nc" id="L9592">            return true;</span>
        }
    }

    public String getCurrentAccessPoint() {

<span class="nc" id="L9598">        ConnectivityManager cm = (ConnectivityManager) getContext().getSystemService(Context.CONNECTIVITY_SERVICE);</span>
<span class="nc" id="L9599">        NetworkInfo info = cm.getActiveNetworkInfo();</span>
<span class="nc bnc" id="L9600" title="All 2 branches missed.">        if (info == null) {</span>
<span class="nc" id="L9601">            return null;</span>
        }
<span class="nc" id="L9603">        String apName = info.getTypeName() + &quot;_&quot; + info.getSubtypeName();</span>
<span class="nc bnc" id="L9604" title="All 2 branches missed.">        if (info.getExtraInfo() != null) {</span>
<span class="nc" id="L9605">            apName += &quot;_&quot; + info.getExtraInfo();</span>
        }
<span class="nc" id="L9607">        return apName;</span>
    }

    @Override
    public boolean isVPNDetectionSupported() {
<span class="fc" id="L9612">        return true;</span>
    }

    @Override
    public boolean isVPNActive() {
        try {
<span class="fc" id="L9618">            ConnectivityManager cm = (ConnectivityManager) getContext().getSystemService(Context.CONNECTIVITY_SERVICE);</span>
<span class="pc bpc" id="L9619" title="2 of 4 branches missed.">            if (cm != null &amp;&amp; Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) {</span>
<span class="nc" id="L9620">                android.net.Network network = cm.getActiveNetwork();</span>
<span class="nc bnc" id="L9621" title="All 2 branches missed.">                if (network != null) {</span>
<span class="nc" id="L9622">                    android.net.NetworkCapabilities capabilities = cm.getNetworkCapabilities(network);</span>
<span class="nc bnc" id="L9623" title="All 4 branches missed.">                    if (capabilities != null &amp;&amp; capabilities.hasTransport(android.net.NetworkCapabilities.TRANSPORT_VPN)) {</span>
<span class="nc" id="L9624">                        return true;</span>
                    }
                }
            }

<span class="nc" id="L9629">            Enumeration&lt;NetworkInterface&gt; interfaces = NetworkInterface.getNetworkInterfaces();</span>
<span class="nc bnc" id="L9630" title="All 4 branches missed.">            while (interfaces != null &amp;&amp; interfaces.hasMoreElements()) {</span>
<span class="nc" id="L9631">                NetworkInterface current = interfaces.nextElement();</span>
<span class="nc bnc" id="L9632" title="All 4 branches missed.">                if (!current.isUp() || current.isLoopback()) {</span>
<span class="nc" id="L9633">                    continue;</span>
                }
<span class="nc" id="L9635">                String name = current.getName();</span>
<span class="nc bnc" id="L9636" title="All 2 branches missed.">                if (name == null) {</span>
<span class="nc" id="L9637">                    continue;</span>
                }
<span class="nc" id="L9639">                name = name.toLowerCase(Locale.US);</span>
<span class="nc bnc" id="L9640" title="All 8 branches missed.">                if (name.startsWith(&quot;tun&quot;) || name.startsWith(&quot;ppp&quot;) || name.startsWith(&quot;tap&quot;) || name.startsWith(&quot;ipsec&quot;)) {</span>
<span class="nc" id="L9641">                    return true;</span>
                }
<span class="nc" id="L9643">            }</span>
<span class="fc" id="L9644">        } catch (Throwable t) {</span>
<span class="fc" id="L9645">            Log.d(&quot;Codename One&quot;, &quot;VPN detection failed&quot;, t);</span>
<span class="nc" id="L9646">        }</span>
<span class="fc" id="L9647">        return false;</span>
    }

    /**
     * @inheritDoc
     */
    public String[] getAPIds() {
<span class="nc bnc" id="L9654" title="All 2 branches missed.">        if (apIds == null) {</span>
<span class="nc" id="L9655">            apIds = new HashMap();</span>
<span class="nc" id="L9656">            NetworkInfo[] aps = ((ConnectivityManager) getContext().getSystemService(Context.CONNECTIVITY_SERVICE)).getAllNetworkInfo();</span>
<span class="nc bnc" id="L9657" title="All 2 branches missed.">            for (int i = 0; i &lt; aps.length; i++) {</span>
<span class="nc" id="L9658">                String apName = aps[i].getTypeName() + &quot;_&quot; + aps[i].getSubtypeName();</span>
<span class="nc bnc" id="L9659" title="All 2 branches missed.">                if (aps[i].getExtraInfo() != null) {</span>
<span class="nc" id="L9660">                    apName += &quot;_&quot; + aps[i].getExtraInfo();</span>
                }
<span class="nc" id="L9662">                apIds.put(apName, aps[i]);</span>
            }
        }
<span class="nc bnc" id="L9665" title="All 2 branches missed.">        if (apIds.isEmpty()) {</span>
<span class="nc" id="L9666">            return null;</span>
        }
<span class="nc" id="L9668">        String[] ret = new String[apIds.size()];</span>
<span class="nc" id="L9669">        Iterator iter = apIds.keySet().iterator();</span>
<span class="nc bnc" id="L9670" title="All 2 branches missed.">        for (int i = 0; iter.hasNext(); i++) {</span>
<span class="nc" id="L9671">            ret[i] = iter.next().toString();</span>
        }
<span class="nc" id="L9673">        return ret;</span>

    }

    /**
     * @inheritDoc
     */
    public int getAPType(String id) {
<span class="nc bnc" id="L9681" title="All 2 branches missed.">        if (apIds == null) {</span>
<span class="nc" id="L9682">            getAPIds();</span>
        }
<span class="nc" id="L9684">        NetworkInfo info = (NetworkInfo) apIds.get(id);</span>
<span class="nc bnc" id="L9685" title="All 2 branches missed.">        if (info == null) {</span>
<span class="nc" id="L9686">            return NetworkManager.ACCESS_POINT_TYPE_UNKNOWN;</span>
        }
<span class="nc" id="L9688">        int type = info.getType();</span>
<span class="nc" id="L9689">        int subType = info.getSubtype();</span>
<span class="nc bnc" id="L9690" title="All 2 branches missed.">        if (type == ConnectivityManager.TYPE_WIFI) {</span>
<span class="nc" id="L9691">            return NetworkManager.ACCESS_POINT_TYPE_WLAN;</span>
<span class="nc bnc" id="L9692" title="All 2 branches missed.">        } else if (type == ConnectivityManager.TYPE_MOBILE) {</span>
<span class="nc bnc" id="L9693" title="All 16 branches missed.">            switch (subType) {</span>
                case TelephonyManager.NETWORK_TYPE_1xRTT:
<span class="nc" id="L9695">                    return NetworkManager.ACCESS_POINT_TYPE_NETWORK2G; // ~ 50-100 kbps</span>
                case TelephonyManager.NETWORK_TYPE_CDMA:
<span class="nc" id="L9697">                    return NetworkManager.ACCESS_POINT_TYPE_NETWORK2G; // ~ 14-64 kbps</span>
                case TelephonyManager.NETWORK_TYPE_EDGE:
<span class="nc" id="L9699">                    return NetworkManager.ACCESS_POINT_TYPE_NETWORK2G; // ~ 50-100 kbps</span>
                case TelephonyManager.NETWORK_TYPE_EVDO_0:
<span class="nc" id="L9701">                    return NetworkManager.ACCESS_POINT_TYPE_NETWORK3G; // ~ 400-1000 kbps</span>
                case TelephonyManager.NETWORK_TYPE_EVDO_A:
<span class="nc" id="L9703">                    return NetworkManager.ACCESS_POINT_TYPE_NETWORK3G; // ~ 600-1400 kbps</span>
                case TelephonyManager.NETWORK_TYPE_GPRS:
<span class="nc" id="L9705">                    return NetworkManager.ACCESS_POINT_TYPE_NETWORK2G; // ~ 100 kbps</span>
                case TelephonyManager.NETWORK_TYPE_HSDPA:
<span class="nc" id="L9707">                    return NetworkManager.ACCESS_POINT_TYPE_NETWORK3G; // ~ 2-14 Mbps</span>
                case TelephonyManager.NETWORK_TYPE_HSPA:
<span class="nc" id="L9709">                    return NetworkManager.ACCESS_POINT_TYPE_NETWORK3G; // ~ 700-1700 kbps</span>
                case TelephonyManager.NETWORK_TYPE_HSUPA:
<span class="nc" id="L9711">                    return NetworkManager.ACCESS_POINT_TYPE_NETWORK3G; // ~ 1-23 Mbps</span>
                case TelephonyManager.NETWORK_TYPE_UMTS:
<span class="nc" id="L9713">                    return NetworkManager.ACCESS_POINT_TYPE_NETWORK3G; // ~ 400-7000 kbps</span>
            /*
                 * Above API level 7, make sure to set android:targetSdkVersion
                 * to appropriate level to use these
                 */
                case TelephonyManager.NETWORK_TYPE_EHRPD: // API level 11
<span class="nc" id="L9719">                    return NetworkManager.ACCESS_POINT_TYPE_NETWORK3G; // ~ 1-2 Mbps</span>
                case TelephonyManager.NETWORK_TYPE_EVDO_B: // API level 9
<span class="nc" id="L9721">                    return NetworkManager.ACCESS_POINT_TYPE_NETWORK3G; // ~ 5 Mbps</span>
                case TelephonyManager.NETWORK_TYPE_HSPAP: // API level 13
<span class="nc" id="L9723">                    return NetworkManager.ACCESS_POINT_TYPE_NETWORK3G; // ~ 10-20 Mbps</span>
                case TelephonyManager.NETWORK_TYPE_IDEN: // API level 8
<span class="nc" id="L9725">                    return NetworkManager.ACCESS_POINT_TYPE_NETWORK2G; // ~25 kbps</span>
                case TelephonyManager.NETWORK_TYPE_LTE: // API level 11
<span class="nc" id="L9727">                    return NetworkManager.ACCESS_POINT_TYPE_NETWORK3G; // ~ 10+ Mbps</span>
                // Unknown
                case TelephonyManager.NETWORK_TYPE_UNKNOWN:
                default:
<span class="nc" id="L9731">                    return NetworkManager.ACCESS_POINT_TYPE_NETWORK2G;</span>
            }
        } else {
<span class="nc" id="L9734">            return NetworkManager.ACCESS_POINT_TYPE_UNKNOWN;</span>
        }
    }

    /**
     * @inheritDoc
     */
    public void setCurrentAccessPoint(String id) {

<span class="nc bnc" id="L9743" title="All 2 branches missed.">        if (apIds == null) {</span>
<span class="nc" id="L9744">            getAPIds();</span>
        }
<span class="nc" id="L9746">        NetworkInfo info = (NetworkInfo) apIds.get(id);</span>
<span class="nc bnc" id="L9747" title="All 4 branches missed.">        if (info == null || info.isConnectedOrConnecting()) {</span>
<span class="nc" id="L9748">            return;</span>

        }
<span class="nc" id="L9751">        ConnectivityManager cm = (ConnectivityManager) getContext().getSystemService(Context.CONNECTIVITY_SERVICE);</span>
<span class="nc" id="L9752">        cm.setNetworkPreference(info.getType());</span>
<span class="nc" id="L9753">    }</span>

    private void scanMedia(File file) {
<span class="nc" id="L9756">        Uri uri = Uri.fromFile(file);</span>
<span class="nc" id="L9757">        Intent scanFileIntent = new Intent(</span>
                Intent.ACTION_MEDIA_SCANNER_SCAN_FILE, uri);
<span class="nc" id="L9759">        getActivity().sendBroadcast(scanFileIntent);</span>
<span class="nc" id="L9760">    }</span>

    /**
     * Gets the last image id from the media store
     *
     * @return
     */
    private String getLastImageId() {
<span class="nc" id="L9768">        int idVal = 0;;</span>
<span class="nc" id="L9769">        final String[] imageColumns = {MediaStore.Images.Media._ID};</span>
<span class="nc" id="L9770">        final String imageOrderBy = MediaStore.Images.Media._ID + &quot; DESC&quot;;</span>
<span class="nc" id="L9771">        final String imageWhere = null;</span>
<span class="nc" id="L9772">        final String[] imageArguments = null;</span>
<span class="nc" id="L9773">        Cursor imageCursor = getContext().getContentResolver().query(MediaStore.Images.Media.EXTERNAL_CONTENT_URI, imageColumns, imageWhere, imageArguments, imageOrderBy);</span>
<span class="nc bnc" id="L9774" title="All 2 branches missed.">        if (imageCursor.moveToFirst()) {</span>
<span class="nc" id="L9775">            int id = imageCursor.getInt(imageCursor.getColumnIndex(MediaStore.Images.Media._ID));</span>
<span class="nc" id="L9776">            imageCursor.close();</span>
<span class="nc" id="L9777">            idVal = id;</span>
        }
<span class="nc" id="L9779">        return &quot;&quot; + idVal;</span>
    }

    private void clearMediaDB(String lastId, String capturePath) {
<span class="nc" id="L9783">        final String[] imageColumns = {MediaStore.Images.Media.DATA, MediaStore.Images.Media.DATE_TAKEN, MediaStore.Images.Media.SIZE, MediaStore.Images.Media._ID};</span>
<span class="nc" id="L9784">        final String imageOrderBy = MediaStore.Images.Media._ID + &quot; DESC&quot;;</span>
<span class="nc" id="L9785">        final String imageWhere = MediaStore.Images.Media._ID + &quot;&gt;?&quot;;</span>
<span class="nc" id="L9786">        final String[] imageArguments = {lastId};</span>
<span class="nc" id="L9787">        Cursor imageCursor = getContext().getContentResolver().query(MediaStore.Images.Media.EXTERNAL_CONTENT_URI, imageColumns, imageWhere, imageArguments, imageOrderBy);</span>
<span class="nc bnc" id="L9788" title="All 2 branches missed.">        if (imageCursor.getCount() &gt; 1) {</span>
<span class="nc bnc" id="L9789" title="All 2 branches missed.">            while (imageCursor.moveToNext()) {</span>
<span class="nc" id="L9790">                int id = imageCursor.getInt(imageCursor.getColumnIndex(MediaStore.Images.Media._ID));</span>
<span class="nc" id="L9791">                String path = imageCursor.getString(imageCursor.getColumnIndex(MediaStore.Images.Media.DATA));</span>
<span class="nc" id="L9792">                Long takenTimeStamp = imageCursor.getLong(imageCursor.getColumnIndex(MediaStore.Images.Media.DATE_TAKEN));</span>
<span class="nc" id="L9793">                Long size = imageCursor.getLong(imageCursor.getColumnIndex(MediaStore.Images.Media.SIZE));</span>
<span class="nc bnc" id="L9794" title="All 2 branches missed.">                if (path.contentEquals(capturePath)) {</span>
                    // Remove it
<span class="nc" id="L9796">                    ContentResolver cr = getContext().getContentResolver();</span>
<span class="nc" id="L9797">                    cr.delete(MediaStore.Images.Media.EXTERNAL_CONTENT_URI, MediaStore.Images.Media._ID + &quot;=?&quot;, new String[]{Long.toString(id)});</span>
<span class="nc" id="L9798">                    break;</span>
                }
<span class="nc" id="L9800">            }</span>
        }
<span class="nc" id="L9802">        imageCursor.close();</span>
<span class="nc" id="L9803">    }</span>


    @Override
    public boolean isNativePickerTypeSupported(int pickerType) {
<span class="nc bnc" id="L9808" title="All 2 branches missed.">        if(android.os.Build.VERSION.SDK_INT &gt;= 11) {</span>
<span class="nc bnc" id="L9809" title="All 6 branches missed.">            return pickerType == Display.PICKER_TYPE_DATE || pickerType == Display.PICKER_TYPE_TIME || pickerType == Display.PICKER_TYPE_STRINGS;</span>
        }
<span class="nc bnc" id="L9811" title="All 4 branches missed.">        return pickerType == Display.PICKER_TYPE_DATE || pickerType == Display.PICKER_TYPE_TIME;</span>
    }

    @Override
    public Object showNativePicker(final int type, final Component source, final Object currentValue, final Object data) {
<span class="nc bnc" id="L9816" title="All 2 branches missed.">        if (getActivity() == null) {</span>
<span class="nc" id="L9817">            return null;</span>
        }
<span class="nc" id="L9819">        final boolean [] canceled = new boolean[1];</span>
<span class="nc" id="L9820">        final boolean [] dismissed = new boolean[1];</span>

<span class="nc bnc" id="L9822" title="All 2 branches missed.">        if(editInProgress()) {</span>
<span class="nc" id="L9823">            stopEditing(true);</span>
        }
<span class="nc bnc" id="L9825" title="All 2 branches missed.">        if(type == Display.PICKER_TYPE_TIME) {</span>

<span class="nc" id="L9827">            class TimePick implements TimePickerDialog.OnTimeSetListener, TimePickerDialog.OnCancelListener, Runnable {</span>
<span class="nc" id="L9828">                int result = ((Integer)currentValue).intValue();</span>
                public void onTimeSet(TimePicker tp, int hour, int minute) {
<span class="nc" id="L9830">                    result = hour * 60 + minute;</span>
<span class="nc" id="L9831">                    dismissed[0] = true;</span>
<span class="nc" id="L9832">                    synchronized(this) {</span>
<span class="nc" id="L9833">                        notify();</span>
<span class="nc" id="L9834">                    }</span>
<span class="nc" id="L9835">                }</span>

                public void run() {
<span class="nc bnc" id="L9838" title="All 2 branches missed.">                    while(!dismissed[0]) {</span>
<span class="nc" id="L9839">                        synchronized(this) {</span>
                            try {
<span class="nc" id="L9841">                                wait(50);</span>
<span class="nc" id="L9842">                            } catch(InterruptedException er) {}</span>
<span class="nc" id="L9843">                        }</span>
                    }
<span class="nc" id="L9845">                }</span>

                @Override
                public void onCancel(DialogInterface di) {
<span class="nc" id="L9849">                    dismissed[0] = true;</span>
<span class="nc" id="L9850">                    canceled[0] = true;</span>
<span class="nc" id="L9851">                    synchronized (this) {</span>
<span class="nc" id="L9852">                        notify();</span>
<span class="nc" id="L9853">                    }</span>
<span class="nc" id="L9854">                }</span>
            }
<span class="nc" id="L9856">            final TimePick pickInstance = new TimePick();</span>
<span class="nc" id="L9857">            getActivity().runOnUiThread(new Runnable() {</span>
                public void run() {
<span class="nc" id="L9859">                    int hour = ((Integer)currentValue).intValue() / 60;</span>
<span class="nc" id="L9860">                    int minute = ((Integer)currentValue).intValue() % 60;</span>
<span class="nc" id="L9861">                    TimePickerDialog tp = new TimePickerDialog(getActivity(), pickInstance, hour, minute, true){</span>

                        @Override
                        public void cancel() {
<span class="nc" id="L9865">                            super.cancel();</span>
<span class="nc" id="L9866">                            dismissed[0] = true;</span>
<span class="nc" id="L9867">                            canceled[0] = true;</span>
<span class="nc" id="L9868">                        }</span>

                        @Override
                        public void dismiss() {
<span class="nc" id="L9872">                            super.dismiss();</span>
<span class="nc" id="L9873">                            dismissed[0] = true;</span>
<span class="nc" id="L9874">                        }</span>

                    };
<span class="nc" id="L9877">                    tp.setOnCancelListener(pickInstance);</span>
                    //DateFormat.is24HourFormat(activity));
<span class="nc" id="L9879">                    tp.show();</span>
<span class="nc" id="L9880">                }</span>
            });
<span class="nc" id="L9882">            Display.getInstance().invokeAndBlock(pickInstance);</span>
<span class="nc bnc" id="L9883" title="All 2 branches missed.">            if(canceled[0]) {</span>
<span class="nc" id="L9884">                return null;</span>
            }
<span class="nc" id="L9886">            return new Integer(pickInstance.result);</span>
        }
<span class="nc bnc" id="L9888" title="All 2 branches missed.">        if(type == Display.PICKER_TYPE_DATE) {</span>
<span class="nc" id="L9889">            final java.util.Calendar cl = java.util.Calendar.getInstance();</span>
<span class="nc bnc" id="L9890" title="All 2 branches missed.">            if(currentValue != null) {</span>
<span class="nc" id="L9891">                cl.setTime((Date)currentValue);</span>
            }
<span class="nc" id="L9893">            class DatePick implements DatePickerDialog.OnDateSetListener,DatePickerDialog.OnCancelListener, Runnable {</span>
<span class="nc" id="L9894">                Date result = (Date)currentValue;</span>

                public void onDateSet(DatePicker dp, int year, int month, int day) {
<span class="nc" id="L9897">                    java.util.Calendar c = java.util.Calendar.getInstance();</span>
<span class="nc" id="L9898">                    c.set(java.util.Calendar.YEAR, year);</span>
<span class="nc" id="L9899">                    c.set(java.util.Calendar.MONTH, month);</span>
<span class="nc" id="L9900">                    c.set(java.util.Calendar.DAY_OF_MONTH, day);</span>
<span class="nc" id="L9901">                    result = c.getTime();</span>
<span class="nc" id="L9902">                    dismissed[0] = true;</span>
<span class="nc" id="L9903">                    synchronized(this) {</span>
<span class="nc" id="L9904">                        notify();</span>
<span class="nc" id="L9905">                    }</span>
<span class="nc" id="L9906">                }</span>

                public void run() {
<span class="nc bnc" id="L9909" title="All 2 branches missed.">                    while(!dismissed[0]) {</span>
<span class="nc" id="L9910">                        synchronized(this) {</span>
                            try {
<span class="nc" id="L9912">                                wait(50);</span>
<span class="nc" id="L9913">                            } catch(InterruptedException er) {}</span>
<span class="nc" id="L9914">                        }</span>
                    }
<span class="nc" id="L9916">                }</span>

                public void onCancel(DialogInterface di) {
<span class="nc" id="L9919">                    result = null;</span>
<span class="nc" id="L9920">                    dismissed[0] = true;</span>
<span class="nc" id="L9921">                    canceled[0] = true;</span>
<span class="nc" id="L9922">                    synchronized(this) {</span>
<span class="nc" id="L9923">                        notify();</span>
<span class="nc" id="L9924">                    }</span>
<span class="nc" id="L9925">                }</span>
            }
<span class="nc" id="L9927">            final DatePick pickInstance = new DatePick();</span>
<span class="nc" id="L9928">            getActivity().runOnUiThread(new Runnable() {</span>
                public void run() {
<span class="nc" id="L9930">                    DatePickerDialog tp = new DatePickerDialog(getActivity(), pickInstance, cl.get(java.util.Calendar.YEAR), cl.get(java.util.Calendar.MONTH), cl.get(java.util.Calendar.DAY_OF_MONTH)){</span>

                        @Override
                        public void cancel() {
<span class="nc" id="L9934">                            super.cancel();</span>
<span class="nc" id="L9935">                            dismissed[0] = true;</span>
<span class="nc" id="L9936">                            canceled[0] = true;</span>
<span class="nc" id="L9937">                        }</span>

                        @Override
                        public void dismiss() {
<span class="nc" id="L9941">                            super.dismiss();</span>
<span class="nc" id="L9942">                            dismissed[0] = true;</span>
<span class="nc" id="L9943">                        }</span>

                    };
<span class="nc" id="L9946">                    tp.setOnCancelListener(pickInstance);</span>
<span class="nc" id="L9947">                    tp.show();</span>
<span class="nc" id="L9948">                }</span>
            });
<span class="nc" id="L9950">            Display.getInstance().invokeAndBlock(pickInstance);</span>
<span class="nc" id="L9951">            return pickInstance.result;</span>
        }
<span class="nc bnc" id="L9953" title="All 2 branches missed.">        if(type == Display.PICKER_TYPE_STRINGS) {</span>
<span class="nc" id="L9954">            final String[] values = (String[])data;</span>
            class StringPick implements Runnable, NumberPicker.OnValueChangeListener {
<span class="nc" id="L9956">                int result = -1;</span>

<span class="nc" id="L9958">                StringPick() {</span>
<span class="nc" id="L9959">                }</span>

                public void run() {
<span class="nc bnc" id="L9962" title="All 2 branches missed.">                    while(!dismissed[0]) {</span>
<span class="nc" id="L9963">                        synchronized(this) {</span>
                            try {
<span class="nc" id="L9965">                                wait(50);</span>
<span class="nc" id="L9966">                            } catch(InterruptedException er) {}</span>
<span class="nc" id="L9967">                        }</span>
                    }
<span class="nc" id="L9969">                }</span>

                public void cancel() {
<span class="nc" id="L9972">                    dismissed[0] = true;</span>
<span class="nc" id="L9973">                    canceled[0] = true;</span>
<span class="nc" id="L9974">                    synchronized(this) {</span>
<span class="nc" id="L9975">                        notify();</span>
<span class="nc" id="L9976">                    }</span>
<span class="nc" id="L9977">                }</span>

                public void ok() {
<span class="nc" id="L9980">                    canceled[0] = false;</span>
<span class="nc" id="L9981">                    dismissed[0] = true;</span>
<span class="nc" id="L9982">                    synchronized(this) {</span>
<span class="nc" id="L9983">                        notify();</span>
<span class="nc" id="L9984">                    }</span>
<span class="nc" id="L9985">                }</span>

                @Override
                public void onValueChange(NumberPicker np, int oldVal, int newVal) {
<span class="nc" id="L9989">                    result = newVal;</span>
<span class="nc" id="L9990">                }</span>
            }

<span class="nc" id="L9993">            final StringPick pickInstance = new StringPick();</span>
<span class="nc bnc" id="L9994" title="All 2 branches missed.">            for(int iter = 0 ; iter &lt; values.length ; iter++) {</span>
<span class="nc bnc" id="L9995" title="All 2 branches missed.">                if(values[iter].equals(currentValue)) {</span>
<span class="nc" id="L9996">                    pickInstance.result = iter;</span>
<span class="nc" id="L9997">                    break;</span>
                }
            }
<span class="nc bnc" id="L10000" title="All 4 branches missed.">            if (pickInstance.result == -1 &amp;&amp; values.length &gt; 0) {</span>
                // The picker will default to showing the first element anyways
                // If we don't set the result to 0, then the user has to first
                // scroll to a different number, then back to the first option
                // to pick the first option.
<span class="nc" id="L10005">                pickInstance.result = 0;</span>
            }

<span class="nc" id="L10008">            getActivity().runOnUiThread(new Runnable() {</span>
                public void run() {
<span class="nc" id="L10010">                    NumberPicker picker = new NumberPicker(getActivity());</span>
<span class="nc bnc" id="L10011" title="All 2 branches missed.">                    if(source.getClientProperty(&quot;showKeyboard&quot;) == null) {</span>
<span class="nc" id="L10012">                        picker.setDescendantFocusability(NumberPicker.FOCUS_BLOCK_DESCENDANTS);</span>
                    }
<span class="nc" id="L10014">                    picker.setMinValue(0);</span>
<span class="nc" id="L10015">                    picker.setMaxValue(values.length - 1);</span>
<span class="nc" id="L10016">                    picker.setDisplayedValues(values);</span>
<span class="nc" id="L10017">                    picker.setOnValueChangedListener(pickInstance);</span>
<span class="nc bnc" id="L10018" title="All 2 branches missed.">                    if(pickInstance.result &gt; -1) {</span>
<span class="nc" id="L10019">                        picker.setValue(pickInstance.result);</span>
                    }
<span class="nc" id="L10021">                    RelativeLayout linearLayout = new RelativeLayout(getActivity());</span>
<span class="nc" id="L10022">                    RelativeLayout.LayoutParams params = new RelativeLayout.LayoutParams(50, 50);</span>
<span class="nc" id="L10023">                    RelativeLayout.LayoutParams numPicerParams = new RelativeLayout.LayoutParams(RelativeLayout.LayoutParams.WRAP_CONTENT, RelativeLayout.LayoutParams.WRAP_CONTENT);</span>
<span class="nc" id="L10024">                    numPicerParams.addRule(RelativeLayout.CENTER_HORIZONTAL);</span>

<span class="nc" id="L10026">                    linearLayout.setLayoutParams(params);</span>
<span class="nc" id="L10027">                    linearLayout.addView(picker,numPicerParams);</span>

<span class="nc" id="L10029">                    AlertDialog.Builder alertDialogBuilder = new AlertDialog.Builder(getActivity());</span>
<span class="nc" id="L10030">                    alertDialogBuilder.setView(linearLayout);</span>
<span class="nc" id="L10031">                    alertDialogBuilder</span>
<span class="nc" id="L10032">                            .setCancelable(false)</span>
<span class="nc" id="L10033">                            .setPositiveButton(&quot;Ok&quot;,</span>
<span class="nc" id="L10034">                                    new DialogInterface.OnClickListener() {</span>
                                        public void onClick(DialogInterface dialog,
                                                            int id) {
<span class="nc" id="L10037">                                            pickInstance.ok();</span>
<span class="nc" id="L10038">                                        }</span>
                                    })
<span class="nc" id="L10040">                            .setNegativeButton(&quot;Cancel&quot;,</span>
<span class="nc" id="L10041">                                    new DialogInterface.OnClickListener() {</span>
                                        public void onClick(DialogInterface dialog,
                                                            int id) {
<span class="nc" id="L10044">                                            dialog.cancel();</span>
<span class="nc" id="L10045">                                            pickInstance.cancel();</span>
<span class="nc" id="L10046">                                        }</span>
                                    });
<span class="nc" id="L10048">                    AlertDialog alertDialog = alertDialogBuilder.create();</span>
<span class="nc" id="L10049">                    alertDialog.show();</span>
<span class="nc" id="L10050">                }</span>
            });
<span class="nc" id="L10052">            Display.getInstance().invokeAndBlock(pickInstance);</span>
<span class="nc bnc" id="L10053" title="All 2 branches missed.">            if(canceled[0]) {</span>
<span class="nc" id="L10054">                return null;</span>
            }
<span class="nc bnc" id="L10056" title="All 2 branches missed.">            if(pickInstance.result &lt; 0) {</span>
<span class="nc" id="L10057">                return null;</span>
            }
<span class="nc" id="L10059">            return values[pickInstance.result];</span>
        }
<span class="nc" id="L10061">        return null;</span>
    }
    
    private ServerSockets serverSockets;
    private synchronized ServerSockets getServerSockets() {
<span class="nc bnc" id="L10066" title="All 2 branches missed.">        if (serverSockets == null) {</span>
<span class="nc" id="L10067">            serverSockets = new ServerSockets();</span>
        }
<span class="nc" id="L10069">        return serverSockets;</span>
    }
    
<span class="nc" id="L10072">    class ServerSockets {</span>
<span class="nc" id="L10073">        Map&lt;Integer,ServerSocket&gt; socks = new HashMap&lt;Integer,ServerSocket&gt;();</span>
        
        public synchronized ServerSocket get(int port) throws IOException {
<span class="nc bnc" id="L10076" title="All 2 branches missed.">            if (socks.containsKey(port)) {</span>
<span class="nc" id="L10077">                ServerSocket sock = socks.get(port);</span>
<span class="nc bnc" id="L10078" title="All 2 branches missed.">                if (sock.isClosed()) {</span>
<span class="nc" id="L10079">                    sock = new ServerSocket(port);</span>
<span class="nc" id="L10080">                    socks.put(port, sock);</span>
                }
<span class="nc" id="L10082">                return sock;</span>
            } else {
<span class="nc" id="L10084">                ServerSocket sock = new ServerSocket(port);</span>
<span class="nc" id="L10085">                socks.put(port, sock);</span>
<span class="nc" id="L10086">                return sock;</span>
            }
        }
        
        
    }

<span class="nc" id="L10093">    class SocketImpl {</span>
        java.net.Socket socketInstance;
<span class="nc" id="L10095">        int errorCode = -1;</span>
<span class="nc" id="L10096">        String errorMessage = null;</span>
        InputStream is;
        OutputStream os;

        public boolean connect(String param, int param1, int connectTimeout) {
            try {
<span class="nc" id="L10102">                socketInstance = new java.net.Socket();</span>
<span class="nc" id="L10103">                socketInstance.connect(new InetSocketAddress(param, param1), connectTimeout);</span>
<span class="nc" id="L10104">                return true;</span>
<span class="nc" id="L10105">            } catch(Exception err) {</span>
<span class="nc" id="L10106">                err.printStackTrace();</span>
<span class="nc" id="L10107">                errorMessage = err.toString();</span>
<span class="nc" id="L10108">                return false;</span>
            }
        }

        private InputStream getInput() throws IOException {
<span class="nc bnc" id="L10113" title="All 2 branches missed.">            if(is == null) {</span>
<span class="nc bnc" id="L10114" title="All 2 branches missed.">                if(socketInstance != null) {</span>
<span class="nc" id="L10115">                    is = socketInstance.getInputStream();</span>
                } else {

                }
            }
<span class="nc" id="L10120">            return is;</span>
        }

        private OutputStream getOutput() throws IOException {
<span class="nc bnc" id="L10124" title="All 2 branches missed.">            if(os == null) {</span>
<span class="nc" id="L10125">                os = socketInstance.getOutputStream();</span>
            }
<span class="nc" id="L10127">            return os;</span>
        }

        public int getAvailableInput() {
            try {
<span class="nc" id="L10132">                return getInput().available();</span>
<span class="nc" id="L10133">            } catch(IOException err) {</span>
<span class="nc" id="L10134">                errorMessage = err.toString();</span>
<span class="nc" id="L10135">                err.printStackTrace();</span>
            }
<span class="nc" id="L10137">            return 0;</span>
        }

        public String getErrorMessage() {
<span class="nc" id="L10141">            return errorMessage;</span>
        }

        public byte[] readFromStream() {
            try {
<span class="nc" id="L10146">                int av = getAvailableInput();</span>
<span class="nc bnc" id="L10147" title="All 2 branches missed.">                if(av &gt; 0) {</span>
<span class="nc" id="L10148">                    byte[] arr = new byte[av];</span>
<span class="nc" id="L10149">                    int size = getInput().read(arr);</span>
<span class="nc bnc" id="L10150" title="All 2 branches missed.">                    if(size == arr.length) {</span>
<span class="nc" id="L10151">                        return arr;</span>
                    }
<span class="nc" id="L10153">                    return shrink(arr, size);</span>
                }
<span class="nc" id="L10155">                byte[] arr = new byte[8192];</span>
<span class="nc" id="L10156">                int size = getInput().read(arr);</span>
<span class="nc bnc" id="L10157" title="All 2 branches missed.">                if(size == arr.length) {</span>
<span class="nc" id="L10158">                    return arr;</span>
                }
<span class="nc" id="L10160">                return shrink(arr, size);</span>
<span class="nc" id="L10161">            } catch(IOException err) {</span>
<span class="nc" id="L10162">                err.printStackTrace();</span>
<span class="nc" id="L10163">                errorMessage = err.toString();</span>
<span class="nc" id="L10164">                return null;</span>
            }
        }

        private byte[] shrink(byte[] arr, int size) {
<span class="nc bnc" id="L10169" title="All 2 branches missed.">            if(size == -1) {</span>
<span class="nc" id="L10170">                return null;</span>
            }
<span class="nc" id="L10172">            byte[] n = new byte[size];</span>
<span class="nc" id="L10173">            System.arraycopy(arr, 0, n, 0, size);</span>
<span class="nc" id="L10174">            return n;</span>
        }

        public void writeToStream(byte[] param) {
            try {
<span class="nc" id="L10179">                OutputStream os = getOutput();</span>
<span class="nc" id="L10180">                os.write(param);</span>
<span class="nc" id="L10181">                os.flush();</span>
<span class="nc" id="L10182">            } catch(IOException err) {</span>
<span class="nc" id="L10183">                errorMessage = err.toString();</span>
<span class="nc" id="L10184">                err.printStackTrace();</span>
<span class="nc" id="L10185">            }</span>
<span class="nc" id="L10186">        }</span>

        public void disconnect() {
            try {
<span class="nc bnc" id="L10190" title="All 2 branches missed.">                if(socketInstance != null) {</span>
<span class="nc bnc" id="L10191" title="All 2 branches missed.">                    if(is != null) {</span>
                        try {
<span class="nc" id="L10193">                            is.close();</span>
<span class="nc" id="L10194">                        } catch(IOException err) {}</span>
                    }
<span class="nc bnc" id="L10196" title="All 2 branches missed.">                    if(os != null) {</span>
                        try {
<span class="nc" id="L10198">                            os.close();</span>
<span class="nc" id="L10199">                        } catch(IOException err) {}</span>
                    }
<span class="nc" id="L10201">                    socketInstance.close();</span>
<span class="nc" id="L10202">                    socketInstance = null;</span>
                }
<span class="nc" id="L10204">            } catch(IOException err) {</span>
<span class="nc" id="L10205">                errorMessage = err.toString();</span>
<span class="nc" id="L10206">                err.printStackTrace();</span>
<span class="nc" id="L10207">            }</span>
<span class="nc" id="L10208">        }</span>

        public Object listen(int param) {
            try {
<span class="nc" id="L10212">                ServerSocket serverSocketInstance = getServerSockets().get(param);</span>
<span class="nc" id="L10213">                socketInstance = serverSocketInstance.accept();</span>
<span class="nc" id="L10214">                SocketImpl si = new SocketImpl();</span>
<span class="nc" id="L10215">                si.socketInstance = socketInstance;</span>
<span class="nc" id="L10216">                return si;</span>
<span class="nc" id="L10217">            } catch(Exception err) {</span>
<span class="nc" id="L10218">                errorMessage = err.toString();</span>
<span class="nc" id="L10219">                err.printStackTrace();</span>
<span class="nc" id="L10220">                return null;</span>
            }
        }

        public boolean isConnected() {
<span class="nc bnc" id="L10225" title="All 2 branches missed.">            return socketInstance != null;</span>
        }

        public int getErrorCode() {
<span class="nc" id="L10229">            return errorCode;</span>
        }
    }

    @Override
    public Object connectSocket(String host, int port) {
<span class="nc" id="L10235">        return connectSocket(host, port, 0);</span>
    }

    
    
    @Override
    public Object connectSocket(String host, int port, int connectTimeout) {
<span class="nc" id="L10242">        SocketImpl i = new SocketImpl();</span>
<span class="nc bnc" id="L10243" title="All 2 branches missed.">        if(i.connect(host, port, connectTimeout)) {</span>
<span class="nc" id="L10244">            return i;</span>
        }
<span class="nc" id="L10246">        return null;</span>
    }

    @Override
    public Object listenSocket(int port) {
<span class="nc" id="L10251">        return new SocketImpl().listen(port);</span>
    }

    @Override
    public String getHostOrIP() {
        try {
<span class="nc" id="L10257">            InetAddress i = java.net.InetAddress.getLocalHost();</span>
<span class="nc bnc" id="L10258" title="All 2 branches missed.">            if(i.isLoopbackAddress()) {</span>
<span class="nc" id="L10259">                Enumeration&lt;NetworkInterface&gt; nie = NetworkInterface.getNetworkInterfaces();</span>
<span class="nc bnc" id="L10260" title="All 2 branches missed.">                while(nie.hasMoreElements()) {</span>
<span class="nc" id="L10261">                    NetworkInterface current = nie.nextElement();</span>
<span class="nc bnc" id="L10262" title="All 2 branches missed.">                    if(!current.isLoopback()) {</span>
<span class="nc" id="L10263">                        Enumeration&lt;InetAddress&gt; iae = current.getInetAddresses();</span>
<span class="nc bnc" id="L10264" title="All 2 branches missed.">                        while(iae.hasMoreElements()) {</span>
<span class="nc" id="L10265">                            InetAddress currentI = iae.nextElement();</span>
<span class="nc bnc" id="L10266" title="All 2 branches missed.">                            if(!currentI.isLoopbackAddress()) {</span>
<span class="nc" id="L10267">                                return currentI.getHostAddress();</span>
                            }
<span class="nc" id="L10269">                        }</span>
                    }
<span class="nc" id="L10271">                }</span>
            }
<span class="nc" id="L10273">            return i.getHostAddress();</span>
<span class="nc" id="L10274">        } catch(Throwable t) {</span>
<span class="nc" id="L10275">            com.codename1.io.Log.e(t);</span>
<span class="nc" id="L10276">            return null;</span>
        }
    }

    @Override
    public void disconnectSocket(Object socket) {
<span class="nc" id="L10282">        ((SocketImpl)socket).disconnect();</span>
<span class="nc" id="L10283">    }</span>

    @Override
    public boolean isSocketConnected(Object socket) {
<span class="nc" id="L10287">        return ((SocketImpl)socket).isConnected();</span>
    }

    

    @Override
    public boolean isServerSocketAvailable() {
<span class="nc" id="L10294">        return true;</span>
    }

    @Override
    public boolean isSocketAvailable() {
<span class="nc" id="L10299">        return true;</span>
    }

    @Override
    public String getSocketErrorMessage(Object socket) {
<span class="nc" id="L10304">        return ((SocketImpl)socket).getErrorMessage();</span>
    }

    @Override
    public int getSocketErrorCode(Object socket) {
<span class="nc" id="L10309">        return ((SocketImpl)socket).getErrorCode();</span>
    }

    @Override
    public int getSocketAvailableInput(Object socket) {
<span class="nc" id="L10314">        return ((SocketImpl)socket).getAvailableInput();</span>
    }

    @Override
    public byte[] readFromSocketStream(Object socket) {
<span class="nc" id="L10319">        return ((SocketImpl)socket).readFromStream();</span>
    }

    @Override
    public void writeToSocketStream(Object socket, byte[] data) {
<span class="nc" id="L10324">        ((SocketImpl)socket).writeToStream(data);</span>
<span class="nc" id="L10325">    }</span>

    //Begin new Graphics Work
    @Override
    public boolean isShapeSupported(Object graphics) {
<span class="fc" id="L10330">        return true;</span>
    }

    @Override
    public boolean isTransformSupported(Object graphics) {
<span class="nc" id="L10335">        return true;</span>
    }

    @Override
    public boolean isPerspectiveTransformSupported(Object graphics){
<span class="nc bnc" id="L10340" title="All 2 branches missed.">        return android.os.Build.VERSION.SDK_INT &gt;= 14;</span>
    }

    @Override
    public void fillShape(Object graphics, com.codename1.ui.geom.Shape shape) {
<span class="fc" id="L10345">        AndroidGraphics ag = (AndroidGraphics)graphics;</span>
<span class="fc" id="L10346">        Path p = cn1ShapeToAndroidPath(shape);</span>
<span class="fc" id="L10347">        ag.fillPath(p);</span>
<span class="fc" id="L10348">    }</span>

    @Override
    public void drawShape(Object graphics, com.codename1.ui.geom.Shape shape, com.codename1.ui.Stroke stroke) {
<span class="fc" id="L10352">        AndroidGraphics ag = (AndroidGraphics)graphics;</span>
<span class="fc" id="L10353">        Path p = cn1ShapeToAndroidPath(shape);</span>
<span class="fc" id="L10354">        ag.drawPath(p, stroke);</span>

<span class="fc" id="L10356">    }</span>

    @Override
    public void drawShadow(Object graphics, Object image, int x, int y, int offsetX, int offsetY, int blurRadius, int spreadRadius, int color, float opacity) {
<span class="nc" id="L10360">        AndroidGraphics ag = (AndroidGraphics)graphics;</span>

<span class="nc" id="L10362">        ag.drawShadow(image, x, y, offsetX, offsetY, blurRadius, spreadRadius, color, opacity);</span>
<span class="nc" id="L10363">    }</span>

    @Override
    public boolean isDrawShadowSupported() {
<span class="nc" id="L10367">        return true;</span>
    }

    @Override
    public boolean isDrawShadowFast() {
<span class="nc" id="L10372">        return false;</span>
    }
    // BEGIN TRANSFORMATION METHODS---------------------------------------------------------



    @Override
    public boolean transformEqualsImpl(Transform t1, Transform t2) {
<span class="fc" id="L10380">        Object o1 = null;</span>
<span class="pc bpc" id="L10381" title="1 of 2 branches missed.">        if(t1 != null) {</span>
<span class="fc" id="L10382">            o1 = t1.getNativeTransform();</span>
        }
<span class="fc" id="L10384">        Object o2 = null;</span>
<span class="pc bpc" id="L10385" title="1 of 2 branches missed.">        if(t2 != null) {</span>
<span class="fc" id="L10386">            o2 = t2.getNativeTransform();</span>
        }
<span class="fc" id="L10388">        return transformNativeEqualsImpl(o1, o2);</span>
    }

    @Override
    public boolean transformNativeEqualsImpl(Object t1, Object t2) {
<span class="pc bpc" id="L10393" title="1 of 2 branches missed.">        if ( t1 != null ){</span>
<span class="fc" id="L10394">            CN1Matrix4f m1 = (CN1Matrix4f)t1;</span>
<span class="fc" id="L10395">            CN1Matrix4f m2 = (CN1Matrix4f)t2;</span>
<span class="fc" id="L10396">            return m1.equals(m2);</span>
        } else {
<span class="nc bnc" id="L10398" title="All 2 branches missed.">            return t2 == null;</span>
        }
    }


    @Override
    public boolean isTransformSupported() {
<span class="fc" id="L10405">        return true;</span>
    }

    @Override
    public boolean isPerspectiveTransformSupported() {

<span class="fc" id="L10411">        return true;</span>
    }

    @Override
    public Object makeTransformAffine(double m00, double m10, double m01, double m11, double m02, double m12) {
<span class="fc" id="L10416">        CN1Matrix4f t = CN1Matrix4f.make(new float[]{</span>
                (float)m00, (float)m10, 0, 0,
                (float)m01, (float)m11, 0, 0,
                0, 0, 1, 0,
                (float)m02, (float)m12, 0, 1
        });
<span class="fc" id="L10422">        return t;</span>
    }

    @Override
    public void setTransformAffine(Object nativeTransform, double m00, double m10, double m01, double m11, double m02, double m12) {
<span class="nc" id="L10427">        ((CN1Matrix4f)nativeTransform).setData(new float[]{</span>
                (float)m00, (float)m10, 0, 0,
                (float)m01, (float)m11, 0, 0,
                0, 0, 1, 0,
                (float)m02, (float)m12, 0, 1
        });
<span class="nc" id="L10433">    }</span>
    
    
    @Override
    public Object makeTransformTranslation(float translateX, float translateY, float translateZ) {
<span class="nc" id="L10438">        return CN1Matrix4f.makeTranslation(translateX, translateY, translateZ);</span>
    }

    @Override
    public void setTransformTranslation(Object nativeTransform, float translateX, float translateY, float translateZ) {
<span class="fc" id="L10443">        CN1Matrix4f m = (CN1Matrix4f)nativeTransform;</span>
<span class="fc" id="L10444">        m.reset();</span>
<span class="fc" id="L10445">        m.translate(translateX, translateY, translateZ);</span>
<span class="fc" id="L10446">    }</span>

    @Override
    public Object makeTransformScale(float scaleX, float scaleY, float scaleZ) {
<span class="nc" id="L10450">        CN1Matrix4f t = CN1Matrix4f.makeIdentity();</span>
<span class="nc" id="L10451">        t.scale(scaleX, scaleY, scaleZ);</span>
<span class="nc" id="L10452">        return t;</span>
    }

    @Override
    public void setTransformScale(Object nativeTransform, float scaleX, float scaleY, float scaleZ) {
<span class="fc" id="L10457">        CN1Matrix4f t = (CN1Matrix4f)nativeTransform;</span>
<span class="fc" id="L10458">        t.reset();</span>
<span class="fc" id="L10459">        t.scale(scaleX, scaleY, scaleZ);</span>
<span class="fc" id="L10460">    }</span>

    @Override
    public Object makeTransformRotation(float angle, float x, float y, float z) {
<span class="fc" id="L10464">        return CN1Matrix4f.makeRotation(angle, x, y, z);</span>
    }

    @Override
    public void setTransformRotation(Object nativeTransform, float angle, float x, float y, float z) {
<span class="nc" id="L10469">        CN1Matrix4f m = (CN1Matrix4f)nativeTransform;</span>
<span class="nc" id="L10470">        m.reset();</span>
<span class="nc" id="L10471">        m.rotate(angle, x, y, z);</span>
<span class="nc" id="L10472">    }</span>

    @Override
    public Object makeTransformPerspective(float fovy, float aspect, float zNear, float zFar) {
<span class="fc" id="L10476">        return CN1Matrix4f.makePerspective(fovy, aspect, zNear, zFar);</span>
    }

    @Override
    public void setTransformPerspective(Object nativeGraphics, float fovy, float aspect, float zNear, float zFar) {
<span class="nc" id="L10481">        CN1Matrix4f m = (CN1Matrix4f)nativeGraphics;</span>
<span class="nc" id="L10482">        m.setPerspective(fovy, aspect, zNear, zFar);</span>
<span class="nc" id="L10483">    }</span>

    @Override
    public Object makeTransformOrtho(float left, float right, float bottom, float top, float near, float far) {
<span class="nc" id="L10487">        return CN1Matrix4f.makeOrtho(left, right, bottom, top, near, far);</span>
    }

    @Override
    public void setTransformOrtho(Object nativeGraphics, float left, float right, float bottom, float top, float near, float far) {
<span class="nc" id="L10492">        CN1Matrix4f m = (CN1Matrix4f)nativeGraphics;</span>
<span class="nc" id="L10493">        m.setOrtho(left, right, bottom, top, near, far);</span>
<span class="nc" id="L10494">    }</span>

    @Override
    public Object makeTransformCamera(float eyeX, float eyeY, float eyeZ, float centerX, float centerY, float centerZ, float upX, float upY, float upZ) {
<span class="fc" id="L10498">        return CN1Matrix4f.makeCamera(eyeX, eyeY, eyeZ, centerX, centerY, centerZ, upX, upY, upZ);</span>
    }

    @Override
    public void setTransformCamera(Object nativeGraphics, float eyeX, float eyeY, float eyeZ, float centerX, float centerY, float centerZ, float upX, float upY, float upZ) {
<span class="nc" id="L10503">        CN1Matrix4f m = (CN1Matrix4f)nativeGraphics;</span>
<span class="nc" id="L10504">        m.setCamera(eyeX, eyeY, eyeZ, centerX, centerY, centerZ, upX, upY, upZ);</span>
<span class="nc" id="L10505">    }</span>


    @Override
    public void transformRotate(Object nativeTransform, float angle, float x, float y, float z) {
<span class="fc" id="L10510">        ((CN1Matrix4f)nativeTransform).rotate(angle, x, y, z);</span>
<span class="fc" id="L10511">    }</span>

    @Override
    public void transformTranslate(Object nativeTransform, float x, float y, float z) {
        //((Matrix) nativeTransform).preTranslate(x, y);
<span class="fc" id="L10516">        ((CN1Matrix4f)nativeTransform).translate(x, y, z);</span>
<span class="fc" id="L10517">    }</span>

    @Override
    public void transformScale(Object nativeTransform, float x, float y, float z) {
        //((Matrix) nativeTransform).preScale(x, y);
<span class="fc" id="L10522">        ((CN1Matrix4f)nativeTransform).scale(x, y, z);</span>
<span class="fc" id="L10523">    }</span>

    @Override
    public Object makeTransformInverse(Object nativeTransform) {

<span class="nc" id="L10528">        CN1Matrix4f inverted = CN1Matrix4f.makeIdentity();</span>
<span class="nc" id="L10529">        inverted.setData(((CN1Matrix4f)nativeTransform).getData());</span>
<span class="nc bnc" id="L10530" title="All 2 branches missed.">        if( inverted.invert()){</span>
<span class="nc" id="L10531">            return inverted;</span>
        }
<span class="nc" id="L10533">        return null;</span>

        //Matrix inverted = new Matrix();
        //if(((Matrix) nativeTransform).invert(inverted)){
        //    return inverted;
        //}
        //return null;
    }

    @Override
    public void setTransformInverse(Object nativeTransform) throws com.codename1.ui.Transform.NotInvertibleException {

<span class="nc" id="L10545">        CN1Matrix4f m = (CN1Matrix4f)nativeTransform;</span>
<span class="nc bnc" id="L10546" title="All 2 branches missed.">        if (!m.invert()) {</span>
<span class="nc" id="L10547">            throw new com.codename1.ui.Transform.NotInvertibleException();</span>
        }
<span class="nc" id="L10549">    }</span>

    @Override
    public void setTransformIdentity(Object transform) {
<span class="fc" id="L10553">        CN1Matrix4f m = (CN1Matrix4f)transform;</span>
<span class="fc" id="L10554">        m.setIdentity();</span>
<span class="fc" id="L10555">    }</span>

    @Override
    public Object makeTransformIdentity() {
<span class="fc" id="L10559">        return CN1Matrix4f.makeIdentity();</span>
    }

    @Override
    public void copyTransform(Object src, Object dest) {
<span class="fc" id="L10564">        CN1Matrix4f t1 = (CN1Matrix4f) src;</span>
<span class="fc" id="L10565">        CN1Matrix4f t2 = (CN1Matrix4f) dest;</span>
<span class="fc" id="L10566">        t2.setData(t1.getData());</span>
<span class="fc" id="L10567">    }</span>

    @Override
    public void concatenateTransform(Object t1, Object t2) {
        //((Matrix) t1).preConcat((Matrix) t2);
<span class="fc" id="L10572">        ((CN1Matrix4f)t1).concatenate((CN1Matrix4f)t2);</span>
<span class="fc" id="L10573">    }</span>

    @Override
    public void transformPoint(Object nativeTransform, float[] in, float[] out) {
        //Matrix t = (Matrix) nativeTransform;
        //t.mapPoints(in, 0, out, 0, 2);
<span class="nc" id="L10579">        ((CN1Matrix4f)nativeTransform).transformCoord(in, out);</span>
<span class="nc" id="L10580">    }</span>

    @Override
    public void setTransform(Object graphics, Transform transform) {
<span class="fc" id="L10584">        AndroidGraphics ag = (AndroidGraphics) graphics;</span>
<span class="fc" id="L10585">        Transform existing = ag.getTransform();</span>
<span class="pc bpc" id="L10586" title="1 of 2 branches missed.">        if (existing == null) {</span>
<span class="nc bnc" id="L10587" title="All 2 branches missed.">            existing = transform == null ? Transform.makeIdentity() : transform.copy();</span>
<span class="nc" id="L10588">            ag.setTransform(existing);</span>
        } else {
<span class="pc bpc" id="L10590" title="1 of 2 branches missed.">            if (transform == null) {</span>
<span class="nc" id="L10591">                existing.setIdentity();</span>
            } else {
<span class="fc" id="L10593">                existing.setTransform(transform);</span>
            }
<span class="fc" id="L10595">            ag.setTransform(existing); // sets dirty flag for transform</span>
        }

<span class="fc" id="L10598">    }</span>

    @Override
    public com.codename1.ui.Transform getTransform(Object graphics) {
<span class="nc" id="L10602">        com.codename1.ui.Transform t = ((AndroidGraphics) graphics).getTransform();</span>
<span class="nc bnc" id="L10603" title="All 2 branches missed.">        if (t == null) {</span>
<span class="nc" id="L10604">            return Transform.makeIdentity();</span>
        }
<span class="nc" id="L10606">        Transform t2 = Transform.makeIdentity();</span>
<span class="nc" id="L10607">        t2.setTransform(t);</span>
<span class="nc" id="L10608">        return t2;</span>
    }

    @Override
    public void getTransform(Object graphics, Transform transform) {
<span class="nc" id="L10613">        com.codename1.ui.Transform t = ((AndroidGraphics) graphics).getTransform();</span>
<span class="nc bnc" id="L10614" title="All 2 branches missed.">        if (t == null) {</span>
<span class="nc" id="L10615">            transform.setIdentity();</span>
        } else {
<span class="nc" id="L10617">            transform.setTransform(t);</span>
        }
<span class="nc" id="L10619">    }</span>


    // END TRANSFORM STUFF


    static Path cn1ShapeToAndroidPath(com.codename1.ui.geom.Shape shape, Path p) {
        //Path p = new Path();
<span class="fc" id="L10627">        p.rewind();</span>
        
<span class="fc" id="L10629">        com.codename1.ui.geom.PathIterator it = shape.getPathIterator();</span>
<span class="pc bpc" id="L10630" title="2 of 3 branches missed.">        switch (it.getWindingRule()) {</span>
            case GeneralPath.WIND_EVEN_ODD:
<span class="nc" id="L10632">                p.setFillType(Path.FillType.EVEN_ODD);</span>
<span class="nc" id="L10633">                break;</span>
            case GeneralPath.WIND_NON_ZERO:
<span class="fc" id="L10635">                p.setFillType(Path.FillType.WINDING);</span>
                break;
        }
        //p.setWindingRule(it.getWindingRule() == com.codename1.ui.geom.PathIterator.WIND_EVEN_ODD ? GeneralPath.WIND_EVEN_ODD : GeneralPath.WIND_NON_ZERO);
<span class="fc" id="L10639">        float[] buf = new float[6];</span>
<span class="fc bfc" id="L10640" title="All 2 branches covered.">        while (!it.isDone()) {</span>
<span class="fc" id="L10641">            int type = it.currentSegment(buf);</span>
<span class="pc bpc" id="L10642" title="1 of 6 branches missed.">            switch (type) {</span>
                case com.codename1.ui.geom.PathIterator.SEG_MOVETO:
<span class="fc" id="L10644">                    p.moveTo(buf[0], buf[1]);</span>
<span class="fc" id="L10645">                    break;</span>
                case com.codename1.ui.geom.PathIterator.SEG_LINETO:
<span class="fc" id="L10647">                    p.lineTo(buf[0], buf[1]);</span>
<span class="fc" id="L10648">                    break;</span>
                case com.codename1.ui.geom.PathIterator.SEG_QUADTO:
<span class="fc" id="L10650">                    p.quadTo(buf[0], buf[1], buf[2], buf[3]);</span>
<span class="fc" id="L10651">                    break;</span>
                case com.codename1.ui.geom.PathIterator.SEG_CUBICTO:
<span class="fc" id="L10653">                    p.cubicTo(buf[0], buf[1], buf[2], buf[3], buf[4], buf[5]);</span>
<span class="fc" id="L10654">                    break;</span>
                case com.codename1.ui.geom.PathIterator.SEG_CLOSE:
<span class="fc" id="L10656">                    p.close();</span>
                    break;

            }
<span class="fc" id="L10660">            it.next();</span>
<span class="fc" id="L10661">        }</span>

<span class="fc" id="L10663">        return p;</span>
    }

    static Path cn1ShapeToAndroidPath(com.codename1.ui.geom.Shape shape) {
<span class="fc" id="L10667">        return cn1ShapeToAndroidPath(shape, new Path());</span>
    }

    /**
     * The ID used for a local notification that should actually trigger a background
     * fetch.  This type of notification is handled specially by the {@link LocalNotificationPublisher}.  It
     * doesn't display a notification to the user, but instead just calls the {@link #performBackgroundFetch() }
     * method.
     */
    static final String BACKGROUND_FETCH_NOTIFICATION_ID=&quot;$$$CN1_BACKGROUND_FETCH$$$&quot;;


    /**
     * Calls the background fetch callback.  If the app is in teh background, this will
     * check to see if the lifecycle class implements the {@link com.codename1.background.BackgroundFetch}
     * interface.  If it does, it will execute its {@link com.codename1.background.BackgroundFetch#performBackgroundFetch(long, com.codename1.util.Callback) }
     * method.
     * @param blocking True if this should block until it is complete.
     */
    public static void performBackgroundFetch(boolean blocking) {

<span class="nc bnc" id="L10688" title="All 2 branches missed.">        if (Display.getInstance().isMinimized()) {</span>
            // By definition, background fetch should only occur if the app is minimized.
            // This keeps it consistent with the iOS implementation that doesn't have a 
            // choice
<span class="nc" id="L10692">            final boolean[] complete = new boolean[1];</span>
<span class="nc" id="L10693">            final Object lock = new Object();</span>
<span class="nc" id="L10694">            final BackgroundFetch bgFetchListener = instance.getBackgroundFetchListener();</span>
<span class="nc" id="L10695">            final long timeout = System.currentTimeMillis()+25000;</span>
<span class="nc bnc" id="L10696" title="All 2 branches missed.">            if (bgFetchListener != null) {</span>
<span class="nc" id="L10697">                Display.getInstance().callSerially(new Runnable() {</span>
                    public void run() {
<span class="nc" id="L10699">                        bgFetchListener.performBackgroundFetch(timeout, new Callback&lt;Boolean&gt;() {</span>

                            @Override
                            public void onSucess(Boolean value) {
                                // On Android the OS doesn't care whether it worked or not
                                // So we'll just consume this.
<span class="nc" id="L10705">                                synchronized (lock) {</span>
<span class="nc" id="L10706">                                    complete[0] = true;</span>
<span class="nc" id="L10707">                                    lock.notify();</span>
<span class="nc" id="L10708">                                }</span>
<span class="nc" id="L10709">                            }</span>

                            @Override
                            public void onError(Object sender, Throwable err, int errorCode, String errorMessage) {
<span class="nc" id="L10713">                                com.codename1.io.Log.e(err);</span>
<span class="nc" id="L10714">                                synchronized (lock) {</span>
<span class="nc" id="L10715">                                    complete[0] = true;</span>
<span class="nc" id="L10716">                                    lock.notify();</span>
<span class="nc" id="L10717">                                }</span>
<span class="nc" id="L10718">                            }</span>

                        });
<span class="nc" id="L10721">                    }</span>
                });

            }

<span class="nc bnc" id="L10726" title="All 4 branches missed.">            while (blocking &amp;&amp; !complete[0]) {</span>
<span class="nc" id="L10727">                Util.wait(lock, 1000);</span>
<span class="nc bnc" id="L10728" title="All 2 branches missed.">                if (!complete[0]) {</span>
<span class="nc" id="L10729">                    System.out.println(&quot;Waiting for background fetch to complete.  Make sure your background fetch handler calls onSuccess() or onError() in the callback when complete&quot;);</span>

                }
<span class="nc bnc" id="L10732" title="All 2 branches missed.">                if (System.currentTimeMillis() &gt; timeout) {</span>
<span class="nc" id="L10733">                    System.out.println(&quot;Background fetch exceeded time alotted.  Not waiting for its completion&quot;);</span>
<span class="nc" id="L10734">                    break;</span>
                }

            }


        }
<span class="nc" id="L10741">    }</span>

    /**
     * Starts the background fetch service.
     */
    public void startBackgroundFetchService() {
<span class="nc" id="L10747">        LocalNotification n = new LocalNotification();</span>
<span class="nc" id="L10748">        n.setId(BACKGROUND_FETCH_NOTIFICATION_ID);</span>
<span class="nc" id="L10749">        cancelLocalNotification(BACKGROUND_FETCH_NOTIFICATION_ID);</span>
        // We schedule a local notification
        // First callback will be at the repeat interval
        // We don't specify a repeat interval because the scheduleLocalNotification will 
        // set that for us using the getPreferredBackgroundFetchInterval method.
<span class="nc" id="L10754">        scheduleLocalNotification(n, System.currentTimeMillis() + getPreferredBackgroundFetchInterval() * 1000, 0);</span>
<span class="nc" id="L10755">    }</span>

    public void stopBackgroundFetchService() {
<span class="nc" id="L10758">        cancelLocalNotification(BACKGROUND_FETCH_NOTIFICATION_ID);</span>
<span class="nc" id="L10759">    }</span>


    private boolean backgroundFetchInitialized;

    @Override
    public void setPreferredBackgroundFetchInterval(int seconds) {
<span class="nc" id="L10766">        int oldInterval = getPreferredBackgroundFetchInterval();</span>
<span class="nc" id="L10767">        super.setPreferredBackgroundFetchInterval(seconds);</span>

<span class="nc bnc" id="L10769" title="All 4 branches missed.">        if (!backgroundFetchInitialized || oldInterval != seconds) {</span>
<span class="nc" id="L10770">            backgroundFetchInitialized = true;</span>
<span class="nc bnc" id="L10771" title="All 2 branches missed.">            if (seconds &gt; 0) {</span>
<span class="nc" id="L10772">                startBackgroundFetchService();</span>
            } else {
<span class="nc" id="L10774">                stopBackgroundFetchService();</span>
            }
        }
<span class="nc" id="L10777">    }</span>



    @Override
    public boolean isBackgroundFetchSupported() {
<span class="nc" id="L10783">        return true;</span>
    }
    public static BackgroundFetch backgroundFetchListener;

    BackgroundFetch getBackgroundFetchListener() {
<span class="nc bnc" id="L10788" title="All 4 branches missed.">        if (getActivity() != null &amp;&amp; getActivity().getApp() instanceof BackgroundFetch) {</span>
<span class="nc" id="L10789">            return (BackgroundFetch)getActivity().getApp();</span>
<span class="nc bnc" id="L10790" title="All 2 branches missed.">        } else if (backgroundFetchListener != null) {</span>
<span class="nc" id="L10791">            return backgroundFetchListener;</span>
        } else {
<span class="nc" id="L10793">            return null;</span>
        }
    }

    public void scheduleLocalNotification(LocalNotification notif, long firstTime, int repeat) {
<span class="nc bnc" id="L10798" title="All 2 branches missed.">        if (android.os.Build.VERSION.SDK_INT &gt;= 33) {</span>
<span class="nc bnc" id="L10799" title="All 2 branches missed.">            if(!checkForPermission(&quot;android.permission.POST_NOTIFICATIONS&quot;, &quot;This is required to receive notifications&quot;)){</span>
<span class="nc" id="L10800">                com.codename1.io.Log.e(new RuntimeException(&quot;Local notification was prevented the POST_NOTIFICATIONS permission was not granted by the user.&quot;));</span>
<span class="nc" id="L10801">                return;</span>
            }
        }
<span class="nc" id="L10804">        final Intent notificationIntent = new Intent(getContext(), LocalNotificationPublisher.class);</span>
<span class="nc" id="L10805">        notificationIntent.setAction(getContext().getApplicationInfo().packageName + &quot;.&quot; + notif.getId());</span>
<span class="nc" id="L10806">        notificationIntent.putExtra(LocalNotificationPublisher.NOTIFICATION, createBundleFromNotification(notif));</span>

<span class="nc" id="L10808">        Intent contentIntent = new Intent();</span>
<span class="nc bnc" id="L10809" title="All 2 branches missed.">        if (activityComponentName != null) {</span>
<span class="nc" id="L10810">            contentIntent.setComponent(activityComponentName);</span>
        } else {
            try {
<span class="nc" id="L10813">                contentIntent.setComponent(getContext().getPackageManager().getLaunchIntentForPackage(getContext().getApplicationInfo().packageName).getComponent());</span>
<span class="nc" id="L10814">            } catch (Exception ex) {</span>
<span class="nc" id="L10815">                System.err.println(&quot;Failed to get the component name for local notification.  Local notification may not work.&quot;);</span>
<span class="nc" id="L10816">                ex.printStackTrace();</span>
<span class="nc" id="L10817">            }</span>
        }
<span class="nc" id="L10819">        contentIntent.putExtra(&quot;LocalNotificationID&quot;, notif.getId());</span>

<span class="nc bnc" id="L10821" title="All 4 branches missed.">        if (BACKGROUND_FETCH_NOTIFICATION_ID.equals(notif.getId()) &amp;&amp; getBackgroundFetchListener() != null) {</span>
<span class="nc" id="L10822">            Context context = AndroidNativeUtil.getContext();</span>

<span class="nc" id="L10824">            Intent intent = new Intent(context, BackgroundFetchHandler.class);</span>
            //there is an bug that causes this to not to workhttps://code.google.com/p/android/issues/detail?id=81812
            //intent.putExtra(&quot;backgroundClass&quot;, getBackgroundLocationListener().getName());
            //an ugly workaround to the putExtra bug 
<span class="nc" id="L10828">            intent.setData(Uri.parse(&quot;http://codenameone.com/a?&quot; + getBackgroundFetchListener().getClass().getName()));</span>
<span class="nc" id="L10829">            PendingIntent pendingIntent = getPendingIntent(context, 0,</span>
                    intent);
<span class="nc" id="L10831">            notificationIntent.putExtra(LocalNotificationPublisher.BACKGROUND_FETCH_INTENT, pendingIntent);</span>

<span class="nc" id="L10833">        } else {</span>
<span class="nc" id="L10834">            contentIntent.setData(Uri.parse(&quot;http://codenameone.com/a?LocalNotificationID=&quot;+Uri.encode(notif.getId())));</span>
        }
<span class="nc" id="L10836">        PendingIntent pendingContentIntent = createPendingIntent(getContext(), 0, contentIntent);</span>

<span class="nc" id="L10838">        notificationIntent.putExtra(LocalNotificationPublisher.NOTIFICATION_INTENT, pendingContentIntent);</span>


<span class="nc" id="L10841">        PendingIntent pendingIntent = getBroadcastPendingIntent(getContext(), 0, notificationIntent);</span>

<span class="nc" id="L10843">        AlarmManager alarmManager = (AlarmManager) getContext().getSystemService(Context.ALARM_SERVICE);</span>
<span class="nc bnc" id="L10844" title="All 2 branches missed.">        if (BACKGROUND_FETCH_NOTIFICATION_ID.equals(notif.getId())) {</span>
<span class="nc" id="L10845">            alarmManager.setRepeating(AlarmManager.RTC_WAKEUP, firstTime, getPreferredBackgroundFetchInterval() * 1000, pendingIntent);</span>
        } else {
<span class="nc bnc" id="L10847" title="All 2 branches missed.">            if(repeat == LocalNotification.REPEAT_NONE){</span>
<span class="nc" id="L10848">                alarmManager.set(AlarmManager.RTC_WAKEUP, firstTime, pendingIntent);</span>

<span class="nc bnc" id="L10850" title="All 2 branches missed.">            }else if(repeat == LocalNotification.REPEAT_MINUTE){</span>

<span class="nc" id="L10852">                alarmManager.setRepeating(AlarmManager.RTC_WAKEUP, firstTime, 60*1000, pendingIntent);</span>

<span class="nc bnc" id="L10854" title="All 2 branches missed.">            }else if(repeat == LocalNotification.REPEAT_HOUR){</span>

<span class="nc" id="L10856">                alarmManager.setInexactRepeating(AlarmManager.RTC_WAKEUP, firstTime, AlarmManager.INTERVAL_HALF_HOUR, pendingIntent);</span>

<span class="nc bnc" id="L10858" title="All 2 branches missed.">            }else if(repeat == LocalNotification.REPEAT_DAY){</span>

<span class="nc" id="L10860">                alarmManager.setInexactRepeating(AlarmManager.RTC_WAKEUP, firstTime, AlarmManager.INTERVAL_DAY, pendingIntent);</span>

<span class="nc bnc" id="L10862" title="All 2 branches missed.">            }else if(repeat == LocalNotification.REPEAT_WEEK){</span>

<span class="nc" id="L10864">                alarmManager.setRepeating(AlarmManager.RTC_WAKEUP, firstTime, AlarmManager.INTERVAL_DAY * 7, pendingIntent);</span>

            }
        }
<span class="nc" id="L10868">    }</span>

    public void cancelLocalNotification(String notificationId) {
<span class="nc" id="L10871">        Intent notificationIntent = new Intent(getContext(), LocalNotificationPublisher.class);</span>
<span class="nc" id="L10872">        notificationIntent.setAction(getContext().getApplicationInfo().packageName + &quot;.&quot; + notificationId);</span>

<span class="nc" id="L10874">        PendingIntent pendingIntent = getBroadcastPendingIntent(getContext(), 0, notificationIntent);</span>
<span class="nc" id="L10875">        AlarmManager alarmManager = (AlarmManager) getContext().getSystemService(Context.ALARM_SERVICE);</span>
<span class="nc" id="L10876">        alarmManager.cancel(pendingIntent);</span>
<span class="nc" id="L10877">    }</span>

    static Bundle createBundleFromNotification(LocalNotification notif){
<span class="nc" id="L10880">        Bundle b = new Bundle();</span>
<span class="nc" id="L10881">        b.putString(&quot;NOTIF_ID&quot;, notif.getId());</span>
<span class="nc" id="L10882">        b.putString(&quot;NOTIF_TITLE&quot;, notif.getAlertTitle());</span>
<span class="nc" id="L10883">        b.putString(&quot;NOTIF_BODY&quot;, notif.getAlertBody());</span>
<span class="nc" id="L10884">        b.putString(&quot;NOTIF_SOUND&quot;, notif.getAlertSound());</span>
<span class="nc" id="L10885">        b.putString(&quot;NOTIF_IMAGE&quot;, notif.getAlertImage());</span>
<span class="nc" id="L10886">        b.putInt(&quot;NOTIF_NUMBER&quot;, notif.getBadgeNumber());</span>
<span class="nc" id="L10887">        return b;</span>
    }

    static LocalNotification createNotificationFromBundle(Bundle b){
<span class="nc" id="L10891">        LocalNotification n = new LocalNotification();</span>
<span class="nc" id="L10892">        n.setId(b.getString(&quot;NOTIF_ID&quot;));</span>
<span class="nc" id="L10893">        n.setAlertTitle(b.getString(&quot;NOTIF_TITLE&quot;));</span>
<span class="nc" id="L10894">        n.setAlertBody(b.getString(&quot;NOTIF_BODY&quot;));</span>
<span class="nc" id="L10895">        n.setAlertSound(b.getString(&quot;NOTIF_SOUND&quot;));</span>
<span class="nc" id="L10896">        n.setAlertImage(b.getString(&quot;NOTIF_IMAGE&quot;));</span>
<span class="nc" id="L10897">        n.setBadgeNumber(b.getInt(&quot;NOTIF_NUMBER&quot;));</span>
<span class="nc" id="L10898">        return n;</span>
    }

    boolean brokenGaussian;
    public Image gaussianBlurImage(Image image, float radius) {
        try {
<span class="fc" id="L10904">            Bitmap outputBitmap = Bitmap.createBitmap((Bitmap)image.getImage());</span>

<span class="fc" id="L10906">            RenderScript rs = RenderScript.create(getContext());</span>
            try {
<span class="fc" id="L10908">                ScriptIntrinsicBlur theIntrinsic = ScriptIntrinsicBlur.create(rs, Element.U8_4(rs));</span>
<span class="fc" id="L10909">                Allocation tmpIn = Allocation.createFromBitmap(rs, (Bitmap)image.getImage());</span>
<span class="fc" id="L10910">                Allocation tmpOut = Allocation.createFromBitmap(rs, outputBitmap);</span>
<span class="fc" id="L10911">                theIntrinsic.setRadius(radius);</span>
<span class="fc" id="L10912">                theIntrinsic.setInput(tmpIn);</span>
<span class="fc" id="L10913">                theIntrinsic.forEach(tmpOut);</span>
<span class="fc" id="L10914">                tmpOut.copyTo(outputBitmap);</span>
<span class="fc" id="L10915">                tmpIn.destroy();</span>
<span class="fc" id="L10916">                tmpOut.destroy();</span>
<span class="fc" id="L10917">                theIntrinsic.destroy();</span>
            } finally {
<span class="fc" id="L10919">                rs.destroy();</span>
            }

<span class="fc" id="L10922">            return new NativeImage(outputBitmap);</span>
<span class="nc" id="L10923">        } catch(Throwable t) {</span>
<span class="nc" id="L10924">            brokenGaussian = true;</span>
<span class="nc" id="L10925">            return image;</span>
        }
    }

    public boolean isGaussianBlurSupported() {
<span class="pc bpc" id="L10930" title="2 of 4 branches missed.">        return (!brokenGaussian) &amp;&amp; android.os.Build.VERSION.SDK_INT &gt;= 11;</span>
    }

    public static boolean checkForPermission(String permission, String description){
<span class="nc" id="L10934">        return checkForPermission(permission, description, false);</span>
    }

    public static void setPermissionPromptCallback(PermissionPromptCallback callback) {
<span class="nc" id="L10938">        permissionPromptCallback = callback;</span>
<span class="nc" id="L10939">    }</span>

    public static PermissionPromptCallback getPermissionPromptCallback() {
<span class="nc" id="L10942">        return permissionPromptCallback;</span>
    }

    private static String getPermissionText(String key, String defaultValue) {
<span class="nc" id="L10946">        return UIManager.getInstance().localize(key, Display.getInstance().getProperty(key, defaultValue));</span>
    }

    private static boolean showPermissionPrompt(String permission, String title, String body, String positiveButtonText, String negativeButtonText) {
<span class="nc bnc" id="L10950" title="All 2 branches missed.">        if (permissionPromptCallback != null) {</span>
<span class="nc" id="L10951">            return permissionPromptCallback.showPermissionPrompt(permission, title, body, positiveButtonText, negativeButtonText);</span>
        }
<span class="nc" id="L10953">        return Dialog.show(title, body, positiveButtonText, negativeButtonText);</span>
    }

    private static void showPermissionMessage(String permission, String title, String body, String okButtonText) {
<span class="nc bnc" id="L10957" title="All 2 branches missed.">        if (permissionPromptCallback != null) {</span>
<span class="nc" id="L10958">            permissionPromptCallback.showPermissionMessage(permission, title, body, okButtonText);</span>
<span class="nc" id="L10959">            return;</span>
        }
<span class="nc" id="L10961">        Dialog.show(title, body, okButtonText, null);</span>
<span class="nc" id="L10962">    }</span>

    /**
     * Return a list of all of the permissions that have been requested by the app (granted or no).
     * This can be used to see which permissions are included in the manifest file.
     * @return 
     */
    public static List&lt;String&gt; getRequestedPermissions() {
<span class="nc" id="L10970">        PackageManager pm = getContext().getPackageManager();</span>
        try
        {
<span class="nc" id="L10973">            PackageInfo packageInfo = pm.getPackageInfo(getContext().getPackageName(), PackageManager.GET_PERMISSIONS);</span>
<span class="nc" id="L10974">            String[] requestedPermissions = null;</span>
<span class="nc bnc" id="L10975" title="All 2 branches missed.">            if (packageInfo != null) {</span>
<span class="nc" id="L10976">                requestedPermissions = packageInfo.requestedPermissions;</span>
<span class="nc" id="L10977">                return Arrays.asList(requestedPermissions);</span>
            }
<span class="nc" id="L10979">            return new ArrayList&lt;String&gt;();</span>
        }
<span class="nc" id="L10981">        catch (PackageManager.NameNotFoundException e)</span>
        {
<span class="nc" id="L10983">            com.codename1.io.Log.e(e);</span>
<span class="nc" id="L10984">            return new ArrayList&lt;String&gt;();</span>
        }
    }
    
    public static boolean checkForPermission(String permission, String description, boolean forceAsk){
        //before sdk 23 no need to ask for permission
<span class="nc bnc" id="L10990" title="All 2 branches missed.">        if(android.os.Build.VERSION.SDK_INT &lt; 23){</span>
<span class="nc" id="L10991">            return true;</span>
        }

<span class="nc bnc" id="L10994" title="All 4 branches missed.">        if (android.os.Build.VERSION.SDK_INT &gt;= 30 &amp;&amp; &quot;android.permission.ACCESS_BACKGROUND_LOCATION&quot;.equals(permission)) {</span>
<span class="nc bnc" id="L10995" title="All 2 branches missed.">            if (androidx.core.content.ContextCompat.checkSelfPermission(getContext(), permission) == PackageManager.PERMISSION_GRANTED) {</span>
<span class="nc" id="L10996">                return true;</span>
            }
<span class="nc bnc" id="L10998" title="All 2 branches missed.">            if (getActivity() == null) {</span>
<span class="nc" id="L10999">                return false;</span>
            }

<span class="nc" id="L11002">            String prompt = getPermissionText(permission, description);</span>
<span class="nc" id="L11003">            String title = getPermissionText(&quot;android.permission.ACCESS_BACKGROUND_LOCATION.title&quot;, &quot;Requires permission&quot;);</span>
<span class="nc" id="L11004">            String settingsBtn = getPermissionText(&quot;android.permission.ACCESS_BACKGROUND_LOCATION.settings&quot;, &quot;Settings&quot;);</span>
<span class="nc" id="L11005">            String cancelBtn = getPermissionText(&quot;android.permission.ACCESS_BACKGROUND_LOCATION.cancel&quot;, &quot;Cancel&quot;);</span>

<span class="nc bnc" id="L11007" title="All 2 branches missed.">            if(showPermissionPrompt(permission, title, prompt, settingsBtn, cancelBtn)){</span>
<span class="nc" id="L11008">                Intent intent = new Intent(android.provider.Settings.ACTION_APPLICATION_DETAILS_SETTINGS);</span>
<span class="nc" id="L11009">                Uri uri = Uri.fromParts(&quot;package&quot;, getContext().getPackageName(), null);</span>
<span class="nc" id="L11010">                intent.setData(uri);</span>
<span class="nc" id="L11011">                getActivity().startActivity(intent);</span>

<span class="nc" id="L11013">                String explanationTitle = getPermissionText(&quot;android.permission.ACCESS_BACKGROUND_LOCATION.explanation_title&quot;, &quot;Permission Required&quot;);</span>
<span class="nc" id="L11014">                String explanationBody = getPermissionText(&quot;android.permission.ACCESS_BACKGROUND_LOCATION.explanation_body&quot;, &quot;Please enable 'Allow all the time' in the settings, then press OK.&quot;);</span>
<span class="nc" id="L11015">                String okBtn = getPermissionText(&quot;android.permission.ACCESS_BACKGROUND_LOCATION.ok&quot;, &quot;OK&quot;);</span>

<span class="nc" id="L11017">                showPermissionMessage(permission, explanationTitle, explanationBody, okBtn);</span>
<span class="nc bnc" id="L11018" title="All 2 branches missed.">                return androidx.core.content.ContextCompat.checkSelfPermission(getActivity(), permission) == PackageManager.PERMISSION_GRANTED;</span>
            } else {
<span class="nc" id="L11020">                return false;</span>
            }
        }

<span class="nc" id="L11024">        String prompt = getPermissionText(permission, description);</span>

<span class="nc bnc" id="L11026" title="All 2 branches missed.">        if (androidx.core.content.ContextCompat.checkSelfPermission(getContext(),</span>
                permission)
                != PackageManager.PERMISSION_GRANTED) {

<span class="nc bnc" id="L11030" title="All 2 branches missed.">            if (getActivity() == null) {</span>
<span class="nc" id="L11031">                return false;</span>
            }

            // Should we show an explanation?
<span class="nc bnc" id="L11035" title="All 4 branches missed.">            if (!forceAsk &amp;&amp; androidx.core.app.ActivityCompat.shouldShowRequestPermissionRationale(getActivity(),</span>
                    permission)) {

                // Show an expanation to the user *asynchronously* -- don't block
<span class="nc" id="L11039">                String title = getPermissionText(permission + &quot;.title&quot;, &quot;Requires permission&quot;);</span>
<span class="nc" id="L11040">                String askAgain = getPermissionText(permission + &quot;.askAgain&quot;, &quot;Ask again&quot;);</span>
<span class="nc" id="L11041">                String dontAsk = getPermissionText(permission + &quot;.dontAsk&quot;, &quot;Don't Ask&quot;);</span>
<span class="nc bnc" id="L11042" title="All 2 branches missed.">                if(showPermissionPrompt(permission, title, prompt, askAgain, dontAsk)){</span>
<span class="nc" id="L11043">                    return checkForPermission(permission, description, true);</span>
                }else {
<span class="nc" id="L11045">                    return false;</span>
                }
            } else {

                // No explanation needed, we can request the permission.
<span class="nc" id="L11050">                ((CodenameOneActivity)getActivity()).setRequestForPermission(true);</span>
<span class="nc" id="L11051">                ((CodenameOneActivity)getActivity()).setWaitingForPermissionResult(true);</span>
<span class="nc" id="L11052">                androidx.core.app.ActivityCompat.requestPermissions(getActivity(),</span>
                        new String[]{permission},
                        1);
                //wait for a response
<span class="nc" id="L11056">                Display.getInstance().invokeAndBlock(new Runnable() {</span>
                    @Override
                    public void run() {
<span class="nc bnc" id="L11059" title="All 2 branches missed.">                        while(((CodenameOneActivity)getActivity()).isRequestForPermission()) {</span>
                            try {
<span class="nc" id="L11061">                                Thread.sleep(50);</span>
<span class="nc" id="L11062">                            } catch (InterruptedException e) {</span>
<span class="nc" id="L11063">                                e.printStackTrace();</span>
<span class="nc" id="L11064">                            }</span>
                        }
<span class="nc" id="L11066">                    }</span>
                });
                //check again if the permission is given after the dialog was displayed
<span class="nc bnc" id="L11069" title="All 2 branches missed.">                return androidx.core.content.ContextCompat.checkSelfPermission(getActivity(),</span>
                        permission) == PackageManager.PERMISSION_GRANTED;

            }
        }
<span class="nc" id="L11074">        return true;</span>
    }

    public boolean isJailbrokenDevice() {
        try {
<span class="nc" id="L11079">            Runtime.getRuntime().exec(&quot;su&quot;);</span>
<span class="nc" id="L11080">            return true;</span>
<span class="fc" id="L11081">        } catch(Throwable t) {</span>
<span class="fc" id="L11082">            com.codename1.io.Log.e(t);</span>
        }
<span class="fc" id="L11084">        return false;</span>
    }

    @Override
    public void announceForAccessibility(final Component cmp, final String text) {
<span class="fc" id="L11089">        final Activity act = getActivity();</span>
<span class="pc bpc" id="L11090" title="1 of 2 branches missed.">        if (act == null) {</span>
<span class="nc" id="L11091">            return;</span>
        }
<span class="fc" id="L11093">        act.runOnUiThread(new Runnable() {</span>
            @Override
            public void run() {
<span class="fc" id="L11096">                View view = null;</span>
<span class="pc bpc" id="L11097" title="1 of 2 branches missed.">                if (cmp instanceof PeerComponent) {</span>
<span class="nc" id="L11098">                    Object peer = ((PeerComponent) cmp).getNativePeer();</span>
<span class="nc bnc" id="L11099" title="All 2 branches missed.">                    if (peer instanceof View) {</span>
<span class="nc" id="L11100">                        view = (View) peer;</span>
                    }
                }
<span class="pc bpc" id="L11103" title="1 of 2 branches missed.">                if (view == null) {</span>
<span class="fc" id="L11104">                    view = act.getWindow().getDecorView();</span>
                }
<span class="pc bpc" id="L11106" title="1 of 2 branches missed.">                if (view == null) {</span>
<span class="nc" id="L11107">                    return;</span>
                }
<span class="pc bpc" id="L11109" title="1 of 2 branches missed.">                if (Build.VERSION.SDK_INT &gt;= 16) {</span>
<span class="fc" id="L11110">                    view.announceForAccessibility(text);</span>
                } else {
<span class="nc" id="L11112">                    AccessibilityManager manager = (AccessibilityManager) act.getSystemService(Context.ACCESSIBILITY_SERVICE);</span>
<span class="nc bnc" id="L11113" title="All 4 branches missed.">                    if (manager != null &amp;&amp; manager.isEnabled()) {</span>
<span class="nc" id="L11114">                        AccessibilityEvent event = AccessibilityEvent.obtain(AccessibilityEvent.TYPE_NOTIFICATION_STATE_CHANGED);</span>
<span class="nc" id="L11115">                        event.getText().add(text);</span>
<span class="nc" id="L11116">                        event.setSource(view);</span>
<span class="nc" id="L11117">                        manager.sendAccessibilityEvent(event);</span>
                    }
                }
<span class="fc" id="L11120">            }</span>
        });
<span class="fc" id="L11122">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>