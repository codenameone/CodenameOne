package @PACKAGE@;

import static org.junit.Assert.assertNotNull;
import static org.junit.Assert.assertTrue;

import android.graphics.Bitmap;
import android.graphics.Canvas;
import android.os.SystemClock;
import android.util.DisplayMetrics;
import android.view.View;

import com.codename1.ui.Display;
import com.codename1.ui.Form;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;

import org.junit.After;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.robolectric.Robolectric;
import org.robolectric.RobolectricTestRunner;
import org.robolectric.android.controller.ActivityController;
import org.robolectric.annotation.Config;
import org.robolectric.annotation.LooperMode;
import org.robolectric.shadows.ShadowLooper;

@RunWith(RobolectricTestRunner.class)
@Config(sdk = 30)
@LooperMode(LooperMode.Mode.LEGACY)
public class @MAIN_NAME@UiTest {

    private static final long STARTUP_TIMEOUT_MS = 30_000L;
    private static final long LAYOUT_TIMEOUT_MS = 5_000L;

    private ActivityController<@MAIN_NAME@Stub> controller;
    private @MAIN_NAME@Stub activity;

    @Before
    public void setUp() {
        controller = Robolectric.buildActivity(@MAIN_NAME@Stub.class);
        activity = controller.setup().get();
        waitForCodenameOneForm();
    }

    @After
    public void tearDown() {
        if (controller != null) {
            controller.pause();
            controller.stop();
            controller.destroy();
        }
    }

    @Test
    public void mainFormScreenshotContainsRenderedContent() throws Exception {
        View decorView = activity.getWindow().getDecorView();
        assertNotNull("Activity decor view should be available", decorView);

        ensureViewHasLayout(decorView);

        Bitmap screenshot = captureBitmap(decorView);
        assertTrue("Screenshot width should be positive", screenshot.getWidth() > 0);
        assertTrue("Screenshot height should be positive", screenshot.getHeight() > 0);
        assertTrue(
                "Screenshot should contain rendered content beyond the background",
                hasRenderableContent(screenshot));

        File screenshotFile = saveScreenshot(screenshot);
        assertTrue("Screenshot file should exist", screenshotFile.isFile());
        assertTrue("Screenshot file should not be empty", screenshotFile.length() > 0L);
    }

    private static Bitmap captureBitmap(View view) {
        Bitmap bitmap = Bitmap.createBitmap(view.getWidth(), view.getHeight(), Bitmap.Config.ARGB_8888);
        Canvas canvas = new Canvas(bitmap);
        view.draw(canvas);
        return bitmap;
    }

    private static void ensureViewHasLayout(View view) {
        long deadline = SystemClock.uptimeMillis() + LAYOUT_TIMEOUT_MS;
        DisplayMetrics metrics = view.getResources().getDisplayMetrics();
        int widthSpec = View.MeasureSpec.makeMeasureSpec(metrics.widthPixels, View.MeasureSpec.EXACTLY);
        int heightSpec = View.MeasureSpec.makeMeasureSpec(metrics.heightPixels, View.MeasureSpec.EXACTLY);

        while ((view.getWidth() == 0 || view.getHeight() == 0) && SystemClock.uptimeMillis() < deadline) {
            view.measure(widthSpec, heightSpec);
            view.layout(0, 0, view.getMeasuredWidth(), view.getMeasuredHeight());
            ShadowLooper.runUiThreadTasksIncludingDelayedTasks();
            SystemClock.sleep(16L);
        }

        if (view.getWidth() == 0 || view.getHeight() == 0) {
            throw new AssertionError("Timed out waiting for decor view to obtain layout bounds");
        }
    }

    private static boolean hasRenderableContent(Bitmap screenshot) {
        int width = screenshot.getWidth();
        int height = screenshot.getHeight();
        if (width <= 0 || height <= 0) {
            return false;
        }
        int[] pixels = new int[width * height];
        screenshot.getPixels(pixels, 0, width, 0, 0, width, height);
        if (pixels.length == 0) {
            return false;
        }
        int background = pixels[0];
        int contentPixels = 0;
        for (int argb : pixels) {
            int alpha = (argb >>> 24) & 0xFF;
            if (alpha == 0) {
                continue;
            }
            if (argb != background) {
                contentPixels++;
                if (contentPixels > width) {
                    return true;
                }
            }
        }
        return false;
    }

    private static File saveScreenshot(Bitmap screenshot) throws IOException {
        File outputDir = resolveArtifactDirectory();
        File screenshotFile = new File(outputDir, "@MAIN_NAME@-ui-test.png");
        try (FileOutputStream out = new FileOutputStream(screenshotFile)) {
            if (!screenshot.compress(Bitmap.CompressFormat.PNG, 100, out)) {
                throw new IOException("Failed to encode screenshot as PNG");
            }
        }
        return screenshotFile;
    }

    private static File resolveArtifactDirectory() throws IOException {
        String directory = System.getenv("CN1_TEST_SCREENSHOT_DIR");
        File outputDir = (directory != null && !directory.isEmpty())
                ? new File(directory)
                : new File("build/ui-test-screenshots");
        if (!outputDir.exists() && !outputDir.mkdirs()) {
            throw new IOException("Failed to create screenshot directory " + outputDir.getAbsolutePath());
        }
        return outputDir;
    }

    private static void waitForCodenameOneForm() {
        long deadline = SystemClock.uptimeMillis() + STARTUP_TIMEOUT_MS;
        while (SystemClock.uptimeMillis() < deadline) {
            ShadowLooper.runUiThreadTasksIncludingDelayedTasks();
            if (Display.isInitialized()) {
                Form current = Display.getInstance().getCurrent();
                if (current != null) {
                    return;
                }
            }
            SystemClock.sleep(16L);
        }
        throw new AssertionError("Timed out waiting for Codename One main form to be displayed");
    }
}
