name: Test iOS build scripts

on:
  pull_request:
    paths:
      - '.github/workflows/scripts-ios.yml'
      - 'scripts/setup-workspace.sh'
      - 'scripts/build-ios-port.sh'
      - 'scripts/build-ios-app.sh'
      - 'scripts/run-ios-simulator-tests.sh'
      - 'scripts/templates/**'
      - '!scripts/templates/**/*.md'
      - 'scripts/ios/**'
      - '!scripts/ios/**/*.md'
      - 'CodenameOne/src/**'
      - '!CodenameOne/src/**/*.md'
      - 'Ports/iOSPort/**'
      - '!Ports/iOSPort/**/*.md'
      - 'vm/**'
      - '!vm/**/*.md'
      - 'tests/**'
      - '!tests/**/*.md'
  push:
    branches: [ master ]
    paths:
      - '.github/workflows/scripts-ios.yml'
      - 'scripts/setup-workspace.sh'
      - 'scripts/build-ios-port.sh'
      - 'scripts/build-ios-app.sh'
      - 'scripts/run-ios-simulator-tests.sh'
      - 'scripts/templates/**'
      - '!scripts/templates/**/*.md'
      - 'scripts/ios/**'
      - '!scripts/ios/**/*.md'
      - 'CodenameOne/src/**'
      - '!CodenameOne/src/**/*.md'
      - 'Ports/iOSPort/**'
      - '!Ports/iOSPort/**/*.md'
      - 'vm/**'
      - '!vm/**/*.md'
      - 'tests/**'
      - '!tests/**/*.md'

jobs:
  build-ios:
    permissions:
      contents: read
      pull-requests: write
      issues: write
    runs-on: macos-15           # pinning macos-15 avoids surprises during the cutover window
    timeout-minutes: 60         # allow enough time for dependency installs and full build
    concurrency:                # ensure only one mac build runs at once
      group: mac-ci
      cancel-in-progress: false # queue new ones instead of canceling in-flight
    env:
      GITHUB_TOKEN: ${{ secrets.CN1SS_GH_TOKEN }}
      GH_TOKEN: ${{ secrets.CN1SS_GH_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - name: Ensure CocoaPods tooling
        run: |
          set -euo pipefail
          if ! command -v pod >/dev/null 2>&1; then
            sudo gem install cocoapods --no-document
          fi
          if ! ruby -rrubygems -e "exit(Gem::Specification::find_all_by_name('xcodeproj').empty? ? 1 : 0)"; then
            sudo gem install xcodeproj --no-document
          fi
          pod --version

      - name: Restore cn1-binaries cache
        uses: actions/cache@v4
        with:
          path: ../cn1-binaries
          key: cn1-binaries-${{ runner.os }}-${{ hashFiles('scripts/setup-workspace.sh') }}
          restore-keys: |
            cn1-binaries-${{ runner.os }}-

      - name: Setup workspace
        run: ./scripts/setup-workspace.sh -q -DskipTests
        # per-step timeout
        timeout-minutes: 25

      - name: Build iOS port
        run: ./scripts/build-ios-port.sh -q -DskipTests
        timeout-minutes: 25

      - name: Build sample iOS app and compile workspace
        id: build-ios-app
        run: ./scripts/build-ios-app.sh -q -DskipTests
        timeout-minutes: 30

      - name: Run iOS simulator automation tests
        run: ./scripts/run-ios-simulator-tests.sh "${{ steps.build-ios-app.outputs.app_bundle }}"
        timeout-minutes: 20

      - name: Upload simulator artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-simulator-artifacts
          path: artifacts
          if-no-files-found: warn
          retention-days: 14
          compression-level: 6

